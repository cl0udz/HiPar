/*
watcher.js 2.5.3- app watcher
Built on 2015-10-20
*/
"use strict";var mongojs=require("mongojs"),sqlite3=require("sqlite3").verbose(),stampit=require("stampit"),_=require("underscore"),logger=require("./logger"),mongoDBWrapper,sqliteWrapper;mongoDBWrapper=stampit().state({connection:void 0}).methods({init:function(a){a=a||"mongodb://localhost:27017/",this.connection=mongojs(a+"watcherjs",["history"])},insertEndpointsHistory:function(a,b){b=b||_.noop,this.connection.history.insert(a,function(c,d){c&&logger.warn("Unable to update the persistent state of '"+a+"', "+c),b(c,d)})},removeEndpointHistory:function(a,b){b=b||_.noop,this.connection.history.remove({endpointId:a},function(c,d){c?logger.warn("Unable to remove '"+a+"', "+c):logger.debug("History for endpoint '"+a+"' has been removed from database!"),b(c,d)})},findHistoryForEndpoint:function(a,b,c,d){d=d||_.noop;var e={};b&&c&&(e.timestamp={$gte:parseFloat(b),$lte:parseFloat(c)}),a&&(e.endpointId=a),this.connection.history.find({$query:e,$orderby:{timestamp:1}},function(a,b){a&&logger.error("Unable to get history, err: "+a+", query: "+e),d(a,b)})},close:function(){this.connection.close()}});var createTableSQL="CREATE TABLE if not exists history (id TEXT, timestamp INTEGER, phase TEXT, sfrom TEXT, sto TEXT)";sqliteWrapper=stampit().state({connection:void 0}).methods({init:function(a){a=a||"storage/history.sqlite",this.connection=new sqlite3.Database(a),this.connection.run(createTableSQL)},insertEndpointsHistory:function(a,b){b=b||_.noop;var c=this.connection;c.serialize(function(){c.run("begin transaction");var d=c.prepare("INSERT INTO history VALUES (?, ?, ?, ?, ?)");_.each(a,function(a){d.run(a.endpointId,a.timestamp,a.phase,a.statusTransition.from,a.statusTransition.to)}),d.finalize(),c.run("commit",b)})},removeEndpointHistory:function(a,b){b=b||_.noop;var c=this.connection,d=c.prepare("DELETE from history where id = ?");d.run(a,b),d.finalize()},findHistoryForEndpoint:function(a,b,c,d){d=d||_.noop;var e,f=this.connection,g=[],h=function(a,b){a||_.each(b,function(a){g.push({endpointId:a.id,timestamp:a.timestamp,phase:a.phase,statusTransition:{from:a.sfrom,to:a.sto}})}),d(a,g)};a&&b&&c?(e=f.prepare("SELECT * FROM history WHERE id = ? AND (timestamp >= ? AND timestamp <= ?)"),e.all(a,b,c,h)):!a||b&&c?(e=f.prepare("SELECT * FROM history"),e.all([],h)):(e=f.prepare("SELECT * FROM history WHERE id = ?"),e.all(a,h)),e.finalize()},close:function(){}}),module.exports={createMongoDBOperationsWrapper:function(a){var b=mongoDBWrapper.create();return b.init(a),b},createSQLiteDBOperationsWrapper:function(a){var b=sqliteWrapper.create();return b.init(a),b}};