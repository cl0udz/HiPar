import path from 'path';
import { BasePipe } from '../pipe';
import { mkdirp, writeFile, unlink } from '../utils';


export default class ExtPipe extends BasePipe {
    constructor() {
        super(...arguments);
    }

    static schema() {
        return {
            description: 'Write files to disk.'
        };
    }

    async remoteAdd(file) {
        file.addCount += 1;
    }

    async remoteChange(file) {
        try {
            await mkdirp(path.dirname(file.name));
            const content = await file.content();
            return writeFile(file.name, content);
        } catch (err) {
            this.log('error', err);
            this.log('error', err.stack);
        }
    }

    async remoteUnlink(file) {
        file.addCount -= 1;
        return unlink(file.name).catch(err => {
            this.log('error', `Could not delete ${file.name} ${err}`);
        });
    }
}
