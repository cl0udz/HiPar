/*
watcher.js 2.5.3- app watcher
Built on 2015-10-20
*/
"use strict";function prepareEndpoint(a){var b;return a&&(b=_.omit(a,"connector","timeout","processed","notified","previousStatus"),b.timestamp=b.timestamp.valueOf(),b.since=b.since.valueOf()),b}function unknownEndpointError(a){return{error:"Unknown endpoint '"+a+"'",status:422}}function generalError(a,b){return{error:a,status:b}}var express=require("express"),_=require("underscore"),s=require("underscore.string"),logger=require("../logger");module.exports={endpoints:function(a){return function(b,c,d){a.getEndpoints().then(function(a){c.json(_.map(a,function(a){return prepareEndpoint(a)}))},function(a){d(generalError(a))})}},endpoint:function(a){return function(b,c,d){var e=b.params.id;a.getEndpoint(e).then(function(a){a?c.json(prepareEndpoint(a)):d(unknownEndpointError(e))},function(a){d(generalError(a))})}},addEndpoint:function(a){return function(b,c,d){var e=b.body.id;b.body.active=s.toBoolean(b.body.active),b.body.notify=s.toBoolean(b.body.notify),a.addEndpoint(b.body,!0).then(function(a){c.json({id:a.id,uri:"/endpoints/"+e,status:a.status})},function(a){d(a.validation?generalError(a,422):generalError(a))})}},removeEndpoint:function(a){return function(b,c,d){var e=b.params.id;a.removeEndpoint(e).then(function(a){a?c.json({id:e}):d(unknownEndpointError(e))},function(a){d(generalError(a))})}},endpointActivate:function(a){var b=this;return function(c,d,e){b._changeEndpointActivationState(a,c,d,!0,e)}},endpointDeactivate:function(a){var b=this;return function(c,d,e){b._changeEndpointActivationState(a,c,d,!1,e)}},_changeEndpointActivationState:function(a,b,c,d,e){var f=b.params.id;a.setEndpointActivationState(f,d).then(function(a){a?c.json({id:a.id,active:a.active,status:a.status}):e(unknownEndpointError(f))},function(a){e(generalError(a))})},endpointEnableNotification:function(a){var b=this;return function(c,d,e){b._changeEndpointNotificationState(a,c,d,!0,e)}},endpointDisableNotification:function(a){var b=this;return function(c,d,e){b._changeEndpointNotificationState(a,c,d,!1,e)}},_changeEndpointNotificationState:function(a,b,c,d,e){var f=b.params.id;a.notifyOnErroneousStatus(f,d).then(function(a){a?c.json({id:a.id,notify:a.notify}):e(unknownEndpointError(f))},function(a){e(generalError(a))})},resolutionStrategies:function(a){return function(b,c,d){a.getResolutionStrategies().then(function(a){c.json(_.pluck(a,"id"))},function(a){d(generalError(a))})}},history:function(a){return function(b,c,d){a.getHistory({endpointId:b.params.id,from:b.params.from,to:b.params.to}).then(function(a){c.json(_.map(a,function(a){return _.omit(a,"_id")}))},function(a){d(generalError(a))})}},getSettings:function(a){return function(b,c,d){a.getSettings().then(function(a){c.json(a)},function(a){d(generalError(a))})}},updateSettings:function(a){return function(b,c,d){a.updateSettings(b.body).then(function(a){c.json(a)},function(a){d(generalError(a,422))})}}};