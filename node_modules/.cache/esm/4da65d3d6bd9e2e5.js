"main";let ObjectID;_6bd‍.w("mongodb",[["ObjectID",["ObjectID"],function(v){ObjectID=v}]]);let settings;_6bd‍.w("../../lib/settings",[["default",["settings"],function(v){settings=v}]]);let db;_6bd‍.w("../../lib/mongo",[["db",["db"],function(v){db=v}]]);let utils;_6bd‍.w("../../lib/utils",[["default",["utils"],function(v){utils=v}]]);let parse;_6bd‍.w("../../lib/parse",[["default",["parse"],function(v){parse=v}]]);let OrdersService;_6bd‍.w("./orders",[["default",["OrdersService"],function(v){OrdersService=v}]]);






class OrdertDiscountsService {
	constructor() {}

	addDiscount(order_id, data) {
		if (!ObjectID.isValid(order_id)) {
			return Promise.reject('Invalid identifier');
		}
		let orderObjectID = new ObjectID(order_id);
		const discount = this.getValidDocumentForInsert(data);

		return db.collection('orders').updateOne(
			{
				_id: orderObjectID
			},
			{
				$push: {
					discounts: discount
				}
			}
		);
	}

	updateDiscount(order_id, discount_id, data) {
		if (!ObjectID.isValid(order_id) || !ObjectID.isValid(discount_id)) {
			return Promise.reject('Invalid identifier');
		}
		let orderObjectID = new ObjectID(order_id);
		let discountObjectID = new ObjectID(discount_id);
		const discount = this.getValidDocumentForUpdate(data);

		return db
			.collection('orders')
			.updateOne(
				{
					_id: orderObjectID,
					'discounts.id': discountObjectID
				},
				{ $set: discount }
			)
			.then(res => OrdersService.getSingleOrder(order_id));
	}

	deleteDiscount(order_id, discount_id) {
		if (!ObjectID.isValid(order_id) || !ObjectID.isValid(discount_id)) {
			return Promise.reject('Invalid identifier');
		}
		let orderObjectID = new ObjectID(order_id);
		let discountObjectID = new ObjectID(discount_id);

		return db
			.collection('orders')
			.updateOne(
				{
					_id: orderObjectID
				},
				{
					$pull: {
						discounts: {
							id: discountObjectID
						}
					}
				}
			)
			.then(res => OrdersService.getSingleOrder(order_id));
	}

	getValidDocumentForInsert(data) {
		return {
			id: new ObjectID(),
			name: parse.getString(data.name),
			amount: parse.getNumberIfPositive(data.amount)
		};
	}

	getValidDocumentForUpdate(data) {
		if (Object.keys(data).length === 0) {
			return new Error('Required fields are missing');
		}

		let discount = {};

		if (data.variant_id !== undefined) {
			discount['discounts.$.name'] = parse.getString(data.name);
		}

		if (data.quantity !== undefined) {
			discount['discounts.$.amount'] = parse.getNumberIfPositive(data.amount);
		}

		return discount;
	}
}

_6bd‍.d(new OrdertDiscountsService());
