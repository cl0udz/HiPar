"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var indicative_rules_1 = require("indicative-rules");

var indicative_compiler_1 = require("indicative-compiler");

var CacheManager_1 = require("../CacheManager");

var config_1 = require("./config");

var cacheManager = new CacheManager_1.CacheManager();

function getExecutor(schema, messages, config) {
  if (!config.cacheKey) {
    var compiler = new indicative_compiler_1.ValidatorCompiler(schema, messages, indicative_rules_1.validations);
    return new indicative_compiler_1.ValidatorExecutor(compiler.compile());
  }

  var compiledSchema = cacheManager.get(config.cacheKey);

  if (!compiledSchema) {
    var _compiler = new indicative_compiler_1.ValidatorCompiler(schema, messages, indicative_rules_1.validations);

    cacheManager.set(config.cacheKey, _compiler.compile());
  }

  return new indicative_compiler_1.ValidatorExecutor(cacheManager.get(config.cacheKey));
}

exports.validate = function (data, schema, messages, config) {
  config = Object.assign({}, config_1.config, config);
  return getExecutor(schema, messages || {}, config).exec(data, config.formatter, config, true, config.removeAdditional, config.customErrorCollector);
};

exports.validateAll = function (data, schema, messages, config) {
  config = Object.assign({}, config_1.config, config);
  return getExecutor(schema, messages || {}, config).exec(data, config.formatter, config, false, config.removeAdditional, config.customErrorCollector);
};