"use strict";

var _jquery = _interopRequireDefault(require("jquery"));

var _codeMirrorLoader = _interopRequireDefault(require("./codeMirrorLoader"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    "default": obj
  };
}

var doc = _codeMirrorLoader["default"].fromTextArea(document.getElementById('document'), {
  mode: {
    name: 'javascript',
    json: true
  },
  indentUnit: 4,
  lineNumbers: true,
  autoClearEmptyLines: true,
  matchBrackets: true,
  readOnly: ME_SETTINGS.readOnly,
  theme: ME_SETTINGS.codeMirrorEditorTheme
});

window.onBackClick = function () {
  // "Back" button is clicked
  if (doc.isClean()) {
    history.back();
  } else if ((0, _jquery["default"])('#discardChanges').length === 0) {
    (0, _jquery["default"])('#pageTitle').parent().append('<div id="discardChanges" class="alert alert-warning"><strong>Document has changed! Are you sure you wish to go back?</strong></div>');
    (0, _jquery["default"])('.backButton').text('Back & Discard Changes');
  } else {
    history.back();
  }

  return false;
};

window.onSubmitClick = function () {
  // Save button is clicked
  (0, _jquery["default"])('#discardChanges').remove();

  _jquery["default"].ajax({
    type: 'POST',
    url: "".concat(ME_SETTINGS.baseHref, "checkValid"),
    data: {
      document: doc.getValue()
    }
  }).done(function (data) {
    if (data === 'Valid') {
      (0, _jquery["default"])('#documentInvalidJSON').remove();
      (0, _jquery["default"])('#documentEditForm').submit();
    } else if ((0, _jquery["default"])('#documentInvalidJSON').length === 0) {
      (0, _jquery["default"])('#pageTitle').parent().append('<div id="documentInvalidJSON" class="alert alert-danger"><strong>Invalid JSON</strong></div>');
    }
  });

  return false;
};

(0, _jquery["default"])(document).ready(function () {
  (0, _jquery["default"])('.deleteButtonDocument').on('click', function (e) {
    var $form = (0, _jquery["default"])(this).closest('form');
    e.stopPropagation();
    e.preventDefault();

    if (ME_SETTINGS.confirmDelete) {
      (0, _jquery["default"])('#confirm-document-delete').modal({
        backdrop: 'static',
        keyboard: false
      }).one('click', '#delete', function () {
        $form.trigger('submit'); // submit the form
      });
    } else {
      $form.trigger('submit');
    }
  });
});