"use strict";

require("core-js/modules/es.array.join");

require("core-js/modules/es.object.define-property");

require("core-js/modules/es.string.bold");

require("core-js/modules/es.array.join");

require("core-js/modules/es.object.define-property");

require("core-js/modules/es.string.bold");

var __importDefault = void 0 && (void 0).__importDefault || function (mod) {
  return mod && mod.__esModule ? mod : {
    "default": mod
  };
};

Object.defineProperty(exports, "__esModule", {
  value: true
});

var fs_extra_1 = __importDefault(require("fs-extra"));

var path_1 = require("./path");

var chalk_1 = __importDefault(require("chalk"));

var process_1 = __importDefault(require("process"));

var find_yarn_workspace_root_1 = __importDefault(require("find-yarn-workspace-root"));

function printNoYarnLockfileError() {
  console.error("\n" + chalk_1["default"].red.bold("**ERROR**") + " " + chalk_1["default"].red("The --use-yarn option was specified but there is no yarn.lock file") + "\n");
}

function printNoLockfilesError() {
  console.error("\n" + chalk_1["default"].red.bold("**ERROR**") + " " + chalk_1["default"].red("No package-lock.json, npm-shrinkwrap.json, or yarn.lock file.\n\nYou must use either npm@>=5, yarn, or npm-shrinkwrap to manage this project's\ndependencies.") + "\n");
}

function printSelectingDefaultMessage() {
  console.info(chalk_1["default"].bold("patch-package") + ": you have both yarn.lock and package-lock.json\nDefaulting to using " + chalk_1["default"].bold("npm") + "\nYou can override this setting by passing --use-yarn or deleting\npackage-lock.json if you don't need it\n");
}

exports.detectPackageManager = function (appRootPath, overridePackageManager) {
  var packageLockExists = fs_extra_1["default"].existsSync(path_1.join(appRootPath, "package-lock.json"));
  var shrinkWrapExists = fs_extra_1["default"].existsSync(path_1.join(appRootPath, "npm-shrinkwrap.json"));
  var yarnLockExists = fs_extra_1["default"].existsSync(path_1.join(appRootPath, "yarn.lock"));

  if ((packageLockExists || shrinkWrapExists) && yarnLockExists) {
    if (overridePackageManager) {
      return overridePackageManager;
    } else {
      printSelectingDefaultMessage();
      return shrinkWrapExists ? "npm-shrinkwrap" : "npm";
    }
  } else if (packageLockExists || shrinkWrapExists) {
    if (overridePackageManager === "yarn") {
      printNoYarnLockfileError();
      process_1["default"].exit(1);
    } else {
      return shrinkWrapExists ? "npm-shrinkwrap" : "npm";
    }
  } else if (yarnLockExists || find_yarn_workspace_root_1["default"]()) {
    return "yarn";
  } else {
    printNoLockfilesError();
    process_1["default"].exit(1);
  }

  throw Error();
};