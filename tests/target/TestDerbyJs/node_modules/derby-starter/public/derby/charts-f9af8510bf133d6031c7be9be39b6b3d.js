"use strict";require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof9(obj){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof9=function _typeof9(obj){return typeof obj;};}else{_typeof9=function _typeof9(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}return _typeof9(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof8(obj){if(typeof Symbol==="function"&&_typeof9(Symbol.iterator)==="symbol"){_typeof8=function _typeof8(obj){return _typeof9(obj);};}else{_typeof8=function _typeof8(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof9(obj);};}return _typeof8(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof7(obj){if(typeof Symbol==="function"&&_typeof8(Symbol.iterator)==="symbol"){_typeof7=function _typeof7(obj){return _typeof8(obj);};}else{_typeof7=function _typeof7(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof8(obj);};}return _typeof7(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof6(obj){if(typeof Symbol==="function"&&_typeof7(Symbol.iterator)==="symbol"){_typeof6=function _typeof6(obj){return _typeof7(obj);};}else{_typeof6=function _typeof6(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof7(obj);};}return _typeof6(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof5(obj){if(typeof Symbol==="function"&&_typeof6(Symbol.iterator)==="symbol"){_typeof5=function _typeof5(obj){return _typeof6(obj);};}else{_typeof5=function _typeof5(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof6(obj);};}return _typeof5(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof4(obj){if(typeof Symbol==="function"&&_typeof5(Symbol.iterator)==="symbol"){_typeof4=function _typeof4(obj){return _typeof5(obj);};}else{_typeof4=function _typeof4(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof5(obj);};}return _typeof4(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof3(obj){if(typeof Symbol==="function"&&_typeof4(Symbol.iterator)==="symbol"){_typeof3=function _typeof3(obj){return _typeof4(obj);};}else{_typeof3=function _typeof3(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof4(obj);};}return _typeof3(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof2(obj){if(typeof Symbol==="function"&&_typeof3(Symbol.iterator)==="symbol"){_typeof2=function _typeof2(obj){return _typeof3(obj);};}else{_typeof2=function _typeof2(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof3(obj);};}return _typeof2(obj);}require("core-js/modules/es.symbol");require("core-js/modules/es.symbol.description");require("core-js/modules/es.symbol.iterator");require("core-js/modules/es.array.concat");require("core-js/modules/es.array.filter");require("core-js/modules/es.array.find");require("core-js/modules/es.array.for-each");require("core-js/modules/es.array.index-of");require("core-js/modules/es.array.is-array");require("core-js/modules/es.array.iterator");require("core-js/modules/es.array.join");require("core-js/modules/es.array.last-index-of");require("core-js/modules/es.array.map");require("core-js/modules/es.array.reduce");require("core-js/modules/es.array.reverse");require("core-js/modules/es.array.slice");require("core-js/modules/es.array.some");require("core-js/modules/es.array.sort");require("core-js/modules/es.array.splice");require("core-js/modules/es.array-buffer.slice");require("core-js/modules/es.date.now");require("core-js/modules/es.date.to-iso-string");require("core-js/modules/es.date.to-json");require("core-js/modules/es.date.to-string");require("core-js/modules/es.function.bind");require("core-js/modules/es.function.name");require("core-js/modules/es.number.constructor");require("core-js/modules/es.number.is-integer");require("core-js/modules/es.number.to-fixed");require("core-js/modules/es.number.to-precision");require("core-js/modules/es.object.create");require("core-js/modules/es.object.define-property");require("core-js/modules/es.object.get-prototype-of");require("core-js/modules/es.object.keys");require("core-js/modules/es.object.set-prototype-of");require("core-js/modules/es.object.to-string");require("core-js/modules/es.parse-float");require("core-js/modules/es.parse-int");require("core-js/modules/es.reflect.own-keys");require("core-js/modules/es.regexp.constructor");require("core-js/modules/es.regexp.exec");require("core-js/modules/es.regexp.to-string");require("core-js/modules/es.string.iterator");require("core-js/modules/es.string.match");require("core-js/modules/es.string.replace");require("core-js/modules/es.string.search");require("core-js/modules/es.string.split");require("core-js/modules/es.string.trim");require("core-js/modules/es.string.fixed");require("core-js/modules/es.typed-array.uint8-array");require("core-js/modules/es.typed-array.copy-within");require("core-js/modules/es.typed-array.every");require("core-js/modules/es.typed-array.fill");require("core-js/modules/es.typed-array.filter");require("core-js/modules/es.typed-array.find");require("core-js/modules/es.typed-array.find-index");require("core-js/modules/es.typed-array.for-each");require("core-js/modules/es.typed-array.includes");require("core-js/modules/es.typed-array.index-of");require("core-js/modules/es.typed-array.iterator");require("core-js/modules/es.typed-array.join");require("core-js/modules/es.typed-array.last-index-of");require("core-js/modules/es.typed-array.map");require("core-js/modules/es.typed-array.reduce");require("core-js/modules/es.typed-array.reduce-right");require("core-js/modules/es.typed-array.reverse");require("core-js/modules/es.typed-array.set");require("core-js/modules/es.typed-array.slice");require("core-js/modules/es.typed-array.some");require("core-js/modules/es.typed-array.sort");require("core-js/modules/es.typed-array.subarray");require("core-js/modules/es.typed-array.to-locale-string");require("core-js/modules/es.typed-array.to-string");require("core-js/modules/web.dom-collections.for-each");require("core-js/modules/web.dom-collections.iterator");require("core-js/modules/web.timers");require("core-js/modules/web.url.to-json");function _typeof(obj){if(typeof Symbol==="function"&&_typeof2(Symbol.iterator)==="symbol"){_typeof=function _typeof(obj){return _typeof2(obj);};}else{_typeof=function _typeof(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":_typeof2(obj);};}return _typeof(obj);}require=function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a;}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r);},p,p.exports,r,e,n,t);}return n[i].exports;}for(var u="function"==typeof require&&require,i=0;i<t.length;i++){o(t[i]);}return o;}return r;}()({1:[function(require,module,exports){(function(__filename,__dirname){"use strict";var app=module.exports=require('derby').createApp('charts',__filename);app.use(require('derby-debug'));app.serverUse(module,'derby-stylus');app.use(require('d-bootstrap'));app.loadViews(__dirname);app.loadStyles(__dirname);app.component(require('d-connection-alert'));app.component(require('d-barchart'));app.component(require('d-barchart-vanilla'));app.component(require('d-d3-barchart'));app.get('/',function(page,model,params,next){var data=model.at('widgets.data');data.subscribe(function(err){if(err)return next(err);data.createNull({bars:[{value:1},{value:10},{value:20}]});page.render();});});// adding a prototype method to page of app
app.proto.remove=function(index){this.model.remove('widgets.data.bars',index);};app.proto.add=function(){this.model.push('widgets.data.bars',{value:Math.random()*100});};}).call(this,"/charts/index.js","/charts");},{"d-barchart":5,"d-barchart-vanilla":4,"d-bootstrap":9,"d-connection-alert":12,"d-d3-barchart":13,"derby":"derby","derby-debug":15}],2:[function(require,module,exports){module.exports=arrayDiff;// Based on some rough benchmarking, this algorithm is about O(2n) worst case,
// and it can compute diffs on random arrays of length 1024 in about 34ms,
// though just a few changes on an array of length 1024 takes about 0.5ms
arrayDiff.InsertDiff=InsertDiff;arrayDiff.RemoveDiff=RemoveDiff;arrayDiff.MoveDiff=MoveDiff;function InsertDiff(index,values){this.index=index;this.values=values;}InsertDiff.prototype.type='insert';InsertDiff.prototype.toJSON=function(){return{type:this.type,index:this.index,values:this.values};};function RemoveDiff(index,howMany){this.index=index;this.howMany=howMany;}RemoveDiff.prototype.type='remove';RemoveDiff.prototype.toJSON=function(){return{type:this.type,index:this.index,howMany:this.howMany};};function MoveDiff(from,to,howMany){this.from=from;this.to=to;this.howMany=howMany;}MoveDiff.prototype.type='move';MoveDiff.prototype.toJSON=function(){return{type:this.type,from:this.from,to:this.to,howMany:this.howMany};};function strictEqual(a,b){return a===b;}function arrayDiff(before,after,equalFn){if(!equalFn)equalFn=strictEqual;// Find all items in both the before and after array, and represent them
// as moves. Many of these "moves" may end up being discarded in the last
// pass if they are from an index to the same index, but we don't know this
// up front, since we haven't yet offset the indices.
//
// Also keep a map of all the indices accounted for in the before and after
// arrays. These maps are used next to create insert and remove diffs.
var beforeLength=before.length;var afterLength=after.length;var moves=[];var beforeMarked={};var afterMarked={};for(var beforeIndex=0;beforeIndex<beforeLength;beforeIndex++){var beforeItem=before[beforeIndex];for(var afterIndex=0;afterIndex<afterLength;afterIndex++){if(afterMarked[afterIndex])continue;if(!equalFn(beforeItem,after[afterIndex]))continue;var from=beforeIndex;var to=afterIndex;var howMany=0;do{beforeMarked[beforeIndex++]=afterMarked[afterIndex++]=true;howMany++;}while(beforeIndex<beforeLength&&afterIndex<afterLength&&equalFn(before[beforeIndex],after[afterIndex])&&!afterMarked[afterIndex]);moves.push(new MoveDiff(from,to,howMany));beforeIndex--;break;}}// Create a remove for all of the items in the before array that were
// not marked as being matched in the after array as well
var removes=[];for(beforeIndex=0;beforeIndex<beforeLength;){if(beforeMarked[beforeIndex]){beforeIndex++;continue;}var index=beforeIndex;var howMany=0;while(beforeIndex<beforeLength&&!beforeMarked[beforeIndex++]){howMany++;}removes.push(new RemoveDiff(index,howMany));}// Create an insert for all of the items in the after array that were
// not marked as being matched in the before array as well
var inserts=[];for(var afterIndex=0;afterIndex<afterLength;){if(afterMarked[afterIndex]){afterIndex++;continue;}var index=afterIndex;var howMany=0;while(afterIndex<afterLength&&!afterMarked[afterIndex++]){howMany++;}var values=after.slice(index,index+howMany);inserts.push(new InsertDiff(index,values));}var insertsLength=inserts.length;var removesLength=removes.length;var movesLength=moves.length;var i,j;// Offset subsequent removes and moves by removes
var count=0;for(i=0;i<removesLength;i++){var remove=removes[i];remove.index-=count;count+=remove.howMany;for(j=0;j<movesLength;j++){var move=moves[j];if(move.from>=remove.index)move.from-=remove.howMany;}}// Offset moves by inserts
for(i=insertsLength;i--;){var insert=inserts[i];var howMany=insert.values.length;for(j=movesLength;j--;){var move=moves[j];if(move.to>=insert.index)move.to-=howMany;}}// Offset the to of moves by later moves
for(i=movesLength;i-->1;){var move=moves[i];if(move.to===move.from)continue;for(j=i;j--;){var earlier=moves[j];if(earlier.to>=move.to)earlier.to-=move.howMany;if(earlier.to>=move.from)earlier.to+=move.howMany;}}// Only output moves that end up having an effect after offsetting
var outputMoves=[];// Offset the from of moves by earlier moves
for(i=0;i<movesLength;i++){var move=moves[i];if(move.to===move.from)continue;outputMoves.push(move);for(j=i+1;j<movesLength;j++){var later=moves[j];if(later.from>=move.from)later.from-=move.howMany;if(later.from>=move.to)later.from+=move.howMany;}}return removes.concat(outputMoves,inserts);}},{}],3:[function(require,module,exports){(function(){var f,aa=aa||{},l=this;function ba(a){a=a.split(".");for(var b=l,c;c=a.shift();){if(null!=b[c]){b=b[c];}else{return null;}}return b;}function ca(){}function da(a){var b=_typeof(a);if("object"==b){if(a){if(a instanceof Array){return"array";}if(a instanceof Object){return b;}var c=Object.prototype.toString.call(a);if("[object Window]"==c){return"object";}if("[object Array]"==c||"number"==typeof a.length&&"undefined"!=typeof a.splice&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice")){return"array";}if("[object Function]"==c||"undefined"!=typeof a.call&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("call")){return"function";}}else{return"null";}}else{if("function"==b&&"undefined"==typeof a.call){return"object";}}return b;}function m(a){return"array"==da(a);}function ea(a){var b=da(a);return"array"==b||"object"==b&&"number"==typeof a.length;}function n(a){return"string"==typeof a;}function fa(a){return"function"==da(a);}var ga="closure_uid_"+(1E9*Math.random()>>>0),ha=0;function ia(a,b,c){return a.call.apply(a.bind,arguments);}function ja(a,b,c){if(!a){throw Error();}if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c);};}return function(){return a.apply(b,arguments);};}function p(a,b,c){p=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ia:ja;return p.apply(null,arguments);}var q=Date.now||function(){return+new Date();};function s(a,b){function c(){}c.prototype=b.prototype;a.pa=b.prototype;a.prototype=new c();a.Hc=function(a,c,g){var h=Array.prototype.slice.call(arguments,2);return b.prototype[c].apply(a,h);};};function ka(a,b){for(var c=a.split("%s"),d="",e=Array.prototype.slice.call(arguments,1);e.length&&1<c.length;){d+=c.shift()+e.shift();}return d+c.join("%s");}function la(a){if(!ma.test(a)){return a;}-1!=a.indexOf("&")&&(a=a.replace(na,"&amp;"));-1!=a.indexOf("<")&&(a=a.replace(oa,"&lt;"));-1!=a.indexOf(">")&&(a=a.replace(pa,"&gt;"));-1!=a.indexOf('"')&&(a=a.replace(qa,"&quot;"));-1!=a.indexOf("'")&&(a=a.replace(ra,"&#39;"));return a;}var na=/&/g,oa=/</g,pa=/>/g,qa=/"/g,ra=/'/g,ma=/[&<>"']/;function sa(){return Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^q()).toString(36);}function ta(a,b){return a<b?-1:a>b?1:0;};var x,ua,va,wa;function xa(){return l.navigator?l.navigator.userAgent:null;}wa=va=ua=x=!1;var ya;if(ya=xa()){var za=l.navigator;x=0==ya.lastIndexOf("Opera",0);ua=!x&&(-1!=ya.indexOf("MSIE")||-1!=ya.indexOf("Trident"));va=!x&&-1!=ya.indexOf("WebKit");wa=!x&&!va&&!ua&&"Gecko"==za.product;}var Aa=x,y=ua,Ba=wa,z=va;function Ca(){var a=l.document;return a?a.documentMode:void 0;}var Da;a:{var Ea="",Fa;if(Aa&&l.opera){var Ga=l.opera.version,Ea="function"==typeof Ga?Ga():Ga;}else{if(Ba?Fa=/rv\:([^\);]+)(\)|;)/:y?Fa=/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/:z&&(Fa=/WebKit\/(\S+)/),Fa){var Ha=Fa.exec(xa()),Ea=Ha?Ha[1]:"";}}if(y){var Ia=Ca();if(Ia>parseFloat(Ea)){Da=String(Ia);break a;}}Da=Ea;}var Ja={};function A(a){var b;if(!(b=Ja[a])){b=0;for(var c=String(Da).replace(/^[\s\xa0]+|[\s\xa0]+$/g,"").split("."),d=String(a).replace(/^[\s\xa0]+|[\s\xa0]+$/g,"").split("."),e=Math.max(c.length,d.length),g=0;0==b&&g<e;g++){var h=c[g]||"",k=d[g]||"",u=RegExp("(\\d*)(\\D*)","g"),K=RegExp("(\\d*)(\\D*)","g");do{var v=u.exec(h)||["","",""],r=K.exec(k)||["","",""];if(0==v[0].length&&0==r[0].length){break;}b=ta(0==v[1].length?0:parseInt(v[1],10),0==r[1].length?0:parseInt(r[1],10))||ta(0==v[2].length,0==r[2].length)||ta(v[2],r[2]);}while(0==b);}b=Ja[a]=0<=b;}return b;}var La=l.document,Ma=La&&y?Ca()||("CSS1Compat"==La.compatMode?parseInt(Da,10):5):void 0;function Na(a){Error.captureStackTrace?Error.captureStackTrace(this,Na):this.stack=Error().stack||"";a&&(this.message=String(a));}s(Na,Error);Na.prototype.name="CustomError";function Oa(a,b){b.unshift(a);Na.call(this,ka.apply(null,b));b.shift();}s(Oa,Na);Oa.prototype.name="AssertionError";function Pa(a,b){throw new Oa("Failure"+(a?": "+a:""),Array.prototype.slice.call(arguments,1));};var Qa=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^/?#]*)@)?([^/#?]*?)(?::([0-9]+))?(?=[/#?]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#(.*))?$");function Ra(a){if(Sa){Sa=!1;var b=l.location;if(b){var c=b.href;if(c&&(c=(c=Ra(c)[3]||null)&&decodeURIComponent(c))&&c!=b.hostname){throw Sa=!0,Error();}}}return a.match(Qa);}var Sa=z;function Ta(a){var b=[],c=0,d;for(d in a){b[c++]=a[d];}return b;}function Ua(a){var b=[],c=0,d;for(d in a){b[c++]=d;}return b;}var Va="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Wa(a,b){for(var c,d,e=1;e<arguments.length;e++){d=arguments[e];for(c in d){a[c]=d[c];}for(var g=0;g<Va.length;g++){c=Va[g],Object.prototype.hasOwnProperty.call(d,c)&&(a[c]=d[c]);}}};var B=Array.prototype,Xa=B.indexOf?function(a,b,c){return B.indexOf.call(a,b,c);}:function(a,b,c){c=null==c?0:0>c?Math.max(0,a.length+c):c;if(n(a)){return n(b)&&1==b.length?a.indexOf(b,c):-1;}for(;c<a.length;c++){if(c in a&&a[c]===b){return c;}}return-1;},Ya=B.forEach?function(a,b,c){B.forEach.call(a,b,c);}:function(a,b,c){for(var d=a.length,e=n(a)?a.split(""):a,g=0;g<d;g++){g in e&&b.call(c,e[g],g,a);}};function Za(a){var b;a:{b=$a;for(var c=a.length,d=n(a)?a.split(""):a,e=0;e<c;e++){if(e in d&&b.call(void 0,d[e],e,a)){b=e;break a;}}b=-1;}return 0>b?null:n(a)?a.charAt(b):a[b];}function ab(a){return B.concat.apply(B,arguments);}function bb(a){var b=a.length;if(0<b){for(var c=Array(b),d=0;d<b;d++){c[d]=a[d];}return c;}return[];};function cb(a,b){this.O={};this.j=[];this.o=0;var c=arguments.length;if(1<c){if(c%2){throw Error("Uneven number of arguments");}for(var d=0;d<c;d+=2){this.set(arguments[d],arguments[d+1]);}}else{if(a){a instanceof cb?(c=a.ca(),d=a.N()):(c=Ua(a),d=Ta(a));for(var e=0;e<c.length;e++){this.set(c[e],d[e]);}}}}f=cb.prototype;f.N=function(){db(this);for(var a=[],b=0;b<this.j.length;b++){a.push(this.O[this.j[b]]);}return a;};f.ca=function(){db(this);return this.j.concat();};f.wa=function(a){return C(this.O,a);};f.remove=function(a){return C(this.O,a)?(delete this.O[a],this.o--,this.j.length>2*this.o&&db(this),!0):!1;};function db(a){if(a.o!=a.j.length){for(var b=0,c=0;b<a.j.length;){var d=a.j[b];C(a.O,d)&&(a.j[c++]=d);b++;}a.j.length=c;}if(a.o!=a.j.length){for(var e={},c=b=0;b<a.j.length;){d=a.j[b],C(e,d)||(a.j[c++]=d,e[d]=1),b++;}a.j.length=c;}}f.get=function(a,b){return C(this.O,a)?this.O[a]:b;};f.set=function(a,b){C(this.O,a)||(this.o++,this.j.push(a));this.O[a]=b;};f.n=function(){return new cb(this);};function C(a,b){return Object.prototype.hasOwnProperty.call(a,b);};function eb(a){if("function"==typeof a.N){return a.N();}if(n(a)){return a.split("");}if(ea(a)){for(var b=[],c=a.length,d=0;d<c;d++){b.push(a[d]);}return b;}return Ta(a);}function D(a,b,c){if("function"==typeof a.forEach){a.forEach(b,c);}else{if(ea(a)||n(a)){Ya(a,b,c);}else{var d;if("function"==typeof a.ca){d=a.ca();}else{if("function"!=typeof a.N){if(ea(a)||n(a)){d=[];for(var e=a.length,g=0;g<e;g++){d.push(g);}}else{d=Ua(a);}}else{d=void 0;}}for(var e=eb(a),g=e.length,h=0;h<g;h++){b.call(c,e[h],d&&d[h],a);}}}};function E(a,b){var c;if(a instanceof E){this.D=void 0!==b?b:a.D,fb(this,a.oa),c=a.eb,F(this),this.eb=c,gb(this,a.ja),hb(this,a.Ca),ib(this,a.I),jb(this,a.R.n()),c=a.Na,F(this),this.Na=c;}else{if(a&&(c=Ra(String(a)))){this.D=!!b;fb(this,c[1]||"",!0);var d=c[2]||"";F(this);this.eb=d?decodeURIComponent(d):"";gb(this,c[3]||"",!0);hb(this,c[4]);ib(this,c[5]||"",!0);jb(this,c[6]||"",!0);c=c[7]||"";F(this);this.Na=c?decodeURIComponent(c):"";}else{this.D=!!b,this.R=new kb(null,0,this.D);}}}f=E.prototype;f.oa="";f.eb="";f.ja="";f.Ca=null;f.I="";f.Na="";f.oc=!1;f.D=!1;f.toString=function(){var a=[],b=this.oa;b&&a.push(lb(b,mb),":");if(b=this.ja){a.push("//");var c=this.eb;c&&a.push(lb(c,mb),"@");a.push(encodeURIComponent(String(b)));b=this.Ca;null!=b&&a.push(":",String(b));}if(b=this.I){this.ja&&"/"!=b.charAt(0)&&a.push("/"),a.push(lb(b,"/"==b.charAt(0)?nb:ob));}(b=this.R.toString())&&a.push("?",b);(b=this.Na)&&a.push("#",lb(b,pb));return a.join("");};f.n=function(){return new E(this);};function fb(a,b,c){F(a);a.oa=c?b?decodeURIComponent(b):"":b;a.oa&&(a.oa=a.oa.replace(/:$/,""));}function gb(a,b,c){F(a);a.ja=c?b?decodeURIComponent(b):"":b;}function hb(a,b){F(a);if(b){b=Number(b);if(isNaN(b)||0>b){throw Error("Bad port number "+b);}a.Ca=b;}else{a.Ca=null;}}function ib(a,b,c){F(a);a.I=c?b?decodeURIComponent(b):"":b;}function jb(a,b,c){F(a);b instanceof kb?(a.R=b,a.R.ub(a.D)):(c||(b=lb(b,qb)),a.R=new kb(b,0,a.D));}function G(a,b,c){F(a);a.R.set(b,c);}function rb(a,b,c){F(a);m(c)||(c=[String(c)]);sb(a.R,b,c);}function H(a){F(a);G(a,"zx",sa());return a;}function F(a){if(a.oc){throw Error("Tried to modify a read-only Uri");}}f.ub=function(a){this.D=a;this.R&&this.R.ub(a);return this;};function tb(a){return a instanceof E?a.n():new E(a,void 0);}function ub(a,b,c,d){var e=new E(null,void 0);a&&fb(e,a);b&&gb(e,b);c&&hb(e,c);d&&ib(e,d);return e;}function lb(a,b){return n(a)?encodeURI(a).replace(b,vb):null;}function vb(a){a=a.charCodeAt(0);return"%"+(a>>4&15).toString(16)+(a&15).toString(16);}var mb=/[#\/\?@]/g,ob=/[\#\?:]/g,nb=/[\#\?]/g,qb=/[\#\?@]/g,pb=/#/g;function kb(a,b,c){this.C=a||null;this.D=!!c;}function I(a){if(!a.h&&(a.h=new cb(),a.o=0,a.C)){for(var b=a.C.split("&"),c=0;c<b.length;c++){var d=b[c].indexOf("="),e=null,g=null;0<=d?(e=b[c].substring(0,d),g=b[c].substring(d+1)):e=b[c];e=decodeURIComponent(e.replace(/\+/g," "));e=J(a,e);a.add(e,g?decodeURIComponent(g.replace(/\+/g," ")):"");}}}f=kb.prototype;f.h=null;f.o=null;f.add=function(a,b){I(this);this.C=null;a=J(this,a);var c=this.h.get(a);c||this.h.set(a,c=[]);c.push(b);this.o++;return this;};f.remove=function(a){I(this);a=J(this,a);return this.h.wa(a)?(this.C=null,this.o-=this.h.get(a).length,this.h.remove(a)):!1;};f.wa=function(a){I(this);a=J(this,a);return this.h.wa(a);};f.ca=function(){I(this);for(var a=this.h.N(),b=this.h.ca(),c=[],d=0;d<b.length;d++){for(var e=a[d],g=0;g<e.length;g++){c.push(b[d]);}}return c;};f.N=function(a){I(this);var b=[];if(n(a)){this.wa(a)&&(b=ab(b,this.h.get(J(this,a))));}else{a=this.h.N();for(var c=0;c<a.length;c++){b=ab(b,a[c]);}}return b;};f.set=function(a,b){I(this);this.C=null;a=J(this,a);this.wa(a)&&(this.o-=this.h.get(a).length);this.h.set(a,[b]);this.o++;return this;};f.get=function(a,b){var c=a?this.N(a):[];return 0<c.length?String(c[0]):b;};function sb(a,b,c){a.remove(b);0<c.length&&(a.C=null,a.h.set(J(a,b),bb(c)),a.o+=c.length);}f.toString=function(){if(this.C){return this.C;}if(!this.h){return"";}for(var a=[],b=this.h.ca(),c=0;c<b.length;c++){for(var d=b[c],e=encodeURIComponent(String(d)),d=this.N(d),g=0;g<d.length;g++){var h=e;""!==d[g]&&(h+="="+encodeURIComponent(String(d[g])));a.push(h);}}return this.C=a.join("&");};f.n=function(){var a=new kb();a.C=this.C;this.h&&(a.h=this.h.n(),a.o=this.o);return a;};function J(a,b){var c=String(b);a.D&&(c=c.toLowerCase());return c;}f.ub=function(a){a&&!this.D&&(I(this),this.C=null,D(this.h,function(a,c){var d=c.toLowerCase();c!=d&&(this.remove(c),sb(this,d,a));},this));this.D=a;};function wb(a){a=String(a);if(/^\s*$/.test(a)?0:/^[\],:{}\s\u2028\u2029]*$/.test(a.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r\u2028\u2029\x00-\x08\x0a-\x1f]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:[\s\u2028\u2029]*\[)+/g,""))){try{return eval("("+a+")");}catch(b){}}throw Error("Invalid JSON string: "+a);}function xb(a){return eval("("+a+")");}function yb(a){var b=[];zb(new Ab(),a,b);return b.join("");}function Ab(){this.Ya=void 0;}function zb(a,b,c){switch(_typeof(b)){case"string":Bb(b,c);break;case"number":c.push(isFinite(b)&&!isNaN(b)?b:"null");break;case"boolean":c.push(b);break;case"undefined":c.push("null");break;case"object":if(null==b){c.push("null");break;}if(m(b)){var d=b.length;c.push("[");for(var e="",g=0;g<d;g++){c.push(e),e=b[g],zb(a,a.Ya?a.Ya.call(b,String(g),e):e,c),e=",";}c.push("]");break;}c.push("{");d="";for(g in b){Object.prototype.hasOwnProperty.call(b,g)&&(e=b[g],"function"!=typeof e&&(c.push(d),Bb(g,c),c.push(":"),zb(a,a.Ya?a.Ya.call(b,g,e):e,c),d=","));}c.push("}");break;case"function":break;default:throw Error("Unknown type: "+_typeof(b));;}}var Cb={'"':'\\"',"\\":"\\\\","/":"\\/","\b":"\\b","\f":"\\f","\n":"\\n","\r":"\\r","\t":"\\t","\x0B":"\\u000b"},Db=/\uffff/.test("\uFFFF")?/[\\\"\x00-\x1f\x7f-\uffff]/g:/[\\\"\x00-\x1f\x7f-\xff]/g;function Bb(a,b){b.push('"',a.replace(Db,function(a){if(a in Cb){return Cb[a];}var b=a.charCodeAt(0),e="\\u";16>b?e+="000":256>b?e+="00":4096>b&&(e+="0");return Cb[a]=e+b.toString(16);}),'"');};function Eb(a){return Fb(a||arguments.callee.caller,[]);}function Fb(a,b){var c=[];if(0<=Xa(b,a)){c.push("[...circular reference...]");}else{if(a&&50>b.length){c.push(Gb(a)+"(");for(var d=a.arguments,e=0;e<d.length;e++){0<e&&c.push(", ");var g;g=d[e];switch(_typeof(g)){case"object":g=g?"object":"null";break;case"string":break;case"number":g=String(g);break;case"boolean":g=g?"true":"false";break;case"function":g=(g=Gb(g))?g:"[fn]";break;default:g=_typeof(g);}40<g.length&&(g=g.substr(0,40)+"...");c.push(g);}b.push(a);c.push(")\n");try{c.push(Fb(a.caller,b));}catch(h){c.push("[exception trying to get caller]\n");}}else{a?c.push("[...long stack...]"):c.push("[end]");}}return c.join("");}function Gb(a){if(Hb[a]){return Hb[a];}a=String(a);if(!Hb[a]){var b=/function ([^\(]+)/.exec(a);Hb[a]=b?b[1]:"[Anonymous]";}return Hb[a];}var Hb={};function Ib(a,b,c,d,e){this.reset(a,b,c,d,e);}Ib.prototype.Fb=null;Ib.prototype.Eb=null;var Jb=0;Ib.prototype.reset=function(a,b,c,d,e){"number"==typeof e||Jb++;d||q();this.Aa=a;this.qc=b;delete this.Fb;delete this.Eb;};Ib.prototype.$b=function(a){this.Aa=a;};function L(a){this.rc=a;}L.prototype.Sa=null;L.prototype.Aa=null;L.prototype.jb=null;L.prototype.Jb=null;function Kb(a,b){this.name=a;this.value=b;}Kb.prototype.toString=function(){return this.name;};var Lb=new Kb("SEVERE",1E3),Mb=new Kb("WARNING",900),Nb=new Kb("INFO",800),Ob=new Kb("CONFIG",700),Pb=new Kb("FINE",500);f=L.prototype;f.getParent=function(){return this.Sa;};f.$b=function(a){this.Aa=a;};function Qb(a){if(a.Aa){return a.Aa;}if(a.Sa){return Qb(a.Sa);}Pa("Root logger has no level set.");return null;}f.log=function(a,b,c){if(a.value>=Qb(this).value){for(fa(b)&&(b=b()),a=this.mc(a,b,c),b="log:"+a.qc,l.console&&(l.console.timeStamp?l.console.timeStamp(b):l.console.markTimeline&&l.console.markTimeline(b)),l.msWriteProfilerMark&&l.msWriteProfilerMark(b),b=this;b;){c=b;var d=a;if(c.Jb){for(var e=0,g=void 0;g=c.Jb[e];e++){g(d);}}b=b.getParent();}}};f.mc=function(a,b,c){var d=new Ib(a,String(b),this.rc);if(c){d.Fb=c;var e;var g=arguments.callee.caller;try{var h;var k=ba("window.location.href");if(n(c)){h={message:c,name:"Unknown error",lineNumber:"Not available",fileName:k,stack:"Not available"};}else{var u,K,v=!1;try{u=c.lineNumber||c.Ic||"Not available";}catch(r){u="Not available",v=!0;}try{K=c.fileName||c.filename||c.sourceURL||l.$googDebugFname||k;}catch(Ka){K="Not available",v=!0;}h=!v&&c.lineNumber&&c.fileName&&c.stack&&c.message&&c.name?c:{message:c.message||"Not available",name:c.name||"UnknownError",lineNumber:u,fileName:K,stack:c.stack||"Not available"};}e="Message: "+la(h.message)+'\nUrl: <a href="view-source:'+h.fileName+'" target="_new">'+h.fileName+"</a>\nLine: "+h.lineNumber+"\n\nBrowser stack:\n"+la(h.stack+"-> ")+"[end]\n\nJS stack traversal:\n"+la(Eb(g)+"-> ");}catch(w){e="Exception trying to expose exception! You win, we lose. "+w;}d.Eb=e;}return d;};f.J=function(a,b){this.log(Lb,a,b);};f.Z=function(a,b){this.log(Mb,a,b);};f.info=function(a,b){this.log(Nb,a,b);};var Rb={},Sb=null;function Tb(a){Sb||(Sb=new L(""),Rb[""]=Sb,Sb.$b(Ob));var b;if(!(b=Rb[a])){b=new L(a);var c=a.lastIndexOf("."),d=a.substr(c+1),c=Tb(a.substr(0,c));c.jb||(c.jb={});c.jb[d]=b;b.Sa=c;Rb[a]=b;}return b;};function M(a,b){a&&a.log(Pb,b,void 0);};function N(){this.r=Tb("goog.net.BrowserChannel");}function Ub(a,b,c,d){a.info("XMLHTTP TEXT ("+b+"): "+Vb(a,c)+(d?" "+d:""));}N.prototype.debug=function(a){this.info(a);};function Wb(a,b,c){a.J((c||"Exception")+b);}N.prototype.info=function(a){var b=this.r;b&&b.info(a,void 0);};N.prototype.Z=function(a){var b=this.r;b&&b.Z(a,void 0);};N.prototype.J=function(a){var b=this.r;b&&b.J(a,void 0);};function Vb(a,b){if(!b||b==Xb){return b;}try{var c=xb(b);if(c){for(var d=0;d<c.length;d++){if(m(c[d])){var e=c[d];if(!(2>e.length)){var g=e[1];if(m(g)&&!(1>g.length)){var h=g[0];if("noop"!=h&&"stop"!=h){for(var k=1;k<g.length;k++){g[k]="";}}}}}}}return yb(c);}catch(u){return a.debug("Exception parsing expected JS array - probably was not JS"),b;}};function Yb(a,b){this.P=b?xb:wb;}Yb.prototype.parse=function(a){return this.P(a);};function O(){0!=Zb&&($b[this[ga]||(this[ga]=++ha)]=this);}var Zb=0,$b={};O.prototype.mb=!1;O.prototype.Ja=function(){if(!this.mb&&(this.mb=!0,this.u(),0!=Zb)){var a=this[ga]||(this[ga]=++ha);delete $b[a];}};O.prototype.u=function(){if(this.Pb){for(;this.Pb.length;){this.Pb.shift()();}}};var ac="closure_listenable_"+(1E6*Math.random()|0);function bc(a){try{return!(!a||!a[ac]);}catch(b){return!1;}}var cc=0;function dc(a,b,c,d,e){this.fa=a;this.Ua=null;this.src=b;this.type=c;this.capture=!!d;this.Oa=e;this.key=++cc;this.na=this.Ia=!1;}function ec(a){a.na=!0;a.fa=null;a.Ua=null;a.src=null;a.Oa=null;};function P(a){this.src=a;this.s={};this.Ga=0;}P.prototype.add=function(a,b,c,d,e){var g=this.s[a];g||(g=this.s[a]=[],this.Ga++);var h=fc(g,b,d,e);-1<h?(a=g[h],c||(a.Ia=!1)):(a=new dc(b,this.src,a,!!d,e),a.Ia=c,g.push(a));return a;};P.prototype.remove=function(a,b,c,d){if(!(a in this.s)){return!1;}var e=this.s[a];b=fc(e,b,c,d);return-1<b?(ec(e[b]),B.splice.call(e,b,1),0==e.length&&(delete this.s[a],this.Ga--),!0):!1;};function gc(a,b){var c=b.type;if(!(c in a.s)){return!1;}var d=a.s[c],e=Xa(d,b),g;(g=0<=e)&&B.splice.call(d,e,1);g&&(ec(b),0==a.s[c].length&&(delete a.s[c],a.Ga--));return g;}P.prototype.Xa=function(a){var b=0,c;for(c in this.s){if(!a||c==a){for(var d=this.s[c],e=0;e<d.length;e++){++b,ec(d[e]);}delete this.s[c];this.Ga--;}}return b;};P.prototype.ya=function(a,b,c,d){a=this.s[a];var e=-1;a&&(e=fc(a,b,c,d));return-1<e?a[e]:null;};function fc(a,b,c,d){for(var e=0;e<a.length;++e){var g=a[e];if(!g.na&&g.fa==b&&g.capture==!!c&&g.Oa==d){return e;}}return-1;};var hc=!y||y&&9<=Ma,ic=y&&!A("9");!z||A("528");Ba&&A("1.9b")||y&&A("8")||Aa&&A("9.5")||z&&A("528");Ba&&!A("8")||y&&A("9");function Q(a,b){this.type=a;this.currentTarget=this.target=b;}f=Q.prototype;f.u=function(){};f.Ja=function(){};f.ga=!1;f.defaultPrevented=!1;f.Yb=!0;f.preventDefault=function(){this.defaultPrevented=!0;this.Yb=!1;};function jc(a){jc[" "](a);return a;}jc[" "]=ca;function kc(a,b){Q.call(this,a?a.type:"");this.relatedTarget=this.currentTarget=this.target=null;this.charCode=this.keyCode=this.button=this.screenY=this.screenX=this.clientY=this.clientX=this.offsetY=this.offsetX=0;this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1;this.Db=this.state=null;if(a){var c=this.type=a.type;this.target=a.target||a.srcElement;this.currentTarget=b;var d=a.relatedTarget;if(d){if(Ba){var e;a:{try{jc(d.nodeName);e=!0;break a;}catch(g){}e=!1;}e||(d=null);}}else{"mouseover"==c?d=a.fromElement:"mouseout"==c&&(d=a.toElement);}this.relatedTarget=d;this.offsetX=z||void 0!==a.offsetX?a.offsetX:a.layerX;this.offsetY=z||void 0!==a.offsetY?a.offsetY:a.layerY;this.clientX=void 0!==a.clientX?a.clientX:a.pageX;this.clientY=void 0!==a.clientY?a.clientY:a.pageY;this.screenX=a.screenX||0;this.screenY=a.screenY||0;this.button=a.button;this.keyCode=a.keyCode||0;this.charCode=a.charCode||("keypress"==c?a.keyCode:0);this.ctrlKey=a.ctrlKey;this.altKey=a.altKey;this.shiftKey=a.shiftKey;this.metaKey=a.metaKey;this.state=a.state;this.Db=a;a.defaultPrevented&&this.preventDefault();delete this.ga;}}s(kc,Q);kc.prototype.preventDefault=function(){kc.pa.preventDefault.call(this);var a=this.Db;if(a.preventDefault){a.preventDefault();}else{if(a.returnValue=!1,ic){try{if(a.ctrlKey||112<=a.keyCode&&123>=a.keyCode){a.keyCode=-1;}}catch(b){}}}};kc.prototype.u=function(){};var lc="closure_lm_"+(1E6*Math.random()|0),mc={},nc=0;function oc(a,b,c,d,e){if(m(b)){for(var g=0;g<b.length;g++){oc(a,b[g],c,d,e);}return null;}c=pc(c);if(bc(a)){a=a.Ra(b,c,d,e);}else{if(!b){throw Error("Invalid event type");}var g=!!d,h=qc(a);h||(a[lc]=h=new P(a));c=h.add(b,c,!1,d,e);c.Ua||(d=rc(),c.Ua=d,d.src=a,d.fa=c,a.addEventListener?a.addEventListener(b,d,g):a.attachEvent(b in mc?mc[b]:mc[b]="on"+b,d),nc++);a=c;}return a;}function rc(){var a=sc,b=hc?function(c){return a.call(b.src,b.fa,c);}:function(c){c=a.call(b.src,b.fa,c);if(!c){return c;}};return b;}function tc(a,b,c,d,e){if(m(b)){for(var g=0;g<b.length;g++){tc(a,b[g],c,d,e);}}else{c=pc(c),bc(a)?a.vb(b,c,d,e):a&&(a=qc(a))&&(b=a.ya(b,c,!!d,e))&&uc(b);}}function uc(a){if("number"==typeof a||!a||a.na){return!1;}var b=a.src;if(bc(b)){return gc(b.W,a);}var c=a.type,d=a.Ua;b.removeEventListener?b.removeEventListener(c,d,a.capture):b.detachEvent&&b.detachEvent(c in mc?mc[c]:mc[c]="on"+c,d);nc--;(c=qc(b))?(gc(c,a),0==c.Ga&&(c.src=null,b[lc]=null)):ec(a);return!0;}function vc(a,b,c,d){var e=1;if(a=qc(a)){if(b=a.s[b]){for(b=bb(b),a=0;a<b.length;a++){var g=b[a];g&&g.capture==c&&!g.na&&(e&=!1!==wc(g,d));}}}return Boolean(e);}function wc(a,b){var c=a.fa,d=a.Oa||a.src;a.Ia&&uc(a);return c.call(d,b);}function sc(a,b){if(a.na){return!0;}if(!hc){var c=b||ba("window.event"),d=new kc(c,this),e=!0;if(!(0>c.keyCode||void 0!=c.returnValue)){a:{var g=!1;if(0==c.keyCode){try{c.keyCode=-1;break a;}catch(h){g=!0;}}if(g||void 0==c.returnValue){c.returnValue=!0;}}c=[];for(g=d.currentTarget;g;g=g.parentNode){c.push(g);}for(var g=a.type,k=c.length-1;!d.ga&&0<=k;k--){d.currentTarget=c[k],e&=vc(c[k],g,!0,d);}for(k=0;!d.ga&&k<c.length;k++){d.currentTarget=c[k],e&=vc(c[k],g,!1,d);}}return e;}return wc(a,new kc(b,this));}function qc(a){a=a[lc];return a instanceof P?a:null;}var xc="__closure_events_fn_"+(1E9*Math.random()>>>0);function pc(a){return fa(a)?a:a[xc]||(a[xc]=function(b){return a.handleEvent(b);});};function R(){O.call(this);this.W=new P(this);this.fc=this;}s(R,O);R.prototype[ac]=!0;f=R.prototype;f.tb=null;f.addEventListener=function(a,b,c,d){oc(this,a,b,c,d);};f.removeEventListener=function(a,b,c,d){tc(this,a,b,c,d);};f.dispatchEvent=function(a){var b,c=this.tb;if(c){for(b=[];c;c=c.tb){b.push(c);}}var c=this.fc,d=a.type||a;if(n(a)){a=new Q(a,c);}else{if(a instanceof Q){a.target=a.target||c;}else{var e=a;a=new Q(d,c);Wa(a,e);}}var e=!0,g;if(b){for(var h=b.length-1;!a.ga&&0<=h;h--){g=a.currentTarget=b[h],e=yc(g,d,!0,a)&&e;}}a.ga||(g=a.currentTarget=c,e=yc(g,d,!0,a)&&e,a.ga||(e=yc(g,d,!1,a)&&e));if(b){for(h=0;!a.ga&&h<b.length;h++){g=a.currentTarget=b[h],e=yc(g,d,!1,a)&&e;}}return e;};f.u=function(){R.pa.u.call(this);this.W&&this.W.Xa(void 0);this.tb=null;};f.Ra=function(a,b,c,d){return this.W.add(String(a),b,!1,c,d);};f.vb=function(a,b,c,d){return this.W.remove(String(a),b,c,d);};function yc(a,b,c,d){b=a.W.s[String(b)];if(!b){return!0;}b=bb(b);for(var e=!0,g=0;g<b.length;++g){var h=b[g];if(h&&!h.na&&h.capture==c){var k=h.fa,u=h.Oa||h.src;h.Ia&&gc(a.W,h);e=!1!==k.call(u,d)&&e;}}return e&&!1!=d.Yb;}f.ya=function(a,b,c,d){return this.W.ya(String(a),b,c,d);};function zc(a,b){R.call(this);this.ea=a||1;this.ra=b||l;this.ib=p(this.Gc,this);this.sb=q();}s(zc,R);f=zc.prototype;f.enabled=!1;f.l=null;f.setInterval=function(a){this.ea=a;this.l&&this.enabled?(this.stop(),this.start()):this.l&&this.stop();};f.Gc=function(){if(this.enabled){var a=q()-this.sb;0<a&&a<0.8*this.ea?this.l=this.ra.setTimeout(this.ib,this.ea-a):(this.l&&(this.ra.clearTimeout(this.l),this.l=null),this.dispatchEvent(Ac),this.enabled&&(this.l=this.ra.setTimeout(this.ib,this.ea),this.sb=q()));}};f.start=function(){this.enabled=!0;this.l||(this.l=this.ra.setTimeout(this.ib,this.ea),this.sb=q());};f.stop=function(){this.enabled=!1;this.l&&(this.ra.clearTimeout(this.l),this.l=null);};f.u=function(){zc.pa.u.call(this);this.stop();delete this.ra;};var Ac="tick";function Bc(a,b,c){if(fa(a)){c&&(a=p(a,c));}else{if(a&&"function"==typeof a.handleEvent){a=p(a.handleEvent,a);}else{throw Error("Invalid listener argument");}}return 2147483647<b?-1:l.setTimeout(a,b||0);};function Cc(){}Cc.prototype.Ab=null;function Dc(a){var b;(b=a.Ab)||(b={},Ec(a)&&(b[0]=!0,b[1]=!0),b=a.Ab=b);return b;};var Fc;function Gc(){}s(Gc,Cc);function Hc(a){return(a=Ec(a))?new ActiveXObject(a):new XMLHttpRequest();}function Ec(a){if(!a.Kb&&"undefined"==typeof XMLHttpRequest&&"undefined"!=typeof ActiveXObject){for(var b=["MSXML2.XMLHTTP.6.0","MSXML2.XMLHTTP.3.0","MSXML2.XMLHTTP","Microsoft.XMLHTTP"],c=0;c<b.length;c++){var d=b[c];try{return new ActiveXObject(d),a.Kb=d;}catch(e){}}throw Error("Could not create ActiveXObject. ActiveX might be disabled, or MSXML might not be installed");}return a.Kb;}Fc=new Gc();function Ic(a){R.call(this);this.headers=new cb();this.gb=a||null;this.T=!1;this.fb=this.f=null;this.Mb=this.Qa="";this.ka=0;this.q="";this.da=this.qb=this.Pa=this.nb=!1;this.Fa=0;this.bb=null;this.Xb=Jc;this.cb=this.dc=!1;}s(Ic,R);var Jc="";Ic.prototype.r=Tb("goog.net.XhrIo");var Kc=/^https?$/i,Lc=["POST","PUT"];f=Ic.prototype;f.send=function(a,b,c,d){if(this.f){throw Error("[goog.net.XhrIo] Object is active with another request="+this.Qa+"; newUri="+a);}b=b?b.toUpperCase():"GET";this.Qa=a;this.q="";this.ka=0;this.Mb=b;this.nb=!1;this.T=!0;this.f=this.gb?Hc(this.gb):Hc(Fc);this.fb=this.gb?Dc(this.gb):Dc(Fc);this.f.onreadystatechange=p(this.Qb,this);try{M(this.r,S(this,"Opening Xhr")),this.qb=!0,this.f.open(b,a,!0),this.qb=!1;}catch(e){M(this.r,S(this,"Error opening Xhr: "+e.message));Mc(this,e);return;}a=c||"";var g=this.headers.n();d&&D(d,function(a,b){g.set(b,a);});d=Za(g.ca());c=l.FormData&&a instanceof l.FormData;!(0<=Xa(Lc,b))||d||c||g.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");D(g,function(a,b){this.f.setRequestHeader(b,a);},this);this.Xb&&(this.f.responseType=this.Xb);"withCredentials"in this.f&&(this.f.withCredentials=this.dc);try{Nc(this),0<this.Fa&&(this.cb=Oc(this.f),M(this.r,S(this,"Will abort after "+this.Fa+"ms if incomplete, xhr2 "+this.cb)),this.cb?(this.f.timeout=this.Fa,this.f.ontimeout=p(this.qa,this)):this.bb=Bc(this.qa,this.Fa,this)),M(this.r,S(this,"Sending request")),this.Pa=!0,this.f.send(a),this.Pa=!1;}catch(h){M(this.r,S(this,"Send error: "+h.message)),Mc(this,h);}};function Oc(a){return y&&A(9)&&"number"==typeof a.timeout&&void 0!==a.ontimeout;}function $a(a){return"content-type"==a.toLowerCase();}f.qa=function(){"undefined"!=typeof aa&&this.f&&(this.q="Timed out after "+this.Fa+"ms, aborting",this.ka=8,M(this.r,S(this,this.q)),this.dispatchEvent("timeout"),this.abort(8));};function Mc(a,b){a.T=!1;a.f&&(a.da=!0,a.f.abort(),a.da=!1);a.q=b;a.ka=5;Pc(a);Qc(a);}function Pc(a){a.nb||(a.nb=!0,a.dispatchEvent("complete"),a.dispatchEvent("error"));}f.abort=function(a){this.f&&this.T&&(M(this.r,S(this,"Aborting")),this.T=!1,this.da=!0,this.f.abort(),this.da=!1,this.ka=a||7,this.dispatchEvent("complete"),this.dispatchEvent("abort"),Qc(this));};f.u=function(){this.f&&(this.T&&(this.T=!1,this.da=!0,this.f.abort(),this.da=!1),Qc(this,!0));Ic.pa.u.call(this);};f.Qb=function(){this.mb||(this.qb||this.Pa||this.da?Rc(this):this.uc());};f.uc=function(){Rc(this);};function Rc(a){if(a.T&&"undefined"!=typeof aa){if(a.fb[1]&&4==T(a)&&2==Sc(a)){M(a.r,S(a,"Local request error detected and ignored"));}else{if(a.Pa&&4==T(a)){Bc(a.Qb,0,a);}else{if(a.dispatchEvent("readystatechange"),4==T(a)){M(a.r,S(a,"Request complete"));a.T=!1;try{var b=Sc(a),c,d;a:{switch(b){case 200:;case 201:;case 202:;case 204:;case 206:;case 304:;case 1223:d=!0;break a;default:d=!1;}}if(!(c=d)){var e;if(e=0===b){var g=Ra(String(a.Qa))[1]||null;if(!g&&self.location){var h=self.location.protocol,g=h.substr(0,h.length-1);}e=!Kc.test(g?g.toLowerCase():"");}c=e;}if(c){a.dispatchEvent("complete"),a.dispatchEvent("success");}else{a.ka=6;var k;try{k=2<T(a)?a.f.statusText:"";}catch(u){M(a.r,"Can not get status: "+u.message),k="";}a.q=k+" ["+Sc(a)+"]";Pc(a);}}finally{Qc(a);}}}}}}function Qc(a,b){if(a.f){Nc(a);var c=a.f,d=a.fb[0]?ca:null;a.f=null;a.fb=null;b||a.dispatchEvent("ready");try{c.onreadystatechange=d;}catch(e){(c=a.r)&&c.J("Problem encountered resetting onreadystatechange: "+e.message,void 0);}}}function Nc(a){a.f&&a.cb&&(a.f.ontimeout=null);"number"==typeof a.bb&&(l.clearTimeout(a.bb),a.bb=null);}f.isActive=function(){return!!this.f;};function T(a){return a.f?a.f.readyState:0;}function Sc(a){try{return 2<T(a)?a.f.status:-1;}catch(b){return(a=a.r)&&a.Z("Can not get status: "+b.message,void 0),-1;}}function Tc(a){try{return a.f?a.f.responseText:"";}catch(b){return M(a.r,"Can not get responseText: "+b.message),"";}}f.Ib=function(){return n(this.q)?this.q:String(this.q);};function S(a,b){return b+" ["+a.Mb+" "+a.Qa+" "+Sc(a)+"]";};function Uc(){this.Wb=q();}new Uc();Uc.prototype.set=function(a){this.Wb=a;};Uc.prototype.reset=function(){this.set(q());};Uc.prototype.get=function(){return this.Wb;};function Vc(a){O.call(this);this.e=a;this.j={};}s(Vc,O);var Wc=[];f=Vc.prototype;f.Ra=function(a,b,c,d){m(b)||(Wc[0]=b,b=Wc);for(var e=0;e<b.length;e++){var g=oc(a,b[e],c||this.handleEvent,d||!1,this.e||this);if(!g){break;}this.j[g.key]=g;}return this;};f.vb=function(a,b,c,d,e){if(m(b)){for(var g=0;g<b.length;g++){this.vb(a,b[g],c,d,e);}}else{c=c||this.handleEvent,e=e||this.e||this,c=pc(c),d=!!d,b=bc(a)?a.ya(b,c,d,e):a?(a=qc(a))?a.ya(b,c,d,e):null:null,b&&(uc(b),delete this.j[b.key]);}return this;};f.Xa=function(){var a=this.j,b=uc,c;for(c in a){b.call(void 0,a[c],c,a);}this.j={};};f.u=function(){Vc.pa.u.call(this);this.Xa();};f.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented");};function Xc(a,b,c){O.call(this);this.pc=a;this.ea=b;this.e=c;this.jc=p(this.vc,this);}s(Xc,O);f=Xc.prototype;f.Za=!1;f.Vb=0;f.l=null;f.stop=function(){this.l&&(l.clearTimeout(this.l),this.l=null,this.Za=!1);};f.u=function(){Xc.pa.u.call(this);this.stop();};f.vc=function(){this.l=null;this.Za&&!this.Vb&&(this.Za=!1,Yc(this));};function Yc(a){a.l=Bc(a.jc,a.ea);a.pc.call(a.e);};function U(a,b,c,d,e){this.b=a;this.a=b;this.Y=c;this.B=d;this.Ea=e||1;this.qa=Zc;this.ob=new Vc(this);this.Ta=new zc();this.Ta.setInterval($c);}f=U.prototype;f.v=null;f.F=!1;f.ua=null;f.xb=null;f.Da=null;f.sa=null;f.U=null;f.w=null;f.X=null;f.k=null;f.Ha=0;f.K=null;f.ta=null;f.q=null;f.g=-1;f.Zb=!0;f.$=!1;f.ma=0;f.Va=null;var Zc=45E3,$c=250;function ad(a,b){switch(a){case 0:return"Non-200 return code ("+b+")";case 1:return"XMLHTTP failure (no data)";case 2:return"HttpConnection timeout";default:return"Unknown error";}}var bd={},dd={};function ed(){return!y||y&&10<=Ma;}f=U.prototype;f.S=function(a){this.v=a;};f.setTimeout=function(a){this.qa=a;};f.bc=function(a){this.ma=a;};function fd(a,b,c){a.sa=1;a.U=H(b.n());a.X=c;a.Cb=!0;gd(a,null);}function hd(a,b,c,d,e){a.sa=1;a.U=H(b.n());a.X=null;a.Cb=c;e&&(a.Zb=!1);gd(a,d);}function gd(a,b){a.Da=q();id(a);a.w=a.U.n();rb(a.w,"t",a.Ea);a.Ha=0;a.k=a.b.lb(a.b.$a()?b:null);0<a.ma&&(a.Va=new Xc(p(a.ec,a,a.k),a.ma));a.ob.Ra(a.k,"readystatechange",a.Bc);var c;if(a.v){c=a.v;var d={},e;for(e in c){d[e]=c[e];}c=d;}else{c={};}a.X?(a.ta="POST",c["Content-Type"]="application/x-www-form-urlencoded",a.k.send(a.w,a.ta,a.X,c)):(a.ta="GET",a.Zb&&!z&&(c.Connection="close"),a.k.send(a.w,a.ta,null,c));a.b.H(jd);if(d=a.X){for(c="",d=d.split("&"),e=0;e<d.length;e++){var g=d[e].split("=");if(1<g.length){var h=g[0],g=g[1],k=h.split("_");c=2<=k.length&&"type"==k[1]?c+(h+"="+g+"&"):c+(h+"=redacted&");}}}else{c=null;}a.a.info("XMLHTTP REQ ("+a.B+") [attempt "+a.Ea+"]: "+a.ta+"\n"+a.w+"\n"+c);}f.Bc=function(a){a=a.target;var b=this.Va;b&&3==T(a)?(this.a.debug("Throttling readystatechange."),b.l||b.Vb?b.Za=!0:Yc(b)):this.ec(a);};f.ec=function(a){try{if(a==this.k){a:{var b=T(this.k),c=this.k.ka,d=Sc(this.k);if(!ed()||z&&!A("420+")){if(4>b){break a;}}else{if(3>b||3==b&&!Aa&&!Tc(this.k)){break a;}}this.$||4!=b||7==c||(8==c||0>=d?this.b.H(kd):this.b.H(ld));md(this);var e=Sc(this.k);this.g=e;var g=Tc(this.k);g||this.a.debug("No response text for uri "+this.w+" status "+e);this.F=200==e;this.a.info("XMLHTTP RESP ("+this.B+") [ attempt "+this.Ea+"]: "+this.ta+"\n"+this.w+"\n"+b+" "+e);this.F?(4==b&&V(this),this.Cb?(nd(this,b,g),Aa&&this.F&&3==b&&(this.ob.Ra(this.Ta,Ac,this.Ac),this.Ta.start())):(Ub(this.a,this.B,g,null),od(this,g)),this.F&&!this.$&&(4==b?this.b.la(this):(this.F=!1,id(this)))):(400==e&&0<g.indexOf("Unknown SID")?(this.q=3,W(),this.a.Z("XMLHTTP Unknown SID ("+this.B+")")):(this.q=0,W(),this.a.Z("XMLHTTP Bad status "+e+" ("+this.B+")")),V(this),pd(this));}}else{this.a.Z("Called back with an unexpected xmlhttp");}}catch(h){this.a.debug("Failed call to OnXmlHttpReadyStateChanged_"),this.k&&Tc(this.k)?Wb(this.a,h,"ResponseText: "+Tc(this.k)):Wb(this.a,h,"No response text");}finally{}};function nd(a,b,c){for(var d=!0;!a.$&&a.Ha<c.length;){var e=qd(a,c);if(e==dd){4==b&&(a.q=4,W(),d=!1);Ub(a.a,a.B,null,"[Incomplete Response]");break;}else{if(e==bd){a.q=4;W();Ub(a.a,a.B,c,"[Invalid Chunk]");d=!1;break;}else{Ub(a.a,a.B,e,null),od(a,e);}}}4==b&&0==c.length&&(a.q=1,W(),d=!1);a.F=a.F&&d;d||(Ub(a.a,a.B,c,"[Invalid Chunked Response]"),V(a),pd(a));}f.Ac=function(){var a=T(this.k),b=Tc(this.k);this.Ha<b.length&&(md(this),nd(this,a,b),this.F&&4!=a&&id(this));};function qd(a,b){var c=a.Ha,d=b.indexOf("\n",c);if(-1==d){return dd;}c=Number(b.substring(c,d));if(isNaN(c)){return bd;}d+=1;if(d+c>b.length){return dd;}var e=b.substr(d,c);a.Ha=d+c;return e;}function rd(a,b){a.Da=q();id(a);var c=b?window.location.hostname:"";a.w=a.U.n();G(a.w,"DOMAIN",c);G(a.w,"t",a.Ea);try{a.K=new ActiveXObject("htmlfile");}catch(d){a.a.J("ActiveX blocked");V(a);a.q=7;W();pd(a);return;}var e="<html><body>";b&&(e+='<script>document.domain="'+c+'"\x3c/script>');e+="</body></html>";a.K.open();a.K.write(e);a.K.close();a.K.parentWindow.m=p(a.yc,a);a.K.parentWindow.d=p(a.Ub,a,!0);a.K.parentWindow.rpcClose=p(a.Ub,a,!1);c=a.K.createElement("div");a.K.parentWindow.document.body.appendChild(c);c.innerHTML='<iframe src="'+a.w+'"></iframe>';a.a.info("TRIDENT REQ ("+a.B+") [ attempt "+a.Ea+"]: GET\n"+a.w);a.b.H(jd);}f.yc=function(a){Y(p(this.xc,this,a),0);};f.xc=function(a){if(!this.$){var b=this.a;b.info("TRIDENT TEXT ("+this.B+"): "+Vb(b,a));md(this);od(this,a);id(this);}};f.Ub=function(a){Y(p(this.wc,this,a),0);};f.wc=function(a){this.$||(this.a.info("TRIDENT TEXT ("+this.B+"): "+a?"success":"failure"),V(this),this.F=a,this.b.la(this),this.b.H(sd));};f.nc=function(){md(this);this.b.la(this);};f.cancel=function(){this.$=!0;V(this);};function id(a){a.xb=q()+a.qa;td(a,a.qa);}function td(a,b){if(null!=a.ua){throw Error("WatchDog timer not null");}a.ua=Y(p(a.zc,a),b);}function md(a){a.ua&&(l.clearTimeout(a.ua),a.ua=null);}f.zc=function(){this.ua=null;var a=q();0<=a-this.xb?(this.F&&this.a.J("Received watchdog timeout even though request loaded successfully"),this.a.info("TIMEOUT: "+this.w),2!=this.sa&&this.b.H(kd),V(this),this.q=2,W(),pd(this)):(this.a.Z("WatchDog timer called too early"),td(this,this.xb-a));};function pd(a){a.b.Lb()||a.$||a.b.la(a);}function V(a){md(a);var b=a.Va;b&&"function"==typeof b.Ja&&b.Ja();a.Va=null;a.Ta.stop();a.ob.Xa();a.k&&(b=a.k,a.k=null,b.abort(),b.Ja());a.K&&(a.K=null);}f.Ib=function(){return this.q;};function od(a,b){try{a.b.Rb(a,b),a.b.H(sd);}catch(c){Wb(a.a,c,"Error in httprequest callback");}};function ud(a,b,c,d,e){new N().debug("TestLoadImageWithRetries: "+e);if(0==d){c(!1);}else{var g=e||0;d--;vd(a,b,function(e){e?c(!0):l.setTimeout(function(){ud(a,b,c,d,g);},g);});}}function vd(a,b,c){function d(a,b){return function(){try{e.debug("TestLoadImage: "+b),g.onload=null,g.onerror=null,g.onabort=null,g.ontimeout=null,l.clearTimeout(h),c(a);}catch(d){Wb(e,d);}};}var e=new N();e.debug("TestLoadImage: loading "+a);var g=new Image(),h=null;g.onload=d(!0,"loaded");g.onerror=d(!1,"error");g.onabort=d(!1,"abort");g.ontimeout=d(!1,"timeout");h=l.setTimeout(function(){if(g.ontimeout){g.ontimeout();}},b);g.src=a;};function wd(a,b){this.b=a;this.a=b;this.P=new Yb(0,!0);}f=wd.prototype;f.v=null;f.A=null;f.Wa=!1;f.cc=null;f.La=null;f.rb=null;f.I=null;f.c=null;f.g=-1;f.L=null;f.va=null;f.S=function(a){this.v=a;};f.ac=function(a){this.P=a;};f.kb=function(a){this.I=a;a=xd(this.b,this.I);W();this.cc=q();var b=this.b.Gb;null!=b?(this.L=this.b.correctHostPrefix(b[0]),(this.va=b[1])?(this.c=1,yd(this)):(this.c=2,zd(this))):(rb(a,"MODE","init"),this.A=new U(this,this.a,void 0,void 0,void 0),this.A.S(this.v),hd(this.A,a,!1,null,!0),this.c=0);};function yd(a){var b=Ad(a.b,a.va,"/mail/images/cleardot.gif");H(b);ud(b.toString(),5E3,p(a.kc,a),3,2E3);a.H(jd);}f.kc=function(a){if(a){this.c=2,zd(this);}else{W();var b=this.b;b.a.debug("Test Connection Blocked");b.g=b.V.g;Z(b,9);}a&&this.H(ld);};function zd(a){a.a.debug("TestConnection: starting stage 2");var b=a.b.Dc;if(null!=b){a.a.debug("TestConnection: skipping stage 2, precomputed result is "+b?"Buffered":"Unbuffered"),W(),b?(W(),Bd(a.b,a,!1)):(W(),Bd(a.b,a,!0));}else{if(a.A=new U(a,a.a,void 0,void 0,void 0),a.A.S(a.v),b=Cd(a.b,a.L,a.I),W(),ed()){rb(b,"TYPE","xmlhttp"),hd(a.A,b,!1,a.L,!1);}else{rb(b,"TYPE","html");var c=a.A;a=Boolean(a.L);c.sa=3;c.U=H(b.n());rd(c,a);}}}f.lb=function(a){return this.b.lb(a);};f.abort=function(){this.A&&(this.A.cancel(),this.A=null);this.g=-1;};f.Lb=function(){return!1;};f.Rb=function(a,b){this.g=a.g;if(0==this.c){if(this.a.debug("TestConnection: Got data for stage 1"),b){try{var c=this.P.parse(b);}catch(d){Wb(this.a,d);Dd(this.b,this);return;}this.L=this.b.correctHostPrefix(c[0]);this.va=c[1];}else{this.a.debug("TestConnection: Null responseText"),Dd(this.b,this);}}else{if(2==this.c){if(this.Wa){W(),this.rb=q();}else{if("11111"==b){if(W(),this.Wa=!0,this.La=q(),c=this.La-this.cc,ed()||500>c){this.g=200,this.A.cancel(),this.a.debug("Test connection succeeded; using streaming connection"),W(),Bd(this.b,this,!0);}}else{W(),this.La=this.rb=q(),this.Wa=!1;}}}}};f.la=function(){this.g=this.A.g;if(!this.A.F){this.a.debug("TestConnection: request failed, in state "+this.c),0==this.c?W():2==this.c&&W(),Dd(this.b,this);}else{if(0==this.c){this.a.debug("TestConnection: request complete for initial check"),this.va?(this.c=1,yd(this)):(this.c=2,zd(this));}else{if(2==this.c){this.a.debug("TestConnection: request complete for stage 2");var a=!1;(a=ed()?this.Wa:200>this.rb-this.La?!1:!0)?(this.a.debug("Test connection succeeded; using streaming connection"),W(),Bd(this.b,this,!0)):(this.a.debug("Test connection failed; not using streaming"),W(),Bd(this.b,this,!1));}}}};f.$a=function(){return this.b.$a();};f.isActive=function(){return this.b.isActive();};f.H=function(a){this.b.H(a);};function Ed(a,b,c){this.Bb=a||null;this.c=Fd;this.t=[];this.Q=[];this.a=new N();this.P=new Yb(0,!0);this.Gb=b||null;this.Dc=null!=c?c:null;}function Gd(a,b){this.Ob=a;this.map=b;}f=Ed.prototype;f.v=null;f.xa=null;f.p=null;f.i=null;f.I=null;f.Ma=null;f.zb=null;f.L=null;f.hc=!0;f.Ba=0;f.sc=0;f.Ka=!1;f.e=null;f.G=null;f.M=null;f.aa=null;f.V=null;f.wb=null;f.gc=!0;f.za=-1;f.Nb=-1;f.g=-1;f.ba=0;f.ha=0;f.ic=5E3;f.Cc=1E4;f.pb=2;f.Hb=2E4;f.ma=0;f.ab=!1;f.ia=8;var Fd=1,Hd=new R();function Id(a){Q.call(this,"statevent",a);}s(Id,Q);function Jd(a,b){Q.call(this,"timingevent",a);this.size=b;}s(Jd,Q);var jd=1,ld=2,kd=3,sd=4;function Kd(a){Q.call(this,"serverreachability",a);}s(Kd,Q);var Xb="y2f%";f=Ed.prototype;f.kb=function(a,b,c,d,e){this.a.debug("connect()");W();this.I=b;this.xa=c||{};d&&void 0!==e&&(this.xa.OSID=d,this.xa.OAID=e);this.a.debug("connectTest_()");Ld(this)&&(this.V=new wd(this,this.a),this.V.S(this.v),this.V.ac(this.P),this.V.kb(a));};f.disconnect=function(){this.a.debug("disconnect()");Md(this);if(3==this.c){var a=this.Ba++,b=this.Ma.n();G(b,"SID",this.Y);G(b,"RID",a);G(b,"TYPE","terminate");Nd(this,b);a=new U(this,this.a,this.Y,a,void 0);a.sa=2;a.U=H(b.n());b=new Image();b.src=a.U;b.onload=b.onerror=p(a.nc,a);a.Da=q();id(a);}Od(this);};function Md(a){a.V&&(a.V.abort(),a.V=null);a.i&&(a.i.cancel(),a.i=null);a.M&&(l.clearTimeout(a.M),a.M=null);Pd(a);a.p&&(a.p.cancel(),a.p=null);a.G&&(l.clearTimeout(a.G),a.G=null);}f.S=function(a){this.v=a;};f.bc=function(a){this.ma=a;};f.Lb=function(){return 0==this.c;};f.ac=function(a){this.P=a;};function Qd(a){a.p||a.G||(a.G=Y(p(a.Tb,a),0),a.ba=0);}f.Tb=function(a){this.G=null;this.a.debug("startForwardChannel_");if(Ld(this)){if(this.c==Fd){if(a){this.a.J("Not supposed to retry the open");}else{this.a.debug("open_()");this.Ba=Math.floor(1E5*Math.random());a=this.Ba++;var b=new U(this,this.a,"",a,void 0);b.S(this.v);var c=Rd(this),d=this.Ma.n();G(d,"RID",a);this.Bb&&G(d,"CVER",this.Bb);Nd(this,d);fd(b,d,c);this.p=b;this.c=2;}}else{3==this.c&&(a?Sd(this,a):0==this.t.length?this.a.debug("startForwardChannel_ returned: nothing to send"):this.p?this.a.J("startForwardChannel_ returned: connection already in progress"):(Sd(this),this.a.debug("startForwardChannel_ finished, sent request")));}}};function Sd(a,b){var c,d;b?6<a.ia?(a.t=a.Q.concat(a.t),a.Q.length=0,c=a.Ba-1,d=Rd(a)):(c=b.B,d=b.X):(c=a.Ba++,d=Rd(a));var e=a.Ma.n();G(e,"SID",a.Y);G(e,"RID",c);G(e,"AID",a.za);Nd(a,e);c=new U(a,a.a,a.Y,c,a.ba+1);c.S(a.v);c.setTimeout(Math.round(0.5*a.Hb)+Math.round(0.5*a.Hb*Math.random()));a.p=c;fd(c,e,d);}function Nd(a,b){if(a.e){var c=a.e.getAdditionalParams(a);c&&D(c,function(a,c){G(b,c,a);});}}function Rd(a){var b=Math.min(a.t.length,1E3),c=["count="+b],d;6<a.ia&&0<b?(d=a.t[0].Ob,c.push("ofs="+d)):d=0;for(var e=0;e<b;e++){var g=a.t[e].Ob,h=a.t[e].map,g=6>=a.ia?e:g-d;try{D(h,function(a,b){c.push("req"+g+"_"+b+"="+encodeURIComponent(a));});}catch(k){c.push("req"+g+"_type="+encodeURIComponent("_badmap")),a.e&&a.e.badMapError(a,h);}}a.Q=a.Q.concat(a.t.splice(0,b));return c.join("&");}function Td(a){a.i||a.M||(a.yb=1,a.M=Y(p(a.Sb,a),0),a.ha=0);}function Ud(a){if(a.i||a.M){return a.a.J("Request already in progress"),!1;}if(3<=a.ha){return!1;}a.a.debug("Going to retry GET");a.yb++;a.M=Y(p(a.Sb,a),Vd(a,a.ha));a.ha++;return!0;}f.Sb=function(){this.M=null;if(Ld(this)){this.a.debug("Creating new HttpRequest");this.i=new U(this,this.a,this.Y,"rpc",this.yb);this.i.S(this.v);this.i.bc(this.ma);var a=this.zb.n();G(a,"RID","rpc");G(a,"SID",this.Y);G(a,"CI",this.wb?"0":"1");G(a,"AID",this.za);Nd(this,a);if(ed()){G(a,"TYPE","xmlhttp"),hd(this.i,a,!0,this.L,!1);}else{G(a,"TYPE","html");var b=this.i,c=Boolean(this.L);b.sa=3;b.U=H(a.n());rd(b,c);}this.a.debug("New Request created");}};function Ld(a){if(a.e){var b=a.e.okToMakeRequest(a);if(0!=b){return a.a.debug("Handler returned error code from okToMakeRequest"),Z(a,b),!1;}}return!0;}function Bd(a,b,c){a.a.debug("Test Connection Finished");a.wb=a.gc&&c;a.g=b.g;a.a.debug("connectChannel_()");a.lc(Fd,0);a.Ma=xd(a,a.I);Qd(a);}function Dd(a,b){a.a.debug("Test Connection Failed");a.g=b.g;Z(a,2);}f.Rb=function(a,b){if(0!=this.c&&(this.i==a||this.p==a)){if(this.g=a.g,this.p==a&&3==this.c){if(7<this.ia){var c;try{c=this.P.parse(b);}catch(d){c=null;}if(m(c)&&3==c.length){var e=c;if(0==e[0]){a:{if(this.a.debug("Server claims our backchannel is missing."),this.M){this.a.debug("But we are currently starting the request.");}else{if(this.i){if(this.i.Da+3E3<this.p.Da){Pd(this),this.i.cancel(),this.i=null;}else{break a;}}else{this.a.Z("We do not have a BackChannel established");}Ud(this);W();}}}else{this.Nb=e[1],c=this.Nb-this.za,0<c&&(e=e[2],this.a.debug(e+" bytes (in "+c+" arrays) are outstanding on the BackChannel"),37500>e&&this.wb&&0==this.ha&&!this.aa&&(this.aa=Y(p(this.tc,this),6E3)));}}else{this.a.debug("Bad POST response data returned"),Z(this,11);}}else{b!=Xb&&(this.a.debug("Bad data returned - missing/invald magic cookie"),Z(this,11));}}else{if(this.i==a&&Pd(this),!/^[\s\xa0]*$/.test(b)){c=this.P.parse(b);for(var e=this.e&&this.e.channelHandleMultipleArrays?[]:null,g=0;g<c.length;g++){var h=c[g];this.za=h[0];h=h[1];2==this.c?"c"==h[0]?(this.Y=h[1],this.L=this.correctHostPrefix(h[2]),h=h[3],this.ia=null!=h?h:6,this.c=3,this.e&&this.e.channelOpened(this),this.zb=Cd(this,this.L,this.I),Td(this)):"stop"==h[0]&&Z(this,7):3==this.c&&("stop"==h[0]?(e&&0!=e.length&&(this.e.channelHandleMultipleArrays(this,e),e.length=0),Z(this,7)):"noop"!=h[0]&&(e?e.push(h):this.e&&this.e.channelHandleArray(this,h)),this.ha=0);}e&&0!=e.length&&this.e.channelHandleMultipleArrays(this,e);}}}};f.correctHostPrefix=function(a){return this.hc?this.e?this.e.correctHostPrefix(a):a:null;};f.tc=function(){null!=this.aa&&(this.aa=null,this.i.cancel(),this.i=null,Ud(this),W());};function Pd(a){null!=a.aa&&(l.clearTimeout(a.aa),a.aa=null);}f.la=function(a){this.a.debug("Request complete");var b;if(this.i==a){Pd(this),this.i=null,b=2;}else{if(this.p==a){this.p=null,b=1;}else{return;}}this.g=a.g;if(0!=this.c){if(a.F){1==b?(q(),Hd.dispatchEvent(new Jd(Hd,a.X?a.X.length:0)),Qd(this),this.Q.length=0):Td(this);}else{var c=a.Ib();if(3==c||7==c||0==c&&0<this.g){this.a.debug("Not retrying due to error type");}else{this.a.debug("Maybe retrying, last error: "+ad(c,this.g));var d;if(d=1==b){this.p||this.G?(this.a.J("Request already in progress"),d=!1):this.c==Fd||this.ba>=(this.Ka?0:this.pb)?d=!1:(this.a.debug("Going to retry POST"),this.G=Y(p(this.Tb,this,a),Vd(this,this.ba)),this.ba++,d=!0);}if(d||2==b&&Ud(this)){return;}this.a.debug("Exceeded max number of retries");}this.a.debug("Error: HTTP request failed");switch(c){case 1:Z(this,5);break;case 4:Z(this,10);break;case 3:Z(this,6);break;case 7:Z(this,12);break;default:Z(this,2);}}}};function Vd(a,b){var c=a.ic+Math.floor(Math.random()*a.Cc);a.isActive()||(a.a.debug("Inactive channel"),c*=2);return c*b;}f.lc=function(a){if(!(0<=Xa(arguments,this.c))){throw Error("Unexpected channel state: "+this.c);}};function Z(a,b){a.a.info("Error code "+b);if(2==b||9==b){var c=null;a.e&&(c=a.e.getNetworkTestImageUri(a));var d=p(a.Fc,a);c||(c=new E("//www.google.com/images/cleardot.gif"),H(c));vd(c.toString(),1E4,d);}else{W();}Wd(a,b);}f.Fc=function(a){a?(this.a.info("Successfully pinged google.com"),W()):(this.a.info("Failed to ping google.com"),W(),Wd(this,8));};function Wd(a,b){a.a.debug("HttpChannel: error - "+b);a.c=0;a.e&&a.e.channelError(a,b);Od(a);Md(a);}function Od(a){a.c=0;a.g=-1;if(a.e){if(0==a.Q.length&&0==a.t.length){a.e.channelClosed(a);}else{a.a.debug("Number of undelivered maps, pending: "+a.Q.length+", outgoing: "+a.t.length);var b=bb(a.Q),c=bb(a.t);a.Q.length=0;a.t.length=0;a.e.channelClosed(a,b,c);}}}function xd(a,b){var c=Ad(a,null,b);a.a.debug("GetForwardChannelUri: "+c);return c;}function Cd(a,b,c){b=Ad(a,a.$a()?b:null,c);a.a.debug("GetBackChannelUri: "+b);return b;}function Ad(a,b,c){var d=tb(c);if(""!=d.ja){b&&gb(d,b+"."+d.ja),hb(d,d.Ca);}else{var e=window.location,d=ub(e.protocol,b?b+"."+e.hostname:e.hostname,e.port,c);}a.xa&&D(a.xa,function(a,b){G(d,b,a);});G(d,"VER",a.ia);Nd(a,d);return d;}f.lb=function(a){if(a&&!this.ab){throw Error("Can't create secondary domain capable XhrIo object.");}a=new Ic();a.dc=this.ab;return a;};f.isActive=function(){return!!this.e&&this.e.isActive(this);};function Y(a,b){if(!fa(a)){throw Error("Fn must not be null and must be a function");}return l.setTimeout(function(){a();},b);}f.H=function(){Hd.dispatchEvent(new Kd(Hd));};function W(){Hd.dispatchEvent(new Id(Hd));}f.$a=function(){return this.ab||!ed();};function Xd(){}f=Xd.prototype;f.channelHandleMultipleArrays=null;f.okToMakeRequest=function(){return 0;};f.channelOpened=function(){};f.channelHandleArray=function(){};f.channelError=function(){};f.channelClosed=function(){};f.getAdditionalParams=function(){return{};};f.getNetworkTestImageUri=function(){return null;};f.isActive=function(){return!0;};f.badMapError=function(){};f.correctHostPrefix=function(a){return a;};var _$,Yd;Yd={0:"Ok",4:"User is logging out",6:"Unknown session ID",7:"Stopped by server",8:"General network error",2:"Request failed",9:"Blocked by a network administrator",5:"No data from server",10:"Got bad data from the server",11:"Got a bad response from the server"};_$=function $(a,b){var c,d,e,g,h,k,u,K,v,r,Ka,w,X,cd;if(!(this instanceof _$)){return new _$(a,b);}r=this;a||(a="channel");a.match(/:\/\//)&&a.replace(/^ws/,"http");b||(b={});m(b||"string"===typeof b)&&(b={});K=b.reconnectTime||3E3;c=b.extraHeaders||null;d=b.extraParams||null;null!==b.affinity&&(d||(d={}),b.affinityParam||(b.affinityParam="a"),this.affinity=b.affinity||sa(),d[b.affinityParam]=this.affinity);X=function X(a){r.readyState=r.readyState=a;};X(this.CLOSED);w=null;k=null!=(cd=b.prev)?cd.Ec:void 0;e=function e(a,b,c,d,_e){try{return"function"===typeof r[a]?r[a](c,d,_e):void 0;}catch(g){throw"undefined"!==typeof console&&null!==console&&console.error(g.stack),g;}};g=new Xd();g.channelOpened=function(){k=w;X(_$.OPEN);return e("onopen");};h=null;g.channelError=function(a,b){var c;c=Yd[b];h=b;r.readyState!==_$.CLOSED&&X(_$.hb);return e("onerror",0,c,b);};v=null;g.channelClosed=function(a,c,d){var g;if(r.readyState!==_$.CLOSED){return w=null,a=h?Yd[h]:"Closed",X(_$.CLOSED),b.reconnect&&7!==h&&0!==h&&(g=6===h?0:K,clearTimeout(v),v=setTimeout(u,g)),e("onclose",0,a,c,d),h=null;}};g.channelHandleArray=function(a,b){return e("onmessage",0,{type:"message",data:b});};u=function u(){if(w){throw Error("Reconnect() called from invalid state");}X(_$.CONNECTING);e("onconnecting");clearTimeout(v);r.Ec=w=new Ed(b.appVersion,null!=k?k.Gb:void 0);b.crossDomainXhr&&(w.ab=!0);w.e=g;c&&w.S(c);h=null;if(b.failFast){var t=w;t.Ka=!0;t.a.info("setFailFast: true");(t.p||t.G)&&t.ba>(t.Ka?0:t.pb)&&(t.a.info("Retry count "+t.ba+" > new maxRetries "+(t.Ka?0:t.pb)+". Fail immediately!"),t.p?(t.p.cancel(),t.la(t.p)):(l.clearTimeout(t.G),t.G=null,Z(t,2)));}return w.kb(""+a+"/test",""+a+"/bind",d,null!=k?k.Y:void 0,null!=k?k.za:void 0);};this.open=function(){if(r.readyState!==r.CLOSED){throw Error("Already open");}return u();};this.close=function(){clearTimeout(v);h=0;if(r.readyState!==_$.CLOSED){return X(_$.hb),w.disconnect();}};this.sendMap=Ka=function Ka(a){var b;if((b=r.readyState)!==_$.hb&&b!==_$.CLOSED){b=w;if(0==b.c){throw Error("Invalid operation: sending map when state is closed");}1E3==b.t.length&&b.a.J("Already have 1000 queued maps upon queueing "+yb(a));b.t.push(new Gd(b.sc++,a));2!=b.c&&3!=b.c||Qd(b);}};this.send=function(a){return"string"===typeof a?Ka({_S:a}):Ka({JSON:yb(a)});};u();};_$.prototype.canSendWhileConnecting=_$.canSendWhileConnecting=!0;_$.prototype.canSendJSON=_$.canSendJSON=!0;_$.prototype.CONNECTING=_$.CONNECTING=_$.CONNECTING=0;_$.prototype.OPEN=_$.OPEN=_$.OPEN=1;_$.prototype.CLOSING=_$.CLOSING=_$.hb=2;_$.prototype.CLOSED=_$.CLOSED=_$.CLOSED=3;("undefined"!==typeof exports&&null!==exports?exports:window).BCSocket=_$;})();},{}],4:[function(require,module,exports){(function(__dirname){module.exports=BarChart;function BarChart(){}BarChart.prototype.view=__dirname;BarChart.prototype.init=function(){var model=this.model;model.setNull("data",[]);model.setNull("width",200);model.setNull("height",100);model.set("layout",[]);this.transform();};BarChart.prototype.create=function(){var model=this.model;var that=this;// changes in values inside the array
model.on("all","data**",function(){//console.log("event data:", arguments);
that.transform();});};BarChart.prototype.transform=function(){var model=this.model;var that=this;var data=model.get("data")||[];var width=model.get("width");var height=model.get("height");var yMax=0;data.forEach(function(d){if(d.value>yMax)yMax=d.value;});var barWidth=width/data.length;var yScale=function yScale(v){return v*height/yMax;};// update the layout
var layout=data.map(function(d,i){return{x:i*barWidth,y:height-yScale(d.value),width:barWidth/2,height:yScale(d.value)};});// we do more computing in js (setDiffDeep) to avoid extra re-rendering
model.setDiffDeep("layout",layout);};BarChart.prototype.clicker=function(d,i,evt,el){console.log("clicked!",d,i,el);};}).call(this,"/node_modules/d-barchart-vanilla");},{}],5:[function(require,module,exports){(function(__dirname){var d3=require('d3');module.exports=BarChart;function BarChart(){}BarChart.prototype.view=__dirname;BarChart.prototype.init=function(){var model=this.model;model.setNull("data",[]);model.setNull("width",200);model.setNull("height",100);model.set("layout",[]);this.yScale=d3.scale.linear().range([0,model.get("height")]);this.xScale=d3.scale.ordinal().rangeBands([0,model.get("width")],0.1);this.transform();};BarChart.prototype.create=function(){var model=this.model;var that=this;// changes in values inside the array
model.on("all","data**",function(){//console.log("event data:", arguments);
that.transform();});};BarChart.prototype.transform=function(){var model=this.model;var that=this;var data=model.get("data")||[];this.xScale.domain(d3.range(data.length));// this could be implemented as extent for a relative scale
this.yScale.domain([0,d3.max(data,function(d){return d.value;})]);// update the layout
var layout=data.map(function(d,i){return{x:that.xScale(i),y:that.yScale.range()[1]-that.yScale(d.value),width:that.xScale.rangeBand()/2,height:that.yScale(d.value)};});// we do more computing in js (setDiffDeep) to avoid extra re-rendering
model.setDiffDeep("layout",layout);};BarChart.prototype.clicker=function(d,i,evt,el){console.log("clicked!",d,i,el);};}).call(this,"/node_modules/d-barchart");},{"d3":14}],6:[function(require,module,exports){(function(__dirname){module.exports=Alert;function Alert(){}Alert.prototype.view=__dirname;Alert.prototype.create=function(model,dom){this.model.setNull('hidden',false);};Alert.prototype.show=function(model,dom){this.model.set('faded',false);this.model.set('hidden',false);};Alert.prototype.hide=function(){var model=this.model;model.set('faded',true);setTimeout(function(){model.set('hidden',true);},300);};}).call(this,"/node_modules/d-bootstrap/alert");},{}],7:[function(require,module,exports){(function(__dirname){module.exports=ContextMenu;function ContextMenu(){}ContextMenu.prototype.view=__dirname;ContextMenu.prototype.create=function(model,dom){// Close when clicking outside of the context menu
var contextMenu=this;dom.on('click',function(e){if(contextMenu.menu.contains(e.target))return;model.set('open',false);});};ContextMenu.prototype.open=function(e){if(!e)throw new Error('You must provide a click event as the first argument to open() when opening the context menu.');e.preventDefault();var contextMenu=this;var model=this.model;var x=e.clientX+'px';var y=e.clientY+'px';var args=Array.prototype.slice.call(arguments);args.unshift('open');args.push(function(){contextMenu.menu.style.top=y;contextMenu.menu.style.left=x;model.set('open',true);});this.emitDelayable.apply(this,args);};ContextMenu.prototype.select=function(option){this.model.set('value',optionValue(option));this.model.set('open',false);if(option.hasOwnProperty('action')&&typeof option.action==='function')option.action();this.emit('select');};function optionValue(option){return option.hasOwnProperty('value')?option.value:option.content;}}).call(this,"/node_modules/d-bootstrap/contextMenu");},{}],8:[function(require,module,exports){(function(__dirname){module.exports=Dropdown;function Dropdown(){}Dropdown.prototype.view=__dirname;Dropdown.prototype.create=function(model,dom){// Close on click outside of the dropdown
var dropdown=this;dom.on('click',function(e){if(dropdown.toggleButton.contains(e.target))return;if(dropdown.menu.contains(e.target))return;model.set('open',false);});// Watch the change of the options and update the selected element if needed
model.on('change','options',function(){model.set('value',model.get('value'));});};Dropdown.prototype.toggle=function(){this.model.set('open',!this.model.get('open'));};Dropdown.prototype.select=function(option){this.model.set('value',optionValue(option));this.model.set('open',false);};Dropdown.prototype.label=function(value){var options=this.getAttribute('options')||[];for(var i=0,len=options.length;i<len;i++){var option=options[i];if(value===optionValue(option)){return option.content;}}return this.getAttribute('prompt')||'Select';};function optionValue(option){return option.hasOwnProperty('value')?option.value:option.content;}}).call(this,"/node_modules/d-bootstrap/dropdown");},{}],9:[function(require,module,exports){module.exports=function(app,options){app.component(require('./dropdown'));app.component(require('./modal'));app.component(require('./tabs'));app.component(require('./alert'));app.component(require('./contextMenu'));if(require&&require.resolve&&!options||options&&options.loadStyles){var filename=require.resolve('bootstrap/dist/css/bootstrap.min.css');app.loadStyles(filename);}};},{"./alert":6,"./contextMenu":7,"./dropdown":8,"./modal":10,"./tabs":11}],10:[function(require,module,exports){(function(__dirname){module.exports=Modal;function Modal(){}Modal.prototype.view=__dirname;Modal.prototype.create=function(model,dom){var modal=this;dom.on('keydown',function(e){if(!model.get('show'))return;if(e.keyCode===27){// Escape
modal.hide('escape');}});};Modal.prototype.show=function(){var model=this.model;this.emitDelayable('show',function(){document.body.classList.add('modal-open');model.set('show',true);setTimeout(function(){model.set('faded',true);},0);});};Modal.prototype.hide=function(action){var cancelled=this.emitCancellable('hide',action);if(cancelled)return;var model=this.model;model.set('faded',false);setTimeout(function(){document.body.classList.remove('modal-open');model.set('show',false);},300);};}).call(this,"/node_modules/d-bootstrap/modal");},{}],11:[function(require,module,exports){(function(__dirname){module.exports=Tabs;function Tabs(){}Tabs.prototype.view=__dirname;Tabs.prototype.init=function(model){model.setNull('selectedIndex',0);};Tabs.prototype.select=function(index){this.model.set('selectedIndex',index);};}).call(this,"/node_modules/d-bootstrap/tabs");},{}],12:[function(require,module,exports){(function(__dirname){module.exports=ConnectionAlert;function ConnectionAlert(){}ConnectionAlert.prototype.view=__dirname;ConnectionAlert.prototype.reconnect=function(){var model=this.model;// Hide the reconnect link for a second after clicking it
model.set('hideReconnect',true);setTimeout(function(){model.set('hideReconnect',false);},1000);model.reconnect();};ConnectionAlert.prototype.reload=function(){window.location.reload();};ConnectionAlert.prototype.sentenceCase=function(text){return text&&text.charAt(0).toUpperCase()+text.slice(1);};}).call(this,"/node_modules/d-connection-alert");},{}],13:[function(require,module,exports){(function(__dirname){var d3=require('d3');module.exports=BarChart;function BarChart(){}BarChart.prototype.view=__dirname;BarChart.prototype.init=function(){var model=this.model;model.setNull("data",[]);model.setNull("width",200);model.setNull("height",100);this.yScale=d3.scale.linear().range([0,model.get("height")]);this.xScale=d3.scale.ordinal().rangeBands([0,model.get("width")],0.1);this.transform();};BarChart.prototype.create=function(){var model=this.model;var that=this;// changes in values inside the array
model.on("all","data**",function(){//console.log("event data:", arguments);
that.transform();that.draw();});that.draw();};BarChart.prototype.transform=function(){var model=this.model;var that=this;var data=model.get("data")||[];this.xScale.domain(d3.range(data.length));// this could be implemented as extent for a relative scale
this.yScale.domain([0,d3.max(data,function(d){return d.value;})]);};BarChart.prototype.draw=function(){var that=this;var model=this.model;var data=model.get("data");var barSel=d3.select(this.chart).selectAll("rect.bar").data(data);barSel.enter().append("rect").classed("bar",true);barSel.exit().remove();barSel.transition().attr({x:function x(d,i){return that.x(d,i);},y:function y(d,i){return that.y(d,i);},width:function width(d,i){return that.width(d,i);},height:function height(d,i){return that.height(d,i);}});barSel.on("click",function(d,i){console.log("clicked!",d,i,this);});};BarChart.prototype.x=function(d,i){return this.xScale(i);};BarChart.prototype.y=function(d,i){return this.yScale.range()[1]-this.yScale(d.value);};BarChart.prototype.width=function(d,i){return this.xScale.rangeBand()/2;};BarChart.prototype.height=function(d,i){return this.yScale(d.value);};}).call(this,"/node_modules/d-d3-barchart");},{"d3":14}],14:[function(require,module,exports){!function(){var d3={version:"3.5.17"};var d3_arraySlice=[].slice,d3_array=function d3_array(list){return d3_arraySlice.call(list);};var d3_document=this.document;function d3_documentElement(node){return node&&(node.ownerDocument||node.document||node).documentElement;}function d3_window(node){return node&&(node.ownerDocument&&node.ownerDocument.defaultView||node.document&&node||node.defaultView);}if(d3_document){try{d3_array(d3_document.documentElement.childNodes)[0].nodeType;}catch(e){d3_array=function d3_array(list){var i=list.length,array=new Array(i);while(i--){array[i]=list[i];}return array;};}}if(!Date.now)Date.now=function(){return+new Date();};if(d3_document){try{d3_document.createElement("DIV").style.setProperty("opacity",0,"");}catch(error){var d3_element_prototype=this.Element.prototype,d3_element_setAttribute=d3_element_prototype.setAttribute,d3_element_setAttributeNS=d3_element_prototype.setAttributeNS,d3_style_prototype=this.CSSStyleDeclaration.prototype,d3_style_setProperty=d3_style_prototype.setProperty;d3_element_prototype.setAttribute=function(name,value){d3_element_setAttribute.call(this,name,value+"");};d3_element_prototype.setAttributeNS=function(space,local,value){d3_element_setAttributeNS.call(this,space,local,value+"");};d3_style_prototype.setProperty=function(name,value,priority){d3_style_setProperty.call(this,name,value+"",priority);};}}d3.ascending=d3_ascending;function d3_ascending(a,b){return a<b?-1:a>b?1:a>=b?0:NaN;}d3.descending=function(a,b){return b<a?-1:b>a?1:b>=a?0:NaN;};d3.min=function(array,f){var i=-1,n=array.length,a,b;if(arguments.length===1){while(++i<n){if((b=array[i])!=null&&b>=b){a=b;break;}}while(++i<n){if((b=array[i])!=null&&a>b)a=b;}}else{while(++i<n){if((b=f.call(array,array[i],i))!=null&&b>=b){a=b;break;}}while(++i<n){if((b=f.call(array,array[i],i))!=null&&a>b)a=b;}}return a;};d3.max=function(array,f){var i=-1,n=array.length,a,b;if(arguments.length===1){while(++i<n){if((b=array[i])!=null&&b>=b){a=b;break;}}while(++i<n){if((b=array[i])!=null&&b>a)a=b;}}else{while(++i<n){if((b=f.call(array,array[i],i))!=null&&b>=b){a=b;break;}}while(++i<n){if((b=f.call(array,array[i],i))!=null&&b>a)a=b;}}return a;};d3.extent=function(array,f){var i=-1,n=array.length,a,b,c;if(arguments.length===1){while(++i<n){if((b=array[i])!=null&&b>=b){a=c=b;break;}}while(++i<n){if((b=array[i])!=null){if(a>b)a=b;if(c<b)c=b;}}}else{while(++i<n){if((b=f.call(array,array[i],i))!=null&&b>=b){a=c=b;break;}}while(++i<n){if((b=f.call(array,array[i],i))!=null){if(a>b)a=b;if(c<b)c=b;}}}return[a,c];};function d3_number(x){return x===null?NaN:+x;}function d3_numeric(x){return!isNaN(x);}d3.sum=function(array,f){var s=0,n=array.length,a,i=-1;if(arguments.length===1){while(++i<n){if(d3_numeric(a=+array[i]))s+=a;}}else{while(++i<n){if(d3_numeric(a=+f.call(array,array[i],i)))s+=a;}}return s;};d3.mean=function(array,f){var s=0,n=array.length,a,i=-1,j=n;if(arguments.length===1){while(++i<n){if(d3_numeric(a=d3_number(array[i])))s+=a;else--j;}}else{while(++i<n){if(d3_numeric(a=d3_number(f.call(array,array[i],i))))s+=a;else--j;}}if(j)return s/j;};d3.quantile=function(values,p){var H=(values.length-1)*p+1,h=Math.floor(H),v=+values[h-1],e=H-h;return e?v+e*(values[h]-v):v;};d3.median=function(array,f){var numbers=[],n=array.length,a,i=-1;if(arguments.length===1){while(++i<n){if(d3_numeric(a=d3_number(array[i])))numbers.push(a);}}else{while(++i<n){if(d3_numeric(a=d3_number(f.call(array,array[i],i))))numbers.push(a);}}if(numbers.length)return d3.quantile(numbers.sort(d3_ascending),.5);};d3.variance=function(array,f){var n=array.length,m=0,a,d,s=0,i=-1,j=0;if(arguments.length===1){while(++i<n){if(d3_numeric(a=d3_number(array[i]))){d=a-m;m+=d/++j;s+=d*(a-m);}}}else{while(++i<n){if(d3_numeric(a=d3_number(f.call(array,array[i],i)))){d=a-m;m+=d/++j;s+=d*(a-m);}}}if(j>1)return s/(j-1);};d3.deviation=function(){var v=d3.variance.apply(this,arguments);return v?Math.sqrt(v):v;};function d3_bisector(compare){return{left:function left(a,x,lo,hi){if(arguments.length<3)lo=0;if(arguments.length<4)hi=a.length;while(lo<hi){var mid=lo+hi>>>1;if(compare(a[mid],x)<0)lo=mid+1;else hi=mid;}return lo;},right:function right(a,x,lo,hi){if(arguments.length<3)lo=0;if(arguments.length<4)hi=a.length;while(lo<hi){var mid=lo+hi>>>1;if(compare(a[mid],x)>0)hi=mid;else lo=mid+1;}return lo;}};}var d3_bisect=d3_bisector(d3_ascending);d3.bisectLeft=d3_bisect.left;d3.bisect=d3.bisectRight=d3_bisect.right;d3.bisector=function(f){return d3_bisector(f.length===1?function(d,x){return d3_ascending(f(d),x);}:f);};d3.shuffle=function(array,i0,i1){if((m=arguments.length)<3){i1=array.length;if(m<2)i0=0;}var m=i1-i0,t,i;while(m){i=Math.random()*m--|0;t=array[m+i0],array[m+i0]=array[i+i0],array[i+i0]=t;}return array;};d3.permute=function(array,indexes){var i=indexes.length,permutes=new Array(i);while(i--){permutes[i]=array[indexes[i]];}return permutes;};d3.pairs=function(array){var i=0,n=array.length-1,p0,p1=array[0],pairs=new Array(n<0?0:n);while(i<n){pairs[i]=[p0=p1,p1=array[++i]];}return pairs;};d3.transpose=function(matrix){if(!(n=matrix.length))return[];for(var i=-1,m=d3.min(matrix,d3_transposeLength),transpose=new Array(m);++i<m;){for(var j=-1,n,row=transpose[i]=new Array(n);++j<n;){row[j]=matrix[j][i];}}return transpose;};function d3_transposeLength(d){return d.length;}d3.zip=function(){return d3.transpose(arguments);};d3.keys=function(map){var keys=[];for(var key in map){keys.push(key);}return keys;};d3.values=function(map){var values=[];for(var key in map){values.push(map[key]);}return values;};d3.entries=function(map){var entries=[];for(var key in map){entries.push({key:key,value:map[key]});}return entries;};d3.merge=function(arrays){var n=arrays.length,m,i=-1,j=0,merged,array;while(++i<n){j+=arrays[i].length;}merged=new Array(j);while(--n>=0){array=arrays[n];m=array.length;while(--m>=0){merged[--j]=array[m];}}return merged;};var abs=Math.abs;d3.range=function(start,stop,step){if(arguments.length<3){step=1;if(arguments.length<2){stop=start;start=0;}}if((stop-start)/step===Infinity)throw new Error("infinite range");var range=[],k=d3_range_integerScale(abs(step)),i=-1,j;start*=k,stop*=k,step*=k;if(step<0)while((j=start+step*++i)>stop){range.push(j/k);}else while((j=start+step*++i)<stop){range.push(j/k);}return range;};function d3_range_integerScale(x){var k=1;while(x*k%1){k*=10;}return k;}function d3_class(ctor,properties){for(var key in properties){Object.defineProperty(ctor.prototype,key,{value:properties[key],enumerable:false});}}d3.map=function(object,f){var map=new d3_Map();if(object instanceof d3_Map){object.forEach(function(key,value){map.set(key,value);});}else if(Array.isArray(object)){var i=-1,n=object.length,o;if(arguments.length===1)while(++i<n){map.set(i,object[i]);}else while(++i<n){map.set(f.call(object,o=object[i],i),o);}}else{for(var key in object){map.set(key,object[key]);}}return map;};function d3_Map(){this._=Object.create(null);}var d3_map_proto="__proto__",d3_map_zero="\x00";d3_class(d3_Map,{has:d3_map_has,get:function get(key){return this._[d3_map_escape(key)];},set:function set(key,value){return this._[d3_map_escape(key)]=value;},remove:d3_map_remove,keys:d3_map_keys,values:function values(){var values=[];for(var key in this._){values.push(this._[key]);}return values;},entries:function entries(){var entries=[];for(var key in this._){entries.push({key:d3_map_unescape(key),value:this._[key]});}return entries;},size:d3_map_size,empty:d3_map_empty,forEach:function forEach(f){for(var key in this._){f.call(this,d3_map_unescape(key),this._[key]);}}});function d3_map_escape(key){return(key+="")===d3_map_proto||key[0]===d3_map_zero?d3_map_zero+key:key;}function d3_map_unescape(key){return(key+="")[0]===d3_map_zero?key.slice(1):key;}function d3_map_has(key){return d3_map_escape(key)in this._;}function d3_map_remove(key){return(key=d3_map_escape(key))in this._&&delete this._[key];}function d3_map_keys(){var keys=[];for(var key in this._){keys.push(d3_map_unescape(key));}return keys;}function d3_map_size(){var size=0;for(var key in this._){++size;}return size;}function d3_map_empty(){for(var key in this._){return false;}return true;}d3.nest=function(){var nest={},keys=[],sortKeys=[],sortValues,rollup;function map(mapType,array,depth){if(depth>=keys.length)return rollup?rollup.call(nest,array):sortValues?array.sort(sortValues):array;var i=-1,n=array.length,key=keys[depth++],keyValue,object,setter,valuesByKey=new d3_Map(),values;while(++i<n){if(values=valuesByKey.get(keyValue=key(object=array[i]))){values.push(object);}else{valuesByKey.set(keyValue,[object]);}}if(mapType){object=mapType();setter=function setter(keyValue,values){object.set(keyValue,map(mapType,values,depth));};}else{object={};setter=function setter(keyValue,values){object[keyValue]=map(mapType,values,depth);};}valuesByKey.forEach(setter);return object;}function entries(map,depth){if(depth>=keys.length)return map;var array=[],sortKey=sortKeys[depth++];map.forEach(function(key,keyMap){array.push({key:key,values:entries(keyMap,depth)});});return sortKey?array.sort(function(a,b){return sortKey(a.key,b.key);}):array;}nest.map=function(array,mapType){return map(mapType,array,0);};nest.entries=function(array){return entries(map(d3.map,array,0),0);};nest.key=function(d){keys.push(d);return nest;};nest.sortKeys=function(order){sortKeys[keys.length-1]=order;return nest;};nest.sortValues=function(order){sortValues=order;return nest;};nest.rollup=function(f){rollup=f;return nest;};return nest;};d3.set=function(array){var set=new d3_Set();if(array)for(var i=0,n=array.length;i<n;++i){set.add(array[i]);}return set;};function d3_Set(){this._=Object.create(null);}d3_class(d3_Set,{has:d3_map_has,add:function add(key){this._[d3_map_escape(key+="")]=true;return key;},remove:d3_map_remove,values:d3_map_keys,size:d3_map_size,empty:d3_map_empty,forEach:function forEach(f){for(var key in this._){f.call(this,d3_map_unescape(key));}}});d3.behavior={};function d3_identity(d){return d;}d3.rebind=function(target,source){var i=1,n=arguments.length,method;while(++i<n){target[method=arguments[i]]=d3_rebind(target,source,source[method]);}return target;};function d3_rebind(target,source,method){return function(){var value=method.apply(source,arguments);return value===source?target:value;};}function d3_vendorSymbol(object,name){if(name in object)return name;name=name.charAt(0).toUpperCase()+name.slice(1);for(var i=0,n=d3_vendorPrefixes.length;i<n;++i){var prefixName=d3_vendorPrefixes[i]+name;if(prefixName in object)return prefixName;}}var d3_vendorPrefixes=["webkit","ms","moz","Moz","o","O"];function d3_noop(){}d3.dispatch=function(){var dispatch=new d3_dispatch(),i=-1,n=arguments.length;while(++i<n){dispatch[arguments[i]]=d3_dispatch_event(dispatch);}return dispatch;};function d3_dispatch(){}d3_dispatch.prototype.on=function(type,listener){var i=type.indexOf("."),name="";if(i>=0){name=type.slice(i+1);type=type.slice(0,i);}if(type)return arguments.length<2?this[type].on(name):this[type].on(name,listener);if(arguments.length===2){if(listener==null)for(type in this){if(this.hasOwnProperty(type))this[type].on(name,null);}return this;}};function d3_dispatch_event(dispatch){var listeners=[],listenerByName=new d3_Map();function event(){var z=listeners,i=-1,n=z.length,l;while(++i<n){if(l=z[i].on)l.apply(this,arguments);}return dispatch;}event.on=function(name,listener){var l=listenerByName.get(name),i;if(arguments.length<2)return l&&l.on;if(l){l.on=null;listeners=listeners.slice(0,i=listeners.indexOf(l)).concat(listeners.slice(i+1));listenerByName.remove(name);}if(listener)listeners.push(listenerByName.set(name,{on:listener}));return dispatch;};return event;}d3.event=null;function d3_eventPreventDefault(){d3.event.preventDefault();}function d3_eventSource(){var e=d3.event,s;while(s=e.sourceEvent){e=s;}return e;}function d3_eventDispatch(target){var dispatch=new d3_dispatch(),i=0,n=arguments.length;while(++i<n){dispatch[arguments[i]]=d3_dispatch_event(dispatch);}dispatch.of=function(thiz,argumentz){return function(e1){try{var e0=e1.sourceEvent=d3.event;e1.target=target;d3.event=e1;dispatch[e1.type].apply(thiz,argumentz);}finally{d3.event=e0;}};};return dispatch;}d3.requote=function(s){return s.replace(d3_requote_re,"\\$&");};var d3_requote_re=/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g;var d3_subclass={}.__proto__?function(object,prototype){object.__proto__=prototype;}:function(object,prototype){for(var property in prototype){object[property]=prototype[property];}};function d3_selection(groups){d3_subclass(groups,d3_selectionPrototype);return groups;}var d3_select=function d3_select(s,n){return n.querySelector(s);},d3_selectAll=function d3_selectAll(s,n){return n.querySelectorAll(s);},_d3_selectMatches=function d3_selectMatches(n,s){var d3_selectMatcher=n.matches||n[d3_vendorSymbol(n,"matchesSelector")];_d3_selectMatches=function d3_selectMatches(n,s){return d3_selectMatcher.call(n,s);};return _d3_selectMatches(n,s);};if(typeof Sizzle==="function"){d3_select=function d3_select(s,n){return Sizzle(s,n)[0]||null;};d3_selectAll=Sizzle;_d3_selectMatches=Sizzle.matchesSelector;}d3.selection=function(){return d3.select(d3_document.documentElement);};var d3_selectionPrototype=d3.selection.prototype=[];d3_selectionPrototype.select=function(selector){var subgroups=[],subgroup,subnode,group,node;selector=d3_selection_selector(selector);for(var j=-1,m=this.length;++j<m;){subgroups.push(subgroup=[]);subgroup.parentNode=(group=this[j]).parentNode;for(var i=-1,n=group.length;++i<n;){if(node=group[i]){subgroup.push(subnode=selector.call(node,node.__data__,i,j));if(subnode&&"__data__"in node)subnode.__data__=node.__data__;}else{subgroup.push(null);}}}return d3_selection(subgroups);};function d3_selection_selector(selector){return typeof selector==="function"?selector:function(){return d3_select(selector,this);};}d3_selectionPrototype.selectAll=function(selector){var subgroups=[],subgroup,node;selector=d3_selection_selectorAll(selector);for(var j=-1,m=this.length;++j<m;){for(var group=this[j],i=-1,n=group.length;++i<n;){if(node=group[i]){subgroups.push(subgroup=d3_array(selector.call(node,node.__data__,i,j)));subgroup.parentNode=node;}}}return d3_selection(subgroups);};function d3_selection_selectorAll(selector){return typeof selector==="function"?selector:function(){return d3_selectAll(selector,this);};}var d3_nsXhtml="http://www.w3.org/1999/xhtml";var d3_nsPrefix={svg:"http://www.w3.org/2000/svg",xhtml:d3_nsXhtml,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};d3.ns={prefix:d3_nsPrefix,qualify:function qualify(name){var i=name.indexOf(":"),prefix=name;if(i>=0&&(prefix=name.slice(0,i))!=="xmlns")name=name.slice(i+1);return d3_nsPrefix.hasOwnProperty(prefix)?{space:d3_nsPrefix[prefix],local:name}:name;}};d3_selectionPrototype.attr=function(name,value){if(arguments.length<2){if(typeof name==="string"){var node=this.node();name=d3.ns.qualify(name);return name.local?node.getAttributeNS(name.space,name.local):node.getAttribute(name);}for(value in name){this.each(d3_selection_attr(value,name[value]));}return this;}return this.each(d3_selection_attr(name,value));};function d3_selection_attr(name,value){name=d3.ns.qualify(name);function attrNull(){this.removeAttribute(name);}function attrNullNS(){this.removeAttributeNS(name.space,name.local);}function attrConstant(){this.setAttribute(name,value);}function attrConstantNS(){this.setAttributeNS(name.space,name.local,value);}function attrFunction(){var x=value.apply(this,arguments);if(x==null)this.removeAttribute(name);else this.setAttribute(name,x);}function attrFunctionNS(){var x=value.apply(this,arguments);if(x==null)this.removeAttributeNS(name.space,name.local);else this.setAttributeNS(name.space,name.local,x);}return value==null?name.local?attrNullNS:attrNull:typeof value==="function"?name.local?attrFunctionNS:attrFunction:name.local?attrConstantNS:attrConstant;}function d3_collapse(s){return s.trim().replace(/\s+/g," ");}d3_selectionPrototype.classed=function(name,value){if(arguments.length<2){if(typeof name==="string"){var node=this.node(),n=(name=d3_selection_classes(name)).length,i=-1;if(value=node.classList){while(++i<n){if(!value.contains(name[i]))return false;}}else{value=node.getAttribute("class");while(++i<n){if(!d3_selection_classedRe(name[i]).test(value))return false;}}return true;}for(value in name){this.each(d3_selection_classed(value,name[value]));}return this;}return this.each(d3_selection_classed(name,value));};function d3_selection_classedRe(name){return new RegExp("(?:^|\\s+)"+d3.requote(name)+"(?:\\s+|$)","g");}function d3_selection_classes(name){return(name+"").trim().split(/^|\s+/);}function d3_selection_classed(name,value){name=d3_selection_classes(name).map(d3_selection_classedName);var n=name.length;function classedConstant(){var i=-1;while(++i<n){name[i](this,value);}}function classedFunction(){var i=-1,x=value.apply(this,arguments);while(++i<n){name[i](this,x);}}return typeof value==="function"?classedFunction:classedConstant;}function d3_selection_classedName(name){var re=d3_selection_classedRe(name);return function(node,value){if(c=node.classList)return value?c.add(name):c.remove(name);var c=node.getAttribute("class")||"";if(value){re.lastIndex=0;if(!re.test(c))node.setAttribute("class",d3_collapse(c+" "+name));}else{node.setAttribute("class",d3_collapse(c.replace(re," ")));}};}d3_selectionPrototype.style=function(name,value,priority){var n=arguments.length;if(n<3){if(typeof name!=="string"){if(n<2)value="";for(priority in name){this.each(d3_selection_style(priority,name[priority],value));}return this;}if(n<2){var node=this.node();return d3_window(node).getComputedStyle(node,null).getPropertyValue(name);}priority="";}return this.each(d3_selection_style(name,value,priority));};function d3_selection_style(name,value,priority){function styleNull(){this.style.removeProperty(name);}function styleConstant(){this.style.setProperty(name,value,priority);}function styleFunction(){var x=value.apply(this,arguments);if(x==null)this.style.removeProperty(name);else this.style.setProperty(name,x,priority);}return value==null?styleNull:typeof value==="function"?styleFunction:styleConstant;}d3_selectionPrototype.property=function(name,value){if(arguments.length<2){if(typeof name==="string")return this.node()[name];for(value in name){this.each(d3_selection_property(value,name[value]));}return this;}return this.each(d3_selection_property(name,value));};function d3_selection_property(name,value){function propertyNull(){delete this[name];}function propertyConstant(){this[name]=value;}function propertyFunction(){var x=value.apply(this,arguments);if(x==null)delete this[name];else this[name]=x;}return value==null?propertyNull:typeof value==="function"?propertyFunction:propertyConstant;}d3_selectionPrototype.text=function(value){return arguments.length?this.each(typeof value==="function"?function(){var v=value.apply(this,arguments);this.textContent=v==null?"":v;}:value==null?function(){this.textContent="";}:function(){this.textContent=value;}):this.node().textContent;};d3_selectionPrototype.html=function(value){return arguments.length?this.each(typeof value==="function"?function(){var v=value.apply(this,arguments);this.innerHTML=v==null?"":v;}:value==null?function(){this.innerHTML="";}:function(){this.innerHTML=value;}):this.node().innerHTML;};d3_selectionPrototype.append=function(name){name=d3_selection_creator(name);return this.select(function(){return this.appendChild(name.apply(this,arguments));});};function d3_selection_creator(name){function create(){var document=this.ownerDocument,namespace=this.namespaceURI;return namespace===d3_nsXhtml&&document.documentElement.namespaceURI===d3_nsXhtml?document.createElement(name):document.createElementNS(namespace,name);}function createNS(){return this.ownerDocument.createElementNS(name.space,name.local);}return typeof name==="function"?name:(name=d3.ns.qualify(name)).local?createNS:create;}d3_selectionPrototype.insert=function(name,before){name=d3_selection_creator(name);before=d3_selection_selector(before);return this.select(function(){return this.insertBefore(name.apply(this,arguments),before.apply(this,arguments)||null);});};d3_selectionPrototype.remove=function(){return this.each(d3_selectionRemove);};function d3_selectionRemove(){var parent=this.parentNode;if(parent)parent.removeChild(this);}d3_selectionPrototype.data=function(value,key){var i=-1,n=this.length,group,node;if(!arguments.length){value=new Array(n=(group=this[0]).length);while(++i<n){if(node=group[i]){value[i]=node.__data__;}}return value;}function bind(group,groupData){var i,n=group.length,m=groupData.length,n0=Math.min(n,m),updateNodes=new Array(m),enterNodes=new Array(m),exitNodes=new Array(n),node,nodeData;if(key){var nodeByKeyValue=new d3_Map(),keyValues=new Array(n),keyValue;for(i=-1;++i<n;){if(node=group[i]){if(nodeByKeyValue.has(keyValue=key.call(node,node.__data__,i))){exitNodes[i]=node;}else{nodeByKeyValue.set(keyValue,node);}keyValues[i]=keyValue;}}for(i=-1;++i<m;){if(!(node=nodeByKeyValue.get(keyValue=key.call(groupData,nodeData=groupData[i],i)))){enterNodes[i]=d3_selection_dataNode(nodeData);}else if(node!==true){updateNodes[i]=node;node.__data__=nodeData;}nodeByKeyValue.set(keyValue,true);}for(i=-1;++i<n;){if(i in keyValues&&nodeByKeyValue.get(keyValues[i])!==true){exitNodes[i]=group[i];}}}else{for(i=-1;++i<n0;){node=group[i];nodeData=groupData[i];if(node){node.__data__=nodeData;updateNodes[i]=node;}else{enterNodes[i]=d3_selection_dataNode(nodeData);}}for(;i<m;++i){enterNodes[i]=d3_selection_dataNode(groupData[i]);}for(;i<n;++i){exitNodes[i]=group[i];}}enterNodes.update=updateNodes;enterNodes.parentNode=updateNodes.parentNode=exitNodes.parentNode=group.parentNode;enter.push(enterNodes);update.push(updateNodes);exit.push(exitNodes);}var enter=d3_selection_enter([]),update=d3_selection([]),exit=d3_selection([]);if(typeof value==="function"){while(++i<n){bind(group=this[i],value.call(group,group.parentNode.__data__,i));}}else{while(++i<n){bind(group=this[i],value);}}update.enter=function(){return enter;};update.exit=function(){return exit;};return update;};function d3_selection_dataNode(data){return{__data__:data};}d3_selectionPrototype.datum=function(value){return arguments.length?this.property("__data__",value):this.property("__data__");};d3_selectionPrototype.filter=function(filter){var subgroups=[],subgroup,group,node;if(typeof filter!=="function")filter=d3_selection_filter(filter);for(var j=0,m=this.length;j<m;j++){subgroups.push(subgroup=[]);subgroup.parentNode=(group=this[j]).parentNode;for(var i=0,n=group.length;i<n;i++){if((node=group[i])&&filter.call(node,node.__data__,i,j)){subgroup.push(node);}}}return d3_selection(subgroups);};function d3_selection_filter(selector){return function(){return _d3_selectMatches(this,selector);};}d3_selectionPrototype.order=function(){for(var j=-1,m=this.length;++j<m;){for(var group=this[j],i=group.length-1,next=group[i],node;--i>=0;){if(node=group[i]){if(next&&next!==node.nextSibling)next.parentNode.insertBefore(node,next);next=node;}}}return this;};d3_selectionPrototype.sort=function(comparator){comparator=d3_selection_sortComparator.apply(this,arguments);for(var j=-1,m=this.length;++j<m;){this[j].sort(comparator);}return this.order();};function d3_selection_sortComparator(comparator){if(!arguments.length)comparator=d3_ascending;return function(a,b){return a&&b?comparator(a.__data__,b.__data__):!a-!b;};}d3_selectionPrototype.each=function(callback){return d3_selection_each(this,function(node,i,j){callback.call(node,node.__data__,i,j);});};function d3_selection_each(groups,callback){for(var j=0,m=groups.length;j<m;j++){for(var group=groups[j],i=0,n=group.length,node;i<n;i++){if(node=group[i])callback(node,i,j);}}return groups;}d3_selectionPrototype.call=function(callback){var args=d3_array(arguments);callback.apply(args[0]=this,args);return this;};d3_selectionPrototype.empty=function(){return!this.node();};d3_selectionPrototype.node=function(){for(var j=0,m=this.length;j<m;j++){for(var group=this[j],i=0,n=group.length;i<n;i++){var node=group[i];if(node)return node;}}return null;};d3_selectionPrototype.size=function(){var n=0;d3_selection_each(this,function(){++n;});return n;};function d3_selection_enter(selection){d3_subclass(selection,d3_selection_enterPrototype);return selection;}var d3_selection_enterPrototype=[];d3.selection.enter=d3_selection_enter;d3.selection.enter.prototype=d3_selection_enterPrototype;d3_selection_enterPrototype.append=d3_selectionPrototype.append;d3_selection_enterPrototype.empty=d3_selectionPrototype.empty;d3_selection_enterPrototype.node=d3_selectionPrototype.node;d3_selection_enterPrototype.call=d3_selectionPrototype.call;d3_selection_enterPrototype.size=d3_selectionPrototype.size;d3_selection_enterPrototype.select=function(selector){var subgroups=[],subgroup,subnode,upgroup,group,node;for(var j=-1,m=this.length;++j<m;){upgroup=(group=this[j]).update;subgroups.push(subgroup=[]);subgroup.parentNode=group.parentNode;for(var i=-1,n=group.length;++i<n;){if(node=group[i]){subgroup.push(upgroup[i]=subnode=selector.call(group.parentNode,node.__data__,i,j));subnode.__data__=node.__data__;}else{subgroup.push(null);}}}return d3_selection(subgroups);};d3_selection_enterPrototype.insert=function(name,before){if(arguments.length<2)before=d3_selection_enterInsertBefore(this);return d3_selectionPrototype.insert.call(this,name,before);};function d3_selection_enterInsertBefore(enter){var i0,j0;return function(d,i,j){var group=enter[j].update,n=group.length,node;if(j!=j0)j0=j,i0=0;if(i>=i0)i0=i+1;while(!(node=group[i0])&&++i0<n){;}return node;};}d3.select=function(node){var group;if(typeof node==="string"){group=[d3_select(node,d3_document)];group.parentNode=d3_document.documentElement;}else{group=[node];group.parentNode=d3_documentElement(node);}return d3_selection([group]);};d3.selectAll=function(nodes){var group;if(typeof nodes==="string"){group=d3_array(d3_selectAll(nodes,d3_document));group.parentNode=d3_document.documentElement;}else{group=d3_array(nodes);group.parentNode=null;}return d3_selection([group]);};d3_selectionPrototype.on=function(type,listener,capture){var n=arguments.length;if(n<3){if(typeof type!=="string"){if(n<2)listener=false;for(capture in type){this.each(d3_selection_on(capture,type[capture],listener));}return this;}if(n<2)return(n=this.node()["__on"+type])&&n._;capture=false;}return this.each(d3_selection_on(type,listener,capture));};function d3_selection_on(type,listener,capture){var name="__on"+type,i=type.indexOf("."),wrap=d3_selection_onListener;if(i>0)type=type.slice(0,i);var filter=d3_selection_onFilters.get(type);if(filter)type=filter,wrap=d3_selection_onFilter;function onRemove(){var l=this[name];if(l){this.removeEventListener(type,l,l.$);delete this[name];}}function onAdd(){var l=wrap(listener,d3_array(arguments));onRemove.call(this);this.addEventListener(type,this[name]=l,l.$=capture);l._=listener;}function removeAll(){var re=new RegExp("^__on([^.]+)"+d3.requote(type)+"$"),match;for(var name in this){if(match=name.match(re)){var l=this[name];this.removeEventListener(match[1],l,l.$);delete this[name];}}}return i?listener?onAdd:onRemove:listener?d3_noop:removeAll;}var d3_selection_onFilters=d3.map({mouseenter:"mouseover",mouseleave:"mouseout"});if(d3_document){d3_selection_onFilters.forEach(function(k){if("on"+k in d3_document)d3_selection_onFilters.remove(k);});}function d3_selection_onListener(listener,argumentz){return function(e){var o=d3.event;d3.event=e;argumentz[0]=this.__data__;try{listener.apply(this,argumentz);}finally{d3.event=o;}};}function d3_selection_onFilter(listener,argumentz){var l=d3_selection_onListener(listener,argumentz);return function(e){var target=this,related=e.relatedTarget;if(!related||related!==target&&!(related.compareDocumentPosition(target)&8)){l.call(target,e);}};}var d3_event_dragSelect,d3_event_dragId=0;function d3_event_dragSuppress(node){var name=".dragsuppress-"+ ++d3_event_dragId,click="click"+name,w=d3.select(d3_window(node)).on("touchmove"+name,d3_eventPreventDefault).on("dragstart"+name,d3_eventPreventDefault).on("selectstart"+name,d3_eventPreventDefault);if(d3_event_dragSelect==null){d3_event_dragSelect="onselectstart"in node?false:d3_vendorSymbol(node.style,"userSelect");}if(d3_event_dragSelect){var style=d3_documentElement(node).style,select=style[d3_event_dragSelect];style[d3_event_dragSelect]="none";}return function(suppressClick){w.on(name,null);if(d3_event_dragSelect)style[d3_event_dragSelect]=select;if(suppressClick){var off=function off(){w.on(click,null);};w.on(click,function(){d3_eventPreventDefault();off();},true);setTimeout(off,0);}};}d3.mouse=function(container){return d3_mousePoint(container,d3_eventSource());};var d3_mouse_bug44083=this.navigator&&/WebKit/.test(this.navigator.userAgent)?-1:0;function d3_mousePoint(container,e){if(e.changedTouches)e=e.changedTouches[0];var svg=container.ownerSVGElement||container;if(svg.createSVGPoint){var point=svg.createSVGPoint();if(d3_mouse_bug44083<0){var window=d3_window(container);if(window.scrollX||window.scrollY){svg=d3.select("body").append("svg").style({position:"absolute",top:0,left:0,margin:0,padding:0,border:"none"},"important");var ctm=svg[0][0].getScreenCTM();d3_mouse_bug44083=!(ctm.f||ctm.e);svg.remove();}}if(d3_mouse_bug44083)point.x=e.pageX,point.y=e.pageY;else point.x=e.clientX,point.y=e.clientY;point=point.matrixTransform(container.getScreenCTM().inverse());return[point.x,point.y];}var rect=container.getBoundingClientRect();return[e.clientX-rect.left-container.clientLeft,e.clientY-rect.top-container.clientTop];}d3.touch=function(container,touches,identifier){if(arguments.length<3)identifier=touches,touches=d3_eventSource().changedTouches;if(touches)for(var i=0,n=touches.length,touch;i<n;++i){if((touch=touches[i]).identifier===identifier){return d3_mousePoint(container,touch);}}};d3.behavior.drag=function(){var event=d3_eventDispatch(drag,"drag","dragstart","dragend"),origin=null,mousedown=dragstart(d3_noop,d3.mouse,d3_window,"mousemove","mouseup"),touchstart=dragstart(d3_behavior_dragTouchId,d3.touch,d3_identity,"touchmove","touchend");function drag(){this.on("mousedown.drag",mousedown).on("touchstart.drag",touchstart);}function dragstart(id,position,subject,move,end){return function(){var that=this,target=d3.event.target.correspondingElement||d3.event.target,parent=that.parentNode,dispatch=event.of(that,arguments),dragged=0,dragId=id(),dragName=".drag"+(dragId==null?"":"-"+dragId),dragOffset,dragSubject=d3.select(subject(target)).on(move+dragName,moved).on(end+dragName,ended),dragRestore=d3_event_dragSuppress(target),position0=position(parent,dragId);if(origin){dragOffset=origin.apply(that,arguments);dragOffset=[dragOffset.x-position0[0],dragOffset.y-position0[1]];}else{dragOffset=[0,0];}dispatch({type:"dragstart"});function moved(){var position1=position(parent,dragId),dx,dy;if(!position1)return;dx=position1[0]-position0[0];dy=position1[1]-position0[1];dragged|=dx|dy;position0=position1;dispatch({type:"drag",x:position1[0]+dragOffset[0],y:position1[1]+dragOffset[1],dx:dx,dy:dy});}function ended(){if(!position(parent,dragId))return;dragSubject.on(move+dragName,null).on(end+dragName,null);dragRestore(dragged);dispatch({type:"dragend"});}};}drag.origin=function(x){if(!arguments.length)return origin;origin=x;return drag;};return d3.rebind(drag,event,"on");};function d3_behavior_dragTouchId(){return d3.event.changedTouches[0].identifier;}d3.touches=function(container,touches){if(arguments.length<2)touches=d3_eventSource().touches;return touches?d3_array(touches).map(function(touch){var point=d3_mousePoint(container,touch);point.identifier=touch.identifier;return point;}):[];};var =1e-6,2=*,=Math.PI,=2*,=-,half=/2,d3_radians=/180,d3_degrees=180/;function d3_sgn(x){return x>0?1:x<0?-1:0;}function d3_cross2d(a,b,c){return(b[0]-a[0])*(c[1]-a[1])-(b[1]-a[1])*(c[0]-a[0]);}function d3_acos(x){return x>1?0:x<-1?:Math.acos(x);}function d3_asin(x){return x>1?half:x<-1?-half:Math.asin(x);}function d3_sinh(x){return((x=Math.exp(x))-1/x)/2;}function d3_cosh(x){return((x=Math.exp(x))+1/x)/2;}function d3_tanh(x){return((x=Math.exp(2*x))-1)/(x+1);}function d3_haversin(x){return(x=Math.sin(x/2))*x;}var =Math.SQRT2,2=2,4=4;d3.interpolateZoom=function(p0,p1){var ux0=p0[0],uy0=p0[1],w0=p0[2],ux1=p1[0],uy1=p1[1],w1=p1[2],dx=ux1-ux0,dy=uy1-uy0,d2=dx*dx+dy*dy,i,S;if(d2<2){S=Math.log(w1/w0)/;i=function i(t){return[ux0+t*dx,uy0+t*dy,w0*Math.exp(*t*S)];};}else{var d1=Math.sqrt(d2),b0=(w1*w1-w0*w0+4*d2)/(2*w0*2*d1),b1=(w1*w1-w0*w0-4*d2)/(2*w1*2*d1),r0=Math.log(Math.sqrt(b0*b0+1)-b0),r1=Math.log(Math.sqrt(b1*b1+1)-b1);S=(r1-r0)/;i=function i(t){var s=t*S,coshr0=d3_cosh(r0),u=w0/(2*d1)*(coshr0*d3_tanh(*s+r0)-d3_sinh(r0));return[ux0+u*dx,uy0+u*dy,w0*coshr0/d3_cosh(*s+r0)];};}i.duration=S*1e3;return i;};d3.behavior.zoom=function(){var view={x:0,y:0,k:1},translate0,center0,center,size=[960,500],scaleExtent=d3_behavior_zoomInfinity,duration=250,zooming=0,mousedown="mousedown.zoom",mousemove="mousemove.zoom",mouseup="mouseup.zoom",mousewheelTimer,touchstart="touchstart.zoom",touchtime,event=d3_eventDispatch(zoom,"zoomstart","zoom","zoomend"),x0,x1,y0,y1;if(!d3_behavior_zoomWheel){d3_behavior_zoomWheel="onwheel"in d3_document?(d3_behavior_zoomDelta=function d3_behavior_zoomDelta(){return-d3.event.deltaY*(d3.event.deltaMode?120:1);},"wheel"):"onmousewheel"in d3_document?(d3_behavior_zoomDelta=function d3_behavior_zoomDelta(){return d3.event.wheelDelta;},"mousewheel"):(d3_behavior_zoomDelta=function d3_behavior_zoomDelta(){return-d3.event.detail;},"MozMousePixelScroll");}function zoom(g){g.on(mousedown,mousedowned).on(d3_behavior_zoomWheel+".zoom",mousewheeled).on("dblclick.zoom",dblclicked).on(touchstart,touchstarted);}zoom.event=function(g){g.each(function(){var dispatch=event.of(this,arguments),view1=view;if(d3_transitionInheritId){d3.select(this).transition().each("start.zoom",function(){view=this.__chart__||{x:0,y:0,k:1};zoomstarted(dispatch);}).tween("zoom:zoom",function(){var dx=size[0],dy=size[1],cx=center0?center0[0]:dx/2,cy=center0?center0[1]:dy/2,i=d3.interpolateZoom([(cx-view.x)/view.k,(cy-view.y)/view.k,dx/view.k],[(cx-view1.x)/view1.k,(cy-view1.y)/view1.k,dx/view1.k]);return function(t){var l=i(t),k=dx/l[2];this.__chart__=view={x:cx-l[0]*k,y:cy-l[1]*k,k:k};zoomed(dispatch);};}).each("interrupt.zoom",function(){zoomended(dispatch);}).each("end.zoom",function(){zoomended(dispatch);});}else{this.__chart__=view;zoomstarted(dispatch);zoomed(dispatch);zoomended(dispatch);}});};zoom.translate=function(_){if(!arguments.length)return[view.x,view.y];view={x:+_[0],y:+_[1],k:view.k};rescale();return zoom;};zoom.scale=function(_){if(!arguments.length)return view.k;view={x:view.x,y:view.y,k:null};scaleTo(+_);rescale();return zoom;};zoom.scaleExtent=function(_){if(!arguments.length)return scaleExtent;scaleExtent=_==null?d3_behavior_zoomInfinity:[+_[0],+_[1]];return zoom;};zoom.center=function(_){if(!arguments.length)return center;center=_&&[+_[0],+_[1]];return zoom;};zoom.size=function(_){if(!arguments.length)return size;size=_&&[+_[0],+_[1]];return zoom;};zoom.duration=function(_){if(!arguments.length)return duration;duration=+_;return zoom;};zoom.x=function(z){if(!arguments.length)return x1;x1=z;x0=z.copy();view={x:0,y:0,k:1};return zoom;};zoom.y=function(z){if(!arguments.length)return y1;y1=z;y0=z.copy();view={x:0,y:0,k:1};return zoom;};function location(p){return[(p[0]-view.x)/view.k,(p[1]-view.y)/view.k];}function point(l){return[l[0]*view.k+view.x,l[1]*view.k+view.y];}function scaleTo(s){view.k=Math.max(scaleExtent[0],Math.min(scaleExtent[1],s));}function translateTo(p,l){l=point(l);view.x+=p[0]-l[0];view.y+=p[1]-l[1];}function zoomTo(that,p,l,k){that.__chart__={x:view.x,y:view.y,k:view.k};scaleTo(Math.pow(2,k));translateTo(center0=p,l);that=d3.select(that);if(duration>0)that=that.transition().duration(duration);that.call(zoom.event);}function rescale(){if(x1)x1.domain(x0.range().map(function(x){return(x-view.x)/view.k;}).map(x0.invert));if(y1)y1.domain(y0.range().map(function(y){return(y-view.y)/view.k;}).map(y0.invert));}function zoomstarted(dispatch){if(!zooming++)dispatch({type:"zoomstart"});}function zoomed(dispatch){rescale();dispatch({type:"zoom",scale:view.k,translate:[view.x,view.y]});}function zoomended(dispatch){if(! --zooming)dispatch({type:"zoomend"}),center0=null;}function mousedowned(){var that=this,dispatch=event.of(that,arguments),dragged=0,subject=d3.select(d3_window(that)).on(mousemove,moved).on(mouseup,ended),location0=location(d3.mouse(that)),dragRestore=d3_event_dragSuppress(that);d3_selection_interrupt.call(that);zoomstarted(dispatch);function moved(){dragged=1;translateTo(d3.mouse(that),location0);zoomed(dispatch);}function ended(){subject.on(mousemove,null).on(mouseup,null);dragRestore(dragged);zoomended(dispatch);}}function touchstarted(){var that=this,dispatch=event.of(that,arguments),locations0={},distance0=0,scale0,zoomName=".zoom-"+d3.event.changedTouches[0].identifier,touchmove="touchmove"+zoomName,touchend="touchend"+zoomName,targets=[],subject=d3.select(that),dragRestore=d3_event_dragSuppress(that);started();zoomstarted(dispatch);subject.on(mousedown,null).on(touchstart,started);function relocate(){var touches=d3.touches(that);scale0=view.k;touches.forEach(function(t){if(t.identifier in locations0)locations0[t.identifier]=location(t);});return touches;}function started(){var target=d3.event.target;d3.select(target).on(touchmove,moved).on(touchend,ended);targets.push(target);var changed=d3.event.changedTouches;for(var i=0,n=changed.length;i<n;++i){locations0[changed[i].identifier]=null;}var touches=relocate(),now=Date.now();if(touches.length===1){if(now-touchtime<500){var p=touches[0];zoomTo(that,p,locations0[p.identifier],Math.floor(Math.log(view.k)/Math.LN2)+1);d3_eventPreventDefault();}touchtime=now;}else if(touches.length>1){var p=touches[0],q=touches[1],dx=p[0]-q[0],dy=p[1]-q[1];distance0=dx*dx+dy*dy;}}function moved(){var touches=d3.touches(that),p0,l0,p1,l1;d3_selection_interrupt.call(that);for(var i=0,n=touches.length;i<n;++i,l1=null){p1=touches[i];if(l1=locations0[p1.identifier]){if(l0)break;p0=p1,l0=l1;}}if(l1){var distance1=(distance1=p1[0]-p0[0])*distance1+(distance1=p1[1]-p0[1])*distance1,scale1=distance0&&Math.sqrt(distance1/distance0);p0=[(p0[0]+p1[0])/2,(p0[1]+p1[1])/2];l0=[(l0[0]+l1[0])/2,(l0[1]+l1[1])/2];scaleTo(scale1*scale0);}touchtime=null;translateTo(p0,l0);zoomed(dispatch);}function ended(){if(d3.event.touches.length){var changed=d3.event.changedTouches;for(var i=0,n=changed.length;i<n;++i){delete locations0[changed[i].identifier];}for(var identifier in locations0){return void relocate();}}d3.selectAll(targets).on(zoomName,null);subject.on(mousedown,mousedowned).on(touchstart,touchstarted);dragRestore();zoomended(dispatch);}}function mousewheeled(){var dispatch=event.of(this,arguments);if(mousewheelTimer)clearTimeout(mousewheelTimer);else d3_selection_interrupt.call(this),translate0=location(center0=center||d3.mouse(this)),zoomstarted(dispatch);mousewheelTimer=setTimeout(function(){mousewheelTimer=null;zoomended(dispatch);},50);d3_eventPreventDefault();scaleTo(Math.pow(2,d3_behavior_zoomDelta()*.002)*view.k);translateTo(center0,translate0);zoomed(dispatch);}function dblclicked(){var p=d3.mouse(this),k=Math.log(view.k)/Math.LN2;zoomTo(this,p,location(p),d3.event.shiftKey?Math.ceil(k)-1:Math.floor(k)+1);}return d3.rebind(zoom,event,"on");};var d3_behavior_zoomInfinity=[0,Infinity],d3_behavior_zoomDelta,d3_behavior_zoomWheel;d3.color=d3_color;function d3_color(){}d3_color.prototype.toString=function(){return this.rgb()+"";};d3.hsl=d3_hsl;function d3_hsl(h,s,l){return this instanceof d3_hsl?void(this.h=+h,this.s=+s,this.l=+l):arguments.length<2?h instanceof d3_hsl?new d3_hsl(h.h,h.s,h.l):d3_rgb_parse(""+h,d3_rgb_hsl,d3_hsl):new d3_hsl(h,s,l);}var d3_hslPrototype=d3_hsl.prototype=new d3_color();d3_hslPrototype.brighter=function(k){k=Math.pow(.7,arguments.length?k:1);return new d3_hsl(this.h,this.s,this.l/k);};d3_hslPrototype.darker=function(k){k=Math.pow(.7,arguments.length?k:1);return new d3_hsl(this.h,this.s,k*this.l);};d3_hslPrototype.rgb=function(){return d3_hsl_rgb(this.h,this.s,this.l);};function d3_hsl_rgb(h,s,l){var m1,m2;h=isNaN(h)?0:(h%=360)<0?h+360:h;s=isNaN(s)?0:s<0?0:s>1?1:s;l=l<0?0:l>1?1:l;m2=l<=.5?l*(1+s):l+s-l*s;m1=2*l-m2;function v(h){if(h>360)h-=360;else if(h<0)h+=360;if(h<60)return m1+(m2-m1)*h/60;if(h<180)return m2;if(h<240)return m1+(m2-m1)*(240-h)/60;return m1;}function vv(h){return Math.round(v(h)*255);}return new d3_rgb(vv(h+120),vv(h),vv(h-120));}d3.hcl=d3_hcl;function d3_hcl(h,c,l){return this instanceof d3_hcl?void(this.h=+h,this.c=+c,this.l=+l):arguments.length<2?h instanceof d3_hcl?new d3_hcl(h.h,h.c,h.l):h instanceof d3_lab?d3_lab_hcl(h.l,h.a,h.b):d3_lab_hcl((h=d3_rgb_lab((h=d3.rgb(h)).r,h.g,h.b)).l,h.a,h.b):new d3_hcl(h,c,l);}var d3_hclPrototype=d3_hcl.prototype=new d3_color();d3_hclPrototype.brighter=function(k){return new d3_hcl(this.h,this.c,Math.min(100,this.l+d3_lab_K*(arguments.length?k:1)));};d3_hclPrototype.darker=function(k){return new d3_hcl(this.h,this.c,Math.max(0,this.l-d3_lab_K*(arguments.length?k:1)));};d3_hclPrototype.rgb=function(){return d3_hcl_lab(this.h,this.c,this.l).rgb();};function d3_hcl_lab(h,c,l){if(isNaN(h))h=0;if(isNaN(c))c=0;return new d3_lab(l,Math.cos(h*=d3_radians)*c,Math.sin(h)*c);}d3.lab=d3_lab;function d3_lab(l,a,b){return this instanceof d3_lab?void(this.l=+l,this.a=+a,this.b=+b):arguments.length<2?l instanceof d3_lab?new d3_lab(l.l,l.a,l.b):l instanceof d3_hcl?d3_hcl_lab(l.h,l.c,l.l):d3_rgb_lab((l=d3_rgb(l)).r,l.g,l.b):new d3_lab(l,a,b);}var d3_lab_K=18;var d3_lab_X=.95047,d3_lab_Y=1,d3_lab_Z=1.08883;var d3_labPrototype=d3_lab.prototype=new d3_color();d3_labPrototype.brighter=function(k){return new d3_lab(Math.min(100,this.l+d3_lab_K*(arguments.length?k:1)),this.a,this.b);};d3_labPrototype.darker=function(k){return new d3_lab(Math.max(0,this.l-d3_lab_K*(arguments.length?k:1)),this.a,this.b);};d3_labPrototype.rgb=function(){return d3_lab_rgb(this.l,this.a,this.b);};function d3_lab_rgb(l,a,b){var y=(l+16)/116,x=y+a/500,z=y-b/200;x=d3_lab_xyz(x)*d3_lab_X;y=d3_lab_xyz(y)*d3_lab_Y;z=d3_lab_xyz(z)*d3_lab_Z;return new d3_rgb(d3_xyz_rgb(3.2404542*x-1.5371385*y-.4985314*z),d3_xyz_rgb(-.969266*x+1.8760108*y+.041556*z),d3_xyz_rgb(.0556434*x-.2040259*y+1.0572252*z));}function d3_lab_hcl(l,a,b){return l>0?new d3_hcl(Math.atan2(b,a)*d3_degrees,Math.sqrt(a*a+b*b),l):new d3_hcl(NaN,NaN,l);}function d3_lab_xyz(x){return x>.206893034?x*x*x:(x-4/29)/7.787037;}function d3_xyz_lab(x){return x>.008856?Math.pow(x,1/3):7.787037*x+4/29;}function d3_xyz_rgb(r){return Math.round(255*(r<=.00304?12.92*r:1.055*Math.pow(r,1/2.4)-.055));}d3.rgb=d3_rgb;function d3_rgb(r,g,b){return this instanceof d3_rgb?void(this.r=~~r,this.g=~~g,this.b=~~b):arguments.length<2?r instanceof d3_rgb?new d3_rgb(r.r,r.g,r.b):d3_rgb_parse(""+r,d3_rgb,d3_hsl_rgb):new d3_rgb(r,g,b);}function d3_rgbNumber(value){return new d3_rgb(value>>16,value>>8&255,value&255);}function d3_rgbString(value){return d3_rgbNumber(value)+"";}var d3_rgbPrototype=d3_rgb.prototype=new d3_color();d3_rgbPrototype.brighter=function(k){k=Math.pow(.7,arguments.length?k:1);var r=this.r,g=this.g,b=this.b,i=30;if(!r&&!g&&!b)return new d3_rgb(i,i,i);if(r&&r<i)r=i;if(g&&g<i)g=i;if(b&&b<i)b=i;return new d3_rgb(Math.min(255,r/k),Math.min(255,g/k),Math.min(255,b/k));};d3_rgbPrototype.darker=function(k){k=Math.pow(.7,arguments.length?k:1);return new d3_rgb(k*this.r,k*this.g,k*this.b);};d3_rgbPrototype.hsl=function(){return d3_rgb_hsl(this.r,this.g,this.b);};d3_rgbPrototype.toString=function(){return"#"+d3_rgb_hex(this.r)+d3_rgb_hex(this.g)+d3_rgb_hex(this.b);};function d3_rgb_hex(v){return v<16?"0"+Math.max(0,v).toString(16):Math.min(255,v).toString(16);}function d3_rgb_parse(format,rgb,hsl){var r=0,g=0,b=0,m1,m2,color;m1=/([a-z]+)\((.*)\)/.exec(format=format.toLowerCase());if(m1){m2=m1[2].split(",");switch(m1[1]){case"hsl":{return hsl(parseFloat(m2[0]),parseFloat(m2[1])/100,parseFloat(m2[2])/100);}case"rgb":{return rgb(d3_rgb_parseNumber(m2[0]),d3_rgb_parseNumber(m2[1]),d3_rgb_parseNumber(m2[2]));}}}if(color=d3_rgb_names.get(format)){return rgb(color.r,color.g,color.b);}if(format!=null&&format.charAt(0)==="#"&&!isNaN(color=parseInt(format.slice(1),16))){if(format.length===4){r=(color&3840)>>4;r=r>>4|r;g=color&240;g=g>>4|g;b=color&15;b=b<<4|b;}else if(format.length===7){r=(color&16711680)>>16;g=(color&65280)>>8;b=color&255;}}return rgb(r,g,b);}function d3_rgb_hsl(r,g,b){var min=Math.min(r/=255,g/=255,b/=255),max=Math.max(r,g,b),d=max-min,h,s,l=(max+min)/2;if(d){s=l<.5?d/(max+min):d/(2-max-min);if(r==max)h=(g-b)/d+(g<b?6:0);else if(g==max)h=(b-r)/d+2;else h=(r-g)/d+4;h*=60;}else{h=NaN;s=l>0&&l<1?0:h;}return new d3_hsl(h,s,l);}function d3_rgb_lab(r,g,b){r=d3_rgb_xyz(r);g=d3_rgb_xyz(g);b=d3_rgb_xyz(b);var x=d3_xyz_lab((.4124564*r+.3575761*g+.1804375*b)/d3_lab_X),y=d3_xyz_lab((.2126729*r+.7151522*g+.072175*b)/d3_lab_Y),z=d3_xyz_lab((.0193339*r+.119192*g+.9503041*b)/d3_lab_Z);return d3_lab(116*y-16,500*(x-y),200*(y-z));}function d3_rgb_xyz(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4);}function d3_rgb_parseNumber(c){var f=parseFloat(c);return c.charAt(c.length-1)==="%"?Math.round(f*2.55):f;}var d3_rgb_names=d3.map({aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074});d3_rgb_names.forEach(function(key,value){d3_rgb_names.set(key,d3_rgbNumber(value));});function d3_functor(v){return typeof v==="function"?v:function(){return v;};}d3.functor=d3_functor;d3.xhr=d3_xhrType(d3_identity);function d3_xhrType(response){return function(url,mimeType,callback){if(arguments.length===2&&typeof mimeType==="function")callback=mimeType,mimeType=null;return d3_xhr(url,mimeType,response,callback);};}function d3_xhr(url,mimeType,response,callback){var xhr={},dispatch=d3.dispatch("beforesend","progress","load","error"),headers={},request=new XMLHttpRequest(),responseType=null;if(this.XDomainRequest&&!("withCredentials"in request)&&/^(http(s)?:)?\/\//.test(url))request=new XDomainRequest();"onload"in request?request.onload=request.onerror=respond:request.onreadystatechange=function(){request.readyState>3&&respond();};function respond(){var status=request.status,result;if(!status&&d3_xhrHasResponse(request)||status>=200&&status<300||status===304){try{result=response.call(xhr,request);}catch(e){dispatch.error.call(xhr,e);return;}dispatch.load.call(xhr,result);}else{dispatch.error.call(xhr,request);}}request.onprogress=function(event){var o=d3.event;d3.event=event;try{dispatch.progress.call(xhr,request);}finally{d3.event=o;}};xhr.header=function(name,value){name=(name+"").toLowerCase();if(arguments.length<2)return headers[name];if(value==null)delete headers[name];else headers[name]=value+"";return xhr;};xhr.mimeType=function(value){if(!arguments.length)return mimeType;mimeType=value==null?null:value+"";return xhr;};xhr.responseType=function(value){if(!arguments.length)return responseType;responseType=value;return xhr;};xhr.response=function(value){response=value;return xhr;};["get","post"].forEach(function(method){xhr[method]=function(){return xhr.send.apply(xhr,[method].concat(d3_array(arguments)));};});xhr.send=function(method,data,callback){if(arguments.length===2&&typeof data==="function")callback=data,data=null;request.open(method,url,true);if(mimeType!=null&&!("accept"in headers))headers["accept"]=mimeType+",*/*";if(request.setRequestHeader)for(var name in headers){request.setRequestHeader(name,headers[name]);}if(mimeType!=null&&request.overrideMimeType)request.overrideMimeType(mimeType);if(responseType!=null)request.responseType=responseType;if(callback!=null)xhr.on("error",callback).on("load",function(request){callback(null,request);});dispatch.beforesend.call(xhr,request);request.send(data==null?null:data);return xhr;};xhr.abort=function(){request.abort();return xhr;};d3.rebind(xhr,dispatch,"on");return callback==null?xhr:xhr.get(d3_xhr_fixCallback(callback));}function d3_xhr_fixCallback(callback){return callback.length===1?function(error,request){callback(error==null?request:null);}:callback;}function d3_xhrHasResponse(request){var type=request.responseType;return type&&type!=="text"?request.response:request.responseText;}d3.dsv=function(delimiter,mimeType){var reFormat=new RegExp('["'+delimiter+"\n]"),delimiterCode=delimiter.charCodeAt(0);function dsv(url,row,callback){if(arguments.length<3)callback=row,row=null;var xhr=d3_xhr(url,mimeType,row==null?response:typedResponse(row),callback);xhr.row=function(_){return arguments.length?xhr.response((row=_)==null?response:typedResponse(_)):row;};return xhr;}function response(request){return dsv.parse(request.responseText);}function typedResponse(f){return function(request){return dsv.parse(request.responseText,f);};}dsv.parse=function(text,f){var o;return dsv.parseRows(text,function(row,i){if(o)return o(row,i-1);var a=new Function("d","return {"+row.map(function(name,i){return JSON.stringify(name)+": d["+i+"]";}).join(",")+"}");o=f?function(row,i){return f(a(row),i);}:a;});};dsv.parseRows=function(text,f){var EOL={},EOF={},rows=[],N=text.length,I=0,n=0,t,eol;function token(){if(I>=N)return EOF;if(eol)return eol=false,EOL;var j=I;if(text.charCodeAt(j)===34){var i=j;while(i++<N){if(text.charCodeAt(i)===34){if(text.charCodeAt(i+1)!==34)break;++i;}}I=i+2;var c=text.charCodeAt(i+1);if(c===13){eol=true;if(text.charCodeAt(i+2)===10)++I;}else if(c===10){eol=true;}return text.slice(j+1,i).replace(/""/g,'"');}while(I<N){var c=text.charCodeAt(I++),k=1;if(c===10)eol=true;else if(c===13){eol=true;if(text.charCodeAt(I)===10)++I,++k;}else if(c!==delimiterCode)continue;return text.slice(j,I-k);}return text.slice(j);}while((t=token())!==EOF){var a=[];while(t!==EOL&&t!==EOF){a.push(t);t=token();}if(f&&(a=f(a,n++))==null)continue;rows.push(a);}return rows;};dsv.format=function(rows){if(Array.isArray(rows[0]))return dsv.formatRows(rows);var fieldSet=new d3_Set(),fields=[];rows.forEach(function(row){for(var field in row){if(!fieldSet.has(field)){fields.push(fieldSet.add(field));}}});return[fields.map(formatValue).join(delimiter)].concat(rows.map(function(row){return fields.map(function(field){return formatValue(row[field]);}).join(delimiter);})).join("\n");};dsv.formatRows=function(rows){return rows.map(formatRow).join("\n");};function formatRow(row){return row.map(formatValue).join(delimiter);}function formatValue(text){return reFormat.test(text)?'"'+text.replace(/\"/g,'""')+'"':text;}return dsv;};d3.csv=d3.dsv(",","text/csv");d3.tsv=d3.dsv("	","text/tab-separated-values");var d3_timer_queueHead,d3_timer_queueTail,d3_timer_interval,d3_timer_timeout,d3_timer_frame=this[d3_vendorSymbol(this,"requestAnimationFrame")]||function(callback){setTimeout(callback,17);};d3.timer=function(){d3_timer.apply(this,arguments);};function d3_timer(callback,delay,then){var n=arguments.length;if(n<2)delay=0;if(n<3)then=Date.now();var time=then+delay,timer={c:callback,t:time,n:null};if(d3_timer_queueTail)d3_timer_queueTail.n=timer;else d3_timer_queueHead=timer;d3_timer_queueTail=timer;if(!d3_timer_interval){d3_timer_timeout=clearTimeout(d3_timer_timeout);d3_timer_interval=1;d3_timer_frame(d3_timer_step);}return timer;}function d3_timer_step(){var now=d3_timer_mark(),delay=d3_timer_sweep()-now;if(delay>24){if(isFinite(delay)){clearTimeout(d3_timer_timeout);d3_timer_timeout=setTimeout(d3_timer_step,delay);}d3_timer_interval=0;}else{d3_timer_interval=1;d3_timer_frame(d3_timer_step);}}d3.timer.flush=function(){d3_timer_mark();d3_timer_sweep();};function d3_timer_mark(){var now=Date.now(),timer=d3_timer_queueHead;while(timer){if(now>=timer.t&&timer.c(now-timer.t))timer.c=null;timer=timer.n;}return now;}function d3_timer_sweep(){var t0,t1=d3_timer_queueHead,time=Infinity;while(t1){if(t1.c){if(t1.t<time)time=t1.t;t1=(t0=t1).n;}else{t1=t0?t0.n=t1.n:d3_timer_queueHead=t1.n;}}d3_timer_queueTail=t0;return time;}function d3_format_precision(x,p){return p-(x?Math.ceil(Math.log(x)/Math.LN10):1);}d3.round=function(x,n){return n?Math.round(x*(n=Math.pow(10,n)))/n:Math.round(x);};var d3_formatPrefixes=["y","z","a","f","p","n","","m","","k","M","G","T","P","E","Z","Y"].map(d3_formatPrefix);d3.formatPrefix=function(value,precision){var i=0;if(value=+value){if(value<0)value*=-1;if(precision)value=d3.round(value,d3_format_precision(value,precision));i=1+Math.floor(1e-12+Math.log(value)/Math.LN10);i=Math.max(-24,Math.min(24,Math.floor((i-1)/3)*3));}return d3_formatPrefixes[8+i/3];};function d3_formatPrefix(d,i){var k=Math.pow(10,abs(8-i)*3);return{scale:i>8?function(d){return d/k;}:function(d){return d*k;},symbol:d};}function d3_locale_numberFormat(locale){var locale_decimal=locale.decimal,locale_thousands=locale.thousands,locale_grouping=locale.grouping,locale_currency=locale.currency,formatGroup=locale_grouping&&locale_thousands?function(value,width){var i=value.length,t=[],j=0,g=locale_grouping[0],length=0;while(i>0&&g>0){if(length+g+1>width)g=Math.max(1,width-length);t.push(value.substring(i-=g,i+g));if((length+=g+1)>width)break;g=locale_grouping[j=(j+1)%locale_grouping.length];}return t.reverse().join(locale_thousands);}:d3_identity;return function(specifier){var match=d3_format_re.exec(specifier),fill=match[1]||" ",align=match[2]||">",sign=match[3]||"-",symbol=match[4]||"",zfill=match[5],width=+match[6],comma=match[7],precision=match[8],type=match[9],scale=1,prefix="",suffix="",integer=false,exponent=true;if(precision)precision=+precision.substring(1);if(zfill||fill==="0"&&align==="="){zfill=fill="0";align="=";}switch(type){case"n":comma=true;type="g";break;case"%":scale=100;suffix="%";type="f";break;case"p":scale=100;suffix="%";type="r";break;case"b":case"o":case"x":case"X":if(symbol==="#")prefix="0"+type.toLowerCase();case"c":exponent=false;case"d":integer=true;precision=0;break;case"s":scale=-1;type="r";break;}if(symbol==="$")prefix=locale_currency[0],suffix=locale_currency[1];if(type=="r"&&!precision)type="g";if(precision!=null){if(type=="g")precision=Math.max(1,Math.min(21,precision));else if(type=="e"||type=="f")precision=Math.max(0,Math.min(20,precision));}type=d3_format_types.get(type)||d3_format_typeDefault;var zcomma=zfill&&comma;return function(value){var fullSuffix=suffix;if(integer&&value%1)return"";var negative=value<0||value===0&&1/value<0?(value=-value,"-"):sign==="-"?"":sign;if(scale<0){var unit=d3.formatPrefix(value,precision);value=unit.scale(value);fullSuffix=unit.symbol+suffix;}else{value*=scale;}value=type(value,precision);var i=value.lastIndexOf("."),before,after;if(i<0){var j=exponent?value.lastIndexOf("e"):-1;if(j<0)before=value,after="";else before=value.substring(0,j),after=value.substring(j);}else{before=value.substring(0,i);after=locale_decimal+value.substring(i+1);}if(!zfill&&comma)before=formatGroup(before,Infinity);var length=prefix.length+before.length+after.length+(zcomma?0:negative.length),padding=length<width?new Array(length=width-length+1).join(fill):"";if(zcomma)before=formatGroup(padding+before,padding.length?width-after.length:Infinity);negative+=prefix;value=before+after;return(align==="<"?negative+value+padding:align===">"?padding+negative+value:align==="^"?padding.substring(0,length>>=1)+negative+value+padding.substring(length):negative+(zcomma?value:padding+value))+fullSuffix;};};}var d3_format_re=/(?:([^{])?([<>=^]))?([+\- ])?([$#])?(0)?(\d+)?(,)?(\.-?\d+)?([a-z%])?/i;var d3_format_types=d3.map({b:function b(x){return x.toString(2);},c:function c(x){return String.fromCharCode(x);},o:function o(x){return x.toString(8);},x:function x(_x){return _x.toString(16);},X:function X(x){return x.toString(16).toUpperCase();},g:function g(x,p){return x.toPrecision(p);},e:function e(x,p){return x.toExponential(p);},f:function f(x,p){return x.toFixed(p);},r:function r(x,p){return(x=d3.round(x,d3_format_precision(x,p))).toFixed(Math.max(0,Math.min(20,d3_format_precision(x*(1+1e-15),p))));}});function d3_format_typeDefault(x){return x+"";}var d3_time=d3.time={},d3_date=Date;function d3_date_utc(){this._=new Date(arguments.length>1?Date.UTC.apply(this,arguments):arguments[0]);}d3_date_utc.prototype={getDate:function getDate(){return this._.getUTCDate();},getDay:function getDay(){return this._.getUTCDay();},getFullYear:function getFullYear(){return this._.getUTCFullYear();},getHours:function getHours(){return this._.getUTCHours();},getMilliseconds:function getMilliseconds(){return this._.getUTCMilliseconds();},getMinutes:function getMinutes(){return this._.getUTCMinutes();},getMonth:function getMonth(){return this._.getUTCMonth();},getSeconds:function getSeconds(){return this._.getUTCSeconds();},getTime:function getTime(){return this._.getTime();},getTimezoneOffset:function getTimezoneOffset(){return 0;},valueOf:function valueOf(){return this._.valueOf();},setDate:function setDate(){d3_time_prototype.setUTCDate.apply(this._,arguments);},setDay:function setDay(){d3_time_prototype.setUTCDay.apply(this._,arguments);},setFullYear:function setFullYear(){d3_time_prototype.setUTCFullYear.apply(this._,arguments);},setHours:function setHours(){d3_time_prototype.setUTCHours.apply(this._,arguments);},setMilliseconds:function setMilliseconds(){d3_time_prototype.setUTCMilliseconds.apply(this._,arguments);},setMinutes:function setMinutes(){d3_time_prototype.setUTCMinutes.apply(this._,arguments);},setMonth:function setMonth(){d3_time_prototype.setUTCMonth.apply(this._,arguments);},setSeconds:function setSeconds(){d3_time_prototype.setUTCSeconds.apply(this._,arguments);},setTime:function setTime(){d3_time_prototype.setTime.apply(this._,arguments);}};var d3_time_prototype=Date.prototype;function d3_time_interval(local,step,number){function round(date){var d0=local(date),d1=offset(d0,1);return date-d0<d1-date?d0:d1;}function ceil(date){step(date=local(new d3_date(date-1)),1);return date;}function offset(date,k){step(date=new d3_date(+date),k);return date;}function range(t0,t1,dt){var time=ceil(t0),times=[];if(dt>1){while(time<t1){if(!(number(time)%dt))times.push(new Date(+time));step(time,1);}}else{while(time<t1){times.push(new Date(+time)),step(time,1);}}return times;}function range_utc(t0,t1,dt){try{d3_date=d3_date_utc;var utc=new d3_date_utc();utc._=t0;return range(utc,t1,dt);}finally{d3_date=Date;}}local.floor=local;local.round=round;local.ceil=ceil;local.offset=offset;local.range=range;var utc=local.utc=d3_time_interval_utc(local);utc.floor=utc;utc.round=d3_time_interval_utc(round);utc.ceil=d3_time_interval_utc(ceil);utc.offset=d3_time_interval_utc(offset);utc.range=range_utc;return local;}function d3_time_interval_utc(method){return function(date,k){try{d3_date=d3_date_utc;var utc=new d3_date_utc();utc._=date;return method(utc,k)._;}finally{d3_date=Date;}};}d3_time.year=d3_time_interval(function(date){date=d3_time.day(date);date.setMonth(0,1);return date;},function(date,offset){date.setFullYear(date.getFullYear()+offset);},function(date){return date.getFullYear();});d3_time.years=d3_time.year.range;d3_time.years.utc=d3_time.year.utc.range;d3_time.day=d3_time_interval(function(date){var day=new d3_date(2e3,0);day.setFullYear(date.getFullYear(),date.getMonth(),date.getDate());return day;},function(date,offset){date.setDate(date.getDate()+offset);},function(date){return date.getDate()-1;});d3_time.days=d3_time.day.range;d3_time.days.utc=d3_time.day.utc.range;d3_time.dayOfYear=function(date){var year=d3_time.year(date);return Math.floor((date-year-(date.getTimezoneOffset()-year.getTimezoneOffset())*6e4)/864e5);};["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].forEach(function(day,i){i=7-i;var interval=d3_time[day]=d3_time_interval(function(date){(date=d3_time.day(date)).setDate(date.getDate()-(date.getDay()+i)%7);return date;},function(date,offset){date.setDate(date.getDate()+Math.floor(offset)*7);},function(date){var day=d3_time.year(date).getDay();return Math.floor((d3_time.dayOfYear(date)+(day+i)%7)/7)-(day!==i);});d3_time[day+"s"]=interval.range;d3_time[day+"s"].utc=interval.utc.range;d3_time[day+"OfYear"]=function(date){var day=d3_time.year(date).getDay();return Math.floor((d3_time.dayOfYear(date)+(day+i)%7)/7);};});d3_time.week=d3_time.sunday;d3_time.weeks=d3_time.sunday.range;d3_time.weeks.utc=d3_time.sunday.utc.range;d3_time.weekOfYear=d3_time.sundayOfYear;function d3_locale_timeFormat(locale){var locale_dateTime=locale.dateTime,locale_date=locale.date,locale_time=locale.time,locale_periods=locale.periods,locale_days=locale.days,locale_shortDays=locale.shortDays,locale_months=locale.months,locale_shortMonths=locale.shortMonths;function d3_time_format(template){var n=template.length;function format(date){var string=[],i=-1,j=0,c,p,f;while(++i<n){if(template.charCodeAt(i)===37){string.push(template.slice(j,i));if((p=d3_time_formatPads[c=template.charAt(++i)])!=null)c=template.charAt(++i);if(f=d3_time_formats[c])c=f(date,p==null?c==="e"?" ":"0":p);string.push(c);j=i+1;}}string.push(template.slice(j,i));return string.join("");}format.parse=function(string){var d={y:1900,m:0,d:1,H:0,M:0,S:0,L:0,Z:null},i=d3_time_parse(d,template,string,0);if(i!=string.length)return null;if("p"in d)d.H=d.H%12+d.p*12;var localZ=d.Z!=null&&d3_date!==d3_date_utc,date=new(localZ?d3_date_utc:d3_date)();if("j"in d)date.setFullYear(d.y,0,d.j);else if("W"in d||"U"in d){if(!("w"in d))d.w="W"in d?1:0;date.setFullYear(d.y,0,1);date.setFullYear(d.y,0,"W"in d?(d.w+6)%7+d.W*7-(date.getDay()+5)%7:d.w+d.U*7-(date.getDay()+6)%7);}else date.setFullYear(d.y,d.m,d.d);date.setHours(d.H+(d.Z/100|0),d.M+d.Z%100,d.S,d.L);return localZ?date._:date;};format.toString=function(){return template;};return format;}function d3_time_parse(date,template,string,j){var c,p,t,i=0,n=template.length,m=string.length;while(i<n){if(j>=m)return-1;c=template.charCodeAt(i++);if(c===37){t=template.charAt(i++);p=d3_time_parsers[t in d3_time_formatPads?template.charAt(i++):t];if(!p||(j=p(date,string,j))<0)return-1;}else if(c!=string.charCodeAt(j++)){return-1;}}return j;}d3_time_format.utc=function(template){var local=d3_time_format(template);function format(date){try{d3_date=d3_date_utc;var utc=new d3_date();utc._=date;return local(utc);}finally{d3_date=Date;}}format.parse=function(string){try{d3_date=d3_date_utc;var date=local.parse(string);return date&&date._;}finally{d3_date=Date;}};format.toString=local.toString;return format;};d3_time_format.multi=d3_time_format.utc.multi=d3_time_formatMulti;var d3_time_periodLookup=d3.map(),d3_time_dayRe=d3_time_formatRe(locale_days),d3_time_dayLookup=d3_time_formatLookup(locale_days),d3_time_dayAbbrevRe=d3_time_formatRe(locale_shortDays),d3_time_dayAbbrevLookup=d3_time_formatLookup(locale_shortDays),d3_time_monthRe=d3_time_formatRe(locale_months),d3_time_monthLookup=d3_time_formatLookup(locale_months),d3_time_monthAbbrevRe=d3_time_formatRe(locale_shortMonths),d3_time_monthAbbrevLookup=d3_time_formatLookup(locale_shortMonths);locale_periods.forEach(function(p,i){d3_time_periodLookup.set(p.toLowerCase(),i);});var d3_time_formats={a:function a(d){return locale_shortDays[d.getDay()];},A:function A(d){return locale_days[d.getDay()];},b:function b(d){return locale_shortMonths[d.getMonth()];},B:function B(d){return locale_months[d.getMonth()];},c:d3_time_format(locale_dateTime),d:function d(_d,p){return d3_time_formatPad(_d.getDate(),p,2);},e:function e(d,p){return d3_time_formatPad(d.getDate(),p,2);},H:function H(d,p){return d3_time_formatPad(d.getHours(),p,2);},I:function I(d,p){return d3_time_formatPad(d.getHours()%12||12,p,2);},j:function j(d,p){return d3_time_formatPad(1+d3_time.dayOfYear(d),p,3);},L:function L(d,p){return d3_time_formatPad(d.getMilliseconds(),p,3);},m:function m(d,p){return d3_time_formatPad(d.getMonth()+1,p,2);},M:function M(d,p){return d3_time_formatPad(d.getMinutes(),p,2);},p:function p(d){return locale_periods[+(d.getHours()>=12)];},S:function S(d,p){return d3_time_formatPad(d.getSeconds(),p,2);},U:function U(d,p){return d3_time_formatPad(d3_time.sundayOfYear(d),p,2);},w:function w(d){return d.getDay();},W:function W(d,p){return d3_time_formatPad(d3_time.mondayOfYear(d),p,2);},x:d3_time_format(locale_date),X:d3_time_format(locale_time),y:function y(d,p){return d3_time_formatPad(d.getFullYear()%100,p,2);},Y:function Y(d,p){return d3_time_formatPad(d.getFullYear()%1e4,p,4);},Z:d3_time_zone,"%":function _(){return"%";}};var d3_time_parsers={a:d3_time_parseWeekdayAbbrev,A:d3_time_parseWeekday,b:d3_time_parseMonthAbbrev,B:d3_time_parseMonth,c:d3_time_parseLocaleFull,d:d3_time_parseDay,e:d3_time_parseDay,H:d3_time_parseHour24,I:d3_time_parseHour24,j:d3_time_parseDayOfYear,L:d3_time_parseMilliseconds,m:d3_time_parseMonthNumber,M:d3_time_parseMinutes,p:d3_time_parseAmPm,S:d3_time_parseSeconds,U:d3_time_parseWeekNumberSunday,w:d3_time_parseWeekdayNumber,W:d3_time_parseWeekNumberMonday,x:d3_time_parseLocaleDate,X:d3_time_parseLocaleTime,y:d3_time_parseYear,Y:d3_time_parseFullYear,Z:d3_time_parseZone,"%":d3_time_parseLiteralPercent};function d3_time_parseWeekdayAbbrev(date,string,i){d3_time_dayAbbrevRe.lastIndex=0;var n=d3_time_dayAbbrevRe.exec(string.slice(i));return n?(date.w=d3_time_dayAbbrevLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}function d3_time_parseWeekday(date,string,i){d3_time_dayRe.lastIndex=0;var n=d3_time_dayRe.exec(string.slice(i));return n?(date.w=d3_time_dayLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}function d3_time_parseMonthAbbrev(date,string,i){d3_time_monthAbbrevRe.lastIndex=0;var n=d3_time_monthAbbrevRe.exec(string.slice(i));return n?(date.m=d3_time_monthAbbrevLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}function d3_time_parseMonth(date,string,i){d3_time_monthRe.lastIndex=0;var n=d3_time_monthRe.exec(string.slice(i));return n?(date.m=d3_time_monthLookup.get(n[0].toLowerCase()),i+n[0].length):-1;}function d3_time_parseLocaleFull(date,string,i){return d3_time_parse(date,d3_time_formats.c.toString(),string,i);}function d3_time_parseLocaleDate(date,string,i){return d3_time_parse(date,d3_time_formats.x.toString(),string,i);}function d3_time_parseLocaleTime(date,string,i){return d3_time_parse(date,d3_time_formats.X.toString(),string,i);}function d3_time_parseAmPm(date,string,i){var n=d3_time_periodLookup.get(string.slice(i,i+=2).toLowerCase());return n==null?-1:(date.p=n,i);}return d3_time_format;}var d3_time_formatPads={"-":"",_:" ","0":"0"},d3_time_numberRe=/^\s*\d+/,d3_time_percentRe=/^%/;function d3_time_formatPad(value,fill,width){var sign=value<0?"-":"",string=(sign?-value:value)+"",length=string.length;return sign+(length<width?new Array(width-length+1).join(fill)+string:string);}function d3_time_formatRe(names){return new RegExp("^(?:"+names.map(d3.requote).join("|")+")","i");}function d3_time_formatLookup(names){var map=new d3_Map(),i=-1,n=names.length;while(++i<n){map.set(names[i].toLowerCase(),i);}return map;}function d3_time_parseWeekdayNumber(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+1));return n?(date.w=+n[0],i+n[0].length):-1;}function d3_time_parseWeekNumberSunday(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i));return n?(date.U=+n[0],i+n[0].length):-1;}function d3_time_parseWeekNumberMonday(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i));return n?(date.W=+n[0],i+n[0].length):-1;}function d3_time_parseFullYear(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+4));return n?(date.y=+n[0],i+n[0].length):-1;}function d3_time_parseYear(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+2));return n?(date.y=d3_time_expandYear(+n[0]),i+n[0].length):-1;}function d3_time_parseZone(date,string,i){return /^[+-]\d{4}$/.test(string=string.slice(i,i+5))?(date.Z=-string,i+5):-1;}function d3_time_expandYear(d){return d+(d>68?1900:2e3);}function d3_time_parseMonthNumber(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+2));return n?(date.m=n[0]-1,i+n[0].length):-1;}function d3_time_parseDay(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+2));return n?(date.d=+n[0],i+n[0].length):-1;}function d3_time_parseDayOfYear(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+3));return n?(date.j=+n[0],i+n[0].length):-1;}function d3_time_parseHour24(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+2));return n?(date.H=+n[0],i+n[0].length):-1;}function d3_time_parseMinutes(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+2));return n?(date.M=+n[0],i+n[0].length):-1;}function d3_time_parseSeconds(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+2));return n?(date.S=+n[0],i+n[0].length):-1;}function d3_time_parseMilliseconds(date,string,i){d3_time_numberRe.lastIndex=0;var n=d3_time_numberRe.exec(string.slice(i,i+3));return n?(date.L=+n[0],i+n[0].length):-1;}function d3_time_zone(d){var z=d.getTimezoneOffset(),zs=z>0?"-":"+",zh=abs(z)/60|0,zm=abs(z)%60;return zs+d3_time_formatPad(zh,"0",2)+d3_time_formatPad(zm,"0",2);}function d3_time_parseLiteralPercent(date,string,i){d3_time_percentRe.lastIndex=0;var n=d3_time_percentRe.exec(string.slice(i,i+1));return n?i+n[0].length:-1;}function d3_time_formatMulti(formats){var n=formats.length,i=-1;while(++i<n){formats[i][0]=this(formats[i][0]);}return function(date){var i=0,f=formats[i];while(!f[1](date)){f=formats[++i];}return f[0](date);};}d3.locale=function(locale){return{numberFormat:d3_locale_numberFormat(locale),timeFormat:d3_locale_timeFormat(locale)};};var d3_locale_enUS=d3.locale({decimal:".",thousands:",",grouping:[3],currency:["$",""],dateTime:"%a %b %e %X %Y",date:"%m/%d/%Y",time:"%H:%M:%S",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});d3.format=d3_locale_enUS.numberFormat;d3.geo={};function d3_adder(){}d3_adder.prototype={s:0,t:0,add:function add(y){d3_adderSum(y,this.t,d3_adderTemp);d3_adderSum(d3_adderTemp.s,this.s,this);if(this.s)this.t+=d3_adderTemp.t;else this.s=d3_adderTemp.t;},reset:function reset(){this.s=this.t=0;},valueOf:function valueOf(){return this.s;}};var d3_adderTemp=new d3_adder();function d3_adderSum(a,b,o){var x=o.s=a+b,bv=x-a,av=x-bv;o.t=a-av+(b-bv);}d3.geo.stream=function(object,listener){if(object&&d3_geo_streamObjectType.hasOwnProperty(object.type)){d3_geo_streamObjectType[object.type](object,listener);}else{d3_geo_streamGeometry(object,listener);}};function d3_geo_streamGeometry(geometry,listener){if(geometry&&d3_geo_streamGeometryType.hasOwnProperty(geometry.type)){d3_geo_streamGeometryType[geometry.type](geometry,listener);}}var d3_geo_streamObjectType={Feature:function Feature(feature,listener){d3_geo_streamGeometry(feature.geometry,listener);},FeatureCollection:function FeatureCollection(object,listener){var features=object.features,i=-1,n=features.length;while(++i<n){d3_geo_streamGeometry(features[i].geometry,listener);}}};var d3_geo_streamGeometryType={Sphere:function Sphere(object,listener){listener.sphere();},Point:function Point(object,listener){object=object.coordinates;listener.point(object[0],object[1],object[2]);},MultiPoint:function MultiPoint(object,listener){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n){object=coordinates[i],listener.point(object[0],object[1],object[2]);}},LineString:function LineString(object,listener){d3_geo_streamLine(object.coordinates,listener,0);},MultiLineString:function MultiLineString(object,listener){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n){d3_geo_streamLine(coordinates[i],listener,0);}},Polygon:function Polygon(object,listener){d3_geo_streamPolygon(object.coordinates,listener);},MultiPolygon:function MultiPolygon(object,listener){var coordinates=object.coordinates,i=-1,n=coordinates.length;while(++i<n){d3_geo_streamPolygon(coordinates[i],listener);}},GeometryCollection:function GeometryCollection(object,listener){var geometries=object.geometries,i=-1,n=geometries.length;while(++i<n){d3_geo_streamGeometry(geometries[i],listener);}}};function d3_geo_streamLine(coordinates,listener,closed){var i=-1,n=coordinates.length-closed,coordinate;listener.lineStart();while(++i<n){coordinate=coordinates[i],listener.point(coordinate[0],coordinate[1],coordinate[2]);}listener.lineEnd();}function d3_geo_streamPolygon(coordinates,listener){var i=-1,n=coordinates.length;listener.polygonStart();while(++i<n){d3_geo_streamLine(coordinates[i],listener,1);}listener.polygonEnd();}d3.geo.area=function(object){d3_geo_areaSum=0;d3.geo.stream(object,d3_geo_area);return d3_geo_areaSum;};var d3_geo_areaSum,d3_geo_areaRingSum=new d3_adder();var d3_geo_area={sphere:function sphere(){d3_geo_areaSum+=4*;},point:d3_noop,lineStart:d3_noop,lineEnd:d3_noop,polygonStart:function polygonStart(){d3_geo_areaRingSum.reset();d3_geo_area.lineStart=d3_geo_areaRingStart;},polygonEnd:function polygonEnd(){var area=2*d3_geo_areaRingSum;d3_geo_areaSum+=area<0?4*+area:area;d3_geo_area.lineStart=d3_geo_area.lineEnd=d3_geo_area.point=d3_noop;}};function d3_geo_areaRingStart(){var 00,00,0,cos0,sin0;d3_geo_area.point=function(,){d3_geo_area.point=nextPoint;0=(00=)*d3_radians,cos0=Math.cos(=(00=)*d3_radians/2+/4),sin0=Math.sin();};function nextPoint(,){*=d3_radians;=*d3_radians/2+/4;var d=-0,sd=d>=0?1:-1,ad=sd*d,cos=Math.cos(),sin=Math.sin(),k=sin0*sin,u=cos0*cos+k*Math.cos(ad),v=k*sd*Math.sin(ad);d3_geo_areaRingSum.add(Math.atan2(v,u));0=,cos0=cos,sin0=sin;}d3_geo_area.lineEnd=function(){nextPoint(00,00);};}function d3_geo_cartesian(spherical){var =spherical[0],=spherical[1],cos=Math.cos();return[cos*Math.cos(),cos*Math.sin(),Math.sin()];}function d3_geo_cartesianDot(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2];}function d3_geo_cartesianCross(a,b){return[a[1]*b[2]-a[2]*b[1],a[2]*b[0]-a[0]*b[2],a[0]*b[1]-a[1]*b[0]];}function d3_geo_cartesianAdd(a,b){a[0]+=b[0];a[1]+=b[1];a[2]+=b[2];}function d3_geo_cartesianScale(vector,k){return[vector[0]*k,vector[1]*k,vector[2]*k];}function d3_geo_cartesianNormalize(d){var l=Math.sqrt(d[0]*d[0]+d[1]*d[1]+d[2]*d[2]);d[0]/=l;d[1]/=l;d[2]/=l;}function d3_geo_spherical(cartesian){return[Math.atan2(cartesian[1],cartesian[0]),d3_asin(cartesian[2])];}function d3_geo_sphericalEqual(a,b){return abs(a[0]-b[0])<&&abs(a[1]-b[1])<;}d3.geo.bounds=function(){var 0,0,1,1,_,__,__,p0,dSum,ranges,range;var bound={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function polygonStart(){bound.point=ringPoint;bound.lineStart=ringStart;bound.lineEnd=ringEnd;dSum=0;d3_geo_area.polygonStart();},polygonEnd:function polygonEnd(){d3_geo_area.polygonEnd();bound.point=point;bound.lineStart=lineStart;bound.lineEnd=lineEnd;if(d3_geo_areaRingSum<0)0=-(1=180),0=-(1=90);else if(dSum>)1=90;else if(dSum<-)0=-90;range[0]=0,range[1]=1;}};function point(,){ranges.push(range=[0=,1=]);if(<0)0=;if(>1)1=;}function linePoint(,){var p=d3_geo_cartesian([*d3_radians,*d3_radians]);if(p0){var normal=d3_geo_cartesianCross(p0,p),equatorial=[normal[1],-normal[0],0],inflection=d3_geo_cartesianCross(equatorial,normal);d3_geo_cartesianNormalize(inflection);inflection=d3_geo_spherical(inflection);var d=-_,s=d>0?1:-1,i=inflection[0]*d3_degrees*s,antimeridian=abs(d)>180;if(antimeridian^(s*_<i&&i<s*)){var i=inflection[1]*d3_degrees;if(i>1)1=i;}else if(i=(i+360)%360-180,antimeridian^(s*_<i&&i<s*)){var i=-inflection[1]*d3_degrees;if(i<0)0=i;}else{if(<0)0=;if(>1)1=;}if(antimeridian){if(<_){if(angle(0,)>angle(0,1))1=;}else{if(angle(,1)>angle(0,1))0=;}}else{if(1>=0){if(<0)0=;if(>1)1=;}else{if(>_){if(angle(0,)>angle(0,1))1=;}else{if(angle(,1)>angle(0,1))0=;}}}}else{point(,);}p0=p,_=;}function lineStart(){bound.point=linePoint;}function lineEnd(){range[0]=0,range[1]=1;bound.point=point;p0=null;}function ringPoint(,){if(p0){var d=-_;dSum+=abs(d)>180?d+(d>0?360:-360):d;}else __=,__=;d3_geo_area.point(,);linePoint(,);}function ringStart(){d3_geo_area.lineStart();}function ringEnd(){ringPoint(__,__);d3_geo_area.lineEnd();if(abs(dSum)>)0=-(1=180);range[0]=0,range[1]=1;p0=null;}function angle(0,1){return(1-=0)<0?1+360:1;}function compareRanges(a,b){return a[0]-b[0];}function withinRange(x,range){return range[0]<=range[1]?range[0]<=x&&x<=range[1]:x<range[0]||range[1]<x;}return function(feature){1=1=-(0=0=Infinity);ranges=[];d3.geo.stream(feature,bound);var n=ranges.length;if(n){ranges.sort(compareRanges);for(var i=1,a=ranges[0],b,merged=[a];i<n;++i){b=ranges[i];if(withinRange(b[0],a)||withinRange(b[1],a)){if(angle(a[0],b[1])>angle(a[0],a[1]))a[1]=b[1];if(angle(b[0],a[1])>angle(a[0],a[1]))a[0]=b[0];}else{merged.push(a=b);}}var best=-Infinity,d;for(var n=merged.length-1,i=0,a=merged[n],b;i<=n;a=b,++i){b=merged[i];if((d=angle(a[1],b[0]))>best)best=d,0=b[0],1=a[1];}}ranges=range=null;return 0===Infinity||0===Infinity?[[NaN,NaN],[NaN,NaN]]:[[0,0],[1,1]];};}();d3.geo.centroid=function(object){d3_geo_centroidW0=d3_geo_centroidW1=d3_geo_centroidX0=d3_geo_centroidY0=d3_geo_centroidZ0=d3_geo_centroidX1=d3_geo_centroidY1=d3_geo_centroidZ1=d3_geo_centroidX2=d3_geo_centroidY2=d3_geo_centroidZ2=0;d3.geo.stream(object,d3_geo_centroid);var x=d3_geo_centroidX2,y=d3_geo_centroidY2,z=d3_geo_centroidZ2,m=x*x+y*y+z*z;if(m<2){x=d3_geo_centroidX1,y=d3_geo_centroidY1,z=d3_geo_centroidZ1;if(d3_geo_centroidW1<)x=d3_geo_centroidX0,y=d3_geo_centroidY0,z=d3_geo_centroidZ0;m=x*x+y*y+z*z;if(m<2)return[NaN,NaN];}return[Math.atan2(y,x)*d3_degrees,d3_asin(z/Math.sqrt(m))*d3_degrees];};var d3_geo_centroidW0,d3_geo_centroidW1,d3_geo_centroidX0,d3_geo_centroidY0,d3_geo_centroidZ0,d3_geo_centroidX1,d3_geo_centroidY1,d3_geo_centroidZ1,d3_geo_centroidX2,d3_geo_centroidY2,d3_geo_centroidZ2;var d3_geo_centroid={sphere:d3_noop,point:d3_geo_centroidPoint,lineStart:d3_geo_centroidLineStart,lineEnd:d3_geo_centroidLineEnd,polygonStart:function polygonStart(){d3_geo_centroid.lineStart=d3_geo_centroidRingStart;},polygonEnd:function polygonEnd(){d3_geo_centroid.lineStart=d3_geo_centroidLineStart;}};function d3_geo_centroidPoint(,){*=d3_radians;var cos=Math.cos(*=d3_radians);d3_geo_centroidPointXYZ(cos*Math.cos(),cos*Math.sin(),Math.sin());}function d3_geo_centroidPointXYZ(x,y,z){++d3_geo_centroidW0;d3_geo_centroidX0+=(x-d3_geo_centroidX0)/d3_geo_centroidW0;d3_geo_centroidY0+=(y-d3_geo_centroidY0)/d3_geo_centroidW0;d3_geo_centroidZ0+=(z-d3_geo_centroidZ0)/d3_geo_centroidW0;}function d3_geo_centroidLineStart(){var x0,y0,z0;d3_geo_centroid.point=function(,){*=d3_radians;var cos=Math.cos(*=d3_radians);x0=cos*Math.cos();y0=cos*Math.sin();z0=Math.sin();d3_geo_centroid.point=nextPoint;d3_geo_centroidPointXYZ(x0,y0,z0);};function nextPoint(,){*=d3_radians;var cos=Math.cos(*=d3_radians),x=cos*Math.cos(),y=cos*Math.sin(),z=Math.sin(),w=Math.atan2(Math.sqrt((w=y0*z-z0*y)*w+(w=z0*x-x0*z)*w+(w=x0*y-y0*x)*w),x0*x+y0*y+z0*z);d3_geo_centroidW1+=w;d3_geo_centroidX1+=w*(x0+(x0=x));d3_geo_centroidY1+=w*(y0+(y0=y));d3_geo_centroidZ1+=w*(z0+(z0=z));d3_geo_centroidPointXYZ(x0,y0,z0);}}function d3_geo_centroidLineEnd(){d3_geo_centroid.point=d3_geo_centroidPoint;}function d3_geo_centroidRingStart(){var 00,00,x0,y0,z0;d3_geo_centroid.point=function(,){00=,00=;d3_geo_centroid.point=nextPoint;*=d3_radians;var cos=Math.cos(*=d3_radians);x0=cos*Math.cos();y0=cos*Math.sin();z0=Math.sin();d3_geo_centroidPointXYZ(x0,y0,z0);};d3_geo_centroid.lineEnd=function(){nextPoint(00,00);d3_geo_centroid.lineEnd=d3_geo_centroidLineEnd;d3_geo_centroid.point=d3_geo_centroidPoint;};function nextPoint(,){*=d3_radians;var cos=Math.cos(*=d3_radians),x=cos*Math.cos(),y=cos*Math.sin(),z=Math.sin(),cx=y0*z-z0*y,cy=z0*x-x0*z,cz=x0*y-y0*x,m=Math.sqrt(cx*cx+cy*cy+cz*cz),u=x0*x+y0*y+z0*z,v=m&&-d3_acos(u)/m,w=Math.atan2(m,u);d3_geo_centroidX2+=v*cx;d3_geo_centroidY2+=v*cy;d3_geo_centroidZ2+=v*cz;d3_geo_centroidW1+=w;d3_geo_centroidX1+=w*(x0+(x0=x));d3_geo_centroidY1+=w*(y0+(y0=y));d3_geo_centroidZ1+=w*(z0+(z0=z));d3_geo_centroidPointXYZ(x0,y0,z0);}}function d3_geo_compose(a,b){function compose(x,y){return x=a(x,y),b(x[0],x[1]);}if(a.invert&&b.invert)compose.invert=function(x,y){return x=b.invert(x,y),x&&a.invert(x[0],x[1]);};return compose;}function d3_true(){return true;}function d3_geo_clipPolygon(segments,compare,clipStartInside,interpolate,listener){var subject=[],clip=[];segments.forEach(function(segment){if((n=segment.length-1)<=0)return;var n,p0=segment[0],p1=segment[n];if(d3_geo_sphericalEqual(p0,p1)){listener.lineStart();for(var i=0;i<n;++i){listener.point((p0=segment[i])[0],p0[1]);}listener.lineEnd();return;}var a=new d3_geo_clipPolygonIntersection(p0,segment,null,true),b=new d3_geo_clipPolygonIntersection(p0,null,a,false);a.o=b;subject.push(a);clip.push(b);a=new d3_geo_clipPolygonIntersection(p1,segment,null,false);b=new d3_geo_clipPolygonIntersection(p1,null,a,true);a.o=b;subject.push(a);clip.push(b);});clip.sort(compare);d3_geo_clipPolygonLinkCircular(subject);d3_geo_clipPolygonLinkCircular(clip);if(!subject.length)return;for(var i=0,entry=clipStartInside,n=clip.length;i<n;++i){clip[i].e=entry=!entry;}var start=subject[0],points,point;while(1){var current=start,isSubject=true;while(current.v){if((current=current.n)===start)return;}points=current.z;listener.lineStart();do{current.v=current.o.v=true;if(current.e){if(isSubject){for(var i=0,n=points.length;i<n;++i){listener.point((point=points[i])[0],point[1]);}}else{interpolate(current.x,current.n.x,1,listener);}current=current.n;}else{if(isSubject){points=current.p.z;for(var i=points.length-1;i>=0;--i){listener.point((point=points[i])[0],point[1]);}}else{interpolate(current.x,current.p.x,-1,listener);}current=current.p;}current=current.o;points=current.z;isSubject=!isSubject;}while(!current.v);listener.lineEnd();}}function d3_geo_clipPolygonLinkCircular(array){if(!(n=array.length))return;var n,i=0,a=array[0],b;while(++i<n){a.n=b=array[i];b.p=a;a=b;}a.n=b=array[0];b.p=a;}function d3_geo_clipPolygonIntersection(point,points,other,entry){this.x=point;this.z=points;this.o=other;this.e=entry;this.v=false;this.n=this.p=null;}function d3_geo_clip(pointVisible,clipLine,interpolate,clipStart){return function(rotate,listener){var line=clipLine(listener),rotatedClipStart=rotate.invert(clipStart[0],clipStart[1]);var clip={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function polygonStart(){clip.point=pointRing;clip.lineStart=ringStart;clip.lineEnd=ringEnd;segments=[];polygon=[];},polygonEnd:function polygonEnd(){clip.point=point;clip.lineStart=lineStart;clip.lineEnd=lineEnd;segments=d3.merge(segments);var clipStartInside=d3_geo_pointInPolygon(rotatedClipStart,polygon);if(segments.length){if(!polygonStarted)listener.polygonStart(),polygonStarted=true;d3_geo_clipPolygon(segments,d3_geo_clipSort,clipStartInside,interpolate,listener);}else if(clipStartInside){if(!polygonStarted)listener.polygonStart(),polygonStarted=true;listener.lineStart();interpolate(null,null,1,listener);listener.lineEnd();}if(polygonStarted)listener.polygonEnd(),polygonStarted=false;segments=polygon=null;},sphere:function sphere(){listener.polygonStart();listener.lineStart();interpolate(null,null,1,listener);listener.lineEnd();listener.polygonEnd();}};function point(,){var point=rotate(,);if(pointVisible(=point[0],=point[1]))listener.point(,);}function pointLine(,){var point=rotate(,);line.point(point[0],point[1]);}function lineStart(){clip.point=pointLine;line.lineStart();}function lineEnd(){clip.point=point;line.lineEnd();}var segments;var buffer=d3_geo_clipBufferListener(),ringListener=clipLine(buffer),polygonStarted=false,polygon,ring;function pointRing(,){ring.push([,]);var point=rotate(,);ringListener.point(point[0],point[1]);}function ringStart(){ringListener.lineStart();ring=[];}function ringEnd(){pointRing(ring[0][0],ring[0][1]);ringListener.lineEnd();var clean=ringListener.clean(),ringSegments=buffer.buffer(),segment,n=ringSegments.length;ring.pop();polygon.push(ring);ring=null;if(!n)return;if(clean&1){segment=ringSegments[0];var n=segment.length-1,i=-1,point;if(n>0){if(!polygonStarted)listener.polygonStart(),polygonStarted=true;listener.lineStart();while(++i<n){listener.point((point=segment[i])[0],point[1]);}listener.lineEnd();}return;}if(n>1&&clean&2)ringSegments.push(ringSegments.pop().concat(ringSegments.shift()));segments.push(ringSegments.filter(d3_geo_clipSegmentLength1));}return clip;};}function d3_geo_clipSegmentLength1(segment){return segment.length>1;}function d3_geo_clipBufferListener(){var lines=[],line;return{lineStart:function lineStart(){lines.push(line=[]);},point:function point(,){line.push([,]);},lineEnd:d3_noop,buffer:function buffer(){var buffer=lines;lines=[];line=null;return buffer;},rejoin:function rejoin(){if(lines.length>1)lines.push(lines.pop().concat(lines.shift()));}};}function d3_geo_clipSort(a,b){return((a=a.x)[0]<0?a[1]-half-:half-a[1])-((b=b.x)[0]<0?b[1]-half-:half-b[1]);}var d3_geo_clipAntimeridian=d3_geo_clip(d3_true,d3_geo_clipAntimeridianLine,d3_geo_clipAntimeridianInterpolate,[-,-/2]);function d3_geo_clipAntimeridianLine(listener){var 0=NaN,0=NaN,s0=NaN,_clean;return{lineStart:function lineStart(){listener.lineStart();_clean=1;},point:function point(1,1){var s1=1>0?:-,d=abs(1-0);if(abs(d-)<){listener.point(0,0=(0+1)/2>0?half:-half);listener.point(s0,0);listener.lineEnd();listener.lineStart();listener.point(s1,0);listener.point(1,0);_clean=0;}else if(s0!==s1&&d>=){if(abs(0-s0)<)0-=s0*;if(abs(1-s1)<)1-=s1*;0=d3_geo_clipAntimeridianIntersect(0,0,1,1);listener.point(s0,0);listener.lineEnd();listener.lineStart();listener.point(s1,0);_clean=0;}listener.point(0=1,0=1);s0=s1;},lineEnd:function lineEnd(){listener.lineEnd();0=0=NaN;},clean:function clean(){return 2-_clean;}};}function d3_geo_clipAntimeridianIntersect(0,0,1,1){var cos0,cos1,sin0_1=Math.sin(0-1);return abs(sin0_1)>?Math.atan((Math.sin(0)*(cos1=Math.cos(1))*Math.sin(1)-Math.sin(1)*(cos0=Math.cos(0))*Math.sin(0))/(cos0*cos1*sin0_1)):(0+1)/2;}function d3_geo_clipAntimeridianInterpolate(from,to,direction,listener){var ;if(from==null){=direction*half;listener.point(-,);listener.point(0,);listener.point(,);listener.point(,0);listener.point(,-);listener.point(0,-);listener.point(-,-);listener.point(-,0);listener.point(-,);}else if(abs(from[0]-to[0])>){var s=from[0]<to[0]?:-;=direction*s/2;listener.point(-s,);listener.point(0,);listener.point(s,);}else{listener.point(to[0],to[1]);}}function d3_geo_pointInPolygon(point,polygon){var meridian=point[0],parallel=point[1],meridianNormal=[Math.sin(meridian),-Math.cos(meridian),0],polarAngle=0,winding=0;d3_geo_areaRingSum.reset();for(var i=0,n=polygon.length;i<n;++i){var ring=polygon[i],m=ring.length;if(!m)continue;var point0=ring[0],0=point0[0],0=point0[1]/2+/4,sin0=Math.sin(0),cos0=Math.cos(0),j=1;while(true){if(j===m)j=0;point=ring[j];var =point[0],=point[1]/2+/4,sin=Math.sin(),cos=Math.cos(),d=-0,sd=d>=0?1:-1,ad=sd*d,antimeridian=ad>,k=sin0*sin;d3_geo_areaRingSum.add(Math.atan2(k*sd*Math.sin(ad),cos0*cos+k*Math.cos(ad)));polarAngle+=antimeridian?d+sd*:d;if(antimeridian^0>=meridian^>=meridian){var arc=d3_geo_cartesianCross(d3_geo_cartesian(point0),d3_geo_cartesian(point));d3_geo_cartesianNormalize(arc);var intersection=d3_geo_cartesianCross(meridianNormal,arc);d3_geo_cartesianNormalize(intersection);var arc=(antimeridian^d>=0?-1:1)*d3_asin(intersection[2]);if(parallel>arc||parallel===arc&&(arc[0]||arc[1])){winding+=antimeridian^d>=0?1:-1;}}if(!j++)break;0=,sin0=sin,cos0=cos,point0=point;}}return(polarAngle<-||polarAngle<&&d3_geo_areaRingSum<-)^winding&1;}function d3_geo_clipCircle(radius){var cr=Math.cos(radius),smallRadius=cr>0,notHemisphere=abs(cr)>,interpolate=d3_geo_circleInterpolate(radius,6*d3_radians);return d3_geo_clip(visible,clipLine,interpolate,smallRadius?[0,-radius]:[-,radius-]);function visible(,){return Math.cos()*Math.cos()>cr;}function clipLine(listener){var point0,c0,v0,v00,_clean2;return{lineStart:function lineStart(){v00=v0=false;_clean2=1;},point:function point(,){var point1=[,],point2,v=visible(,),c=smallRadius?v?0:code(,):v?code(+(<0?:-),):0;if(!point0&&(v00=v0=v))listener.lineStart();if(v!==v0){point2=intersect(point0,point1);if(d3_geo_sphericalEqual(point0,point2)||d3_geo_sphericalEqual(point1,point2)){point1[0]+=;point1[1]+=;v=visible(point1[0],point1[1]);}}if(v!==v0){_clean2=0;if(v){listener.lineStart();point2=intersect(point1,point0);listener.point(point2[0],point2[1]);}else{point2=intersect(point0,point1);listener.point(point2[0],point2[1]);listener.lineEnd();}point0=point2;}else if(notHemisphere&&point0&&smallRadius^v){var t;if(!(c&c0)&&(t=intersect(point1,point0,true))){_clean2=0;if(smallRadius){listener.lineStart();listener.point(t[0][0],t[0][1]);listener.point(t[1][0],t[1][1]);listener.lineEnd();}else{listener.point(t[1][0],t[1][1]);listener.lineEnd();listener.lineStart();listener.point(t[0][0],t[0][1]);}}}if(v&&(!point0||!d3_geo_sphericalEqual(point0,point1))){listener.point(point1[0],point1[1]);}point0=point1,v0=v,c0=c;},lineEnd:function lineEnd(){if(v0)listener.lineEnd();point0=null;},clean:function clean(){return _clean2|(v00&&v0)<<1;}};}function intersect(a,b,two){var pa=d3_geo_cartesian(a),pb=d3_geo_cartesian(b);var n1=[1,0,0],n2=d3_geo_cartesianCross(pa,pb),n2n2=d3_geo_cartesianDot(n2,n2),n1n2=n2[0],determinant=n2n2-n1n2*n1n2;if(!determinant)return!two&&a;var c1=cr*n2n2/determinant,c2=-cr*n1n2/determinant,n1xn2=d3_geo_cartesianCross(n1,n2),A=d3_geo_cartesianScale(n1,c1),B=d3_geo_cartesianScale(n2,c2);d3_geo_cartesianAdd(A,B);var u=n1xn2,w=d3_geo_cartesianDot(A,u),uu=d3_geo_cartesianDot(u,u),t2=w*w-uu*(d3_geo_cartesianDot(A,A)-1);if(t2<0)return;var t=Math.sqrt(t2),q=d3_geo_cartesianScale(u,(-w-t)/uu);d3_geo_cartesianAdd(q,A);q=d3_geo_spherical(q);if(!two)return q;var 0=a[0],1=b[0],0=a[1],1=b[1],z;if(1<0)z=0,0=1,1=z;var =1-0,polar=abs(-)<,meridian=polar||<;if(!polar&&1<0)z=0,0=1,1=z;if(meridian?polar?0+1>0^q[1]<(abs(q[0]-0)<?0:1):0<=q[1]&&q[1]<=1:>^(0<=q[0]&&q[0]<=1)){var q1=d3_geo_cartesianScale(u,(-w+t)/uu);d3_geo_cartesianAdd(q1,A);return[q,d3_geo_spherical(q1)];}}function code(,){var r=smallRadius?radius:-radius,code=0;if(<-r)code|=1;else if(>r)code|=2;if(<-r)code|=4;else if(>r)code|=8;return code;}}function d3_geom_clipLine(x0,y0,x1,y1){return function(line){var a=line.a,b=line.b,ax=a.x,ay=a.y,bx=b.x,by=b.y,t0=0,t1=1,dx=bx-ax,dy=by-ay,r;r=x0-ax;if(!dx&&r>0)return;r/=dx;if(dx<0){if(r<t0)return;if(r<t1)t1=r;}else if(dx>0){if(r>t1)return;if(r>t0)t0=r;}r=x1-ax;if(!dx&&r<0)return;r/=dx;if(dx<0){if(r>t1)return;if(r>t0)t0=r;}else if(dx>0){if(r<t0)return;if(r<t1)t1=r;}r=y0-ay;if(!dy&&r>0)return;r/=dy;if(dy<0){if(r<t0)return;if(r<t1)t1=r;}else if(dy>0){if(r>t1)return;if(r>t0)t0=r;}r=y1-ay;if(!dy&&r<0)return;r/=dy;if(dy<0){if(r>t1)return;if(r>t0)t0=r;}else if(dy>0){if(r<t0)return;if(r<t1)t1=r;}if(t0>0)line.a={x:ax+t0*dx,y:ay+t0*dy};if(t1<1)line.b={x:ax+t1*dx,y:ay+t1*dy};return line;};}var d3_geo_clipExtentMAX=1e9;d3.geo.clipExtent=function(){var x0,y0,x1,y1,_stream,clip,clipExtent={stream:function stream(output){if(_stream)_stream.valid=false;_stream=clip(output);_stream.valid=true;return _stream;},extent:function extent(_){if(!arguments.length)return[[x0,y0],[x1,y1]];clip=d3_geo_clipExtent(x0=+_[0][0],y0=+_[0][1],x1=+_[1][0],y1=+_[1][1]);if(_stream)_stream.valid=false,_stream=null;return clipExtent;}};return clipExtent.extent([[0,0],[960,500]]);};function d3_geo_clipExtent(x0,y0,x1,y1){return function(listener){var listener_=listener,bufferListener=d3_geo_clipBufferListener(),clipLine=d3_geom_clipLine(x0,y0,x1,y1),segments,polygon,ring;var clip={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function polygonStart(){listener=bufferListener;segments=[];polygon=[];clean=true;},polygonEnd:function polygonEnd(){listener=listener_;segments=d3.merge(segments);var clipStartInside=insidePolygon([x0,y1]),inside=clean&&clipStartInside,visible=segments.length;if(inside||visible){listener.polygonStart();if(inside){listener.lineStart();interpolate(null,null,1,listener);listener.lineEnd();}if(visible){d3_geo_clipPolygon(segments,compare,clipStartInside,interpolate,listener);}listener.polygonEnd();}segments=polygon=ring=null;}};function insidePolygon(p){var wn=0,n=polygon.length,y=p[1];for(var i=0;i<n;++i){for(var j=1,v=polygon[i],m=v.length,a=v[0],b;j<m;++j){b=v[j];if(a[1]<=y){if(b[1]>y&&d3_cross2d(a,b,p)>0)++wn;}else{if(b[1]<=y&&d3_cross2d(a,b,p)<0)--wn;}a=b;}}return wn!==0;}function interpolate(from,to,direction,listener){var a=0,a1=0;if(from==null||(a=corner(from,direction))!==(a1=corner(to,direction))||comparePoints(from,to)<0^direction>0){do{listener.point(a===0||a===3?x0:x1,a>1?y1:y0);}while((a=(a+direction+4)%4)!==a1);}else{listener.point(to[0],to[1]);}}function pointVisible(x,y){return x0<=x&&x<=x1&&y0<=y&&y<=y1;}function point(x,y){if(pointVisible(x,y))listener.point(x,y);}var x__,y__,v__,x_,y_,v_,first,clean;function lineStart(){clip.point=linePoint;if(polygon)polygon.push(ring=[]);first=true;v_=false;x_=y_=NaN;}function lineEnd(){if(segments){linePoint(x__,y__);if(v__&&v_)bufferListener.rejoin();segments.push(bufferListener.buffer());}clip.point=point;if(v_)listener.lineEnd();}function linePoint(x,y){x=Math.max(-d3_geo_clipExtentMAX,Math.min(d3_geo_clipExtentMAX,x));y=Math.max(-d3_geo_clipExtentMAX,Math.min(d3_geo_clipExtentMAX,y));var v=pointVisible(x,y);if(polygon)ring.push([x,y]);if(first){x__=x,y__=y,v__=v;first=false;if(v){listener.lineStart();listener.point(x,y);}}else{if(v&&v_)listener.point(x,y);else{var l={a:{x:x_,y:y_},b:{x:x,y:y}};if(clipLine(l)){if(!v_){listener.lineStart();listener.point(l.a.x,l.a.y);}listener.point(l.b.x,l.b.y);if(!v)listener.lineEnd();clean=false;}else if(v){listener.lineStart();listener.point(x,y);clean=false;}}}x_=x,y_=y,v_=v;}return clip;};function corner(p,direction){return abs(p[0]-x0)<?direction>0?0:3:abs(p[0]-x1)<?direction>0?2:1:abs(p[1]-y0)<?direction>0?1:0:direction>0?3:2;}function compare(a,b){return comparePoints(a.x,b.x);}function comparePoints(a,b){var ca=corner(a,1),cb=corner(b,1);return ca!==cb?ca-cb:ca===0?b[1]-a[1]:ca===1?a[0]-b[0]:ca===2?a[1]-b[1]:b[0]-a[0];}}function d3_geo_conic(projectAt){var 0=0,1=/3,m=d3_geo_projectionMutator(projectAt),p=m(0,1);p.parallels=function(_){if(!arguments.length)return[0/*180,1/*180];return m(0=_[0]*/180,1=_[1]*/180);};return p;}function d3_geo_conicEqualArea(0,1){var sin0=Math.sin(0),n=(sin0+Math.sin(1))/2,C=1+sin0*(2*n-sin0),0=Math.sqrt(C)/n;function forward(,){var =Math.sqrt(C-2*n*Math.sin())/n;return[*Math.sin(*=n),0-*Math.cos()];}forward.invert=function(x,y){var 0_y=0-y;return[Math.atan2(x,0_y)/n,d3_asin((C-(x*x+0_y*0_y)*n*n)/(2*n))];};return forward;}(d3.geo.conicEqualArea=function(){return d3_geo_conic(d3_geo_conicEqualArea);}).raw=d3_geo_conicEqualArea;d3.geo.albers=function(){return d3.geo.conicEqualArea().rotate([96,0]).center([-.6,38.7]).parallels([29.5,45.5]).scale(1070);};d3.geo.albersUsa=function(){var lower48=d3.geo.albers();var alaska=d3.geo.conicEqualArea().rotate([154,0]).center([-2,58.5]).parallels([55,65]);var hawaii=d3.geo.conicEqualArea().rotate([157,0]).center([-3,19.9]).parallels([8,18]);var _point,pointStream={point:function point(x,y){_point=[x,y];}},lower48Point,alaskaPoint,hawaiiPoint;function albersUsa(coordinates){var x=coordinates[0],y=coordinates[1];_point=null;(lower48Point(x,y),_point)||(alaskaPoint(x,y),_point)||hawaiiPoint(x,y);return _point;}albersUsa.invert=function(coordinates){var k=lower48.scale(),t=lower48.translate(),x=(coordinates[0]-t[0])/k,y=(coordinates[1]-t[1])/k;return(y>=.12&&y<.234&&x>=-.425&&x<-.214?alaska:y>=.166&&y<.234&&x>=-.214&&x<-.115?hawaii:lower48).invert(coordinates);};albersUsa.stream=function(stream){var lower48Stream=lower48.stream(stream),alaskaStream=alaska.stream(stream),hawaiiStream=hawaii.stream(stream);return{point:function point(x,y){lower48Stream.point(x,y);alaskaStream.point(x,y);hawaiiStream.point(x,y);},sphere:function sphere(){lower48Stream.sphere();alaskaStream.sphere();hawaiiStream.sphere();},lineStart:function lineStart(){lower48Stream.lineStart();alaskaStream.lineStart();hawaiiStream.lineStart();},lineEnd:function lineEnd(){lower48Stream.lineEnd();alaskaStream.lineEnd();hawaiiStream.lineEnd();},polygonStart:function polygonStart(){lower48Stream.polygonStart();alaskaStream.polygonStart();hawaiiStream.polygonStart();},polygonEnd:function polygonEnd(){lower48Stream.polygonEnd();alaskaStream.polygonEnd();hawaiiStream.polygonEnd();}};};albersUsa.precision=function(_){if(!arguments.length)return lower48.precision();lower48.precision(_);alaska.precision(_);hawaii.precision(_);return albersUsa;};albersUsa.scale=function(_){if(!arguments.length)return lower48.scale();lower48.scale(_);alaska.scale(_*.35);hawaii.scale(_);return albersUsa.translate(lower48.translate());};albersUsa.translate=function(_){if(!arguments.length)return lower48.translate();var k=lower48.scale(),x=+_[0],y=+_[1];lower48Point=lower48.translate(_).clipExtent([[x-.455*k,y-.238*k],[x+.455*k,y+.238*k]]).stream(pointStream).point;alaskaPoint=alaska.translate([x-.307*k,y+.201*k]).clipExtent([[x-.425*k+,y+.12*k+],[x-.214*k-,y+.234*k-]]).stream(pointStream).point;hawaiiPoint=hawaii.translate([x-.205*k,y+.212*k]).clipExtent([[x-.214*k+,y+.166*k+],[x-.115*k-,y+.234*k-]]).stream(pointStream).point;return albersUsa;};return albersUsa.scale(1070);};var d3_geo_pathAreaSum,d3_geo_pathAreaPolygon,d3_geo_pathArea={point:d3_noop,lineStart:d3_noop,lineEnd:d3_noop,polygonStart:function polygonStart(){d3_geo_pathAreaPolygon=0;d3_geo_pathArea.lineStart=d3_geo_pathAreaRingStart;},polygonEnd:function polygonEnd(){d3_geo_pathArea.lineStart=d3_geo_pathArea.lineEnd=d3_geo_pathArea.point=d3_noop;d3_geo_pathAreaSum+=abs(d3_geo_pathAreaPolygon/2);}};function d3_geo_pathAreaRingStart(){var x00,y00,x0,y0;d3_geo_pathArea.point=function(x,y){d3_geo_pathArea.point=nextPoint;x00=x0=x,y00=y0=y;};function nextPoint(x,y){d3_geo_pathAreaPolygon+=y0*x-x0*y;x0=x,y0=y;}d3_geo_pathArea.lineEnd=function(){nextPoint(x00,y00);};}var d3_geo_pathBoundsX0,d3_geo_pathBoundsY0,d3_geo_pathBoundsX1,d3_geo_pathBoundsY1;var d3_geo_pathBounds={point:d3_geo_pathBoundsPoint,lineStart:d3_noop,lineEnd:d3_noop,polygonStart:d3_noop,polygonEnd:d3_noop};function d3_geo_pathBoundsPoint(x,y){if(x<d3_geo_pathBoundsX0)d3_geo_pathBoundsX0=x;if(x>d3_geo_pathBoundsX1)d3_geo_pathBoundsX1=x;if(y<d3_geo_pathBoundsY0)d3_geo_pathBoundsY0=y;if(y>d3_geo_pathBoundsY1)d3_geo_pathBoundsY1=y;}function d3_geo_pathBuffer(){var pointCircle=d3_geo_pathBufferCircle(4.5),buffer=[];var stream={point:point,lineStart:function lineStart(){stream.point=pointLineStart;},lineEnd:lineEnd,polygonStart:function polygonStart(){stream.lineEnd=lineEndPolygon;},polygonEnd:function polygonEnd(){stream.lineEnd=lineEnd;stream.point=point;},pointRadius:function pointRadius(_){pointCircle=d3_geo_pathBufferCircle(_);return stream;},result:function result(){if(buffer.length){var result=buffer.join("");buffer=[];return result;}}};function point(x,y){buffer.push("M",x,",",y,pointCircle);}function pointLineStart(x,y){buffer.push("M",x,",",y);stream.point=pointLine;}function pointLine(x,y){buffer.push("L",x,",",y);}function lineEnd(){stream.point=point;}function lineEndPolygon(){buffer.push("Z");}return stream;}function d3_geo_pathBufferCircle(radius){return"m0,"+radius+"a"+radius+","+radius+" 0 1,1 0,"+-2*radius+"a"+radius+","+radius+" 0 1,1 0,"+2*radius+"z";}var d3_geo_pathCentroid={point:d3_geo_pathCentroidPoint,lineStart:d3_geo_pathCentroidLineStart,lineEnd:d3_geo_pathCentroidLineEnd,polygonStart:function polygonStart(){d3_geo_pathCentroid.lineStart=d3_geo_pathCentroidRingStart;},polygonEnd:function polygonEnd(){d3_geo_pathCentroid.point=d3_geo_pathCentroidPoint;d3_geo_pathCentroid.lineStart=d3_geo_pathCentroidLineStart;d3_geo_pathCentroid.lineEnd=d3_geo_pathCentroidLineEnd;}};function d3_geo_pathCentroidPoint(x,y){d3_geo_centroidX0+=x;d3_geo_centroidY0+=y;++d3_geo_centroidZ0;}function d3_geo_pathCentroidLineStart(){var x0,y0;d3_geo_pathCentroid.point=function(x,y){d3_geo_pathCentroid.point=nextPoint;d3_geo_pathCentroidPoint(x0=x,y0=y);};function nextPoint(x,y){var dx=x-x0,dy=y-y0,z=Math.sqrt(dx*dx+dy*dy);d3_geo_centroidX1+=z*(x0+x)/2;d3_geo_centroidY1+=z*(y0+y)/2;d3_geo_centroidZ1+=z;d3_geo_pathCentroidPoint(x0=x,y0=y);}}function d3_geo_pathCentroidLineEnd(){d3_geo_pathCentroid.point=d3_geo_pathCentroidPoint;}function d3_geo_pathCentroidRingStart(){var x00,y00,x0,y0;d3_geo_pathCentroid.point=function(x,y){d3_geo_pathCentroid.point=nextPoint;d3_geo_pathCentroidPoint(x00=x0=x,y00=y0=y);};function nextPoint(x,y){var dx=x-x0,dy=y-y0,z=Math.sqrt(dx*dx+dy*dy);d3_geo_centroidX1+=z*(x0+x)/2;d3_geo_centroidY1+=z*(y0+y)/2;d3_geo_centroidZ1+=z;z=y0*x-x0*y;d3_geo_centroidX2+=z*(x0+x);d3_geo_centroidY2+=z*(y0+y);d3_geo_centroidZ2+=z*3;d3_geo_pathCentroidPoint(x0=x,y0=y);}d3_geo_pathCentroid.lineEnd=function(){nextPoint(x00,y00);};}function d3_geo_pathContext(context){var _pointRadius=4.5;var stream={point:point,lineStart:function lineStart(){stream.point=pointLineStart;},lineEnd:lineEnd,polygonStart:function polygonStart(){stream.lineEnd=lineEndPolygon;},polygonEnd:function polygonEnd(){stream.lineEnd=lineEnd;stream.point=point;},pointRadius:function pointRadius(_){_pointRadius=_;return stream;},result:d3_noop};function point(x,y){context.moveTo(x+_pointRadius,y);context.arc(x,y,_pointRadius,0,);}function pointLineStart(x,y){context.moveTo(x,y);stream.point=pointLine;}function pointLine(x,y){context.lineTo(x,y);}function lineEnd(){stream.point=point;}function lineEndPolygon(){context.closePath();}return stream;}function d3_geo_resample(project){var 2=.5,cosMinDistance=Math.cos(30*d3_radians),maxDepth=16;function resample(stream){return(maxDepth?resampleRecursive:resampleNone)(stream);}function resampleNone(stream){return d3_geo_transformPoint(stream,function(x,y){x=project(x,y);stream.point(x[0],x[1]);});}function resampleRecursive(stream){var 00,00,x00,y00,a00,b00,c00,0,x0,y0,a0,b0,c0;var resample={point:point,lineStart:lineStart,lineEnd:lineEnd,polygonStart:function polygonStart(){stream.polygonStart();resample.lineStart=ringStart;},polygonEnd:function polygonEnd(){stream.polygonEnd();resample.lineStart=lineStart;}};function point(x,y){x=project(x,y);stream.point(x[0],x[1]);}function lineStart(){x0=NaN;resample.point=linePoint;stream.lineStart();}function linePoint(,){var c=d3_geo_cartesian([,]),p=project(,);resampleLineTo(x0,y0,0,a0,b0,c0,x0=p[0],y0=p[1],0=,a0=c[0],b0=c[1],c0=c[2],maxDepth,stream);stream.point(x0,y0);}function lineEnd(){resample.point=point;stream.lineEnd();}function ringStart(){lineStart();resample.point=ringPoint;resample.lineEnd=ringEnd;}function ringPoint(,){linePoint(00=,00=),x00=x0,y00=y0,a00=a0,b00=b0,c00=c0;resample.point=linePoint;}function ringEnd(){resampleLineTo(x0,y0,0,a0,b0,c0,x00,y00,00,a00,b00,c00,maxDepth,stream);resample.lineEnd=lineEnd;lineEnd();}return resample;}function resampleLineTo(x0,y0,0,a0,b0,c0,x1,y1,1,a1,b1,c1,depth,stream){var dx=x1-x0,dy=y1-y0,d2=dx*dx+dy*dy;if(d2>4*2&&depth--){var a=a0+a1,b=b0+b1,c=c0+c1,m=Math.sqrt(a*a+b*b+c*c),2=Math.asin(c/=m),2=abs(abs(c)-1)<||abs(0-1)<?(0+1)/2:Math.atan2(b,a),p=project(2,2),x2=p[0],y2=p[1],dx2=x2-x0,dy2=y2-y0,dz=dy*dx2-dx*dy2;if(dz*dz/d2>2||abs((dx*dx2+dy*dy2)/d2-.5)>.3||a0*a1+b0*b1+c0*c1<cosMinDistance){resampleLineTo(x0,y0,0,a0,b0,c0,x2,y2,2,a/=m,b/=m,c,depth,stream);stream.point(x2,y2);resampleLineTo(x2,y2,2,a,b,c,x1,y1,1,a1,b1,c1,depth,stream);}}}resample.precision=function(_){if(!arguments.length)return Math.sqrt(2);maxDepth=(2=_*_)>0&&16;return resample;};return resample;}d3.geo.path=function(){var pointRadius=4.5,projection,context,projectStream,contextStream,cacheStream;function path(object){if(object){if(typeof pointRadius==="function")contextStream.pointRadius(+pointRadius.apply(this,arguments));if(!cacheStream||!cacheStream.valid)cacheStream=projectStream(contextStream);d3.geo.stream(object,cacheStream);}return contextStream.result();}path.area=function(object){d3_geo_pathAreaSum=0;d3.geo.stream(object,projectStream(d3_geo_pathArea));return d3_geo_pathAreaSum;};path.centroid=function(object){d3_geo_centroidX0=d3_geo_centroidY0=d3_geo_centroidZ0=d3_geo_centroidX1=d3_geo_centroidY1=d3_geo_centroidZ1=d3_geo_centroidX2=d3_geo_centroidY2=d3_geo_centroidZ2=0;d3.geo.stream(object,projectStream(d3_geo_pathCentroid));return d3_geo_centroidZ2?[d3_geo_centroidX2/d3_geo_centroidZ2,d3_geo_centroidY2/d3_geo_centroidZ2]:d3_geo_centroidZ1?[d3_geo_centroidX1/d3_geo_centroidZ1,d3_geo_centroidY1/d3_geo_centroidZ1]:d3_geo_centroidZ0?[d3_geo_centroidX0/d3_geo_centroidZ0,d3_geo_centroidY0/d3_geo_centroidZ0]:[NaN,NaN];};path.bounds=function(object){d3_geo_pathBoundsX1=d3_geo_pathBoundsY1=-(d3_geo_pathBoundsX0=d3_geo_pathBoundsY0=Infinity);d3.geo.stream(object,projectStream(d3_geo_pathBounds));return[[d3_geo_pathBoundsX0,d3_geo_pathBoundsY0],[d3_geo_pathBoundsX1,d3_geo_pathBoundsY1]];};path.projection=function(_){if(!arguments.length)return projection;projectStream=(projection=_)?_.stream||d3_geo_pathProjectStream(_):d3_identity;return reset();};path.context=function(_){if(!arguments.length)return context;contextStream=(context=_)==null?new d3_geo_pathBuffer():new d3_geo_pathContext(_);if(typeof pointRadius!=="function")contextStream.pointRadius(pointRadius);return reset();};path.pointRadius=function(_){if(!arguments.length)return pointRadius;pointRadius=typeof _==="function"?_:(contextStream.pointRadius(+_),+_);return path;};function reset(){cacheStream=null;return path;}return path.projection(d3.geo.albersUsa()).context(null);};function d3_geo_pathProjectStream(project){var resample=d3_geo_resample(function(x,y){return project([x*d3_degrees,y*d3_degrees]);});return function(stream){return d3_geo_projectionRadians(resample(stream));};}d3.geo.transform=function(methods){return{stream:function stream(_stream2){var transform=new d3_geo_transform(_stream2);for(var k in methods){transform[k]=methods[k];}return transform;}};};function d3_geo_transform(stream){this.stream=stream;}d3_geo_transform.prototype={point:function point(x,y){this.stream.point(x,y);},sphere:function sphere(){this.stream.sphere();},lineStart:function lineStart(){this.stream.lineStart();},lineEnd:function lineEnd(){this.stream.lineEnd();},polygonStart:function polygonStart(){this.stream.polygonStart();},polygonEnd:function polygonEnd(){this.stream.polygonEnd();}};function d3_geo_transformPoint(stream,point){return{point:point,sphere:function sphere(){stream.sphere();},lineStart:function lineStart(){stream.lineStart();},lineEnd:function lineEnd(){stream.lineEnd();},polygonStart:function polygonStart(){stream.polygonStart();},polygonEnd:function polygonEnd(){stream.polygonEnd();}};}d3.geo.projection=d3_geo_projection;d3.geo.projectionMutator=d3_geo_projectionMutator;function d3_geo_projection(project){return d3_geo_projectionMutator(function(){return project;})();}function d3_geo_projectionMutator(projectAt){var project,rotate,projectRotate,projectResample=d3_geo_resample(function(x,y){x=project(x,y);return[x[0]*k+x,y-x[1]*k];}),k=150,x=480,y=250,=0,=0,=0,=0,=0,x,y,preclip=d3_geo_clipAntimeridian,postclip=d3_identity,clipAngle=null,clipExtent=null,stream;function projection(point){point=projectRotate(point[0]*d3_radians,point[1]*d3_radians);return[point[0]*k+x,y-point[1]*k];}function invert(point){point=projectRotate.invert((point[0]-x)/k,(y-point[1])/k);return point&&[point[0]*d3_degrees,point[1]*d3_degrees];}projection.stream=function(output){if(stream)stream.valid=false;stream=d3_geo_projectionRadians(preclip(rotate,projectResample(postclip(output))));stream.valid=true;return stream;};projection.clipAngle=function(_){if(!arguments.length)return clipAngle;preclip=_==null?(clipAngle=_,d3_geo_clipAntimeridian):d3_geo_clipCircle((clipAngle=+_)*d3_radians);return invalidate();};projection.clipExtent=function(_){if(!arguments.length)return clipExtent;clipExtent=_;postclip=_?d3_geo_clipExtent(_[0][0],_[0][1],_[1][0],_[1][1]):d3_identity;return invalidate();};projection.scale=function(_){if(!arguments.length)return k;k=+_;return reset();};projection.translate=function(_){if(!arguments.length)return[x,y];x=+_[0];y=+_[1];return reset();};projection.center=function(_){if(!arguments.length)return[*d3_degrees,*d3_degrees];=_[0]%360*d3_radians;=_[1]%360*d3_radians;return reset();};projection.rotate=function(_){if(!arguments.length)return[*d3_degrees,*d3_degrees,*d3_degrees];=_[0]%360*d3_radians;=_[1]%360*d3_radians;=_.length>2?_[2]%360*d3_radians:0;return reset();};d3.rebind(projection,projectResample,"precision");function reset(){projectRotate=d3_geo_compose(rotate=d3_geo_rotation(,,),project);var center=project(,);x=x-center[0]*k;y=y+center[1]*k;return invalidate();}function invalidate(){if(stream)stream.valid=false,stream=null;return projection;}return function(){project=projectAt.apply(this,arguments);projection.invert=project.invert&&invert;return reset();};}function d3_geo_projectionRadians(stream){return d3_geo_transformPoint(stream,function(x,y){stream.point(x*d3_radians,y*d3_radians);});}function d3_geo_equirectangular(,){return[,];}(d3.geo.equirectangular=function(){return d3_geo_projection(d3_geo_equirectangular);}).raw=d3_geo_equirectangular.invert=d3_geo_equirectangular;d3.geo.rotation=function(rotate){rotate=d3_geo_rotation(rotate[0]%360*d3_radians,rotate[1]*d3_radians,rotate.length>2?rotate[2]*d3_radians:0);function forward(coordinates){coordinates=rotate(coordinates[0]*d3_radians,coordinates[1]*d3_radians);return coordinates[0]*=d3_degrees,coordinates[1]*=d3_degrees,coordinates;}forward.invert=function(coordinates){coordinates=rotate.invert(coordinates[0]*d3_radians,coordinates[1]*d3_radians);return coordinates[0]*=d3_degrees,coordinates[1]*=d3_degrees,coordinates;};return forward;};function d3_geo_identityRotation(,){return[>?-:<-?+:,];}d3_geo_identityRotation.invert=d3_geo_equirectangular;function d3_geo_rotation(,,){return ?||?d3_geo_compose(d3_geo_rotation(),d3_geo_rotation(,)):d3_geo_rotation():||?d3_geo_rotation(,):d3_geo_identityRotation;}function d3_geo_forwardRotation(){return function(,){return +=,[>?-:<-?+:,];};}function d3_geo_rotation(){var rotation=d3_geo_forwardRotation();rotation.invert=d3_geo_forwardRotation(-);return rotation;}function d3_geo_rotation(,){var cos=Math.cos(),sin=Math.sin(),cos=Math.cos(),sin=Math.sin();function rotation(,){var cos=Math.cos(),x=Math.cos()*cos,y=Math.sin()*cos,z=Math.sin(),k=z*cos+x*sin;return[Math.atan2(y*cos-k*sin,x*cos-z*sin),d3_asin(k*cos+y*sin)];}rotation.invert=function(,){var cos=Math.cos(),x=Math.cos()*cos,y=Math.sin()*cos,z=Math.sin(),k=z*cos-y*sin;return[Math.atan2(y*cos+z*sin,x*cos+k*sin),d3_asin(k*cos-x*sin)];};return rotation;}d3.geo.circle=function(){var origin=[0,0],angle,precision=6,interpolate;function circle(){var center=typeof origin==="function"?origin.apply(this,arguments):origin,rotate=d3_geo_rotation(-center[0]*d3_radians,-center[1]*d3_radians,0).invert,ring=[];interpolate(null,null,1,{point:function point(x,y){ring.push(x=rotate(x,y));x[0]*=d3_degrees,x[1]*=d3_degrees;}});return{type:"Polygon",coordinates:[ring]};}circle.origin=function(x){if(!arguments.length)return origin;origin=x;return circle;};circle.angle=function(x){if(!arguments.length)return angle;interpolate=d3_geo_circleInterpolate((angle=+x)*d3_radians,precision*d3_radians);return circle;};circle.precision=function(_){if(!arguments.length)return precision;interpolate=d3_geo_circleInterpolate(angle*d3_radians,(precision=+_)*d3_radians);return circle;};return circle.angle(90);};function d3_geo_circleInterpolate(radius,precision){var cr=Math.cos(radius),sr=Math.sin(radius);return function(from,to,direction,listener){var step=direction*precision;if(from!=null){from=d3_geo_circleAngle(cr,from);to=d3_geo_circleAngle(cr,to);if(direction>0?from<to:from>to)from+=direction*;}else{from=radius+direction*;to=radius-.5*step;}for(var point,t=from;direction>0?t>to:t<to;t-=step){listener.point((point=d3_geo_spherical([cr,-sr*Math.cos(t),-sr*Math.sin(t)]))[0],point[1]);}};}function d3_geo_circleAngle(cr,point){var a=d3_geo_cartesian(point);a[0]-=cr;d3_geo_cartesianNormalize(a);var angle=d3_acos(-a[1]);return((-a[2]<0?-angle:angle)+2*Math.PI-)%(2*Math.PI);}d3.geo.distance=function(a,b){var =(b[0]-a[0])*d3_radians,0=a[1]*d3_radians,1=b[1]*d3_radians,sin=Math.sin(),cos=Math.cos(),sin0=Math.sin(0),cos0=Math.cos(0),sin1=Math.sin(1),cos1=Math.cos(1),t;return Math.atan2(Math.sqrt((t=cos1*sin)*t+(t=cos0*sin1-sin0*cos1*cos)*t),sin0*sin1+cos0*cos1*cos);};d3.geo.graticule=function(){var x1,x0,X1,X0,y1,y0,Y1,Y0,dx=10,dy=dx,DX=90,DY=360,x,y,X,Y,precision=2.5;function graticule(){return{type:"MultiLineString",coordinates:lines()};}function lines(){return d3.range(Math.ceil(X0/DX)*DX,X1,DX).map(X).concat(d3.range(Math.ceil(Y0/DY)*DY,Y1,DY).map(Y)).concat(d3.range(Math.ceil(x0/dx)*dx,x1,dx).filter(function(x){return abs(x%DX)>;}).map(x)).concat(d3.range(Math.ceil(y0/dy)*dy,y1,dy).filter(function(y){return abs(y%DY)>;}).map(y));}graticule.lines=function(){return lines().map(function(coordinates){return{type:"LineString",coordinates:coordinates};});};graticule.outline=function(){return{type:"Polygon",coordinates:[X(X0).concat(Y(Y1).slice(1),X(X1).reverse().slice(1),Y(Y0).reverse().slice(1))]};};graticule.extent=function(_){if(!arguments.length)return graticule.minorExtent();return graticule.majorExtent(_).minorExtent(_);};graticule.majorExtent=function(_){if(!arguments.length)return[[X0,Y0],[X1,Y1]];X0=+_[0][0],X1=+_[1][0];Y0=+_[0][1],Y1=+_[1][1];if(X0>X1)_=X0,X0=X1,X1=_;if(Y0>Y1)_=Y0,Y0=Y1,Y1=_;return graticule.precision(precision);};graticule.minorExtent=function(_){if(!arguments.length)return[[x0,y0],[x1,y1]];x0=+_[0][0],x1=+_[1][0];y0=+_[0][1],y1=+_[1][1];if(x0>x1)_=x0,x0=x1,x1=_;if(y0>y1)_=y0,y0=y1,y1=_;return graticule.precision(precision);};graticule.step=function(_){if(!arguments.length)return graticule.minorStep();return graticule.majorStep(_).minorStep(_);};graticule.majorStep=function(_){if(!arguments.length)return[DX,DY];DX=+_[0],DY=+_[1];return graticule;};graticule.minorStep=function(_){if(!arguments.length)return[dx,dy];dx=+_[0],dy=+_[1];return graticule;};graticule.precision=function(_){if(!arguments.length)return precision;precision=+_;x=d3_geo_graticuleX(y0,y1,90);y=d3_geo_graticuleY(x0,x1,precision);X=d3_geo_graticuleX(Y0,Y1,90);Y=d3_geo_graticuleY(X0,X1,precision);return graticule;};return graticule.majorExtent([[-180,-90+],[180,90-]]).minorExtent([[-180,-80-],[180,80+]]);};function d3_geo_graticuleX(y0,y1,dy){var y=d3.range(y0,y1-,dy).concat(y1);return function(x){return y.map(function(y){return[x,y];});};}function d3_geo_graticuleY(x0,x1,dx){var x=d3.range(x0,x1-,dx).concat(x1);return function(y){return x.map(function(x){return[x,y];});};}function d3_source(d){return d.source;}function d3_target(d){return d.target;}d3.geo.greatArc=function(){var source=d3_source,source_,target=d3_target,target_;function greatArc(){return{type:"LineString",coordinates:[source_||source.apply(this,arguments),target_||target.apply(this,arguments)]};}greatArc.distance=function(){return d3.geo.distance(source_||source.apply(this,arguments),target_||target.apply(this,arguments));};greatArc.source=function(_){if(!arguments.length)return source;source=_,source_=typeof _==="function"?null:_;return greatArc;};greatArc.target=function(_){if(!arguments.length)return target;target=_,target_=typeof _==="function"?null:_;return greatArc;};greatArc.precision=function(){return arguments.length?greatArc:0;};return greatArc;};d3.geo.interpolate=function(source,target){return d3_geo_interpolate(source[0]*d3_radians,source[1]*d3_radians,target[0]*d3_radians,target[1]*d3_radians);};function d3_geo_interpolate(x0,y0,x1,y1){var cy0=Math.cos(y0),sy0=Math.sin(y0),cy1=Math.cos(y1),sy1=Math.sin(y1),kx0=cy0*Math.cos(x0),ky0=cy0*Math.sin(x0),kx1=cy1*Math.cos(x1),ky1=cy1*Math.sin(x1),d=2*Math.asin(Math.sqrt(d3_haversin(y1-y0)+cy0*cy1*d3_haversin(x1-x0))),k=1/Math.sin(d);var interpolate=d?function(t){var B=Math.sin(t*=d)*k,A=Math.sin(d-t)*k,x=A*kx0+B*kx1,y=A*ky0+B*ky1,z=A*sy0+B*sy1;return[Math.atan2(y,x)*d3_degrees,Math.atan2(z,Math.sqrt(x*x+y*y))*d3_degrees];}:function(){return[x0*d3_degrees,y0*d3_degrees];};interpolate.distance=d;return interpolate;}d3.geo.length=function(object){d3_geo_lengthSum=0;d3.geo.stream(object,d3_geo_length);return d3_geo_lengthSum;};var d3_geo_lengthSum;var d3_geo_length={sphere:d3_noop,point:d3_noop,lineStart:d3_geo_lengthLineStart,lineEnd:d3_noop,polygonStart:d3_noop,polygonEnd:d3_noop};function d3_geo_lengthLineStart(){var 0,sin0,cos0;d3_geo_length.point=function(,){0=*d3_radians,sin0=Math.sin(*=d3_radians),cos0=Math.cos();d3_geo_length.point=nextPoint;};d3_geo_length.lineEnd=function(){d3_geo_length.point=d3_geo_length.lineEnd=d3_noop;};function nextPoint(,){var sin=Math.sin(*=d3_radians),cos=Math.cos(),t=abs((*=d3_radians)-0),cos=Math.cos(t);d3_geo_lengthSum+=Math.atan2(Math.sqrt((t=cos*Math.sin(t))*t+(t=cos0*sin-sin0*cos*cos)*t),sin0*sin+cos0*cos*cos);0=,sin0=sin,cos0=cos;}}function d3_geo_azimuthal(scale,angle){function azimuthal(,){var cos=Math.cos(),cos=Math.cos(),k=scale(cos*cos);return[k*cos*Math.sin(),k*Math.sin()];}azimuthal.invert=function(x,y){var =Math.sqrt(x*x+y*y),c=angle(),sinc=Math.sin(c),cosc=Math.cos(c);return[Math.atan2(x*sinc,*cosc),Math.asin(&&y*sinc/)];};return azimuthal;}var d3_geo_azimuthalEqualArea=d3_geo_azimuthal(function(coscos){return Math.sqrt(2/(1+coscos));},function(){return 2*Math.asin(/2);});(d3.geo.azimuthalEqualArea=function(){return d3_geo_projection(d3_geo_azimuthalEqualArea);}).raw=d3_geo_azimuthalEqualArea;var d3_geo_azimuthalEquidistant=d3_geo_azimuthal(function(coscos){var c=Math.acos(coscos);return c&&c/Math.sin(c);},d3_identity);(d3.geo.azimuthalEquidistant=function(){return d3_geo_projection(d3_geo_azimuthalEquidistant);}).raw=d3_geo_azimuthalEquidistant;function d3_geo_conicConformal(0,1){var cos0=Math.cos(0),t=function t(){return Math.tan(/4+/2);},n=0===1?Math.sin(0):Math.log(cos0/Math.cos(1))/Math.log(t(1)/t(0)),F=cos0*Math.pow(t(0),n)/n;if(!n)return d3_geo_mercator;function forward(,){if(F>0){if(<-half+)=-half+;}else{if(>half-)=half-;}var =F/Math.pow(t(),n);return[*Math.sin(n*),F-*Math.cos(n*)];}forward.invert=function(x,y){var 0_y=F-y,=d3_sgn(n)*Math.sqrt(x*x+0_y*0_y);return[Math.atan2(x,0_y)/n,2*Math.atan(Math.pow(F/,1/n))-half];};return forward;}(d3.geo.conicConformal=function(){return d3_geo_conic(d3_geo_conicConformal);}).raw=d3_geo_conicConformal;function d3_geo_conicEquidistant(0,1){var cos0=Math.cos(0),n=0===1?Math.sin(0):(cos0-Math.cos(1))/(1-0),G=cos0/n+0;if(abs(n)<)return d3_geo_equirectangular;function forward(,){var =G-;return[*Math.sin(n*),G-*Math.cos(n*)];}forward.invert=function(x,y){var 0_y=G-y;return[Math.atan2(x,0_y)/n,G-d3_sgn(n)*Math.sqrt(x*x+0_y*0_y)];};return forward;}(d3.geo.conicEquidistant=function(){return d3_geo_conic(d3_geo_conicEquidistant);}).raw=d3_geo_conicEquidistant;var d3_geo_gnomonic=d3_geo_azimuthal(function(coscos){return 1/coscos;},Math.atan);(d3.geo.gnomonic=function(){return d3_geo_projection(d3_geo_gnomonic);}).raw=d3_geo_gnomonic;function d3_geo_mercator(,){return[,Math.log(Math.tan(/4+/2))];}d3_geo_mercator.invert=function(x,y){return[x,2*Math.atan(Math.exp(y))-half];};function d3_geo_mercatorProjection(project){var m=d3_geo_projection(project),scale=m.scale,translate=m.translate,clipExtent=m.clipExtent,clipAuto;m.scale=function(){var v=scale.apply(m,arguments);return v===m?clipAuto?m.clipExtent(null):m:v;};m.translate=function(){var v=translate.apply(m,arguments);return v===m?clipAuto?m.clipExtent(null):m:v;};m.clipExtent=function(_){var v=clipExtent.apply(m,arguments);if(v===m){if(clipAuto=_==null){var k=*scale(),t=translate();clipExtent([[t[0]-k,t[1]-k],[t[0]+k,t[1]+k]]);}}else if(clipAuto){v=null;}return v;};return m.clipExtent(null);}(d3.geo.mercator=function(){return d3_geo_mercatorProjection(d3_geo_mercator);}).raw=d3_geo_mercator;var d3_geo_orthographic=d3_geo_azimuthal(function(){return 1;},Math.asin);(d3.geo.orthographic=function(){return d3_geo_projection(d3_geo_orthographic);}).raw=d3_geo_orthographic;var d3_geo_stereographic=d3_geo_azimuthal(function(coscos){return 1/(1+coscos);},function(){return 2*Math.atan();});(d3.geo.stereographic=function(){return d3_geo_projection(d3_geo_stereographic);}).raw=d3_geo_stereographic;function d3_geo_transverseMercator(,){return[Math.log(Math.tan(/4+/2)),-];}d3_geo_transverseMercator.invert=function(x,y){return[-y,2*Math.atan(Math.exp(x))-half];};(d3.geo.transverseMercator=function(){var projection=d3_geo_mercatorProjection(d3_geo_transverseMercator),center=projection.center,rotate=projection.rotate;projection.center=function(_){return _?center([-_[1],_[0]]):(_=center(),[_[1],-_[0]]);};projection.rotate=function(_){return _?rotate([_[0],_[1],_.length>2?_[2]+90:90]):(_=rotate(),[_[0],_[1],_[2]-90]);};return rotate([0,0,90]);}).raw=d3_geo_transverseMercator;d3.geom={};function d3_geom_pointX(d){return d[0];}function d3_geom_pointY(d){return d[1];}d3.geom.hull=function(vertices){var x=d3_geom_pointX,y=d3_geom_pointY;if(arguments.length)return hull(vertices);function hull(data){if(data.length<3)return[];var fx=d3_functor(x),fy=d3_functor(y),i,n=data.length,points=[],flippedPoints=[];for(i=0;i<n;i++){points.push([+fx.call(this,data[i],i),+fy.call(this,data[i],i),i]);}points.sort(d3_geom_hullOrder);for(i=0;i<n;i++){flippedPoints.push([points[i][0],-points[i][1]]);}var upper=d3_geom_hullUpper(points),lower=d3_geom_hullUpper(flippedPoints);var skipLeft=lower[0]===upper[0],skipRight=lower[lower.length-1]===upper[upper.length-1],polygon=[];for(i=upper.length-1;i>=0;--i){polygon.push(data[points[upper[i]][2]]);}for(i=+skipLeft;i<lower.length-skipRight;++i){polygon.push(data[points[lower[i]][2]]);}return polygon;}hull.x=function(_){return arguments.length?(x=_,hull):x;};hull.y=function(_){return arguments.length?(y=_,hull):y;};return hull;};function d3_geom_hullUpper(points){var n=points.length,hull=[0,1],hs=2;for(var i=2;i<n;i++){while(hs>1&&d3_cross2d(points[hull[hs-2]],points[hull[hs-1]],points[i])<=0){--hs;}hull[hs++]=i;}return hull.slice(0,hs);}function d3_geom_hullOrder(a,b){return a[0]-b[0]||a[1]-b[1];}d3.geom.polygon=function(coordinates){d3_subclass(coordinates,d3_geom_polygonPrototype);return coordinates;};var d3_geom_polygonPrototype=d3.geom.polygon.prototype=[];d3_geom_polygonPrototype.area=function(){var i=-1,n=this.length,a,b=this[n-1],area=0;while(++i<n){a=b;b=this[i];area+=a[1]*b[0]-a[0]*b[1];}return area*.5;};d3_geom_polygonPrototype.centroid=function(k){var i=-1,n=this.length,x=0,y=0,a,b=this[n-1],c;if(!arguments.length)k=-1/(6*this.area());while(++i<n){a=b;b=this[i];c=a[0]*b[1]-b[0]*a[1];x+=(a[0]+b[0])*c;y+=(a[1]+b[1])*c;}return[x*k,y*k];};d3_geom_polygonPrototype.clip=function(subject){var input,closed=d3_geom_polygonClosed(subject),i=-1,n=this.length-d3_geom_polygonClosed(this),j,m,a=this[n-1],b,c,d;while(++i<n){input=subject.slice();subject.length=0;b=this[i];c=input[(m=input.length-closed)-1];j=-1;while(++j<m){d=input[j];if(d3_geom_polygonInside(d,a,b)){if(!d3_geom_polygonInside(c,a,b)){subject.push(d3_geom_polygonIntersect(c,d,a,b));}subject.push(d);}else if(d3_geom_polygonInside(c,a,b)){subject.push(d3_geom_polygonIntersect(c,d,a,b));}c=d;}if(closed)subject.push(subject[0]);a=b;}return subject;};function d3_geom_polygonInside(p,a,b){return(b[0]-a[0])*(p[1]-a[1])<(b[1]-a[1])*(p[0]-a[0]);}function d3_geom_polygonIntersect(c,d,a,b){var x1=c[0],x3=a[0],x21=d[0]-x1,x43=b[0]-x3,y1=c[1],y3=a[1],y21=d[1]-y1,y43=b[1]-y3,ua=(x43*(y1-y3)-y43*(x1-x3))/(y43*x21-x43*y21);return[x1+ua*x21,y1+ua*y21];}function d3_geom_polygonClosed(coordinates){var a=coordinates[0],b=coordinates[coordinates.length-1];return!(a[0]-b[0]||a[1]-b[1]);}var d3_geom_voronoiEdges,d3_geom_voronoiCells,d3_geom_voronoiBeaches,d3_geom_voronoiBeachPool=[],d3_geom_voronoiFirstCircle,d3_geom_voronoiCircles,d3_geom_voronoiCirclePool=[];function d3_geom_voronoiBeach(){d3_geom_voronoiRedBlackNode(this);this.edge=this.site=this.circle=null;}function d3_geom_voronoiCreateBeach(site){var beach=d3_geom_voronoiBeachPool.pop()||new d3_geom_voronoiBeach();beach.site=site;return beach;}function d3_geom_voronoiDetachBeach(beach){d3_geom_voronoiDetachCircle(beach);d3_geom_voronoiBeaches.remove(beach);d3_geom_voronoiBeachPool.push(beach);d3_geom_voronoiRedBlackNode(beach);}function d3_geom_voronoiRemoveBeach(beach){var circle=beach.circle,x=circle.x,y=circle.cy,vertex={x:x,y:y},previous=beach.P,next=beach.N,disappearing=[beach];d3_geom_voronoiDetachBeach(beach);var lArc=previous;while(lArc.circle&&abs(x-lArc.circle.x)<&&abs(y-lArc.circle.cy)<){previous=lArc.P;disappearing.unshift(lArc);d3_geom_voronoiDetachBeach(lArc);lArc=previous;}disappearing.unshift(lArc);d3_geom_voronoiDetachCircle(lArc);var rArc=next;while(rArc.circle&&abs(x-rArc.circle.x)<&&abs(y-rArc.circle.cy)<){next=rArc.N;disappearing.push(rArc);d3_geom_voronoiDetachBeach(rArc);rArc=next;}disappearing.push(rArc);d3_geom_voronoiDetachCircle(rArc);var nArcs=disappearing.length,iArc;for(iArc=1;iArc<nArcs;++iArc){rArc=disappearing[iArc];lArc=disappearing[iArc-1];d3_geom_voronoiSetEdgeEnd(rArc.edge,lArc.site,rArc.site,vertex);}lArc=disappearing[0];rArc=disappearing[nArcs-1];rArc.edge=d3_geom_voronoiCreateEdge(lArc.site,rArc.site,null,vertex);d3_geom_voronoiAttachCircle(lArc);d3_geom_voronoiAttachCircle(rArc);}function d3_geom_voronoiAddBeach(site){var x=site.x,directrix=site.y,lArc,rArc,dxl,dxr,node=d3_geom_voronoiBeaches._;while(node){dxl=d3_geom_voronoiLeftBreakPoint(node,directrix)-x;if(dxl>)node=node.L;else{dxr=x-d3_geom_voronoiRightBreakPoint(node,directrix);if(dxr>){if(!node.R){lArc=node;break;}node=node.R;}else{if(dxl>-){lArc=node.P;rArc=node;}else if(dxr>-){lArc=node;rArc=node.N;}else{lArc=rArc=node;}break;}}}var newArc=d3_geom_voronoiCreateBeach(site);d3_geom_voronoiBeaches.insert(lArc,newArc);if(!lArc&&!rArc)return;if(lArc===rArc){d3_geom_voronoiDetachCircle(lArc);rArc=d3_geom_voronoiCreateBeach(lArc.site);d3_geom_voronoiBeaches.insert(newArc,rArc);newArc.edge=rArc.edge=d3_geom_voronoiCreateEdge(lArc.site,newArc.site);d3_geom_voronoiAttachCircle(lArc);d3_geom_voronoiAttachCircle(rArc);return;}if(!rArc){newArc.edge=d3_geom_voronoiCreateEdge(lArc.site,newArc.site);return;}d3_geom_voronoiDetachCircle(lArc);d3_geom_voronoiDetachCircle(rArc);var lSite=lArc.site,ax=lSite.x,ay=lSite.y,bx=site.x-ax,by=site.y-ay,rSite=rArc.site,cx=rSite.x-ax,cy=rSite.y-ay,d=2*(bx*cy-by*cx),hb=bx*bx+by*by,hc=cx*cx+cy*cy,vertex={x:(cy*hb-by*hc)/d+ax,y:(bx*hc-cx*hb)/d+ay};d3_geom_voronoiSetEdgeEnd(rArc.edge,lSite,rSite,vertex);newArc.edge=d3_geom_voronoiCreateEdge(lSite,site,null,vertex);rArc.edge=d3_geom_voronoiCreateEdge(site,rSite,null,vertex);d3_geom_voronoiAttachCircle(lArc);d3_geom_voronoiAttachCircle(rArc);}function d3_geom_voronoiLeftBreakPoint(arc,directrix){var site=arc.site,rfocx=site.x,rfocy=site.y,pby2=rfocy-directrix;if(!pby2)return rfocx;var lArc=arc.P;if(!lArc)return-Infinity;site=lArc.site;var lfocx=site.x,lfocy=site.y,plby2=lfocy-directrix;if(!plby2)return lfocx;var hl=lfocx-rfocx,aby2=1/pby2-1/plby2,b=hl/plby2;if(aby2)return(-b+Math.sqrt(b*b-2*aby2*(hl*hl/(-2*plby2)-lfocy+plby2/2+rfocy-pby2/2)))/aby2+rfocx;return(rfocx+lfocx)/2;}function d3_geom_voronoiRightBreakPoint(arc,directrix){var rArc=arc.N;if(rArc)return d3_geom_voronoiLeftBreakPoint(rArc,directrix);var site=arc.site;return site.y===directrix?site.x:Infinity;}function d3_geom_voronoiCell(site){this.site=site;this.edges=[];}d3_geom_voronoiCell.prototype.prepare=function(){var halfEdges=this.edges,iHalfEdge=halfEdges.length,edge;while(iHalfEdge--){edge=halfEdges[iHalfEdge].edge;if(!edge.b||!edge.a)halfEdges.splice(iHalfEdge,1);}halfEdges.sort(d3_geom_voronoiHalfEdgeOrder);return halfEdges.length;};function d3_geom_voronoiCloseCells(extent){var x0=extent[0][0],x1=extent[1][0],y0=extent[0][1],y1=extent[1][1],x2,y2,x3,y3,cells=d3_geom_voronoiCells,iCell=cells.length,cell,iHalfEdge,halfEdges,nHalfEdges,start,end;while(iCell--){cell=cells[iCell];if(!cell||!cell.prepare())continue;halfEdges=cell.edges;nHalfEdges=halfEdges.length;iHalfEdge=0;while(iHalfEdge<nHalfEdges){end=halfEdges[iHalfEdge].end(),x3=end.x,y3=end.y;start=halfEdges[++iHalfEdge%nHalfEdges].start(),x2=start.x,y2=start.y;if(abs(x3-x2)>||abs(y3-y2)>){halfEdges.splice(iHalfEdge,0,new d3_geom_voronoiHalfEdge(d3_geom_voronoiCreateBorderEdge(cell.site,end,abs(x3-x0)<&&y1-y3>?{x:x0,y:abs(x2-x0)<?y2:y1}:abs(y3-y1)<&&x1-x3>?{x:abs(y2-y1)<?x2:x1,y:y1}:abs(x3-x1)<&&y3-y0>?{x:x1,y:abs(x2-x1)<?y2:y0}:abs(y3-y0)<&&x3-x0>?{x:abs(y2-y0)<?x2:x0,y:y0}:null),cell.site,null));++nHalfEdges;}}}}function d3_geom_voronoiHalfEdgeOrder(a,b){return b.angle-a.angle;}function d3_geom_voronoiCircle(){d3_geom_voronoiRedBlackNode(this);this.x=this.y=this.arc=this.site=this.cy=null;}function d3_geom_voronoiAttachCircle(arc){var lArc=arc.P,rArc=arc.N;if(!lArc||!rArc)return;var lSite=lArc.site,cSite=arc.site,rSite=rArc.site;if(lSite===rSite)return;var bx=cSite.x,by=cSite.y,ax=lSite.x-bx,ay=lSite.y-by,cx=rSite.x-bx,cy=rSite.y-by;var d=2*(ax*cy-ay*cx);if(d>=-2)return;var ha=ax*ax+ay*ay,hc=cx*cx+cy*cy,x=(cy*ha-ay*hc)/d,y=(ax*hc-cx*ha)/d,cy=y+by;var circle=d3_geom_voronoiCirclePool.pop()||new d3_geom_voronoiCircle();circle.arc=arc;circle.site=cSite;circle.x=x+bx;circle.y=cy+Math.sqrt(x*x+y*y);circle.cy=cy;arc.circle=circle;var before=null,node=d3_geom_voronoiCircles._;while(node){if(circle.y<node.y||circle.y===node.y&&circle.x<=node.x){if(node.L)node=node.L;else{before=node.P;break;}}else{if(node.R)node=node.R;else{before=node;break;}}}d3_geom_voronoiCircles.insert(before,circle);if(!before)d3_geom_voronoiFirstCircle=circle;}function d3_geom_voronoiDetachCircle(arc){var circle=arc.circle;if(circle){if(!circle.P)d3_geom_voronoiFirstCircle=circle.N;d3_geom_voronoiCircles.remove(circle);d3_geom_voronoiCirclePool.push(circle);d3_geom_voronoiRedBlackNode(circle);arc.circle=null;}}function d3_geom_voronoiClipEdges(extent){var edges=d3_geom_voronoiEdges,clip=d3_geom_clipLine(extent[0][0],extent[0][1],extent[1][0],extent[1][1]),i=edges.length,e;while(i--){e=edges[i];if(!d3_geom_voronoiConnectEdge(e,extent)||!clip(e)||abs(e.a.x-e.b.x)<&&abs(e.a.y-e.b.y)<){e.a=e.b=null;edges.splice(i,1);}}}function d3_geom_voronoiConnectEdge(edge,extent){var vb=edge.b;if(vb)return true;var va=edge.a,x0=extent[0][0],x1=extent[1][0],y0=extent[0][1],y1=extent[1][1],lSite=edge.l,rSite=edge.r,lx=lSite.x,ly=lSite.y,rx=rSite.x,ry=rSite.y,fx=(lx+rx)/2,fy=(ly+ry)/2,fm,fb;if(ry===ly){if(fx<x0||fx>=x1)return;if(lx>rx){if(!va)va={x:fx,y:y0};else if(va.y>=y1)return;vb={x:fx,y:y1};}else{if(!va)va={x:fx,y:y1};else if(va.y<y0)return;vb={x:fx,y:y0};}}else{fm=(lx-rx)/(ry-ly);fb=fy-fm*fx;if(fm<-1||fm>1){if(lx>rx){if(!va)va={x:(y0-fb)/fm,y:y0};else if(va.y>=y1)return;vb={x:(y1-fb)/fm,y:y1};}else{if(!va)va={x:(y1-fb)/fm,y:y1};else if(va.y<y0)return;vb={x:(y0-fb)/fm,y:y0};}}else{if(ly<ry){if(!va)va={x:x0,y:fm*x0+fb};else if(va.x>=x1)return;vb={x:x1,y:fm*x1+fb};}else{if(!va)va={x:x1,y:fm*x1+fb};else if(va.x<x0)return;vb={x:x0,y:fm*x0+fb};}}}edge.a=va;edge.b=vb;return true;}function d3_geom_voronoiEdge(lSite,rSite){this.l=lSite;this.r=rSite;this.a=this.b=null;}function d3_geom_voronoiCreateEdge(lSite,rSite,va,vb){var edge=new d3_geom_voronoiEdge(lSite,rSite);d3_geom_voronoiEdges.push(edge);if(va)d3_geom_voronoiSetEdgeEnd(edge,lSite,rSite,va);if(vb)d3_geom_voronoiSetEdgeEnd(edge,rSite,lSite,vb);d3_geom_voronoiCells[lSite.i].edges.push(new d3_geom_voronoiHalfEdge(edge,lSite,rSite));d3_geom_voronoiCells[rSite.i].edges.push(new d3_geom_voronoiHalfEdge(edge,rSite,lSite));return edge;}function d3_geom_voronoiCreateBorderEdge(lSite,va,vb){var edge=new d3_geom_voronoiEdge(lSite,null);edge.a=va;edge.b=vb;d3_geom_voronoiEdges.push(edge);return edge;}function d3_geom_voronoiSetEdgeEnd(edge,lSite,rSite,vertex){if(!edge.a&&!edge.b){edge.a=vertex;edge.l=lSite;edge.r=rSite;}else if(edge.l===rSite){edge.b=vertex;}else{edge.a=vertex;}}function d3_geom_voronoiHalfEdge(edge,lSite,rSite){var va=edge.a,vb=edge.b;this.edge=edge;this.site=lSite;this.angle=rSite?Math.atan2(rSite.y-lSite.y,rSite.x-lSite.x):edge.l===lSite?Math.atan2(vb.x-va.x,va.y-vb.y):Math.atan2(va.x-vb.x,vb.y-va.y);}d3_geom_voronoiHalfEdge.prototype={start:function start(){return this.edge.l===this.site?this.edge.a:this.edge.b;},end:function end(){return this.edge.l===this.site?this.edge.b:this.edge.a;}};function d3_geom_voronoiRedBlackTree(){this._=null;}function d3_geom_voronoiRedBlackNode(node){node.U=node.C=node.L=node.R=node.P=node.N=null;}d3_geom_voronoiRedBlackTree.prototype={insert:function insert(after,node){var parent,grandpa,uncle;if(after){node.P=after;node.N=after.N;if(after.N)after.N.P=node;after.N=node;if(after.R){after=after.R;while(after.L){after=after.L;}after.L=node;}else{after.R=node;}parent=after;}else if(this._){after=d3_geom_voronoiRedBlackFirst(this._);node.P=null;node.N=after;after.P=after.L=node;parent=after;}else{node.P=node.N=null;this._=node;parent=null;}node.L=node.R=null;node.U=parent;node.C=true;after=node;while(parent&&parent.C){grandpa=parent.U;if(parent===grandpa.L){uncle=grandpa.R;if(uncle&&uncle.C){parent.C=uncle.C=false;grandpa.C=true;after=grandpa;}else{if(after===parent.R){d3_geom_voronoiRedBlackRotateLeft(this,parent);after=parent;parent=after.U;}parent.C=false;grandpa.C=true;d3_geom_voronoiRedBlackRotateRight(this,grandpa);}}else{uncle=grandpa.L;if(uncle&&uncle.C){parent.C=uncle.C=false;grandpa.C=true;after=grandpa;}else{if(after===parent.L){d3_geom_voronoiRedBlackRotateRight(this,parent);after=parent;parent=after.U;}parent.C=false;grandpa.C=true;d3_geom_voronoiRedBlackRotateLeft(this,grandpa);}}parent=after.U;}this._.C=false;},remove:function remove(node){if(node.N)node.N.P=node.P;if(node.P)node.P.N=node.N;node.N=node.P=null;var parent=node.U,sibling,left=node.L,right=node.R,next,red;if(!left)next=right;else if(!right)next=left;else next=d3_geom_voronoiRedBlackFirst(right);if(parent){if(parent.L===node)parent.L=next;else parent.R=next;}else{this._=next;}if(left&&right){red=next.C;next.C=node.C;next.L=left;left.U=next;if(next!==right){parent=next.U;next.U=node.U;node=next.R;parent.L=node;next.R=right;right.U=next;}else{next.U=parent;parent=next;node=next.R;}}else{red=node.C;node=next;}if(node)node.U=parent;if(red)return;if(node&&node.C){node.C=false;return;}do{if(node===this._)break;if(node===parent.L){sibling=parent.R;if(sibling.C){sibling.C=false;parent.C=true;d3_geom_voronoiRedBlackRotateLeft(this,parent);sibling=parent.R;}if(sibling.L&&sibling.L.C||sibling.R&&sibling.R.C){if(!sibling.R||!sibling.R.C){sibling.L.C=false;sibling.C=true;d3_geom_voronoiRedBlackRotateRight(this,sibling);sibling=parent.R;}sibling.C=parent.C;parent.C=sibling.R.C=false;d3_geom_voronoiRedBlackRotateLeft(this,parent);node=this._;break;}}else{sibling=parent.L;if(sibling.C){sibling.C=false;parent.C=true;d3_geom_voronoiRedBlackRotateRight(this,parent);sibling=parent.L;}if(sibling.L&&sibling.L.C||sibling.R&&sibling.R.C){if(!sibling.L||!sibling.L.C){sibling.R.C=false;sibling.C=true;d3_geom_voronoiRedBlackRotateLeft(this,sibling);sibling=parent.L;}sibling.C=parent.C;parent.C=sibling.L.C=false;d3_geom_voronoiRedBlackRotateRight(this,parent);node=this._;break;}}sibling.C=true;node=parent;parent=parent.U;}while(!node.C);if(node)node.C=false;}};function d3_geom_voronoiRedBlackRotateLeft(tree,node){var p=node,q=node.R,parent=p.U;if(parent){if(parent.L===p)parent.L=q;else parent.R=q;}else{tree._=q;}q.U=parent;p.U=q;p.R=q.L;if(p.R)p.R.U=p;q.L=p;}function d3_geom_voronoiRedBlackRotateRight(tree,node){var p=node,q=node.L,parent=p.U;if(parent){if(parent.L===p)parent.L=q;else parent.R=q;}else{tree._=q;}q.U=parent;p.U=q;p.L=q.R;if(p.L)p.L.U=p;q.R=p;}function d3_geom_voronoiRedBlackFirst(node){while(node.L){node=node.L;}return node;}function d3_geom_voronoi(sites,bbox){var site=sites.sort(d3_geom_voronoiVertexOrder).pop(),x0,y0,circle;d3_geom_voronoiEdges=[];d3_geom_voronoiCells=new Array(sites.length);d3_geom_voronoiBeaches=new d3_geom_voronoiRedBlackTree();d3_geom_voronoiCircles=new d3_geom_voronoiRedBlackTree();while(true){circle=d3_geom_voronoiFirstCircle;if(site&&(!circle||site.y<circle.y||site.y===circle.y&&site.x<circle.x)){if(site.x!==x0||site.y!==y0){d3_geom_voronoiCells[site.i]=new d3_geom_voronoiCell(site);d3_geom_voronoiAddBeach(site);x0=site.x,y0=site.y;}site=sites.pop();}else if(circle){d3_geom_voronoiRemoveBeach(circle.arc);}else{break;}}if(bbox)d3_geom_voronoiClipEdges(bbox),d3_geom_voronoiCloseCells(bbox);var diagram={cells:d3_geom_voronoiCells,edges:d3_geom_voronoiEdges};d3_geom_voronoiBeaches=d3_geom_voronoiCircles=d3_geom_voronoiEdges=d3_geom_voronoiCells=null;return diagram;}function d3_geom_voronoiVertexOrder(a,b){return b.y-a.y||b.x-a.x;}d3.geom.voronoi=function(points){var x=d3_geom_pointX,y=d3_geom_pointY,fx=x,fy=y,clipExtent=d3_geom_voronoiClipExtent;if(points)return voronoi(points);function voronoi(data){var polygons=new Array(data.length),x0=clipExtent[0][0],y0=clipExtent[0][1],x1=clipExtent[1][0],y1=clipExtent[1][1];d3_geom_voronoi(sites(data),clipExtent).cells.forEach(function(cell,i){var edges=cell.edges,site=cell.site,polygon=polygons[i]=edges.length?edges.map(function(e){var s=e.start();return[s.x,s.y];}):site.x>=x0&&site.x<=x1&&site.y>=y0&&site.y<=y1?[[x0,y1],[x1,y1],[x1,y0],[x0,y0]]:[];polygon.point=data[i];});return polygons;}function sites(data){return data.map(function(d,i){return{x:Math.round(fx(d,i)/)*,y:Math.round(fy(d,i)/)*,i:i};});}voronoi.links=function(data){return d3_geom_voronoi(sites(data)).edges.filter(function(edge){return edge.l&&edge.r;}).map(function(edge){return{source:data[edge.l.i],target:data[edge.r.i]};});};voronoi.triangles=function(data){var triangles=[];d3_geom_voronoi(sites(data)).cells.forEach(function(cell,i){var site=cell.site,edges=cell.edges.sort(d3_geom_voronoiHalfEdgeOrder),j=-1,m=edges.length,e0,s0,e1=edges[m-1].edge,s1=e1.l===site?e1.r:e1.l;while(++j<m){e0=e1;s0=s1;e1=edges[j].edge;s1=e1.l===site?e1.r:e1.l;if(i<s0.i&&i<s1.i&&d3_geom_voronoiTriangleArea(site,s0,s1)<0){triangles.push([data[i],data[s0.i],data[s1.i]]);}}});return triangles;};voronoi.x=function(_){return arguments.length?(fx=d3_functor(x=_),voronoi):x;};voronoi.y=function(_){return arguments.length?(fy=d3_functor(y=_),voronoi):y;};voronoi.clipExtent=function(_){if(!arguments.length)return clipExtent===d3_geom_voronoiClipExtent?null:clipExtent;clipExtent=_==null?d3_geom_voronoiClipExtent:_;return voronoi;};voronoi.size=function(_){if(!arguments.length)return clipExtent===d3_geom_voronoiClipExtent?null:clipExtent&&clipExtent[1];return voronoi.clipExtent(_&&[[0,0],_]);};return voronoi;};var d3_geom_voronoiClipExtent=[[-1e6,-1e6],[1e6,1e6]];function d3_geom_voronoiTriangleArea(a,b,c){return(a.x-c.x)*(b.y-a.y)-(a.x-b.x)*(c.y-a.y);}d3.geom.delaunay=function(vertices){return d3.geom.voronoi().triangles(vertices);};d3.geom.quadtree=function(points,x1,y1,x2,y2){var x=d3_geom_pointX,y=d3_geom_pointY,compat;if(compat=arguments.length){x=d3_geom_quadtreeCompatX;y=d3_geom_quadtreeCompatY;if(compat===3){y2=y1;x2=x1;y1=x1=0;}return quadtree(points);}function quadtree(data){var d,fx=d3_functor(x),fy=d3_functor(y),xs,ys,i,n,x1_,y1_,x2_,y2_;if(x1!=null){x1_=x1,y1_=y1,x2_=x2,y2_=y2;}else{x2_=y2_=-(x1_=y1_=Infinity);xs=[],ys=[];n=data.length;if(compat)for(i=0;i<n;++i){d=data[i];if(d.x<x1_)x1_=d.x;if(d.y<y1_)y1_=d.y;if(d.x>x2_)x2_=d.x;if(d.y>y2_)y2_=d.y;xs.push(d.x);ys.push(d.y);}else for(i=0;i<n;++i){var x_=+fx(d=data[i],i),y_=+fy(d,i);if(x_<x1_)x1_=x_;if(y_<y1_)y1_=y_;if(x_>x2_)x2_=x_;if(y_>y2_)y2_=y_;xs.push(x_);ys.push(y_);}}var dx=x2_-x1_,dy=y2_-y1_;if(dx>dy)y2_=y1_+dx;else x2_=x1_+dy;function insert(n,d,x,y,x1,y1,x2,y2){if(isNaN(x)||isNaN(y))return;if(n.leaf){var nx=n.x,ny=n.y;if(nx!=null){if(abs(nx-x)+abs(ny-y)<.01){insertChild(n,d,x,y,x1,y1,x2,y2);}else{var nPoint=n.point;n.x=n.y=n.point=null;insertChild(n,nPoint,nx,ny,x1,y1,x2,y2);insertChild(n,d,x,y,x1,y1,x2,y2);}}else{n.x=x,n.y=y,n.point=d;}}else{insertChild(n,d,x,y,x1,y1,x2,y2);}}function insertChild(n,d,x,y,x1,y1,x2,y2){var xm=(x1+x2)*.5,ym=(y1+y2)*.5,right=x>=xm,below=y>=ym,i=below<<1|right;n.leaf=false;n=n.nodes[i]||(n.nodes[i]=d3_geom_quadtreeNode());if(right)x1=xm;else x2=xm;if(below)y1=ym;else y2=ym;insert(n,d,x,y,x1,y1,x2,y2);}var root=d3_geom_quadtreeNode();root.add=function(d){insert(root,d,+fx(d,++i),+fy(d,i),x1_,y1_,x2_,y2_);};root.visit=function(f){d3_geom_quadtreeVisit(f,root,x1_,y1_,x2_,y2_);};root.find=function(point){return d3_geom_quadtreeFind(root,point[0],point[1],x1_,y1_,x2_,y2_);};i=-1;if(x1==null){while(++i<n){insert(root,data[i],xs[i],ys[i],x1_,y1_,x2_,y2_);}--i;}else data.forEach(root.add);xs=ys=data=d=null;return root;}quadtree.x=function(_){return arguments.length?(x=_,quadtree):x;};quadtree.y=function(_){return arguments.length?(y=_,quadtree):y;};quadtree.extent=function(_){if(!arguments.length)return x1==null?null:[[x1,y1],[x2,y2]];if(_==null)x1=y1=x2=y2=null;else x1=+_[0][0],y1=+_[0][1],x2=+_[1][0],y2=+_[1][1];return quadtree;};quadtree.size=function(_){if(!arguments.length)return x1==null?null:[x2-x1,y2-y1];if(_==null)x1=y1=x2=y2=null;else x1=y1=0,x2=+_[0],y2=+_[1];return quadtree;};return quadtree;};function d3_geom_quadtreeCompatX(d){return d.x;}function d3_geom_quadtreeCompatY(d){return d.y;}function d3_geom_quadtreeNode(){return{leaf:true,nodes:[],point:null,x:null,y:null};}function d3_geom_quadtreeVisit(f,node,x1,y1,x2,y2){if(!f(node,x1,y1,x2,y2)){var sx=(x1+x2)*.5,sy=(y1+y2)*.5,children=node.nodes;if(children[0])d3_geom_quadtreeVisit(f,children[0],x1,y1,sx,sy);if(children[1])d3_geom_quadtreeVisit(f,children[1],sx,y1,x2,sy);if(children[2])d3_geom_quadtreeVisit(f,children[2],x1,sy,sx,y2);if(children[3])d3_geom_quadtreeVisit(f,children[3],sx,sy,x2,y2);}}function d3_geom_quadtreeFind(root,x,y,x0,y0,x3,y3){var minDistance2=Infinity,closestPoint;(function find(node,x1,y1,x2,y2){if(x1>x3||y1>y3||x2<x0||y2<y0)return;if(point=node.point){var point,dx=x-node.x,dy=y-node.y,distance2=dx*dx+dy*dy;if(distance2<minDistance2){var distance=Math.sqrt(minDistance2=distance2);x0=x-distance,y0=y-distance;x3=x+distance,y3=y+distance;closestPoint=point;}}var children=node.nodes,xm=(x1+x2)*.5,ym=(y1+y2)*.5,right=x>=xm,below=y>=ym;for(var i=below<<1|right,j=i+4;i<j;++i){if(node=children[i&3])switch(i&3){case 0:find(node,x1,y1,xm,ym);break;case 1:find(node,xm,y1,x2,ym);break;case 2:find(node,x1,ym,xm,y2);break;case 3:find(node,xm,ym,x2,y2);break;}}})(root,x0,y0,x3,y3);return closestPoint;}d3.interpolateRgb=d3_interpolateRgb;function d3_interpolateRgb(a,b){a=d3.rgb(a);b=d3.rgb(b);var ar=a.r,ag=a.g,ab=a.b,br=b.r-ar,bg=b.g-ag,bb=b.b-ab;return function(t){return"#"+d3_rgb_hex(Math.round(ar+br*t))+d3_rgb_hex(Math.round(ag+bg*t))+d3_rgb_hex(Math.round(ab+bb*t));};}d3.interpolateObject=d3_interpolateObject;function d3_interpolateObject(a,b){var i={},c={},k;for(k in a){if(k in b){i[k]=d3_interpolate(a[k],b[k]);}else{c[k]=a[k];}}for(k in b){if(!(k in a)){c[k]=b[k];}}return function(t){for(k in i){c[k]=i[k](t);}return c;};}d3.interpolateNumber=d3_interpolateNumber;function d3_interpolateNumber(a,b){a=+a,b=+b;return function(t){return a*(1-t)+b*t;};}d3.interpolateString=d3_interpolateString;function d3_interpolateString(a,b){var bi=d3_interpolate_numberA.lastIndex=d3_interpolate_numberB.lastIndex=0,am,bm,bs,i=-1,s=[],q=[];a=a+"",b=b+"";while((am=d3_interpolate_numberA.exec(a))&&(bm=d3_interpolate_numberB.exec(b))){if((bs=bm.index)>bi){bs=b.slice(bi,bs);if(s[i])s[i]+=bs;else s[++i]=bs;}if((am=am[0])===(bm=bm[0])){if(s[i])s[i]+=bm;else s[++i]=bm;}else{s[++i]=null;q.push({i:i,x:d3_interpolateNumber(am,bm)});}bi=d3_interpolate_numberB.lastIndex;}if(bi<b.length){bs=b.slice(bi);if(s[i])s[i]+=bs;else s[++i]=bs;}return s.length<2?q[0]?(b=q[0].x,function(t){return b(t)+"";}):function(){return b;}:(b=q.length,function(t){for(var i=0,o;i<b;++i){s[(o=q[i]).i]=o.x(t);}return s.join("");});}var d3_interpolate_numberA=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,d3_interpolate_numberB=new RegExp(d3_interpolate_numberA.source,"g");d3.interpolate=d3_interpolate;function d3_interpolate(a,b){var i=d3.interpolators.length,f;while(--i>=0&&!(f=d3.interpolators[i](a,b))){;}return f;}d3.interpolators=[function(a,b){var t=_typeof(b);return(t==="string"?d3_rgb_names.has(b.toLowerCase())||/^(#|rgb\(|hsl\()/i.test(b)?d3_interpolateRgb:d3_interpolateString:b instanceof d3_color?d3_interpolateRgb:Array.isArray(b)?d3_interpolateArray:t==="object"&&isNaN(b)?d3_interpolateObject:d3_interpolateNumber)(a,b);}];d3.interpolateArray=d3_interpolateArray;function d3_interpolateArray(a,b){var x=[],c=[],na=a.length,nb=b.length,n0=Math.min(a.length,b.length),i;for(i=0;i<n0;++i){x.push(d3_interpolate(a[i],b[i]));}for(;i<na;++i){c[i]=a[i];}for(;i<nb;++i){c[i]=b[i];}return function(t){for(i=0;i<n0;++i){c[i]=x[i](t);}return c;};}var d3_ease_default=function d3_ease_default(){return d3_identity;};var d3_ease=d3.map({linear:d3_ease_default,poly:d3_ease_poly,quad:function quad(){return d3_ease_quad;},cubic:function cubic(){return d3_ease_cubic;},sin:function sin(){return d3_ease_sin;},exp:function exp(){return d3_ease_exp;},circle:function circle(){return d3_ease_circle;},elastic:d3_ease_elastic,back:d3_ease_back,bounce:function bounce(){return d3_ease_bounce;}});var d3_ease_mode=d3.map({"in":d3_identity,out:d3_ease_reverse,"in-out":d3_ease_reflect,"out-in":function outIn(f){return d3_ease_reflect(d3_ease_reverse(f));}});d3.ease=function(name){var i=name.indexOf("-"),t=i>=0?name.slice(0,i):name,m=i>=0?name.slice(i+1):"in";t=d3_ease.get(t)||d3_ease_default;m=d3_ease_mode.get(m)||d3_identity;return d3_ease_clamp(m(t.apply(null,d3_arraySlice.call(arguments,1))));};function d3_ease_clamp(f){return function(t){return t<=0?0:t>=1?1:f(t);};}function d3_ease_reverse(f){return function(t){return 1-f(1-t);};}function d3_ease_reflect(f){return function(t){return .5*(t<.5?f(2*t):2-f(2-2*t));};}function d3_ease_quad(t){return t*t;}function d3_ease_cubic(t){return t*t*t;}function d3_ease_cubicInOut(t){if(t<=0)return 0;if(t>=1)return 1;var t2=t*t,t3=t2*t;return 4*(t<.5?t3:3*(t-t2)+t3-.75);}function d3_ease_poly(e){return function(t){return Math.pow(t,e);};}function d3_ease_sin(t){return 1-Math.cos(t*half);}function d3_ease_exp(t){return Math.pow(2,10*(t-1));}function d3_ease_circle(t){return 1-Math.sqrt(1-t*t);}function d3_ease_elastic(a,p){var s;if(arguments.length<2)p=.45;if(arguments.length)s=p/*Math.asin(1/a);else a=1,s=p/4;return function(t){return 1+a*Math.pow(2,-10*t)*Math.sin((t-s)*/p);};}function d3_ease_back(s){if(!s)s=1.70158;return function(t){return t*t*((s+1)*t-s);};}function d3_ease_bounce(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375;}d3.interpolateHcl=d3_interpolateHcl;function d3_interpolateHcl(a,b){a=d3.hcl(a);b=d3.hcl(b);var ah=a.h,ac=a.c,al=a.l,bh=b.h-ah,bc=b.c-ac,bl=b.l-al;if(isNaN(bc))bc=0,ac=isNaN(ac)?b.c:ac;if(isNaN(bh))bh=0,ah=isNaN(ah)?b.h:ah;else if(bh>180)bh-=360;else if(bh<-180)bh+=360;return function(t){return d3_hcl_lab(ah+bh*t,ac+bc*t,al+bl*t)+"";};}d3.interpolateHsl=d3_interpolateHsl;function d3_interpolateHsl(a,b){a=d3.hsl(a);b=d3.hsl(b);var ah=a.h,as=a.s,al=a.l,bh=b.h-ah,bs=b.s-as,bl=b.l-al;if(isNaN(bs))bs=0,as=isNaN(as)?b.s:as;if(isNaN(bh))bh=0,ah=isNaN(ah)?b.h:ah;else if(bh>180)bh-=360;else if(bh<-180)bh+=360;return function(t){return d3_hsl_rgb(ah+bh*t,as+bs*t,al+bl*t)+"";};}d3.interpolateLab=d3_interpolateLab;function d3_interpolateLab(a,b){a=d3.lab(a);b=d3.lab(b);var al=a.l,aa=a.a,ab=a.b,bl=b.l-al,ba=b.a-aa,bb=b.b-ab;return function(t){return d3_lab_rgb(al+bl*t,aa+ba*t,ab+bb*t)+"";};}d3.interpolateRound=d3_interpolateRound;function d3_interpolateRound(a,b){b-=a;return function(t){return Math.round(a+b*t);};}d3.transform=function(string){var g=d3_document.createElementNS(d3.ns.prefix.svg,"g");return(d3.transform=function(string){if(string!=null){g.setAttribute("transform",string);var t=g.transform.baseVal.consolidate();}return new d3_transform(t?t.matrix:d3_transformIdentity);})(string);};function d3_transform(m){var r0=[m.a,m.b],r1=[m.c,m.d],kx=d3_transformNormalize(r0),kz=d3_transformDot(r0,r1),ky=d3_transformNormalize(d3_transformCombine(r1,r0,-kz))||0;if(r0[0]*r1[1]<r1[0]*r0[1]){r0[0]*=-1;r0[1]*=-1;kx*=-1;kz*=-1;}this.rotate=(kx?Math.atan2(r0[1],r0[0]):Math.atan2(-r1[0],r1[1]))*d3_degrees;this.translate=[m.e,m.f];this.scale=[kx,ky];this.skew=ky?Math.atan2(kz,ky)*d3_degrees:0;}d3_transform.prototype.toString=function(){return"translate("+this.translate+")rotate("+this.rotate+")skewX("+this.skew+")scale("+this.scale+")";};function d3_transformDot(a,b){return a[0]*b[0]+a[1]*b[1];}function d3_transformNormalize(a){var k=Math.sqrt(d3_transformDot(a,a));if(k){a[0]/=k;a[1]/=k;}return k;}function d3_transformCombine(a,b,k){a[0]+=k*b[0];a[1]+=k*b[1];return a;}var d3_transformIdentity={a:1,b:0,c:0,d:1,e:0,f:0};d3.interpolateTransform=d3_interpolateTransform;function d3_interpolateTransformPop(s){return s.length?s.pop()+",":"";}function d3_interpolateTranslate(ta,tb,s,q){if(ta[0]!==tb[0]||ta[1]!==tb[1]){var i=s.push("translate(",null,",",null,")");q.push({i:i-4,x:d3_interpolateNumber(ta[0],tb[0])},{i:i-2,x:d3_interpolateNumber(ta[1],tb[1])});}else if(tb[0]||tb[1]){s.push("translate("+tb+")");}}function d3_interpolateRotate(ra,rb,s,q){if(ra!==rb){if(ra-rb>180)rb+=360;else if(rb-ra>180)ra+=360;q.push({i:s.push(d3_interpolateTransformPop(s)+"rotate(",null,")")-2,x:d3_interpolateNumber(ra,rb)});}else if(rb){s.push(d3_interpolateTransformPop(s)+"rotate("+rb+")");}}function d3_interpolateSkew(wa,wb,s,q){if(wa!==wb){q.push({i:s.push(d3_interpolateTransformPop(s)+"skewX(",null,")")-2,x:d3_interpolateNumber(wa,wb)});}else if(wb){s.push(d3_interpolateTransformPop(s)+"skewX("+wb+")");}}function d3_interpolateScale(ka,kb,s,q){if(ka[0]!==kb[0]||ka[1]!==kb[1]){var i=s.push(d3_interpolateTransformPop(s)+"scale(",null,",",null,")");q.push({i:i-4,x:d3_interpolateNumber(ka[0],kb[0])},{i:i-2,x:d3_interpolateNumber(ka[1],kb[1])});}else if(kb[0]!==1||kb[1]!==1){s.push(d3_interpolateTransformPop(s)+"scale("+kb+")");}}function d3_interpolateTransform(a,b){var s=[],q=[];a=d3.transform(a),b=d3.transform(b);d3_interpolateTranslate(a.translate,b.translate,s,q);d3_interpolateRotate(a.rotate,b.rotate,s,q);d3_interpolateSkew(a.skew,b.skew,s,q);d3_interpolateScale(a.scale,b.scale,s,q);a=b=null;return function(t){var i=-1,n=q.length,o;while(++i<n){s[(o=q[i]).i]=o.x(t);}return s.join("");};}function d3_uninterpolateNumber(a,b){b=(b-=a=+a)||1/b;return function(x){return(x-a)/b;};}function d3_uninterpolateClamp(a,b){b=(b-=a=+a)||1/b;return function(x){return Math.max(0,Math.min(1,(x-a)/b));};}d3.layout={};d3.layout.bundle=function(){return function(links){var paths=[],i=-1,n=links.length;while(++i<n){paths.push(d3_layout_bundlePath(links[i]));}return paths;};};function d3_layout_bundlePath(link){var start=link.source,end=link.target,lca=d3_layout_bundleLeastCommonAncestor(start,end),points=[start];while(start!==lca){start=start.parent;points.push(start);}var k=points.length;while(end!==lca){points.splice(k,0,end);end=end.parent;}return points;}function d3_layout_bundleAncestors(node){var ancestors=[],parent=node.parent;while(parent!=null){ancestors.push(node);node=parent;parent=parent.parent;}ancestors.push(node);return ancestors;}function d3_layout_bundleLeastCommonAncestor(a,b){if(a===b)return a;var aNodes=d3_layout_bundleAncestors(a),bNodes=d3_layout_bundleAncestors(b),aNode=aNodes.pop(),bNode=bNodes.pop(),sharedNode=null;while(aNode===bNode){sharedNode=aNode;aNode=aNodes.pop();bNode=bNodes.pop();}return sharedNode;}d3.layout.chord=function(){var chord={},chords,groups,matrix,n,padding=0,sortGroups,sortSubgroups,sortChords;function relayout(){var subgroups={},groupSums=[],groupIndex=d3.range(n),subgroupIndex=[],k,x,x0,i,j;chords=[];groups=[];k=0,i=-1;while(++i<n){x=0,j=-1;while(++j<n){x+=matrix[i][j];}groupSums.push(x);subgroupIndex.push(d3.range(n));k+=x;}if(sortGroups){groupIndex.sort(function(a,b){return sortGroups(groupSums[a],groupSums[b]);});}if(sortSubgroups){subgroupIndex.forEach(function(d,i){d.sort(function(a,b){return sortSubgroups(matrix[i][a],matrix[i][b]);});});}k=(-padding*n)/k;x=0,i=-1;while(++i<n){x0=x,j=-1;while(++j<n){var di=groupIndex[i],dj=subgroupIndex[di][j],v=matrix[di][dj],a0=x,a1=x+=v*k;subgroups[di+"-"+dj]={index:di,subindex:dj,startAngle:a0,endAngle:a1,value:v};}groups[di]={index:di,startAngle:x0,endAngle:x,value:groupSums[di]};x+=padding;}i=-1;while(++i<n){j=i-1;while(++j<n){var source=subgroups[i+"-"+j],target=subgroups[j+"-"+i];if(source.value||target.value){chords.push(source.value<target.value?{source:target,target:source}:{source:source,target:target});}}}if(sortChords)resort();}function resort(){chords.sort(function(a,b){return sortChords((a.source.value+a.target.value)/2,(b.source.value+b.target.value)/2);});}chord.matrix=function(x){if(!arguments.length)return matrix;n=(matrix=x)&&matrix.length;chords=groups=null;return chord;};chord.padding=function(x){if(!arguments.length)return padding;padding=x;chords=groups=null;return chord;};chord.sortGroups=function(x){if(!arguments.length)return sortGroups;sortGroups=x;chords=groups=null;return chord;};chord.sortSubgroups=function(x){if(!arguments.length)return sortSubgroups;sortSubgroups=x;chords=null;return chord;};chord.sortChords=function(x){if(!arguments.length)return sortChords;sortChords=x;if(chords)resort();return chord;};chord.chords=function(){if(!chords)relayout();return chords;};chord.groups=function(){if(!groups)relayout();return groups;};return chord;};d3.layout.force=function(){var force={},event=d3.dispatch("start","tick","end"),timer,size=[1,1],drag,alpha,friction=.9,linkDistance=d3_layout_forceLinkDistance,linkStrength=d3_layout_forceLinkStrength,charge=-30,chargeDistance2=d3_layout_forceChargeDistance2,gravity=.1,theta2=.64,nodes=[],links=[],distances,strengths,charges;function repulse(node){return function(quad,x1,_,x2){if(quad.point!==node){var dx=quad.cx-node.x,dy=quad.cy-node.y,dw=x2-x1,dn=dx*dx+dy*dy;if(dw*dw/theta2<dn){if(dn<chargeDistance2){var k=quad.charge/dn;node.px-=dx*k;node.py-=dy*k;}return true;}if(quad.point&&dn&&dn<chargeDistance2){var k=quad.pointCharge/dn;node.px-=dx*k;node.py-=dy*k;}}return!quad.charge;};}force.tick=function(){if((alpha*=.99)<.005){timer=null;event.end({type:"end",alpha:alpha=0});return true;}var n=nodes.length,m=links.length,q,i,o,s,t,l,k,x,y;for(i=0;i<m;++i){o=links[i];s=o.source;t=o.target;x=t.x-s.x;y=t.y-s.y;if(l=x*x+y*y){l=alpha*strengths[i]*((l=Math.sqrt(l))-distances[i])/l;x*=l;y*=l;t.x-=x*(k=s.weight+t.weight?s.weight/(s.weight+t.weight):.5);t.y-=y*k;s.x+=x*(k=1-k);s.y+=y*k;}}if(k=alpha*gravity){x=size[0]/2;y=size[1]/2;i=-1;if(k)while(++i<n){o=nodes[i];o.x+=(x-o.x)*k;o.y+=(y-o.y)*k;}}if(charge){d3_layout_forceAccumulate(q=d3.geom.quadtree(nodes),alpha,charges);i=-1;while(++i<n){if(!(o=nodes[i]).fixed){q.visit(repulse(o));}}}i=-1;while(++i<n){o=nodes[i];if(o.fixed){o.x=o.px;o.y=o.py;}else{o.x-=(o.px-(o.px=o.x))*friction;o.y-=(o.py-(o.py=o.y))*friction;}}event.tick({type:"tick",alpha:alpha});};force.nodes=function(x){if(!arguments.length)return nodes;nodes=x;return force;};force.links=function(x){if(!arguments.length)return links;links=x;return force;};force.size=function(x){if(!arguments.length)return size;size=x;return force;};force.linkDistance=function(x){if(!arguments.length)return linkDistance;linkDistance=typeof x==="function"?x:+x;return force;};force.distance=force.linkDistance;force.linkStrength=function(x){if(!arguments.length)return linkStrength;linkStrength=typeof x==="function"?x:+x;return force;};force.friction=function(x){if(!arguments.length)return friction;friction=+x;return force;};force.charge=function(x){if(!arguments.length)return charge;charge=typeof x==="function"?x:+x;return force;};force.chargeDistance=function(x){if(!arguments.length)return Math.sqrt(chargeDistance2);chargeDistance2=x*x;return force;};force.gravity=function(x){if(!arguments.length)return gravity;gravity=+x;return force;};force.theta=function(x){if(!arguments.length)return Math.sqrt(theta2);theta2=x*x;return force;};force.alpha=function(x){if(!arguments.length)return alpha;x=+x;if(alpha){if(x>0){alpha=x;}else{timer.c=null,timer.t=NaN,timer=null;event.end({type:"end",alpha:alpha=0});}}else if(x>0){event.start({type:"start",alpha:alpha=x});timer=d3_timer(force.tick);}return force;};force.start=function(){var i,n=nodes.length,m=links.length,w=size[0],h=size[1],neighbors,o;for(i=0;i<n;++i){(o=nodes[i]).index=i;o.weight=0;}for(i=0;i<m;++i){o=links[i];if(typeof o.source=="number")o.source=nodes[o.source];if(typeof o.target=="number")o.target=nodes[o.target];++o.source.weight;++o.target.weight;}for(i=0;i<n;++i){o=nodes[i];if(isNaN(o.x))o.x=position("x",w);if(isNaN(o.y))o.y=position("y",h);if(isNaN(o.px))o.px=o.x;if(isNaN(o.py))o.py=o.y;}distances=[];if(typeof linkDistance==="function")for(i=0;i<m;++i){distances[i]=+linkDistance.call(this,links[i],i);}else for(i=0;i<m;++i){distances[i]=linkDistance;}strengths=[];if(typeof linkStrength==="function")for(i=0;i<m;++i){strengths[i]=+linkStrength.call(this,links[i],i);}else for(i=0;i<m;++i){strengths[i]=linkStrength;}charges=[];if(typeof charge==="function")for(i=0;i<n;++i){charges[i]=+charge.call(this,nodes[i],i);}else for(i=0;i<n;++i){charges[i]=charge;}function position(dimension,size){if(!neighbors){neighbors=new Array(n);for(j=0;j<n;++j){neighbors[j]=[];}for(j=0;j<m;++j){var o=links[j];neighbors[o.source.index].push(o.target);neighbors[o.target.index].push(o.source);}}var candidates=neighbors[i],j=-1,l=candidates.length,x;while(++j<l){if(!isNaN(x=candidates[j][dimension]))return x;}return Math.random()*size;}return force.resume();};force.resume=function(){return force.alpha(.1);};force.stop=function(){return force.alpha(0);};force.drag=function(){if(!drag)drag=d3.behavior.drag().origin(d3_identity).on("dragstart.force",d3_layout_forceDragstart).on("drag.force",dragmove).on("dragend.force",d3_layout_forceDragend);if(!arguments.length)return drag;this.on("mouseover.force",d3_layout_forceMouseover).on("mouseout.force",d3_layout_forceMouseout).call(drag);};function dragmove(d){d.px=d3.event.x,d.py=d3.event.y;force.resume();}return d3.rebind(force,event,"on");};function d3_layout_forceDragstart(d){d.fixed|=2;}function d3_layout_forceDragend(d){d.fixed&=~6;}function d3_layout_forceMouseover(d){d.fixed|=4;d.px=d.x,d.py=d.y;}function d3_layout_forceMouseout(d){d.fixed&=~4;}function d3_layout_forceAccumulate(quad,alpha,charges){var cx=0,cy=0;quad.charge=0;if(!quad.leaf){var nodes=quad.nodes,n=nodes.length,i=-1,c;while(++i<n){c=nodes[i];if(c==null)continue;d3_layout_forceAccumulate(c,alpha,charges);quad.charge+=c.charge;cx+=c.charge*c.cx;cy+=c.charge*c.cy;}}if(quad.point){if(!quad.leaf){quad.point.x+=Math.random()-.5;quad.point.y+=Math.random()-.5;}var k=alpha*charges[quad.point.index];quad.charge+=quad.pointCharge=k;cx+=k*quad.point.x;cy+=k*quad.point.y;}quad.cx=cx/quad.charge;quad.cy=cy/quad.charge;}var d3_layout_forceLinkDistance=20,d3_layout_forceLinkStrength=1,d3_layout_forceChargeDistance2=Infinity;d3.layout.hierarchy=function(){var sort=d3_layout_hierarchySort,children=d3_layout_hierarchyChildren,value=d3_layout_hierarchyValue;function hierarchy(root){var stack=[root],nodes=[],node;root.depth=0;while((node=stack.pop())!=null){nodes.push(node);if((childs=children.call(hierarchy,node,node.depth))&&(n=childs.length)){var n,childs,child;while(--n>=0){stack.push(child=childs[n]);child.parent=node;child.depth=node.depth+1;}if(value)node.value=0;node.children=childs;}else{if(value)node.value=+value.call(hierarchy,node,node.depth)||0;delete node.children;}}d3_layout_hierarchyVisitAfter(root,function(node){var childs,parent;if(sort&&(childs=node.children))childs.sort(sort);if(value&&(parent=node.parent))parent.value+=node.value;});return nodes;}hierarchy.sort=function(x){if(!arguments.length)return sort;sort=x;return hierarchy;};hierarchy.children=function(x){if(!arguments.length)return children;children=x;return hierarchy;};hierarchy.value=function(x){if(!arguments.length)return value;value=x;return hierarchy;};hierarchy.revalue=function(root){if(value){d3_layout_hierarchyVisitBefore(root,function(node){if(node.children)node.value=0;});d3_layout_hierarchyVisitAfter(root,function(node){var parent;if(!node.children)node.value=+value.call(hierarchy,node,node.depth)||0;if(parent=node.parent)parent.value+=node.value;});}return root;};return hierarchy;};function d3_layout_hierarchyRebind(object,hierarchy){d3.rebind(object,hierarchy,"sort","children","value");object.nodes=object;object.links=d3_layout_hierarchyLinks;return object;}function d3_layout_hierarchyVisitBefore(node,callback){var nodes=[node];while((node=nodes.pop())!=null){callback(node);if((children=node.children)&&(n=children.length)){var n,children;while(--n>=0){nodes.push(children[n]);}}}}function d3_layout_hierarchyVisitAfter(node,callback){var nodes=[node],nodes2=[];while((node=nodes.pop())!=null){nodes2.push(node);if((children=node.children)&&(n=children.length)){var i=-1,n,children;while(++i<n){nodes.push(children[i]);}}}while((node=nodes2.pop())!=null){callback(node);}}function d3_layout_hierarchyChildren(d){return d.children;}function d3_layout_hierarchyValue(d){return d.value;}function d3_layout_hierarchySort(a,b){return b.value-a.value;}function d3_layout_hierarchyLinks(nodes){return d3.merge(nodes.map(function(parent){return(parent.children||[]).map(function(child){return{source:parent,target:child};});}));}d3.layout.partition=function(){var hierarchy=d3.layout.hierarchy(),size=[1,1];function position(node,x,dx,dy){var children=node.children;node.x=x;node.y=node.depth*dy;node.dx=dx;node.dy=dy;if(children&&(n=children.length)){var i=-1,n,c,d;dx=node.value?dx/node.value:0;while(++i<n){position(c=children[i],x,d=c.value*dx,dy);x+=d;}}}function depth(node){var children=node.children,d=0;if(children&&(n=children.length)){var i=-1,n;while(++i<n){d=Math.max(d,depth(children[i]));}}return 1+d;}function partition(d,i){var nodes=hierarchy.call(this,d,i);position(nodes[0],0,size[0],size[1]/depth(nodes[0]));return nodes;}partition.size=function(x){if(!arguments.length)return size;size=x;return partition;};return d3_layout_hierarchyRebind(partition,hierarchy);};d3.layout.pie=function(){var value=Number,sort=d3_layout_pieSortByValue,startAngle=0,endAngle=,padAngle=0;function pie(data){var n=data.length,values=data.map(function(d,i){return+value.call(pie,d,i);}),a=+(typeof startAngle==="function"?startAngle.apply(this,arguments):startAngle),da=(typeof endAngle==="function"?endAngle.apply(this,arguments):endAngle)-a,p=Math.min(Math.abs(da)/n,+(typeof padAngle==="function"?padAngle.apply(this,arguments):padAngle)),pa=p*(da<0?-1:1),sum=d3.sum(values),k=sum?(da-n*pa)/sum:0,index=d3.range(n),arcs=[],v;if(sort!=null)index.sort(sort===d3_layout_pieSortByValue?function(i,j){return values[j]-values[i];}:function(i,j){return sort(data[i],data[j]);});index.forEach(function(i){arcs[i]={data:data[i],value:v=values[i],startAngle:a,endAngle:a+=v*k+pa,padAngle:p};});return arcs;}pie.value=function(_){if(!arguments.length)return value;value=_;return pie;};pie.sort=function(_){if(!arguments.length)return sort;sort=_;return pie;};pie.startAngle=function(_){if(!arguments.length)return startAngle;startAngle=_;return pie;};pie.endAngle=function(_){if(!arguments.length)return endAngle;endAngle=_;return pie;};pie.padAngle=function(_){if(!arguments.length)return padAngle;padAngle=_;return pie;};return pie;};var d3_layout_pieSortByValue={};d3.layout.stack=function(){var values=d3_identity,order=d3_layout_stackOrderDefault,offset=d3_layout_stackOffsetZero,out=d3_layout_stackOut,x=d3_layout_stackX,y=d3_layout_stackY;function stack(data,index){if(!(n=data.length))return data;var series=data.map(function(d,i){return values.call(stack,d,i);});var points=series.map(function(d){return d.map(function(v,i){return[x.call(stack,v,i),y.call(stack,v,i)];});});var orders=order.call(stack,points,index);series=d3.permute(series,orders);points=d3.permute(points,orders);var offsets=offset.call(stack,points,index);var m=series[0].length,n,i,j,o;for(j=0;j<m;++j){out.call(stack,series[0][j],o=offsets[j],points[0][j][1]);for(i=1;i<n;++i){out.call(stack,series[i][j],o+=points[i-1][j][1],points[i][j][1]);}}return data;}stack.values=function(x){if(!arguments.length)return values;values=x;return stack;};stack.order=function(x){if(!arguments.length)return order;order=typeof x==="function"?x:d3_layout_stackOrders.get(x)||d3_layout_stackOrderDefault;return stack;};stack.offset=function(x){if(!arguments.length)return offset;offset=typeof x==="function"?x:d3_layout_stackOffsets.get(x)||d3_layout_stackOffsetZero;return stack;};stack.x=function(z){if(!arguments.length)return x;x=z;return stack;};stack.y=function(z){if(!arguments.length)return y;y=z;return stack;};stack.out=function(z){if(!arguments.length)return out;out=z;return stack;};return stack;};function d3_layout_stackX(d){return d.x;}function d3_layout_stackY(d){return d.y;}function d3_layout_stackOut(d,y0,y){d.y0=y0;d.y=y;}var d3_layout_stackOrders=d3.map({"inside-out":function insideOut(data){var n=data.length,i,j,max=data.map(d3_layout_stackMaxIndex),sums=data.map(d3_layout_stackReduceSum),index=d3.range(n).sort(function(a,b){return max[a]-max[b];}),top=0,bottom=0,tops=[],bottoms=[];for(i=0;i<n;++i){j=index[i];if(top<bottom){top+=sums[j];tops.push(j);}else{bottom+=sums[j];bottoms.push(j);}}return bottoms.reverse().concat(tops);},reverse:function reverse(data){return d3.range(data.length).reverse();},"default":d3_layout_stackOrderDefault});var d3_layout_stackOffsets=d3.map({silhouette:function silhouette(data){var n=data.length,m=data[0].length,sums=[],max=0,i,j,o,y0=[];for(j=0;j<m;++j){for(i=0,o=0;i<n;i++){o+=data[i][j][1];}if(o>max)max=o;sums.push(o);}for(j=0;j<m;++j){y0[j]=(max-sums[j])/2;}return y0;},wiggle:function wiggle(data){var n=data.length,x=data[0],m=x.length,i,j,k,s1,s2,s3,dx,o,o0,y0=[];y0[0]=o=o0=0;for(j=1;j<m;++j){for(i=0,s1=0;i<n;++i){s1+=data[i][j][1];}for(i=0,s2=0,dx=x[j][0]-x[j-1][0];i<n;++i){for(k=0,s3=(data[i][j][1]-data[i][j-1][1])/(2*dx);k<i;++k){s3+=(data[k][j][1]-data[k][j-1][1])/dx;}s2+=s3*data[i][j][1];}y0[j]=o-=s1?s2/s1*dx:0;if(o<o0)o0=o;}for(j=0;j<m;++j){y0[j]-=o0;}return y0;},expand:function expand(data){var n=data.length,m=data[0].length,k=1/n,i,j,o,y0=[];for(j=0;j<m;++j){for(i=0,o=0;i<n;i++){o+=data[i][j][1];}if(o)for(i=0;i<n;i++){data[i][j][1]/=o;}else for(i=0;i<n;i++){data[i][j][1]=k;}}for(j=0;j<m;++j){y0[j]=0;}return y0;},zero:d3_layout_stackOffsetZero});function d3_layout_stackOrderDefault(data){return d3.range(data.length);}function d3_layout_stackOffsetZero(data){var j=-1,m=data[0].length,y0=[];while(++j<m){y0[j]=0;}return y0;}function d3_layout_stackMaxIndex(array){var i=1,j=0,v=array[0][1],k,n=array.length;for(;i<n;++i){if((k=array[i][1])>v){j=i;v=k;}}return j;}function d3_layout_stackReduceSum(d){return d.reduce(d3_layout_stackSum,0);}function d3_layout_stackSum(p,d){return p+d[1];}d3.layout.histogram=function(){var frequency=true,valuer=Number,ranger=d3_layout_histogramRange,binner=d3_layout_histogramBinSturges;function histogram(data,i){var bins=[],values=data.map(valuer,this),range=ranger.call(this,values,i),thresholds=binner.call(this,range,values,i),bin,i=-1,n=values.length,m=thresholds.length-1,k=frequency?1:1/n,x;while(++i<m){bin=bins[i]=[];bin.dx=thresholds[i+1]-(bin.x=thresholds[i]);bin.y=0;}if(m>0){i=-1;while(++i<n){x=values[i];if(x>=range[0]&&x<=range[1]){bin=bins[d3.bisect(thresholds,x,1,m)-1];bin.y+=k;bin.push(data[i]);}}}return bins;}histogram.value=function(x){if(!arguments.length)return valuer;valuer=x;return histogram;};histogram.range=function(x){if(!arguments.length)return ranger;ranger=d3_functor(x);return histogram;};histogram.bins=function(x){if(!arguments.length)return binner;binner=typeof x==="number"?function(range){return d3_layout_histogramBinFixed(range,x);}:d3_functor(x);return histogram;};histogram.frequency=function(x){if(!arguments.length)return frequency;frequency=!!x;return histogram;};return histogram;};function d3_layout_histogramBinSturges(range,values){return d3_layout_histogramBinFixed(range,Math.ceil(Math.log(values.length)/Math.LN2+1));}function d3_layout_histogramBinFixed(range,n){var x=-1,b=+range[0],m=(range[1]-b)/n,f=[];while(++x<=n){f[x]=m*x+b;}return f;}function d3_layout_histogramRange(values){return[d3.min(values),d3.max(values)];}d3.layout.pack=function(){var hierarchy=d3.layout.hierarchy().sort(d3_layout_packSort),padding=0,size=[1,1],radius;function pack(d,i){var nodes=hierarchy.call(this,d,i),root=nodes[0],w=size[0],h=size[1],r=radius==null?Math.sqrt:typeof radius==="function"?radius:function(){return radius;};root.x=root.y=0;d3_layout_hierarchyVisitAfter(root,function(d){d.r=+r(d.value);});d3_layout_hierarchyVisitAfter(root,d3_layout_packSiblings);if(padding){var dr=padding*(radius?1:Math.max(2*root.r/w,2*root.r/h))/2;d3_layout_hierarchyVisitAfter(root,function(d){d.r+=dr;});d3_layout_hierarchyVisitAfter(root,d3_layout_packSiblings);d3_layout_hierarchyVisitAfter(root,function(d){d.r-=dr;});}d3_layout_packTransform(root,w/2,h/2,radius?1:1/Math.max(2*root.r/w,2*root.r/h));return nodes;}pack.size=function(_){if(!arguments.length)return size;size=_;return pack;};pack.radius=function(_){if(!arguments.length)return radius;radius=_==null||typeof _==="function"?_:+_;return pack;};pack.padding=function(_){if(!arguments.length)return padding;padding=+_;return pack;};return d3_layout_hierarchyRebind(pack,hierarchy);};function d3_layout_packSort(a,b){return a.value-b.value;}function d3_layout_packInsert(a,b){var c=a._pack_next;a._pack_next=b;b._pack_prev=a;b._pack_next=c;c._pack_prev=b;}function d3_layout_packSplice(a,b){a._pack_next=b;b._pack_prev=a;}function d3_layout_packIntersects(a,b){var dx=b.x-a.x,dy=b.y-a.y,dr=a.r+b.r;return .999*dr*dr>dx*dx+dy*dy;}function d3_layout_packSiblings(node){if(!(nodes=node.children)||!(n=nodes.length))return;var nodes,xMin=Infinity,xMax=-Infinity,yMin=Infinity,yMax=-Infinity,a,b,c,i,j,k,n;function bound(node){xMin=Math.min(node.x-node.r,xMin);xMax=Math.max(node.x+node.r,xMax);yMin=Math.min(node.y-node.r,yMin);yMax=Math.max(node.y+node.r,yMax);}nodes.forEach(d3_layout_packLink);a=nodes[0];a.x=-a.r;a.y=0;bound(a);if(n>1){b=nodes[1];b.x=b.r;b.y=0;bound(b);if(n>2){c=nodes[2];d3_layout_packPlace(a,b,c);bound(c);d3_layout_packInsert(a,c);a._pack_prev=c;d3_layout_packInsert(c,b);b=a._pack_next;for(i=3;i<n;i++){d3_layout_packPlace(a,b,c=nodes[i]);var isect=0,s1=1,s2=1;for(j=b._pack_next;j!==b;j=j._pack_next,s1++){if(d3_layout_packIntersects(j,c)){isect=1;break;}}if(isect==1){for(k=a._pack_prev;k!==j._pack_prev;k=k._pack_prev,s2++){if(d3_layout_packIntersects(k,c)){break;}}}if(isect){if(s1<s2||s1==s2&&b.r<a.r)d3_layout_packSplice(a,b=j);else d3_layout_packSplice(a=k,b);i--;}else{d3_layout_packInsert(a,c);b=c;bound(c);}}}}var cx=(xMin+xMax)/2,cy=(yMin+yMax)/2,cr=0;for(i=0;i<n;i++){c=nodes[i];c.x-=cx;c.y-=cy;cr=Math.max(cr,c.r+Math.sqrt(c.x*c.x+c.y*c.y));}node.r=cr;nodes.forEach(d3_layout_packUnlink);}function d3_layout_packLink(node){node._pack_next=node._pack_prev=node;}function d3_layout_packUnlink(node){delete node._pack_next;delete node._pack_prev;}function d3_layout_packTransform(node,x,y,k){var children=node.children;node.x=x+=k*node.x;node.y=y+=k*node.y;node.r*=k;if(children){var i=-1,n=children.length;while(++i<n){d3_layout_packTransform(children[i],x,y,k);}}}function d3_layout_packPlace(a,b,c){var db=a.r+c.r,dx=b.x-a.x,dy=b.y-a.y;if(db&&(dx||dy)){var da=b.r+c.r,dc=dx*dx+dy*dy;da*=da;db*=db;var x=.5+(db-da)/(2*dc),y=Math.sqrt(Math.max(0,2*da*(db+dc)-(db-=dc)*db-da*da))/(2*dc);c.x=a.x+x*dx+y*dy;c.y=a.y+x*dy-y*dx;}else{c.x=a.x+db;c.y=a.y;}}d3.layout.tree=function(){var hierarchy=d3.layout.hierarchy().sort(null).value(null),separation=d3_layout_treeSeparation,size=[1,1],nodeSize=null;function tree(d,i){var nodes=hierarchy.call(this,d,i),root0=nodes[0],root1=wrapTree(root0);d3_layout_hierarchyVisitAfter(root1,firstWalk),root1.parent.m=-root1.z;d3_layout_hierarchyVisitBefore(root1,secondWalk);if(nodeSize)d3_layout_hierarchyVisitBefore(root0,sizeNode);else{var left=root0,right=root0,bottom=root0;d3_layout_hierarchyVisitBefore(root0,function(node){if(node.x<left.x)left=node;if(node.x>right.x)right=node;if(node.depth>bottom.depth)bottom=node;});var tx=separation(left,right)/2-left.x,kx=size[0]/(right.x+separation(right,left)/2+tx),ky=size[1]/(bottom.depth||1);d3_layout_hierarchyVisitBefore(root0,function(node){node.x=(node.x+tx)*kx;node.y=node.depth*ky;});}return nodes;}function wrapTree(root0){var root1={A:null,children:[root0]},queue=[root1],node1;while((node1=queue.pop())!=null){for(var children=node1.children,child,i=0,n=children.length;i<n;++i){queue.push((children[i]=child={_:children[i],parent:node1,children:(child=children[i].children)&&child.slice()||[],A:null,a:null,z:0,m:0,c:0,s:0,t:null,i:i}).a=child);}}return root1.children[0];}function firstWalk(v){var children=v.children,siblings=v.parent.children,w=v.i?siblings[v.i-1]:null;if(children.length){d3_layout_treeShift(v);var midpoint=(children[0].z+children[children.length-1].z)/2;if(w){v.z=w.z+separation(v._,w._);v.m=v.z-midpoint;}else{v.z=midpoint;}}else if(w){v.z=w.z+separation(v._,w._);}v.parent.A=apportion(v,w,v.parent.A||siblings[0]);}function secondWalk(v){v._.x=v.z+v.parent.m;v.m+=v.parent.m;}function apportion(v,w,ancestor){if(w){var vip=v,vop=v,vim=w,vom=vip.parent.children[0],sip=vip.m,sop=vop.m,sim=vim.m,som=vom.m,shift;while(vim=d3_layout_treeRight(vim),vip=d3_layout_treeLeft(vip),vim&&vip){vom=d3_layout_treeLeft(vom);vop=d3_layout_treeRight(vop);vop.a=v;shift=vim.z+sim-vip.z-sip+separation(vim._,vip._);if(shift>0){d3_layout_treeMove(d3_layout_treeAncestor(vim,v,ancestor),v,shift);sip+=shift;sop+=shift;}sim+=vim.m;sip+=vip.m;som+=vom.m;sop+=vop.m;}if(vim&&!d3_layout_treeRight(vop)){vop.t=vim;vop.m+=sim-sop;}if(vip&&!d3_layout_treeLeft(vom)){vom.t=vip;vom.m+=sip-som;ancestor=v;}}return ancestor;}function sizeNode(node){node.x*=size[0];node.y=node.depth*size[1];}tree.separation=function(x){if(!arguments.length)return separation;separation=x;return tree;};tree.size=function(x){if(!arguments.length)return nodeSize?null:size;nodeSize=(size=x)==null?sizeNode:null;return tree;};tree.nodeSize=function(x){if(!arguments.length)return nodeSize?size:null;nodeSize=(size=x)==null?null:sizeNode;return tree;};return d3_layout_hierarchyRebind(tree,hierarchy);};function d3_layout_treeSeparation(a,b){return a.parent==b.parent?1:2;}function d3_layout_treeLeft(v){var children=v.children;return children.length?children[0]:v.t;}function d3_layout_treeRight(v){var children=v.children,n;return(n=children.length)?children[n-1]:v.t;}function d3_layout_treeMove(wm,wp,shift){var change=shift/(wp.i-wm.i);wp.c-=change;wp.s+=shift;wm.c+=change;wp.z+=shift;wp.m+=shift;}function d3_layout_treeShift(v){var shift=0,change=0,children=v.children,i=children.length,w;while(--i>=0){w=children[i];w.z+=shift;w.m+=shift;shift+=w.s+(change+=w.c);}}function d3_layout_treeAncestor(vim,v,ancestor){return vim.a.parent===v.parent?vim.a:ancestor;}d3.layout.cluster=function(){var hierarchy=d3.layout.hierarchy().sort(null).value(null),separation=d3_layout_treeSeparation,size=[1,1],nodeSize=false;function cluster(d,i){var nodes=hierarchy.call(this,d,i),root=nodes[0],previousNode,x=0;d3_layout_hierarchyVisitAfter(root,function(node){var children=node.children;if(children&&children.length){node.x=d3_layout_clusterX(children);node.y=d3_layout_clusterY(children);}else{node.x=previousNode?x+=separation(node,previousNode):0;node.y=0;previousNode=node;}});var left=d3_layout_clusterLeft(root),right=d3_layout_clusterRight(root),x0=left.x-separation(left,right)/2,x1=right.x+separation(right,left)/2;d3_layout_hierarchyVisitAfter(root,nodeSize?function(node){node.x=(node.x-root.x)*size[0];node.y=(root.y-node.y)*size[1];}:function(node){node.x=(node.x-x0)/(x1-x0)*size[0];node.y=(1-(root.y?node.y/root.y:1))*size[1];});return nodes;}cluster.separation=function(x){if(!arguments.length)return separation;separation=x;return cluster;};cluster.size=function(x){if(!arguments.length)return nodeSize?null:size;nodeSize=(size=x)==null;return cluster;};cluster.nodeSize=function(x){if(!arguments.length)return nodeSize?size:null;nodeSize=(size=x)!=null;return cluster;};return d3_layout_hierarchyRebind(cluster,hierarchy);};function d3_layout_clusterY(children){return 1+d3.max(children,function(child){return child.y;});}function d3_layout_clusterX(children){return children.reduce(function(x,child){return x+child.x;},0)/children.length;}function d3_layout_clusterLeft(node){var children=node.children;return children&&children.length?d3_layout_clusterLeft(children[0]):node;}function d3_layout_clusterRight(node){var children=node.children,n;return children&&(n=children.length)?d3_layout_clusterRight(children[n-1]):node;}d3.layout.treemap=function(){var hierarchy=d3.layout.hierarchy(),round=Math.round,size=[1,1],padding=null,pad=d3_layout_treemapPadNull,sticky=false,stickies,mode="squarify",ratio=.5*(1+Math.sqrt(5));function scale(children,k){var i=-1,n=children.length,child,area;while(++i<n){area=(child=children[i]).value*(k<0?0:k);child.area=isNaN(area)||area<=0?0:area;}}function squarify(node){var children=node.children;if(children&&children.length){var rect=pad(node),row=[],remaining=children.slice(),child,best=Infinity,score,u=mode==="slice"?rect.dx:mode==="dice"?rect.dy:mode==="slice-dice"?node.depth&1?rect.dy:rect.dx:Math.min(rect.dx,rect.dy),n;scale(remaining,rect.dx*rect.dy/node.value);row.area=0;while((n=remaining.length)>0){row.push(child=remaining[n-1]);row.area+=child.area;if(mode!=="squarify"||(score=worst(row,u))<=best){remaining.pop();best=score;}else{row.area-=row.pop().area;position(row,u,rect,false);u=Math.min(rect.dx,rect.dy);row.length=row.area=0;best=Infinity;}}if(row.length){position(row,u,rect,true);row.length=row.area=0;}children.forEach(squarify);}}function stickify(node){var children=node.children;if(children&&children.length){var rect=pad(node),remaining=children.slice(),child,row=[];scale(remaining,rect.dx*rect.dy/node.value);row.area=0;while(child=remaining.pop()){row.push(child);row.area+=child.area;if(child.z!=null){position(row,child.z?rect.dx:rect.dy,rect,!remaining.length);row.length=row.area=0;}}children.forEach(stickify);}}function worst(row,u){var s=row.area,r,rmax=0,rmin=Infinity,i=-1,n=row.length;while(++i<n){if(!(r=row[i].area))continue;if(r<rmin)rmin=r;if(r>rmax)rmax=r;}s*=s;u*=u;return s?Math.max(u*rmax*ratio/s,s/(u*rmin*ratio)):Infinity;}function position(row,u,rect,flush){var i=-1,n=row.length,x=rect.x,y=rect.y,v=u?round(row.area/u):0,o;if(u==rect.dx){if(flush||v>rect.dy)v=rect.dy;while(++i<n){o=row[i];o.x=x;o.y=y;o.dy=v;x+=o.dx=Math.min(rect.x+rect.dx-x,v?round(o.area/v):0);}o.z=true;o.dx+=rect.x+rect.dx-x;rect.y+=v;rect.dy-=v;}else{if(flush||v>rect.dx)v=rect.dx;while(++i<n){o=row[i];o.x=x;o.y=y;o.dx=v;y+=o.dy=Math.min(rect.y+rect.dy-y,v?round(o.area/v):0);}o.z=false;o.dy+=rect.y+rect.dy-y;rect.x+=v;rect.dx-=v;}}function treemap(d){var nodes=stickies||hierarchy(d),root=nodes[0];root.x=root.y=0;if(root.value)root.dx=size[0],root.dy=size[1];else root.dx=root.dy=0;if(stickies)hierarchy.revalue(root);scale([root],root.dx*root.dy/root.value);(stickies?stickify:squarify)(root);if(sticky)stickies=nodes;return nodes;}treemap.size=function(x){if(!arguments.length)return size;size=x;return treemap;};treemap.padding=function(x){if(!arguments.length)return padding;function padFunction(node){var p=x.call(treemap,node,node.depth);return p==null?d3_layout_treemapPadNull(node):d3_layout_treemapPad(node,typeof p==="number"?[p,p,p,p]:p);}function padConstant(node){return d3_layout_treemapPad(node,x);}var type;pad=(padding=x)==null?d3_layout_treemapPadNull:(type=_typeof(x))==="function"?padFunction:type==="number"?(x=[x,x,x,x],padConstant):padConstant;return treemap;};treemap.round=function(x){if(!arguments.length)return round!=Number;round=x?Math.round:Number;return treemap;};treemap.sticky=function(x){if(!arguments.length)return sticky;sticky=x;stickies=null;return treemap;};treemap.ratio=function(x){if(!arguments.length)return ratio;ratio=x;return treemap;};treemap.mode=function(x){if(!arguments.length)return mode;mode=x+"";return treemap;};return d3_layout_hierarchyRebind(treemap,hierarchy);};function d3_layout_treemapPadNull(node){return{x:node.x,y:node.y,dx:node.dx,dy:node.dy};}function d3_layout_treemapPad(node,padding){var x=node.x+padding[3],y=node.y+padding[0],dx=node.dx-padding[1]-padding[3],dy=node.dy-padding[0]-padding[2];if(dx<0){x+=dx/2;dx=0;}if(dy<0){y+=dy/2;dy=0;}return{x:x,y:y,dx:dx,dy:dy};}d3.random={normal:function normal(,){var n=arguments.length;if(n<2)=1;if(n<1)=0;return function(){var x,y,r;do{x=Math.random()*2-1;y=Math.random()*2-1;r=x*x+y*y;}while(!r||r>1);return +*x*Math.sqrt(-2*Math.log(r)/r);};},logNormal:function logNormal(){var random=d3.random.normal.apply(d3,arguments);return function(){return Math.exp(random());};},bates:function bates(m){var random=d3.random.irwinHall(m);return function(){return random()/m;};},irwinHall:function irwinHall(m){return function(){for(var s=0,j=0;j<m;j++){s+=Math.random();}return s;};}};d3.scale={};function d3_scaleExtent(domain){var start=domain[0],stop=domain[domain.length-1];return start<stop?[start,stop]:[stop,start];}function d3_scaleRange(scale){return scale.rangeExtent?scale.rangeExtent():d3_scaleExtent(scale.range());}function d3_scale_bilinear(domain,range,uninterpolate,interpolate){var u=uninterpolate(domain[0],domain[1]),i=interpolate(range[0],range[1]);return function(x){return i(u(x));};}function d3_scale_nice(domain,nice){var i0=0,i1=domain.length-1,x0=domain[i0],x1=domain[i1],dx;if(x1<x0){dx=i0,i0=i1,i1=dx;dx=x0,x0=x1,x1=dx;}domain[i0]=nice.floor(x0);domain[i1]=nice.ceil(x1);return domain;}function d3_scale_niceStep(step){return step?{floor:function floor(x){return Math.floor(x/step)*step;},ceil:function ceil(x){return Math.ceil(x/step)*step;}}:d3_scale_niceIdentity;}var d3_scale_niceIdentity={floor:d3_identity,ceil:d3_identity};function d3_scale_polylinear(domain,range,uninterpolate,interpolate){var u=[],i=[],j=0,k=Math.min(domain.length,range.length)-1;if(domain[k]<domain[0]){domain=domain.slice().reverse();range=range.slice().reverse();}while(++j<=k){u.push(uninterpolate(domain[j-1],domain[j]));i.push(interpolate(range[j-1],range[j]));}return function(x){var j=d3.bisect(domain,x,1,k)-1;return i[j](u[j](x));};}d3.scale.linear=function(){return d3_scale_linear([0,1],[0,1],d3_interpolate,false);};function d3_scale_linear(domain,range,interpolate,clamp){var output,input;function rescale(){var linear=Math.min(domain.length,range.length)>2?d3_scale_polylinear:d3_scale_bilinear,uninterpolate=clamp?d3_uninterpolateClamp:d3_uninterpolateNumber;output=linear(domain,range,uninterpolate,interpolate);input=linear(range,domain,uninterpolate,d3_interpolate);return scale;}function scale(x){return output(x);}scale.invert=function(y){return input(y);};scale.domain=function(x){if(!arguments.length)return domain;domain=x.map(Number);return rescale();};scale.range=function(x){if(!arguments.length)return range;range=x;return rescale();};scale.rangeRound=function(x){return scale.range(x).interpolate(d3_interpolateRound);};scale.clamp=function(x){if(!arguments.length)return clamp;clamp=x;return rescale();};scale.interpolate=function(x){if(!arguments.length)return interpolate;interpolate=x;return rescale();};scale.ticks=function(m){return d3_scale_linearTicks(domain,m);};scale.tickFormat=function(m,format){return d3_scale_linearTickFormat(domain,m,format);};scale.nice=function(m){d3_scale_linearNice(domain,m);return rescale();};scale.copy=function(){return d3_scale_linear(domain,range,interpolate,clamp);};return rescale();}function d3_scale_linearRebind(scale,linear){return d3.rebind(scale,linear,"range","rangeRound","interpolate","clamp");}function d3_scale_linearNice(domain,m){d3_scale_nice(domain,d3_scale_niceStep(d3_scale_linearTickRange(domain,m)[2]));d3_scale_nice(domain,d3_scale_niceStep(d3_scale_linearTickRange(domain,m)[2]));return domain;}function d3_scale_linearTickRange(domain,m){if(m==null)m=10;var extent=d3_scaleExtent(domain),span=extent[1]-extent[0],step=Math.pow(10,Math.floor(Math.log(span/m)/Math.LN10)),err=m/span*step;if(err<=.15)step*=10;else if(err<=.35)step*=5;else if(err<=.75)step*=2;extent[0]=Math.ceil(extent[0]/step)*step;extent[1]=Math.floor(extent[1]/step)*step+step*.5;extent[2]=step;return extent;}function d3_scale_linearTicks(domain,m){return d3.range.apply(d3,d3_scale_linearTickRange(domain,m));}function d3_scale_linearTickFormat(domain,m,format){var range=d3_scale_linearTickRange(domain,m);if(format){var match=d3_format_re.exec(format);match.shift();if(match[8]==="s"){var prefix=d3.formatPrefix(Math.max(abs(range[0]),abs(range[1])));if(!match[7])match[7]="."+d3_scale_linearPrecision(prefix.scale(range[2]));match[8]="f";format=d3.format(match.join(""));return function(d){return format(prefix.scale(d))+prefix.symbol;};}if(!match[7])match[7]="."+d3_scale_linearFormatPrecision(match[8],range);format=match.join("");}else{format=",."+d3_scale_linearPrecision(range[2])+"f";}return d3.format(format);}var d3_scale_linearFormatSignificant={s:1,g:1,p:1,r:1,e:1};function d3_scale_linearPrecision(value){return-Math.floor(Math.log(value)/Math.LN10+.01);}function d3_scale_linearFormatPrecision(type,range){var p=d3_scale_linearPrecision(range[2]);return type in d3_scale_linearFormatSignificant?Math.abs(p-d3_scale_linearPrecision(Math.max(abs(range[0]),abs(range[1]))))+ +(type!=="e"):p-(type==="%")*2;}d3.scale.log=function(){return d3_scale_log(d3.scale.linear().domain([0,1]),10,true,[1,10]);};function d3_scale_log(linear,base,positive,domain){function log(x){return(positive?Math.log(x<0?0:x):-Math.log(x>0?0:-x))/Math.log(base);}function pow(x){return positive?Math.pow(base,x):-Math.pow(base,-x);}function scale(x){return linear(log(x));}scale.invert=function(x){return pow(linear.invert(x));};scale.domain=function(x){if(!arguments.length)return domain;positive=x[0]>=0;linear.domain((domain=x.map(Number)).map(log));return scale;};scale.base=function(_){if(!arguments.length)return base;base=+_;linear.domain(domain.map(log));return scale;};scale.nice=function(){var niced=d3_scale_nice(domain.map(log),positive?Math:d3_scale_logNiceNegative);linear.domain(niced);domain=niced.map(pow);return scale;};scale.ticks=function(){var extent=d3_scaleExtent(domain),ticks=[],u=extent[0],v=extent[1],i=Math.floor(log(u)),j=Math.ceil(log(v)),n=base%1?2:base;if(isFinite(j-i)){if(positive){for(;i<j;i++){for(var k=1;k<n;k++){ticks.push(pow(i)*k);}}ticks.push(pow(i));}else{ticks.push(pow(i));for(;i++<j;){for(var k=n-1;k>0;k--){ticks.push(pow(i)*k);}}}for(i=0;ticks[i]<u;i++){}for(j=ticks.length;ticks[j-1]>v;j--){}ticks=ticks.slice(i,j);}return ticks;};scale.tickFormat=function(n,format){if(!arguments.length)return d3_scale_logFormat;if(arguments.length<2)format=d3_scale_logFormat;else if(typeof format!=="function")format=d3.format(format);var k=Math.max(1,base*n/scale.ticks().length);return function(d){var i=d/pow(Math.round(log(d)));if(i*base<base-.5)i*=base;return i<=k?format(d):"";};};scale.copy=function(){return d3_scale_log(linear.copy(),base,positive,domain);};return d3_scale_linearRebind(scale,linear);}var d3_scale_logFormat=d3.format(".0e"),d3_scale_logNiceNegative={floor:function floor(x){return-Math.ceil(-x);},ceil:function ceil(x){return-Math.floor(-x);}};d3.scale.pow=function(){return d3_scale_pow(d3.scale.linear(),1,[0,1]);};function d3_scale_pow(linear,exponent,domain){var powp=d3_scale_powPow(exponent),powb=d3_scale_powPow(1/exponent);function scale(x){return linear(powp(x));}scale.invert=function(x){return powb(linear.invert(x));};scale.domain=function(x){if(!arguments.length)return domain;linear.domain((domain=x.map(Number)).map(powp));return scale;};scale.ticks=function(m){return d3_scale_linearTicks(domain,m);};scale.tickFormat=function(m,format){return d3_scale_linearTickFormat(domain,m,format);};scale.nice=function(m){return scale.domain(d3_scale_linearNice(domain,m));};scale.exponent=function(x){if(!arguments.length)return exponent;powp=d3_scale_powPow(exponent=x);powb=d3_scale_powPow(1/exponent);linear.domain(domain.map(powp));return scale;};scale.copy=function(){return d3_scale_pow(linear.copy(),exponent,domain);};return d3_scale_linearRebind(scale,linear);}function d3_scale_powPow(e){return function(x){return x<0?-Math.pow(-x,e):Math.pow(x,e);};}d3.scale.sqrt=function(){return d3.scale.pow().exponent(.5);};d3.scale.ordinal=function(){return d3_scale_ordinal([],{t:"range",a:[[]]});};function d3_scale_ordinal(domain,ranger){var index,range,rangeBand;function scale(x){return range[((index.get(x)||(ranger.t==="range"?index.set(x,domain.push(x)):NaN))-1)%range.length];}function steps(start,step){return d3.range(domain.length).map(function(i){return start+step*i;});}scale.domain=function(x){if(!arguments.length)return domain;domain=[];index=new d3_Map();var i=-1,n=x.length,xi;while(++i<n){if(!index.has(xi=x[i]))index.set(xi,domain.push(xi));}return scale[ranger.t].apply(scale,ranger.a);};scale.range=function(x){if(!arguments.length)return range;range=x;rangeBand=0;ranger={t:"range",a:arguments};return scale;};scale.rangePoints=function(x,padding){if(arguments.length<2)padding=0;var start=x[0],stop=x[1],step=domain.length<2?(start=(start+stop)/2,0):(stop-start)/(domain.length-1+padding);range=steps(start+step*padding/2,step);rangeBand=0;ranger={t:"rangePoints",a:arguments};return scale;};scale.rangeRoundPoints=function(x,padding){if(arguments.length<2)padding=0;var start=x[0],stop=x[1],step=domain.length<2?(start=stop=Math.round((start+stop)/2),0):(stop-start)/(domain.length-1+padding)|0;range=steps(start+Math.round(step*padding/2+(stop-start-(domain.length-1+padding)*step)/2),step);rangeBand=0;ranger={t:"rangeRoundPoints",a:arguments};return scale;};scale.rangeBands=function(x,padding,outerPadding){if(arguments.length<2)padding=0;if(arguments.length<3)outerPadding=padding;var reverse=x[1]<x[0],start=x[reverse-0],stop=x[1-reverse],step=(stop-start)/(domain.length-padding+2*outerPadding);range=steps(start+step*outerPadding,step);if(reverse)range.reverse();rangeBand=step*(1-padding);ranger={t:"rangeBands",a:arguments};return scale;};scale.rangeRoundBands=function(x,padding,outerPadding){if(arguments.length<2)padding=0;if(arguments.length<3)outerPadding=padding;var reverse=x[1]<x[0],start=x[reverse-0],stop=x[1-reverse],step=Math.floor((stop-start)/(domain.length-padding+2*outerPadding));range=steps(start+Math.round((stop-start-(domain.length-padding)*step)/2),step);if(reverse)range.reverse();rangeBand=Math.round(step*(1-padding));ranger={t:"rangeRoundBands",a:arguments};return scale;};scale.rangeBand=function(){return rangeBand;};scale.rangeExtent=function(){return d3_scaleExtent(ranger.a[0]);};scale.copy=function(){return d3_scale_ordinal(domain,ranger);};return scale.domain(domain);}d3.scale.category10=function(){return d3.scale.ordinal().range(d3_category10);};d3.scale.category20=function(){return d3.scale.ordinal().range(d3_category20);};d3.scale.category20b=function(){return d3.scale.ordinal().range(d3_category20b);};d3.scale.category20c=function(){return d3.scale.ordinal().range(d3_category20c);};var d3_category10=[2062260,16744206,2924588,14034728,9725885,9197131,14907330,8355711,12369186,1556175].map(d3_rgbString);var d3_category20=[2062260,11454440,16744206,16759672,2924588,10018698,14034728,16750742,9725885,12955861,9197131,12885140,14907330,16234194,8355711,13092807,12369186,14408589,1556175,10410725].map(d3_rgbString);var d3_category20b=[3750777,5395619,7040719,10264286,6519097,9216594,11915115,13556636,9202993,12426809,15186514,15190932,8666169,11356490,14049643,15177372,8077683,10834324,13528509,14589654].map(d3_rgbString);var d3_category20c=[3244733,7057110,10406625,13032431,15095053,16616764,16625259,16634018,3253076,7652470,10607003,13101504,7695281,10394312,12369372,14342891,6513507,9868950,12434877,14277081].map(d3_rgbString);d3.scale.quantile=function(){return d3_scale_quantile([],[]);};function d3_scale_quantile(domain,range){var thresholds;function rescale(){var k=0,q=range.length;thresholds=[];while(++k<q){thresholds[k-1]=d3.quantile(domain,k/q);}return scale;}function scale(x){if(!isNaN(x=+x))return range[d3.bisect(thresholds,x)];}scale.domain=function(x){if(!arguments.length)return domain;domain=x.map(d3_number).filter(d3_numeric).sort(d3_ascending);return rescale();};scale.range=function(x){if(!arguments.length)return range;range=x;return rescale();};scale.quantiles=function(){return thresholds;};scale.invertExtent=function(y){y=range.indexOf(y);return y<0?[NaN,NaN]:[y>0?thresholds[y-1]:domain[0],y<thresholds.length?thresholds[y]:domain[domain.length-1]];};scale.copy=function(){return d3_scale_quantile(domain,range);};return rescale();}d3.scale.quantize=function(){return d3_scale_quantize(0,1,[0,1]);};function d3_scale_quantize(x0,x1,range){var kx,i;function scale(x){return range[Math.max(0,Math.min(i,Math.floor(kx*(x-x0))))];}function rescale(){kx=range.length/(x1-x0);i=range.length-1;return scale;}scale.domain=function(x){if(!arguments.length)return[x0,x1];x0=+x[0];x1=+x[x.length-1];return rescale();};scale.range=function(x){if(!arguments.length)return range;range=x;return rescale();};scale.invertExtent=function(y){y=range.indexOf(y);y=y<0?NaN:y/kx+x0;return[y,y+1/kx];};scale.copy=function(){return d3_scale_quantize(x0,x1,range);};return rescale();}d3.scale.threshold=function(){return d3_scale_threshold([.5],[0,1]);};function d3_scale_threshold(domain,range){function scale(x){if(x<=x)return range[d3.bisect(domain,x)];}scale.domain=function(_){if(!arguments.length)return domain;domain=_;return scale;};scale.range=function(_){if(!arguments.length)return range;range=_;return scale;};scale.invertExtent=function(y){y=range.indexOf(y);return[domain[y-1],domain[y]];};scale.copy=function(){return d3_scale_threshold(domain,range);};return scale;}d3.scale.identity=function(){return d3_scale_identity([0,1]);};function d3_scale_identity(domain){function identity(x){return+x;}identity.invert=identity;identity.domain=identity.range=function(x){if(!arguments.length)return domain;domain=x.map(identity);return identity;};identity.ticks=function(m){return d3_scale_linearTicks(domain,m);};identity.tickFormat=function(m,format){return d3_scale_linearTickFormat(domain,m,format);};identity.copy=function(){return d3_scale_identity(domain);};return identity;}d3.svg={};function d3_zero(){return 0;}d3.svg.arc=function(){var innerRadius=d3_svg_arcInnerRadius,outerRadius=d3_svg_arcOuterRadius,cornerRadius=d3_zero,padRadius=d3_svg_arcAuto,startAngle=d3_svg_arcStartAngle,endAngle=d3_svg_arcEndAngle,padAngle=d3_svg_arcPadAngle;function arc(){var r0=Math.max(0,+innerRadius.apply(this,arguments)),r1=Math.max(0,+outerRadius.apply(this,arguments)),a0=startAngle.apply(this,arguments)-half,a1=endAngle.apply(this,arguments)-half,da=Math.abs(a1-a0),cw=a0>a1?0:1;if(r1<r0)rc=r1,r1=r0,r0=rc;if(da>=)return circleSegment(r1,cw)+(r0?circleSegment(r0,1-cw):"")+"Z";var rc,cr,rp,ap,p0=0,p1=0,x0,y0,x1,y1,x2,y2,x3,y3,path=[];if(ap=(+padAngle.apply(this,arguments)||0)/2){rp=padRadius===d3_svg_arcAuto?Math.sqrt(r0*r0+r1*r1):+padRadius.apply(this,arguments);if(!cw)p1*=-1;if(r1)p1=d3_asin(rp/r1*Math.sin(ap));if(r0)p0=d3_asin(rp/r0*Math.sin(ap));}if(r1){x0=r1*Math.cos(a0+p1);y0=r1*Math.sin(a0+p1);x1=r1*Math.cos(a1-p1);y1=r1*Math.sin(a1-p1);var l1=Math.abs(a1-a0-2*p1)<=?0:1;if(p1&&d3_svg_arcSweep(x0,y0,x1,y1)===cw^l1){var h1=(a0+a1)/2;x0=r1*Math.cos(h1);y0=r1*Math.sin(h1);x1=y1=null;}}else{x0=y0=0;}if(r0){x2=r0*Math.cos(a1-p0);y2=r0*Math.sin(a1-p0);x3=r0*Math.cos(a0+p0);y3=r0*Math.sin(a0+p0);var l0=Math.abs(a0-a1+2*p0)<=?0:1;if(p0&&d3_svg_arcSweep(x2,y2,x3,y3)===1-cw^l0){var h0=(a0+a1)/2;x2=r0*Math.cos(h0);y2=r0*Math.sin(h0);x3=y3=null;}}else{x2=y2=0;}if(da>&&(rc=Math.min(Math.abs(r1-r0)/2,+cornerRadius.apply(this,arguments)))>.001){cr=r0<r1^cw?0:1;var rc1=rc,rc0=rc;if(da<){var oc=x3==null?[x2,y2]:x1==null?[x0,y0]:d3_geom_polygonIntersect([x0,y0],[x3,y3],[x1,y1],[x2,y2]),ax=x0-oc[0],ay=y0-oc[1],bx=x1-oc[0],by=y1-oc[1],kc=1/Math.sin(Math.acos((ax*bx+ay*by)/(Math.sqrt(ax*ax+ay*ay)*Math.sqrt(bx*bx+by*by)))/2),lc=Math.sqrt(oc[0]*oc[0]+oc[1]*oc[1]);rc0=Math.min(rc,(r0-lc)/(kc-1));rc1=Math.min(rc,(r1-lc)/(kc+1));}if(x1!=null){var t30=d3_svg_arcCornerTangents(x3==null?[x2,y2]:[x3,y3],[x0,y0],r1,rc1,cw),t12=d3_svg_arcCornerTangents([x1,y1],[x2,y2],r1,rc1,cw);if(rc===rc1){path.push("M",t30[0],"A",rc1,",",rc1," 0 0,",cr," ",t30[1],"A",r1,",",r1," 0 ",1-cw^d3_svg_arcSweep(t30[1][0],t30[1][1],t12[1][0],t12[1][1]),",",cw," ",t12[1],"A",rc1,",",rc1," 0 0,",cr," ",t12[0]);}else{path.push("M",t30[0],"A",rc1,",",rc1," 0 1,",cr," ",t12[0]);}}else{path.push("M",x0,",",y0);}if(x3!=null){var t03=d3_svg_arcCornerTangents([x0,y0],[x3,y3],r0,-rc0,cw),t21=d3_svg_arcCornerTangents([x2,y2],x1==null?[x0,y0]:[x1,y1],r0,-rc0,cw);if(rc===rc0){path.push("L",t21[0],"A",rc0,",",rc0," 0 0,",cr," ",t21[1],"A",r0,",",r0," 0 ",cw^d3_svg_arcSweep(t21[1][0],t21[1][1],t03[1][0],t03[1][1]),",",1-cw," ",t03[1],"A",rc0,",",rc0," 0 0,",cr," ",t03[0]);}else{path.push("L",t21[0],"A",rc0,",",rc0," 0 0,",cr," ",t03[0]);}}else{path.push("L",x2,",",y2);}}else{path.push("M",x0,",",y0);if(x1!=null)path.push("A",r1,",",r1," 0 ",l1,",",cw," ",x1,",",y1);path.push("L",x2,",",y2);if(x3!=null)path.push("A",r0,",",r0," 0 ",l0,",",1-cw," ",x3,",",y3);}path.push("Z");return path.join("");}function circleSegment(r1,cw){return"M0,"+r1+"A"+r1+","+r1+" 0 1,"+cw+" 0,"+-r1+"A"+r1+","+r1+" 0 1,"+cw+" 0,"+r1;}arc.innerRadius=function(v){if(!arguments.length)return innerRadius;innerRadius=d3_functor(v);return arc;};arc.outerRadius=function(v){if(!arguments.length)return outerRadius;outerRadius=d3_functor(v);return arc;};arc.cornerRadius=function(v){if(!arguments.length)return cornerRadius;cornerRadius=d3_functor(v);return arc;};arc.padRadius=function(v){if(!arguments.length)return padRadius;padRadius=v==d3_svg_arcAuto?d3_svg_arcAuto:d3_functor(v);return arc;};arc.startAngle=function(v){if(!arguments.length)return startAngle;startAngle=d3_functor(v);return arc;};arc.endAngle=function(v){if(!arguments.length)return endAngle;endAngle=d3_functor(v);return arc;};arc.padAngle=function(v){if(!arguments.length)return padAngle;padAngle=d3_functor(v);return arc;};arc.centroid=function(){var r=(+innerRadius.apply(this,arguments)+ +outerRadius.apply(this,arguments))/2,a=(+startAngle.apply(this,arguments)+ +endAngle.apply(this,arguments))/2-half;return[Math.cos(a)*r,Math.sin(a)*r];};return arc;};var d3_svg_arcAuto="auto";function d3_svg_arcInnerRadius(d){return d.innerRadius;}function d3_svg_arcOuterRadius(d){return d.outerRadius;}function d3_svg_arcStartAngle(d){return d.startAngle;}function d3_svg_arcEndAngle(d){return d.endAngle;}function d3_svg_arcPadAngle(d){return d&&d.padAngle;}function d3_svg_arcSweep(x0,y0,x1,y1){return(x0-x1)*y0-(y0-y1)*x0>0?0:1;}function d3_svg_arcCornerTangents(p0,p1,r1,rc,cw){var x01=p0[0]-p1[0],y01=p0[1]-p1[1],lo=(cw?rc:-rc)/Math.sqrt(x01*x01+y01*y01),ox=lo*y01,oy=-lo*x01,x1=p0[0]+ox,y1=p0[1]+oy,x2=p1[0]+ox,y2=p1[1]+oy,x3=(x1+x2)/2,y3=(y1+y2)/2,dx=x2-x1,dy=y2-y1,d2=dx*dx+dy*dy,r=r1-rc,D=x1*y2-x2*y1,d=(dy<0?-1:1)*Math.sqrt(Math.max(0,r*r*d2-D*D)),cx0=(D*dy-dx*d)/d2,cy0=(-D*dx-dy*d)/d2,cx1=(D*dy+dx*d)/d2,cy1=(-D*dx+dy*d)/d2,dx0=cx0-x3,dy0=cy0-y3,dx1=cx1-x3,dy1=cy1-y3;if(dx0*dx0+dy0*dy0>dx1*dx1+dy1*dy1)cx0=cx1,cy0=cy1;return[[cx0-ox,cy0-oy],[cx0*r1/r,cy0*r1/r]];}function d3_svg_line(projection){var x=d3_geom_pointX,y=d3_geom_pointY,defined=d3_true,interpolate=d3_svg_lineLinear,interpolateKey=interpolate.key,tension=.7;function line(data){var segments=[],points=[],i=-1,n=data.length,d,fx=d3_functor(x),fy=d3_functor(y);function segment(){segments.push("M",interpolate(projection(points),tension));}while(++i<n){if(defined.call(this,d=data[i],i)){points.push([+fx.call(this,d,i),+fy.call(this,d,i)]);}else if(points.length){segment();points=[];}}if(points.length)segment();return segments.length?segments.join(""):null;}line.x=function(_){if(!arguments.length)return x;x=_;return line;};line.y=function(_){if(!arguments.length)return y;y=_;return line;};line.defined=function(_){if(!arguments.length)return defined;defined=_;return line;};line.interpolate=function(_){if(!arguments.length)return interpolateKey;if(typeof _==="function")interpolateKey=interpolate=_;else interpolateKey=(interpolate=d3_svg_lineInterpolators.get(_)||d3_svg_lineLinear).key;return line;};line.tension=function(_){if(!arguments.length)return tension;tension=_;return line;};return line;}d3.svg.line=function(){return d3_svg_line(d3_identity);};var d3_svg_lineInterpolators=d3.map({linear:d3_svg_lineLinear,"linear-closed":d3_svg_lineLinearClosed,step:d3_svg_lineStep,"step-before":d3_svg_lineStepBefore,"step-after":d3_svg_lineStepAfter,basis:d3_svg_lineBasis,"basis-open":d3_svg_lineBasisOpen,"basis-closed":d3_svg_lineBasisClosed,bundle:d3_svg_lineBundle,cardinal:d3_svg_lineCardinal,"cardinal-open":d3_svg_lineCardinalOpen,"cardinal-closed":d3_svg_lineCardinalClosed,monotone:d3_svg_lineMonotone});d3_svg_lineInterpolators.forEach(function(key,value){value.key=key;value.closed=/-closed$/.test(key);});function d3_svg_lineLinear(points){return points.length>1?points.join("L"):points+"Z";}function d3_svg_lineLinearClosed(points){return points.join("L")+"Z";}function d3_svg_lineStep(points){var i=0,n=points.length,p=points[0],path=[p[0],",",p[1]];while(++i<n){path.push("H",(p[0]+(p=points[i])[0])/2,"V",p[1]);}if(n>1)path.push("H",p[0]);return path.join("");}function d3_svg_lineStepBefore(points){var i=0,n=points.length,p=points[0],path=[p[0],",",p[1]];while(++i<n){path.push("V",(p=points[i])[1],"H",p[0]);}return path.join("");}function d3_svg_lineStepAfter(points){var i=0,n=points.length,p=points[0],path=[p[0],",",p[1]];while(++i<n){path.push("H",(p=points[i])[0],"V",p[1]);}return path.join("");}function d3_svg_lineCardinalOpen(points,tension){return points.length<4?d3_svg_lineLinear(points):points[1]+d3_svg_lineHermite(points.slice(1,-1),d3_svg_lineCardinalTangents(points,tension));}function d3_svg_lineCardinalClosed(points,tension){return points.length<3?d3_svg_lineLinearClosed(points):points[0]+d3_svg_lineHermite((points.push(points[0]),points),d3_svg_lineCardinalTangents([points[points.length-2]].concat(points,[points[1]]),tension));}function d3_svg_lineCardinal(points,tension){return points.length<3?d3_svg_lineLinear(points):points[0]+d3_svg_lineHermite(points,d3_svg_lineCardinalTangents(points,tension));}function d3_svg_lineHermite(points,tangents){if(tangents.length<1||points.length!=tangents.length&&points.length!=tangents.length+2){return d3_svg_lineLinear(points);}var quad=points.length!=tangents.length,path="",p0=points[0],p=points[1],t0=tangents[0],t=t0,pi=1;if(quad){path+="Q"+(p[0]-t0[0]*2/3)+","+(p[1]-t0[1]*2/3)+","+p[0]+","+p[1];p0=points[1];pi=2;}if(tangents.length>1){t=tangents[1];p=points[pi];pi++;path+="C"+(p0[0]+t0[0])+","+(p0[1]+t0[1])+","+(p[0]-t[0])+","+(p[1]-t[1])+","+p[0]+","+p[1];for(var i=2;i<tangents.length;i++,pi++){p=points[pi];t=tangents[i];path+="S"+(p[0]-t[0])+","+(p[1]-t[1])+","+p[0]+","+p[1];}}if(quad){var lp=points[pi];path+="Q"+(p[0]+t[0]*2/3)+","+(p[1]+t[1]*2/3)+","+lp[0]+","+lp[1];}return path;}function d3_svg_lineCardinalTangents(points,tension){var tangents=[],a=(1-tension)/2,p0,p1=points[0],p2=points[1],i=1,n=points.length;while(++i<n){p0=p1;p1=p2;p2=points[i];tangents.push([a*(p2[0]-p0[0]),a*(p2[1]-p0[1])]);}return tangents;}function d3_svg_lineBasis(points){if(points.length<3)return d3_svg_lineLinear(points);var i=1,n=points.length,pi=points[0],x0=pi[0],y0=pi[1],px=[x0,x0,x0,(pi=points[1])[0]],py=[y0,y0,y0,pi[1]],path=[x0,",",y0,"L",d3_svg_lineDot4(d3_svg_lineBasisBezier3,px),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,py)];points.push(points[n-1]);while(++i<=n){pi=points[i];px.shift();px.push(pi[0]);py.shift();py.push(pi[1]);d3_svg_lineBasisBezier(path,px,py);}points.pop();path.push("L",pi);return path.join("");}function d3_svg_lineBasisOpen(points){if(points.length<4)return d3_svg_lineLinear(points);var path=[],i=-1,n=points.length,pi,px=[0],py=[0];while(++i<3){pi=points[i];px.push(pi[0]);py.push(pi[1]);}path.push(d3_svg_lineDot4(d3_svg_lineBasisBezier3,px)+","+d3_svg_lineDot4(d3_svg_lineBasisBezier3,py));--i;while(++i<n){pi=points[i];px.shift();px.push(pi[0]);py.shift();py.push(pi[1]);d3_svg_lineBasisBezier(path,px,py);}return path.join("");}function d3_svg_lineBasisClosed(points){var path,i=-1,n=points.length,m=n+4,pi,px=[],py=[];while(++i<4){pi=points[i%n];px.push(pi[0]);py.push(pi[1]);}path=[d3_svg_lineDot4(d3_svg_lineBasisBezier3,px),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,py)];--i;while(++i<m){pi=points[i%n];px.shift();px.push(pi[0]);py.shift();py.push(pi[1]);d3_svg_lineBasisBezier(path,px,py);}return path.join("");}function d3_svg_lineBundle(points,tension){var n=points.length-1;if(n){var x0=points[0][0],y0=points[0][1],dx=points[n][0]-x0,dy=points[n][1]-y0,i=-1,p,t;while(++i<=n){p=points[i];t=i/n;p[0]=tension*p[0]+(1-tension)*(x0+t*dx);p[1]=tension*p[1]+(1-tension)*(y0+t*dy);}}return d3_svg_lineBasis(points);}function d3_svg_lineDot4(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3];}var d3_svg_lineBasisBezier1=[0,2/3,1/3,0],d3_svg_lineBasisBezier2=[0,1/3,2/3,0],d3_svg_lineBasisBezier3=[0,1/6,2/3,1/6];function d3_svg_lineBasisBezier(path,x,y){path.push("C",d3_svg_lineDot4(d3_svg_lineBasisBezier1,x),",",d3_svg_lineDot4(d3_svg_lineBasisBezier1,y),",",d3_svg_lineDot4(d3_svg_lineBasisBezier2,x),",",d3_svg_lineDot4(d3_svg_lineBasisBezier2,y),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,x),",",d3_svg_lineDot4(d3_svg_lineBasisBezier3,y));}function d3_svg_lineSlope(p0,p1){return(p1[1]-p0[1])/(p1[0]-p0[0]);}function d3_svg_lineFiniteDifferences(points){var i=0,j=points.length-1,m=[],p0=points[0],p1=points[1],d=m[0]=d3_svg_lineSlope(p0,p1);while(++i<j){m[i]=(d+(d=d3_svg_lineSlope(p0=p1,p1=points[i+1])))/2;}m[i]=d;return m;}function d3_svg_lineMonotoneTangents(points){var tangents=[],d,a,b,s,m=d3_svg_lineFiniteDifferences(points),i=-1,j=points.length-1;while(++i<j){d=d3_svg_lineSlope(points[i],points[i+1]);if(abs(d)<){m[i]=m[i+1]=0;}else{a=m[i]/d;b=m[i+1]/d;s=a*a+b*b;if(s>9){s=d*3/Math.sqrt(s);m[i]=s*a;m[i+1]=s*b;}}}i=-1;while(++i<=j){s=(points[Math.min(j,i+1)][0]-points[Math.max(0,i-1)][0])/(6*(1+m[i]*m[i]));tangents.push([s||0,m[i]*s||0]);}return tangents;}function d3_svg_lineMonotone(points){return points.length<3?d3_svg_lineLinear(points):points[0]+d3_svg_lineHermite(points,d3_svg_lineMonotoneTangents(points));}d3.svg.line.radial=function(){var line=d3_svg_line(d3_svg_lineRadial);line.radius=line.x,delete line.x;line.angle=line.y,delete line.y;return line;};function d3_svg_lineRadial(points){var point,i=-1,n=points.length,r,a;while(++i<n){point=points[i];r=point[0];a=point[1]-half;point[0]=r*Math.cos(a);point[1]=r*Math.sin(a);}return points;}function d3_svg_area(projection){var x0=d3_geom_pointX,x1=d3_geom_pointX,y0=0,y1=d3_geom_pointY,defined=d3_true,interpolate=d3_svg_lineLinear,interpolateKey=interpolate.key,interpolateReverse=interpolate,L="L",tension=.7;function area(data){var segments=[],points0=[],points1=[],i=-1,n=data.length,d,fx0=d3_functor(x0),fy0=d3_functor(y0),fx1=x0===x1?function(){return x;}:d3_functor(x1),fy1=y0===y1?function(){return y;}:d3_functor(y1),x,y;function segment(){segments.push("M",interpolate(projection(points1),tension),L,interpolateReverse(projection(points0.reverse()),tension),"Z");}while(++i<n){if(defined.call(this,d=data[i],i)){points0.push([x=+fx0.call(this,d,i),y=+fy0.call(this,d,i)]);points1.push([+fx1.call(this,d,i),+fy1.call(this,d,i)]);}else if(points0.length){segment();points0=[];points1=[];}}if(points0.length)segment();return segments.length?segments.join(""):null;}area.x=function(_){if(!arguments.length)return x1;x0=x1=_;return area;};area.x0=function(_){if(!arguments.length)return x0;x0=_;return area;};area.x1=function(_){if(!arguments.length)return x1;x1=_;return area;};area.y=function(_){if(!arguments.length)return y1;y0=y1=_;return area;};area.y0=function(_){if(!arguments.length)return y0;y0=_;return area;};area.y1=function(_){if(!arguments.length)return y1;y1=_;return area;};area.defined=function(_){if(!arguments.length)return defined;defined=_;return area;};area.interpolate=function(_){if(!arguments.length)return interpolateKey;if(typeof _==="function")interpolateKey=interpolate=_;else interpolateKey=(interpolate=d3_svg_lineInterpolators.get(_)||d3_svg_lineLinear).key;interpolateReverse=interpolate.reverse||interpolate;L=interpolate.closed?"M":"L";return area;};area.tension=function(_){if(!arguments.length)return tension;tension=_;return area;};return area;}d3_svg_lineStepBefore.reverse=d3_svg_lineStepAfter;d3_svg_lineStepAfter.reverse=d3_svg_lineStepBefore;d3.svg.area=function(){return d3_svg_area(d3_identity);};d3.svg.area.radial=function(){var area=d3_svg_area(d3_svg_lineRadial);area.radius=area.x,delete area.x;area.innerRadius=area.x0,delete area.x0;area.outerRadius=area.x1,delete area.x1;area.angle=area.y,delete area.y;area.startAngle=area.y0,delete area.y0;area.endAngle=area.y1,delete area.y1;return area;};d3.svg.chord=function(){var source=d3_source,target=d3_target,radius=d3_svg_chordRadius,startAngle=d3_svg_arcStartAngle,endAngle=d3_svg_arcEndAngle;function chord(d,i){var s=subgroup(this,source,d,i),t=subgroup(this,target,d,i);return"M"+s.p0+arc(s.r,s.p1,s.a1-s.a0)+(equals(s,t)?curve(s.r,s.p1,s.r,s.p0):curve(s.r,s.p1,t.r,t.p0)+arc(t.r,t.p1,t.a1-t.a0)+curve(t.r,t.p1,s.r,s.p0))+"Z";}function subgroup(self,f,d,i){var subgroup=f.call(self,d,i),r=radius.call(self,subgroup,i),a0=startAngle.call(self,subgroup,i)-half,a1=endAngle.call(self,subgroup,i)-half;return{r:r,a0:a0,a1:a1,p0:[r*Math.cos(a0),r*Math.sin(a0)],p1:[r*Math.cos(a1),r*Math.sin(a1)]};}function equals(a,b){return a.a0==b.a0&&a.a1==b.a1;}function arc(r,p,a){return"A"+r+","+r+" 0 "+ +(a>)+",1 "+p;}function curve(r0,p0,r1,p1){return"Q 0,0 "+p1;}chord.radius=function(v){if(!arguments.length)return radius;radius=d3_functor(v);return chord;};chord.source=function(v){if(!arguments.length)return source;source=d3_functor(v);return chord;};chord.target=function(v){if(!arguments.length)return target;target=d3_functor(v);return chord;};chord.startAngle=function(v){if(!arguments.length)return startAngle;startAngle=d3_functor(v);return chord;};chord.endAngle=function(v){if(!arguments.length)return endAngle;endAngle=d3_functor(v);return chord;};return chord;};function d3_svg_chordRadius(d){return d.radius;}d3.svg.diagonal=function(){var source=d3_source,target=d3_target,projection=d3_svg_diagonalProjection;function diagonal(d,i){var p0=source.call(this,d,i),p3=target.call(this,d,i),m=(p0.y+p3.y)/2,p=[p0,{x:p0.x,y:m},{x:p3.x,y:m},p3];p=p.map(projection);return"M"+p[0]+"C"+p[1]+" "+p[2]+" "+p[3];}diagonal.source=function(x){if(!arguments.length)return source;source=d3_functor(x);return diagonal;};diagonal.target=function(x){if(!arguments.length)return target;target=d3_functor(x);return diagonal;};diagonal.projection=function(x){if(!arguments.length)return projection;projection=x;return diagonal;};return diagonal;};function d3_svg_diagonalProjection(d){return[d.x,d.y];}d3.svg.diagonal.radial=function(){var diagonal=d3.svg.diagonal(),projection=d3_svg_diagonalProjection,projection_=diagonal.projection;diagonal.projection=function(x){return arguments.length?projection_(d3_svg_diagonalRadialProjection(projection=x)):projection;};return diagonal;};function d3_svg_diagonalRadialProjection(projection){return function(){var d=projection.apply(this,arguments),r=d[0],a=d[1]-half;return[r*Math.cos(a),r*Math.sin(a)];};}d3.svg.symbol=function(){var type=d3_svg_symbolType,size=d3_svg_symbolSize;function symbol(d,i){return(d3_svg_symbols.get(type.call(this,d,i))||d3_svg_symbolCircle)(size.call(this,d,i));}symbol.type=function(x){if(!arguments.length)return type;type=d3_functor(x);return symbol;};symbol.size=function(x){if(!arguments.length)return size;size=d3_functor(x);return symbol;};return symbol;};function d3_svg_symbolSize(){return 64;}function d3_svg_symbolType(){return"circle";}function d3_svg_symbolCircle(size){var r=Math.sqrt(size/);return"M0,"+r+"A"+r+","+r+" 0 1,1 0,"+-r+"A"+r+","+r+" 0 1,1 0,"+r+"Z";}var d3_svg_symbols=d3.map({circle:d3_svg_symbolCircle,cross:function cross(size){var r=Math.sqrt(size/5)/2;return"M"+-3*r+","+-r+"H"+-r+"V"+-3*r+"H"+r+"V"+-r+"H"+3*r+"V"+r+"H"+r+"V"+3*r+"H"+-r+"V"+r+"H"+-3*r+"Z";},diamond:function diamond(size){var ry=Math.sqrt(size/(2*d3_svg_symbolTan30)),rx=ry*d3_svg_symbolTan30;return"M0,"+-ry+"L"+rx+",0"+" 0,"+ry+" "+-rx+",0"+"Z";},square:function square(size){var r=Math.sqrt(size)/2;return"M"+-r+","+-r+"L"+r+","+-r+" "+r+","+r+" "+-r+","+r+"Z";},"triangle-down":function triangleDown(size){var rx=Math.sqrt(size/d3_svg_symbolSqrt3),ry=rx*d3_svg_symbolSqrt3/2;return"M0,"+ry+"L"+rx+","+-ry+" "+-rx+","+-ry+"Z";},"triangle-up":function triangleUp(size){var rx=Math.sqrt(size/d3_svg_symbolSqrt3),ry=rx*d3_svg_symbolSqrt3/2;return"M0,"+-ry+"L"+rx+","+ry+" "+-rx+","+ry+"Z";}});d3.svg.symbolTypes=d3_svg_symbols.keys();var d3_svg_symbolSqrt3=Math.sqrt(3),d3_svg_symbolTan30=Math.tan(30*d3_radians);d3_selectionPrototype.transition=function(name){var id=d3_transitionInheritId||++d3_transitionId,ns=d3_transitionNamespace(name),subgroups=[],subgroup,node,transition=d3_transitionInherit||{time:Date.now(),ease:d3_ease_cubicInOut,delay:0,duration:250};for(var j=-1,m=this.length;++j<m;){subgroups.push(subgroup=[]);for(var group=this[j],i=-1,n=group.length;++i<n;){if(node=group[i])d3_transitionNode(node,i,ns,id,transition);subgroup.push(node);}}return d3_transition(subgroups,ns,id);};d3_selectionPrototype.interrupt=function(name){return this.each(name==null?d3_selection_interrupt:d3_selection_interruptNS(d3_transitionNamespace(name)));};var d3_selection_interrupt=d3_selection_interruptNS(d3_transitionNamespace());function d3_selection_interruptNS(ns){return function(){var lock,activeId,active;if((lock=this[ns])&&(active=lock[activeId=lock.active])){active.timer.c=null;active.timer.t=NaN;if(--lock.count)delete lock[activeId];else delete this[ns];lock.active+=.5;active.event&&active.event.interrupt.call(this,this.__data__,active.index);}};}function d3_transition(groups,ns,id){d3_subclass(groups,d3_transitionPrototype);groups.namespace=ns;groups.id=id;return groups;}var d3_transitionPrototype=[],d3_transitionId=0,d3_transitionInheritId,d3_transitionInherit;d3_transitionPrototype.call=d3_selectionPrototype.call;d3_transitionPrototype.empty=d3_selectionPrototype.empty;d3_transitionPrototype.node=d3_selectionPrototype.node;d3_transitionPrototype.size=d3_selectionPrototype.size;d3.transition=function(selection,name){return selection&&selection.transition?d3_transitionInheritId?selection.transition(name):selection:d3.selection().transition(selection);};d3.transition.prototype=d3_transitionPrototype;d3_transitionPrototype.select=function(selector){var id=this.id,ns=this.namespace,subgroups=[],subgroup,subnode,node;selector=d3_selection_selector(selector);for(var j=-1,m=this.length;++j<m;){subgroups.push(subgroup=[]);for(var group=this[j],i=-1,n=group.length;++i<n;){if((node=group[i])&&(subnode=selector.call(node,node.__data__,i,j))){if("__data__"in node)subnode.__data__=node.__data__;d3_transitionNode(subnode,i,ns,id,node[ns][id]);subgroup.push(subnode);}else{subgroup.push(null);}}}return d3_transition(subgroups,ns,id);};d3_transitionPrototype.selectAll=function(selector){var id=this.id,ns=this.namespace,subgroups=[],subgroup,subnodes,node,subnode,transition;selector=d3_selection_selectorAll(selector);for(var j=-1,m=this.length;++j<m;){for(var group=this[j],i=-1,n=group.length;++i<n;){if(node=group[i]){transition=node[ns][id];subnodes=selector.call(node,node.__data__,i,j);subgroups.push(subgroup=[]);for(var k=-1,o=subnodes.length;++k<o;){if(subnode=subnodes[k])d3_transitionNode(subnode,k,ns,id,transition);subgroup.push(subnode);}}}}return d3_transition(subgroups,ns,id);};d3_transitionPrototype.filter=function(filter){var subgroups=[],subgroup,group,node;if(typeof filter!=="function")filter=d3_selection_filter(filter);for(var j=0,m=this.length;j<m;j++){subgroups.push(subgroup=[]);for(var group=this[j],i=0,n=group.length;i<n;i++){if((node=group[i])&&filter.call(node,node.__data__,i,j)){subgroup.push(node);}}}return d3_transition(subgroups,this.namespace,this.id);};d3_transitionPrototype.tween=function(name,tween){var id=this.id,ns=this.namespace;if(arguments.length<2)return this.node()[ns][id].tween.get(name);return d3_selection_each(this,tween==null?function(node){node[ns][id].tween.remove(name);}:function(node){node[ns][id].tween.set(name,tween);});};function d3_transition_tween(groups,name,value,tween){var id=groups.id,ns=groups.namespace;return d3_selection_each(groups,typeof value==="function"?function(node,i,j){node[ns][id].tween.set(name,tween(value.call(node,node.__data__,i,j)));}:(value=tween(value),function(node){node[ns][id].tween.set(name,value);}));}d3_transitionPrototype.attr=function(nameNS,value){if(arguments.length<2){for(value in nameNS){this.attr(value,nameNS[value]);}return this;}var interpolate=nameNS=="transform"?d3_interpolateTransform:d3_interpolate,name=d3.ns.qualify(nameNS);function attrNull(){this.removeAttribute(name);}function attrNullNS(){this.removeAttributeNS(name.space,name.local);}function attrTween(b){return b==null?attrNull:(b+="",function(){var a=this.getAttribute(name),i;return a!==b&&(i=interpolate(a,b),function(t){this.setAttribute(name,i(t));});});}function attrTweenNS(b){return b==null?attrNullNS:(b+="",function(){var a=this.getAttributeNS(name.space,name.local),i;return a!==b&&(i=interpolate(a,b),function(t){this.setAttributeNS(name.space,name.local,i(t));});});}return d3_transition_tween(this,"attr."+nameNS,value,name.local?attrTweenNS:attrTween);};d3_transitionPrototype.attrTween=function(nameNS,tween){var name=d3.ns.qualify(nameNS);function attrTween(d,i){var f=tween.call(this,d,i,this.getAttribute(name));return f&&function(t){this.setAttribute(name,f(t));};}function attrTweenNS(d,i){var f=tween.call(this,d,i,this.getAttributeNS(name.space,name.local));return f&&function(t){this.setAttributeNS(name.space,name.local,f(t));};}return this.tween("attr."+nameNS,name.local?attrTweenNS:attrTween);};d3_transitionPrototype.style=function(name,value,priority){var n=arguments.length;if(n<3){if(typeof name!=="string"){if(n<2)value="";for(priority in name){this.style(priority,name[priority],value);}return this;}priority="";}function styleNull(){this.style.removeProperty(name);}function styleString(b){return b==null?styleNull:(b+="",function(){var a=d3_window(this).getComputedStyle(this,null).getPropertyValue(name),i;return a!==b&&(i=d3_interpolate(a,b),function(t){this.style.setProperty(name,i(t),priority);});});}return d3_transition_tween(this,"style."+name,value,styleString);};d3_transitionPrototype.styleTween=function(name,tween,priority){if(arguments.length<3)priority="";function styleTween(d,i){var f=tween.call(this,d,i,d3_window(this).getComputedStyle(this,null).getPropertyValue(name));return f&&function(t){this.style.setProperty(name,f(t),priority);};}return this.tween("style."+name,styleTween);};d3_transitionPrototype.text=function(value){return d3_transition_tween(this,"text",value,d3_transition_text);};function d3_transition_text(b){if(b==null)b="";return function(){this.textContent=b;};}d3_transitionPrototype.remove=function(){var ns=this.namespace;return this.each("end.transition",function(){var p;if(this[ns].count<2&&(p=this.parentNode))p.removeChild(this);});};d3_transitionPrototype.ease=function(value){var id=this.id,ns=this.namespace;if(arguments.length<1)return this.node()[ns][id].ease;if(typeof value!=="function")value=d3.ease.apply(d3,arguments);return d3_selection_each(this,function(node){node[ns][id].ease=value;});};d3_transitionPrototype.delay=function(value){var id=this.id,ns=this.namespace;if(arguments.length<1)return this.node()[ns][id].delay;return d3_selection_each(this,typeof value==="function"?function(node,i,j){node[ns][id].delay=+value.call(node,node.__data__,i,j);}:(value=+value,function(node){node[ns][id].delay=value;}));};d3_transitionPrototype.duration=function(value){var id=this.id,ns=this.namespace;if(arguments.length<1)return this.node()[ns][id].duration;return d3_selection_each(this,typeof value==="function"?function(node,i,j){node[ns][id].duration=Math.max(1,value.call(node,node.__data__,i,j));}:(value=Math.max(1,value),function(node){node[ns][id].duration=value;}));};d3_transitionPrototype.each=function(type,listener){var id=this.id,ns=this.namespace;if(arguments.length<2){var inherit=d3_transitionInherit,inheritId=d3_transitionInheritId;try{d3_transitionInheritId=id;d3_selection_each(this,function(node,i,j){d3_transitionInherit=node[ns][id];type.call(node,node.__data__,i,j);});}finally{d3_transitionInherit=inherit;d3_transitionInheritId=inheritId;}}else{d3_selection_each(this,function(node){var transition=node[ns][id];(transition.event||(transition.event=d3.dispatch("start","end","interrupt"))).on(type,listener);});}return this;};d3_transitionPrototype.transition=function(){var id0=this.id,id1=++d3_transitionId,ns=this.namespace,subgroups=[],subgroup,group,node,transition;for(var j=0,m=this.length;j<m;j++){subgroups.push(subgroup=[]);for(var group=this[j],i=0,n=group.length;i<n;i++){if(node=group[i]){transition=node[ns][id0];d3_transitionNode(node,i,ns,id1,{time:transition.time,ease:transition.ease,delay:transition.delay+transition.duration,duration:transition.duration});}subgroup.push(node);}}return d3_transition(subgroups,ns,id1);};function d3_transitionNamespace(name){return name==null?"__transition__":"__transition_"+name+"__";}function d3_transitionNode(node,i,ns,id,inherit){var lock=node[ns]||(node[ns]={active:0,count:0}),transition=lock[id],time,timer,duration,ease,tweens;function schedule(elapsed){var delay=transition.delay;timer.t=delay+time;if(delay<=elapsed)return start(elapsed-delay);timer.c=start;}function start(elapsed){var activeId=lock.active,active=lock[activeId];if(active){active.timer.c=null;active.timer.t=NaN;--lock.count;delete lock[activeId];active.event&&active.event.interrupt.call(node,node.__data__,active.index);}for(var cancelId in lock){if(+cancelId<id){var cancel=lock[cancelId];cancel.timer.c=null;cancel.timer.t=NaN;--lock.count;delete lock[cancelId];}}timer.c=tick;d3_timer(function(){if(timer.c&&tick(elapsed||1)){timer.c=null;timer.t=NaN;}return 1;},0,time);lock.active=id;transition.event&&transition.event.start.call(node,node.__data__,i);tweens=[];transition.tween.forEach(function(key,value){if(value=value.call(node,node.__data__,i)){tweens.push(value);}});ease=transition.ease;duration=transition.duration;}function tick(elapsed){var t=elapsed/duration,e=ease(t),n=tweens.length;while(n>0){tweens[--n].call(node,e);}if(t>=1){transition.event&&transition.event.end.call(node,node.__data__,i);if(--lock.count)delete lock[id];else delete node[ns];return 1;}}if(!transition){time=inherit.time;timer=d3_timer(schedule,0,time);transition=lock[id]={tween:new d3_Map(),time:time,timer:timer,delay:inherit.delay,duration:inherit.duration,ease:inherit.ease,index:i};inherit=null;++lock.count;}}d3.svg.axis=function(){var scale=d3.scale.linear(),orient=d3_svg_axisDefaultOrient,innerTickSize=6,outerTickSize=6,tickPadding=3,tickArguments_=[10],tickValues=null,tickFormat_;function axis(g){g.each(function(){var g=d3.select(this);var scale0=this.__chart__||scale,scale1=this.__chart__=scale.copy();var ticks=tickValues==null?scale1.ticks?scale1.ticks.apply(scale1,tickArguments_):scale1.domain():tickValues,tickFormat=tickFormat_==null?scale1.tickFormat?scale1.tickFormat.apply(scale1,tickArguments_):d3_identity:tickFormat_,tick=g.selectAll(".tick").data(ticks,scale1),tickEnter=tick.enter().insert("g",".domain").attr("class","tick").style("opacity",),tickExit=d3.transition(tick.exit()).style("opacity",).remove(),tickUpdate=d3.transition(tick.order()).style("opacity",1),tickSpacing=Math.max(innerTickSize,0)+tickPadding,tickTransform;var range=d3_scaleRange(scale1),path=g.selectAll(".domain").data([0]),pathUpdate=(path.enter().append("path").attr("class","domain"),d3.transition(path));tickEnter.append("line");tickEnter.append("text");var lineEnter=tickEnter.select("line"),lineUpdate=tickUpdate.select("line"),text=tick.select("text").text(tickFormat),textEnter=tickEnter.select("text"),textUpdate=tickUpdate.select("text"),sign=orient==="top"||orient==="left"?-1:1,x1,x2,y1,y2;if(orient==="bottom"||orient==="top"){tickTransform=d3_svg_axisX,x1="x",y1="y",x2="x2",y2="y2";text.attr("dy",sign<0?"0em":".71em").style("text-anchor","middle");pathUpdate.attr("d","M"+range[0]+","+sign*outerTickSize+"V0H"+range[1]+"V"+sign*outerTickSize);}else{tickTransform=d3_svg_axisY,x1="y",y1="x",x2="y2",y2="x2";text.attr("dy",".32em").style("text-anchor",sign<0?"end":"start");pathUpdate.attr("d","M"+sign*outerTickSize+","+range[0]+"H0V"+range[1]+"H"+sign*outerTickSize);}lineEnter.attr(y2,sign*innerTickSize);textEnter.attr(y1,sign*tickSpacing);lineUpdate.attr(x2,0).attr(y2,sign*innerTickSize);textUpdate.attr(x1,0).attr(y1,sign*tickSpacing);if(scale1.rangeBand){var x=scale1,dx=x.rangeBand()/2;scale0=scale1=function scale1(d){return x(d)+dx;};}else if(scale0.rangeBand){scale0=scale1;}else{tickExit.call(tickTransform,scale1,scale0);}tickEnter.call(tickTransform,scale0,scale1);tickUpdate.call(tickTransform,scale1,scale1);});}axis.scale=function(x){if(!arguments.length)return scale;scale=x;return axis;};axis.orient=function(x){if(!arguments.length)return orient;orient=x in d3_svg_axisOrients?x+"":d3_svg_axisDefaultOrient;return axis;};axis.ticks=function(){if(!arguments.length)return tickArguments_;tickArguments_=d3_array(arguments);return axis;};axis.tickValues=function(x){if(!arguments.length)return tickValues;tickValues=x;return axis;};axis.tickFormat=function(x){if(!arguments.length)return tickFormat_;tickFormat_=x;return axis;};axis.tickSize=function(x){var n=arguments.length;if(!n)return innerTickSize;innerTickSize=+x;outerTickSize=+arguments[n-1];return axis;};axis.innerTickSize=function(x){if(!arguments.length)return innerTickSize;innerTickSize=+x;return axis;};axis.outerTickSize=function(x){if(!arguments.length)return outerTickSize;outerTickSize=+x;return axis;};axis.tickPadding=function(x){if(!arguments.length)return tickPadding;tickPadding=+x;return axis;};axis.tickSubdivide=function(){return arguments.length&&axis;};return axis;};var d3_svg_axisDefaultOrient="bottom",d3_svg_axisOrients={top:1,right:1,bottom:1,left:1};function d3_svg_axisX(selection,x0,x1){selection.attr("transform",function(d){var v0=x0(d);return"translate("+(isFinite(v0)?v0:x1(d))+",0)";});}function d3_svg_axisY(selection,y0,y1){selection.attr("transform",function(d){var v0=y0(d);return"translate(0,"+(isFinite(v0)?v0:y1(d))+")";});}d3.svg.brush=function(){var event=d3_eventDispatch(brush,"brushstart","brush","brushend"),x=null,y=null,xExtent=[0,0],yExtent=[0,0],xExtentDomain,yExtentDomain,xClamp=true,yClamp=true,resizes=d3_svg_brushResizes[0];function brush(g){g.each(function(){var g=d3.select(this).style("pointer-events","all").style("-webkit-tap-highlight-color","rgba(0,0,0,0)").on("mousedown.brush",brushstart).on("touchstart.brush",brushstart);var background=g.selectAll(".background").data([0]);background.enter().append("rect").attr("class","background").style("visibility","hidden").style("cursor","crosshair");g.selectAll(".extent").data([0]).enter().append("rect").attr("class","extent").style("cursor","move");var resize=g.selectAll(".resize").data(resizes,d3_identity);resize.exit().remove();resize.enter().append("g").attr("class",function(d){return"resize "+d;}).style("cursor",function(d){return d3_svg_brushCursor[d];}).append("rect").attr("x",function(d){return /[ew]$/.test(d)?-3:null;}).attr("y",function(d){return /^[ns]/.test(d)?-3:null;}).attr("width",6).attr("height",6).style("visibility","hidden");resize.style("display",brush.empty()?"none":null);var gUpdate=d3.transition(g),backgroundUpdate=d3.transition(background),range;if(x){range=d3_scaleRange(x);backgroundUpdate.attr("x",range[0]).attr("width",range[1]-range[0]);redrawX(gUpdate);}if(y){range=d3_scaleRange(y);backgroundUpdate.attr("y",range[0]).attr("height",range[1]-range[0]);redrawY(gUpdate);}redraw(gUpdate);});}brush.event=function(g){g.each(function(){var event_=event.of(this,arguments),extent1={x:xExtent,y:yExtent,i:xExtentDomain,j:yExtentDomain},extent0=this.__chart__||extent1;this.__chart__=extent1;if(d3_transitionInheritId){d3.select(this).transition().each("start.brush",function(){xExtentDomain=extent0.i;yExtentDomain=extent0.j;xExtent=extent0.x;yExtent=extent0.y;event_({type:"brushstart"});}).tween("brush:brush",function(){var xi=d3_interpolateArray(xExtent,extent1.x),yi=d3_interpolateArray(yExtent,extent1.y);xExtentDomain=yExtentDomain=null;return function(t){xExtent=extent1.x=xi(t);yExtent=extent1.y=yi(t);event_({type:"brush",mode:"resize"});};}).each("end.brush",function(){xExtentDomain=extent1.i;yExtentDomain=extent1.j;event_({type:"brush",mode:"resize"});event_({type:"brushend"});});}else{event_({type:"brushstart"});event_({type:"brush",mode:"resize"});event_({type:"brushend"});}});};function redraw(g){g.selectAll(".resize").attr("transform",function(d){return"translate("+xExtent[+/e$/.test(d)]+","+yExtent[+/^s/.test(d)]+")";});}function redrawX(g){g.select(".extent").attr("x",xExtent[0]);g.selectAll(".extent,.n>rect,.s>rect").attr("width",xExtent[1]-xExtent[0]);}function redrawY(g){g.select(".extent").attr("y",yExtent[0]);g.selectAll(".extent,.e>rect,.w>rect").attr("height",yExtent[1]-yExtent[0]);}function brushstart(){var target=this,eventTarget=d3.select(d3.event.target),event_=event.of(target,arguments),g=d3.select(target),resizing=eventTarget.datum(),resizingX=!/^(n|s)$/.test(resizing)&&x,resizingY=!/^(e|w)$/.test(resizing)&&y,dragging=eventTarget.classed("extent"),dragRestore=d3_event_dragSuppress(target),center,origin=d3.mouse(target),offset;var w=d3.select(d3_window(target)).on("keydown.brush",keydown).on("keyup.brush",keyup);if(d3.event.changedTouches){w.on("touchmove.brush",brushmove).on("touchend.brush",brushend);}else{w.on("mousemove.brush",brushmove).on("mouseup.brush",brushend);}g.interrupt().selectAll("*").interrupt();if(dragging){origin[0]=xExtent[0]-origin[0];origin[1]=yExtent[0]-origin[1];}else if(resizing){var ex=+/w$/.test(resizing),ey=+/^n/.test(resizing);offset=[xExtent[1-ex]-origin[0],yExtent[1-ey]-origin[1]];origin[0]=xExtent[ex];origin[1]=yExtent[ey];}else if(d3.event.altKey)center=origin.slice();g.style("pointer-events","none").selectAll(".resize").style("display",null);d3.select("body").style("cursor",eventTarget.style("cursor"));event_({type:"brushstart"});brushmove();function keydown(){if(d3.event.keyCode==32){if(!dragging){center=null;origin[0]-=xExtent[1];origin[1]-=yExtent[1];dragging=2;}d3_eventPreventDefault();}}function keyup(){if(d3.event.keyCode==32&&dragging==2){origin[0]+=xExtent[1];origin[1]+=yExtent[1];dragging=0;d3_eventPreventDefault();}}function brushmove(){var point=d3.mouse(target),moved=false;if(offset){point[0]+=offset[0];point[1]+=offset[1];}if(!dragging){if(d3.event.altKey){if(!center)center=[(xExtent[0]+xExtent[1])/2,(yExtent[0]+yExtent[1])/2];origin[0]=xExtent[+(point[0]<center[0])];origin[1]=yExtent[+(point[1]<center[1])];}else center=null;}if(resizingX&&move1(point,x,0)){redrawX(g);moved=true;}if(resizingY&&move1(point,y,1)){redrawY(g);moved=true;}if(moved){redraw(g);event_({type:"brush",mode:dragging?"move":"resize"});}}function move1(point,scale,i){var range=d3_scaleRange(scale),r0=range[0],r1=range[1],position=origin[i],extent=i?yExtent:xExtent,size=extent[1]-extent[0],min,max;if(dragging){r0-=position;r1-=size+position;}min=(i?yClamp:xClamp)?Math.max(r0,Math.min(r1,point[i])):point[i];if(dragging){max=(min+=position)+size;}else{if(center)position=Math.max(r0,Math.min(r1,2*center[i]-min));if(position<min){max=min;min=position;}else{max=position;}}if(extent[0]!=min||extent[1]!=max){if(i)yExtentDomain=null;else xExtentDomain=null;extent[0]=min;extent[1]=max;return true;}}function brushend(){brushmove();g.style("pointer-events","all").selectAll(".resize").style("display",brush.empty()?"none":null);d3.select("body").style("cursor",null);w.on("mousemove.brush",null).on("mouseup.brush",null).on("touchmove.brush",null).on("touchend.brush",null).on("keydown.brush",null).on("keyup.brush",null);dragRestore();event_({type:"brushend"});}}brush.x=function(z){if(!arguments.length)return x;x=z;resizes=d3_svg_brushResizes[!x<<1|!y];return brush;};brush.y=function(z){if(!arguments.length)return y;y=z;resizes=d3_svg_brushResizes[!x<<1|!y];return brush;};brush.clamp=function(z){if(!arguments.length)return x&&y?[xClamp,yClamp]:x?xClamp:y?yClamp:null;if(x&&y)xClamp=!!z[0],yClamp=!!z[1];else if(x)xClamp=!!z;else if(y)yClamp=!!z;return brush;};brush.extent=function(z){var x0,x1,y0,y1,t;if(!arguments.length){if(x){if(xExtentDomain){x0=xExtentDomain[0],x1=xExtentDomain[1];}else{x0=xExtent[0],x1=xExtent[1];if(x.invert)x0=x.invert(x0),x1=x.invert(x1);if(x1<x0)t=x0,x0=x1,x1=t;}}if(y){if(yExtentDomain){y0=yExtentDomain[0],y1=yExtentDomain[1];}else{y0=yExtent[0],y1=yExtent[1];if(y.invert)y0=y.invert(y0),y1=y.invert(y1);if(y1<y0)t=y0,y0=y1,y1=t;}}return x&&y?[[x0,y0],[x1,y1]]:x?[x0,x1]:y&&[y0,y1];}if(x){x0=z[0],x1=z[1];if(y)x0=x0[0],x1=x1[0];xExtentDomain=[x0,x1];if(x.invert)x0=x(x0),x1=x(x1);if(x1<x0)t=x0,x0=x1,x1=t;if(x0!=xExtent[0]||x1!=xExtent[1])xExtent=[x0,x1];}if(y){y0=z[0],y1=z[1];if(x)y0=y0[1],y1=y1[1];yExtentDomain=[y0,y1];if(y.invert)y0=y(y0),y1=y(y1);if(y1<y0)t=y0,y0=y1,y1=t;if(y0!=yExtent[0]||y1!=yExtent[1])yExtent=[y0,y1];}return brush;};brush.clear=function(){if(!brush.empty()){xExtent=[0,0],yExtent=[0,0];xExtentDomain=yExtentDomain=null;}return brush;};brush.empty=function(){return!!x&&xExtent[0]==xExtent[1]||!!y&&yExtent[0]==yExtent[1];};return d3.rebind(brush,event,"on");};var d3_svg_brushCursor={n:"ns-resize",e:"ew-resize",s:"ns-resize",w:"ew-resize",nw:"nwse-resize",ne:"nesw-resize",se:"nwse-resize",sw:"nesw-resize"};var d3_svg_brushResizes=[["n","e","s","w","nw","ne","se","sw"],["e","w"],["n","s"],[]];var d3_time_format=d3_time.format=d3_locale_enUS.timeFormat;var d3_time_formatUtc=d3_time_format.utc;var d3_time_formatIso=d3_time_formatUtc("%Y-%m-%dT%H:%M:%S.%LZ");d3_time_format.iso=Date.prototype.toISOString&&+new Date("2000-01-01T00:00:00.000Z")?d3_time_formatIsoNative:d3_time_formatIso;function d3_time_formatIsoNative(date){return date.toISOString();}d3_time_formatIsoNative.parse=function(string){var date=new Date(string);return isNaN(date)?null:date;};d3_time_formatIsoNative.toString=d3_time_formatIso.toString;d3_time.second=d3_time_interval(function(date){return new d3_date(Math.floor(date/1e3)*1e3);},function(date,offset){date.setTime(date.getTime()+Math.floor(offset)*1e3);},function(date){return date.getSeconds();});d3_time.seconds=d3_time.second.range;d3_time.seconds.utc=d3_time.second.utc.range;d3_time.minute=d3_time_interval(function(date){return new d3_date(Math.floor(date/6e4)*6e4);},function(date,offset){date.setTime(date.getTime()+Math.floor(offset)*6e4);},function(date){return date.getMinutes();});d3_time.minutes=d3_time.minute.range;d3_time.minutes.utc=d3_time.minute.utc.range;d3_time.hour=d3_time_interval(function(date){var timezone=date.getTimezoneOffset()/60;return new d3_date((Math.floor(date/36e5-timezone)+timezone)*36e5);},function(date,offset){date.setTime(date.getTime()+Math.floor(offset)*36e5);},function(date){return date.getHours();});d3_time.hours=d3_time.hour.range;d3_time.hours.utc=d3_time.hour.utc.range;d3_time.month=d3_time_interval(function(date){date=d3_time.day(date);date.setDate(1);return date;},function(date,offset){date.setMonth(date.getMonth()+offset);},function(date){return date.getMonth();});d3_time.months=d3_time.month.range;d3_time.months.utc=d3_time.month.utc.range;function d3_time_scale(linear,methods,format){function scale(x){return linear(x);}scale.invert=function(x){return d3_time_scaleDate(linear.invert(x));};scale.domain=function(x){if(!arguments.length)return linear.domain().map(d3_time_scaleDate);linear.domain(x);return scale;};function tickMethod(extent,count){var span=extent[1]-extent[0],target=span/count,i=d3.bisect(d3_time_scaleSteps,target);return i==d3_time_scaleSteps.length?[methods.year,d3_scale_linearTickRange(extent.map(function(d){return d/31536e6;}),count)[2]]:!i?[d3_time_scaleMilliseconds,d3_scale_linearTickRange(extent,count)[2]]:methods[target/d3_time_scaleSteps[i-1]<d3_time_scaleSteps[i]/target?i-1:i];}scale.nice=function(interval,skip){var domain=scale.domain(),extent=d3_scaleExtent(domain),method=interval==null?tickMethod(extent,10):typeof interval==="number"&&tickMethod(extent,interval);if(method)interval=method[0],skip=method[1];function skipped(date){return!isNaN(date)&&!interval.range(date,d3_time_scaleDate(+date+1),skip).length;}return scale.domain(d3_scale_nice(domain,skip>1?{floor:function floor(date){while(skipped(date=interval.floor(date))){date=d3_time_scaleDate(date-1);}return date;},ceil:function ceil(date){while(skipped(date=interval.ceil(date))){date=d3_time_scaleDate(+date+1);}return date;}}:interval));};scale.ticks=function(interval,skip){var extent=d3_scaleExtent(scale.domain()),method=interval==null?tickMethod(extent,10):typeof interval==="number"?tickMethod(extent,interval):!interval.range&&[{range:interval},skip];if(method)interval=method[0],skip=method[1];return interval.range(extent[0],d3_time_scaleDate(+extent[1]+1),skip<1?1:skip);};scale.tickFormat=function(){return format;};scale.copy=function(){return d3_time_scale(linear.copy(),methods,format);};return d3_scale_linearRebind(scale,linear);}function d3_time_scaleDate(t){return new Date(t);}var d3_time_scaleSteps=[1e3,5e3,15e3,3e4,6e4,3e5,9e5,18e5,36e5,108e5,216e5,432e5,864e5,1728e5,6048e5,2592e6,7776e6,31536e6];var d3_time_scaleLocalMethods=[[d3_time.second,1],[d3_time.second,5],[d3_time.second,15],[d3_time.second,30],[d3_time.minute,1],[d3_time.minute,5],[d3_time.minute,15],[d3_time.minute,30],[d3_time.hour,1],[d3_time.hour,3],[d3_time.hour,6],[d3_time.hour,12],[d3_time.day,1],[d3_time.day,2],[d3_time.week,1],[d3_time.month,1],[d3_time.month,3],[d3_time.year,1]];var d3_time_scaleLocalFormat=d3_time_format.multi([[".%L",function(d){return d.getMilliseconds();}],[":%S",function(d){return d.getSeconds();}],["%I:%M",function(d){return d.getMinutes();}],["%I %p",function(d){return d.getHours();}],["%a %d",function(d){return d.getDay()&&d.getDate()!=1;}],["%b %d",function(d){return d.getDate()!=1;}],["%B",function(d){return d.getMonth();}],["%Y",d3_true]]);var d3_time_scaleMilliseconds={range:function range(start,stop,step){return d3.range(Math.ceil(start/step)*step,+stop,step).map(d3_time_scaleDate);},floor:d3_identity,ceil:d3_identity};d3_time_scaleLocalMethods.year=d3_time.year;d3_time.scale=function(){return d3_time_scale(d3.scale.linear(),d3_time_scaleLocalMethods,d3_time_scaleLocalFormat);};var d3_time_scaleUtcMethods=d3_time_scaleLocalMethods.map(function(m){return[m[0].utc,m[1]];});var d3_time_scaleUtcFormat=d3_time_formatUtc.multi([[".%L",function(d){return d.getUTCMilliseconds();}],[":%S",function(d){return d.getUTCSeconds();}],["%I:%M",function(d){return d.getUTCMinutes();}],["%I %p",function(d){return d.getUTCHours();}],["%a %d",function(d){return d.getUTCDay()&&d.getUTCDate()!=1;}],["%b %d",function(d){return d.getUTCDate()!=1;}],["%B",function(d){return d.getUTCMonth();}],["%Y",d3_true]]);d3_time_scaleUtcMethods.year=d3_time.year.utc;d3_time.scale.utc=function(){return d3_time_scale(d3.scale.linear(),d3_time_scaleUtcMethods,d3_time_scaleUtcFormat);};d3.text=d3_xhrType(function(request){return request.responseText;});d3.json=function(url,callback){return d3_xhr(url,"application/json",d3_json,callback);};function d3_json(request){return JSON.parse(request.responseText);}d3.html=function(url,callback){return d3_xhr(url,"text/html",d3_html,callback);};function d3_html(request){var range=d3_document.createRange();range.selectNode(d3_document.body);return range.createContextualFragment(request.responseText);}d3.xml=d3_xhrType(function(request){return request.responseXML;});if(typeof define==="function"&&define.amd)this.d3=d3,define(d3);else if(_typeof(module)==="object"&&module.exports)module.exports=d3;else this.d3=d3;}();},{}],15:[function(require,module,exports){module.exports=function(app){app.on('ready',function(page){window.MODEL=page.model;window.APP=app;app.findComponent=findComponent;app.componentCommand=componentCommand;app.derby.Model.prototype.logEvents=logEvents;});};function findComponent(name,index){if(index==null)index=0;var commentIterator=document.createTreeWalker(document,128,null,false);var node;while(node=commentIterator.nextNode()){if(node.data!==name)continue;if(index===0){return node.$component;}index--;}};function componentCommand(comment){var count=0;var commentIterator=document.createTreeWalker(document,128,null,false);var node;while(node=commentIterator.nextNode()){if(node===comment){return'(component = APP.findComponent(\''+node.data+'\','+count+'))';}if(node.data===comment.data)count++;}};function logEvents(path){if(path==null)path='';this.on('all',path+'**',console.log.bind(console));};},{}],16:[function(require,module,exports){exports.contexts=require('./lib/contexts');exports.expressions=require('./lib/expressions');exports.operatorFns=require('./lib/operatorFns');exports.options=require('./lib/options');exports.templates=require('./lib/templates');},{"./lib/contexts":17,"./lib/expressions":18,"./lib/operatorFns":19,"./lib/options":20,"./lib/templates":21}],17:[function(require,module,exports){exports.ContextMeta=ContextMeta;exports.Context=Context;function noop(){}// TODO:
// Implement removeItemContext
function ContextMeta(){this.addBinding=noop;this.removeBinding=noop;this.removeNode=noop;this.addItemContext=noop;this.removeItemContext=noop;this.views=null;this.idNamespace='';this.idCount=0;this.pending=[];this.pauseCount=0;}function Context(meta,controller,parent,unbound,expression){// Required properties //
// Properties which are globally inherited for the entire page
this.meta=meta;// The page or component. Must have a `model` property with a `data` property
this.controller=controller;// Optional properties //
// Containing context
this.parent=parent;// Boolean set to true when bindings should be ignored
this.unbound=unbound;// The expression for a block
this.expression=expression;// Alias name for the given expression
this.alias=expression&&expression.meta&&expression.meta.as;// Alias name for the index or iterated key
this.keyAlias=expression&&expression.meta&&expression.meta.keyAs;// For Context::eachChild
// The context of the each at render time
this.item=null;// For Context::viewChild
// Reference to the current view
this.view=null;// Attribute values passed to the view instance
this.attributes=null;// MarkupHooks to be called after insert into DOM of component
this.hooks=null;// MarkupHooks to be called immediately before init of component
this.initHooks=null;// For Context::closureChild
// Reference to another context established at render time by ContextClosure
this.closure=null;// Used in EventModel
this._id=null;}Context.prototype.id=function(){var count=++this.meta.idCount;return this.meta.idNamespace+'_'+count.toString(36);};Context.prototype.addBinding=function(binding){// Don't add bindings that wrap list items. Only their outer range is needed
if(binding.itemFor)return;var expression=binding.template.expression;// Don't rerender in unbound sections
if(expression?expression.isUnbound(this):this.unbound)return;// Don't rerender to changes in a with expression
if(expression&&expression.meta&&expression.meta.blockType==='with')return;this.meta.addBinding(binding);};Context.prototype.removeBinding=function(binding){this.meta.removeBinding(binding);};Context.prototype.removeNode=function(node){this.meta.removeNode(node);};Context.prototype.child=function(expression){// Set or inherit the binding mode
var blockType=expression.meta&&expression.meta.blockType;var unbound=blockType==='unbound'?true:blockType==='bound'?false:this.unbound;return new Context(this.meta,this.controller,this,unbound,expression);};Context.prototype.componentChild=function(component){return new Context(this.meta,component,this,this.unbound);};// Make a context for an item in an each block
Context.prototype.eachChild=function(expression,item){var context=new Context(this.meta,this.controller,this,this.unbound,expression);context.item=item;this.meta.addItemContext(context);return context;};Context.prototype.viewChild=function(view,attributes,hooks,initHooks){var context=new Context(this.meta,this.controller,this,this.unbound);context.view=view;context.attributes=attributes;context.hooks=hooks;context.initHooks=initHooks;return context;};Context.prototype.closureChild=function(closure){var context=new Context(this.meta,this.controller,this,this.unbound);context.closure=closure;return context;};Context.prototype.forRelative=function(expression){var context=this;while(context&&context.expression===expression||context.view){context=context.parent;}return context;};// Returns the closest context which defined the named alias
Context.prototype.forAlias=function(alias){var context=this;while(context){if(context.alias===alias||context.keyAlias===alias)return context;context=context.parent;}};// Returns the closest containing context for a view attribute name or nothing
Context.prototype.forAttribute=function(attribute){var context=this;while(context){// Find the closest context associated with a view
if(context.view){var attributes=context.attributes;if(!attributes)return;if(attributes.hasOwnProperty(attribute))return context;// If the attribute isn't found, but the attributes inherit, continue
// looking in the next closest view context
if(!attributes.inherit&&!attributes.extend)return;}context=context.parent;}};Context.prototype.forViewParent=function(){var context=this;while(context){// When a context with a `closure` property is encountered, skip to its
// parent context rather than returning the nearest view's. This reference
// is created by wrapping a template in a ContextClosure template
if(context.closure)return context.closure.parent;// Find the closest view and return the containing context
if(context.view)return context.parent;context=context.parent;}};Context.prototype.getView=function(){var context=this;while(context){// Find the closest view
if(context.view)return context.view;context=context.parent;}};// Returns the `this` value for a context
Context.prototype.get=function(){var value=this.expression?this.expression.get(this):this.controller.model.data;if(this.item!=null){return value&&value[this.item];}return value;};Context.prototype.pause=function(){this.meta.pauseCount++;};Context.prototype.unpause=function(){if(--this.meta.pauseCount)return;this.flush();};Context.prototype.flush=function(){var pending=this.meta.pending;var len=pending.length;if(!len)return;this.meta.pending=[];for(var i=0;i<len;i++){pending[i]();}};Context.prototype.queue=function(cb){this.meta.pending.push(cb);};},{}],18:[function(require,module,exports){(function(global){var serializeObject=require('serialize-object');var operatorFns=require('./operatorFns');var templates=require('./templates');var Template=templates.Template;var util=require('./util');var concat=util.concat;exports.lookup=lookup;exports.templateTruthy=templateTruthy;exports.pathSegments=pathSegments;exports.renderValue=renderValue;exports.renderTemplate=renderTemplate;exports.ExpressionMeta=ExpressionMeta;exports.Expression=Expression;exports.LiteralExpression=LiteralExpression;exports.PathExpression=PathExpression;exports.RelativePathExpression=RelativePathExpression;exports.AliasPathExpression=AliasPathExpression;exports.AttributePathExpression=AttributePathExpression;exports.BracketsExpression=BracketsExpression;exports.DeferRenderExpression=DeferRenderExpression;exports.ArrayExpression=ArrayExpression;exports.ObjectExpression=ObjectExpression;exports.FnExpression=FnExpression;exports.OperatorExpression=OperatorExpression;exports.NewExpression=NewExpression;exports.SequenceExpression=SequenceExpression;exports.ViewParentExpression=ViewParentExpression;exports.ScopedModelExpression=ScopedModelExpression;function lookup(segments,value){if(!segments)return value;for(var i=0,len=segments.length;i<len;i++){if(value==null)return value;value=value[segments[i]];}return value;}// Unlike JS, `[]` is falsey. Otherwise, truthiness is the same as JS
function templateTruthy(value){return Array.isArray(value)?value.length>0:!!value;}function pathSegments(segments){var result=[];for(var i=0;i<segments.length;i++){var segment=segments[i];result[i]=_typeof(segment)==='object'?segment.item:segment;}return result;}function renderValue(value,context){return _typeof(value)!=='object'?value:value instanceof Template?renderTemplate(value,context):Array.isArray(value)?renderArray(value,context):renderObject(value,context);}function renderTemplate(value,context){var i=1000;while(value instanceof Template){if(--i<0)throw new Error('Maximum template render passes exceeded');value=value.get(context,true);}return value;}function renderArray(array,context){for(var i=0;i<array.length;i++){if(hasTemplateProperty(array[i])){return renderArrayProperties(array,context);}}return array;}function renderObject(object,context){return hasTemplateProperty(object)?renderObjectProperties(object,context):object;}function hasTemplateProperty(object){if(!object)return false;if(object.constructor!==Object)return false;for(var key in object){if(object[key]instanceof Template)return true;}return false;}function renderArrayProperties(array,context){var out=new Array(array.length);for(var i=0;i<array.length;i++){out[i]=renderValue(array[i],context);}return out;}function renderObjectProperties(object,context){var out={};for(var key in object){out[key]=renderValue(object[key],context);}return out;}function ExpressionMeta(source,blockType,isEnd,as,keyAs,unescaped,bindType,valueType){this.source=source;this.blockType=blockType;this.isEnd=isEnd;this.as=as;this.keyAs=keyAs;this.unescaped=unescaped;this.bindType=bindType;this.valueType=valueType;}ExpressionMeta.prototype.module='expressions';ExpressionMeta.prototype.type='ExpressionMeta';ExpressionMeta.prototype.serialize=function(){return serializeObject.instance(this,this.source,this.blockType,this.isEnd,this.as,this.keyAs,this.unescaped,this.bindType,this.valueType);};function Expression(meta){this.meta=meta;}Expression.prototype.module='expressions';Expression.prototype.type='Expression';Expression.prototype.serialize=function(){return serializeObject.instance(this,this.meta);};Expression.prototype.toString=function(){return this.meta&&this.meta.source;};Expression.prototype.truthy=function(context){var blockType=this.meta.blockType;if(blockType==='else')return true;var value=this.get(context,true);var truthy=templateTruthy(value);return blockType==='unless'?!truthy:truthy;};Expression.prototype.get=function(){};// Return the expression's segment list with context objects
Expression.prototype.resolve=function(){};// Return a list of segment lists or null
Expression.prototype.dependencies=function(){};// Return the pathSegments that the expression currently resolves to or null
Expression.prototype.pathSegments=function(context){var segments=this.resolve(context);return segments&&pathSegments(segments);};Expression.prototype.set=function(context,value){var segments=this.pathSegments(context);if(!segments)throw new Error('Expression does not support setting');context.controller.model._set(segments,value);};Expression.prototype._resolvePatch=function(context,segments){return context&&context.expression===this&&context.item!=null?segments.concat(context):segments;};Expression.prototype.isUnbound=function(context){// If the template being rendered has an explicit bindType keyword, such as:
// {{unbound #item.text}}
var bindType=this.meta&&this.meta.bindType;if(bindType==='unbound')return true;if(bindType==='bound')return false;// Otherwise, inherit from the context
return context.unbound;};Expression.prototype._lookupAndContextifyValue=function(value,context){if(this.segments&&this.segments.length){// If expression has segments, e.g. `bar.baz` in `#foo.bar.baz`, then
// render the base value (e.g. `#foo`) if it's a template and look up the
// value at the indicated path.
value=renderTemplate(value,context);value=lookup(this.segments,value);}if(value instanceof Template&&!(value instanceof templates.ContextClosure)){// If we're not immediately rendering the template, then create a ContextClosure
// so that the value renders with the correct context later.
value=new templates.ContextClosure(value,context);}return value;};function LiteralExpression(value,meta){this.value=value;this.meta=meta;}LiteralExpression.prototype=Object.create(Expression.prototype);LiteralExpression.prototype.constructor=LiteralExpression;LiteralExpression.prototype.type='LiteralExpression';LiteralExpression.prototype.serialize=function(){return serializeObject.instance(this,this.value,this.meta);};LiteralExpression.prototype.get=function(){return this.value;};function PathExpression(segments,meta){this.segments=segments;this.meta=meta;}PathExpression.prototype=Object.create(Expression.prototype);PathExpression.prototype.constructor=PathExpression;PathExpression.prototype.type='PathExpression';PathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.segments,this.meta);};PathExpression.prototype.get=function(context){// See View::dependencies. This is needed in order to handle the case of
// getting dependencies within a component template, in which case we cannot
// access model data separate from rendering.
if(!context.controller)return;return lookup(this.segments,context.controller.model.data);};PathExpression.prototype.resolve=function(context){// See View::dependencies. This is needed in order to handle the case of
// getting dependencies within a component template, in which case we cannot
// access model data separate from rendering.
if(!context.controller)return;var segments=concat(context.controller._scope,this.segments);return this._resolvePatch(context,segments);};PathExpression.prototype.dependencies=function(context,options){// See View::dependencies. This is needed in order to handle the case of
// getting dependencies within a component template, in which case we cannot
// access model data separate from rendering.
if(!context.controller)return;var value=lookup(this.segments,context.controller.model.data);var dependencies=getDependencies(value,context,options);return appendDependency(dependencies,this,context);};function RelativePathExpression(segments,meta){this.segments=segments;this.meta=meta;}RelativePathExpression.prototype=Object.create(Expression.prototype);RelativePathExpression.prototype.constructor=RelativePathExpression;RelativePathExpression.prototype.type='RelativePathExpression';RelativePathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.segments,this.meta);};RelativePathExpression.prototype.get=function(context){var relativeContext=context.forRelative(this);var value=relativeContext.get();return this._lookupAndContextifyValue(value,relativeContext);};RelativePathExpression.prototype.resolve=function(context){var relativeContext=context.forRelative(this);var base=relativeContext.expression?relativeContext.expression.resolve(relativeContext):[];if(!base)return;var segments=base.concat(this.segments);return this._resolvePatch(context,segments);};RelativePathExpression.prototype.dependencies=function(context,options){// Return inner dependencies from our ancestor
// (e.g., {{ with foo[bar] }} ... {{ this.x }} has 'bar' as a dependency.)
var relativeContext=context.forRelative(this);var dependencies=relativeContext.expression&&relativeContext.expression.dependencies(relativeContext,options);return swapLastDependency(dependencies,this,context);};function AliasPathExpression(alias,segments,meta){this.alias=alias;this.segments=segments;this.meta=meta;}AliasPathExpression.prototype=Object.create(Expression.prototype);AliasPathExpression.prototype.constructor=AliasPathExpression;AliasPathExpression.prototype.type='AliasPathExpression';AliasPathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.alias,this.segments,this.meta);};AliasPathExpression.prototype.get=function(context){var aliasContext=context.forAlias(this.alias);if(!aliasContext)return;if(aliasContext.keyAlias===this.alias){return aliasContext.item;}var value=aliasContext.get();return this._lookupAndContextifyValue(value,aliasContext);};AliasPathExpression.prototype.resolve=function(context){var aliasContext=context.forAlias(this.alias);if(!aliasContext)return;if(aliasContext.keyAlias===this.alias)return;var base=aliasContext.expression.resolve(aliasContext);if(!base)return;var segments=base.concat(this.segments);return this._resolvePatch(context,segments);};AliasPathExpression.prototype.dependencies=function(context,options){var aliasContext=context.forAlias(this.alias);if(!aliasContext)return;if(aliasContext.keyAlias===this.alias){// For keyAliases, use a dependency of the entire list, so that it will
// always update when the list itself changes. This is over-binding, but
// would otherwise be much more complex
var base=aliasContext.expression.resolve(aliasContext.parent);if(!base)return;return[base];}var dependencies=aliasContext.expression.dependencies(aliasContext,options);return swapLastDependency(dependencies,this,context);};function AttributePathExpression(attribute,segments,meta){this.attribute=attribute;this.segments=segments;this.meta=meta;}AttributePathExpression.prototype=Object.create(Expression.prototype);AttributePathExpression.prototype.constructor=AttributePathExpression;AttributePathExpression.prototype.type='AttributePathExpression';AttributePathExpression.prototype.serialize=function(){return serializeObject.instance(this,this.attribute,this.segments,this.meta);};AttributePathExpression.prototype.get=function(context){var attributeContext=context.forAttribute(this.attribute);if(!attributeContext)return;var value=attributeContext.attributes[this.attribute];if(value instanceof Expression){value=value.get(attributeContext);}return this._lookupAndContextifyValue(value,attributeContext);};AttributePathExpression.prototype.resolve=function(context){var attributeContext=context.forAttribute(this.attribute);if(!attributeContext)return;// Attributes may be a template, an expression, or a literal value
var base;var value=attributeContext.attributes[this.attribute];if(value instanceof Expression||value instanceof Template){base=value.resolve(attributeContext);}if(!base)return;var segments=base.concat(this.segments);return this._resolvePatch(context,segments);};AttributePathExpression.prototype.dependencies=function(context,options){var attributeContext=context.forAttribute(this.attribute);if(!attributeContext)return;// Attributes may be a template, an expression, or a literal value
var value=attributeContext.attributes[this.attribute];var dependencies=getDependencies(value,attributeContext,options);return swapLastDependency(dependencies,this,context);};function BracketsExpression(before,inside,afterSegments,meta){this.before=before;this.inside=inside;this.afterSegments=afterSegments;this.meta=meta;}BracketsExpression.prototype=Object.create(Expression.prototype);BracketsExpression.prototype.constructor=BracketsExpression;BracketsExpression.prototype.type='BracketsExpression';BracketsExpression.prototype.serialize=function(){return serializeObject.instance(this,this.before,this.inside,this.afterSegments,this.meta);};BracketsExpression.prototype.get=function(context){var inside=this.inside.get(context);if(inside==null)return;var before=this.before.get(context);if(!before)return;var base=before[inside];return this.afterSegments?lookup(this.afterSegments,base):base;};BracketsExpression.prototype.resolve=function(context){// Get and split the current value of the expression inside the brackets
var inside=this.inside.get(context);if(inside==null)return;// Concat the before, inside, and optional after segments
var base=this.before.resolve(context);if(!base)return;var segments=this.afterSegments?base.concat(inside,this.afterSegments):base.concat(inside);return this._resolvePatch(context,segments);};BracketsExpression.prototype.dependencies=function(context,options){var before=this.before.dependencies(context,options);if(before)before.pop();var inner=this.inside.dependencies(context,options);var dependencies=concat(before,inner);return appendDependency(dependencies,this,context);};// This Expression is used to wrap a template so that when its containing
// Expression--such as an ObjectExpression or ArrayExpression--is evaluated,
// it returns the template unrendered and wrapped in the current context.
// Separating evaluation of the containing expression from template rendering
// is used to support array attributes of views. This way, we can evaluate an
// array and iterate through it separately from rendering template content
function DeferRenderExpression(template,meta){if(!(template instanceof Template)){throw new Error('DeferRenderExpression requires a Template argument');}this.template=template;this.meta=meta;}DeferRenderExpression.prototype=Object.create(Expression.prototype);DeferRenderExpression.prototype.constructor=DeferRenderExpression;DeferRenderExpression.prototype.type='DeferRenderExpression';DeferRenderExpression.prototype.serialize=function(){return serializeObject.instance(this,this.template,this.meta);};DeferRenderExpression.prototype.get=function(context){return new templates.ContextClosure(this.template,context);};function ArrayExpression(items,afterSegments,meta){this.items=items;this.afterSegments=afterSegments;this.meta=meta;}ArrayExpression.prototype=Object.create(Expression.prototype);ArrayExpression.prototype.constructor=ArrayExpression;ArrayExpression.prototype.type='ArrayExpression';ArrayExpression.prototype.serialize=function(){return serializeObject.instance(this,this.items,this.afterSegments,this.meta);};ArrayExpression.prototype.get=function(context){var items=new Array(this.items.length);for(var i=0;i<this.items.length;i++){var value=this.items[i].get(context);items[i]=value;}return this.afterSegments?lookup(this.afterSegments,items):items;};ArrayExpression.prototype.dependencies=function(context,options){if(!this.items)return;var dependencies;for(var i=0;i<this.items.length;i++){var itemDependencies=this.items[i].dependencies(context,options);dependencies=concat(dependencies,itemDependencies);}return dependencies;};function ObjectExpression(properties,afterSegments,meta){this.properties=properties;this.afterSegments=afterSegments;this.meta=meta;}ObjectExpression.prototype=Object.create(Expression.prototype);ObjectExpression.prototype.constructor=ObjectExpression;ObjectExpression.prototype.type='ObjectExpression';ObjectExpression.prototype.serialize=function(){return serializeObject.instance(this,this.properties,this.afterSegments,this.meta);};ObjectExpression.prototype.get=function(context){var object={};for(var key in this.properties){var value=this.properties[key].get(context);object[key]=value;}return this.afterSegments?lookup(this.afterSegments,object):object;};ObjectExpression.prototype.dependencies=function(context,options){if(!this.properties)return;var dependencies;for(var key in this.properties){var propertyDependencies=this.properties[key].dependencies(context,options);dependencies=concat(dependencies,propertyDependencies);}return dependencies;};function FnExpression(segments,args,afterSegments,meta){this.segments=segments;this.args=args;this.afterSegments=afterSegments;this.meta=meta;var parentSegments=segments&&segments.slice();this.lastSegment=parentSegments&&parentSegments.pop();this.parentSegments=parentSegments&&parentSegments.length?parentSegments:null;}FnExpression.prototype=Object.create(Expression.prototype);FnExpression.prototype.constructor=FnExpression;FnExpression.prototype.type='FnExpression';FnExpression.prototype.serialize=function(){return serializeObject.instance(this,this.segments,this.args,this.afterSegments,this.meta);};FnExpression.prototype.get=function(context){var value=this.apply(context);// Lookup property underneath computed value if needed
return this.afterSegments?lookup(this.afterSegments,value):value;};FnExpression.prototype.apply=function(context,extraInputs){// See View::dependencies. This is needed in order to handle the case of
// getting dependencies within a component template, in which case we cannot
// access model data separate from rendering.
if(!context.controller)return;var parent=this._lookupParent(context);var fn=parent[this.lastSegment];var getFn=fn.get||fn;var out=this._applyFn(getFn,context,extraInputs,parent);return out;};FnExpression.prototype._lookupParent=function(context){// Lookup function on current controller
var controller=context.controller;var segments=this.parentSegments;var parent=segments?lookup(segments,controller):controller;if(parent&&parent[this.lastSegment])return parent;// Otherwise lookup function on page
var page=controller.page;if(controller!==page){parent=segments?lookup(segments,page):page;if(parent&&parent[this.lastSegment])return parent;}// Otherwise lookup function on global
parent=segments?lookup(segments,global):global;if(parent&&parent[this.lastSegment])return parent;// Throw if not found
throw new Error('Function not found for: '+this.segments.join('.'));};FnExpression.prototype._getInputs=function(context){var inputs=[];for(var i=0,len=this.args.length;i<len;i++){var value=this.args[i].get(context);inputs.push(renderValue(value,context));}return inputs;};FnExpression.prototype._applyFn=function(fn,context,extraInputs,thisArg){// Apply if there are no path inputs
if(!this.args){return extraInputs?fn.apply(thisArg,extraInputs):fn.call(thisArg);}// Otherwise, get the current value for path inputs and apply
var inputs=this._getInputs(context);if(extraInputs){for(var i=0,len=extraInputs.length;i<len;i++){inputs.push(extraInputs[i]);}}return fn.apply(thisArg,inputs);};FnExpression.prototype.dependencies=function(context,options){var dependencies=[];if(!this.args)return dependencies;for(var i=0,len=this.args.length;i<len;i++){var argDependencies=this.args[i].dependencies(context,options);if(!argDependencies||argDependencies.length<1)continue;var end=argDependencies.length-1;for(var j=0;j<end;j++){dependencies.push(argDependencies[j]);}var last=argDependencies[end];if(last[last.length-1]!=='*'){last=last.concat('*');}dependencies.push(last);}return dependencies;};FnExpression.prototype.set=function(context,value){var controller=context.controller;var fn,parent;while(controller){parent=this.parentSegments?lookup(this.parentSegments,controller):controller;fn=parent&&parent[this.lastSegment];if(fn)break;controller=controller.parent;}var setFn=fn&&fn.set;if(!setFn)throw new Error('No setter function for: '+this.segments.join('.'));var inputs=this._getInputs(context);inputs.unshift(value);var out=setFn.apply(parent,inputs);for(var i in out){this.args[i].set(context,out[i]);}};function NewExpression(segments,args,afterSegments,meta){FnExpression.call(this,segments,args,afterSegments,meta);}NewExpression.prototype=Object.create(FnExpression.prototype);NewExpression.prototype.constructor=NewExpression;NewExpression.prototype.type='NewExpression';NewExpression.prototype._applyFn=function(Fn,context){// Apply if there are no path inputs
if(!this.args)return new Fn();// Otherwise, get the current value for path inputs and apply
var inputs=this._getInputs(context);inputs.unshift(null);return new(Fn.bind.apply(Fn,inputs))();};function OperatorExpression(name,args,afterSegments,meta){this.name=name;this.args=args;this.afterSegments=afterSegments;this.meta=meta;this.getFn=operatorFns.get[name];this.setFn=operatorFns.set[name];}OperatorExpression.prototype=Object.create(FnExpression.prototype);OperatorExpression.prototype.constructor=OperatorExpression;OperatorExpression.prototype.type='OperatorExpression';OperatorExpression.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.args,this.afterSegments,this.meta);};OperatorExpression.prototype.apply=function(context){var inputs=this._getInputs(context);return this.getFn.apply(null,inputs);};OperatorExpression.prototype.set=function(context,value){var inputs=this._getInputs(context);inputs.unshift(value);var out=this.setFn.apply(null,inputs);for(var i in out){this.args[i].set(context,out[i]);}};function SequenceExpression(args,afterSegments,meta){this.args=args;this.afterSegments=afterSegments;this.meta=meta;}SequenceExpression.prototype=Object.create(OperatorExpression.prototype);SequenceExpression.prototype.constructor=SequenceExpression;SequenceExpression.prototype.type='SequenceExpression';SequenceExpression.prototype.serialize=function(){return serializeObject.instance(this,this.args,this.afterSegments,this.meta);};SequenceExpression.prototype.name=',';SequenceExpression.prototype.getFn=operatorFns.get[','];SequenceExpression.prototype.resolve=function(context){var last=this.args[this.args.length-1];return last.resolve(context);};SequenceExpression.prototype.dependencies=function(context,options){var dependencies=[];for(var i=0,len=this.args.length;i<len;i++){var argDependencies=this.args[i].dependencies(context,options);for(var j=0,jLen=argDependencies.length;j<jLen;j++){dependencies.push(argDependencies[j]);}}return dependencies;};// For each method that takes a context argument, get the nearest parent view
// context, then delegate methods to the inner expression
function ViewParentExpression(expression,meta){this.expression=expression;this.meta=meta;}ViewParentExpression.prototype=Object.create(Expression.prototype);ViewParentExpression.prototype.constructor=ViewParentExpression;ViewParentExpression.prototype.type='ViewParentExpression';ViewParentExpression.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.meta);};ViewParentExpression.prototype.get=function(context){var parentContext=context.forViewParent();return this.expression.get(parentContext);};ViewParentExpression.prototype.resolve=function(context){var parentContext=context.forViewParent();return this.expression.resolve(parentContext);};ViewParentExpression.prototype.dependencies=function(context,options){var parentContext=context.forViewParent();return this.expression.dependencies(parentContext,options);};ViewParentExpression.prototype.pathSegments=function(context){var parentContext=context.forViewParent();return this.expression.pathSegments(parentContext);};ViewParentExpression.prototype.set=function(context,value){var parentContext=context.forViewParent();return this.expression.set(parentContext,value);};function ScopedModelExpression(expression,meta){this.expression=expression;this.meta=meta;}ScopedModelExpression.prototype=Object.create(Expression.prototype);ScopedModelExpression.prototype.constructor=ScopedModelExpression;ScopedModelExpression.prototype.type='ScopedModelExpression';ScopedModelExpression.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.meta);};// Return a scoped model instead of the value
ScopedModelExpression.prototype.get=function(context){var segments=this.pathSegments(context);if(!segments)return;return context.controller.model.scope(segments.join('.'));};// Delegate other methods to the inner expression
ScopedModelExpression.prototype.resolve=function(context){return this.expression.resolve(context);};ScopedModelExpression.prototype.dependencies=function(context,options){return this.expression.dependencies(context,options);};ScopedModelExpression.prototype.pathSegments=function(context){return this.expression.pathSegments(context);};ScopedModelExpression.prototype.set=function(context,value){return this.expression.set(context,value);};function getDependencies(value,context,options){if(value instanceof Expression||value instanceof Template){return value.dependencies(context,options);}}function appendDependency(dependencies,expression,context){var segments=expression.resolve(context);if(!segments)return dependencies;if(dependencies){dependencies.push(segments);return dependencies;}return[segments];}function swapLastDependency(dependencies,expression,context){if(!expression.segments.length){return dependencies;}var segments=expression.resolve(context);if(!segments)return dependencies;if(dependencies){dependencies.pop();dependencies.push(segments);return dependencies;}return[segments];}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{"./operatorFns":19,"./templates":21,"./util":22,"serialize-object":76}],19:[function(require,module,exports){// `-` and `+` can be either unary or binary, so all unary operators are
// postfixed with `U` to differentiate
exports.get={// Unary operators
'!U':function U(value){return!value;},'-U':function U(value){return-value;},'+U':function U(value){return+value;},'~U':function U(value){return~value;},'typeofU':function typeofU(value){return _typeof(value);}// Binary operators
,'||':function _(left,right){return left||right;},'&&':function _(left,right){return left&&right;},'|':function _(left,right){return left|right;},'^':function _(left,right){return left^right;},'&':function _(left,right){return left&right;},'==':function _(left,right){return left==right;// jshint ignore:line
},'!=':function _(left,right){return left!=right;// jshint ignore:line
},'===':function _(left,right){return left===right;},'!==':function _(left,right){return left!==right;},'<':function _(left,right){return left<right;},'>':function _(left,right){return left>right;},'<=':function _(left,right){return left<=right;},'>=':function _(left,right){return left>=right;},'instanceof':function _instanceof(left,right){return left instanceof right;},'in':function _in(left,right){return left in right;},'<<':function _(left,right){return left<<right;},'>>':function _(left,right){return left>>right;},'>>>':function _(left,right){return left>>>right;},'+':function _(left,right){return left+right;},'-':function _(left,right){return left-right;},'*':function _(left,right){return left*right;},'/':function _(left,right){return left/right;},'%':function _(left,right){return left%right;}// Conditional operator
,'?':function _(test,consequent,alternate){return test?consequent:alternate;},// Sequence
',':function _(){return arguments[arguments.length-1];}};exports.set={// Unary operators
'!U':function U(value){return[!value];},'-U':function U(value){return[-value];}// Binary operators
,'==':function _(value,left,right){if(value)return[right];},'===':function _(value,left,right){if(value)return[right];},'in':function _in(value,left,right){right[left]=true;return{1:right};},'+':function _(value,left,right){return[value-right];},'-':function _(value,left,right){return[value+right];},'*':function _(value,left,right){return[value/right];},'/':function _(value,left,right){return[value*right];}};},{}],20:[function(require,module,exports){var templates=require('./templates');exports.DependencyOptions=DependencyOptions;function DependencyOptions(options){this.setIgnoreTemplate(options&&options.ignoreTemplate);}DependencyOptions.shouldIgnoreTemplate=function(template,options){return options?options.ignoreTemplate===template:false;};DependencyOptions.prototype.setIgnoreTemplate=function(template){while(template instanceof templates.ContextClosure){template=template.template;}this.ignoreTemplate=template;};},{"./templates":21}],21:[function(require,module,exports){var saddle=require('saddle');var serializeObject=require('serialize-object');var DependencyOptions=require('./options').DependencyOptions;var util=require('./util');var concat=util.concat;var hasKeys=util.hasKeys;var traverseAndCreate=util.traverseAndCreate;(function(){for(var key in saddle){exports[key]=saddle[key];}})();exports.Marker=Marker;exports.View=View;exports.ViewInstance=ViewInstance;exports.DynamicViewInstance=DynamicViewInstance;exports.ViewParent=ViewParent;exports.ContextClosure=ContextClosure;exports.Views=Views;exports.MarkupHook=MarkupHook;exports.ElementOn=ElementOn;exports.ComponentOn=ComponentOn;exports.AsProperty=AsProperty;exports.AsObject=AsObject;exports.AsObjectComponent=AsObjectComponent;exports.AsArray=AsArray;exports.AsArrayComponent=AsArrayComponent;exports.emptyTemplate=new saddle.Template([]);// Add ::isUnbound to Template && Binding
saddle.Template.prototype.isUnbound=function(context){return context.unbound;};saddle.Binding.prototype.isUnbound=function(){return this.template.expression.isUnbound(this.context);};// Add Template::resolve
saddle.Template.prototype.resolve=function(){};// The Template::dependencies method is specific to how Derby bindings work,
// so extend all of the Saddle Template types here
saddle.Template.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;return concatArrayDependencies(null,this.content,context,options);};saddle.Doctype.prototype.dependencies=function(){};saddle.Text.prototype.dependencies=function(){};saddle.DynamicText.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;return getDependencies(this.expression,context,options);};saddle.Comment.prototype.dependencies=function(){};saddle.DynamicComment.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;return getDependencies(this.expression,context,options);};saddle.Html.prototype.dependencies=function(){};saddle.DynamicHtml.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;return getDependencies(this.expression,context,options);};saddle.Element.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var dependencies=concatMapDependencies(null,this.attributes,context,options);if(!this.content)return dependencies;return concatArrayDependencies(dependencies,this.content,context,options);};saddle.DynamicElement.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var dependencies=saddle.Element.prototype.dependencies(context,options);return concatDependencies(dependencies,this.tagName,context,options);};saddle.Block.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var dependencies=this.expression.meta&&this.expression.meta.blockType==='on'?getDependencies(this.expression,context,options):null;var blockContext=context.child(this.expression);return concatArrayDependencies(dependencies,this.content,blockContext,options);};saddle.ConditionalBlock.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var condition=this.getCondition(context);if(condition==null){return getDependencies(this.expressions[0],context,options);}var dependencies=concatSubArrayDependencies(null,this.expressions,context,options,condition);var expression=this.expressions[condition];var content=this.contents[condition];var blockContext=context.child(expression);return concatArrayDependencies(dependencies,content,blockContext,options);};saddle.EachBlock.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var dependencies=getDependencies(this.expression,context,options);var items=this.expression.get(context);if(items&&items.length){for(var i=0;i<items.length;i++){var itemContext=context.eachChild(this.expression,i);dependencies=concatArrayDependencies(dependencies,this.content,itemContext,options);}}else if(this.elseContent){dependencies=concatArrayDependencies(dependencies,this.elseContent,context,options);}return dependencies;};saddle.Attribute.prototype.dependencies=function(){};saddle.DynamicAttribute.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;return getDependencies(this.expression,context,options);};function concatSubArrayDependencies(dependencies,expressions,context,options,end){for(var i=0;i<=end;i++){dependencies=concatDependencies(dependencies,expressions[i],context,options);}return dependencies;}function concatArrayDependencies(dependencies,expressions,context,options){for(var i=0;i<expressions.length;i++){dependencies=concatDependencies(dependencies,expressions[i],context,options);}return dependencies;}function concatMapDependencies(dependencies,expressions,context,options){for(var key in expressions){dependencies=concatDependencies(dependencies,expressions[key],context,options);}return dependencies;}function concatDependencies(dependencies,expression,context,options){var expressionDependencies=getDependencies(expression,context,options);return concat(dependencies,expressionDependencies);}function getDependencies(expression,context,options){return expression.dependencies(context,options);}var markerHooks=[{emit:function emit(context,node){node.$component=context.controller;context.controller.markerNode=node;}}];function Marker(data){saddle.Comment.call(this,data,markerHooks);}Marker.prototype=Object.create(saddle.Comment.prototype);Marker.prototype.constructor=Marker;Marker.prototype.type='Marker';Marker.prototype.serialize=function(){return serializeObject.instance(this,this.data);};Marker.prototype.get=function(){return'';};function ViewAttributesMap(source){var items=source.split(/\s+/);for(var i=0,len=items.length;i<len;i++){this[items[i]]=true;}}function ViewArraysMap(source){var items=source.split(/\s+/);for(var i=0,len=items.length;i<len;i++){var item=items[i].split('/');this[item[0]]=item[1]||item[0];}}function View(views,name,source,options){this.views=views;this.name=name;this.source=source;this.options=options;var nameSegments=(this.name||'').split(':');var lastSegment=nameSegments.pop();this.namespace=nameSegments.join(':');this.registeredName=lastSegment==='index'?this.namespace:this.name;this.attributesMap=options&&options.attributes&&new ViewAttributesMap(options.attributes);this.arraysMap=options&&options.arrays&&new ViewArraysMap(options.arrays);// The empty string is considered true for easier HTML attribute parsing
this.unminified=options&&(options.unminified||options.unminified==='');this.string=options&&(options.string||options.string==='');this.literal=options&&(options.literal||options.literal==='');this.template=null;this.componentFactory=null;this.fromSerialized=false;}View.prototype=Object.create(saddle.Template.prototype);View.prototype.constructor=View;View.prototype.type='View';View.prototype.serialize=function(){return null;};View.prototype._isComponent=function(context){if(!this.componentFactory)return false;if(context.attributes&&context.attributes.extend)return false;return true;};View.prototype._initComponent=function(context){return this._isComponent(context)?this.componentFactory.init(context):context;};View.prototype._queueCreate=function(context,viewContext){if(this._isComponent(context)){var componentFactory=this.componentFactory;context.queue(function queuedCreate(){componentFactory.create(viewContext);});if(!context.hooks)return;context.queue(function queuedComponentHooks(){// Kick off hooks if view instance specified `on` or `as` attributes
for(var i=0,len=context.hooks.length;i<len;i++){context.hooks[i].emit(context,viewContext.controller);}});}};View.prototype.get=function(context,unescaped){var viewContext=this._initComponent(context);var template=this.template||this.parse();return template.get(viewContext,unescaped);};View.prototype.getFragment=function(context,binding){var viewContext=this._initComponent(context);var template=this.template||this.parse();var fragment=template.getFragment(viewContext,binding);this._queueCreate(context,viewContext);return fragment;};View.prototype.appendTo=function(parent,context){var viewContext=this._initComponent(context);var template=this.template||this.parse();template.appendTo(parent,viewContext);this._queueCreate(context,viewContext);};View.prototype.attachTo=function(parent,node,context){var viewContext=this._initComponent(context);var template=this.template||this.parse();var node=template.attachTo(parent,node,viewContext);this._queueCreate(context,viewContext);return node;};View.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var template=this.template||this.parse();// We can't figure out relative path dependencies within a component without
// rendering it, because each component instance's scope is dynamically set
// based on its unique `id` property. To represent this, set the context
// controller to `null`.
//
// Under normal rendering conditions, contexts should always have reference
// to a controller. Expression::get() methods use the reference to
// `context.controller.model.data` to lookup values, and paths are resolved
// based on `context.controller.model._scope`.
//
// To handle this, Expression methods guard against a null controller by not
// returning any dependencies for model paths. In addition, they return
// `undefined` from get, which affect dependencies computed for
// ConditionalBlock and EachBlock, as their dependencies will differ based
// on the value of model data.
//
// TODO: This likely under-estimates the true dependencies within a
// template. However, to provide a more complete view of dependencies, we'd
// need information we only have at render time, namely, the scope and data
// within the component model. This may indicate that Derby should use a
// more Functional Reactive Programming (FRP)-like approach of having
// dependencies be returned from getFragment and attach methods along with
// DOM nodes rather than computing dependencies separately from rendering.
var viewContext=this._isComponent(context)?context.componentChild(null):context;return template.dependencies(viewContext,options);};View.prototype.parse=function(){this._parse();if(this.componentFactory){var marker=new Marker(this.name);this.template.content.unshift(marker);}return this.template;};// View.prototype._parse is defined in parsing.js, so that it doesn't have to
// be included in the client if templates are all parsed server-side
View.prototype._parse=function(){throw new Error('View parsing not available');};function ViewInstance(name,attributes,hooks,initHooks){this.name=name;this.attributes=attributes;this.hooks=hooks;this.initHooks=initHooks;this.view=null;}ViewInstance.prototype=Object.create(saddle.Template.prototype);ViewInstance.prototype.constructor=ViewInstance;ViewInstance.prototype.type='ViewInstance';ViewInstance.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.attributes,this.hooks,this.initHooks);};ViewInstance.prototype.get=function(context,unescaped){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks,this.initHooks);return view.get(viewContext,unescaped);};ViewInstance.prototype.getFragment=function(context,binding){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks,this.initHooks);return view.getFragment(viewContext,binding);};ViewInstance.prototype.appendTo=function(parent,context){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks,this.initHooks);view.appendTo(parent,viewContext);};ViewInstance.prototype.attachTo=function(parent,node,context){var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks,this.initHooks);return view.attachTo(parent,node,viewContext);};ViewInstance.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var view=this._find(context);var viewContext=context.viewChild(view,this.attributes,this.hooks,this.initHooks);return view.dependencies(viewContext,options);};ViewInstance.prototype._find=function(context){if(this.view)return this.view;var contextView=context.getView();var namespace=contextView&&contextView.namespace;this.view=context.meta.views.find(this.name,namespace);if(!this.view){var message=context.meta.views.findErrorMessage(this.name,contextView);throw new Error(message);}return this.view;};function DynamicViewInstance(nameExpression,attributes,hooks,initHooks){this.nameExpression=nameExpression;this.attributes=attributes;this.hooks=hooks;this.initHooks=initHooks;}DynamicViewInstance.prototype=Object.create(ViewInstance.prototype);DynamicViewInstance.prototype.constructor=DynamicViewInstance;DynamicViewInstance.prototype.type='DynamicViewInstance';DynamicViewInstance.prototype.serialize=function(){return serializeObject.instance(this,this.nameExpression,this.attributes,this.hooks,this.initHooks);};DynamicViewInstance.prototype._find=function(context){var name=this.nameExpression.get(context);var contextView=context.getView();var namespace=contextView&&contextView.namespace;var view=name&&context.meta.views.find(name,namespace);return view||exports.emptyTemplate;};DynamicViewInstance.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var nameDependencies=this.nameExpression.dependencies(context);var viewDependencies=ViewInstance.prototype.dependencies.call(this,context,options);return concat(nameDependencies,viewDependencies);};// Without a ContextClosure, ViewParent will return the nearest context that
// is the parent of a view instance. When a context with a `closure` property
// is encountered first, ViewParent will find the specific referenced context,
// even if it is further up the context hierarchy.
function ViewParent(template){this.template=template;}ViewParent.prototype=Object.create(saddle.Template.prototype);ViewParent.prototype.constructor=ViewParent;ViewParent.prototype.type='ViewParent';ViewParent.prototype.serialize=function(){return serializeObject.instance(this,this.template);};ViewParent.prototype.get=function(context,unescaped){var parentContext=context.forViewParent();return this.template.get(parentContext,unescaped);};ViewParent.prototype.getFragment=function(context,binding){var parentContext=context.forViewParent();return this.template.getFragment(parentContext,binding);};ViewParent.prototype.appendTo=function(parent,context){var parentContext=context.forViewParent();this.template.appendTo(parent,parentContext);};ViewParent.prototype.attachTo=function(parent,node,context){var parentContext=context.forViewParent();return this.template.attachTo(parent,node,parentContext);};ViewParent.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this,options))return;var parentContext=context.forViewParent();return this.template.dependencies(parentContext,options);};// At render time, this template creates a context child and sets its
// `closure` property to a fixed reference. It is used in combination with
// ViewParent in order to control which context is returned.
//
// Instances of this template cannot be serialized. It is intended for use
// dynamically during rendering only.
function ContextClosure(template,context){this.template=template;this.context=context;}ContextClosure.prototype=Object.create(saddle.Template.prototype);ContextClosure.prototype.constructor=ContextClosure;ContextClosure.prototype.serialize=function(){throw new Error('ContextClosure cannot be serialized');};ContextClosure.prototype.get=function(context,unescaped){var closureContext=context.closureChild(this.context);return this.template.get(closureContext,unescaped);};ContextClosure.prototype.getFragment=function(context,binding){var closureContext=context.closureChild(this.context);return this.template.getFragment(closureContext,binding);};ContextClosure.prototype.appendTo=function(parent,context){var closureContext=context.closureChild(this.context);this.template.appendTo(parent,closureContext);};ContextClosure.prototype.attachTo=function(parent,node,context){var closureContext=context.closureChild(this.context);return this.template.attachTo(parent,node,closureContext);};ContextClosure.prototype.dependencies=function(context,options){if(DependencyOptions.shouldIgnoreTemplate(this.template,options))return;var closureContext=context.closureChild(this.context);return this.template.dependencies(closureContext,options);};ContextClosure.prototype.equals=function(other){return other instanceof ContextClosure&&this.context===other.context&&this.template.equals(other.template);};function ViewsMap(){}function Views(){this.nameMap=new ViewsMap();this.tagMap=new ViewsMap();// TODO: elementMap is deprecated and should be removed with Derby 0.6.0
this.elementMap=this.tagMap;}Views.prototype.find=function(name,namespace){var map=this.nameMap;// Exact match lookup
var exactName=namespace?namespace+':'+name:name;var match=map[exactName];if(match)return match;// Relative lookup
var segments=name.split(':');var segmentsDepth=segments.length;if(namespace)segments=namespace.split(':').concat(segments);// Iterate through segments, leaving the `segmentsDepth` segments and
// removing the second to `segmentsDepth` segment to traverse up the
// namespaces. Decrease `segmentsDepth` if not found and repeat again.
while(segmentsDepth>0){var testSegments=segments.slice();while(testSegments.length>segmentsDepth){testSegments.splice(-1-segmentsDepth,1);var testName=testSegments.join(':');var match=map[testName];if(match)return match;}segmentsDepth--;}};Views.prototype.register=function(name,source,options){var mapName=name.replace(/:index$/,'');var view=this.nameMap[mapName];if(view){// Recreate the view if it already exists. We re-apply the constructor
// instead of creating a new view object so that references to object
// can be cached after finding the first time
var componentFactory=view.componentFactory;View.call(view,this,name,source,options);view.componentFactory=componentFactory;}else{view=new View(this,name,source,options);}this.nameMap[mapName]=view;// TODO: element is deprecated and should be removed with Derby 0.6.0
var tagName=options&&(options.tag||options.element);if(tagName)this.tagMap[tagName]=view;return view;};Views.prototype.deserialize=function(items){for(var i=0;i<items.length;i++){var item=items[i];var setTemplate=item[0];var name=item[1];var source=item[2];var options=item[3];var view=this.register(name,source,options);view.parse=setTemplate;view.fromSerialized=true;}};Views.prototype.serialize=function(options){var forServer=options&&options.server;var minify=options&&options.minify;var items=[];for(var name in this.nameMap){var view=this.nameMap[name];var template=view.template||view.parse();if(!forServer&&view.options){// Do not serialize views with the `serverOnly` option, except when
// serializing for a server script
if(view.options.serverOnly)continue;// For views with the `server` option, serialize them with a blank
// template body. This allows them to be used from other views on the
// browser, but they will output nothing on the browser
if(view.options.server)template=exports.emptyTemplate;}// Serializing views as a function allows them to be constructed lazily upon
// first use. This can improve initial load times of the application when
// there are many views
items.push('[function(){return this.template='+template.serialize()+'},'+serializeObject.args([view.name,minify?null:view.source,hasKeys(view.options)?view.options:null])+']');}return'function(derbyTemplates, views){'+'var expressions = derbyTemplates.expressions,'+'templates = derbyTemplates.templates;'+'views.deserialize(['+items.join(',')+'])}';};Views.prototype.findErrorMessage=function(name,contextView){var names=Object.keys(this.nameMap);var message='Cannot find view "'+name+'" in'+[''].concat(names).join('\n  ')+'\n';if(contextView){message+='\nWithin template "'+contextView.name+'":\n'+contextView.source;}return message;};function MarkupHook(){}MarkupHook.prototype.module=saddle.Template.prototype.module;function ElementOn(name,expression){this.name=name;this.expression=expression;}ElementOn.prototype=Object.create(MarkupHook.prototype);ElementOn.prototype.constructor=ElementOn;ElementOn.prototype.type='ElementOn';ElementOn.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.expression);};ElementOn.prototype.emit=function(context,element){var elementOn=this;if(this.name==='create'){this.apply(context,element);}else if(this.name==='destroy'){var destroyListeners=element.$destroyListeners||(element.$destroyListeners=[]);destroyListeners.push(function elementOnDestroy(){elementOn.apply(context,element);});}else{element.addEventListener(this.name,function elementOnListener(event){return elementOn.apply(context,element,event);},false);}};ElementOn.prototype.apply=function(context,element,event){var modelData=context.controller.model.data;modelData.$event=event;modelData.$element=element;var out=this.expression.apply(context);delete modelData.$event;delete modelData.$element;return out;};function ComponentOn(name,expression){this.name=name;this.expression=expression;}ComponentOn.prototype=Object.create(MarkupHook.prototype);ComponentOn.prototype.constructor=ComponentOn;ComponentOn.prototype.type='ComponentOn';ComponentOn.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.expression);};ComponentOn.prototype.emit=function(context,component){var expression=this.expression;component.on(this.name,function componentOnListener(){var args=arguments.length&&Array.prototype.slice.call(arguments);return expression.apply(context,args);});};function AsProperty(segments){this.segments=segments;this.lastSegment=segments.pop();}AsProperty.prototype=Object.create(MarkupHook.prototype);AsProperty.prototype.constructor=AsProperty;AsProperty.prototype.type='AsProperty';AsProperty.prototype.serialize=function(){var segments=this.segments.concat(this.lastSegment);return serializeObject.instance(this,segments);};AsProperty.prototype.emit=function(context,target){var node=traverseAndCreate(context.controller,this.segments);node[this.lastSegment]=target;};function AsObject(segments,keyExpression){AsProperty.call(this,segments);this.keyExpression=keyExpression;}AsObject.prototype=Object.create(AsProperty.prototype);AsObject.prototype.constructor=AsObject;AsObject.prototype.type='AsObject';AsObject.prototype.serialize=function(){var segments=this.segments.concat(this.lastSegment);return serializeObject.instance(this,segments,this.keyExpression);};AsObject.prototype.emit=function(context,target){var node=traverseAndCreate(context.controller,this.segments);var object=node[this.lastSegment]||(node[this.lastSegment]={});var key=this.keyExpression.get(context);object[key]=target;this.addListeners(target,object,key);};AsObject.prototype.addListeners=function(target,object,key){this.addDestroyListener(target,function asObjectDestroy(){delete object[key];});};AsObject.prototype.addDestroyListener=function(target,listener){var listeners=target.$destroyListeners||(target.$destroyListeners=[]);listeners.push(listener);};function AsObjectComponent(segments,keyExpression){AsObject.call(this,segments,keyExpression);}AsObjectComponent.prototype=Object.create(AsObject.prototype);AsObjectComponent.prototype.constructor=AsObjectComponent;AsObjectComponent.prototype.type='AsObjectComponent';AsObjectComponent.prototype.addDestroyListener=function(target,listener){target.on('destroy',listener);};function AsArray(segments){AsProperty.call(this,segments);}AsArray.prototype=Object.create(AsProperty.prototype);AsArray.prototype.constructor=AsArray;AsArray.prototype.type='AsArray';AsArray.prototype.emit=function(context,target){var node=traverseAndCreate(context.controller,this.segments);var array=node[this.lastSegment]||(node[this.lastSegment]=[]);// Iterate backwards, since rendering will usually append
for(var i=array.length;i--;){var item=array[i];// Don't add an item if already in the array
if(item===target)return;var mask=this.comparePosition(target,item);// If the emitted target is after the current item in the document,
// insert it next in the array
// Node.DOCUMENT_POSITION_FOLLOWING = 4
if(mask&4){array.splice(i+1,0,target);this.addListeners(target,array);return;}}// Add to the beginning if before all items
array.unshift(target);this.addListeners(target,array);};AsArray.prototype.addListeners=function(target,array){this.addDestroyListener(target,function asArrayDestroy(){var index=array.indexOf(target);if(index!==-1)array.splice(index,1);});};AsArray.prototype.comparePosition=function(target,item){return item.compareDocumentPosition(target);};AsArray.prototype.addDestroyListener=AsObject.prototype.addDestroyListener;function AsArrayComponent(segments){AsArray.call(this,segments);}AsArrayComponent.prototype=Object.create(AsArray.prototype);AsArrayComponent.prototype.constructor=AsArrayComponent;AsArrayComponent.prototype.type='AsArrayComponent';AsArrayComponent.prototype.comparePosition=function(target,item){return item.markerNode.compareDocumentPosition(target.markerNode);};AsArrayComponent.prototype.addDestroyListener=AsObjectComponent.prototype.addDestroyListener;},{"./options":20,"./util":22,"saddle":75,"serialize-object":76}],22:[function(require,module,exports){exports.concat=function(a,b){if(!a)return b;if(!b)return a;return a.concat(b);};exports.hasKeys=function(value){if(!value)return false;for(var key in value){return true;}return false;};exports.traverseAndCreate=function(node,segments){var len=segments.length;if(!len)return node;for(var i=0;i<len;i++){var segment=segments[i];node=node[segment]||(node[segment]={});}return node;};},{}],23:[function(require,module,exports){/*
 * App.js
 *
 * Provides the glue between views, controllers, and routes for an
 * application's functionality. Apps are responsible for creating pages.
 *
 */var path=require('path');var EventEmitter=require('events').EventEmitter;var tracks=require('tracks');var util=require('racer/lib/util');var derbyTemplates=require('derby-templates');var templates=derbyTemplates.templates;var components=require('./components');var PageBase=require('./Page');var serializedViews=require('./_views');module.exports=App;function App(derby,name,filename,options){EventEmitter.call(this);this.derby=derby;this.name=name;this.filename=filename;this.scriptHash='f9af8510bf133d6031c7be9be39b6b3d';this.bundledAt=1580746977713;this.Page=createAppPage(derby);this.proto=this.Page.prototype;this.views=new templates.Views();this.tracksRoutes=tracks.setup(this);this.model=null;this.page=null;this._pendingComponentMap={};this._init(options);}function createAppPage(derby){var Page=derby&&derby.Page||PageBase;// Inherit from Page/PageForServer so that we can add controller functions as prototype
// methods on this app's pages
function AppPage(){Page.apply(this,arguments);}AppPage.prototype=Object.create(Page.prototype);return AppPage;}util.mergeInto(App.prototype,EventEmitter.prototype);// Overriden on server
App.prototype._init=function(){this._waitForAttach=true;this._cancelAttach=false;this.model=new this.derby.Model();serializedViews(derbyTemplates,this.views);// Must init async so that app.on('model') listeners can be added.
// Must also wait for content ready so that bundle is fully downloaded.
this._contentReady();};App.prototype._finishInit=function(){var script=this._getScript();var data=JSON.parse(script.nextSibling.innerHTML);this.model.createConnection(data);this.emit('model',this.model);util.isProduction=data.nodeEnv==='production';if(!util.isProduction)this._autoRefresh();this.model.unbundle(data);var page=this.createPage();page.params=this.model.get('$render.params');this.emit('ready',page);this._waitForAttach=false;// Instead of attaching, do a route and render if a link was clicked before
// the page finished attaching
if(this._cancelAttach){this.history.refresh();return;}// Since an attachment failure is *fatal* and could happen as a result of a
// browser extension like AdBlock, an invalid template, or a small bug in
// Derby or Saddle, re-render from scratch on production failures
if(util.isProduction){try{page.attach();}catch(err){this.history.refresh();console.warn('attachment error',err.stack);}}else{page.attach();}this.emit('load',page);};// Modified from: https://github.com/addyosmani/jquery.parts/blob/master/jquery.documentReady.js
App.prototype._contentReady=function(){// Is the DOM ready to be used? Set to true once it occurs.
var isReady=false;var app=this;// The ready event handler
function onDOMContentLoaded(){if(document.addEventListener){document.removeEventListener('DOMContentLoaded',onDOMContentLoaded,false);}else{// we're here because readyState !== 'loading' in oldIE
// which is good enough for us to call the dom ready!
document.detachEvent('onreadystatechange',onDOMContentLoaded);}onDOMReady();}// Handle when the DOM is ready
function onDOMReady(){// Make sure that the DOM is not already loaded
if(isReady)return;// Make sure body exists, at least, in case IE gets a little overzealous (ticket #5443).
if(!document.body)return setTimeout(onDOMReady,0);// Remember that the DOM is ready
isReady=true;// Make sure this is always async and then finishin init
setTimeout(function(){app._finishInit();},0);}// The DOM ready check for Internet Explorer
function doScrollCheck(){if(isReady)return;try{// If IE is used, use the trick by Diego Perini
// http://javascript.nwbox.com/IEContentLoaded/
document.documentElement.doScroll('left');}catch(err){setTimeout(doScrollCheck,0);return;}// and execute any waiting functions
onDOMReady();}// Catch cases where called after the browser event has already occurred.
if(document.readyState!=='loading')return onDOMReady();// Mozilla, Opera and webkit nightlies currently support this event
if(document.addEventListener){// Use the handy event callback
document.addEventListener('DOMContentLoaded',onDOMContentLoaded,false);// A fallback to window.onload, that will always work
window.addEventListener('load',onDOMContentLoaded,false);// If IE event model is used
}else if(document.attachEvent){// ensure firing before onload,
// maybe late but safe also for iframes
document.attachEvent('onreadystatechange',onDOMContentLoaded);// A fallback to window.onload, that will always work
window.attachEvent('onload',onDOMContentLoaded);// If IE and not a frame
// continually check to see if the document is ready
var toplevel;try{toplevel=window.frameElement==null;}catch(err){}if(document.documentElement.doScroll&&toplevel){doScrollCheck();}}};App.prototype._getScript=function(){return document.querySelector('script[data-derby-app]');};App.prototype.use=util.use;App.prototype.serverUse=util.serverUse;App.prototype.loadViews=function(){};App.prototype.loadStyles=function(){};// This function is overriden by requiring 'derby/parsing'
App.prototype.addViews=function(){throw new Error('Parsing not available. Registering a view from source should not be used '+'in application code. Instead, specify a filename with view.file.');};App.prototype.component=function(name,constructor,isDependency){if(typeof name==='function'){constructor=name;name=null;}if(typeof constructor!=='function'){throw new Error('Missing component constructor argument');}var viewProp=constructor.view;var viewIs,viewFilename,viewSource,viewDependencies;// Always using an object for the static `view` property is preferred
if(viewProp&&_typeof(viewProp)==='object'){viewIs=viewProp.is;viewFilename=viewProp.file;viewSource=viewProp.source;viewDependencies=viewProp.dependencies;}else{// Ignore other properties when `view` is an object. It is possible that
// properties could be inherited from a parent component when extending it.
//
// DEPRECATED: constructor.prototype.name and constructor.prototype.view
// use the equivalent static properties instead
viewIs=constructor.is||constructor.prototype.name;viewFilename=constructor.view||constructor.prototype.view;}var viewName=name||viewIs||viewFilename&&path.basename(viewFilename,'.html');if(!viewName){throw new Error('No view specified for component');}if(viewFilename&&viewSource){throw new Error('Component may not specify both a view file and source');}// TODO: DRY. This is copy-pasted from derby-templates
var mapName=viewName.replace(/:index$/,'');var currentView=this.views.nameMap[mapName];var currentConstructor=currentView&&currentView.componentFactory?currentView.componentFactory.constructor:this._pendingComponentMap[mapName];// Avoid registering the same component twice; we want to avoid the overhead
// of loading view files from disk again. This is also what prevents
// circular dependencies from infinite looping
if(currentConstructor===constructor)return;// Calling app.component() overrides existing views or components. Prevent
// dependencies from doing this without warning
if(isDependency&&currentView&&!currentView.fromSerialized){throw new Error('Dependencies cannot override existing views. Already registered "'+viewName+'"');}// This map is used to prevent infinite loops from circular dependencies
this._pendingComponentMap[mapName]=constructor;// Recursively register component dependencies
if(viewDependencies){for(var i=0;i<viewDependencies.length;i++){var dependency=viewDependencies[i];if(Array.isArray(dependency)){this.component(dependency[0],dependency[1],true);}else{this.component(null,dependency,true);}}}// Register or find views specified by the component
var view;if(viewFilename){this.loadViews(viewFilename,viewName);view=this.views.find(viewName);}else if(viewSource){this.addViews(viewSource,viewName);view=this.views.find(viewName);}else if(name){view=this.views.find(viewName);}else{view=this.views.register(viewName,'');}if(!view){var message=this.views.findErrorMessage(viewName);throw new Error(message);}// Inherit from Component
components.extendComponent(constructor);// Associate the appropriate view with the component constructor
view.componentFactory=components.createFactory(constructor);delete this._pendingComponentMap[mapName];// Make chainable
return this;};App.prototype.createPage=function(){if(this.page){this.emit('destroyPage',this.page);this.page.destroy();}var page=new this.Page(this,this.model);this.page=page;return page;};App.prototype.onRoute=function(callback,page,next,done){if(this._waitForAttach){// Cancel any routing before the initial page attachment. Instead, do a
// render once derby is ready
this._cancelAttach=true;return;}this.emit('route',page);// HACK: To update render in transitional routes
page.model.set('$render.params',page.params);page.model.set('$render.url',page.params.url);page.model.set('$render.query',page.params.query);// If transitional
if(done){var app=this;var _done=function _done(){app.emit('routeDone',page,'transition');done();};callback.call(page,page,page.model,page.params,next,_done);return;}callback.call(page,page,page.model,page.params,next);};App.prototype._autoRefresh=function(){var app=this;var connection=this.model.connection;connection.on('connected',function(){connection.send({derby:'app',name:app.name,hash:app.scriptHash});});connection.on('receive',function(request){if(request.data.derby){var message=request.data;request.data=null;app._handleMessage(message.derby,message);}});};App.prototype._handleMessage=function(action,message){if(action==='refreshViews'){var fn=new Function('return '+message.views)();// jshint ignore:line
fn(derbyTemplates,this.views);var ns=this.model.get('$render.ns');this.page.render(ns);}else if(action==='refreshStyles'){var styleElement=document.querySelector('style[data-filename="'+message.filename+'"]');if(styleElement)styleElement.innerHTML=message.css;}else if(action==='reload'){this.model.whenNothingPending(function(){window.location=window.location;});}};},{"./Page":27,"./_views":28,"./components":29,"derby-templates":16,"events":33,"path":39,"racer/lib/util":74,"tracks":92}],24:[function(require,module,exports){var EventEmitter=require('events').EventEmitter;var util=require('racer/lib/util');var Dom=require('./Dom');module.exports=Controller;function Controller(app,page,model){EventEmitter.call(this);this.dom=new Dom(this);this.app=app;this.page=page;this.model=model;model.data.$controller=this;}util.mergeInto(Controller.prototype,EventEmitter.prototype);Controller.prototype.emitCancellable=function(){var cancelled=false;function cancel(){cancelled=true;}var args=Array.prototype.slice.call(arguments);args.push(cancel);this.emit.apply(this,args);return cancelled;};Controller.prototype.emitDelayable=function(){var args=Array.prototype.slice.call(arguments);var callback=args.pop();var delayed=false;function delay(){delayed=true;return callback;}args.push(delay);this.emit.apply(this,args);if(!delayed)callback();return delayed;};},{"./Dom":26,"events":33,"racer/lib/util":74}],25:[function(require,module,exports){/*
 * Derby.js
 * Meant to be the entry point for the framework.
 *
 */var racer=require('racer');module.exports=Derby;function Derby(){}Derby.prototype=Object.create(racer);Derby.prototype.constructor=Derby;Derby.prototype.App=require('./App');Derby.prototype.Page=require('./Page');Derby.prototype.Component=require('./components').Component;Derby.prototype.createApp=function(name,filename,options){return new this.App(this,name,filename,options);};if(!racer.util.isServer){require('./documentListeners').add(document);}},{"./App":23,"./Page":27,"./components":29,"./documentListeners":30,"racer":"racer"}],26:[function(require,module,exports){module.exports=Dom;function Dom(controller){this.controller=controller;this._listeners=null;}Dom.prototype._initListeners=function(){var dom=this;this.controller.on('destroy',function domOnDestroy(){var listeners=dom._listeners;if(!listeners)return;for(var i=listeners.length;i--;){listeners[i].remove();}dom._listeners=null;});return this._listeners=[];};Dom.prototype._listenerIndex=function(domListener){var listeners=this._listeners;if(!listeners)return-1;for(var i=listeners.length;i--;){if(listeners[i].equals(domListener))return i;}return-1;};Dom.prototype.addListener=function(type,target,listener,useCapture){if(typeof target==='function'){useCapture=listener;listener=target;target=document;}var domListener=type==='destroy'?new DestroyListener(target,listener):new DomListener(type,target,listener,useCapture);if(-1===this._listenerIndex(domListener)){var listeners=this._listeners||this._initListeners();listeners.push(domListener);}domListener.add();};Dom.prototype.on=Dom.prototype.addListener;Dom.prototype.once=function(type,target,listener,useCapture){if(typeof target==='function'){useCapture=listener;listener=target;target=document;}this.addListener(type,target,wrappedListener,useCapture);var dom=this;function wrappedListener(){dom.removeListener(type,target,wrappedListener,useCapture);return listener.apply(this,arguments);}};Dom.prototype.removeListener=function(type,target,listener,useCapture){if(typeof target==='function'){useCapture=listener;listener=target;target=document;}var domListener=new DomListener(type,target,listener,useCapture);domListener.remove();var i=this._listenerIndex(domListener);if(i>-1)this._listeners.splice(i,1);};function DomListener(type,target,listener,useCapture){this.type=type;this.target=target;this.listener=listener;this.useCapture=!!useCapture;}DomListener.prototype.equals=function(domListener){return this.listener===domListener.listener&&this.target===domListener.target&&this.type===domListener.type&&this.useCapture===domListener.useCapture;};DomListener.prototype.add=function(){this.target.addEventListener(this.type,this.listener,this.useCapture);};DomListener.prototype.remove=function(){this.target.removeEventListener(this.type,this.listener,this.useCapture);};function DestroyListener(target,listener){DomListener.call(this,'destroy',target,listener);}DestroyListener.prototype=new DomListener();DestroyListener.prototype.add=function(){var listeners=this.target.$destroyListeners||(this.target.$destroyListeners=[]);if(listeners.indexOf(this.listener)===-1){listeners.push(this.listener);}};DestroyListener.prototype.remove=function(){var listeners=this.target.$destroyListeners;if(!listeners)return;var index=listeners.indexOf(this.listener);if(index!==-1){listeners.splice(index,1);}};},{}],27:[function(require,module,exports){var derbyTemplates=require('derby-templates');var contexts=derbyTemplates.contexts;var expressions=derbyTemplates.expressions;var templates=derbyTemplates.templates;var DependencyOptions=derbyTemplates.options.DependencyOptions;var util=require('racer/lib/util');var components=require('./components');var EventModel=require('./eventmodel');var textDiff=require('./textDiff');var Controller=require('./Controller');var documentListeners=require('./documentListeners');module.exports=Page;function Page(app,model){Controller.call(this,app,this,model);this.params=null;if(this.init)this.init(model);this.context=this._createContext();this._eventModel=null;this._removeModelListeners=null;this._components={};this._addListeners();}util.mergeInto(Page.prototype,Controller.prototype);Page.prototype.$bodyClass=function(ns){if(!ns)return;var classNames=[];var segments=ns.split(':');for(var i=0,len=segments.length;i<len;i++){var className=segments.slice(0,i+1).join('-');classNames.push(className);}return classNames.join(' ');};Page.prototype.$preventDefault=function(e){e.preventDefault();};Page.prototype.$stopPropagation=function(e){e.stopPropagation();};Page.prototype._setRenderParams=function(ns){this.model.set('$render.ns',ns);this.model.set('$render.params',this.params);this.model.set('$render.url',this.params&&this.params.url);this.model.set('$render.query',this.params&&this.params.query);};Page.prototype._setRenderPrefix=function(ns){var prefix=ns?ns+':':'';this.model.set('$render.prefix',prefix);};Page.prototype.get=function(viewName,ns,unescaped){this._setRenderPrefix(ns);var view=this.getView(viewName,ns);return view.get(this.context,unescaped);};Page.prototype.getFragment=function(viewName,ns){this._setRenderPrefix(ns);var view=this.getView(viewName,ns);return view.getFragment(this.context);};Page.prototype.getView=function(viewName,ns){return this.app.views.find(viewName,ns);};Page.prototype.render=function(ns){this.app.emit('render',this);this.context.pause();this._setRenderParams(ns);var titleFragment=this.getFragment('TitleElement',ns);var bodyFragment=this.getFragment('BodyElement',ns);var titleElement=document.getElementsByTagName('title')[0];titleElement.parentNode.replaceChild(titleFragment,titleElement);document.body.parentNode.replaceChild(bodyFragment,document.body);this.context.unpause();if(this.create)this.create(this.model,this.dom);this.app.emit('routeDone',this,'render');};Page.prototype.attach=function(){this.context.pause();var ns=this.model.get('$render.ns');var titleView=this.getView('TitleElement',ns);var bodyView=this.getView('BodyElement',ns);var titleElement=document.getElementsByTagName('title')[0];titleView.attachTo(titleElement.parentNode,titleElement,this.context);bodyView.attachTo(document.body.parentNode,document.body,this.context);this.context.unpause();if(this.create)this.create(this.model,this.dom);};Page.prototype._createContext=function(){var contextMeta=new contexts.ContextMeta();contextMeta.views=this.app&&this.app.views;var context=new contexts.Context(contextMeta,this);context.expression=new expressions.PathExpression([]);context.alias='#root';return context;};Page.prototype._addListeners=function(){var eventModel=this._eventModel=new EventModel();this._addModelListeners(eventModel);this._addContextListeners(eventModel);};Page.prototype.destroy=function(){this.emit('destroy');this._removeModelListeners();for(var id in this._components){var component=this._components[id];component.destroy();}// Remove all data, refs, listeners, and reactive functions
// for the previous page
var silentModel=this.model.silent();silentModel.destroy('_page');silentModel.destroy('$components');// Unfetch and unsubscribe from all queries and documents
silentModel.unloadAll&&silentModel.unloadAll();};Page.prototype._addModelListeners=function(eventModel){var model=this.model;if(!model)return;// Registering model listeners with the *Immediate events helps to prevent
// a bug with binding updates where a model listener causes a change to the
// path being listened on, directly or indirectly.
// TODO: Remove this when upgrading Racer to the next major version. Feature
// detect which type of event listener to register by emitting a test event
if(useLegacyListeners(model)){return this._addModelListenersLegacy(eventModel);}// `util.castSegments(segments)` is needed to cast string segments into
// numbers, since EventModel#child does typeof checks against segments. This
// could be done once in Racer's Model#emit, instead of in every listener.
var changeListener=model.on('changeImmediate',function onChange(segments,event){// The pass parameter is passed in for special handling of updates
// resulting from stringInsert or stringRemove
segments=util.castSegments(segments.slice());eventModel.set(segments,event.previous,event.pass);});var loadListener=model.on('loadImmediate',function onLoad(segments){segments=util.castSegments(segments.slice());eventModel.set(segments);});var unloadListener=model.on('unloadImmediate',function onUnload(segments,event){segments=util.castSegments(segments.slice());eventModel.set(segments,event.previous);});var insertListener=model.on('insertImmediate',function onInsert(segments,event){segments=util.castSegments(segments.slice());eventModel.insert(segments,event.index,event.values.length);});var removeListener=model.on('removeImmediate',function onRemove(segments,event){segments=util.castSegments(segments.slice());eventModel.remove(segments,event.index,event.values.length);});var moveListener=model.on('moveImmediate',function onMove(segments,event){segments=util.castSegments(segments.slice());eventModel.move(segments,event.from,event.to,event.howMany);});this._removeModelListeners=function(){model.removeListener('changeImmediate',changeListener);model.removeListener('loadImmediate',loadListener);model.removeListener('unloadImmediate',unloadListener);model.removeListener('insertImmediate',insertListener);model.removeListener('removeImmediate',removeListener);model.removeListener('moveImmediate',moveListener);};};function useLegacyListeners(model){var useLegacy=true;// model.once is broken in older racer, so manually remove event
var listener=model.on('changeImmediate',function(segments,event){model.removeListener('changeImmediate',listener);// Older Racer emits an array of eventArgs, whereas newer racer emits an event object
useLegacy=Array.isArray(event);});model.set('$derby.testEvent',true);return useLegacy;}Page.prototype._addModelListenersLegacy=function(eventModel){var model=this.model;if(!model)return;// `util.castSegments(segments)` is needed to cast string segments into
// numbers, since EventModel#child does typeof checks against segments. This
// could be done once in Racer's Model#emit, instead of in every listener.
var changeListener=model.on('changeImmediate',function onChange(segments,eventArgs){// eventArgs[0] is the new value, which Derby bindings don't use directly.
var previous=eventArgs[1];// The pass parameter is passed in for special handling of updates
// resulting from stringInsert or stringRemove
var pass=eventArgs[2];segments=util.castSegments(segments.slice());eventModel.set(segments,previous,pass);});var loadListener=model.on('loadImmediate',function onLoad(segments){segments=util.castSegments(segments.slice());eventModel.set(segments);});var unloadListener=model.on('unloadImmediate',function onUnload(segments){segments=util.castSegments(segments.slice());eventModel.set(segments);});var insertListener=model.on('insertImmediate',function onInsert(segments,eventArgs){var index=eventArgs[0];var values=eventArgs[1];segments=util.castSegments(segments.slice());eventModel.insert(segments,index,values.length);});var removeListener=model.on('removeImmediate',function onRemove(segments,eventArgs){var index=eventArgs[0];var values=eventArgs[1];segments=util.castSegments(segments.slice());eventModel.remove(segments,index,values.length);});var moveListener=model.on('moveImmediate',function onMove(segments,eventArgs){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];segments=util.castSegments(segments.slice());eventModel.move(segments,from,to,howMany);});this._removeModelListeners=function(){model.removeListener('changeImmediate',changeListener);model.removeListener('loadImmediate',loadListener);model.removeListener('unloadImmediate',unloadListener);model.removeListener('insertImmediate',insertListener);model.removeListener('removeImmediate',removeListener);model.removeListener('moveImmediate',moveListener);};};Page.prototype._addContextListeners=function(eventModel){this.context.meta.addBinding=addBinding;this.context.meta.removeBinding=removeBinding;this.context.meta.removeNode=removeNode;this.context.meta.addItemContext=addItemContext;this.context.meta.removeItemContext=removeItemContext;function addItemContext(context){var segments=context.expression.resolve(context);eventModel.addItemContext(segments,context);}function removeItemContext(context){// TODO
}function addBinding(binding){patchTextBinding(binding);var expressions=binding.template.expressions;if(expressions){for(var i=0,len=expressions.length;i<len;i++){addDependencies(eventModel,expressions[i],binding);}}else{var expression=binding.template.expression;addDependencies(eventModel,expression,binding);}}function removeBinding(binding){var bindingWrappers=binding.meta;if(!bindingWrappers)return;for(var i=bindingWrappers.length;i--;){eventModel.removeBinding(bindingWrappers[i]);}}function removeNode(node){var component=node.$component;if(component)component.destroy();var destroyListeners=node.$destroyListeners;if(destroyListeners){for(var i=0;i<destroyListeners.length;i++){destroyListeners[i]();}}}};function addDependencies(eventModel,expression,binding){var bindingWrapper=new BindingWrapper(eventModel,expression,binding);bindingWrapper.updateDependencies();}// The code here uses object-based set pattern where objects are keyed using
// sequentially generated IDs.
var nextId=1;function BindingWrapper(eventModel,expression,binding){this.eventModel=eventModel;this.expression=expression;this.binding=binding;this.id=nextId++;this.eventModels=null;this.dependencies=null;this.ignoreTemplateDependency=binding instanceof components.ComponentAttributeBinding||binding.template instanceof templates.DynamicText&&binding instanceof templates.RangeBinding;if(binding.meta){binding.meta.push(this);}else{binding.meta=[this];}}BindingWrapper.prototype.updateDependencies=function(){var dependencyOptions;if(this.ignoreTemplateDependency&&this.binding.condition instanceof templates.Template){dependencyOptions=new DependencyOptions();dependencyOptions.setIgnoreTemplate(this.binding.condition);}var dependencies=this.expression.dependencies(this.binding.context,dependencyOptions);if(this.dependencies){// Do nothing if dependencies haven't changed
if(equalDependencies(this.dependencies,dependencies))return;// Otherwise, remove current dependencies
this.eventModel.removeBinding(this);}// Add new dependencies
if(!dependencies)return;this.dependencies=dependencies;for(var i=0,len=dependencies.length;i<len;i++){var dependency=dependencies[i];if(dependency)this.eventModel.addBinding(dependency,this);}};BindingWrapper.prototype.update=function(previous,pass){this.binding.update(previous,pass);this.updateDependencies();};BindingWrapper.prototype.insert=function(index,howMany){this.binding.insert(index,howMany);this.updateDependencies();};BindingWrapper.prototype.remove=function(index,howMany){this.binding.remove(index,howMany);this.updateDependencies();};BindingWrapper.prototype.move=function(from,to,howMany){this.binding.move(from,to,howMany);this.updateDependencies();};function equalDependencies(a,b){var lenA=a?a.length:-1;var lenB=b?b.length:-1;if(lenA!==lenB)return false;for(var i=0;i<lenA;i++){var itemA=a[i];var itemB=b[i];var lenItemA=itemA?itemA.length:-1;var lenItemB=itemB?itemB.length:-1;if(lenItemA!==lenItemB)return false;for(var j=0;j<lenItemB;j++){if(itemA[j]!==itemB[j])return false;}}return true;}function patchTextBinding(binding){if(binding instanceof templates.AttributeBinding&&binding.name==='value'&&(binding.element.tagName==='INPUT'||binding.element.tagName==='TEXTAREA')&&documentListeners.inputSupportsSelection(binding.element)&&binding.template.expression.resolve(binding.context)){binding.update=textInputUpdate;}}function textInputUpdate(previous,pass){textUpdate(this,this.element,previous,pass);}function textUpdate(binding,element,previous,pass){if(pass){if(pass.$event&&pass.$event.target===element){return;}else if(pass.$stringInsert){return textDiff.onStringInsert(element,previous,pass.$stringInsert.index,pass.$stringInsert.text);}else if(pass.$stringRemove){return textDiff.onStringRemove(element,previous,pass.$stringRemove.index,pass.$stringRemove.howMany);}}binding.template.update(binding.context,binding);}},{"./Controller":24,"./components":29,"./documentListeners":30,"./eventmodel":31,"./textDiff":32,"derby-templates":16,"racer/lib/util":74}],28:[function(require,module,exports){/*DERBY_SERIALIZED_VIEWS*/module.exports=function(derbyTemplates,views){var expressions=derbyTemplates.expressions,templates=derbyTemplates.templates;views.deserialize([[function(){return this.template=new templates.Template([new templates.Element('title',void 0,[new templates.Block(new templates.Template([new templates.DynamicText(new expressions.PathExpression(['$render','prefix'],new expressions.ExpressionMeta('$render.prefix'))),new templates.Text('Title')],'{{$render.prefix}}Title'),[new templates.DynamicViewInstance(new templates.Template([new templates.DynamicText(new expressions.PathExpression(['$render','prefix'],new expressions.ExpressionMeta('$render.prefix'))),new templates.Text('Title')],'{{$render.prefix}}Title'),{})])],void 0,false)]);},'TitleElement','<title><view is="{{$render.prefix}}Title"></view></title>'],[function(){return this.template=new templates.Template([new templates.Element('body',{'class':new templates.DynamicAttribute(new expressions.FnExpression(['$bodyClass'],[new expressions.PathExpression(['$render','ns'])],void 0,new expressions.ExpressionMeta('$bodyClass($render.ns)')))},[new templates.Block(new templates.Template([new templates.DynamicText(new expressions.PathExpression(['$render','prefix'],new expressions.ExpressionMeta('$render.prefix'))),new templates.Text('Body')],'{{$render.prefix}}Body'),[new templates.DynamicViewInstance(new templates.Template([new templates.DynamicText(new expressions.PathExpression(['$render','prefix'],new expressions.ExpressionMeta('$render.prefix'))),new templates.Text('Body')],'{{$render.prefix}}Body'),{})])],void 0,false,true)]);},'BodyElement','<body class="{{$bodyClass($render.ns)}}"><view is="{{$render.prefix}}Body"></view>'],[function(){return this.template=new templates.Template([new templates.Text('Charts')]);},'Title','\n  Charts\n\n'],[function(){return this.template=new templates.Template([new templates.ViewInstance('d-connection-alert',{}),new templates.Element('div',{'class':new templates.Attribute('container')},[new templates.Element('h1',void 0,[new templates.Text('Derby Charts')],void 0,false),new templates.Element('div',{'class':new templates.Attribute('charts')},[new templates.ViewInstance('tabs',{'selectedIndex':new expressions.ViewParentExpression(new expressions.PathExpression(['widgets','data','currentTab'],new expressions.ExpressionMeta('widgets.data.currentTab'))),'panes':new expressions.ArrayExpression([new expressions.ObjectExpression({'title':new expressions.LiteralExpression('Bar'),'content':new expressions.DeferRenderExpression(new templates.ViewParent(new templates.Template([new templates.Element('div',{'class':new templates.Attribute('barchart')},[new templates.ViewInstance('d-barchart-vanilla',{'data':new expressions.ViewParentExpression(new expressions.PathExpression(['widgets','data','bars'],new expressions.ExpressionMeta('widgets.data.bars'))),'width':'300','height':'200'}),new templates.Element('span',void 0,[new templates.Text('Bar chart component in '),new templates.Element('a',{'href':new templates.Attribute('https://github.com/derbyjs/d-barchart-vanilla')},[new templates.Text('vanilla JS')],void 0,false)],void 0,false)],void 0,false),new templates.Element('div',{'class':new templates.Attribute('barchart')},[new templates.ViewInstance('d-barchart',{'data':new expressions.ViewParentExpression(new expressions.PathExpression(['widgets','data','bars'],new expressions.ExpressionMeta('widgets.data.bars'))),'width':'300','height':'200'}),new templates.Element('span',void 0,[new templates.Text('Bar chart component using '),new templates.Element('a',{'target':new templates.Attribute('_blank'),'href':new templates.Attribute('https://github.com/derbyjs/d-barchart')},[new templates.Text('some d3')],void 0,false),new templates.Text(' (for layout)')],void 0,false)],void 0,false),new templates.Element('div',{'class':new templates.Attribute('barchart')},[new templates.ViewInstance('d-d3-barchart',{'data':new expressions.ViewParentExpression(new expressions.PathExpression(['widgets','data','bars'],new expressions.ExpressionMeta('widgets.data.bars'))),'width':'300','height':'200'}),new templates.Element('span',void 0,[new templates.Text('Bar chart component using '),new templates.Element('a',{'href':new templates.Attribute('https://github.com/derbyjs/d-d3-barchart')},[new templates.Text('full d3')],void 0,false)],void 0,false)],void 0,false)])))})])})],void 0,false),new templates.Element('div',{'class':new templates.Attribute('inputs')},[new templates.EachBlock(new expressions.PathExpression(['widgets','data','bars'],new expressions.ExpressionMeta('each widgets.data.bars as #d,#i','each',void 0,'#d','#i')),[new templates.Element('div',{'class':new templates.Attribute('datum')},[new templates.Element('div',{'class':new templates.Attribute('d-label')},[new templates.DynamicText(new expressions.AliasPathExpression('#i',[],new expressions.ExpressionMeta('#i'))),new templates.Text(':')],void 0,false),new templates.Element('div',{'class':new templates.Attribute('d-input')},[new templates.Element('input',{'type':new templates.Attribute('range'),'value':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['value'],new expressions.ExpressionMeta('#d.value')))},null,void 0,false),new templates.Element('button',{'class':new templates.Attribute('x button')},[new templates.Text('x')],[new templates.ElementOn('click',new expressions.FnExpression(['page','remove'],[new expressions.AliasPathExpression('#i',[])]))],false)],void 0,false)],void 0,false)]),new templates.Element('div',{'class':new templates.Attribute('add')},[new templates.Element('button',{'class':new templates.Attribute('x plus button')},[new templates.Text('+')],[new templates.ElementOn('click',new expressions.FnExpression(['page','add'],[]))],false),new templates.Text(' Add a new Bar')],void 0,false)],void 0,false)],void 0,false)]);},'Body','\n  <view is="d-connection-alert"></view>\n  <div class="container">\n    <h1>Derby Charts</h1>\n    <div class="charts">\n      <tabs selected-index="{{widgets.data.currentTab}}">\n        <pane title="Bar">\n        <div class=barchart>\n          <view is="d-barchart-vanilla" data={{widgets.data.bars}} width=300 height=200></view>\n          <span>Bar chart component in <a href="https://github.com/derbyjs/d-barchart-vanilla">vanilla JS</a></span>\n        </div>\n        <div class=barchart>\n          <view is="d-barchart" data={{widgets.data.bars}} width=300 height=200></view>\n          <span>Bar chart component using <a target=_blank href="https://github.com/derbyjs/d-barchart">some d3</a> (for layout)</span>\n        </div>\n        <div class=barchart>\n          <view is="d-d3-barchart" data={{widgets.data.bars}} width=300 height=200></view>\n          <span>Bar chart component using <a href="https://github.com/derbyjs/d-d3-barchart">full d3</a></span>\n        </div>\n\n        </pane>\n      </tabs>\n    </div>\n\n    <div class="inputs">\n      {{each widgets.data.bars as #d,#i}}\n      <div class=datum>\n        <div class="d-label">{{#i}}:</div>\n        <div class="d-input">\n          <input type=range value={{#d.value}}>\n          <button on-click="page.remove(#i)" class="x button">x</button>\n        </div>\n      </div>\n      {{/each}}\n      <div class=add>\n        <button on-click="page.add()" class="x plus button">+</button> Add a new Bar\n      </div>\n    </div>\n  </div>\n\n'],[function(){return this.template=new templates.Template([]);},'Tail',''],[function(){return this.template=new templates.Template([new templates.Marker('dropdown:index'),new templates.Element('div',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('dropdown '),new templates.DynamicText(new expressions.AttributePathExpression('class',[],new expressions.ExpressionMeta('@class'))),new templates.ConditionalBlock([new expressions.PathExpression(['open'],new expressions.ExpressionMeta('if open','if'))],[[new templates.Text(' open')]])],'dropdown {{@class}}{{if open}} open{{/if}}'))},[new templates.Element('button',{'id':new templates.DynamicAttribute(new templates.Template([new templates.Text('dropdown-toggle'),new templates.DynamicText(new expressions.PathExpression(['id'],new expressions.ExpressionMeta('id')))],'dropdown-toggle{{id}}')),'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('btn '),new templates.DynamicText(new expressions.OperatorExpression('||',[new expressions.AttributePathExpression('buttonClass',[]),new expressions.LiteralExpression('btn-default')],void 0,new expressions.ExpressionMeta('@buttonClass || \'btn-default\''))),new templates.Text(' dropdown-toggle')],'btn {{@buttonClass || \'btn-default\'}} dropdown-toggle')),'type':new templates.Attribute('button')},[new templates.DynamicText(new expressions.FnExpression(['label'],[new expressions.PathExpression(['value'])],void 0,new expressions.ExpressionMeta('label(value)'))),new templates.Text(' '),new templates.Element('span',{'class':new templates.Attribute('caret')},[],void 0,false)],[new templates.AsProperty(['toggleButton']),new templates.ElementOn('click',new expressions.FnExpression(['toggle'],[]))],false),new templates.Element('ul',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('dropdown-menu '),new templates.DynamicText(new expressions.AttributePathExpression('menuClass',[],new expressions.ExpressionMeta('@menuClass')))],'dropdown-menu {{@menuClass}}')),'role':new templates.Attribute('menu'),'aria-labelledby':new templates.DynamicAttribute(new templates.Template([new templates.Text('dropdown-toggle'),new templates.DynamicText(new expressions.PathExpression(['id'],new expressions.ExpressionMeta('id')))],'dropdown-toggle{{id}}'))},[new templates.EachBlock(new expressions.AttributePathExpression('options',[],new expressions.ExpressionMeta('each @options','each')),[new templates.Element('li',{'role':new templates.Attribute('presentation'),'class':new templates.DynamicAttribute(new expressions.RelativePathExpression(['class'],new expressions.ExpressionMeta('this.class')))},[new templates.Element('a',{'role':new templates.Attribute('menuitem'),'tabindex':new templates.Attribute('-1'),'href':new templates.Attribute('#')},[new templates.DynamicText(new expressions.RelativePathExpression(['content'],new expressions.ExpressionMeta('this.content')))],[new templates.ElementOn('click',new expressions.FnExpression(['select'],[new expressions.RelativePathExpression([])])),new templates.ElementOn('click',new expressions.FnExpression(['$preventDefault'],[new expressions.PathExpression(['$event'])]))],false)],void 0,false)])],[new templates.AsProperty(['menu'])],false)],void 0,false)]);},'dropdown:index','\n  <div class="dropdown {{@class}}{{if open}} open{{/if}}">\n    <button\n      as="toggleButton"\n      on-click="toggle()"\n      id="dropdown-toggle{{id}}"\n      class="btn {{@buttonClass || \'btn-default\'}} dropdown-toggle"\n      type="button">\n      {{label(value)}} <span class="caret"></span>\n    </button>\n    <ul as="menu" class="dropdown-menu {{@menuClass}}" role="menu" aria-labelledby="dropdown-toggle{{id}}">\n      {{each @options}}\n        <li role="presentation" class="{{this.class}}">\n          <a on-click="select(this)" role="menuitem" tabindex="-1">{{this.content}}</a>\n        </li>\n      {{/each}}\n    </ul>\n  </div>\n\n',{'arrays':'option/options','element':'dropdown'}],[function(){return this.template=new templates.Template([new templates.Marker('modal:index'),new templates.Element('div',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('modal fade'),new templates.ConditionalBlock([new expressions.PathExpression(['faded'],new expressions.ExpressionMeta('if faded','if'))],[[new templates.Text(' in')]])],'modal fade{{if faded}} in{{/if}}')),'style':new templates.DynamicAttribute(new templates.ConditionalBlock([new expressions.PathExpression(['show'],new expressions.ExpressionMeta('if show','if'))],[[new templates.Text('display: block')]]))},[new templates.Element('div',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('modal-dialog'),new templates.ConditionalBlock([new expressions.AttributePathExpression('size',[],new expressions.ExpressionMeta('if @size','if'))],[[new templates.Text(' modal-'),new templates.DynamicText(new expressions.AttributePathExpression('size',[],new expressions.ExpressionMeta('@size')))]])],'modal-dialog{{if @size}} modal-{{@size}}{{/}}'))},[new templates.Element('div',{'class':new templates.Attribute('modal-content')},[new templates.Element('div',{'class':new templates.Attribute('modal-header')},[new templates.Element('button',{'type':new templates.Attribute('button'),'class':new templates.Attribute('close'),'aria-hidden':new templates.Attribute('true')},[new templates.Text('')],[new templates.ElementOn('click',new expressions.FnExpression(['hide'],[new expressions.LiteralExpression('close')]))],false),new templates.Element('h4',{'class':new templates.Attribute('modal-title')},[new templates.DynamicText(new expressions.AttributePathExpression('title',[],new expressions.ExpressionMeta('@title')))],void 0,false)],void 0,false),new templates.Element('div',{'class':new templates.Attribute('modal-body')},[new templates.DynamicText(new expressions.AttributePathExpression('content',[],new expressions.ExpressionMeta('@content')))],void 0,false),new templates.Element('div',{'class':new templates.Attribute('modal-footer')},[new templates.EachBlock(new expressions.AttributePathExpression('actions',[],new expressions.ExpressionMeta('each @actions','each')),[new templates.Element('button',{'type':new templates.Attribute('button'),'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('btn '),new templates.DynamicText(new expressions.OperatorExpression('||',[new expressions.RelativePathExpression(['class']),new expressions.LiteralExpression('btn-default')],void 0,new expressions.ExpressionMeta('this.class || \'btn-default\'')))],'btn {{this.class || \'btn-default\'}}'))},[new templates.DynamicText(new expressions.RelativePathExpression(['content'],new expressions.ExpressionMeta('this.content')))],[new templates.ElementOn('click',new expressions.FnExpression(['hide'],[new expressions.OperatorExpression('||',[new expressions.RelativePathExpression(['value']),new expressions.RelativePathExpression(['content'])])]))],false)])],void 0,false)],[new templates.ElementOn('click',new expressions.FnExpression(['$stopPropagation'],[new expressions.PathExpression(['$event'])]))],false)],void 0,false)],[new templates.ElementOn('click',new expressions.FnExpression(['hide'],[new expressions.LiteralExpression('backdrop')]))],false),new templates.ConditionalBlock([new expressions.PathExpression(['show'],new expressions.ExpressionMeta('if show','if'))],[[new templates.Element('div',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('modal-backdrop fade'),new templates.ConditionalBlock([new expressions.PathExpression(['faded'],new expressions.ExpressionMeta('if faded','if'))],[[new templates.Text(' in')]])],'modal-backdrop fade{{if faded}} in{{/if}}'))},[],void 0,false)]])]);},'modal:index','\n  <div on-click="hide(\'backdrop\')" class="modal fade{{if faded}} in{{/if}}" style="{{if show}}display: block{{/if}}">\n    <div class="modal-dialog{{if @size}} modal-{{@size}}{{/}}">\n      <div class="modal-content" on-click="$stopPropagation($event)">\n        <div class="modal-header">\n          <button on-click="hide(\'close\')" type="button" class="close" aria-hidden="true">&times;</button>\n          <h4 class="modal-title">{{@title}}</h4>\n        </div>\n        <div class="modal-body">\n          {{@content}}\n        </div>\n        <div class="modal-footer">\n          {{each @actions}}\n            <button\n              on-click="hide(this.value || this.content)"\n              type="button"\n              class="btn {{this.class || \'btn-default\'}}">\n              {{this.content}}\n            </button>\n          {{/each}}\n        </div>\n      </div>\n    </div>\n  </div>\n  {{if show}}\n    <div class="modal-backdrop fade{{if faded}} in{{/if}}"></div>\n  {{/if}}\n\n',{'arrays':'action/actions','attributes':'title','element':'modal'}],[function(){return this.template=new templates.Template([new templates.Marker('tabs:index'),new templates.Element('ul',{'class':new templates.Attribute('nav nav-tabs')},[new templates.EachBlock(new expressions.AttributePathExpression('panes',[],new expressions.ExpressionMeta('each @panes as #pane, #i','each',void 0,'#pane','#i')),[new templates.Element('li',{'class':new templates.DynamicAttribute(new templates.ConditionalBlock([new expressions.OperatorExpression('===',[new expressions.PathExpression(['selectedIndex']),new expressions.AliasPathExpression('#i',[])],void 0,new expressions.ExpressionMeta('if selectedIndex === #i','if'))],[[new templates.Text('active')]]))},[new templates.Element('a',{'href':new templates.Attribute('#')},[new templates.DynamicText(new expressions.AliasPathExpression('#pane',['title'],new expressions.ExpressionMeta('#pane.title')))],[new templates.ElementOn('click',new expressions.FnExpression(['select'],[new expressions.AliasPathExpression('#i',[])])),new templates.ElementOn('click',new expressions.FnExpression(['$preventDefault'],[new expressions.PathExpression(['$event'])]))],false)],void 0,false)])],void 0,false),new templates.Element('div',{'class':new templates.Attribute('tab-content')},[new templates.EachBlock(new expressions.AttributePathExpression('panes',[],new expressions.ExpressionMeta('each @panes as #pane, #i','each',void 0,'#pane','#i')),[new templates.Element('div',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('tab-pane'),new templates.ConditionalBlock([new expressions.OperatorExpression('===',[new expressions.PathExpression(['selectedIndex']),new expressions.AliasPathExpression('#i',[])],void 0,new expressions.ExpressionMeta('if selectedIndex === #i','if'))],[[new templates.Text(' active')]])],'tab-pane{{if selectedIndex === #i}} active{{/if}}'))},[new templates.DynamicText(new expressions.AliasPathExpression('#pane',['content'],new expressions.ExpressionMeta('#pane.content')))],void 0,false)])],void 0,false)]);},'tabs:index','\n  <ul class="nav nav-tabs">\n    {{each @panes as #pane, #i}}\n      <li class="{{if selectedIndex === #i}}active{{/if}}">\n        <a on-click="select(#i)">{{#pane.title}}</a>\n      </li>\n    {{/each}}\n  </ul>\n  <div class="tab-content">\n    {{each @panes as #pane, #i}}\n      <div class="tab-pane{{if selectedIndex === #i}} active{{/if}}">\n        {{#pane.content}}\n      </div>\n    {{/each}}\n  </div>\n\n',{'arrays':'pane/panes','element':'tabs'}],[function(){return this.template=new templates.Template([new templates.Marker('alert:index'),new templates.Element('div',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('alert alert-'),new templates.DynamicText(new expressions.AttributePathExpression('type',[],new expressions.ExpressionMeta('@type'))),new templates.Text(' '),new templates.ConditionalBlock([new expressions.AttributePathExpression('dismiss',[],new expressions.ExpressionMeta('if @dismiss','if'))],[[new templates.Text('alert-dismissable')]]),new templates.Text(' '),new templates.ConditionalBlock([new expressions.PathExpression(['faded'],new expressions.ExpressionMeta('if faded','if'))],[[new templates.Text('fade')]])],'alert alert-{{@type}} {{if @dismiss}}alert-dismissable{{/}} {{if faded}}fade{{/}}')),'style':new templates.DynamicAttribute(new templates.ConditionalBlock([new expressions.PathExpression(['hidden'],new expressions.ExpressionMeta('if hidden','if'))],[[new templates.Text('display: none')]]))},[new templates.ConditionalBlock([new expressions.AttributePathExpression('dismiss',[],new expressions.ExpressionMeta('if @dismiss','if'))],[[new templates.Element('button',{'type':new templates.Attribute('button'),'class':new templates.Attribute('close'),'aria-hidden':new templates.Attribute('true')},[new templates.DynamicText(new expressions.AttributePathExpression('dismiss',[],new expressions.ExpressionMeta('@dismiss')))],[new templates.ElementOn('click',new expressions.FnExpression(['hide'],[]))],false)]]),new templates.DynamicText(new expressions.AttributePathExpression('content',[],new expressions.ExpressionMeta('@content')))],void 0,false)]);},'alert:index','\n  <div class="alert alert-{{@type}} {{if @dismiss}}alert-dismissable{{/}} {{if faded}}fade{{/}}" style="{{if hidden}}display: none{{/}}">\n    {{if @dismiss}}\n      <button on-click="hide()" type="button" class="close" aria-hidden="true">{{@dismiss}}</button>\n    {{/}}\n    {{@content}}\n  </div>\n',{'element':'alert','attributes':'dismiss'}],[function(){return this.template=new templates.Template([new templates.Marker('contextMenu:index'),new templates.Element('div',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('context-menu dropdown '),new templates.DynamicText(new expressions.AttributePathExpression('class',[],new expressions.ExpressionMeta('@class'))),new templates.ConditionalBlock([new expressions.PathExpression(['open'],new expressions.ExpressionMeta('if open','if'))],[[new templates.Text(' open')]])],'context-menu dropdown {{@class}}{{if open}} open{{/if}}'))},[new templates.Element('ul',{'class':new templates.DynamicAttribute(new templates.Template([new templates.Text('dropdown-menu '),new templates.DynamicText(new expressions.AttributePathExpression('menuClass',[],new expressions.ExpressionMeta('@menuClass')))],'dropdown-menu {{@menuClass}}')),'role':new templates.Attribute('menu'),'style':new templates.Attribute('position: fixed')},[new templates.ConditionalBlock([new expressions.AttributePathExpression('header',[],new expressions.ExpressionMeta('if @header','if'))],[[new templates.Element('li',{'class':new templates.Attribute('dropdown-header')},[new templates.DynamicText(new expressions.AttributePathExpression('header',[],new expressions.ExpressionMeta('@header')))],void 0,false)]]),new templates.EachBlock(new expressions.AttributePathExpression('options',[],new expressions.ExpressionMeta('each @options as #option','each',void 0,'#option')),[new templates.Element('li',{'role':new templates.Attribute('presentation'),'class':new templates.DynamicAttribute(new expressions.AliasPathExpression('#option',['class'],new expressions.ExpressionMeta('#option.class')))},[new templates.ConditionalBlock([new expressions.AliasPathExpression('#option',['content'],new expressions.ExpressionMeta('if #option.content','if'))],[[new templates.Element('a',{'role':new templates.Attribute('menuitem'),'tabindex':new templates.Attribute('-1'),'href':new templates.Attribute('#')},[new templates.DynamicText(new expressions.AliasPathExpression('#option',['content'],new expressions.ExpressionMeta('#option.content')))],[new templates.ElementOn('click',new expressions.FnExpression(['select'],[new expressions.AliasPathExpression('#option',[])])),new templates.ElementOn('click',new expressions.FnExpression(['$preventDefault'],[new expressions.PathExpression(['$event'])]))],false)]])],void 0,false)])],[new templates.AsProperty(['menu'])],false)],void 0,false)]);},'contextMenu:index','\n    <div class="context-menu dropdown {{@class}}{{if open}} open{{/if}}">\n        <ul as="menu" class="dropdown-menu {{@menuClass}}" role="menu" style="position: fixed">\n        {{if @header}}\n          <li class="dropdown-header">{{@header}}</li>\n        {{/}}\n        {{each @options as #option}}\n          <li role="presentation" class="{{#option.class}}">\n            {{if #option.content}}\n              <a on-click="select(#option)" role="menuitem" tabindex="-1">{{#option.content}}</a>\n            {{/}}\n          </li>\n        {{/}}\n    </ul>\n  </div>\n',{'arrays':'option/options','element':'contextmenu'}],[function(){return this.template=new templates.Template([new templates.Marker('d-connection-alert:index'),new templates.ConditionalBlock([new expressions.OperatorExpression('!==',[new expressions.AliasPathExpression('#root',['$connection','state']),new expressions.LiteralExpression('connected')],void 0,new expressions.ExpressionMeta('if #root.$connection.state !== \'connected\'','if'))],[[new templates.Element('div',{'class':new templates.Attribute('connection')},[new templates.Element('p',{'class':new templates.Attribute('alert alert-warning')},[new templates.ConditionalBlock([new expressions.OperatorExpression('===',[new expressions.AliasPathExpression('#root',['$connection','state']),new expressions.LiteralExpression('stopped')],void 0,new expressions.ExpressionMeta('if #root.$connection.state === \'stopped\'','if')),new expressions.Expression(new expressions.ExpressionMeta('else','else'))],[[new templates.Text('Unable to reconnect  '),new templates.Element('a',{'href':new templates.Attribute('#')},[new templates.Text('Reload')],[new templates.ElementOn('click',new expressions.FnExpression(['reload'],[])),new templates.ElementOn('click',new expressions.FnExpression(['$preventDefault'],[new expressions.PathExpression(['$event'])]))],false)],[new templates.DynamicText(new expressions.FnExpression(['sentenceCase'],[new expressions.AliasPathExpression('#root',['$connection','state'])],void 0,new expressions.ExpressionMeta('sentenceCase(#root.$connection.state)'))),new templates.ConditionalBlock([new expressions.PathExpression(['hideReconnect'],new expressions.ExpressionMeta('unless hideReconnect','unless'))],[[new templates.Text('  '),new templates.Element('a',{'href':new templates.Attribute('#')},[new templates.Text('Reconnect')],[new templates.ElementOn('click',new expressions.FnExpression(['reconnect'],[])),new templates.ElementOn('click',new expressions.FnExpression(['$preventDefault'],[new expressions.PathExpression(['$event'])]))],false)]])]])],void 0,false)],void 0,false)]])]);},'d-connection-alert:index','\n  {{if #root.$connection.state !== \'connected\'}}\n    <div class="connection">\n      <p class="alert alert-warning">\n        {{if #root.$connection.state === \'stopped\'}}\n          Unable to reconnect &ndash; <a on-click="reload()">Reload</a>\n        {{else}}\n          {{sentenceCase(#root.$connection.state)}}\n          {{unless hideReconnect}}\n            &sp;&ndash; <a on-click="reconnect()">Reconnect</a>\n          {{/unless}}\n        {{/if}}\n      </p>\n    </div>\n  {{/if}}\n\n'],[function(){return this.template=new templates.Template([new templates.Marker('d-barchart:index'),new templates.Element('div',{'class':new templates.Attribute('d-barchart')},[new templates.Element('svg',{'width':new templates.DynamicAttribute(new expressions.PathExpression(['width'],new expressions.ExpressionMeta('width'))),'height':new templates.DynamicAttribute(new expressions.PathExpression(['height'],new expressions.ExpressionMeta('height')))},[new templates.Element('g',{'class':new templates.Attribute('bars')},[new templates.EachBlock(new expressions.PathExpression(['layout'],new expressions.ExpressionMeta('each layout as #d, #i','each',void 0,'#d','#i')),[new templates.Element('rect',{'class':new templates.Attribute('bar'),'x':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['x'],new expressions.ExpressionMeta('#d.x'))),'y':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['y'],new expressions.ExpressionMeta('#d.y'))),'width':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['width'],new expressions.ExpressionMeta('#d.width'))),'height':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['height'],new expressions.ExpressionMeta('#d.height')))},[],[new templates.ElementOn('click',new expressions.FnExpression(['clicker'],[new expressions.AliasPathExpression('#d',[]),new expressions.AliasPathExpression('#i',[]),new expressions.PathExpression(['$event']),new expressions.PathExpression(['$element'])]))],false,null,'http://www.w3.org/2000/svg')])],void 0,false,null,'http://www.w3.org/2000/svg')],void 0,false,null,'http://www.w3.org/2000/svg')],void 0,false)]);},'d-barchart:index','\n  <div class="d-barchart">\n    <svg width={{width}} height={{height}}>\n      <g class="bars">\n        {{each layout as #d, #i}}\n        <rect class=bar\n          x={{#d.x}}\n          y={{#d.y}}\n          width={{#d.width}}\n          height={{#d.height}}\n          on-click=clicker(#d,#i,$event,$element)\n        ></rect>\n        {{/each}}\n      </g>\n    </svg>\n  </div>\n\n'],[function(){return this.template=new templates.Template([new templates.Marker('d-barchart-vanilla:index'),new templates.Element('div',{'class':new templates.Attribute('d-barchart-vanilla')},[new templates.Element('svg',{'width':new templates.DynamicAttribute(new expressions.PathExpression(['width'],new expressions.ExpressionMeta('width'))),'height':new templates.DynamicAttribute(new expressions.PathExpression(['height'],new expressions.ExpressionMeta('height')))},[new templates.Element('g',{'class':new templates.Attribute('bars')},[new templates.EachBlock(new expressions.PathExpression(['layout'],new expressions.ExpressionMeta('each layout as #d, #i','each',void 0,'#d','#i')),[new templates.Element('rect',{'class':new templates.Attribute('bar'),'x':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['x'],new expressions.ExpressionMeta('#d.x'))),'y':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['y'],new expressions.ExpressionMeta('#d.y'))),'width':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['width'],new expressions.ExpressionMeta('#d.width'))),'height':new templates.DynamicAttribute(new expressions.AliasPathExpression('#d',['height'],new expressions.ExpressionMeta('#d.height')))},[],[new templates.ElementOn('click',new expressions.FnExpression(['clicker'],[new expressions.AliasPathExpression('#d',[]),new expressions.AliasPathExpression('#i',[]),new expressions.PathExpression(['$event']),new expressions.PathExpression(['$element'])]))],false,null,'http://www.w3.org/2000/svg')])],void 0,false,null,'http://www.w3.org/2000/svg')],void 0,false,null,'http://www.w3.org/2000/svg')],void 0,false)]);},'d-barchart-vanilla:index','\n  <div class="d-barchart-vanilla">\n    <svg width={{width}} height={{height}}>\n      <g class="bars">\n        {{each layout as #d, #i}}\n        <rect class=bar\n          x={{#d.x}}\n          y={{#d.y}}\n          width={{#d.width}}\n          height={{#d.height}}\n          on-click=clicker(#d,#i,$event,$element)\n        >\n        </rect>\n        {{/each}}\n      </g>\n    </svg>\n  </div>\n\n'],[function(){return this.template=new templates.Template([new templates.Marker('d-d3-barchart:index'),new templates.Element('div',{'class':new templates.Attribute('d-d3-barchart')},[new templates.Element('svg',{'width':new templates.DynamicAttribute(new expressions.PathExpression(['width'],new expressions.ExpressionMeta('width'))),'height':new templates.DynamicAttribute(new expressions.PathExpression(['height'],new expressions.ExpressionMeta('height')))},[new templates.Element('g',{'class':new templates.Attribute('bars')},[new templates.Block(new expressions.Expression(new expressions.ExpressionMeta('unbound','unbound')),[new templates.EachBlock(new expressions.PathExpression(['data'],new expressions.ExpressionMeta('each data as #d, #i','each',void 0,'#d','#i')),[new templates.Element('rect',{'class':new templates.Attribute('bar'),'x':new templates.DynamicAttribute(new expressions.FnExpression(['x'],[new expressions.AliasPathExpression('#d',[]),new expressions.AliasPathExpression('#i',[])],void 0,new expressions.ExpressionMeta('x(#d,#i)'))),'y':new templates.DynamicAttribute(new expressions.FnExpression(['y'],[new expressions.AliasPathExpression('#d',[]),new expressions.AliasPathExpression('#i',[])],void 0,new expressions.ExpressionMeta('y(#d,#i)'))),'width':new templates.DynamicAttribute(new expressions.FnExpression(['width'],[new expressions.AliasPathExpression('#d',[]),new expressions.AliasPathExpression('#i',[])],void 0,new expressions.ExpressionMeta('width(#d,#i)'))),'height':new templates.DynamicAttribute(new expressions.FnExpression(['height'],[new expressions.AliasPathExpression('#d',[]),new expressions.AliasPathExpression('#i',[])],void 0,new expressions.ExpressionMeta('height(#d,#i)')))},[],void 0,false,null,'http://www.w3.org/2000/svg')])])],void 0,false,null,'http://www.w3.org/2000/svg')],[new templates.AsProperty(['chart'])],false,null,'http://www.w3.org/2000/svg')],void 0,false)]);},'d-d3-barchart:index','\n  <div class="d-d3-barchart">\n    <svg as="chart" width={{width}} height={{height}}>\n      <g class="bars">\n      {{unbound}}\n        {{each data as #d, #i}}\n        <rect class=bar\n          x={{x(#d,#i)}}\n          y={{y(#d,#i)}}\n          width={{width(#d,#i)}}\n          height={{height(#d,#i)}}>\n        </rect>\n        {{/each}}\n      {{/unbound}}\n      </g>\n    </svg>\n  </div>\n\n']]);};/*DERBY_SERIALIZED_VIEWS_END*/},{}],29:[function(require,module,exports){/*
 * components.js
 *
 * Components associate custom script functionality with a view. They can be
 * distributed as standalone modules containing templates, scripts, and styles.
 * They can also be used to modularize application functionality.
 *
 */var util=require('racer/lib/util');var derbyTemplates=require('derby-templates');var templates=derbyTemplates.templates;var expressions=derbyTemplates.expressions;var Controller=require('./Controller');var slice=[].slice;exports.Component=Component;exports.ComponentAttribute=ComponentAttribute;exports.ComponentAttributeBinding=ComponentAttributeBinding;exports.ComponentFactory=ComponentFactory;exports.SingletonComponentFactory=SingletonComponentFactory;exports.createFactory=createFactory;exports.extendComponent=extendComponent;function Component(context,data){var parent=context.controller;var id=context.id();var scope=['$components',id];var model=parent.model.root.eventContext(id);model._at=scope.join('.');data.id=id;model._set(scope,data);// Store a reference to the component's scope such that the expression
// getters are relative to the component
model.data=data;Controller.call(this,parent.app,parent.page,model);this.parent=parent;this.context=context.componentChild(this);this.id=id;this._scope=scope;// Add reference to this component on the page so that all components
// associated with a page can be destroyed when the page transitions
this.page._components[id]=this;this.isDestroyed=false;}util.mergeInto(Component.prototype,Controller.prototype);Component.prototype.destroy=function(){this.emit('destroy');this.model.removeContextListeners();this.model.destroy();delete this.page._components[this.id];var components=this.page._eventModel.object.$components;if(components)delete components.object[this.id];this.isDestroyed=true;};// Apply calls to the passed in function with the component as the context.
// Stop calling back once the component is destroyed, which avoids possible bugs
// and memory leaks.
Component.prototype.bind=function(callback){var component=this;this.on('destroy',function(){// Reduce potential for memory leaks by removing references to the component
// and the passed in callback, which could have closure references
component=null;// Cease calling back after component is removed from the DOM
callback=null;});return function componentBindWrapper(){if(!callback)return;return callback.apply(component,arguments);};};// When passing in a numeric delay, calls the function at most once per that
// many milliseconds. Like Underscore, the function will be called on the
// leading and the trailing edge of the delay as appropriate. Unlike Underscore,
// calls are consistently called via setTimeout and are never synchronous. This
// should be used for reducing the frequency of ongoing updates, such as scroll
// events or other continuous streams of events.
//
// Additionally, implements an interface intended to be used with
// window.requestAnimationFrame or process.nextTick. If one of these is passed,
// it will be used to create a single async call following any number of
// synchronous calls. This mode is typically used to coalesce many synchronous
// events (such as multiple model events) into a single async event.
//
// Like component.bind(), will no longer call back once the component is
// destroyed, which avoids possible bugs and memory leaks.
Component.prototype.throttle=function(callback,delayArg){var component=this;this.on('destroy',function(){// Reduce potential for memory leaks by removing references to the component
// and the passed in callback, which could have closure references
component=null;// Cease calling back after component is removed from the DOM
callback=null;});// throttle(callback)
// throttle(callback, 150)
if(delayArg==null||typeof delayArg==='number'){var delay=delayArg||0;var nextArgs;var previous;var boundCallback=function boundCallback(){var args=nextArgs;nextArgs=null;previous=+new Date();if(callback&&args){callback.apply(component,args);}};return function componentThrottleWrapper(){var queueCall=!nextArgs;nextArgs=slice.call(arguments);if(queueCall){var now=+new Date();var remaining=Math.max(previous+delay-now,0);setTimeout(boundCallback,remaining);}};}// throttle(callback, window.requestAnimationFrame)
// throttle(callback, process.nextTick)
if(typeof delayArg==='function'){var nextArgs;var boundCallback=function boundCallback(){var args=nextArgs;nextArgs=null;if(callback&&args){callback.apply(component,args);}};return function componentThrottleWrapper(){var queueCall=!nextArgs;nextArgs=slice.call(arguments);if(queueCall)delayArg(boundCallback);};}throw new Error('Second argument must be a delay function or number');};// Suppresses calls until the function is no longer called for that many
// milliseconds. This should be used for delaying updates triggered by user
// input, such as window resizing, or typing text that has a live preview or
// client-side validation. This should not be used for inputs that trigger
// server requests, such as search autocomplete; use debounceAsync for those
// cases instead.
//
// Like component.bind(), will no longer call back once the component is
// destroyed, which avoids possible bugs and memory leaks.
Component.prototype.debounce=function(callback,delay){delay=delay||0;if(typeof delay!=='number'){throw new Error('Second argument must be a number');}var component=this;this.on('destroy',function(){// Reduce potential for memory leaks by removing references to the component
// and the passed in callback, which could have closure references
component=null;// Cease calling back after component is removed from the DOM
callback=null;});var nextArgs;var timeout;var boundCallback=function boundCallback(){var args=nextArgs;nextArgs=null;timeout=null;if(callback&&args){callback.apply(component,args);}};return function componentDebounceWrapper(){nextArgs=slice.call(arguments);if(timeout)clearTimeout(timeout);timeout=setTimeout(boundCallback,delay);};};// Forked from: https://github.com/juliangruber/async-debounce
//
// Like debounce(), suppresses calls until the function is no longer called for
// that many milliseconds. In addition, suppresses calls while the callback
// function is running. In other words, the callback will not be called again
// until the supplied done() argument is called. When the debounced function is
// called while the callback is running, the callback will be called again
// immediately after done() is called. Thus, the callback will always receive
// the last value passed to the debounced function.
//
// This avoids the potential for multiple callbacks to execute in parallel and
// complete out of order. It also acts as an adaptive rate limiter. Use this
// method to debounce any field that triggers an async call as the user types.
//
// Like component.bind(), will no longer call back once the component is
// destroyed, which avoids possible bugs and memory leaks.
Component.prototype.debounceAsync=function(callback,delay){var applyArguments=callback.length!==1;delay=delay||0;if(typeof delay!=='number'){throw new Error('Second argument must be a number');}var component=this;this.on('destroy',function(){// Reduce potential for memory leaks by removing references to the component
// and the passed in callback, which could have closure references
component=null;// Cease calling back after component is removed from the DOM
callback=null;});var running=false;var nextArgs;var timeout;function done(){var args=nextArgs;nextArgs=null;timeout=null;if(callback&&args){running=true;args.push(done);callback.apply(component,args);}else{running=false;}}return function componentDebounceAsyncWrapper(){nextArgs=applyArguments?slice.call(arguments):[];if(timeout)clearTimeout(timeout);if(running)return;timeout=setTimeout(done,delay);};};Component.prototype.get=function(viewName,unescaped){var view=this.getView(viewName);return view.get(this.context,unescaped);};Component.prototype.getFragment=function(viewName){var view=this.getView(viewName);return view.getFragment(this.context);};Component.prototype.getView=function(viewName){var contextView=this.context.getView();return viewName?this.app.views.find(viewName,contextView.namespace):contextView;};Component.prototype.getAttribute=function(key){var attributeContext=this.context.forAttribute(key);if(!attributeContext)return;var value=attributeContext.attributes[key];if(value instanceof expressions.Expression){value=value.get(attributeContext);}return expressions.renderValue(value,this.context);};Component.prototype.setAttribute=function(key,value){this.context.parent.attributes[key]=value;};Component.prototype.setNullAttribute=function(key,value){var attributes=this.context.parent.attributes;if(attributes[key]==null)attributes[key]=value;};function ComponentAttribute(expression,model,key){this.expression=expression;this.model=model;this.key=key;}ComponentAttribute.prototype.update=function(context,binding){var value=this.expression.get(context);binding.condition=value;this.model.setDiff(this.key,value);};function ComponentAttributeBinding(expression,model,key,context){this.template=new ComponentAttribute(expression,model,key);this.context=context;this.condition=expression.get(context);}ComponentAttributeBinding.prototype=Object.create(templates.Binding.prototype);ComponentAttributeBinding.prototype.constructor=ComponentAttributeBinding;function setModelAttributes(context,model){var attributes=context.parent.attributes;if(!attributes)return;// Set attribute values on component model
for(var key in attributes){var value=attributes[key];setModelAttribute(context,model,key,value);}}function setModelAttribute(context,model,key,value){// If an attribute is an Expression, set its current value in the model
// and keep it up to date. When it is a resolvable path, use a Racer ref,
// which makes it a two-way binding. Otherwise, set to the current value
// and create a binding that will set the value in the model as the
// expression's dependencies change.
if(value instanceof expressions.Expression){var segments=value.pathSegments(context);if(segments){model.root.ref(model._at+'.'+key,segments.join('.'),{updateIndices:true});}else{var binding=new ComponentAttributeBinding(value,model,key,context);context.addBinding(binding);model.set(key,binding.condition);}return;}// If an attribute is a Template, set a template object in the model.
// Eagerly rendering a template can cause excessive rendering when the
// developer wants to pass in a complex chunk of HTML, and if we were to
// set a string in the model that represents the template value, we'd lose
// the ability to use the value in the component's template, since HTML
// would be escaped and we'd lose the ability to create proper bindings.
//
// This may be of surprise to developers, since it may not be intuitive
// whether a passed in value will produce an expression or a template. To
// get the rendered value consistently, the component's getAttribute(key)
// method may be used to get the value that would be rendered.
if(value instanceof templates.Template){var template=new templates.ContextClosure(value,context);model.set(key,template);return;}// For all other value types, set the passed in value directly. Passed in
// values will only be set initially, so model paths should be used if
// bindings are desired.
model.set(key,value);}function createFactory(constructor){// DEPRECATED: constructor.prototype.singleton is deprecated. "singleton"
// static property on the constructor is preferred
return constructor.singleton||constructor.prototype.singleton?new SingletonComponentFactory(constructor):new ComponentFactory(constructor);}function emitInitHooks(context,component){if(!context.initHooks)return;// Run initHooks for `on` listeners immediately before init
for(var i=0,len=context.initHooks.length;i<len;i++){context.initHooks[i].emit(context,component);}}function ComponentModelData(){this.id=null;this.$controller=null;}function ComponentFactory(constructor){this.constructor=constructor;}ComponentFactory.prototype.init=function(context){var DataConstructor=this.constructor.DataConstructor||ComponentModelData;var data=new DataConstructor();var component=new this.constructor(context,data);// Detect whether the component constructor already called super by checking
// for one of the properties it sets. If not, call the Component constructor
if(!component.context){Component.call(component,context,data);}setModelAttributes(component.context,component.model);// Do the user-specific initialization. The component constructor should be
// an empty function and the actual initialization code should be done in the
// component's init method. This means that we don't have to rely on users
// properly calling the Component constructor method and avoids having to
// play nice with how CoffeeScript extends class constructors
emitInitHooks(context,component);component.emit('init',component);if(component.init)component.init(component.model);return component.context;};ComponentFactory.prototype.create=function(context){var component=context.controller;component.emit('create',component);// Call the component's create function after its view is rendered
if(component.create){component.create(component.model,component.dom);}};function noop(){}function SingletonComponentFactory(constructor){this.constructor=constructor;this.component=null;// Disable component from being destroyed, since it is intended to
// be used multiple times
constructor.prototype.destroy=noop;}SingletonComponentFactory.prototype.isSingleton=true;SingletonComponentFactory.prototype.init=function(context){if(!this.component)this.component=new this.constructor();return context.componentChild(this.component);};// Don't call the init or create methods for singleton components
SingletonComponentFactory.prototype.create=noop;function isBasePrototype(object){return object===Object.prototype||object===Function.prototype||object===null;}function getRootPrototype(object){while(true){var prototype=Object.getPrototypeOf(object);if(isBasePrototype(prototype))return object;object=prototype;}}var _extendComponent=Object.setPrototypeOf&&Object.getPrototypeOf?// Modern version, which supports ES6 classes
function(constructor){// Find the end of the prototype chain
var rootPrototype=getRootPrototype(constructor.prototype);// This guard is a workaroud to a bug that has occurred in Chakra when
// app.component() is invoked twice on the same constructor. In that case,
// the `instanceof Component` check in extendComponent incorrectly returns
// false after the prototype has already been set to `Component.prototype`.
// Then, this code proceeds to set the prototype of Component.prototype
// to itself, which throws a "Cyclic __proto__ value" error.
// https://github.com/Microsoft/ChakraCore/issues/5915
if(rootPrototype===Component.prototype)return;// Establish inheritance with the pattern that Node's util.inherits() uses
// if Object.setPrototypeOf() is available (all modern browsers & IE11).
// This inhertance pattern is not equivalent to class extends, but it does
// work to make instances of the constructor inherit the desired prototype
// https://github.com/nodejs/node/issues/4179
Object.setPrototypeOf(rootPrototype,Component.prototype);}:// Fallback for older browsers
function(constructor){// In this version, we iterate over all of the properties on the
// constructor's prototype and merge them into a new prototype object.
// This flattens the prototype chain, meaning that instanceof will not
// work for classes from which the current component inherits
var prototype=constructor.prototype;// Otherwise, modify constructor.prototype. This won't work with ES6
// classes, since their prototype property is non-writeable. However, it
// does work in older browsers that don't support Object.setPrototypeOf(),
// and those browsers don't support ES6 classes either
constructor.prototype=Object.create(Component.prototype);constructor.prototype.constructor=constructor;util.mergeInto(constructor.prototype,prototype);};function extendComponent(constructor){// Don't do anything if the constructor already extends Component
if(constructor.prototype instanceof Component)return;// Otherwise, append Component.prototype to constructor's prototype chain
_extendComponent(constructor);}},{"./Controller":24,"derby-templates":16,"racer/lib/util":74}],30:[function(require,module,exports){var textDiff=require('./textDiff');exports.add=addDocumentListeners;exports.inputSupportsSelection=inputSupportsSelection;// http://www.whatwg.org/specs/web-apps/current-work/multipage/the-input-element.html#do-not-apply
// TODO: Date types support
function inputSupportsSelection(input){var type=input.type;return type==='text'||type==='textarea'||type==='search'||type==='url'||type==='tel'||type==='password';}function inputIsNumberValue(input){var type=input.type;return type==='number'||type==='range'&&!input.multiple;}var inputValue=function inputValue(input){return inputIsNumberValue(input)?input.valueAsNumber:input.value;};function addDocumentListeners(doc){doc.addEventListener('input',documentInput,true);doc.addEventListener('change',documentChange,true);// Listen to more events for versions of IE with buggy input event implementations
if(parseFloat(window.navigator.appVersion.split('MSIE ')[1])<=9){// We're listening on selectionchange because there's no other event emitted when
// the user clicks 'delete' from a context menu when right clicking on selected text.
// So although this event fires overly aggressively, it's the only real way
// to ensure that we can detect all changes to the input value in IE <= 9
doc.addEventListener('selectionchange',function(e){if(document.activeElement){documentInput({target:document.activeElement});// selectionchange evts don't have the e.target we need
}},true);}// For some reason valueAsNumber returns NaN for number inputs in IE
// until a new IE version that handles this is released, parse input.value as a fallback
var input=document.createElement('input');input.type='number';input.value='7';if(input.valueAsNumber!==input.valueAsNumber){var oldInputValue=inputValue;inputValue=function inputValue(input){if(input.type==='number'){return inputIsNumberValue(input)?parseFloat(input.value):input.value;}else{return oldInputValue.apply(this,arguments);}};}}function documentInput(e){var target=e.target;if(target.tagName==='INPUT'||target.tagName==='TEXTAREA'){setInputValue(e,target);}}function documentChange(e){var target=e.target;if(target.tagName==='INPUT'){setBoundProperty(target,'checked');setInputValue(e,target);}else if(target.tagName==='SELECT'){setOptionBindings(target);}else if(target.tagName==='TEXTAREA'){setInputValue(e,target);}}function setBoundProperty(node,property){var binding=node.$bindAttributes&&node.$bindAttributes[property];if(!binding||binding.isUnbound())return;var value=node[property];binding.template.expression.set(binding.context,value);}function setInputValue(e,target){var binding=target.$bindAttributes&&target.$bindAttributes.value;if(!binding||binding.isUnbound())return;if(inputSupportsSelection(target)){var pass={$event:e};textDiffBinding(binding,target.value,pass);}else{var value=inputValue(target);binding.template.expression.set(binding.context,value);}}function textDiffBinding(binding,value,pass){var expression=binding.template.expression;var segments=expression.pathSegments(binding.context);if(segments){var model=binding.context.controller.model.pass(pass);textDiff.onTextInput(model,segments,value);}else if(expression.set){expression.set(binding.context,value);}}function setOptionBindings(parent){for(var node=parent.firstChild;node;node=node.nextSibling){if(node.tagName==='OPTION'){setBoundProperty(node,'selected');}else if(node.hasChildNodes()){setOptionBindings(node);}}}},{"./textDiff":32}],31:[function(require,module,exports){var expressions=require('derby-templates').expressions;// The many trees of bindings:
//
// - Model tree, containing your actual data. Eg:
//    {users:{fred:{age:40}, wilma:{age:37}}}
//
// - Event model tree, whose structure mirrors the model tree. The event model
//   tree lets us annotate the model tree with listeners which fire when events
//   change. I think there are three types of listeners:
//
//   1. Reference binding binds to whatever is referred to by the path. Eg,
//   {{each items as item}} binds item by reference as it goes through the
//   list.
//   2. Fixed path bindings explicitly bind to whatever is at that path
//   regardless of how the model changes underneath the event model
//   3. Listen on a subtree and fire when anything in the subtree changes. This
//   is used for custom functions.
//
// {{foo.id}} would listen on the fixed path ['foo', 'id'].
//
//
// - Context tree represents the changing (embedded) contexts of the templating
//   engine. This maps to the tree of templates and allows templates to reference
//   anything in any of their enclosing template scopes.
//
module.exports=EventModel;// The code here uses object-based set pattern where objects are keyed using
// sequentially generated IDs.
var nextId=1;// A binding object is something with update(), insert()/move()/remove() defined.
// Given x[y] with model.get(y) == 5:
//  item = 5
//  segments = ['y']
//  outside = the EventModel for x.
//
// Note that item could be a Context or another ModelRef - eg:
//
// {{ each foo as bar }} ... {{ x[bar] }}  -or-  {{ x[y[z]] }}
function ModelRef(model,item,segments,outside){this.id=nextId++;// We need a reference to the model & our segment list so we can update our
// value.
this.model=model;this.segments=segments;// Our current value.
this.item=item;// outside is a reference to the EventModel of the thing on the lhs of the
// brackets. For example, in x[y].z, outside is the EventModel of x.
this.outside=outside;// result is the EventModel of the evaluated version of the brackets. In
// x[y].z, its the EventModel of x[y].
this.result=outside.child(item).refChild(this);}ModelRef.prototype.update=function(){var segments=expressions.pathSegments(this.segments);var newItem=expressions.lookup(segments,this.model.data);if(this.item===newItem)return;// First remove myself.
delete this.outside.child(this.item).refChildren[this.id];this.item=newItem;var container=this.outside.child(this.item);// I want to just call refChild but that would create a new EM. Instead I
// want to just implant my current EM there.
if(!container.refChildren)container.refChildren=new RefChildrenMap();container.refChildren[this.id]=this.result;// Finally, update all the bindings in the tree.
this.result.update();};function RefOutMap(){}function RefChildrenMap(){}function BindingsMap(){}function ItemContextsMap(){}function EventModelsMap(){}function EventModel(){this.id=nextId++;// Most of these won't ever be filled in, so I'm just leaving them null.
//
// These contain our EventModel children.
this.object=null;this.array=null;// This contains any EventModel children which have floating references.
this.arrayByReference=null;// If the data stored here is ever used to lookup other values, this is an
// object mapping remote child ID -> ref.
//
// Eg given x[y], y.refOut[x.id] = <Binding>
this.refOut=null;// This is a map from ref id -> event model for events bound to this
// EventModel but via a ref. We could just merge them into the main tree, but
// this way they're easy to move.
//
// Eg, given x[y] (y=1), x.1.refChildren[ref id] is an EventModel.
this.refChildren=null;this.bindings=null;// Item contexts are contexts which need their item number changed as this
// EventModel object moves around its surrounding list.
this.itemContexts=null;}EventModel.prototype.refChild=function(ref){if(!this.refChildren)this.refChildren=new RefChildrenMap();var id=ref.id;if(!this.refChildren[id]){this.refChildren[id]=new EventModel();}return this.refChildren[id];};EventModel.prototype.arrayLookup=function(model,segmentsBefore,segmentsInside){var segments=expressions.pathSegments(segmentsInside);var item=expressions.lookup(segments,model.data);var source=this.at(segmentsInside);// What the array currently resolves to. Given x[y] with y=1, container is
// the EM for x
var container=this.at(segmentsBefore);if(!source.refOut)source.refOut=new RefOutMap();var ref=source.refOut[container.id];if(ref==null){ref=new ModelRef(model,item,segmentsInside,container);source.refOut[container.id]=ref;}return ref;};// Returns the EventModel node of the named child.
EventModel.prototype.child=function(segment){var container;if(typeof segment==='string'){// Object
if(!this.object)this.object={};container=this.object;}else if(typeof segment==='number'){// Array by value
if(!this.array)this.array=[];container=this.array;}else if(segment instanceof ModelRef){// Array reference. We'll need to lookup the child with the right
// value, then look inside its ref children for the right EventModel
// (so we can update it later). This is pretty janky, but should be
// *correct* even in the face of recursive array accessors.
//
// This will calculate it based on the current segment values, but refs
// cache the EM anyway.
//return this.child(segment.item).refChild(segment);
return segment.result;}else{// Array by reference
if(!this.arrayByReference)this.arrayByReference=[];container=this.arrayByReference;segment=segment.item;}return container[segment]||(container[segment]=new EventModel());};// Returns the EventModel node at the given segments list. Note that although
// EventModel nodes are unique, its possible for multiple EventModel nodes to
// refer to the same section of the model because of references.
//
// If you want to update the bindings that refer to a specific path, use
// each().
//
// EventModel objects are created as needed.
EventModel.prototype.at=function(segments){// For unbound dependancies.
if(segments==null)return this;var eventModel=this;for(var i=0;i<segments.length;i++){eventModel=eventModel.child(segments[i]);}return eventModel;};EventModel.prototype.isEmpty=function(){if(hasKeys(this.dependancies))return false;if(hasKeys(this.itemContexts))return false;if(this.object){if(hasKeys(this.object))return false;this.object=null;}if(this.arrayByReference){for(var i=0;i<this.arrayByReference.length;i++){if(this.arrayByReference[i]!=null)return false;}this.arrayByReference=null;}if(this.array){for(var i=0;i<this.array.length;i++){if(this.array[i]!=null)return false;}this.array=null;}return true;};function hasKeys(object){for(var key in object){return true;}return false;}// **** Updating the EventModel
EventModel.prototype._addItemContext=function(context){if(!context._id)context._id=nextId++;if(!this.itemContexts)this.itemContexts=new ItemContextsMap();this.itemContexts[context._id]=context;};EventModel.prototype._removeItemContext=function(context){if(this.itemContexts){delete this.itemContexts[context._id];}};EventModel.prototype._addBinding=function(binding){var bindings=this.bindings||(this.bindings=new BindingsMap());binding.eventModels||(binding.eventModels=new EventModelsMap());bindings[binding.id]=binding;binding.eventModels[this.id]=this;};// This is the main hook to add bindings to the event model tree. It should
// only be called on the root EventModel object.
EventModel.prototype.addBinding=function(segments,binding){this.at(segments)._addBinding(binding);};// This is used for objects (contexts in derby's case) that have a .item
// property which refers to an array index.
EventModel.prototype.addItemContext=function(segments,context){this.at(segments)._addItemContext(context);};EventModel.prototype.removeBinding=function(binding){if(!binding.eventModels)return;for(var id in binding.eventModels){var eventModel=binding.eventModels[id];if(eventModel.bindings)delete eventModel.bindings[binding.id];}binding.eventModels=null;};EventModel.prototype._each=function(segments,pos,fn){// Our refChildren are effectively merged into this object.
if(this.refChildren){for(var id in this.refChildren){var refChild=this.refChildren[id];if(refChild)refChild._each(segments,pos,fn);}}if(segments.length===pos){fn(this);return;}var segment=segments[pos];var child;if(typeof segment==='string'){// Object. Just recurse into our objects set. Its possible to rewrite this
// function to simply loop in the case of object lookups, but I don't think
// it'll buy us much.
child=this.object&&this.object[segment];if(child)child._each(segments,pos+1,fn);}else{// Number. Recurse both into the fixed list and the reference list.
child=this.array&&this.array[segment];if(child)child._each(segments,pos+1,fn);child=this.arrayByReference&&this.arrayByReference[segment];if(child)child._each(segments,pos+1,fn);}};// Called when the scalar value at the path changes. This only calls update()
// on this node. See update() below if you want to update entire
// subtrees.
EventModel.prototype.localUpdate=function(previous,pass){if(this.bindings){for(var id in this.bindings){var binding=this.bindings[id];if(binding)binding.update(previous,pass);}}// If our value changed, we also need to update anything that depends on it
// via refOut.
if(this.refOut){for(var id in this.refOut){var ref=this.refOut[id];if(ref)ref.update();}}};// This is used when an object subtree is replaced / removed.
EventModel.prototype.update=function(previous,pass){this.localUpdate(previous,pass);if(this.object){for(var key in this.object){var binding=this.object[key];if(binding)binding.update();}}if(this.array){for(var i=0;i<this.array.length;i++){var binding=this.array[i];if(binding)binding.update();}}if(this.arrayByReference){for(var i=0;i<this.arrayByReference.length;i++){var binding=this.arrayByReference[i];if(binding)binding.update();}}};// Updates the indexes in itemContexts of our children in the range of
// [from, to). from and to both optional.
EventModel.prototype._updateChildItemContexts=function(from,to){if(!this.arrayByReference)return;if(from==null)from=0;if(to==null)to=this.arrayByReference.length;for(var i=from;i<to;i++){var contexts=this.arrayByReference[i]&&this.arrayByReference[i].itemContexts;if(contexts){for(var key in contexts){contexts[key].item=i;}}}};// Updates our array-by-value values. They have to recursively update every
// binding in their children. Sad.
EventModel.prototype._updateArray=function(from,to){if(!this.array)return;if(from==null)from=0;if(to==null)to=this.array.length;for(var i=from;i<to;i++){var binding=this.array[i];if(binding)binding.update();}};EventModel.prototype._updateObject=function(){if(this.object){for(var key in this.object){var binding=this.object[key];if(binding)binding.update();}}};EventModel.prototype._set=function(previous,pass){// This just updates anything thats bound to the whole subtree. An alternate
// implementation could be passed in the new value at this node (which we
// cache), then compare with the old version and only update parts of the
// subtree which are relevant. I don't know if thats an important
// optimization - it really depends on your use case.
this.update(previous,pass);};// Insert into this EventModel node.
EventModel.prototype._insert=function(index,howMany){// Update fixed paths
this._updateArray(index);// Update relative paths
if(this.arrayByReference&&this.arrayByReference.length>index){// Shift the actual items in the array references array.
// This probably isn't the best way to implement insert. Other options are
// using concat() on slices or though constructing a temporary array and
// using splice.call. Hopefully if this method is slow it'll come up during
// profiling.
for(var i=0;i<howMany;i++){this.arrayByReference.splice(index,0,null);}// Update the path in the contexts
this._updateChildItemContexts(index+howMany);}// Finally call our bindings.
if(this.bindings){for(var id in this.bindings){var binding=this.bindings[id];if(binding)binding.insert(index,howMany);}}this._updateObject();};// Remove howMany child elements from this EventModel at index.
EventModel.prototype._remove=function(index,howMany){// Update fixed paths. Both the removed items and items after it may have changed.
this._updateArray(index);if(this.arrayByReference){// Update relative paths. First throw away all the children which have been removed.
this.arrayByReference.splice(index,howMany);this._updateChildItemContexts(index);}// Call bindings.
if(this.bindings){for(var id in this.bindings){var binding=this.bindings[id];if(binding)binding.remove(index,howMany);}}this._updateObject();};// Move howMany items from `from` to `to`.
EventModel.prototype._move=function(from,to,howMany){// first points to the first element that was moved. end points to the list
// element past the end of the changed region.
var first,end;if(from<to){first=from;end=to+howMany;}else{first=to;end=from+howMany;}// Update fixed paths.
this._updateArray(first,end);// Update relative paths
var arr=this.arrayByReference;if(arr&&arr.length>first){// Remove from the old location
var values=arr.splice(from,howMany);// Insert at the new location
arr.splice.apply(arr,[to,0].concat(values));// Update the path in the contexts
this._updateChildItemContexts(first,end);}// Finally call our bindings.
if(this.bindings){for(var id in this.bindings){var binding=this.bindings[id];if(binding)binding.move(from,to,howMany);}}this._updateObject();};// Helpers.
EventModel.prototype.mutate=function(segments,fn){// This finds & returns a list of all event models which exist and could match
// the specified path. The path cannot contain contexts like derby expression
// segment lists (just because I don't think thats a useful feature and its not
// implemented)
this._each(segments,0,fn);// Also emit all mutations as sets on star paths, which are how dependencies
// for view helper functions are represented. They should react to a path
// or any child path being modified
for(var i=0,len=segments.length;i++<len;){var wildcardSegments=segments.slice(0,i);wildcardSegments.push('*');this._each(wildcardSegments,0,childSetWildcard);}};function childSetWildcard(child){child._set();}EventModel.prototype.set=function(segments,previous,pass){this.mutate(segments,function childSet(child){child._set(previous,pass);});};EventModel.prototype.insert=function(segments,index,howMany){this.mutate(segments,function childInsert(child){child._insert(index,howMany);});};EventModel.prototype.remove=function(segments,index,howMany){this.mutate(segments,function childRemove(child){child._remove(index,howMany);});};EventModel.prototype.move=function(segments,from,to,howMany){this.mutate(segments,function childMove(child){child._move(from,to,howMany);});};},{"derby-templates":16}],32:[function(require,module,exports){exports.onStringInsert=onStringInsert;exports.onStringRemove=onStringRemove;exports.onTextInput=onTextInput;function onStringInsert(el,previous,index,text){function transformCursor(cursor){return index<cursor?cursor+text.length:cursor;}previous||(previous='');var newText=previous.slice(0,index)+text+previous.slice(index);replaceText(el,newText,transformCursor);}function onStringRemove(el,previous,index,howMany){function transformCursor(cursor){return index<cursor?cursor-Math.min(howMany,cursor-index):cursor;}previous||(previous='');var newText=previous.slice(0,index)+previous.slice(index+howMany);replaceText(el,newText,transformCursor);}function replaceText(el,newText,transformCursor){var selectionStart=transformCursor(el.selectionStart);var selectionEnd=transformCursor(el.selectionEnd);var scrollTop=el.scrollTop;el.value=newText;if(el.scrollTop!==scrollTop){el.scrollTop=scrollTop;}if(document.activeElement===el){el.selectionStart=selectionStart;el.selectionEnd=selectionEnd;}}function onTextInput(model,segments,value){var previous=model._get(segments)||'';if(previous===value)return;var start=0;while(previous.charAt(start)===value.charAt(start)){start++;}var end=0;while(previous.charAt(previous.length-1-end)===value.charAt(value.length-1-end)&&end+start<previous.length&&end+start<value.length){end++;}if(previous.length!==start+end){var howMany=previous.length-start-end;model._stringRemove(segments,start,howMany);}if(value.length!==start+end){var inserted=value.slice(start,value.length-end);model._stringInsert(segments,start,inserted);}}},{}],33:[function(require,module,exports){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
var objectCreate=Object.create||objectCreatePolyfill;var objectKeys=Object.keys||objectKeysPolyfill;var bind=Function.prototype.bind||functionBindPolyfill;function EventEmitter(){if(!this._events||!Object.prototype.hasOwnProperty.call(this,'_events')){this._events=objectCreate(null);this._eventsCount=0;}this._maxListeners=this._maxListeners||undefined;}module.exports=EventEmitter;// Backwards-compat with node 0.10.x
EventEmitter.EventEmitter=EventEmitter;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;// By default EventEmitters will print a warning if more than 10 listeners are
// added to it. This is a useful default which helps finding memory leaks.
var defaultMaxListeners=10;var hasDefineProperty;try{var o={};if(Object.defineProperty)Object.defineProperty(o,'x',{value:0});hasDefineProperty=o.x===0;}catch(err){hasDefineProperty=false;}if(hasDefineProperty){Object.defineProperty(EventEmitter,'defaultMaxListeners',{enumerable:true,get:function get(){return defaultMaxListeners;},set:function set(arg){// check whether the input is a positive number (whose value is zero or
// greater and not a NaN).
if(typeof arg!=='number'||arg<0||arg!==arg)throw new TypeError('"defaultMaxListeners" must be a positive number');defaultMaxListeners=arg;}});}else{EventEmitter.defaultMaxListeners=defaultMaxListeners;}// Obviously not all Emitters should be limited to 10. This function allows
// that to be increased. Set to zero for unlimited.
EventEmitter.prototype.setMaxListeners=function setMaxListeners(n){if(typeof n!=='number'||n<0||isNaN(n))throw new TypeError('"n" argument must be a positive number');this._maxListeners=n;return this;};function $getMaxListeners(that){if(that._maxListeners===undefined)return EventEmitter.defaultMaxListeners;return that._maxListeners;}EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return $getMaxListeners(this);};// These standalone emit* functions are used to optimize calling of event
// handlers for fast cases because emit() itself often has a variable number of
// arguments and can be deoptimized because of that. These functions always have
// the same number of arguments and thus do not get deoptimized, so the code
// inside them can execute faster.
function emitNone(handler,isFn,self){if(isFn)handler.call(self);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self);}}}function emitOne(handler,isFn,self,arg1){if(isFn)handler.call(self,arg1);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1);}}}function emitTwo(handler,isFn,self,arg1,arg2){if(isFn)handler.call(self,arg1,arg2);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1,arg2);}}}function emitThree(handler,isFn,self,arg1,arg2,arg3){if(isFn)handler.call(self,arg1,arg2,arg3);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1,arg2,arg3);}}}function emitMany(handler,isFn,self,args){if(isFn)handler.apply(self,args);else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].apply(self,args);}}}EventEmitter.prototype.emit=function emit(type){var er,handler,len,args,i,events;var doError=type==='error';events=this._events;if(events)doError=doError&&events.error==null;else if(!doError)return false;// If there is no 'error' event listener then throw.
if(doError){if(arguments.length>1)er=arguments[1];if(er instanceof Error){throw er;// Unhandled 'error' event
}else{// At least give some kind of context to the user
var err=new Error('Unhandled "error" event. ('+er+')');err.context=er;throw err;}return false;}handler=events[type];if(!handler)return false;var isFn=typeof handler==='function';len=arguments.length;switch(len){// fast cases
case 1:emitNone(handler,isFn,this);break;case 2:emitOne(handler,isFn,this,arguments[1]);break;case 3:emitTwo(handler,isFn,this,arguments[1],arguments[2]);break;case 4:emitThree(handler,isFn,this,arguments[1],arguments[2],arguments[3]);break;// slower
default:args=new Array(len-1);for(i=1;i<len;i++){args[i-1]=arguments[i];}emitMany(handler,isFn,this,args);}return true;};function _addListener(target,type,listener,prepend){var m;var events;var existing;if(typeof listener!=='function')throw new TypeError('"listener" argument must be a function');events=target._events;if(!events){events=target._events=objectCreate(null);target._eventsCount=0;}else{// To avoid recursion in the case that type === "newListener"! Before
// adding it to the listeners, first emit "newListener".
if(events.newListener){target.emit('newListener',type,listener.listener?listener.listener:listener);// Re-assign `events` because a newListener handler could have caused the
// this._events to be assigned to a new object
events=target._events;}existing=events[type];}if(!existing){// Optimize the case of one listener. Don't need the extra array object.
existing=events[type]=listener;++target._eventsCount;}else{if(typeof existing==='function'){// Adding the second element, need to change to array.
existing=events[type]=prepend?[listener,existing]:[existing,listener];}else{// If we've already got an array, just append.
if(prepend){existing.unshift(listener);}else{existing.push(listener);}}// Check for listener leak
if(!existing.warned){m=$getMaxListeners(target);if(m&&m>0&&existing.length>m){existing.warned=true;var w=new Error('Possible EventEmitter memory leak detected. '+existing.length+' "'+String(type)+'" listeners '+'added. Use emitter.setMaxListeners() to '+'increase limit.');w.name='MaxListenersExceededWarning';w.emitter=target;w.type=type;w.count=existing.length;if((typeof console==="undefined"?"undefined":_typeof(console))==='object'&&console.warn){console.warn('%s: %s',w.name,w.message);}}}}return target;}EventEmitter.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false);};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true);};function onceWrapper(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;switch(arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:var args=new Array(arguments.length);for(var i=0;i<args.length;++i){args[i]=arguments[i];}this.listener.apply(this.target,args);}}}function _onceWrap(target,type,listener){var state={fired:false,wrapFn:undefined,target:target,type:type,listener:listener};var wrapped=bind.call(onceWrapper,state);wrapped.listener=listener;state.wrapFn=wrapped;return wrapped;}EventEmitter.prototype.once=function once(type,listener){if(typeof listener!=='function')throw new TypeError('"listener" argument must be a function');this.on(type,_onceWrap(this,type,listener));return this;};EventEmitter.prototype.prependOnceListener=function prependOnceListener(type,listener){if(typeof listener!=='function')throw new TypeError('"listener" argument must be a function');this.prependListener(type,_onceWrap(this,type,listener));return this;};// Emits a 'removeListener' event if and only if the listener was removed.
EventEmitter.prototype.removeListener=function removeListener(type,listener){var list,events,position,i,originalListener;if(typeof listener!=='function')throw new TypeError('"listener" argument must be a function');events=this._events;if(!events)return this;list=events[type];if(!list)return this;if(list===listener||list.listener===listener){if(--this._eventsCount===0)this._events=objectCreate(null);else{delete events[type];if(events.removeListener)this.emit('removeListener',type,list.listener||listener);}}else if(typeof list!=='function'){position=-1;for(i=list.length-1;i>=0;i--){if(list[i]===listener||list[i].listener===listener){originalListener=list[i].listener;position=i;break;}}if(position<0)return this;if(position===0)list.shift();else spliceOne(list,position);if(list.length===1)events[type]=list[0];if(events.removeListener)this.emit('removeListener',type,originalListener||listener);}return this;};EventEmitter.prototype.removeAllListeners=function removeAllListeners(type){var listeners,events,i;events=this._events;if(!events)return this;// not listening for removeListener, no need to emit
if(!events.removeListener){if(arguments.length===0){this._events=objectCreate(null);this._eventsCount=0;}else if(events[type]){if(--this._eventsCount===0)this._events=objectCreate(null);else delete events[type];}return this;}// emit removeListener for all listeners on all events
if(arguments.length===0){var keys=objectKeys(events);var key;for(i=0;i<keys.length;++i){key=keys[i];if(key==='removeListener')continue;this.removeAllListeners(key);}this.removeAllListeners('removeListener');this._events=objectCreate(null);this._eventsCount=0;return this;}listeners=events[type];if(typeof listeners==='function'){this.removeListener(type,listeners);}else if(listeners){// LIFO order
for(i=listeners.length-1;i>=0;i--){this.removeListener(type,listeners[i]);}}return this;};function _listeners(target,type,unwrap){var events=target._events;if(!events)return[];var evlistener=events[type];if(!evlistener)return[];if(typeof evlistener==='function')return unwrap?[evlistener.listener||evlistener]:[evlistener];return unwrap?unwrapListeners(evlistener):arrayClone(evlistener,evlistener.length);}EventEmitter.prototype.listeners=function listeners(type){return _listeners(this,type,true);};EventEmitter.prototype.rawListeners=function rawListeners(type){return _listeners(this,type,false);};EventEmitter.listenerCount=function(emitter,type){if(typeof emitter.listenerCount==='function'){return emitter.listenerCount(type);}else{return listenerCount.call(emitter,type);}};EventEmitter.prototype.listenerCount=listenerCount;function listenerCount(type){var events=this._events;if(events){var evlistener=events[type];if(typeof evlistener==='function'){return 1;}else if(evlistener){return evlistener.length;}}return 0;}EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?Reflect.ownKeys(this._events):[];};// About 1.5x faster than the two-arg version of Array#splice().
function spliceOne(list,index){for(var i=index,k=i+1,n=list.length;k<n;i+=1,k+=1){list[i]=list[k];}list.pop();}function arrayClone(arr,n){var copy=new Array(n);for(var i=0;i<n;++i){copy[i]=arr[i];}return copy;}function unwrapListeners(arr){var ret=new Array(arr.length);for(var i=0;i<ret.length;++i){ret[i]=arr[i].listener||arr[i];}return ret;}function objectCreatePolyfill(proto){var F=function F(){};F.prototype=proto;return new F();}function objectKeysPolyfill(obj){var keys=[];for(var k in obj){if(Object.prototype.hasOwnProperty.call(obj,k)){keys.push(k);}}return k;}function functionBindPolyfill(context){var fn=this;return function(){return fn.apply(context,arguments);};}},{}],34:[function(require,module,exports){'use strict';var isArray=Array.isArray;var keyList=Object.keys;var hasProp=Object.prototype.hasOwnProperty;module.exports=function equal(a,b){if(a===b)return true;if(a&&b&&_typeof(a)=='object'&&_typeof(b)=='object'){var arrA=isArray(a),arrB=isArray(b),i,length,key;if(arrA&&arrB){length=a.length;if(length!=b.length)return false;for(i=length;i--!==0;){if(!equal(a[i],b[i]))return false;}return true;}if(arrA!=arrB)return false;var dateA=a instanceof Date,dateB=b instanceof Date;if(dateA!=dateB)return false;if(dateA&&dateB)return a.getTime()==b.getTime();var regexpA=a instanceof RegExp,regexpB=b instanceof RegExp;if(regexpA!=regexpB)return false;if(regexpA&&regexpB)return a.toString()==b.toString();var keys=keyList(a);length=keys.length;if(length!==keyList(b).length)return false;for(i=length;i--!==0;){if(!hasProp.call(b,keys[i]))return false;}for(i=length;i--!==0;){key=keys[i];if(!equal(a[key],b[key]))return false;}return true;}return a!==a&&b!==b;};},{}],35:[function(require,module,exports){// These methods let you build a transform function from a transformComponent
// function for OT types like JSON0 in which operations are lists of components
// and transforming them requires N^2 work. I find it kind of nasty that I need
// this, but I'm not really sure what a better solution is. Maybe I should do
// this automatically to types that don't have a compose function defined.
// Add transform and transformX functions for an OT type which has
// transformComponent defined.  transformComponent(destination array,
// component, other component, side)
module.exports=bootstrapTransform;function bootstrapTransform(type,transformComponent,checkValidOp,append){var transformComponentX=function transformComponentX(left,right,destLeft,destRight){transformComponent(destLeft,left,right,'left');transformComponent(destRight,right,left,'right');};var transformX=type.transformX=function(leftOp,rightOp){checkValidOp(leftOp);checkValidOp(rightOp);var newRightOp=[];for(var i=0;i<rightOp.length;i++){var rightComponent=rightOp[i];// Generate newLeftOp by composing leftOp by rightComponent
var newLeftOp=[];var k=0;while(k<leftOp.length){var nextC=[];transformComponentX(leftOp[k],rightComponent,newLeftOp,nextC);k++;if(nextC.length===1){rightComponent=nextC[0];}else if(nextC.length===0){for(var j=k;j<leftOp.length;j++){append(newLeftOp,leftOp[j]);}rightComponent=null;break;}else{// Recurse.
var pair=transformX(leftOp.slice(k),nextC);for(var l=0;l<pair[0].length;l++){append(newLeftOp,pair[0][l]);}for(var r=0;r<pair[1].length;r++){append(newRightOp,pair[1][r]);}rightComponent=null;break;}}if(rightComponent!=null){append(newRightOp,rightComponent);}leftOp=newLeftOp;}return[leftOp,newRightOp];};// Transforms op with specified type ('left' or 'right') by otherOp.
type.transform=function(op,otherOp,type){if(!(type==='left'||type==='right'))throw new Error("type must be 'left' or 'right'");if(otherOp.length===0)return op;if(op.length===1&&otherOp.length===1)return transformComponent([],op[0],otherOp[0],type);if(type==='left')return transformX(op,otherOp)[0];else return transformX(otherOp,op)[1];};};},{}],36:[function(require,module,exports){// Only the JSON type is exported, because the text type is deprecated
// otherwise. (If you want to use it somewhere, you're welcome to pull it out
// into a separate module that json0 can depend on).
module.exports={type:require('./json0')};},{"./json0":37}],37:[function(require,module,exports){/*
 This is the implementation of the JSON OT type.

 Spec is here: https://github.com/josephg/ShareJS/wiki/JSON-Operations

 Note: This is being made obsolete. It will soon be replaced by the JSON2 type.
*/ /**
 * UTILITY FUNCTIONS
 */ /**
 * Checks if the passed object is an Array instance. Can't use Array.isArray
 * yet because its not supported on IE8.
 *
 * @param obj
 * @returns {boolean}
 */var isArray=function isArray(obj){return Object.prototype.toString.call(obj)=='[object Array]';};/**
 * Checks if the passed object is an Object instance.
 * No function call (fast) version
 *
 * @param obj
 * @returns {boolean}
 */var isObject=function isObject(obj){return!!obj&&obj.constructor===Object;};/**
 * Clones the passed object using JSON serialization (which is slow).
 *
 * hax, copied from test/types/json. Apparently this is still the fastest way
 * to deep clone an object, assuming we have browser support for JSON.  @see
 * http://jsperf.com/cloning-an-object/12
 */var clone=function clone(o){return JSON.parse(JSON.stringify(o));};/**
 * JSON OT Type
 * @type {*}
 */var json={name:'json0',uri:'http://sharejs.org/types/JSONv0'};// You can register another OT type as a subtype in a JSON document using
// the following function. This allows another type to handle certain
// operations instead of the builtin JSON type.
var subtypes={};json.registerSubtype=function(subtype){subtypes[subtype.name]=subtype;};json.create=function(data){// Null instead of undefined if you don't pass an argument.
return data===undefined?null:clone(data);};json.invertComponent=function(c){var c_={p:c.p};// handle subtype ops
if(c.t&&subtypes[c.t]){c_.t=c.t;c_.o=subtypes[c.t].invert(c.o);}if(c.si!==void 0)c_.sd=c.si;if(c.sd!==void 0)c_.si=c.sd;if(c.oi!==void 0)c_.od=c.oi;if(c.od!==void 0)c_.oi=c.od;if(c.li!==void 0)c_.ld=c.li;if(c.ld!==void 0)c_.li=c.ld;if(c.na!==void 0)c_.na=-c.na;if(c.lm!==void 0){c_.lm=c.p[c.p.length-1];c_.p=c.p.slice(0,c.p.length-1).concat([c.lm]);}return c_;};json.invert=function(op){var op_=op.slice().reverse();var iop=[];for(var i=0;i<op_.length;i++){iop.push(json.invertComponent(op_[i]));}return iop;};json.checkValidOp=function(op){for(var i=0;i<op.length;i++){if(!isArray(op[i].p))throw new Error('Missing path');}};json.checkList=function(elem){if(!isArray(elem))throw new Error('Referenced element not a list');};json.checkObj=function(elem){if(!isObject(elem)){throw new Error("Referenced element not an object (it was "+JSON.stringify(elem)+")");}};// helper functions to convert old string ops to and from subtype ops
function convertFromText(c){c.t='text0';var o={p:c.p.pop()};if(c.si!=null)o.i=c.si;if(c.sd!=null)o.d=c.sd;c.o=[o];}function convertToText(c){c.p.push(c.o[0].p);if(c.o[0].i!=null)c.si=c.o[0].i;if(c.o[0].d!=null)c.sd=c.o[0].d;delete c.t;delete c.o;}json.apply=function(snapshot,op){json.checkValidOp(op);op=clone(op);var container={data:snapshot};for(var i=0;i<op.length;i++){var c=op[i];// convert old string ops to use subtype for backwards compatibility
if(c.si!=null||c.sd!=null)convertFromText(c);var parent=null;var parentKey=null;var elem=container;var key='data';for(var j=0;j<c.p.length;j++){var p=c.p[j];parent=elem;parentKey=key;elem=elem[key];key=p;if(parent==null)throw new Error('Path invalid');}// handle subtype ops
if(c.t&&c.o!==void 0&&subtypes[c.t]){elem[key]=subtypes[c.t].apply(elem[key],c.o);// Number add
}else if(c.na!==void 0){if(typeof elem[key]!='number')throw new Error('Referenced element not a number');elem[key]+=c.na;}// List replace
else if(c.li!==void 0&&c.ld!==void 0){json.checkList(elem);// Should check the list element matches c.ld
elem[key]=c.li;}// List insert
else if(c.li!==void 0){json.checkList(elem);elem.splice(key,0,c.li);}// List delete
else if(c.ld!==void 0){json.checkList(elem);// Should check the list element matches c.ld here too.
elem.splice(key,1);}// List move
else if(c.lm!==void 0){json.checkList(elem);if(c.lm!=key){var e=elem[key];// Remove it...
elem.splice(key,1);// And insert it back.
elem.splice(c.lm,0,e);}}// Object insert / replace
else if(c.oi!==void 0){json.checkObj(elem);// Should check that elem[key] == c.od
elem[key]=c.oi;}// Object delete
else if(c.od!==void 0){json.checkObj(elem);// Should check that elem[key] == c.od
delete elem[key];}else{throw new Error('invalid / missing instruction in op');}}return container.data;};// Helper to break an operation up into a bunch of small ops.
json.shatter=function(op){var results=[];for(var i=0;i<op.length;i++){results.push([op[i]]);}return results;};// Helper for incrementally applying an operation to a snapshot. Calls yield
// after each op component has been applied.
json.incrementalApply=function(snapshot,op,_yield){for(var i=0;i<op.length;i++){var smallOp=[op[i]];snapshot=json.apply(snapshot,smallOp);// I'd just call this yield, but thats a reserved keyword. Bah!
_yield(smallOp,snapshot);}return snapshot;};// Checks if two paths, p1 and p2 match.
var pathMatches=json.pathMatches=function(p1,p2,ignoreLast){if(p1.length!=p2.length)return false;for(var i=0;i<p1.length;i++){if(p1[i]!==p2[i]&&(!ignoreLast||i!==p1.length-1))return false;}return true;};json.append=function(dest,c){c=clone(c);if(dest.length===0){dest.push(c);return;}var last=dest[dest.length-1];// convert old string ops to use subtype for backwards compatibility
if((c.si!=null||c.sd!=null)&&(last.si!=null||last.sd!=null)){convertFromText(c);convertFromText(last);}if(pathMatches(c.p,last.p)){// handle subtype ops
if(c.t&&last.t&&c.t===last.t&&subtypes[c.t]){last.o=subtypes[c.t].compose(last.o,c.o);// convert back to old string ops
if(c.si!=null||c.sd!=null){var p=c.p;for(var i=0;i<last.o.length-1;i++){c.o=[last.o.pop()];c.p=p.slice();convertToText(c);dest.push(c);}convertToText(last);}}else if(last.na!=null&&c.na!=null){dest[dest.length-1]={p:last.p,na:last.na+c.na};}else if(last.li!==undefined&&c.li===undefined&&c.ld===last.li){// insert immediately followed by delete becomes a noop.
if(last.ld!==undefined){// leave the delete part of the replace
delete last.li;}else{dest.pop();}}else if(last.od!==undefined&&last.oi===undefined&&c.oi!==undefined&&c.od===undefined){last.oi=c.oi;}else if(last.oi!==undefined&&c.od!==undefined){// The last path component inserted something that the new component deletes (or replaces).
// Just merge them.
if(c.oi!==undefined){last.oi=c.oi;}else if(last.od!==undefined){delete last.oi;}else{// An insert directly followed by a delete turns into a no-op and can be removed.
dest.pop();}}else if(c.lm!==undefined&&c.p[c.p.length-1]===c.lm){// don't do anything
}else{dest.push(c);}}else{// convert string ops back
if((c.si!=null||c.sd!=null)&&(last.si!=null||last.sd!=null)){convertToText(c);convertToText(last);}dest.push(c);}};json.compose=function(op1,op2){json.checkValidOp(op1);json.checkValidOp(op2);var newOp=clone(op1);for(var i=0;i<op2.length;i++){json.append(newOp,op2[i]);}return newOp;};json.normalize=function(op){var newOp=[];op=isArray(op)?op:[op];for(var i=0;i<op.length;i++){var c=op[i];if(c.p==null)c.p=[];json.append(newOp,c);}return newOp;};// Returns the common length of the paths of ops a and b
json.commonLengthForOps=function(a,b){var alen=a.p.length;var blen=b.p.length;if(a.na!=null||a.t)alen++;if(b.na!=null||b.t)blen++;if(alen===0)return-1;if(blen===0)return null;alen--;blen--;for(var i=0;i<alen;i++){var p=a.p[i];if(i>=blen||p!==b.p[i])return null;}return alen;};// Returns true if an op can affect the given path
json.canOpAffectPath=function(op,path){return json.commonLengthForOps({p:path},op)!=null;};// transform c so it applies to a document with otherC applied.
json.transformComponent=function(dest,c,otherC,type){c=clone(c);var common=json.commonLengthForOps(otherC,c);var common2=json.commonLengthForOps(c,otherC);var cplength=c.p.length;var otherCplength=otherC.p.length;if(c.na!=null||c.t)cplength++;if(otherC.na!=null||otherC.t)otherCplength++;// if c is deleting something, and that thing is changed by otherC, we need to
// update c to reflect that change for invertibility.
if(common2!=null&&otherCplength>cplength&&c.p[common2]==otherC.p[common2]){if(c.ld!==void 0){var oc=clone(otherC);oc.p=oc.p.slice(cplength);c.ld=json.apply(clone(c.ld),[oc]);}else if(c.od!==void 0){var oc=clone(otherC);oc.p=oc.p.slice(cplength);c.od=json.apply(clone(c.od),[oc]);}}if(common!=null){var commonOperand=cplength==otherCplength;// backward compatibility for old string ops
var oc=otherC;if((c.si!=null||c.sd!=null)&&(otherC.si!=null||otherC.sd!=null)){convertFromText(c);oc=clone(otherC);convertFromText(oc);}// handle subtype ops
if(oc.t&&subtypes[oc.t]){if(c.t&&c.t===oc.t){var res=subtypes[c.t].transform(c.o,oc.o,type);// convert back to old string ops
if(c.si!=null||c.sd!=null){var p=c.p;for(var i=0;i<res.length;i++){c.o=[res[i]];c.p=p.slice();convertToText(c);json.append(dest,c);}}else if(!isArray(res)||res.length>0){c.o=res;json.append(dest,c);}return dest;}}// transform based on otherC
else if(otherC.na!==void 0){// this case is handled below
}else if(otherC.li!==void 0&&otherC.ld!==void 0){if(otherC.p[common]===c.p[common]){// noop
if(!commonOperand){return dest;}else if(c.ld!==void 0){// we're trying to delete the same element, -> noop
if(c.li!==void 0&&type==='left'){// we're both replacing one element with another. only one can survive
c.ld=clone(otherC.li);}else{return dest;}}}}else if(otherC.li!==void 0){if(c.li!==void 0&&c.ld===undefined&&commonOperand&&c.p[common]===otherC.p[common]){// in li vs. li, left wins.
if(type==='right')c.p[common]++;}else if(otherC.p[common]<=c.p[common]){c.p[common]++;}if(c.lm!==void 0){if(commonOperand){// otherC edits the same list we edit
if(otherC.p[common]<=c.lm)c.lm++;// changing c.from is handled above.
}}}else if(otherC.ld!==void 0){if(c.lm!==void 0){if(commonOperand){if(otherC.p[common]===c.p[common]){// they deleted the thing we're trying to move
return dest;}// otherC edits the same list we edit
var p=otherC.p[common];var from=c.p[common];var to=c.lm;if(p<to||p===to&&from<to)c.lm--;}}if(otherC.p[common]<c.p[common]){c.p[common]--;}else if(otherC.p[common]===c.p[common]){if(otherCplength<cplength){// we're below the deleted element, so -> noop
return dest;}else if(c.ld!==void 0){if(c.li!==void 0){// we're replacing, they're deleting. we become an insert.
delete c.ld;}else{// we're trying to delete the same element, -> noop
return dest;}}}}else if(otherC.lm!==void 0){if(c.lm!==void 0&&cplength===otherCplength){// lm vs lm, here we go!
var from=c.p[common];var to=c.lm;var otherFrom=otherC.p[common];var otherTo=otherC.lm;if(otherFrom!==otherTo){// if otherFrom == otherTo, we don't need to change our op.
// where did my thing go?
if(from===otherFrom){// they moved it! tie break.
if(type==='left'){c.p[common]=otherTo;if(from===to)// ugh
c.lm=otherTo;}else{return dest;}}else{// they moved around it
if(from>otherFrom)c.p[common]--;if(from>otherTo)c.p[common]++;else if(from===otherTo){if(otherFrom>otherTo){c.p[common]++;if(from===to)// ugh, again
c.lm++;}}// step 2: where am i going to put it?
if(to>otherFrom){c.lm--;}else if(to===otherFrom){if(to>from)c.lm--;}if(to>otherTo){c.lm++;}else if(to===otherTo){// if we're both moving in the same direction, tie break
if(otherTo>otherFrom&&to>from||otherTo<otherFrom&&to<from){if(type==='right')c.lm++;}else{if(to>from)c.lm++;else if(to===otherFrom)c.lm--;}}}}}else if(c.li!==void 0&&c.ld===undefined&&commonOperand){// li
var from=otherC.p[common];var to=otherC.lm;p=c.p[common];if(p>from)c.p[common]--;if(p>to)c.p[common]++;}else{// ld, ld+li, si, sd, na, oi, od, oi+od, any li on an element beneath
// the lm
//
// i.e. things care about where their item is after the move.
var from=otherC.p[common];var to=otherC.lm;p=c.p[common];if(p===from){c.p[common]=to;}else{if(p>from)c.p[common]--;if(p>to)c.p[common]++;else if(p===to&&from>to)c.p[common]++;}}}else if(otherC.oi!==void 0&&otherC.od!==void 0){if(c.p[common]===otherC.p[common]){if(c.oi!==void 0&&commonOperand){// we inserted where someone else replaced
if(type==='right'){// left wins
return dest;}else{// we win, make our op replace what they inserted
c.od=otherC.oi;}}else{// -> noop if the other component is deleting the same object (or any parent)
return dest;}}}else if(otherC.oi!==void 0){if(c.oi!==void 0&&c.p[common]===otherC.p[common]){// left wins if we try to insert at the same place
if(type==='left'){json.append(dest,{p:c.p,od:otherC.oi});}else{return dest;}}}else if(otherC.od!==void 0){if(c.p[common]==otherC.p[common]){if(!commonOperand)return dest;if(c.oi!==void 0){delete c.od;}else{return dest;}}}}json.append(dest,c);return dest;};require('./bootstrapTransform')(json,json.transformComponent,json.checkValidOp,json.append);/**
 * Register a subtype for string operations, using the text0 type.
 */var text=require('./text0');json.registerSubtype(text);module.exports=json;},{"./bootstrapTransform":35,"./text0":38}],38:[function(require,module,exports){// DEPRECATED!
//
// This type works, but is not exported. Its included here because the JSON0
// embedded string operations use this library.
// A simple text implementation
//
// Operations are lists of components. Each component either inserts or deletes
// at a specified position in the document.
//
// Components are either:
//  {i:'str', p:100}: Insert 'str' at position 100 in the document
//  {d:'str', p:100}: Delete 'str' at position 100 in the document
//
// Components in an operation are executed sequentially, so the position of components
// assumes previous components have already executed.
//
// Eg: This op:
//   [{i:'abc', p:0}]
// is equivalent to this op:
//   [{i:'a', p:0}, {i:'b', p:1}, {i:'c', p:2}]
var text=module.exports={name:'text0',uri:'http://sharejs.org/types/textv0',create:function create(initial){if(initial!=null&&typeof initial!=='string'){throw new Error('Initial data must be a string');}return initial||'';}};/** Insert s2 into s1 at pos. */var strInject=function strInject(s1,pos,s2){return s1.slice(0,pos)+s2+s1.slice(pos);};/** Check that an operation component is valid. Throws if its invalid. */var checkValidComponent=function checkValidComponent(c){if(typeof c.p!=='number')throw new Error('component missing position field');if(typeof c.i==='string'===(typeof c.d==='string'))throw new Error('component needs an i or d field');if(c.p<0)throw new Error('position cannot be negative');};/** Check that an operation is valid */var checkValidOp=function checkValidOp(op){for(var i=0;i<op.length;i++){checkValidComponent(op[i]);}};/** Apply op to snapshot */text.apply=function(snapshot,op){var deleted;checkValidOp(op);for(var i=0;i<op.length;i++){var component=op[i];if(component.i!=null){snapshot=strInject(snapshot,component.p,component.i);}else{deleted=snapshot.slice(component.p,component.p+component.d.length);if(component.d!==deleted)throw new Error("Delete component '"+component.d+"' does not match deleted text '"+deleted+"'");snapshot=snapshot.slice(0,component.p)+snapshot.slice(component.p+component.d.length);}}return snapshot;};/**
 * Append a component to the end of newOp. Exported for use by the random op
 * generator and the JSON0 type.
 */var append=text._append=function(newOp,c){if(c.i===''||c.d==='')return;if(newOp.length===0){newOp.push(c);}else{var last=newOp[newOp.length-1];if(last.i!=null&&c.i!=null&&last.p<=c.p&&c.p<=last.p+last.i.length){// Compose the insert into the previous insert
newOp[newOp.length-1]={i:strInject(last.i,c.p-last.p,c.i),p:last.p};}else if(last.d!=null&&c.d!=null&&c.p<=last.p&&last.p<=c.p+c.d.length){// Compose the deletes together
newOp[newOp.length-1]={d:strInject(c.d,last.p-c.p,last.d),p:c.p};}else{newOp.push(c);}}};/** Compose op1 and op2 together */text.compose=function(op1,op2){checkValidOp(op1);checkValidOp(op2);var newOp=op1.slice();for(var i=0;i<op2.length;i++){append(newOp,op2[i]);}return newOp;};/** Clean up an op */text.normalize=function(op){var newOp=[];// Normalize should allow ops which are a single (unwrapped) component:
// {i:'asdf', p:23}.
// There's no good way to test if something is an array:
// http://perfectionkills.com/instanceof-considered-harmful-or-how-to-write-a-robust-isarray/
// so this is probably the least bad solution.
if(op.i!=null||op.p!=null)op=[op];for(var i=0;i<op.length;i++){var c=op[i];if(c.p==null)c.p=0;append(newOp,c);}return newOp;};// This helper method transforms a position by an op component.
//
// If c is an insert, insertAfter specifies whether the transform
// is pushed after the insert (true) or before it (false).
//
// insertAfter is optional for deletes.
var transformPosition=function transformPosition(pos,c,insertAfter){// This will get collapsed into a giant ternary by uglify.
if(c.i!=null){if(c.p<pos||c.p===pos&&insertAfter){return pos+c.i.length;}else{return pos;}}else{// I think this could also be written as: Math.min(c.p, Math.min(c.p -
// otherC.p, otherC.d.length)) but I think its harder to read that way, and
// it compiles using ternary operators anyway so its no slower written like
// this.
if(pos<=c.p){return pos;}else if(pos<=c.p+c.d.length){return c.p;}else{return pos-c.d.length;}}};// Helper method to transform a cursor position as a result of an op.
//
// Like transformPosition above, if c is an insert, insertAfter specifies
// whether the cursor position is pushed after an insert (true) or before it
// (false).
text.transformCursor=function(position,op,side){var insertAfter=side==='right';for(var i=0;i<op.length;i++){position=transformPosition(position,op[i],insertAfter);}return position;};// Transform an op component by another op component. Asymmetric.
// The result will be appended to destination.
//
// exported for use in JSON type
var transformComponent=text._tc=function(dest,c,otherC,side){//var cIntersect, intersectEnd, intersectStart, newC, otherIntersect, s;
checkValidComponent(c);checkValidComponent(otherC);if(c.i!=null){// Insert.
append(dest,{i:c.i,p:transformPosition(c.p,otherC,side==='right')});}else{// Delete
if(otherC.i!=null){// Delete vs insert
var s=c.d;if(c.p<otherC.p){append(dest,{d:s.slice(0,otherC.p-c.p),p:c.p});s=s.slice(otherC.p-c.p);}if(s!=='')append(dest,{d:s,p:c.p+otherC.i.length});}else{// Delete vs delete
if(c.p>=otherC.p+otherC.d.length)append(dest,{d:c.d,p:c.p-otherC.d.length});else if(c.p+c.d.length<=otherC.p)append(dest,c);else{// They overlap somewhere.
var newC={d:'',p:c.p};if(c.p<otherC.p)newC.d=c.d.slice(0,otherC.p-c.p);if(c.p+c.d.length>otherC.p+otherC.d.length)newC.d+=c.d.slice(otherC.p+otherC.d.length-c.p);// This is entirely optional - I'm just checking the deleted text in
// the two ops matches
var intersectStart=Math.max(c.p,otherC.p);var intersectEnd=Math.min(c.p+c.d.length,otherC.p+otherC.d.length);var cIntersect=c.d.slice(intersectStart-c.p,intersectEnd-c.p);var otherIntersect=otherC.d.slice(intersectStart-otherC.p,intersectEnd-otherC.p);if(cIntersect!==otherIntersect)throw new Error('Delete ops delete different text in the same region of the document');if(newC.d!==''){newC.p=transformPosition(newC.p,otherC);append(dest,newC);}}}}return dest;};var invertComponent=function invertComponent(c){return c.i!=null?{d:c.i,p:c.p}:{i:c.d,p:c.p};};// No need to use append for invert, because the components won't be able to
// cancel one another.
text.invert=function(op){// Shallow copy & reverse that sucka.
op=op.slice().reverse();for(var i=0;i<op.length;i++){op[i]=invertComponent(op[i]);}return op;};require('./bootstrapTransform')(text,transformComponent,checkValidOp,append);},{"./bootstrapTransform":35}],39:[function(require,module,exports){(function(process){// .dirname, .basename, and .extname methods are extracted from Node.js v8.11.1,
// backported and transplited with Babel, with backwards-compat fixes
// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
// resolves . and .. elements in a path array with directory names there
// must be no slashes, empty elements, or device names (c:\) in the array
// (so also no leading and trailing slashes - it does not distinguish
// relative and absolute paths)
function normalizeArray(parts,allowAboveRoot){// if the path tries to go above the root, `up` ends up > 0
var up=0;for(var i=parts.length-1;i>=0;i--){var last=parts[i];if(last==='.'){parts.splice(i,1);}else if(last==='..'){parts.splice(i,1);up++;}else if(up){parts.splice(i,1);up--;}}// if the path is allowed to go above the root, restore leading ..s
if(allowAboveRoot){for(;up--;up){parts.unshift('..');}}return parts;}// path.resolve([from ...], to)
// posix version
exports.resolve=function(){var resolvedPath='',resolvedAbsolute=false;for(var i=arguments.length-1;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();// Skip empty and invalid entries
if(typeof path!=='string'){throw new TypeError('Arguments to path.resolve must be strings');}else if(!path){continue;}resolvedPath=path+'/'+resolvedPath;resolvedAbsolute=path.charAt(0)==='/';}// At this point the path should be resolved to a full absolute path, but
// handle relative paths to be safe (might happen when process.cwd() fails)
// Normalize the path
resolvedPath=normalizeArray(filter(resolvedPath.split('/'),function(p){return!!p;}),!resolvedAbsolute).join('/');return(resolvedAbsolute?'/':'')+resolvedPath||'.';};// path.normalize(path)
// posix version
exports.normalize=function(path){var isAbsolute=exports.isAbsolute(path),trailingSlash=substr(path,-1)==='/';// Normalize the path
path=normalizeArray(filter(path.split('/'),function(p){return!!p;}),!isAbsolute).join('/');if(!path&&!isAbsolute){path='.';}if(path&&trailingSlash){path+='/';}return(isAbsolute?'/':'')+path;};// posix version
exports.isAbsolute=function(path){return path.charAt(0)==='/';};// posix version
exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){if(typeof p!=='string'){throw new TypeError('Arguments to path.join must be strings');}return p;}).join('/'));};// path.relative(from, to)
// posix version
exports.relative=function(from,to){from=exports.resolve(from).substr(1);to=exports.resolve(to).substr(1);function trim(arr){var start=0;for(;start<arr.length;start++){if(arr[start]!=='')break;}var end=arr.length-1;for(;end>=0;end--){if(arr[end]!=='')break;}if(start>end)return[];return arr.slice(start,end-start+1);}var fromParts=trim(from.split('/'));var toParts=trim(to.split('/'));var length=Math.min(fromParts.length,toParts.length);var samePartsLength=length;for(var i=0;i<length;i++){if(fromParts[i]!==toParts[i]){samePartsLength=i;break;}}var outputParts=[];for(var i=samePartsLength;i<fromParts.length;i++){outputParts.push('..');}outputParts=outputParts.concat(toParts.slice(samePartsLength));return outputParts.join('/');};exports.sep='/';exports.delimiter=':';exports.dirname=function(path){if(typeof path!=='string')path=path+'';if(path.length===0)return'.';var code=path.charCodeAt(0);var hasRoot=code===47/*/*/;var end=-1;var matchedSlash=true;for(var i=path.length-1;i>=1;--i){code=path.charCodeAt(i);if(code===47/*/*/){if(!matchedSlash){end=i;break;}}else{// We saw the first non-path separator
matchedSlash=false;}}if(end===-1)return hasRoot?'/':'.';if(hasRoot&&end===1){// return '//';
// Backwards-compat fix:
return'/';}return path.slice(0,end);};function basename(path){if(typeof path!=='string')path=path+'';var start=0;var end=-1;var matchedSlash=true;var i;for(i=path.length-1;i>=0;--i){if(path.charCodeAt(i)===47/*/*/){// If we reached a path separator that was not part of a set of path
// separators at the end of the string, stop now
if(!matchedSlash){start=i+1;break;}}else if(end===-1){// We saw the first non-path separator, mark this as the end of our
// path component
matchedSlash=false;end=i+1;}}if(end===-1)return'';return path.slice(start,end);}// Uses a mixed approach for backwards-compatibility, as ext behavior changed
// in new Node.js versions, so only basename() above is backported here
exports.basename=function(path,ext){var f=basename(path);if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length);}return f;};exports.extname=function(path){if(typeof path!=='string')path=path+'';var startDot=-1;var startPart=0;var end=-1;var matchedSlash=true;// Track the state of characters (if any) we see before our first dot and
// after any path separator we find
var preDotState=0;for(var i=path.length-1;i>=0;--i){var code=path.charCodeAt(i);if(code===47/*/*/){// If we reached a path separator that was not part of a set of path
// separators at the end of the string, stop now
if(!matchedSlash){startPart=i+1;break;}continue;}if(end===-1){// We saw the first non-path separator, mark this as the end of our
// extension
matchedSlash=false;end=i+1;}if(code===46/*.*/){// If this is our first dot, mark it as the start of our extension
if(startDot===-1)startDot=i;else if(preDotState!==1)preDotState=1;}else if(startDot!==-1){// We saw a non-dot and non-path separator before our dot, so we should
// have a good chance at having a non-empty extension
preDotState=-1;}}if(startDot===-1||end===-1||// We saw a non-dot character immediately before the dot
preDotState===0||// The (right-most) trimmed path component is exactly '..'
preDotState===1&&startDot===end-1&&startDot===startPart+1){return'';}return path.slice(startDot,end);};function filter(xs,f){if(xs.filter)return xs.filter(f);var res=[];for(var i=0;i<xs.length;i++){if(f(xs[i],i,xs))res.push(xs[i]);}return res;}// String.prototype.substr - negative index don't work in IE8
var substr='ab'.substr(-1)==='b'?function(str,start,len){return str.substr(start,len);}:function(str,start,len){if(start<0)start=str.length+start;return str.substr(start,len);};}).call(this,require('_process'));},{"_process":40}],40:[function(require,module,exports){// shim for using process in browser
var process=module.exports={};// cached from whatever global is present so that test runners that stub it
// don't break things.  But we need to wrap it in a try catch in case it is
// wrapped in strict mode code which doesn't define any globals.  It's inside a
// function because try/catches deoptimize in certain engines.
var cachedSetTimeout;var cachedClearTimeout;function defaultSetTimout(){throw new Error('setTimeout has not been defined');}function defaultClearTimeout(){throw new Error('clearTimeout has not been defined');}(function(){try{if(typeof setTimeout==='function'){cachedSetTimeout=setTimeout;}else{cachedSetTimeout=defaultSetTimout;}}catch(e){cachedSetTimeout=defaultSetTimout;}try{if(typeof clearTimeout==='function'){cachedClearTimeout=clearTimeout;}else{cachedClearTimeout=defaultClearTimeout;}}catch(e){cachedClearTimeout=defaultClearTimeout;}})();function runTimeout(fun){if(cachedSetTimeout===setTimeout){//normal enviroments in sane situations
return setTimeout(fun,0);}// if setTimeout wasn't available but was latter defined
if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout){cachedSetTimeout=setTimeout;return setTimeout(fun,0);}try{// when when somebody has screwed with setTimeout but no I.E. maddness
return cachedSetTimeout(fun,0);}catch(e){try{// When we are in I.E. but the script has been evaled so I.E. doesn't trust the global object when called normally
return cachedSetTimeout.call(null,fun,0);}catch(e){// same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error
return cachedSetTimeout.call(this,fun,0);}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout){//normal enviroments in sane situations
return clearTimeout(marker);}// if clearTimeout wasn't available but was latter defined
if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout){cachedClearTimeout=clearTimeout;return clearTimeout(marker);}try{// when when somebody has screwed with setTimeout but no I.E. maddness
return cachedClearTimeout(marker);}catch(e){try{// When we are in I.E. but the script has been evaled so I.E. doesn't  trust the global object when called normally
return cachedClearTimeout.call(null,marker);}catch(e){// same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error.
// Some versions of I.E. have different rules for clearTimeout vs setTimeout
return cachedClearTimeout.call(this,marker);}}}var queue=[];var draining=false;var currentQueue;var queueIndex=-1;function cleanUpNextTick(){if(!draining||!currentQueue){return;}draining=false;if(currentQueue.length){queue=currentQueue.concat(queue);}else{queueIndex=-1;}if(queue.length){drainQueue();}}function drainQueue(){if(draining){return;}var timeout=runTimeout(cleanUpNextTick);draining=true;var len=queue.length;while(len){currentQueue=queue;queue=[];while(++queueIndex<len){if(currentQueue){currentQueue[queueIndex].run();}}queueIndex=-1;len=queue.length;}currentQueue=null;draining=false;runClearTimeout(timeout);}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1){for(var i=1;i<arguments.length;i++){args[i-1]=arguments[i];}}queue.push(new Item(fun,args));if(queue.length===1&&!draining){runTimeout(drainQueue);}};// v8 likes predictible objects
function Item(fun,array){this.fun=fun;this.array=array;}Item.prototype.run=function(){this.fun.apply(null,this.array);};process.title='browser';process.browser=true;process.env={};process.argv=[];process.version='';// empty string to avoid regexp issues
process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.prependListener=noop;process.prependOnceListener=noop;process.listeners=function(name){return[];};process.binding=function(name){throw new Error('process.binding is not supported');};process.cwd=function(){return'/';};process.chdir=function(dir){throw new Error('process.chdir is not supported');};process.umask=function(){return 0;};},{}],41:[function(require,module,exports){(function(global){/*! https://mths.be/punycode v1.4.1 by @mathias */;(function(root){/** Detect free variables */var freeExports=_typeof(exports)=='object'&&exports&&!exports.nodeType&&exports;var freeModule=_typeof(module)=='object'&&module&&!module.nodeType&&module;var freeGlobal=_typeof(global)=='object'&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal||freeGlobal.self===freeGlobal){root=freeGlobal;}/**
	 * The `punycode` object.
	 * @name punycode
	 * @type Object
	 */var punycode,/** Highest positive signed 32-bit float value */maxInt=2147483647,// aka. 0x7FFFFFFF or 2^31-1
/** Bootstring parameters */base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,// 0x80
delimiter='-',// '\x2D'
/** Regular expressions */regexPunycode=/^xn--/,regexNonASCII=/[^\x20-\x7E]/,// unprintable ASCII chars + non-ASCII chars
regexSeparators=/[\x2E\u3002\uFF0E\uFF61]/g,// RFC 3490 separators
/** Error messages */errors={'overflow':'Overflow: input needs wider integers to process','not-basic':'Illegal input >= 0x80 (not a basic code point)','invalid-input':'Invalid input'},/** Convenience shortcuts */baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,/** Temporary variable */key;/*--------------------------------------------------------------------------*/ /**
	 * A generic error utility function.
	 * @private
	 * @param {String} type The error type.
	 * @returns {Error} Throws a `RangeError` with the applicable error message.
	 */function error(type){throw new RangeError(errors[type]);}/**
	 * A generic `Array#map` utility function.
	 * @private
	 * @param {Array} array The array to iterate over.
	 * @param {Function} callback The function that gets called for every array
	 * item.
	 * @returns {Array} A new array of values returned by the callback function.
	 */function map(array,fn){var length=array.length;var result=[];while(length--){result[length]=fn(array[length]);}return result;}/**
	 * A simple `Array#map`-like wrapper to work with domain name strings or email
	 * addresses.
	 * @private
	 * @param {String} domain The domain name or email address.
	 * @param {Function} callback The function that gets called for every
	 * character.
	 * @returns {Array} A new string of characters returned by the callback
	 * function.
	 */function mapDomain(string,fn){var parts=string.split('@');var result='';if(parts.length>1){// In email addresses, only the domain name should be punycoded. Leave
// the local part (i.e. everything up to `@`) intact.
result=parts[0]+'@';string=parts[1];}// Avoid `split(regex)` for IE8 compatibility. See #17.
string=string.replace(regexSeparators,'\x2E');var labels=string.split('.');var encoded=map(labels,fn).join('.');return result+encoded;}/**
	 * Creates an array containing the numeric code points of each Unicode
	 * character in the string. While JavaScript uses UCS-2 internally,
	 * this function will convert a pair of surrogate halves (each of which
	 * UCS-2 exposes as separate characters) into a single code point,
	 * matching UTF-16.
	 * @see `punycode.ucs2.encode`
	 * @see <https://mathiasbynens.be/notes/javascript-encoding>
	 * @memberOf punycode.ucs2
	 * @name decode
	 * @param {String} string The Unicode input string (UCS-2).
	 * @returns {Array} The new array of code points.
	 */function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=0xD800&&value<=0xDBFF&&counter<length){// high surrogate, and there is a next character
extra=string.charCodeAt(counter++);if((extra&0xFC00)==0xDC00){// low surrogate
output.push(((value&0x3FF)<<10)+(extra&0x3FF)+0x10000);}else{// unmatched surrogate; only append this code unit, in case the next
// code unit is the high surrogate of a surrogate pair
output.push(value);counter--;}}else{output.push(value);}}return output;}/**
	 * Creates a string based on an array of numeric code points.
	 * @see `punycode.ucs2.decode`
	 * @memberOf punycode.ucs2
	 * @name encode
	 * @param {Array} codePoints The array of numeric code points.
	 * @returns {String} The new Unicode string (UCS-2).
	 */function ucs2encode(array){return map(array,function(value){var output='';if(value>0xFFFF){value-=0x10000;output+=stringFromCharCode(value>>>10&0x3FF|0xD800);value=0xDC00|value&0x3FF;}output+=stringFromCharCode(value);return output;}).join('');}/**
	 * Converts a basic code point into a digit/integer.
	 * @see `digitToBasic()`
	 * @private
	 * @param {Number} codePoint The basic numeric code point value.
	 * @returns {Number} The numeric value of a basic code point (for use in
	 * representing integers) in the range `0` to `base - 1`, or `base` if
	 * the code point does not represent a value.
	 */function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22;}if(codePoint-65<26){return codePoint-65;}if(codePoint-97<26){return codePoint-97;}return base;}/**
	 * Converts a digit/integer into a basic code point.
	 * @see `basicToDigit()`
	 * @private
	 * @param {Number} digit The numeric value of a basic code point.
	 * @returns {Number} The basic code point whose value (when used for
	 * representing integers) is `digit`, which needs to be in the range
	 * `0` to `base - 1`. If `flag` is non-zero, the uppercase form is
	 * used; else, the lowercase form is used. The behavior is undefined
	 * if `flag` is non-zero and `digit` has no uppercase form.
	 */function digitToBasic(digit,flag){//  0..25 map to ASCII a..z or A..Z
// 26..35 map to ASCII 0..9
return digit+22+75*(digit<26)-((flag!=0)<<5);}/**
	 * Bias adaptation function as per section 3.4 of RFC 3492.
	 * https://tools.ietf.org/html/rfc3492#section-3.4
	 * @private
	 */function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;/* no initialization */delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin);}return floor(k+(baseMinusTMin+1)*delta/(delta+skew));}/**
	 * Converts a Punycode string of ASCII-only symbols to a string of Unicode
	 * symbols.
	 * @memberOf punycode
	 * @param {String} input The Punycode string of ASCII-only symbols.
	 * @returns {String} The resulting string of Unicode symbols.
	 */function decode(input){// Don't use UCS-2
var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,/** Cached calculation results */baseMinusT;// Handle the basic code points: let `basic` be the number of input code
// points before the last delimiter, or `0` if there is none, then copy
// the first basic code points to the output.
basic=input.lastIndexOf(delimiter);if(basic<0){basic=0;}for(j=0;j<basic;++j){// if it's not a basic code point
if(input.charCodeAt(j)>=0x80){error('not-basic');}output.push(input.charCodeAt(j));}// Main decoding loop: start just after the last delimiter if any basic code
// points were copied; start at the beginning otherwise.
for(index=basic>0?basic+1:0;index<inputLength;)/* no final expression */{// `index` is the index of the next character to be consumed.
// Decode a generalized variable-length integer into `delta`,
// which gets added to `i`. The overflow checking is easier
// if we increase `i` as we go, then subtract off its starting
// value at the end to obtain `delta`.
for(oldi=i,w=1,k=base;;/* no condition */k+=base){if(index>=inputLength){error('invalid-input');}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error('overflow');}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break;}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error('overflow');}w*=baseMinusT;}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);// `i` was supposed to wrap around from `out` to `0`,
// incrementing `n` each time, so we'll fix that now:
if(floor(i/out)>maxInt-n){error('overflow');}n+=floor(i/out);i%=out;// Insert `n` at position `i` of the output
output.splice(i++,0,n);}return ucs2encode(output);}/**
	 * Converts a string of Unicode symbols (e.g. a domain name label) to a
	 * Punycode string of ASCII-only symbols.
	 * @memberOf punycode
	 * @param {String} input The string of Unicode symbols.
	 * @returns {String} The resulting Punycode string of ASCII-only symbols.
	 */function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],/** `inputLength` will hold the number of code points in `input`. */inputLength,/** Cached calculation results */handledCPCountPlusOne,baseMinusT,qMinusT;// Convert the input in UCS-2 to Unicode
input=ucs2decode(input);// Cache the length
inputLength=input.length;// Initialize the state
n=initialN;delta=0;bias=initialBias;// Handle the basic code points
for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<0x80){output.push(stringFromCharCode(currentValue));}}handledCPCount=basicLength=output.length;// `handledCPCount` is the number of code points that have been handled;
// `basicLength` is the number of basic code points.
// Finish the basic string - if it is not empty - with a delimiter
if(basicLength){output.push(delimiter);}// Main encoding loop:
while(handledCPCount<inputLength){// All non-basic code points < n have been handled already. Find the next
// larger one:
for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue;}}// Increase `delta` enough to advance the decoder's <n,i> state to <m,0>,
// but guard against overflow
handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error('overflow');}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error('overflow');}if(currentValue==n){// Represent delta as a generalized variable-length integer
for(q=delta,k=base;;/* no condition */k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break;}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT);}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount;}}++delta;++n;}return output.join('');}/**
	 * Converts a Punycode string representing a domain name or an email address
	 * to Unicode. Only the Punycoded parts of the input will be converted, i.e.
	 * it doesn't matter if you call it on a string that has already been
	 * converted to Unicode.
	 * @memberOf punycode
	 * @param {String} input The Punycoded domain name or email address to
	 * convert to Unicode.
	 * @returns {String} The Unicode representation of the given Punycode
	 * string.
	 */function toUnicode(input){return mapDomain(input,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string;});}/**
	 * Converts a Unicode string representing a domain name or an email address to
	 * Punycode. Only the non-ASCII parts of the domain name will be converted,
	 * i.e. it doesn't matter if you call it with a domain that's already in
	 * ASCII.
	 * @memberOf punycode
	 * @param {String} input The domain name or email address to convert, as a
	 * Unicode string.
	 * @returns {String} The Punycode representation of the given domain name or
	 * email address.
	 */function toASCII(input){return mapDomain(input,function(string){return regexNonASCII.test(string)?'xn--'+encode(string):string;});}/*--------------------------------------------------------------------------*/ /** Define the public API */punycode={/**
		 * A string representing the current Punycode.js version number.
		 * @memberOf punycode
		 * @type String
		 */'version':'1.4.1',/**
		 * An object of methods to convert from JavaScript's internal character
		 * representation (UCS-2) to Unicode code points, and back.
		 * @see <https://mathiasbynens.be/notes/javascript-encoding>
		 * @memberOf punycode
		 * @type Object
		 */'ucs2':{'decode':ucs2decode,'encode':ucs2encode},'decode':decode,'encode':encode,'toASCII':toASCII,'toUnicode':toUnicode};/** Expose `punycode` */ // Some AMD build optimizers, like r.js, check for specific condition patterns
// like the following:
if(typeof define=='function'&&_typeof(define.amd)=='object'&&define.amd){define('punycode',function(){return punycode;});}else if(freeExports&&freeModule){if(module.exports==freeExports){// in Node.js, io.js, or RingoJS v0.8.0+
freeModule.exports=punycode;}else{// in Narwhal or RingoJS v0.7.0-
for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key]);}}}else{// in Rhino or a web browser
root.punycode=punycode;}})(this);}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],42:[function(require,module,exports){'use strict';var replace=String.prototype.replace;var percentTwenties=/%20/g;var util=require('./utils');var Format={RFC1738:'RFC1738',RFC3986:'RFC3986'};module.exports=util.assign({'default':Format.RFC3986,formatters:{RFC1738:function RFC1738(value){return replace.call(value,percentTwenties,'+');},RFC3986:function RFC3986(value){return String(value);}}},Format);},{"./utils":46}],43:[function(require,module,exports){'use strict';var stringify=require('./stringify');var parse=require('./parse');var formats=require('./formats');module.exports={formats:formats,parse:parse,stringify:stringify};},{"./formats":42,"./parse":44,"./stringify":45}],44:[function(require,module,exports){'use strict';var utils=require('./utils');var has=Object.prototype.hasOwnProperty;var isArray=Array.isArray;var defaults={allowDots:false,allowPrototypes:false,arrayLimit:20,charset:'utf-8',charsetSentinel:false,comma:false,decoder:utils.decode,delimiter:'&',depth:5,ignoreQueryPrefix:false,interpretNumericEntities:false,parameterLimit:1000,parseArrays:true,plainObjects:false,strictNullHandling:false};var interpretNumericEntities=function interpretNumericEntities(str){return str.replace(/&#(\d+);/g,function($0,numberStr){return String.fromCharCode(parseInt(numberStr,10));});};// This is what browsers will submit when the  character occurs in an
// application/x-www-form-urlencoded body and the encoding of the page containing
// the form is iso-8859-1, or when the submitted form has an accept-charset
// attribute of iso-8859-1. Presumably also with other charsets that do not contain
// the  character, such as us-ascii.
var isoSentinel='utf8=%26%2310003%3B';// encodeURIComponent('&#10003;')
// These are the percent-encoded utf-8 octets representing a checkmark, indicating that the request actually is utf-8 encoded.
var charsetSentinel='utf8=%E2%9C%93';// encodeURIComponent('')
var parseValues=function parseQueryStringValues(str,options){var obj={};var cleanStr=options.ignoreQueryPrefix?str.replace(/^\?/,''):str;var limit=options.parameterLimit===Infinity?undefined:options.parameterLimit;var parts=cleanStr.split(options.delimiter,limit);var skipIndex=-1;// Keep track of where the utf8 sentinel was found
var i;var charset=options.charset;if(options.charsetSentinel){for(i=0;i<parts.length;++i){if(parts[i].indexOf('utf8=')===0){if(parts[i]===charsetSentinel){charset='utf-8';}else if(parts[i]===isoSentinel){charset='iso-8859-1';}skipIndex=i;i=parts.length;// The eslint settings do not allow break;
}}}for(i=0;i<parts.length;++i){if(i===skipIndex){continue;}var part=parts[i];var bracketEqualsPos=part.indexOf(']=');var pos=bracketEqualsPos===-1?part.indexOf('='):bracketEqualsPos+1;var key,val;if(pos===-1){key=options.decoder(part,defaults.decoder,charset,'key');val=options.strictNullHandling?null:'';}else{key=options.decoder(part.slice(0,pos),defaults.decoder,charset,'key');val=options.decoder(part.slice(pos+1),defaults.decoder,charset,'value');}if(val&&options.interpretNumericEntities&&charset==='iso-8859-1'){val=interpretNumericEntities(val);}if(val&&typeof val==='string'&&options.comma&&val.indexOf(',')>-1){val=val.split(',');}if(part.indexOf('[]=')>-1){val=isArray(val)?[val]:val;}if(has.call(obj,key)){obj[key]=utils.combine(obj[key],val);}else{obj[key]=val;}}return obj;};var parseObject=function parseObject(chain,val,options){var leaf=val;for(var i=chain.length-1;i>=0;--i){var obj;var root=chain[i];if(root==='[]'&&options.parseArrays){obj=[].concat(leaf);}else{obj=options.plainObjects?Object.create(null):{};var cleanRoot=root.charAt(0)==='['&&root.charAt(root.length-1)===']'?root.slice(1,-1):root;var index=parseInt(cleanRoot,10);if(!options.parseArrays&&cleanRoot===''){obj={0:leaf};}else if(!isNaN(index)&&root!==cleanRoot&&String(index)===cleanRoot&&index>=0&&options.parseArrays&&index<=options.arrayLimit){obj=[];obj[index]=leaf;}else{obj[cleanRoot]=leaf;}}leaf=obj;}return leaf;};var parseKeys=function parseQueryStringKeys(givenKey,val,options){if(!givenKey){return;}// Transform dot notation to bracket notation
var key=options.allowDots?givenKey.replace(/\.([^.[]+)/g,'[$1]'):givenKey;// The regex chunks
var brackets=/(\[[^[\]]*])/;var child=/(\[[^[\]]*])/g;// Get the parent
var segment=options.depth>0&&brackets.exec(key);var parent=segment?key.slice(0,segment.index):key;// Stash the parent if it exists
var keys=[];if(parent){// If we aren't using plain objects, optionally prefix keys that would overwrite object prototype properties
if(!options.plainObjects&&has.call(Object.prototype,parent)){if(!options.allowPrototypes){return;}}keys.push(parent);}// Loop through children appending to the array until we hit depth
var i=0;while(options.depth>0&&(segment=child.exec(key))!==null&&i<options.depth){i+=1;if(!options.plainObjects&&has.call(Object.prototype,segment[1].slice(1,-1))){if(!options.allowPrototypes){return;}}keys.push(segment[1]);}// If there's a remainder, just add whatever is left
if(segment){keys.push('['+key.slice(segment.index)+']');}return parseObject(keys,val,options);};var normalizeParseOptions=function normalizeParseOptions(opts){if(!opts){return defaults;}if(opts.decoder!==null&&opts.decoder!==undefined&&typeof opts.decoder!=='function'){throw new TypeError('Decoder has to be a function.');}if(typeof opts.charset!=='undefined'&&opts.charset!=='utf-8'&&opts.charset!=='iso-8859-1'){throw new Error('The charset option must be either utf-8, iso-8859-1, or undefined');}var charset=typeof opts.charset==='undefined'?defaults.charset:opts.charset;return{allowDots:typeof opts.allowDots==='undefined'?defaults.allowDots:!!opts.allowDots,allowPrototypes:typeof opts.allowPrototypes==='boolean'?opts.allowPrototypes:defaults.allowPrototypes,arrayLimit:typeof opts.arrayLimit==='number'?opts.arrayLimit:defaults.arrayLimit,charset:charset,charsetSentinel:typeof opts.charsetSentinel==='boolean'?opts.charsetSentinel:defaults.charsetSentinel,comma:typeof opts.comma==='boolean'?opts.comma:defaults.comma,decoder:typeof opts.decoder==='function'?opts.decoder:defaults.decoder,delimiter:typeof opts.delimiter==='string'||utils.isRegExp(opts.delimiter)?opts.delimiter:defaults.delimiter,// eslint-disable-next-line no-implicit-coercion, no-extra-parens
depth:typeof opts.depth==='number'||opts.depth===false?+opts.depth:defaults.depth,ignoreQueryPrefix:opts.ignoreQueryPrefix===true,interpretNumericEntities:typeof opts.interpretNumericEntities==='boolean'?opts.interpretNumericEntities:defaults.interpretNumericEntities,parameterLimit:typeof opts.parameterLimit==='number'?opts.parameterLimit:defaults.parameterLimit,parseArrays:opts.parseArrays!==false,plainObjects:typeof opts.plainObjects==='boolean'?opts.plainObjects:defaults.plainObjects,strictNullHandling:typeof opts.strictNullHandling==='boolean'?opts.strictNullHandling:defaults.strictNullHandling};};module.exports=function(str,opts){var options=normalizeParseOptions(opts);if(str===''||str===null||typeof str==='undefined'){return options.plainObjects?Object.create(null):{};}var tempObj=typeof str==='string'?parseValues(str,options):str;var obj=options.plainObjects?Object.create(null):{};// Iterate over the keys and setup the new object
var keys=Object.keys(tempObj);for(var i=0;i<keys.length;++i){var key=keys[i];var newObj=parseKeys(key,tempObj[key],options);obj=utils.merge(obj,newObj,options);}return utils.compact(obj);};},{"./utils":46}],45:[function(require,module,exports){'use strict';var utils=require('./utils');var formats=require('./formats');var has=Object.prototype.hasOwnProperty;var arrayPrefixGenerators={brackets:function brackets(prefix){return prefix+'[]';},comma:'comma',indices:function indices(prefix,key){return prefix+'['+key+']';},repeat:function repeat(prefix){return prefix;}};var isArray=Array.isArray;var push=Array.prototype.push;var pushToArray=function pushToArray(arr,valueOrArray){push.apply(arr,isArray(valueOrArray)?valueOrArray:[valueOrArray]);};var toISO=Date.prototype.toISOString;var defaultFormat=formats['default'];var defaults={addQueryPrefix:false,allowDots:false,charset:'utf-8',charsetSentinel:false,delimiter:'&',encode:true,encoder:utils.encode,encodeValuesOnly:false,format:defaultFormat,formatter:formats.formatters[defaultFormat],// deprecated
indices:false,serializeDate:function serializeDate(date){return toISO.call(date);},skipNulls:false,strictNullHandling:false};var isNonNullishPrimitive=function isNonNullishPrimitive(v){return typeof v==='string'||typeof v==='number'||typeof v==='boolean'||_typeof(v)==='symbol'||typeof v==='bigint';};var stringify=function stringify(object,prefix,generateArrayPrefix,strictNullHandling,skipNulls,encoder,filter,sort,allowDots,serializeDate,formatter,encodeValuesOnly,charset){var obj=object;if(typeof filter==='function'){obj=filter(prefix,obj);}else if(obj instanceof Date){obj=serializeDate(obj);}else if(generateArrayPrefix==='comma'&&isArray(obj)){obj=obj.join(',');}if(obj===null){if(strictNullHandling){return encoder&&!encodeValuesOnly?encoder(prefix,defaults.encoder,charset,'key'):prefix;}obj='';}if(isNonNullishPrimitive(obj)||utils.isBuffer(obj)){if(encoder){var keyValue=encodeValuesOnly?prefix:encoder(prefix,defaults.encoder,charset,'key');return[formatter(keyValue)+'='+formatter(encoder(obj,defaults.encoder,charset,'value'))];}return[formatter(prefix)+'='+formatter(String(obj))];}var values=[];if(typeof obj==='undefined'){return values;}var objKeys;if(isArray(filter)){objKeys=filter;}else{var keys=Object.keys(obj);objKeys=sort?keys.sort(sort):keys;}for(var i=0;i<objKeys.length;++i){var key=objKeys[i];if(skipNulls&&obj[key]===null){continue;}if(isArray(obj)){pushToArray(values,stringify(obj[key],typeof generateArrayPrefix==='function'?generateArrayPrefix(prefix,key):prefix,generateArrayPrefix,strictNullHandling,skipNulls,encoder,filter,sort,allowDots,serializeDate,formatter,encodeValuesOnly,charset));}else{pushToArray(values,stringify(obj[key],prefix+(allowDots?'.'+key:'['+key+']'),generateArrayPrefix,strictNullHandling,skipNulls,encoder,filter,sort,allowDots,serializeDate,formatter,encodeValuesOnly,charset));}}return values;};var normalizeStringifyOptions=function normalizeStringifyOptions(opts){if(!opts){return defaults;}if(opts.encoder!==null&&opts.encoder!==undefined&&typeof opts.encoder!=='function'){throw new TypeError('Encoder has to be a function.');}var charset=opts.charset||defaults.charset;if(typeof opts.charset!=='undefined'&&opts.charset!=='utf-8'&&opts.charset!=='iso-8859-1'){throw new TypeError('The charset option must be either utf-8, iso-8859-1, or undefined');}var format=formats['default'];if(typeof opts.format!=='undefined'){if(!has.call(formats.formatters,opts.format)){throw new TypeError('Unknown format option provided.');}format=opts.format;}var formatter=formats.formatters[format];var filter=defaults.filter;if(typeof opts.filter==='function'||isArray(opts.filter)){filter=opts.filter;}return{addQueryPrefix:typeof opts.addQueryPrefix==='boolean'?opts.addQueryPrefix:defaults.addQueryPrefix,allowDots:typeof opts.allowDots==='undefined'?defaults.allowDots:!!opts.allowDots,charset:charset,charsetSentinel:typeof opts.charsetSentinel==='boolean'?opts.charsetSentinel:defaults.charsetSentinel,delimiter:typeof opts.delimiter==='undefined'?defaults.delimiter:opts.delimiter,encode:typeof opts.encode==='boolean'?opts.encode:defaults.encode,encoder:typeof opts.encoder==='function'?opts.encoder:defaults.encoder,encodeValuesOnly:typeof opts.encodeValuesOnly==='boolean'?opts.encodeValuesOnly:defaults.encodeValuesOnly,filter:filter,formatter:formatter,serializeDate:typeof opts.serializeDate==='function'?opts.serializeDate:defaults.serializeDate,skipNulls:typeof opts.skipNulls==='boolean'?opts.skipNulls:defaults.skipNulls,sort:typeof opts.sort==='function'?opts.sort:null,strictNullHandling:typeof opts.strictNullHandling==='boolean'?opts.strictNullHandling:defaults.strictNullHandling};};module.exports=function(object,opts){var obj=object;var options=normalizeStringifyOptions(opts);var objKeys;var filter;if(typeof options.filter==='function'){filter=options.filter;obj=filter('',obj);}else if(isArray(options.filter)){filter=options.filter;objKeys=filter;}var keys=[];if(_typeof(obj)!=='object'||obj===null){return'';}var arrayFormat;if(opts&&opts.arrayFormat in arrayPrefixGenerators){arrayFormat=opts.arrayFormat;}else if(opts&&'indices'in opts){arrayFormat=opts.indices?'indices':'repeat';}else{arrayFormat='indices';}var generateArrayPrefix=arrayPrefixGenerators[arrayFormat];if(!objKeys){objKeys=Object.keys(obj);}if(options.sort){objKeys.sort(options.sort);}for(var i=0;i<objKeys.length;++i){var key=objKeys[i];if(options.skipNulls&&obj[key]===null){continue;}pushToArray(keys,stringify(obj[key],key,generateArrayPrefix,options.strictNullHandling,options.skipNulls,options.encode?options.encoder:null,options.filter,options.sort,options.allowDots,options.serializeDate,options.formatter,options.encodeValuesOnly,options.charset));}var joined=keys.join(options.delimiter);var prefix=options.addQueryPrefix===true?'?':'';if(options.charsetSentinel){if(options.charset==='iso-8859-1'){// encodeURIComponent('&#10003;'), the "numeric entity" representation of a checkmark
prefix+='utf8=%26%2310003%3B&';}else{// encodeURIComponent('')
prefix+='utf8=%E2%9C%93&';}}return joined.length>0?prefix+joined:'';};},{"./formats":42,"./utils":46}],46:[function(require,module,exports){'use strict';var has=Object.prototype.hasOwnProperty;var isArray=Array.isArray;var hexTable=function(){var array=[];for(var i=0;i<256;++i){array.push('%'+((i<16?'0':'')+i.toString(16)).toUpperCase());}return array;}();var compactQueue=function compactQueue(queue){while(queue.length>1){var item=queue.pop();var obj=item.obj[item.prop];if(isArray(obj)){var compacted=[];for(var j=0;j<obj.length;++j){if(typeof obj[j]!=='undefined'){compacted.push(obj[j]);}}item.obj[item.prop]=compacted;}}};var arrayToObject=function arrayToObject(source,options){var obj=options&&options.plainObjects?Object.create(null):{};for(var i=0;i<source.length;++i){if(typeof source[i]!=='undefined'){obj[i]=source[i];}}return obj;};var merge=function merge(target,source,options){/* eslint no-param-reassign: 0 */if(!source){return target;}if(_typeof(source)!=='object'){if(isArray(target)){target.push(source);}else if(target&&_typeof(target)==='object'){if(options&&(options.plainObjects||options.allowPrototypes)||!has.call(Object.prototype,source)){target[source]=true;}}else{return[target,source];}return target;}if(!target||_typeof(target)!=='object'){return[target].concat(source);}var mergeTarget=target;if(isArray(target)&&!isArray(source)){mergeTarget=arrayToObject(target,options);}if(isArray(target)&&isArray(source)){source.forEach(function(item,i){if(has.call(target,i)){var targetItem=target[i];if(targetItem&&_typeof(targetItem)==='object'&&item&&_typeof(item)==='object'){target[i]=merge(targetItem,item,options);}else{target.push(item);}}else{target[i]=item;}});return target;}return Object.keys(source).reduce(function(acc,key){var value=source[key];if(has.call(acc,key)){acc[key]=merge(acc[key],value,options);}else{acc[key]=value;}return acc;},mergeTarget);};var assign=function assignSingleSource(target,source){return Object.keys(source).reduce(function(acc,key){acc[key]=source[key];return acc;},target);};var decode=function decode(str,decoder,charset){var strWithoutPlus=str.replace(/\+/g,' ');if(charset==='iso-8859-1'){// unescape never throws, no try...catch needed:
return strWithoutPlus.replace(/%[0-9a-f]{2}/gi,unescape);}// utf-8
try{return decodeURIComponent(strWithoutPlus);}catch(e){return strWithoutPlus;}};var encode=function encode(str,defaultEncoder,charset){// This code was originally written by Brian White (mscdex) for the io.js core querystring library.
// It has been adapted here for stricter adherence to RFC 3986
if(str.length===0){return str;}var string=str;if(_typeof(str)==='symbol'){string=Symbol.prototype.toString.call(str);}else if(typeof str!=='string'){string=String(str);}if(charset==='iso-8859-1'){return escape(string).replace(/%u[0-9a-f]{4}/gi,function($0){return'%26%23'+parseInt($0.slice(2),16)+'%3B';});}var out='';for(var i=0;i<string.length;++i){var c=string.charCodeAt(i);if(c===0x2D// -
||c===0x2E// .
||c===0x5F// _
||c===0x7E// ~
||c>=0x30&&c<=0x39// 0-9
||c>=0x41&&c<=0x5A// a-z
||c>=0x61&&c<=0x7A// A-Z
){out+=string.charAt(i);continue;}if(c<0x80){out=out+hexTable[c];continue;}if(c<0x800){out=out+(hexTable[0xC0|c>>6]+hexTable[0x80|c&0x3F]);continue;}if(c<0xD800||c>=0xE000){out=out+(hexTable[0xE0|c>>12]+hexTable[0x80|c>>6&0x3F]+hexTable[0x80|c&0x3F]);continue;}i+=1;c=0x10000+((c&0x3FF)<<10|string.charCodeAt(i)&0x3FF);out+=hexTable[0xF0|c>>18]+hexTable[0x80|c>>12&0x3F]+hexTable[0x80|c>>6&0x3F]+hexTable[0x80|c&0x3F];}return out;};var compact=function compact(value){var queue=[{obj:{o:value},prop:'o'}];var refs=[];for(var i=0;i<queue.length;++i){var item=queue[i];var obj=item.obj[item.prop];var keys=Object.keys(obj);for(var j=0;j<keys.length;++j){var key=keys[j];var val=obj[key];if(_typeof(val)==='object'&&val!==null&&refs.indexOf(val)===-1){queue.push({obj:obj,prop:key});refs.push(val);}}}compactQueue(queue);return value;};var isRegExp=function isRegExp(obj){return Object.prototype.toString.call(obj)==='[object RegExp]';};var isBuffer=function isBuffer(obj){if(!obj||_typeof(obj)!=='object'){return false;}return!!(obj.constructor&&obj.constructor.isBuffer&&obj.constructor.isBuffer(obj));};var combine=function combine(a,b){return[].concat(a,b);};module.exports={arrayToObject:arrayToObject,assign:assign,combine:combine,compact:compact,decode:decode,encode:encode,isBuffer:isBuffer,isRegExp:isRegExp,merge:merge};},{}],47:[function(require,module,exports){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
'use strict';// If obj.hasOwnProperty has been overridden, then calling
// obj.hasOwnProperty(prop) will break.
// See: https://github.com/joyent/node/issues/1707
function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop);}module.exports=function(qs,sep,eq,options){sep=sep||'&';eq=eq||'=';var obj={};if(typeof qs!=='string'||qs.length===0){return obj;}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1000;if(options&&typeof options.maxKeys==='number'){maxKeys=options.maxKeys;}var len=qs.length;// maxKeys <= 0 means that we should not limit keys count
if(maxKeys>0&&len>maxKeys){len=maxKeys;}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,'%20'),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1);}else{kstr=x;vstr='';}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v;}else if(isArray(obj[k])){obj[k].push(v);}else{obj[k]=[obj[k],v];}}return obj;};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==='[object Array]';};},{}],48:[function(require,module,exports){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
'use strict';var stringifyPrimitive=function stringifyPrimitive(v){switch(_typeof(v)){case'string':return v;case'boolean':return v?'true':'false';case'number':return isFinite(v)?v:'';default:return'';}};module.exports=function(obj,sep,eq,name){sep=sep||'&';eq=eq||'=';if(obj===null){obj=undefined;}if(_typeof(obj)==='object'){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v));}).join(sep);}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]));}}).join(sep);}if(!name)return'';return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj));};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==='[object Array]';};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i));}return res;}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key);}return res;};},{}],49:[function(require,module,exports){'use strict';exports.decode=exports.parse=require('./decode');exports.encode=exports.stringify=require('./encode');},{"./decode":47,"./encode":48}],50:[function(require,module,exports){var racer=require('racer');var Socket=require('./socket');var CLIENT_OPTIONS=JSON.parse('{"base":"/channel","reconnect":true,"browserChannelOnly":false,"timeout":10000,"timeoutIncrement":10000}');racer.Model.prototype._createSocket=function(bundle){return new Socket(CLIENT_OPTIONS);};},{"./socket":51,"racer":"racer"}],51:[function(require,module,exports){module.exports=Socket;var BCSocket=require('browserchannel/dist/bcsocket-uncompressed').BCSocket;function Socket(options){this._options=options;this._messageQueue=[];this._connectedOnce=false;this._attemptNum=0;this._url=getWebSocketURL(options);if(supportWebSockets()&&!options.browserChannelOnly){this._createWebSocket();}else{this._createBrowserChannel();}}Socket.prototype._createWebSocket=function(){this._type='websocket';this._socket=new WebSocket(this._url);this.open=this._createWebSocket.bind(this);this._syncState();this._socket.onmessage=this._ws_onmessage.bind(this);this._socket.onopen=this._ws_onopen.bind(this);this._socket.onclose=this._ws_onclose.bind(this);};Socket.prototype._createBrowserChannel=function(){this._type='browserchannel';this._socket=BCSocket(this._options.base,this._options);this.open=this._createBrowserChannel.bind(this);this._syncState();this._socket.onmessage=this._bc_onmessage.bind(this);this._socket.onopen=this._bc_onopen.bind(this);this._socket.onclose=this._bc_onclose.bind(this);};Socket.prototype._ws_onmessage=function(message){this._syncState();message.data=JSON.parse(message.data);this.onmessage&&this.onmessage(message);};Socket.prototype._ws_onopen=function(event){this._attemptNum=0;this._connectedOnce=true;this._syncState();this._flushQueue();this.onopen&&this.onopen(event);};Socket.prototype._ws_onclose=function(event){this._syncState();console.log('WebSocket: connection is broken',event);this.onclose&&this.onclose(event);if(!this._connectedOnce){return this._createBrowserChannel();}var socket=this;if(this._options.reconnect&&!event.wasClean){setTimeout(function(){if(socket.readyState===socket.CLOSED){socket._createWebSocket();}},this._getTimeout());}this._attemptNum++;};Socket.prototype._getTimeout=function(){var base=this._options.timeout;var increment=this._options.timeoutIncrement*this._attemptNum;var maxTimeout=base+increment;return getRandom(maxTimeout/3,maxTimeout);};Socket.prototype._bc_onmessage=function(data){this._syncState();this.onmessage&&this.onmessage(data);};Socket.prototype._bc_onopen=function(event){this._syncState();this.onopen&&this.onopen(event);};Socket.prototype._bc_onclose=function(event){this._syncState();this.onclose&&this.onclose(event);};Socket.prototype._flushQueue=function(){while(this._messageQueue.length!==0){var data=this._messageQueue.shift();this._send(data);}};Socket.prototype._send=function(data){if(this._type==='websocket'&&typeof data!=='string')data=JSON.stringify(data);this._socket.send(data);};Socket.prototype.send=function(data){if(this._type==='websocket'){if(this._socket.readyState===WebSocket.OPEN&&this._messageQueue.length===0){this._send(data);}else{this._messageQueue.push(data);}}else{this._send(data);}};Socket.prototype.close=function(){this._socket.close();};Socket.prototype._syncState=function(){this.readyState=this._socket.readyState;};Socket.prototype.reconnect=function(){if(this._type==='websocket'&&this.readyState===this.CLOSED){this._createWebSocket();}};// ShareJS constants
Socket.prototype.canSendWhileConnecting=true;Socket.prototype.canSendJSON=true;// WebSocket constants
Socket.prototype.CONNECTING=0;Socket.prototype.OPEN=1;Socket.prototype.CLOSING=2;Socket.prototype.CLOSED=3;function getRandom(min,max){return Math.random()*(max-min)+min;}function supportWebSockets(){// The condition is from Modernizr
// https://github.com/Modernizr/Modernizr/blob/master/feature-detects/websockets.js#L28
return'WebSocket'in window&&window.WebSocket.CLOSING===2;}function getWebSocketURL(options){var port;if(window.location&&window.location.port){port=":"+window.location.port;}var srvPort=options.srvPort;var srvSecurePort=options.srvSecurePort;var srvHost=options.srvHost||window.location.hostname;var srvProtocol=options.srvProtocol||window.location.protocol;var protocol=srvProtocol==='https:'?'wss:':'ws:';if(protocol==='ws:'&&srvPort){port=":"+srvPort;}else if(protocol==='wss:'&&srvSecurePort){port=":"+srvSecurePort;}return protocol+'//'+srvHost+(port||"")+options.base;}// Maybe need to use reconnection timing algorithm from
// http://blog.johnryding.com/post/78544969349/how-to-reconnect-web-sockets-in-a-realtime-web-app
},{"browserchannel/dist/bcsocket-uncompressed":3}],52:[function(require,module,exports){module.exports=CollectionCounter;function CollectionCounter(){this.reset();}CollectionCounter.prototype.reset=function(){this.collections={};};CollectionCounter.prototype.get=function(collectionName,id){var collection=this.collections[collectionName];return collection&&collection[id];};CollectionCounter.prototype.increment=function(collectionName,id){var collection=this.collections[collectionName]||(this.collections[collectionName]={});var count=(collection[id]||0)+1;collection[id]=count;return count;};CollectionCounter.prototype.decrement=function(collectionName,id){var collection=this.collections[collectionName];var count=collection&&collection[id];if(count==null)return;if(count>1){count--;collection[id]=count;return count;}delete collection[id];// Check if the collection still has any keys
// eslint-disable-next-line no-unused-vars
for(var key in collection){return 0;}delete this.collections[collectionName];return 0;};CollectionCounter.prototype.toJSON=function(){// Check to see if we have any keys
// eslint-disable-next-line no-unused-vars
for(var key in this.collections){return this.collections;}return;};},{}],53:[function(require,module,exports){module.exports=Doc;function Doc(model,collectionName,id){this.collectionName=collectionName;this.id=id;this.collectionData=model&&model.data[collectionName];}Doc.prototype.path=function(segments){var path=this.collectionName+'.'+this.id;if(segments&&segments.length)path+='.'+segments.join('.');return path;};Doc.prototype._errorMessage=function(description,segments,value){return description+' at '+this.path(segments)+': '+JSON.stringify(value,null,2);};},{}],54:[function(require,module,exports){var Doc=require('./Doc');var util=require('../util');module.exports=LocalDoc;function LocalDoc(model,collectionName,id,data){Doc.call(this,model,collectionName,id);this.data=data;this._updateCollectionData();}LocalDoc.prototype=new Doc();LocalDoc.prototype._updateCollectionData=function(){this.collectionData[this.id]=this.data;};LocalDoc.prototype.create=function(value,cb){if(this.data!==undefined){var message=this._errorMessage('create on local document with data',null,this.data);var err=new Error(message);return cb(err);}this.data=value;this._updateCollectionData();cb();};LocalDoc.prototype.set=function(segments,value,cb){function set(node,key){var previous=node[key];node[key]=value;return previous;}return this._apply(segments,set,cb);};LocalDoc.prototype.del=function(segments,cb){// Don't do anything if the value is already undefined, since
// apply creates objects as it traverses, and the del method
// should not create anything
var previous=this.get(segments);if(previous===undefined){cb();return;}function del(node,key){delete node[key];return previous;}return this._apply(segments,del,cb);};LocalDoc.prototype.increment=function(segments,byNumber,cb){var self=this;function validate(value){if(typeof value==='number'||value==null)return;return new TypeError(self._errorMessage('increment on non-number',segments,value));}function increment(node,key){var value=(node[key]||0)+byNumber;node[key]=value;return value;}return this._validatedApply(segments,validate,increment,cb);};LocalDoc.prototype.push=function(segments,value,cb){function push(arr){return arr.push(value);}return this._arrayApply(segments,push,cb);};LocalDoc.prototype.unshift=function(segments,value,cb){function unshift(arr){return arr.unshift(value);}return this._arrayApply(segments,unshift,cb);};LocalDoc.prototype.insert=function(segments,index,values,cb){function insert(arr){arr.splice.apply(arr,[index,0].concat(values));return arr.length;}return this._arrayApply(segments,insert,cb);};LocalDoc.prototype.pop=function(segments,cb){function pop(arr){return arr.pop();}return this._arrayApply(segments,pop,cb);};LocalDoc.prototype.shift=function(segments,cb){function shift(arr){return arr.shift();}return this._arrayApply(segments,shift,cb);};LocalDoc.prototype.remove=function(segments,index,howMany,cb){function remove(arr){return arr.splice(index,howMany);}return this._arrayApply(segments,remove,cb);};LocalDoc.prototype.move=function(segments,from,to,howMany,cb){function move(arr){// Remove from old location
var values=arr.splice(from,howMany);// Insert in new location
arr.splice.apply(arr,[to,0].concat(values));return values;}return this._arrayApply(segments,move,cb);};LocalDoc.prototype.stringInsert=function(segments,index,value,cb){var self=this;function validate(value){if(typeof value==='string'||value==null)return;return new TypeError(self._errorMessage('stringInsert on non-string',segments,value));}function stringInsert(node,key){var previous=node[key];if(previous==null){node[key]=value;return previous;}node[key]=previous.slice(0,index)+value+previous.slice(index);return previous;}return this._validatedApply(segments,validate,stringInsert,cb);};LocalDoc.prototype.stringRemove=function(segments,index,howMany,cb){var self=this;function validate(value){if(typeof value==='string'||value==null)return;return new TypeError(self._errorMessage('stringRemove on non-string',segments,value));}function stringRemove(node,key){var previous=node[key];if(previous==null)return previous;if(index<0)index+=previous.length;node[key]=previous.slice(0,index)+previous.slice(index+howMany);return previous;}return this._validatedApply(segments,validate,stringRemove,cb);};LocalDoc.prototype.get=function(segments){return util.lookup(segments,this.data);};/**
 * @param {Array} segments is the array representing a path
 * @param {Function} fn(node, key) applies a mutation on node[key]
 * @return {Object} returns the return value of fn(node, key)
 */LocalDoc.prototype._createImplied=function(segments,fn){var node=this;var key='data';var i=0;var nextKey=segments[i++];while(nextKey!=null){// Get or create implied object or array
node=node[key]||(node[key]=/^\d+$/.test(nextKey)?[]:{});key=nextKey;nextKey=segments[i++];}return fn(node,key);};LocalDoc.prototype._apply=function(segments,fn,cb){var out=this._createImplied(segments,fn);this._updateCollectionData();cb();return out;};LocalDoc.prototype._validatedApply=function(segments,validate,fn,cb){var out=this._createImplied(segments,function(node,key){var err=validate(node[key]);if(err)return cb(err);return fn(node,key);});this._updateCollectionData();cb();return out;};LocalDoc.prototype._arrayApply=function(segments,fn,cb){// Lookup a pointer to the property or nested property &
// return the current value or create a new array
var arr=this._createImplied(segments,nodeCreateArray);if(!Array.isArray(arr)){var message=this._errorMessage(fn.name+' on non-array',segments,arr);var err=new TypeError(message);return cb(err);}var out=fn(arr);this._updateCollectionData();cb();return out;};function nodeCreateArray(node,key){var node=node[key]||(node[key]=[]);return node;}},{"../util":74,"./Doc":53}],55:[function(require,module,exports){var uuid=require('uuid');Model.INITS=[];module.exports=Model;function Model(options){this.root=this;var inits=Model.INITS;if(!options)options={};this.debug=options.debug||{};for(var i=0;i<inits.length;i++){inits[i](this,options);}}Model.prototype.id=function(){return uuid.v4();};Model.prototype._child=function(){return new ChildModel(this);};Model.ChildModel=ChildModel;function ChildModel(model){// Shared properties should be accessed via the root. This makes inheritance
// cheap and easily extensible
this.root=model.root;// EventEmitter methods access these properties directly, so they must be
// inherited manually instead of via the root
this._events=model._events;this._maxListeners=model._maxListeners;// Properties specific to a child instance
this._context=model._context;this._at=model._at;this._pass=model._pass;this._silent=model._silent;this._eventContext=model._eventContext;this._preventCompose=model._preventCompose;}ChildModel.prototype=new Model();},{"uuid":99}],56:[function(require,module,exports){(function(process){var util=require('../util');var Model=require('./Model');var defaultType=require('sharedb/lib/client').types.defaultType;module.exports=Query;Model.INITS.push(function(model){model.root._queries=new Queries();});Model.prototype.query=function(collectionName,expression,options){// DEPRECATED: Passing in a string as the third argument specifies the db
// option for backward compatibility
if(typeof options==='string'){options={db:options};}return this._getOrCreateQuery(collectionName,expression,options,Query);};/**
 * If an existing query is present with the same `collectionName`, `expression`,
 * and `options`, then returns the existing query; otherwise, constructs and
 * returns a new query using `QueryConstructor`.
 *
 * @param {string} collectionName
 * @param {*} expression
 * @param {*} options
 * @param {new (model: Model, collectionName: string, expression: any, options: any) => Query} QueryConstructor -
 *   constructor function for a Query, to create one if not already present on this model
 */Model.prototype._getOrCreateQuery=function(collectionName,expression,options,QueryConstructor){expression=this.sanitizeQuery(expression);var query=this.root._queries.get(collectionName,expression,options);if(query)return query;query=new QueryConstructor(this,collectionName,expression,options);this.root._queries.add(query);return query;};// This method replaces undefined in query objects with null, because
// undefined properties are removed in JSON stringify. This can be dangerous
// in queries, where presenece of a property may indicate that it should be a
// filter and absence means that all values are accepted. We aren't checking
// for cycles, which aren't allowed in JSON, so this could throw a max call
// stack error
Model.prototype.sanitizeQuery=function(expression){if(expression&&_typeof(expression)==='object'){for(var key in expression){if(expression.hasOwnProperty(key)){var value=expression[key];if(value===undefined){expression[key]=null;}else{this.sanitizeQuery(value);}}}}return expression;};// Called during initialization of the bundle on page load.
Model.prototype._initQueries=function(items){var queries=this.root._queries;for(var i=0;i<items.length;i++){var item=items[i];var counts=item[0];var collectionName=item[1];var expression=item[2];var results=item[3]||[];var options=item[4];var extra=item[5];var query=this.root._queries.get(collectionName,expression,options);if(!query){query=new Query(this,collectionName,expression,options);queries.add(query);}query._setExtra(extra);var ids=[];for(var resultIndex=0;resultIndex<results.length;resultIndex++){var result=results[resultIndex];if(typeof result==='string'){ids.push(result);continue;}var data=result[0];var v=result[1];var id=result[2]||data.id;var type=result[3];ids.push(id);var snapshot={data:data,v:v,type:type};this.getOrCreateDoc(collectionName,id,snapshot);}query._addMapIds(ids);this._set(query.idsSegments,ids);for(var countIndex=0;countIndex<counts.length;countIndex++){var count=counts[countIndex];var subscribed=count[0]||0;var fetched=count[1]||0;var contextId=count[2];if(contextId)query.model.setContext(contextId);while(subscribed--){query.subscribe();}query.fetchCount+=fetched;while(fetched--){query.model._context.fetchQuery(query);}}}};function Queries(){// Map is a flattened map of queries by hash. Currently used in contexts
this.map={};// Collections is a nested map of queries by collection then hash
this.collections={};}Queries.prototype.add=function(query){this.map[query.hash]=query;var collection=this.collections[query.collectionName]||(this.collections[query.collectionName]={});collection[query.hash]=query;};Queries.prototype.remove=function(query){delete this.map[query.hash];var collection=this.collections[query.collectionName];if(!collection)return;delete collection[query.hash];// Check if the collection still has any keys
// eslint-disable-next-line no-unused-vars
for(var key in collection){return;}delete this.collections[query.collectionName];};Queries.prototype.get=function(collectionName,expression,options){var hash=queryHash(collectionName,expression,options);return this.map[hash];};Queries.prototype.toJSON=function(){var out=[];for(var hash in this.map){var query=this.map[hash];if(query.subscribeCount||query.fetchCount){out.push(query.serialize());}}return out;};function Query(model,collectionName,expression,options){this.model=model.pass({$query:this});this.collectionName=collectionName;this.expression=expression;this.options=options;this.hash=queryHash(collectionName,expression,options);this.segments=['$queries',this.hash];this.idsSegments=['$queries',this.hash,'ids'];this.extraSegments=['$queries',this.hash,'extra'];this._pendingSubscribeCallbacks=[];// These are used to help cleanup appropriately when calling unsubscribe and
// unfetch. A query won't be fully cleaned up until unfetch and unsubscribe
// are called the same number of times that fetch and subscribe were called.
this.subscribeCount=0;this.fetchCount=0;this.created=false;this.shareQuery=null;// idMap is checked in maybeUnload to see if the query is currently holding
// a reference to an id in its results set. This map is duplicative of the
// actual results id list stored in the model, but we are maintaining it,
// because otherwise maybeUnload would be looping through the entire results
// set of each query on the same collection for every doc checked
//
// Map of id -> count of ids
this.idMap={};}Query.prototype.create=function(){this.created=true;this.model.root._queries.add(this);};Query.prototype.destroy=function(){var ids=this.getIds();this.created=false;if(this.shareQuery){this.shareQuery.destroy();this.shareQuery=null;}this.model.root._queries.remove(this);this.idMap={};this.model._del(this.segments);this._maybeUnloadDocs(ids);};Query.prototype.fetch=function(cb){cb=this.model.wrapCallback(cb);this.model._context.fetchQuery(this);this.fetchCount++;if(!this.created)this.create();var query=this;function fetchCb(err,results,extra){if(err)return cb(err);query._setExtra(extra);query._setResults(results);cb();}this.model.root.connection.createFetchQuery(this.collectionName,this.expression,this.options,fetchCb);return this;};Query.prototype.subscribe=function(cb){cb=this.model.wrapCallback(cb);this.model._context.subscribeQuery(this);if(this.subscribeCount++){var query=this;process.nextTick(function(){var data=query.model._get(query.segments);if(data){cb();}else{query._pendingSubscribeCallbacks.push(cb);}});return this;}if(!this.created)this.create();var options=this.options?util.copy(this.options):{};options.results=this._getShareResults();// When doing server-side rendering, we actually do a fetch the first time
// that subscribe is called, but keep track of the state as if subscribe
// were called for proper initialization in the client
if(this.model.root.fetchOnly){this._shareFetchedSubscribe(options,cb);}else{this._shareSubscribe(options,cb);}return this;};Query.prototype._subscribeCb=function(cb){var query=this;return function subscribeCb(err,results,extra){if(err)return query._flushSubscribeCallbacks(err,cb);query._setExtra(extra);query._setResults(results);query._flushSubscribeCallbacks(null,cb);};};Query.prototype._shareFetchedSubscribe=function(options,cb){this.model.root.connection.createFetchQuery(this.collectionName,this.expression,options,this._subscribeCb(cb));};Query.prototype._shareSubscribe=function(options,cb){var query=this;// Sanity check, though this shouldn't happen
if(this.shareQuery){this.shareQuery.destroy();}this.shareQuery=this.model.root.connection.createSubscribeQuery(this.collectionName,this.expression,options,this._subscribeCb(cb));this.shareQuery.on('insert',function(shareDocs,index){var ids=resultsIds(shareDocs);query._addMapIds(ids);query.model._insert(query.idsSegments,index,ids);});this.shareQuery.on('remove',function(shareDocs,index){var ids=resultsIds(shareDocs);query._removeMapIds(ids);query.model._remove(query.idsSegments,index,shareDocs.length);});this.shareQuery.on('move',function(shareDocs,from,to){query.model._move(query.idsSegments,from,to,shareDocs.length);});this.shareQuery.on('extra',function(extra){query.model._setDiffDeep(query.extraSegments,extra);});this.shareQuery.on('error',function(err){query.model._emitError(err,query.hash);});};Query.prototype._removeMapIds=function(ids){for(var i=ids.length;i--;){var id=ids[i];if(this.idMap[id]>1){this.idMap[id]--;}else{delete this.idMap[id];}}// Technically this isn't quite right and we might not wait the full unload
// delay if someone else calls maybeUnload for the same doc id. However,
// it is a lot easier to implement than delaying the removal until later and
// dealing with adds that might happen in the meantime. This will probably
// work to avoid thrashing subscribe/unsubscribe in expected cases
if(this.model.root.unloadDelay){var query=this;setTimeout(function(){query._maybeUnloadDocs(ids);},this.model.root.unloadDelay);return;}this._maybeUnloadDocs(ids);};Query.prototype._addMapIds=function(ids){for(var i=ids.length;i--;){var id=ids[i];this.idMap[id]=(this.idMap[id]||0)+1;}};Query.prototype._diffMapIds=function(ids){var addedIds=[];var removedIds=[];var newMap={};for(var i=ids.length;i--;){var id=ids[i];newMap[id]=true;if(this.idMap[id])continue;addedIds.push(id);}for(var id in this.idMap){if(newMap[id])continue;removedIds.push(id);}if(addedIds.length)this._addMapIds(addedIds);if(removedIds.length)this._removeMapIds(removedIds);};Query.prototype._setExtra=function(extra){if(extra===undefined)return;this.model._setDiffDeep(this.extraSegments,extra);};Query.prototype._setResults=function(results){var ids=resultsIds(results);this._setResultIds(ids);};Query.prototype._setResultIds=function(ids){this._diffMapIds(ids);this.model._setArrayDiff(this.idsSegments,ids);};Query.prototype._maybeUnloadDocs=function(ids){for(var i=0;i<ids.length;i++){var id=ids[i];this.model._maybeUnloadDoc(this.collectionName,id);}};// Flushes `_pendingSubscribeCallbacks`, calling each callback in the array,
// with an optional error to pass into each. `_pendingSubscribeCallbacks` will
// be empty after this runs.
Query.prototype._flushSubscribeCallbacks=function(err,cb){cb(err);var pendingCallback;while(pendingCallback=this._pendingSubscribeCallbacks.shift()){pendingCallback(err);}};Query.prototype.unfetch=function(cb){cb=this.model.wrapCallback(cb);this.model._context.unfetchQuery(this);// No effect if the query is not currently fetched
if(!this.fetchCount){cb();return this;}var query=this;if(this.model.root.unloadDelay){setTimeout(finishUnfetchQuery,this.model.root.unloadDelay);}else{finishUnfetchQuery();}function finishUnfetchQuery(){var count=--query.fetchCount;if(count)return cb(null,count);// Cleanup when no fetches or subscribes remain
if(!query.subscribeCount)query.destroy();cb(null,0);}return this;};Query.prototype.unsubscribe=function(cb){cb=this.model.wrapCallback(cb);this.model._context.unsubscribeQuery(this);// No effect if the query is not currently subscribed
if(!this.subscribeCount){cb();return this;}var query=this;if(this.model.root.unloadDelay){setTimeout(finishUnsubscribeQuery,this.model.root.unloadDelay);}else{finishUnsubscribeQuery();}function finishUnsubscribeQuery(){var count=--query.subscribeCount;if(count)return cb(null,count);if(query.shareQuery){query.shareQuery.destroy();query.shareQuery=null;}unsubscribeQueryCallback();}function unsubscribeQueryCallback(err){if(err)return cb(err);// Cleanup when no fetches or subscribes remain
if(!query.fetchCount)query.destroy();cb(null,0);}return this;};Query.prototype._getShareResults=function(){var ids=this.model._get(this.idsSegments);if(!ids)return;var collection=this.model.getCollection(this.collectionName);if(!collection)return;var results=[];for(var i=0;i<ids.length;i++){var id=ids[i];var doc=collection.docs[id];results.push(doc&&doc.shareDoc);}return results;};Query.prototype.get=function(){var results=[];var data=this.model._get(this.segments);if(!data){console.warn('You must fetch or subscribe to a query before getting its results.');return results;}var ids=data.ids;if(!ids)return results;var collection=this.model.getCollection(this.collectionName);for(var i=0,l=ids.length;i<l;i++){var id=ids[i];var doc=collection&&collection.docs[id];results.push(doc&&doc.get());}return results;};Query.prototype.getIds=function(){return this.model._get(this.idsSegments)||[];};Query.prototype.getExtra=function(){return this.model._get(this.extraSegments);};Query.prototype.ref=function(from){var idsPath=this.idsSegments.join('.');return this.model.refList(from,this.collectionName,idsPath);};Query.prototype.refIds=function(from){var idsPath=this.idsSegments.join('.');return this.model.root.ref(from,idsPath);};Query.prototype.refExtra=function(from,relPath){var extraPath=this.extraSegments.join('.');if(relPath)extraPath+='.'+relPath;return this.model.root.ref(from,extraPath);};Query.prototype.serialize=function(){var ids=this.getIds();var collection=this.model.getCollection(this.collectionName);var results;if(collection){results=[];for(var i=0;i<ids.length;i++){var id=ids[i];var doc=collection.docs[id];if(doc){delete collection.docs[id];var data=doc.shareDoc.data;var result=[data,doc.shareDoc.version];if(!data||data.id!==id){result[2]=id;}if(doc.shareDoc.type!==defaultType){result[3]=doc.shareDoc.type&&doc.shareDoc.type.name;}results.push(result);}else{results.push(id);}}}var counts=[];var contexts=this.model.root._contexts;for(var key in contexts){var context=contexts[key];var subscribed=context.subscribedQueries[this.hash]||0;var fetched=context.fetchedQueries[this.hash]||0;if(subscribed||fetched){if(key!=='root'){counts.push([subscribed,fetched,key]);}else if(fetched){counts.push([subscribed,fetched]);}else{counts.push([subscribed]);}}}var serialized=[counts,this.collectionName,this.expression,results,this.options,this.getExtra()];while(serialized[serialized.length-1]==null){serialized.pop();}return serialized;};function queryHash(collectionName,expression,options){var args=[collectionName,expression,options];return JSON.stringify(args).replace(/\./g,'|');}function resultsIds(results){var ids=[];for(var i=0;i<results.length;i++){var shareDoc=results[i];ids.push(shareDoc.id);}return ids;}}).call(this,require('_process'));},{"../util":74,"./Model":55,"_process":40,"sharedb/lib/client":79}],57:[function(require,module,exports){/**
 * RemoteDoc adapts the ShareJS operation protocol to Racer's mutator
 * interface.
 *
 * 1. It maps Racer's mutator methods to outgoing ShareJS operations.
 * 2. It maps incoming ShareJS operations to Racer events.
 */var Doc=require('./Doc');var util=require('../util');module.exports=RemoteDoc;function RemoteDoc(model,collectionName,id,snapshot,collection){// This is a bit messy, but we have to immediately register this doc on the
// collection that added it, so that when we create the shareDoc and the
// connection emits the 'doc' event, we'll find this doc instead of
// creating a new one
if(collection)collection.docs[id]=this;Doc.call(this,model,collectionName,id);this.model=model.pass({$remote:true});this.debugMutations=model.root.debug.remoteMutations;// Get or create the Share document. Note that we must have already added
// this doc to the collection to avoid creating a duplicate doc
this.shareDoc=model.root.connection.get(collectionName,id);this.shareDoc.ingestSnapshot(snapshot);this._initShareDoc();}RemoteDoc.prototype=new Doc();RemoteDoc.prototype._initShareDoc=function(){var doc=this;var model=this.model;var collectionName=this.collectionName;var id=this.id;var shareDoc=this.shareDoc;// Override submitOp to disable all writes and perform a dry-run
if(model.root.debug.disableSubmit){shareDoc.submitOp=function(){};shareDoc.create=function(){};shareDoc.del=function(){};}// Subscribe to doc events
shareDoc.on('op',function(op,isLocal){// Don't emit on local operations, since they are emitted in the mutator
if(isLocal)return;doc._updateCollectionData();doc._onOp(op);});shareDoc.on('del',function(previous,isLocal){// Calling the shareDoc.del method does not emit an operation event,
// so we create the appropriate event here.
if(isLocal)return;delete doc.collectionData[id];model.emit('change',[collectionName,id],[undefined,previous,model._pass]);});shareDoc.on('create',function(isLocal){// Local creates should not emit an event, since they only happen
// implicitly as a result of another mutation, and that operation will
// emit the appropriate event. Remote creates can set the snapshot data
// without emitting an operation event, so an event needs to be emitted
// for them.
if(isLocal)return;doc._updateCollectionData();var value=shareDoc.data;model.emit('change',[collectionName,id],[value,undefined,model._pass]);});shareDoc.on('error',function(err){model._emitError(err,collectionName+'.'+id);});shareDoc.on('load',function(){doc._updateCollectionData();var value=shareDoc.data;// If we subscribe to an uncreated document, no need to emit 'load' event
if(value===undefined)return;model.emit('load',[collectionName,id],[value,model._pass]);});this._updateCollectionData();};RemoteDoc.prototype._updateCollectionData=function(){var data=this.shareDoc.data;if(_typeof(data)==='object'&&!Array.isArray(data)&&data!==null){data.id=this.id;}this.collectionData[this.id]=data;};RemoteDoc.prototype.create=function(value,cb){if(this.debugMutations){console.log('RemoteDoc create',this.path(),value);}// We copy the snapshot data at time of create to prevent the id added
// outside of ShareJS from getting stored in the data
var data=util.deepCopy(value);if(data)delete data.id;this.shareDoc.create(data,cb);// The id value will get added to the data that was passed in
this.shareDoc.data=value;this._updateCollectionData();this.model._context.createDoc(this.collectionName,this.id);return;};RemoteDoc.prototype.set=function(segments,value,cb){if(this.debugMutations){console.log('RemoteDoc set',this.path(segments),value);}var previous=this._createImplied(segments);var lastSegment=segments[segments.length-1];if(previous instanceof ImpliedOp){previous.value[lastSegment]=value;this.shareDoc.submitOp(previous.op,cb);this._updateCollectionData();return;}var op=util.isArrayIndex(lastSegment)?[new ListReplaceOp(segments.slice(0,-1),lastSegment,previous,value)]:[new ObjectReplaceOp(segments,previous,value)];this.shareDoc.submitOp(op,cb);this._updateCollectionData();return previous;};RemoteDoc.prototype.del=function(segments,cb){if(this.debugMutations){console.log('RemoteDoc del',this.path(segments));}if(segments.length===0){var previous=this.get();this.shareDoc.del(cb);delete this.collectionData[this.id];return previous;}// Don't do anything if the value is already undefined, since
// the del method should not create anything
var previous=this.get(segments);if(previous===undefined){cb();return;}var op=[new ObjectDeleteOp(segments,previous)];this.shareDoc.submitOp(op,cb);this._updateCollectionData();return previous;};RemoteDoc.prototype.increment=function(segments,byNumber,cb){if(this.debugMutations){console.log('RemoteDoc increment',this.path(segments),byNumber);}var previous=this._createImplied(segments);if(previous instanceof ImpliedOp){var lastSegment=segments[segments.length-1];previous.value[lastSegment]=byNumber;this.shareDoc.submitOp(previous.op,cb);this._updateCollectionData();return byNumber;}if(previous==null){var lastSegment=segments[segments.length-1];var op=util.isArrayIndex(lastSegment)?[new ListInsertOp(segments.slice(0,-1),lastSegment,byNumber)]:[new ObjectInsertOp(segments,byNumber)];this.shareDoc.submitOp(op,cb);this._updateCollectionData();return byNumber;}var op=[new IncrementOp(segments,byNumber)];this.shareDoc.submitOp(op,cb);this._updateCollectionData();return previous+byNumber;};RemoteDoc.prototype.push=function(segments,value,cb){if(this.debugMutations){console.log('RemoteDoc push',this.path(segments),value);}var shareDoc=this.shareDoc;function push(arr,fnCb){var op=[new ListInsertOp(segments,arr.length,value)];shareDoc.submitOp(op,fnCb);return arr.length;}return this._arrayApply(segments,push,cb);};RemoteDoc.prototype.unshift=function(segments,value,cb){if(this.debugMutations){console.log('RemoteDoc unshift',this.path(segments),value);}var shareDoc=this.shareDoc;function unshift(arr,fnCb){var op=[new ListInsertOp(segments,0,value)];shareDoc.submitOp(op,fnCb);return arr.length;}return this._arrayApply(segments,unshift,cb);};RemoteDoc.prototype.insert=function(segments,index,values,cb){if(this.debugMutations){console.log('RemoteDoc insert',this.path(segments),index,values);}var shareDoc=this.shareDoc;function insert(arr,fnCb){var op=createInsertOp(segments,index,values);shareDoc.submitOp(op,fnCb);return arr.length;}return this._arrayApply(segments,insert,cb);};function createInsertOp(segments,index,values){if(!Array.isArray(values)){return[new ListInsertOp(segments,index,values)];}var op=[];for(var i=0,len=values.length;i<len;i++){op.push(new ListInsertOp(segments,index++,values[i]));}return op;}RemoteDoc.prototype.pop=function(segments,cb){if(this.debugMutations){console.log('RemoteDoc pop',this.path(segments));}var shareDoc=this.shareDoc;function pop(arr,fnCb){var index=arr.length-1;var value=arr[index];var op=[new ListRemoveOp(segments,index,value)];shareDoc.submitOp(op,fnCb);return value;}return this._arrayApply(segments,pop,cb);};RemoteDoc.prototype.shift=function(segments,cb){if(this.debugMutations){console.log('RemoteDoc shift',this.path(segments));}var shareDoc=this.shareDoc;function shift(arr,fnCb){var value=arr[0];var op=[new ListRemoveOp(segments,0,value)];shareDoc.submitOp(op,fnCb);return value;}return this._arrayApply(segments,shift,cb);};RemoteDoc.prototype.remove=function(segments,index,howMany,cb){if(this.debugMutations){console.log('RemoteDoc remove',this.path(segments),index,howMany);}var shareDoc=this.shareDoc;function remove(arr,fnCb){var values=arr.slice(index,index+howMany);var op=[];for(var i=0,len=values.length;i<len;i++){op.push(new ListRemoveOp(segments,index,values[i]));}shareDoc.submitOp(op,fnCb);return values;}return this._arrayApply(segments,remove,cb);};RemoteDoc.prototype.move=function(segments,from,to,howMany,cb){if(this.debugMutations){console.log('RemoteDoc move',this.path(segments),from,to,howMany);}var shareDoc=this.shareDoc;function move(arr,fnCb){// Get the return value
var values=arr.slice(from,from+howMany);// Build an op that moves each item individually
var op=[];for(var i=0;i<howMany;i++){op.push(new ListMoveOp(segments,from<to?from:from+howMany-1,from<to?to+howMany-1:to));}shareDoc.submitOp(op,fnCb);return values;}return this._arrayApply(segments,move,cb);};RemoteDoc.prototype.stringInsert=function(segments,index,value,cb){if(this.debugMutations){console.log('RemoteDoc stringInsert',this.path(segments),index,value);}var previous=this._createImplied(segments);if(previous instanceof ImpliedOp){var lastSegment=segments[segments.length-1];previous.value[lastSegment]=value;this.shareDoc.submitOp(previous.op,cb);this._updateCollectionData();return;}if(previous==null){var lastSegment=segments[segments.length-1];var op=util.isArrayIndex(lastSegment)?[new ListInsertOp(segments.slice(0,-1),lastSegment,value)]:[new ObjectInsertOp(segments,value)];this.shareDoc.submitOp(op,cb);this._updateCollectionData();return previous;}var op=[new StringInsertOp(segments,index,value)];this.shareDoc.submitOp(op,cb);this._updateCollectionData();return previous;};RemoteDoc.prototype.stringRemove=function(segments,index,howMany,cb){if(this.debugMutations){console.log('RemoteDoc stringRemove',this.path(segments),index,howMany);}var previous=this._createImplied(segments);if(previous instanceof ImpliedOp)return;if(previous==null)return previous;var removed=previous.slice(index,index+howMany);var op=[new StringRemoveOp(segments,index,removed)];this.shareDoc.submitOp(op,cb);this._updateCollectionData();return previous;};RemoteDoc.prototype.subtypeSubmit=function(segments,subtype,subtypeOp,cb){if(this.debugMutations){console.log('RemoteDoc subtypeSubmit',this.path(segments),subtype,subtypeOp);}var previous=this._createImplied(segments);if(previous instanceof ImpliedOp){this.shareDoc.submitOp(previous.op);previous=undefined;}var op=new SubtypeOp(segments,subtype,subtypeOp);this.shareDoc.submitOp(op,cb);this._updateCollectionData();return previous;};RemoteDoc.prototype.get=function(segments){return util.lookup(segments,this.shareDoc.data);};RemoteDoc.prototype._createImplied=function(segments){if(!this.shareDoc.type){throw new Error('Mutation on uncreated remote document');}var parent=this.shareDoc;var key='data';var node=parent[key];var i=0;var nextKey=segments[i++];var op,value;while(nextKey!=null){if(!node){if(op){value=value[key]=util.isArrayIndex(nextKey)?[]:{};}else{value=util.isArrayIndex(nextKey)?[]:{};if(Array.isArray(parent)){if(key>=parent.length){op=new ListInsertOp(segments.slice(0,i-2),key,value);}else{op=new ListReplaceOp(segments.slice(0,i-2),key,node,value);}}else{op=new ObjectInsertOp(segments.slice(0,i-1),value);}}node=value;}parent=node;key=nextKey;node=parent[key];nextKey=segments[i++];}if(op)return new ImpliedOp(op,value);return node;};function ImpliedOp(op,value){this.op=op;this.value=value;}RemoteDoc.prototype._arrayApply=function(segments,fn,cb){var arr=this._createImplied(segments);if(arr instanceof ImpliedOp){this.shareDoc.submitOp(arr.op);arr=this.get(segments);}if(arr==null){var lastSegment=segments[segments.length-1];var op=util.isArrayIndex(lastSegment)?[new ListInsertOp(segments.slice(0,-1),lastSegment,[])]:[new ObjectInsertOp(segments,[])];this.shareDoc.submitOp(op);arr=this.get(segments);}if(!Array.isArray(arr)){var message=this._errorMessage(fn.name+' on non-array',segments,arr);var err=new TypeError(message);return cb(err);}var out=fn(arr,cb);this._updateCollectionData();return out;};RemoteDoc.prototype._onOp=function(op){var item;if(op.length===1){// ShareDB docs shatter json0 ops into single components during apply
item=op[0];}else if(op.length===0){// Ignore no-ops
return;}else{try{op=JSON.stringify(op);}catch(err){}throw new Error('Received op with multiple components from ShareDB '+op);}var segments=[this.collectionName,this.id].concat(item.p);var model=this.model;// ObjectReplaceOp, ObjectInsertOp, or ObjectDeleteOp
if(defined(item.oi)||defined(item.od)){var value=item.oi;var previous=item.od;model.emit('change',segments,[value,previous,model._pass]);// ListReplaceOp
}else if(defined(item.li)&&defined(item.ld)){var value=item.li;var previous=item.ld;model.emit('change',segments,[value,previous,model._pass]);// ListInsertOp
}else if(defined(item.li)){var index=segments[segments.length-1];var values=[item.li];model.emit('insert',segments.slice(0,-1),[index,values,model._pass]);// ListRemoveOp
}else if(defined(item.ld)){var index=segments[segments.length-1];var removed=[item.ld];model.emit('remove',segments.slice(0,-1),[index,removed,model._pass]);// ListMoveOp
}else if(defined(item.lm)){var from=segments[segments.length-1];var to=item.lm;var howMany=1;model.emit('move',segments.slice(0,-1),[from,to,howMany,model._pass]);// StringInsertOp
}else if(defined(item.si)){var index=segments[segments.length-1];var text=item.si;segments=segments.slice(0,-1);var value=model._get(segments);var previous=value.slice(0,index)+value.slice(index+text.length);var pass=model.pass({$stringInsert:{index:index,text:text}})._pass;model.emit('change',segments,[value,previous,pass]);// StringRemoveOp
}else if(defined(item.sd)){var index=segments[segments.length-1];var text=item.sd;var howMany=text.length;segments=segments.slice(0,-1);var value=model._get(segments);var previous=value.slice(0,index)+text+value.slice(index);var pass=model.pass({$stringRemove:{index:index,howMany:howMany}})._pass;model.emit('change',segments,[value,previous,pass]);// IncrementOp
}else if(defined(item.na)){var value=this.get(item.p);var previous=value-item.na;model.emit('change',segments,[value,previous,model._pass]);// SubtypeOp
}else if(defined(item.t)){var value=this.get(item.p);// Since this is generic to all subtypes, we don't know how to get a copy
// of the previous value efficiently. We could make a copy eagerly, but
// given that embedded types are likely to be used for custom editors,
// we'll assume they primarily use the returned op and are unlikely to
// need the previous snapshot data
var previous=undefined;var type=item.t;var op=item.o;var pass=model.pass({$subtype:{type:type,op:op}})._pass;model.emit('change',segments,[value,previous,pass]);}};function ObjectReplaceOp(segments,before,after){this.p=util.castSegments(segments);this.od=before;this.oi=after===undefined?null:after;}function ObjectInsertOp(segments,value){this.p=util.castSegments(segments);this.oi=value===undefined?null:value;}function ObjectDeleteOp(segments,value){this.p=util.castSegments(segments);this.od=value===undefined?null:value;}function ListReplaceOp(segments,index,before,after){this.p=util.castSegments(segments.concat(index));this.ld=before;this.li=after===undefined?null:after;}function ListInsertOp(segments,index,value){this.p=util.castSegments(segments.concat(index));this.li=value===undefined?null:value;}function ListRemoveOp(segments,index,value){this.p=util.castSegments(segments.concat(index));this.ld=value===undefined?null:value;}function ListMoveOp(segments,from,to){this.p=util.castSegments(segments.concat(from));this.lm=to;}function StringInsertOp(segments,index,value){this.p=util.castSegments(segments.concat(index));this.si=value;}function StringRemoveOp(segments,index,value){this.p=util.castSegments(segments.concat(index));this.sd=value;}function IncrementOp(segments,byNumber){this.p=util.castSegments(segments);this.na=byNumber;}function SubtypeOp(segments,subtype,subtypeOp){this.p=util.castSegments(segments);this.t=subtype;this.o=subtypeOp;}function defined(value){return value!==undefined;}},{"../util":74,"./Doc":53}],58:[function(require,module,exports){var Model=require('./Model');var LocalDoc=require('./LocalDoc');var util=require('../util');function CollectionMap(){}function ModelData(){}function DocMap(){}function CollectionData(){}Model.INITS.push(function(model){model.root.collections=new CollectionMap();model.root.data=new ModelData();});Model.prototype.getCollection=function(collectionName){return this.root.collections[collectionName];};Model.prototype.getDoc=function(collectionName,id){var collection=this.root.collections[collectionName];return collection&&collection.docs[id];};Model.prototype.get=function(subpath){var segments=this._splitPath(subpath);return this._get(segments);};Model.prototype._get=function(segments){return util.lookup(segments,this.root.data);};Model.prototype.getCopy=function(subpath){var segments=this._splitPath(subpath);return this._getCopy(segments);};Model.prototype._getCopy=function(segments){var value=this._get(segments);return util.copy(value);};Model.prototype.getDeepCopy=function(subpath){var segments=this._splitPath(subpath);return this._getDeepCopy(segments);};Model.prototype._getDeepCopy=function(segments){var value=this._get(segments);return util.deepCopy(value);};Model.prototype.getOrCreateCollection=function(name){var collection=this.root.collections[name];if(collection)return collection;var Doc=this._getDocConstructor(name);collection=new Collection(this.root,name,Doc);this.root.collections[name]=collection;return collection;};Model.prototype._getDocConstructor=function(){// Only create local documents. This is overriden in ./connection.js, so that
// the RemoteDoc behavior can be selectively included
return LocalDoc;};/**
 * Returns an existing document with id in a collection. If the document does
 * not exist, then creates the document with id in a collection and returns the
 * new document.
 * @param {String} collectionName
 * @param {String} id
 * @param {Object} [data] data to create if doc with id does not exist in collection
 */Model.prototype.getOrCreateDoc=function(collectionName,id,data){var collection=this.getOrCreateCollection(collectionName);return collection.docs[id]||collection.add(id,data);};/**
 * @param {String} subpath
 */Model.prototype.destroy=function(subpath){var segments=this._splitPath(subpath);// Silently remove all types of listeners within subpath
var silentModel=this.silent();silentModel.removeAllListeners(null,subpath);silentModel._removeAllRefs(segments);silentModel._stopAll(segments);silentModel._removeAllFilters(segments);// Silently remove all model data within subpath
if(segments.length===0){this.root.collections=new CollectionMap();// Delete each property of data instead of creating a new object so that
// it is possible to continue using a reference to the original data object
var data=this.root.data;for(var key in data){delete data[key];}}else if(segments.length===1){var collection=this.getCollection(segments[0]);collection&&collection.destroy();}else{silentModel._del(segments);}};function Collection(model,name,Doc){this.model=model;this.name=name;this.Doc=Doc;this.docs=new DocMap();this.data=model.data[name]=new CollectionData();}/**
 * Adds a document with `id` and `data` to `this` Collection.
 * @param {String} id
 * @param {Object} data
 * @return {LocalDoc|RemoteDoc} doc
 */Collection.prototype.add=function(id,data){var doc=new this.Doc(this.model,this.name,id,data,this);this.docs[id]=doc;return doc;};Collection.prototype.destroy=function(){delete this.model.collections[this.name];delete this.model.data[this.name];};/**
 * Removes the document with `id` from `this` Collection. If there are no more
 * documents in the Collection after the given document is removed, then this
 * also destroys the Collection.
 * @param {String} id
 */Collection.prototype.remove=function(id){delete this.docs[id];delete this.data[id];if(noKeys(this.docs))this.destroy();};/**
 * Returns an object that maps doc ids to fully resolved documents.
 * @return {Object}
 */Collection.prototype.get=function(){return this.data;};function noKeys(object){// eslint-disable-next-line no-unused-vars
for(var key in object){return false;}return true;}},{"../util":74,"./LocalDoc":54,"./Model":55}],59:[function(require,module,exports){var Connection=require('sharedb/lib/client').Connection;var Model=require('./Model');var LocalDoc=require('./LocalDoc');var RemoteDoc=require('./RemoteDoc');Model.INITS.push(function(model){model.root._preventCompose=false;});Model.prototype.preventCompose=function(){var model=this._child();model._preventCompose=true;return model;};Model.prototype.allowCompose=function(){var model=this._child();model._preventCompose=false;return model;};Model.prototype.createConnection=function(bundle){// Model::_createSocket should be defined by the socket plugin
this.root.socket=this._createSocket(bundle);// The Share connection will bind to the socket by defining the onopen,
// onmessage, etc. methods
var model=this;this.root.connection=new Connection(this.root.socket);this.root.connection.on('state',function(state,reason){model._setDiff(['$connection','state'],state);model._setDiff(['$connection','reason'],reason);});this._set(['$connection','state'],'connected');this._finishCreateConnection();};Model.prototype._finishCreateConnection=function(){var model=this;this.root.connection.on('error',function(err){model._emitError(err);});// Share docs can be created by queries, so we need to register them
// with Racer as soon as they are created to capture their events
this.root.connection.on('doc',function(shareDoc){model.getOrCreateDoc(shareDoc.collection,shareDoc.id);});};Model.prototype.connect=function(){this.root.socket.open();};Model.prototype.disconnect=function(){this.root.socket.close();};Model.prototype.reconnect=function(){this.disconnect();this.connect();};// Clean delayed disconnect
Model.prototype.close=function(cb){cb=this.wrapCallback(cb);var model=this;this.whenNothingPending(function(){model.root.socket.close();cb();});};// Returns a reference to the ShareDB agent if it is connected directly on the
// server. Will return null if the ShareDB connection has been disconnected or
// if we are not in the same process and we do not have a reference to the
// server-side agent object
Model.prototype.getAgent=function(){return this.root.connection.agent;};Model.prototype._isLocal=function(name){// Whether the collection is local or remote is determined by its name.
// Collections starting with an underscore ('_') are for user-defined local
// collections, those starting with a dollar sign ('$'') are for
// framework-defined local collections, and all others are remote.
var firstCharcter=name.charAt(0);return firstCharcter==='_'||firstCharcter==='$';};Model.prototype._getDocConstructor=function(name){return this._isLocal(name)?LocalDoc:RemoteDoc;};Model.prototype.hasPending=function(){return this.root.connection.hasPending();};Model.prototype.hasWritePending=function(){return this.root.connection.hasWritePending();};Model.prototype.whenNothingPending=function(cb){return this.root.connection.whenNothingPending(cb);};},{"./LocalDoc":54,"./Model":55,"./RemoteDoc":57,"sharedb/lib/client":79}],60:[function(require,module,exports){/**
 * Contexts are useful for keeping track of the origin of subscribes.
 */var Model=require('./Model');var CollectionCounter=require('./CollectionCounter');Model.INITS.push(function(model){model.root._contexts=new Contexts();model.root.setContext('root');});Model.prototype.context=function(id){var model=this._child();model.setContext(id);return model;};Model.prototype.setContext=function(id){this._context=this.getOrCreateContext(id);};Model.prototype.getOrCreateContext=function(id){var context=this.root._contexts[id]||(this.root._contexts[id]=new Context(this,id));return context;};Model.prototype.unload=function(id){var context=id?this.root._contexts[id]:this._context;context&&context.unload();};Model.prototype.unloadAll=function(){var contexts=this.root._contexts;for(var key in contexts){contexts[key].unload();}};function Contexts(){}function FetchedQueries(){}function SubscribedQueries(){}function Context(model,id){this.model=model;this.id=id;this.fetchedDocs=new CollectionCounter();this.subscribedDocs=new CollectionCounter();this.createdDocs=new CollectionCounter();this.fetchedQueries=new FetchedQueries();this.subscribedQueries=new SubscribedQueries();}Context.prototype.toJSON=function(){var fetchedDocs=this.fetchedDocs.toJSON();var subscribedDocs=this.subscribedDocs.toJSON();var createdDocs=this.createdDocs.toJSON();if(!fetchedDocs&&!subscribedDocs&&!createdDocs)return;return{fetchedDocs:fetchedDocs,subscribedDocs:subscribedDocs,createdDocs:createdDocs};};Context.prototype.fetchDoc=function(collectionName,id){this.fetchedDocs.increment(collectionName,id);};Context.prototype.subscribeDoc=function(collectionName,id){this.subscribedDocs.increment(collectionName,id);};Context.prototype.unfetchDoc=function(collectionName,id){this.fetchedDocs.decrement(collectionName,id);};Context.prototype.unsubscribeDoc=function(collectionName,id){this.subscribedDocs.decrement(collectionName,id);};Context.prototype.createDoc=function(collectionName,id){this.createdDocs.increment(collectionName,id);};Context.prototype.fetchQuery=function(query){mapIncrement(this.fetchedQueries,query.hash);};Context.prototype.subscribeQuery=function(query){mapIncrement(this.subscribedQueries,query.hash);};Context.prototype.unfetchQuery=function(query){mapDecrement(this.fetchedQueries,query.hash);};Context.prototype.unsubscribeQuery=function(query){mapDecrement(this.subscribedQueries,query.hash);};function mapIncrement(map,key){map[key]=(map[key]||0)+1;}function mapDecrement(map,key){map[key]&&map[key]--;if(!map[key])delete map[key];}Context.prototype.unload=function(){var model=this.model;for(var hash in this.fetchedQueries){var query=model.root._queries.map[hash];if(!query)continue;var count=this.fetchedQueries[hash];while(count--){query.unfetch();}}for(var hash in this.subscribedQueries){var query=model.root._queries.map[hash];if(!query)continue;var count=this.subscribedQueries[hash];while(count--){query.unsubscribe();}}for(var collectionName in this.fetchedDocs.collections){var collection=this.fetchedDocs.collections[collectionName];for(var id in collection){var count=collection[id];while(count--){model.unfetchDoc(collectionName,id);}}}for(var collectionName in this.subscribedDocs.collections){var collection=this.subscribedDocs.collections[collectionName];for(var id in collection){var count=collection[id];while(count--){model.unsubscribeDoc(collectionName,id);}}}for(var collectionName in this.createdDocs.collections){var collection=this.createdDocs.collections[collectionName];for(var id in collection){model._maybeUnloadDoc(collectionName,id);}}this.createdDocs.reset();};},{"./CollectionCounter":52,"./Model":55}],61:[function(require,module,exports){var defaultFns=module.exports=new DefaultFns();defaultFns.reverse=new FnPair(getReverse,setReverse);defaultFns.asc=asc;defaultFns.desc=desc;function DefaultFns(){}function FnPair(get,set){this.get=get;this.set=set;}function getReverse(array){return array&&array.slice().reverse();}function setReverse(values){return{0:getReverse(values)};}function asc(a,b){if(a<b)return-1;if(a>b)return 1;return 0;}function desc(a,b){if(a>b)return-1;if(a<b)return 1;return 0;}},{}],62:[function(require,module,exports){// @ts-check
var EventEmitter=require('events').EventEmitter;var util=require('../util');/** @type any */var Model=require('./Model');// These events are re-emitted as 'all' events, and they are queued up and
// emitted in sequence, so that events generated by other events are not
// seen in a different order by later listeners
Model.MUTATOR_EVENTS={change:true,insert:true,remove:true,move:true,load:true,unload:true};Model.INITS.push(function(model){EventEmitter.call(this);// Set max listeners to unlimited
model.setMaxListeners(0);// Used in async methods to emit an error event if a callback is not supplied.
// This will throw if there is no handler for model.on('error')
model.root._defaultCallback=defaultCallback;function defaultCallback(err){if(err)model._emitError(err);}model.root._mutatorEventQueue=null;model.root._pass=new Passed({},{});model.root._silent=null;model.root._eventContext=null;});util.mergeInto(Model.prototype,EventEmitter.prototype);Model.prototype.wrapCallback=function(cb){if(!cb)return this.root._defaultCallback;var model=this;return function wrappedCallback(){try{return cb.apply(this,arguments);}catch(err){model._emitError(err);}};};Model.prototype._emitError=function(err,context){var message=err.message?err.message:typeof err==='string'?err:'Unknown model error';if(context){message+=' '+context;}if(err.data){try{message+=' '+JSON.stringify(err.data);}catch(stringifyErr){}}if(err instanceof Error){err.message=message;}else{err=new Error(message);}this.emit('error',err);};// EventEmitter.prototype.on, EventEmitter.prototype.addListener, and
// EventEmitter.prototype.once return `this`. The Model equivalents return
// the listener instead, since it is made internally for method subscriptions
// and may need to be passed to removeListener.
Model.prototype._emit=EventEmitter.prototype.emit;Model.prototype.emit=function(type){if(type==='error'){return this._emit.apply(this,arguments);}if(Model.MUTATOR_EVENTS[type]){if(this._silent)return this;// `segments` is almost definitely an array of strings.
//
// A search for `.emit(` shows that `segments` is generated from either
// `Model#_splitPath` or `Model#_dereference`, both of which return an array
// of strings.
var segments=arguments[1];var eventArgs=arguments[2];this._emit(type+'Immediate',segments,eventArgs);if(this.root._mutatorEventQueue){this.root._mutatorEventQueue.push([type,segments,eventArgs]);return this;}this.root._mutatorEventQueue=[];this._emit(type,segments,eventArgs);this._emit('all',segments,[type].concat(eventArgs));while(this.root._mutatorEventQueue.length){var queued=this.root._mutatorEventQueue.shift();type=queued[0];segments=queued[1];eventArgs=queued[2];this._emit(type,segments,eventArgs);this._emit('all',segments,[type].concat(eventArgs));}this.root._mutatorEventQueue=null;return this;}return this._emit.apply(this,arguments);};Model.prototype._on=EventEmitter.prototype.on;Model.prototype.addListener=Model.prototype.on=function(type,pattern,options,cb){var listener=eventListener(this,type,pattern,options,cb);this._on(type,listener);return listener;};Model.prototype.once=function(type,pattern,options,cb){var listener=eventListener(this,type,pattern,options,cb);function g(){var matches=listener.apply(null,arguments);if(matches)this.removeListener(type,g);}this._on(type,g);return g;};/**
 * @typedef {Object} ModelOnOptions
 * @property {boolean} [useEventObjects] - If true, the listener is called with
 *   `cb(event: ___Event, captures: string[])`, instead of the legacy var-args
 *   style `cb(captures..., [eventType], eventArgs..., passed)`.
 */Model.prototype._removeAllListeners=EventEmitter.prototype.removeAllListeners;Model.prototype.removeAllListeners=function(type,subpattern){// If a pattern is specified without an event type, remove all model event
// listeners under that pattern for all events
if(!type){for(var key in this._events){this.removeAllListeners(key,subpattern);}return this;}var pattern=this.path(subpattern);// If no pattern is specified, remove all listeners like normal
if(!pattern){if(arguments.length===0){return this._removeAllListeners();}return this._removeAllListeners(type);}// Remove all listeners for an event under a pattern
var listeners=this.listeners(type);var segments=pattern.split('.');// Make sure to iterate in reverse, since the array might be
// mutated as listeners are removed
for(var i=listeners.length;i--;){var listener=listeners[i];if(patternContained(pattern,segments,listener)){this.removeListener(type,listener);}}return this;};function patternContained(pattern,segments,listener){var listenerSegments=listener.patternSegments;if(!listenerSegments)return false;if(pattern===listener.pattern||pattern==='**')return true;var len=segments.length;if(len>listenerSegments.length)return false;for(var i=0;i<len;i++){if(segments[i]!==listenerSegments[i])return false;}return true;}Model.prototype.pass=function(object,invert){var model=this._child();model._pass=invert?new Passed(object,this._pass):new Passed(this._pass,object);return model;};function Passed(previous,value){for(var key in previous){this[key]=previous[key];}for(var key in value){this[key]=value[key];}}/**
 * The returned Model will or won't trigger event handlers when the model emits
 * events, depending on `value`
 * @param {Boolean|Null} value defaults to true
 * @return {Model}
 */Model.prototype.silent=function(value){var model=this._child();model._silent=value==null?true:value;return model;};Model.prototype.eventContext=function(value){var model=this._child();model._eventContext=value;return model;};Model.prototype.removeContextListeners=function(value){if(arguments.length===0){value=this._eventContext;}// Remove all events created within a given context
for(var type in this._events){var listeners=this.listeners(type);// Make sure to iterate in reverse, since the array might be
// mutated as listeners are removed
for(var i=listeners.length;i--;){var listener=listeners[i];if(listener.eventContext===value){this.removeListener(type,listener);}}}return this;};/**
 * @param {Model} model
 * @param {string} eventType
 */function eventListener(model,eventType,arg2,arg3,arg4){var subpattern,options,cb;if(arg4){// on(eventType, path, options, cb)
subpattern=arg2;options=arg3;cb=arg4;}else if(arg3){// on(eventType, path, cb)
// on(eventType, options, cb)
cb=arg3;if(model.isPath(arg2)){subpattern=arg2;}else{options=arg2;}}else{// if (arg2)
// on(eventType, cb)
cb=arg2;}if(options){if(options.useEventObjects){var useEventObjects=true;}}if(subpattern){// For signatures with pattern:
// model.on('change', 'example.subpath.**', callback)
// model.at('example').on('change', 'subpath', callback)
var pattern=model.path(subpattern);return useEventObjects?modelEventListener(eventType,pattern,cb,model._eventContext):modelEventListenerLegacy(pattern,cb,model._eventContext);}// For signature without explicit pattern:
// model.at('example').on('change', callback)
/** @type string */var path=model.path();if(path){return useEventObjects?modelEventListener(eventType,path,cb,model._eventContext):modelEventListenerLegacy(path,cb,model._eventContext);}// For signature:
// model.on('normalEvent', callback)
return cb;}/**
 * Legacy version of `modelEventListener` that calls `cb` with var-args
 * `(captures..., [eventType], args..., passed)` instead of new-style
 * `___Event` objects.
 *
 * @param {string} pattern
 * @param {Function} cb
 * @param {*} eventContext
 * @return {ModelListenerFn & ModelListenerProps}
 */function modelEventListenerLegacy(pattern,cb,eventContext){var patternSegments=util.castSegments(pattern.split('.'));var testFn=testPatternFn(pattern,patternSegments);/** @type ModelListenerFn */function modelListener(segments,eventArgs){var captures=testFn(segments);if(!captures)return;var args=captures.length?captures.concat(eventArgs):eventArgs;cb.apply(null,args);return true;}// Used in Model#removeAllListeners
modelListener.pattern=pattern;modelListener.patternSegments=patternSegments;modelListener.eventContext=eventContext;return modelListener;}/**
 * Returns a function that can be passed to `EventEmitter#on`, with some
 * additional properties used for `Model#removeAllListeners`.
 *
 * When the function is called, it checks if the event matches `patternArg`, and
 * if there's a match, it calls `cb`.
 *
 * @param {string} eventType
 * @param {string} pattern
 * @param {Function} cb
 * @param {*} eventContext
 * @return {ModelListenerFn & ModelListenerProps}
 */function modelEventListener(eventType,pattern,cb,eventContext){var patternSegments=util.castSegments(pattern.split('.'));var testFn=testPatternFn(pattern,patternSegments);var eventFactory=getEventFactory(eventType);/** @type ModelListenerFn */function modelListener(segments,eventArgs){var captures=testFn(segments);if(!captures)return;var event=eventFactory(eventArgs);cb(event,captures);return true;}// Used in Model#removeAllListeners
modelListener.pattern=pattern;modelListener.patternSegments=patternSegments;modelListener.eventContext=eventContext;return modelListener;}/** @typedef { (segments: string[], eventArgs: any[]) => (boolean | undefined) } ModelListenerFn */ /** @typedef { {pattern: string, patternSegments: Array<string | number>, eventContext: any} } ModelListenerProps */ /**
 * Returns a factory function that creates an `___Event` object based on an
 * old-style `eventArgs` array.
 *
 * @param {string} eventType
 * @return {(eventArgs: any[]) => ChangeEvent | InsertEvent | RemoveEvent | MoveEvent | LoadEvent | UnloadEvent}
 */function getEventFactory(eventType){switch(eventType){case'change':return function(eventArgs){return new ChangeEvent(eventArgs);};case'insert':return function(eventArgs){return new InsertEvent(eventArgs);};case'remove':return function(eventArgs){return new RemoveEvent(eventArgs);};case'move':return function(eventArgs){return new MoveEvent(eventArgs);};case'load':return function(eventArgs){return new LoadEvent(eventArgs);};case'unload':return function(eventArgs){return new UnloadEvent(eventArgs);};case'all':return function(eventArgs){var concreteEventType=eventArgs[0];// 'change', 'insert', etc.
var concreteEventFactory=getEventFactory(concreteEventType);return concreteEventFactory(eventArgs.slice(1));};default:throw new Error('Unknown event: '+eventType);}}// These constructors accept the `eventArgs` array format that Racer uses
// internally when calling `Model#emit`.
//
// Eventually, Racer should switch to passing these events around directly,
// but that will require updating all the places that parse the `eventArgs`
// array format, to extract things like `passed`.
function ChangeEvent(eventArgs){this.value=eventArgs[0];this.previous=eventArgs[1];this.passed=eventArgs[2];}ChangeEvent.prototype.type='change';function InsertEvent(eventArgs){this.index=eventArgs[0];this.values=eventArgs[1];this.passed=eventArgs[2];}InsertEvent.prototype.type='insert';function RemoveEvent(eventArgs){this.index=eventArgs[0];this.removed=eventArgs[1];this.passed=eventArgs[2];}RemoveEvent.prototype.type='remove';function MoveEvent(eventArgs){this.from=eventArgs[0];this.to=eventArgs[1];this.howMany=eventArgs[2];this.passed=eventArgs[3];}MoveEvent.prototype.type='move';function LoadEvent(eventArgs){this.document=eventArgs[0];this.passed=eventArgs[1];}LoadEvent.prototype.type='load';function UnloadEvent(eventArgs){this.previousDocument=eventArgs[0];this.passed=eventArgs[1];}UnloadEvent.prototype.type='unload';/**
 * Returns a function that tests an array of event segments against the
 * `patternSegments`. (`pattern` only matters if it's exactly `'**'`.)
 *
 * @param {string?} pattern
 * @param {Array<string | number>} patternSegments
 * @return {(segments: string[]) => (string[] | undefined)} A function to test
 *   an array of event segments. If the event segments match, an array of 0 or
 *   more segments captured by `'*'` / `'**'` is returned, one per wildcard. If
 *   the event segments don't match, `undefined` is returned.
 */function testPatternFn(pattern,patternSegments){if(pattern==='**'){return function testPattern(segments){return[segments.join('.')];};}var endingRest=stripRestWildcard(patternSegments);return function testPattern(segments){// Any pattern with more segments does not match
var patternLen=patternSegments.length;if(patternLen>segments.length)return;// A pattern with the same number of segments matches if each
// of the segments are wildcards or equal. A shorter pattern matches
// if it ends in a rest wildcard and each of the corresponding
// segments are wildcards or equal.
if(patternLen===segments.length||endingRest){/** @type string[] */var captures=[];for(var i=0;i<patternLen;i++){var patternSegment=patternSegments[i];var segment=segments[i];if(patternSegment==='*'||patternSegment==='**'){captures.push(segment);continue;}if(patternSegment!==segment)return;}if(endingRest){var remainder=segments.slice(i).join('.');captures.push(remainder);}return captures;}};}/**
 * @param {Array<string | number>} segments
 */function stripRestWildcard(segments){// ['example', '**'] -> ['example']; return true
var lastIndex=segments.length-1;var lastSegment=segments[lastIndex];if(lastSegment==='**'){segments.pop();return true;}// ['example', 'subpath**'] -> ['example', 'subpath']; return true
if(typeof lastSegment!=='string')return false;var match=/^([^\*]+)\*\*$/.exec(lastSegment);if(!match)return false;segments[lastIndex]=match[1];return true;}},{"../util":74,"./Model":55,"events":33}],63:[function(require,module,exports){var util=require('../util');var Model=require('./Model');var defaultFns=require('./defaultFns');Model.INITS.push(function(model){model.root._filters=new Filters(model);model.on('all',filterListener);function filterListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];var map=model.root._filters.fromMap;for(var path in map){var filter=map[path];if(pass.$filter===filter)continue;if(util.mayImpact(filter.segments,segments)||filter.inputsSegments&&util.mayImpactAny(filter.inputsSegments,segments)){filter.update(pass);}}}});function parseFilterArguments(model,args){var fn=args.pop();var options;if(!model.isPath(args[args.length-1])){options=args.pop();}var path=model.path(args.shift());var i=args.length;while(i--){args[i]=model.path(args[i]);}return{path:path,inputPaths:args.length?args:null,options:options,fn:fn};}Model.prototype.filter=function(){var args=Array.prototype.slice.call(arguments);var parsed=parseFilterArguments(this,args);return this.root._filters.add(parsed.path,parsed.fn,null,parsed.inputPaths,parsed.options);};Model.prototype.sort=function(){var args=Array.prototype.slice.call(arguments);var parsed=parseFilterArguments(this,args);return this.root._filters.add(parsed.path,null,parsed.fn||'asc',parsed.inputPaths,parsed.options);};Model.prototype.removeAllFilters=function(subpath){var segments=this._splitPath(subpath);this._removeAllFilters(segments);};Model.prototype._removeAllFilters=function(segments){var filters=this.root._filters.fromMap;for(var from in filters){if(util.contains(segments,filters[from].fromSegments)){filters[from].destroy();}}};function FromMap(){}function Filters(model){this.model=model;this.fromMap=new FromMap();}Filters.prototype.add=function(path,filterFn,sortFn,inputPaths,options){return new Filter(this,path,filterFn,sortFn,inputPaths,options);};Filters.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var filter=this.fromMap[from];// Don't try to bundle if functions were passed directly instead of by name
if(!filter.bundle)continue;var args=[from,filter.path,filter.filterName,filter.sortName,filter.inputPaths];if(filter.options)args.push(filter.options);out.push(args);}return out;};function Filter(filters,path,filterFn,sortFn,inputPaths,options){this.filters=filters;this.model=filters.model.pass({$filter:this});this.path=path;this.segments=path.split('.');this.filterName=null;this.sortName=null;this.bundle=true;this.filterFn=null;this.sortFn=null;this.inputPaths=inputPaths;this.inputsSegments=null;if(inputPaths){this.inputsSegments=[];for(var i=0;i<this.inputPaths.length;i++){var segments=this.inputPaths[i].split('.');this.inputsSegments.push(segments);}}this.options=options;this.skip=options&&options.skip;this.limit=options&&options.limit;if(filterFn)this.filter(filterFn);if(sortFn)this.sort(sortFn);this.idsSegments=null;this.from=null;this.fromSegments=null;}Filter.prototype.filter=function(fn){if(typeof fn==='function'){this.filterFn=fn;this.bundle=false;return this;}else if(typeof fn==='string'){this.filterName=fn;this.filterFn=this.model.root._namedFns[fn]||defaultFns[fn];if(!this.filterFn){throw new TypeError('Filter function not found: '+fn);}}return this;};Filter.prototype.sort=function(fn){if(!fn)fn='asc';if(typeof fn==='function'){this.sortFn=fn;this.bundle=false;return this;}else if(typeof fn==='string'){this.sortName=fn;this.sortFn=this.model.root._namedFns[fn]||defaultFns[fn];if(!this.sortFn){throw new TypeError('Sort function not found: '+fn);}}return this;};Filter.prototype._slice=function(results){if(this.skip==null&&this.limit==null)return results;var begin=this.skip||0;// A limit of zero is equivalent to setting no limit
var end;if(this.limit)end=begin+this.limit;return results.slice(begin,end);};Filter.prototype.getInputs=function(){if(!this.inputsSegments)return;var inputs=[];for(var i=0,len=this.inputsSegments.length;i<len;i++){var input=this.model._get(this.inputsSegments[i]);inputs.push(input);}return inputs;};Filter.prototype.callFilter=function(items,key,inputs){var item=items[key];return inputs?this.filterFn.apply(this.model,[item,key,items].concat(inputs)):this.filterFn.call(this.model,item,key,items);};Filter.prototype.ids=function(){var items=this.model._get(this.segments);var ids=[];if(!items)return ids;if(Array.isArray(items)){throw new Error('model.filter is not currently supported on arrays');}if(this.filterFn){var inputs=this.getInputs();for(var key in items){if(items.hasOwnProperty(key)&&this.callFilter(items,key,inputs)){ids.push(key);}}}else{ids=Object.keys(items);}var sortFn=this.sortFn;if(sortFn){ids.sort(function(a,b){return sortFn(items[a],items[b]);});}return this._slice(ids);};Filter.prototype.get=function(){var items=this.model._get(this.segments);var results=[];if(Array.isArray(items)){throw new Error('model.filter is not currently supported on arrays');}if(this.filterFn){var inputs=this.getInputs();for(var key in items){if(items.hasOwnProperty(key)&&this.callFilter(items,key,inputs)){results.push(items[key]);}}}else{for(var key in items){if(items.hasOwnProperty(key)){results.push(items[key]);}}}if(this.sortFn)results.sort(this.sortFn);return this._slice(results);};Filter.prototype.update=function(pass){var ids=this.ids();this.model.pass(pass,true)._setArrayDiff(this.idsSegments,ids);};Filter.prototype.ref=function(from){from=this.model.path(from);this.from=from;this.fromSegments=from.split('.');this.filters.fromMap[from]=this;this.idsSegments=['$filters',from.replace(/\./g,'|')];this.update();return this.model.refList(from,this.path,this.idsSegments.join('.'));};Filter.prototype.destroy=function(){delete this.filters.fromMap[this.from];this.model._removeRef(this.idsSegments);this.model._del(this.idsSegments);};},{"../util":74,"./Model":55,"./defaultFns":61}],64:[function(require,module,exports){(function(process){var util=require('../util');var Model=require('./Model');var defaultFns=require('./defaultFns');function NamedFns(){}Model.INITS.push(function(model){model.root._namedFns=new NamedFns();model.root._fns=new Fns(model);model.on('all',fnListener);function fnListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];var map=model.root._fns.fromMap;for(var path in map){var fn=map[path];if(pass.$fn===fn)continue;if(util.mayImpactAny(fn.inputsSegments,segments)){// Mutation affecting input path
fn.onInput(pass);}else if(util.mayImpact(fn.fromSegments,segments)){// Mutation affecting output path
fn.onOutput(pass);}}}});Model.prototype.fn=function(name,fns){this.root._namedFns[name]=fns;};function parseStartArguments(model,args,hasPath){var last=args.pop();var fns,name;if(typeof last==='string'){name=last;}else{fns=last;}// For `Model#start`, the first parameter is the output path.
var path;if(hasPath){path=model.path(args.shift());}// The second-to-last original argument could be an options object.
// If it's not an array and not path-like, then it's an options object.
last=args[args.length-1];var options;if(!Array.isArray(last)&&!model.isPath(last)){options=args.pop();}// `args` is just the input paths at this point.
var inputs;if(args.length===1&&Array.isArray(args[0])){// Inputs provided as one array:
//   model.start(outPath, [inPath1, inPath2], fn);
inputs=args[0];}else{// Inputs provided as var-args:
//   model.start(outPath, inPath1, inPath2, fn);
inputs=args;}// Normalize each input into a string path.
var i=inputs.length;while(i--){inputs[i]=model.path(inputs[i]);}return{name:name,path:path,inputPaths:inputs,fns:fns,options:options};}Model.prototype.evaluate=function(){var args=Array.prototype.slice.call(arguments);var parsed=parseStartArguments(this,args,false);return this.root._fns.get(parsed.name,parsed.inputPaths,parsed.fns,parsed.options);};Model.prototype.start=function(){var args=Array.prototype.slice.call(arguments);var parsed=parseStartArguments(this,args,true);return this.root._fns.start(parsed.name,parsed.path,parsed.inputPaths,parsed.fns,parsed.options);};Model.prototype.stop=function(subpath){var path=this.path(subpath);this._stop(path);};Model.prototype._stop=function(fromPath){this.root._fns.stop(fromPath);};Model.prototype.stopAll=function(subpath){var segments=this._splitPath(subpath);this._stopAll(segments);};Model.prototype._stopAll=function(segments){var fns=this.root._fns.fromMap;for(var from in fns){var fromSegments=fns[from].fromSegments;if(util.contains(segments,fromSegments)){this._stop(from);}}};function FromMap(){}function Fns(model){this.model=model;this.nameMap=model.root._namedFns;this.fromMap=new FromMap();}Fns.prototype.get=function(name,inputPaths,fns,options){fns||(fns=this.nameMap[name]||defaultFns[name]);var fn=new Fn(this.model,name,null,inputPaths,fns,options);return fn.get();};Fns.prototype.start=function(name,path,inputPaths,fns,options){fns||(fns=this.nameMap[name]||defaultFns[name]);var fn=new Fn(this.model,name,path,inputPaths,fns,options);this.fromMap[path]=fn;return fn._onInput();};Fns.prototype.stop=function(path){var fn=this.fromMap[path];delete this.fromMap[path];return fn;};Fns.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var fn=this.fromMap[from];// Don't try to bundle non-named functions that were started via
// model.start directly instead of by name
if(!fn.name)continue;var args=[fn.from].concat(fn.inputPaths);if(fn.options)args.push(fn.options);args.push(fn.name);out.push(args);}return out;};function Fn(model,name,from,inputPaths,fns,options){this.model=model.pass({$fn:this});this.name=name;this.from=from;this.inputPaths=inputPaths;this.options=options;if(!fns){throw new TypeError('Model function not found: '+name);}this.getFn=fns.get||fns;this.setFn=fns.set;this.fromSegments=from&&from.split('.');this.inputsSegments=[];for(var i=0;i<this.inputPaths.length;i++){var segments=this.inputPaths[i].split('.');this.inputsSegments.push(segments);}// Copy can be 'output', 'input', 'both', or 'none'
var copy=options&&options.copy||'output';this.copyInput=copy==='input'||copy==='both';this.copyOutput=copy==='output'||copy==='both';// Mode can be 'diffDeep', 'diff', 'arrayDeep', or 'array'
this.mode=options&&options.mode||'diffDeep';this.async=!!(options&&options.async);this.eventPending=false;}Fn.prototype.apply=function(fn,inputs){for(var i=0,len=this.inputsSegments.length;i<len;i++){var input=this.model._get(this.inputsSegments[i]);inputs.push(this.copyInput?util.deepCopy(input):input);}return fn.apply(this.model,inputs);};Fn.prototype.get=function(){return this.apply(this.getFn,[]);};Fn.prototype.set=function(value,pass){if(!this.setFn)return;var out=this.apply(this.setFn,[value]);if(!out)return;var inputsSegments=this.inputsSegments;var model=this.model.pass(pass,true);for(var key in out){var value=this.copyOutput?util.deepCopy(out[key]):out[key];this._setValue(model,inputsSegments[key],value);}};Fn.prototype.onInput=function(pass){if(this.async){if(this.eventPending)return;this.eventPending=true;var fn=this;process.nextTick(function(){fn._onInput(pass);fn.eventPending=false;});return;}return this._onInput(pass);};Fn.prototype._onInput=function(pass){var value=this.copyOutput?util.deepCopy(this.get()):this.get();this._setValue(this.model.pass(pass,true),this.fromSegments,value);return value;};Fn.prototype.onOutput=function(pass){var value=this.model._get(this.fromSegments);return this.set(value,pass);};Fn.prototype._setValue=function(model,segments,value){if(this.mode==='diffDeep'){model._setDiffDeep(segments,value);}else if(this.mode==='arrayDeep'){model._setArrayDiffDeep(segments,value);}else if(this.mode==='array'){model._setArrayDiff(segments,value);}else{model._setDiff(segments,value);}};}).call(this,require('_process'));},{"../util":74,"./Model":55,"./defaultFns":61,"_process":40}],65:[function(require,module,exports){module.exports=require('./Model');var util=require('../util');// Extend model on both server and client //
require('./unbundle');require('./events');require('./paths');require('./collections');require('./mutators');require('./setDiff');require('./connection');require('./subscriptions');require('./Query');require('./contexts');require('./fn');require('./filter');require('./refList');require('./ref');// Extend model for server //
util.serverRequire(module,'./bundle');util.serverRequire(module,'./connection.server');},{"../util":74,"./Model":55,"./Query":56,"./collections":58,"./connection":59,"./contexts":60,"./events":62,"./filter":63,"./fn":64,"./mutators":66,"./paths":67,"./ref":68,"./refList":69,"./setDiff":70,"./subscriptions":71,"./unbundle":72}],66:[function(require,module,exports){var util=require('../util');var Model=require('./Model');Model.prototype._mutate=function(segments,fn,cb){cb=this.wrapCallback(cb);var collectionName=segments[0];var id=segments[1];if(!collectionName||!id){var message=fn.name+' must be performed under a collection '+'and document id. Invalid path: '+segments.join('.');return cb(new Error(message));}var doc=this.getOrCreateDoc(collectionName,id);var docSegments=segments.slice(2);if(this._preventCompose&&doc.shareDoc){var oldPreventCompose=doc.shareDoc.preventCompose;doc.shareDoc.preventCompose=true;var out=fn(doc,docSegments,cb);doc.shareDoc.preventCompose=oldPreventCompose;return out;}return fn(doc,docSegments,cb);};Model.prototype.set=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._set(segments,value,cb);};Model.prototype._set=function(segments,value,cb){segments=this._dereference(segments);var model=this;function set(doc,docSegments,fnCb){var previous=doc.set(docSegments,value,fnCb);// On setting the entire doc, remote docs sometimes do a copy to add the
// id without it being stored in the database by ShareJS
if(docSegments.length===0)value=doc.get(docSegments);model.emit('change',segments,[value,previous,model._pass]);return previous;}return this._mutate(segments,set,cb);};Model.prototype.setNull=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._setNull(segments,value,cb);};Model.prototype._setNull=function(segments,value,cb){segments=this._dereference(segments);var model=this;function setNull(doc,docSegments,fnCb){var previous=doc.get(docSegments);if(previous!=null){fnCb();return previous;}doc.set(docSegments,value,fnCb);model.emit('change',segments,[value,previous,model._pass]);return value;}return this._mutate(segments,setNull,cb);};Model.prototype.setEach=function(){var subpath,object,cb;if(arguments.length===1){object=arguments[0];}else if(arguments.length===2){subpath=arguments[0];object=arguments[1];}else{subpath=arguments[0];object=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._setEach(segments,object,cb);};Model.prototype._setEach=function(segments,object,cb){segments=this._dereference(segments);var group=util.asyncGroup(this.wrapCallback(cb));for(var key in object){var value=object[key];this._set(segments.concat(key),value,group());}};Model.prototype.create=function(){var subpath,value,cb;if(arguments.length===0){value={};}else if(arguments.length===1){if(typeof arguments[0]==='function'){value={};cb=arguments[0];}else{value=arguments[0];}}else if(arguments.length===2){if(typeof arguments[1]==='function'){value=arguments[0];cb=arguments[1];}else{subpath=arguments[0];value=arguments[1];}}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._create(segments,value,cb);};Model.prototype._create=function(segments,value,cb){segments=this._dereference(segments);if(segments.length!==2){var message='create may only be used on a document path. '+'Invalid path: '+segments.join('.');cb=this.wrapCallback(cb);return cb(new Error(message));}var model=this;function create(doc,docSegments,fnCb){var previous;doc.create(value,fnCb);// On creating the doc, remote docs do a copy to add the id without
// it being stored in the database by ShareJS
value=doc.get();model.emit('change',segments,[value,previous,model._pass]);}this._mutate(segments,create,cb);};Model.prototype.createNull=function(){var subpath,value,cb;if(arguments.length===0){value={};}else if(arguments.length===1){if(typeof arguments[0]==='function'){value={};cb=arguments[0];}else{value=arguments[0];}}else if(arguments.length===2){if(typeof arguments[1]==='function'){value=arguments[0];cb=arguments[1];}else{subpath=arguments[0];value=arguments[1];}}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._createNull(segments,value,cb);};Model.prototype._createNull=function(segments,value,cb){segments=this._dereference(segments);var doc=this.getDoc(segments[0],segments[1]);if(doc&&doc.get()!=null)return;this._create(segments,value,cb);};Model.prototype.add=function(){var subpath,value,cb;if(arguments.length===0){value={};}else if(arguments.length===1){if(typeof arguments[0]==='function'){value={};cb=arguments[0];}else{value=arguments[0];}}else if(arguments.length===2){if(typeof arguments[1]==='function'){value=arguments[0];cb=arguments[1];}else{subpath=arguments[0];value=arguments[1];}}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._add(segments,value,cb);};Model.prototype._add=function(segments,value,cb){if(_typeof(value)!=='object'){var message='add requires an object value. Invalid value: '+value;cb=this.wrapCallback(cb);return cb(new Error(message));}var id=value.id||this.id();value.id=id;segments=this._dereference(segments.concat(id));var model=this;function add(doc,docSegments,fnCb){var previous;if(docSegments.length){previous=doc.set(docSegments,value,fnCb);}else{doc.create(value,fnCb);// On creating the doc, remote docs do a copy to add the id without
// it being stored in the database by ShareJS
value=doc.get();}model.emit('change',segments,[value,previous,model._pass]);}this._mutate(segments,add,cb);return id;};Model.prototype.del=function(){var subpath,cb;if(arguments.length===1){if(typeof arguments[0]==='function'){cb=arguments[0];}else{subpath=arguments[0];}}else{subpath=arguments[0];cb=arguments[1];}var segments=this._splitPath(subpath);return this._del(segments,cb);};Model.prototype._del=function(segments,cb){segments=this._dereference(segments);var model=this;function del(doc,docSegments,fnCb){var previous=doc.del(docSegments,fnCb);// When deleting an entire document, also remove the reference to the
// document object from its collection
if(segments.length===2){var collectionName=segments[0];var id=segments[1];model.root.collections[collectionName].remove(id);}model.emit('change',segments,[undefined,previous,model._pass]);return previous;}return this._mutate(segments,del,cb);};Model.prototype.increment=function(){var subpath,byNumber,cb;if(arguments.length===1){if(typeof arguments[0]==='function'){cb=arguments[0];}else if(typeof arguments[0]==='number'){byNumber=arguments[0];}else{subpath=arguments[0];}}else if(arguments.length===2){if(typeof arguments[1]==='function'){cb=arguments[1];if(typeof arguments[0]==='number'){byNumber=arguments[0];}else{subpath=arguments[0];}}else{subpath=arguments[0];byNumber=arguments[1];}}else{subpath=arguments[0];byNumber=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._increment(segments,byNumber,cb);};Model.prototype._increment=function(segments,byNumber,cb){segments=this._dereference(segments);if(byNumber==null)byNumber=1;var model=this;function increment(doc,docSegments,fnCb){var value=doc.increment(docSegments,byNumber,fnCb);var previous=value-byNumber;model.emit('change',segments,[value,previous,model._pass]);return value;}return this._mutate(segments,increment,cb);};Model.prototype.push=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._push(segments,value,cb);};Model.prototype._push=function(segments,value,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function push(doc,docSegments,fnCb){var length=doc.push(docSegments,value,fnCb);model.emit('insert',segments,[length-1,[value],model._pass]);return length;}return this._mutate(segments,push,cb);};Model.prototype.unshift=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._unshift(segments,value,cb);};Model.prototype._unshift=function(segments,value,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function unshift(doc,docSegments,fnCb){var length=doc.unshift(docSegments,value,fnCb);model.emit('insert',segments,[0,[value],model._pass]);return length;}return this._mutate(segments,unshift,cb);};Model.prototype.insert=function(){var subpath,index,values,cb;if(arguments.length<2){throw new Error('Not enough arguments for insert');}else if(arguments.length===2){index=arguments[0];values=arguments[1];}else if(arguments.length===3){subpath=arguments[0];index=arguments[1];values=arguments[2];}else{subpath=arguments[0];index=arguments[1];values=arguments[2];cb=arguments[3];}var segments=this._splitPath(subpath);return this._insert(segments,+index,values,cb);};Model.prototype._insert=function(segments,index,values,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function insert(doc,docSegments,fnCb){var inserted=Array.isArray(values)?values:[values];var length=doc.insert(docSegments,index,inserted,fnCb);model.emit('insert',segments,[index,inserted,model._pass]);return length;}return this._mutate(segments,insert,cb);};Model.prototype.pop=function(){var subpath,cb;if(arguments.length===1){if(typeof arguments[0]==='function'){cb=arguments[0];}else{subpath=arguments[0];}}else{subpath=arguments[0];cb=arguments[1];}var segments=this._splitPath(subpath);return this._pop(segments,cb);};Model.prototype._pop=function(segments,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function pop(doc,docSegments,fnCb){var arr=doc.get(docSegments);var length=arr&&arr.length;if(!length){fnCb();return;}var value=doc.pop(docSegments,fnCb);model.emit('remove',segments,[length-1,[value],model._pass]);return value;}return this._mutate(segments,pop,cb);};Model.prototype.shift=function(){var subpath,cb;if(arguments.length===1){if(typeof arguments[0]==='function'){cb=arguments[0];}else{subpath=arguments[0];}}else{subpath=arguments[0];cb=arguments[1];}var segments=this._splitPath(subpath);return this._shift(segments,cb);};Model.prototype._shift=function(segments,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);var model=this;function shift(doc,docSegments,fnCb){var arr=doc.get(docSegments);var length=arr&&arr.length;if(!length){fnCb();return;}var value=doc.shift(docSegments,fnCb);model.emit('remove',segments,[0,[value],model._pass]);return value;}return this._mutate(segments,shift,cb);};Model.prototype.remove=function(){var subpath,index,howMany,cb;if(arguments.length<2){index=arguments[0];}else if(arguments.length===2){if(typeof arguments[1]==='function'){cb=arguments[1];if(typeof arguments[0]==='number'){index=arguments[0];}else{subpath=arguments[0];}}else{// eslint-disable-next-line no-lonely-if
if(typeof arguments[0]==='number'){index=arguments[0];howMany=arguments[1];}else{subpath=arguments[0];index=arguments[1];}}}else if(arguments.length===3){if(typeof arguments[2]==='function'){cb=arguments[2];if(typeof arguments[0]==='number'){index=arguments[0];howMany=arguments[1];}else{subpath=arguments[0];index=arguments[1];}}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2];}}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2];cb=arguments[3];}var segments=this._splitPath(subpath);if(index==null)index=segments.pop();return this._remove(segments,+index,howMany,cb);};Model.prototype._remove=function(segments,index,howMany,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);if(howMany==null)howMany=1;var model=this;function remove(doc,docSegments,fnCb){var removed=doc.remove(docSegments,index,howMany,fnCb);model.emit('remove',segments,[index,removed,model._pass]);return removed;}return this._mutate(segments,remove,cb);};Model.prototype.move=function(){var subpath,from,to,howMany,cb;if(arguments.length<2){throw new Error('Not enough arguments for move');}else if(arguments.length===2){from=arguments[0];to=arguments[1];}else if(arguments.length===3){if(typeof arguments[2]==='function'){from=arguments[0];to=arguments[1];cb=arguments[2];}else if(typeof arguments[0]==='number'){from=arguments[0];to=arguments[1];howMany=arguments[2];}else{subpath=arguments[0];from=arguments[1];to=arguments[2];}}else if(arguments.length===4){if(typeof arguments[3]==='function'){cb=arguments[3];if(typeof arguments[0]==='number'){from=arguments[0];to=arguments[1];howMany=arguments[2];}else{subpath=arguments[0];from=arguments[1];to=arguments[2];}}else{subpath=arguments[0];from=arguments[1];to=arguments[2];howMany=arguments[3];}}else{subpath=arguments[0];from=arguments[1];to=arguments[2];howMany=arguments[3];cb=arguments[4];}var segments=this._splitPath(subpath);return this._move(segments,from,to,howMany,cb);};Model.prototype._move=function(segments,from,to,howMany,cb){var forArrayMutator=true;segments=this._dereference(segments,forArrayMutator);if(howMany==null)howMany=1;var model=this;function move(doc,docSegments,fnCb){// Cast to numbers
from=+from;to=+to;// Convert negative indices into positive
if(from<0||to<0){var len=doc.get(docSegments).length;if(from<0)from+=len;if(to<0)to+=len;}var moved=doc.move(docSegments,from,to,howMany,fnCb);model.emit('move',segments,[from,to,moved.length,model._pass]);return moved;}return this._mutate(segments,move,cb);};Model.prototype.stringInsert=function(){var subpath,index,text,cb;if(arguments.length<2){throw new Error('Not enough arguments for stringInsert');}else if(arguments.length===2){index=arguments[0];text=arguments[1];}else if(arguments.length===3){if(typeof arguments[2]==='function'){index=arguments[0];text=arguments[1];cb=arguments[2];}else{subpath=arguments[0];index=arguments[1];text=arguments[2];}}else{subpath=arguments[0];index=arguments[1];text=arguments[2];cb=arguments[3];}var segments=this._splitPath(subpath);return this._stringInsert(segments,index,text,cb);};Model.prototype._stringInsert=function(segments,index,text,cb){segments=this._dereference(segments);var model=this;function stringInsert(doc,docSegments,fnCb){var previous=doc.stringInsert(docSegments,index,text,fnCb);var value=doc.get(docSegments);var pass=model.pass({$stringInsert:{index:index,text:text}})._pass;model.emit('change',segments,[value,previous,pass]);return;}return this._mutate(segments,stringInsert,cb);};Model.prototype.stringRemove=function(){var subpath,index,howMany,cb;if(arguments.length<2){throw new Error('Not enough arguments for stringRemove');}else if(arguments.length===2){index=arguments[0];howMany=arguments[1];}else if(arguments.length===3){if(typeof arguments[2]==='function'){index=arguments[0];howMany=arguments[1];cb=arguments[2];}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2];}}else{subpath=arguments[0];index=arguments[1];howMany=arguments[2];cb=arguments[3];}var segments=this._splitPath(subpath);return this._stringRemove(segments,index,howMany,cb);};Model.prototype._stringRemove=function(segments,index,howMany,cb){segments=this._dereference(segments);var model=this;function stringRemove(doc,docSegments,fnCb){var previous=doc.stringRemove(docSegments,index,howMany,fnCb);var value=doc.get(docSegments);var pass=model.pass({$stringRemove:{index:index,howMany:howMany}})._pass;model.emit('change',segments,[value,previous,pass]);return;}return this._mutate(segments,stringRemove,cb);};Model.prototype.subtypeSubmit=function(){var subpath,subtype,subtypeOp,cb;if(arguments.length<2){throw new Error('Not enough arguments for subtypeSubmit');}else if(arguments.length===2){subtype=arguments[0];subtypeOp=arguments[1];}else if(arguments.length===3){if(typeof arguments[2]==='function'){subtype=arguments[0];subtypeOp=arguments[1];cb=arguments[2];}else{subpath=arguments[0];subtype=arguments[1];subtypeOp=arguments[2];}}else{subpath=arguments[0];subtype=arguments[1];subtypeOp=arguments[2];cb=arguments[3];}var segments=this._splitPath(subpath);return this._subtypeSubmit(segments,subtype,subtypeOp,cb);};Model.prototype._subtypeSubmit=function(segments,subtype,subtypeOp,cb){segments=this._dereference(segments);var model=this;function subtypeSubmit(doc,docSegments,fnCb){var previous=doc.subtypeSubmit(docSegments,subtype,subtypeOp,fnCb);var value=doc.get(docSegments);var pass=model.pass({$subtype:{type:subtype,op:subtypeOp}})._pass;// Emit undefined for the previous value, since we don't really know
// whether or not the previous value returned by the subtypeSubmit is the
// same object returned by reference or not. This may cause change
// listeners to over-trigger, but that is usually going to be better than
// under-triggering
model.emit('change',segments,[value,undefined,pass]);return previous;}return this._mutate(segments,subtypeSubmit,cb);};},{"../util":74,"./Model":55}],67:[function(require,module,exports){var Model=require('./Model');exports.mixin={};Model.prototype._splitPath=function(subpath){var path=this.path(subpath);return path&&path.split('.')||[];};/**
 * Returns the path equivalent to the path of the current scoped model plus
 * (optionally) a suffix subpath
 *
 * @optional @param {String} subpath
 * @return {String} absolute path
 * @api public
 */Model.prototype.path=function(subpath){if(subpath==null||subpath==='')return this._at?this._at:'';if(typeof subpath==='string'||typeof subpath==='number'){return this._at?this._at+'.'+subpath:''+subpath;}if(typeof subpath.path==='function')return subpath.path();};Model.prototype.isPath=function(subpath){return this.path(subpath)!=null;};Model.prototype.scope=function(path){if(arguments.length>1){for(var i=1;i<arguments.length;i++){path=path+'.'+arguments[i];}}return createScoped(this,path);};/**
 * Create a model object scoped to a particular path.
 * Example:
 *     var user = model.at('users.1');
 *     user.set('username', 'brian');
 *     user.on('push', 'todos', function(todo) {
 *       // ...
 *     });
 *
 *  @param {String} segment
 *  @return {Model} a scoped model
 *  @api public
 */Model.prototype.at=function(subpath){if(arguments.length>1){for(var i=1;i<arguments.length;i++){subpath=subpath+'.'+arguments[i];}}var path=this.path(subpath);return createScoped(this,path);};function createScoped(model,path){var scoped=model._child();scoped._at=path;return scoped;}/**
 * Returns a model scope that is a number of levels above the current scoped
 * path. Number of levels defaults to 1, so this method called without
 * arguments returns the model scope's parent model scope.
 *
 * @optional @param {Number} levels
 * @return {Model} a scoped model
 */Model.prototype.parent=function(levels){if(levels==null)levels=1;var segments=this._splitPath();var len=Math.max(0,segments.length-levels);var path=segments.slice(0,len).join('.');return this.scope(path);};/**
 * Returns the last property segment of the current model scope path
 *
 * @optional @param {String} path
 * @return {String}
 */Model.prototype.leaf=function(path){if(!path)path=this.path();var i=path.lastIndexOf('.');return path.slice(i+1);};},{"./Model":55}],68:[function(require,module,exports){var util=require('../util');var Model=require('./Model');Model.INITS.push(function(model){var root=model.root;root._refs=new Refs();addIndexListeners(root);addListener(root,'change',refChange);addListener(root,'load',refLoad);addListener(root,'unload',refUnload);addListener(root,'insert',refInsert);addListener(root,'remove',refRemove);addListener(root,'move',refMove);});function addIndexListeners(model){model.on('insertImmediate',function refInsertIndex(segments,eventArgs){var index=eventArgs[0];var howMany=eventArgs[1].length;function patchInsert(refIndex){return index<=refIndex?refIndex+howMany:refIndex;}onIndexChange(segments,patchInsert);});model.on('removeImmediate',function refRemoveIndex(segments,eventArgs){var index=eventArgs[0];var howMany=eventArgs[1].length;function patchRemove(refIndex){return index<=refIndex?refIndex-howMany:refIndex;}onIndexChange(segments,patchRemove);});model.on('moveImmediate',function refMoveIndex(segments,eventArgs){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];function patchMove(refIndex){// If the index was moved itself
if(from<=refIndex&&refIndex<from+howMany){return refIndex+to-from;}// Remove part of a move
if(from<=refIndex)refIndex-=howMany;// Insert part of a move
if(to<=refIndex)refIndex+=howMany;return refIndex;}onIndexChange(segments,patchMove);});function onIndexChange(segments,patch){var fromMap=model._refs.fromMap;for(var from in fromMap){var ref=fromMap[from];if(!(ref.updateIndices&&util.contains(segments,ref.toSegments)&&ref.toSegments.length>segments.length))continue;var index=+ref.toSegments[segments.length];var patched=patch(index);if(index===patched)continue;model._refs.remove(from);ref.toSegments[segments.length]=''+patched;ref.to=ref.toSegments.join('.');model._refs.add(ref);}}}function refChange(model,dereferenced,eventArgs,segments){var value=eventArgs[0];// Detect if we are deleting vs. setting to undefined
if(value===undefined){var parentSegments=segments.slice();var last=parentSegments.pop();var parent=model._get(parentSegments);if(!parent||!(last in parent)){model._del(dereferenced);return;}}model._set(dereferenced,value);}function refLoad(model,dereferenced,eventArgs){var value=eventArgs[0];model._set(dereferenced,value);}function refUnload(model,dereferenced){model._del(dereferenced);}function refInsert(model,dereferenced,eventArgs){var index=eventArgs[0];var values=eventArgs[1];model._insert(dereferenced,index,values);}function refRemove(model,dereferenced,eventArgs){var index=eventArgs[0];var howMany=eventArgs[1].length;model._remove(dereferenced,index,howMany);}function refMove(model,dereferenced,eventArgs){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];model._move(dereferenced,from,to,howMany);}function addListener(model,type,fn){model.on(type+'Immediate',refListener);function refListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];// Find cases where an event is emitted on a path where a reference
// is pointing. All original mutations happen on the fully dereferenced
// location, so this detection only needs to happen in one direction
var toMap=model._refs.toMap;var subpath;for(var i=0,len=segments.length;i<len;i++){subpath=subpath?subpath+'.'+segments[i]:segments[i];// If a ref is found pointing to a matching subpath, re-emit on the
// place where the reference is coming from as if the mutation also
// occured at that path
var refs=toMap[subpath];if(!refs)continue;// Shallow clone refs in case a ref is removed while going through
// the loop
refs=refs.slice();var remaining=segments.slice(i+1);for(var refIndex=0,numRefs=refs.length;refIndex<numRefs;refIndex++){var ref=refs[refIndex];var dereferenced=ref.fromSegments.concat(remaining);// The value may already be up to date via object reference. If so,
// simply re-emit the event. Otherwise, perform the same mutation on
// the ref's path
if(model._get(dereferenced)===model._get(segments)){model.emit(type,dereferenced,eventArgs);}else{var setterModel=ref.model.pass(pass,true);setterModel._dereference=noopDereference;fn(setterModel,dereferenced,eventArgs,segments);}}}// If a ref points to a child of a matching subpath, get the value in
// case it has changed and set if different
var parentToMap=model._refs.parentToMap;var refs=parentToMap[subpath];if(!refs)return;for(var refIndex=0,numRefs=refs.length;refIndex<numRefs;refIndex++){var ref=refs[refIndex];var value=model._get(ref.toSegments);var previous=model._get(ref.fromSegments);if(previous!==value){var setterModel=ref.model.pass(pass,true);setterModel._dereference=noopDereference;setterModel._set(ref.fromSegments,value);}}}}Model.prototype._canRefTo=function(value){return this.isPath(value)||value&&typeof value.ref==='function';};Model.prototype.ref=function(){var from,to,options;if(arguments.length===1){to=arguments[0];}else if(arguments.length===2){if(this._canRefTo(arguments[1])){from=arguments[0];to=arguments[1];}else{to=arguments[0];options=arguments[1];}}else{from=arguments[0];to=arguments[1];options=arguments[2];}var fromPath=this.path(from);var toPath=this.path(to);// Make ref to reffable object, such as query or filter
if(!toPath)return to.ref(fromPath);var ref=new Ref(this.root,fromPath,toPath,options);if(ref.fromSegments.length<2){throw new Error('ref must be performed under a collection '+'and document id. Invalid path: '+fromPath);}this.root._refs.remove(fromPath);this.root._refLists.remove(fromPath);var value=this.get(to);ref.model._set(ref.fromSegments,value);this.root._refs.add(ref);return this.scope(fromPath);};Model.prototype.removeRef=function(subpath){var segments=this._splitPath(subpath);var fromPath=segments.join('.');this._removeRef(segments,fromPath);};Model.prototype._removeRef=function(segments,fromPath){this.root._refs.remove(fromPath);this.root._refLists.remove(fromPath);this._del(segments);};Model.prototype.removeAllRefs=function(subpath){var segments=this._splitPath(subpath);this._removeAllRefs(segments);};Model.prototype._removeAllRefs=function(segments){this._removeMapRefs(segments,this.root._refs.fromMap);this._removeMapRefs(segments,this.root._refLists.fromMap);};Model.prototype._removeMapRefs=function(segments,map){for(var from in map){var fromSegments=map[from].fromSegments;if(util.contains(segments,fromSegments)){this._removeRef(fromSegments,from);}}};Model.prototype.dereference=function(subpath){var segments=this._splitPath(subpath);return this._dereference(segments).join('.');};Model.prototype._dereference=function(segments,forArrayMutator,ignore){if(segments.length===0)return segments;var refs=this.root._refs.fromMap;var refLists=this.root._refLists.fromMap;var doAgain;do{var subpath='';doAgain=false;for(var i=0,len=segments.length;i<len;i++){subpath=subpath?subpath+'.'+segments[i]:segments[i];var ref=refs[subpath];if(ref){var remaining=segments.slice(i+1);segments=ref.toSegments.concat(remaining);doAgain=true;break;}var refList=refLists[subpath];if(refList&&refList!==ignore){var belowDescendant=i+2<len;var belowChild=i+1<len;if(!(belowDescendant||forArrayMutator&&belowChild))continue;segments=refList.dereference(segments,i);doAgain=true;break;}}}while(doAgain);// If a dereference fails, return a path that will result in a null value
// instead of a path to everything in the model
if(segments.length===0)return['$null'];return segments;};function noopDereference(segments){return segments;}function Ref(model,from,to,options){this.model=model&&model.pass({$ref:this});this.from=from;this.to=to;this.fromSegments=from.split('.');this.toSegments=to.split('.');this.parentTos=[];for(var i=1,len=this.toSegments.length;i<len;i++){var parentTo=this.toSegments.slice(0,i).join('.');this.parentTos.push(parentTo);}this.updateIndices=options&&options.updateIndices;}function FromMap(){}function ToMap(){}function Refs(){this.fromMap=new FromMap();this.toMap=new ToMap();this.parentToMap=new ToMap();}Refs.prototype.add=function(ref){this.fromMap[ref.from]=ref;listMapAdd(this.toMap,ref.to,ref);for(var i=0,len=ref.parentTos.length;i<len;i++){listMapAdd(this.parentToMap,ref.parentTos[i],ref);}};Refs.prototype.remove=function(from){var ref=this.fromMap[from];if(!ref)return;delete this.fromMap[from];listMapRemove(this.toMap,ref.to,ref);for(var i=0,len=ref.parentTos.length;i<len;i++){listMapRemove(this.parentToMap,ref.parentTos[i],ref);}return ref;};Refs.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var ref=this.fromMap[from];out.push([ref.from,ref.to]);}return out;};function listMapAdd(map,name,item){map[name]||(map[name]=[]);map[name].push(item);}function listMapRemove(map,name,item){var items=map[name];if(!items)return;var index=items.indexOf(item);if(index===-1)return;items.splice(index,1);if(!items.length)delete map[name];}},{"../util":74,"./Model":55}],69:[function(require,module,exports){var util=require('../util');var Model=require('./Model');Model.INITS.push(function(model){var root=model.root;root._refLists=new RefLists();for(var type in Model.MUTATOR_EVENTS){addListener(root,type);}});function addListener(model,type){model.on(type+'Immediate',refListListener);function refListListener(segments,eventArgs){var pass=eventArgs[eventArgs.length-1];// Check for updates on or underneath paths
var fromMap=model._refLists.fromMap;for(var from in fromMap){var refList=fromMap[from];if(pass.$refList===refList)continue;refList.onMutation(type,segments,eventArgs);}}}/**
 * @param {String} type
 * @param {Array} segments
 * @param {Array} eventArgs
 * @param {RefList} refList
 */function patchFromEvent(type,segments,eventArgs,refList){var fromLength=refList.fromSegments.length;var segmentsLength=segments.length;var pass=eventArgs[eventArgs.length-1];var model=refList.model.pass(pass,true);// Mutation on the `from` output itself
if(segmentsLength===fromLength){if(type==='insert'){var index=eventArgs[0];var values=eventArgs[1];var ids=setNewToValues(model,refList,values);model._insert(refList.idsSegments,index,ids);return;}if(type==='remove'){var index=eventArgs[0];var howMany=eventArgs[1].length;var ids=model._remove(refList.idsSegments,index,howMany);// Delete the appropriate items underneath `to` if the `deleteRemoved`
// option was set true
if(refList.deleteRemoved){for(var i=0;i<ids.length;i++){var item=refList.itemById(ids[i]);model._del(refList.toSegmentsByItem(item));}}return;}if(type==='move'){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];model._move(refList.idsSegments,from,to,howMany);return;}// Change of the entire output
var values=type==='change'?eventArgs[0]:model._get(refList.fromSegments);// Set ids to empty list if output is set to null
if(!values){model._set(refList.idsSegments,[]);return;}// If the entire output is set, create a list of ids based on the output,
// and update the corresponding items
var ids=setNewToValues(model,refList,values);model._set(refList.idsSegments,ids);return;}// If mutation is on a parent of `from`, we might need to re-create the
// entire refList output
if(segmentsLength<fromLength){model._setArrayDiff(refList.fromSegments,refList.get());return;}var index=segments[fromLength];var value=model._get(refList.fromSegments.concat(index));var toSegments=refList.toSegmentsByItem(value);// Mutation underneath a child of the `from` object.
if(segmentsLength>fromLength+1){throw new Error('Mutation on descendant of refList `from`'+' should have been dereferenced: '+segments.join('.'));}// Otherwise, mutation of a child of the `from` object
// If changing the item itself, it will also have to be re-set on the
// original object
if(type==='change'){model._set(toSegments,value);updateIdForValue(model,refList,index,value);return;}if(type==='insert'||type==='remove'||type==='move'){throw new Error('Array mutation on child of refList `from`'+'should have been dereferenced: '+segments.join('.'));}}/**
 * @private
 * @param {Model} model
 * @param {RefList} refList
 * @param {Array} values
 */function setNewToValues(model,refList,values){var ids=[];for(var i=0;i<values.length;i++){var value=values[i];var id=refList.idByItem(value);if(id===undefined&&_typeof(value)==='object'){id=value.id=model.id();}var toSegments=refList.toSegmentsByItem(value);if(id===undefined||toSegments===undefined){throw new Error('Unable to add item to refList: '+value);}if(model._get(toSegments)!==value){model._set(toSegments,value);}ids.push(id);}return ids;}function updateIdForValue(model,refList,index,value){var id=refList.idByItem(value);var outSegments=refList.idsSegments.concat(index);model._set(outSegments,id);}function patchToEvent(type,segments,eventArgs,refList){var toLength=refList.toSegments.length;var segmentsLength=segments.length;var pass=eventArgs[eventArgs.length-1];var model=refList.model.pass(pass,true);// Mutation on the `to` object itself
if(segmentsLength===toLength){if(type==='insert'){var values=eventArgs[1];for(var i=0;i<values.length;i++){var value=values[i];var indices=refList.indicesByItem(value);if(!indices)continue;for(var j=0;j<indices.length;j++){var outSegments=refList.fromSegments.concat(indices[j]);model._set(outSegments,value);}}return;}if(type==='remove'){var removeIndex=eventArgs[0];var values=eventArgs[1];var howMany=values.length;for(var i=removeIndex,len=removeIndex+howMany;i<len;i++){var indices=refList.indicesByItem(values[i]);if(!indices)continue;for(var j=0,indicesLen=indices.length;j<indicesLen;j++){var outSegments=refList.fromSegments.concat(indices[j]);model._set(outSegments,undefined);}}return;}if(type==='move'){// Moving items in the `to` object should have no effect on the output
return;}}// Mutation on or above the `to` object
if(segmentsLength<=toLength){// If the entire `to` object is updated, we need to re-create the
// entire refList output and apply what is different
model._setArrayDiff(refList.fromSegments,refList.get());return;}// Mutation underneath a child of the `to` object. The item will already
// be up to date, since it is under an object reference. Just re-emit
if(segmentsLength>toLength+1){var value=model._get(segments.slice(0,toLength+1));var indices=refList.indicesByItem(value);if(!indices)return;var remaining=segments.slice(toLength+1);for(var i=0;i<indices.length;i++){var index=indices[i];var dereferenced=refList.fromSegments.concat(index,remaining);dereferenced=model._dereference(dereferenced,null,refList);eventArgs=eventArgs.slice();eventArgs[eventArgs.length-1]=model._pass;model.emit(type,dereferenced,eventArgs);}return;}// Otherwise, mutation of a child of the `to` object
// If changing the item itself, it will also have to be re-set on the
// array created by the refList
if(type==='change'||type==='load'||type==='unload'){var value,previous;if(type==='change'){value=eventArgs[0];previous=eventArgs[1];}else if(type==='load'){value=eventArgs[0];previous=undefined;}else if(type==='unload'){value=undefined;previous=eventArgs[0];}var newIndices=refList.indicesByItem(value);var oldIndices=refList.indicesByItem(previous);if(!newIndices&&!oldIndices)return;if(oldIndices&&!equivalentArrays(oldIndices,newIndices)){// The changed item used to refer to some indices, but no longer does
for(var i=0;i<oldIndices.length;i++){var outSegments=refList.fromSegments.concat(oldIndices[i]);model._set(outSegments,undefined);}}if(newIndices){for(var i=0;i<newIndices.length;i++){var outSegments=refList.fromSegments.concat(newIndices[i]);model._set(outSegments,value);}}return;}var value=model._get(segments.slice(0,toLength+1));var indices=refList.indicesByItem(value);if(!indices)return;if(type==='insert'||type==='remove'||type==='move'){// Array mutations will have already been updated via an object
// reference, so only re-emit
for(var i=0;i<indices.length;i++){var dereferenced=refList.fromSegments.concat(indices[i]);dereferenced=model._dereference(dereferenced,null,refList);eventArgs=eventArgs.slice();eventArgs[eventArgs.length-1]=model._pass;model.emit(type,dereferenced,eventArgs);}}}function equivalentArrays(a,b){if(!a||!b)return false;if(a.length!==b.length)return false;for(var i=0;i<a.length;i++){if(a[i]!==b[i])return false;}return true;}function patchIdsEvent(type,segments,eventArgs,refList){var idsLength=refList.idsSegments.length;var segmentsLength=segments.length;var pass=eventArgs[eventArgs.length-1];var model=refList.model.pass(pass,true);// An array mutation of the ids should be mirrored with a like change in
// the output array
if(segmentsLength===idsLength){if(type==='insert'){var index=eventArgs[0];var inserted=eventArgs[1];var values=[];for(var i=0;i<inserted.length;i++){var value=refList.itemById(inserted[i]);values.push(value);}model._insert(refList.fromSegments,index,values);return;}if(type==='remove'){var index=eventArgs[0];var howMany=eventArgs[1].length;model._remove(refList.fromSegments,index,howMany);return;}if(type==='move'){var from=eventArgs[0];var to=eventArgs[1];var howMany=eventArgs[2];model._move(refList.fromSegments,from,to,howMany);return;}}// Mutation on the `ids` list itself
if(segmentsLength<=idsLength){// If the entire `ids` array is updated, we need to re-create the
// entire refList output and apply what is different
model._setArrayDiff(refList.fromSegments,refList.get());return;}// Otherwise, direct mutation of a child in the `ids` object or mutation
// underneath an item in the `ids` list. Update the item for the appropriate
// id if it has changed
var index=segments[idsLength];var id=refList.idByIndex(index);var item=refList.itemById(id);var itemSegments=refList.fromSegments.concat(index);if(model._get(itemSegments)!==item){model._set(itemSegments,item);}}Model.prototype.refList=function(){var from,to,ids,options;if(arguments.length===2){to=arguments[0];ids=arguments[1];}else if(arguments.length===3){if(this.isPath(arguments[2])){from=arguments[0];to=arguments[1];ids=arguments[2];}else{to=arguments[0];ids=arguments[1];options=arguments[2];}}else{from=arguments[0];to=arguments[1];ids=arguments[2];options=arguments[3];}var fromPath=this.path(from);var toPath;if(Array.isArray(to)){toPath=[];for(var i=0;i<to.length;i++){toPath.push(this.path(to[i]));}}else{toPath=this.path(to);}var idsPath=this.path(ids);var refList=new RefList(this.root,fromPath,toPath,idsPath,options);this.root._refLists.remove(fromPath);refList.model._setArrayDiff(refList.fromSegments,refList.get());this.root._refLists.add(refList);return this.scope(fromPath);};function RefList(model,from,to,ids,options){this.model=model&&model.pass({$refList:this});this.from=from;this.to=to;this.ids=ids;this.fromSegments=from&&from.split('.');this.toSegments=to&&to.split('.');this.idsSegments=ids&&ids.split('.');this.options=options;this.deleteRemoved=options&&options.deleteRemoved;}// The default implementation assumes that the ids array is a flat list of
// keys on the to object. Ideally, this mapping could be customized via
// inheriting from RefList and overriding these methods without having to
// modify the above event handling code.
//
// In the default refList implementation, `key` and `id` are equal.
//
// Terms in the below methods:
//   `item`  - Object on the `to` path, which gets mirrored on the `from` path
//   `key`   - The property under `to` at which an item is located
//   `id`    - String or object in the array at the `ids` path
//   `index` - The index of an id, which corresponds to an index on `from`
RefList.prototype.get=function(){var ids=this.model._get(this.idsSegments);if(!ids)return[];var items=this.model._get(this.toSegments);var out=[];for(var i=0;i<ids.length;i++){var key=ids[i];out.push(items&&items[key]);}return out;};RefList.prototype.dereference=function(segments,i){var remaining=segments.slice(i+1);var key=this.idByIndex(remaining[0]);if(key==null)return[];remaining[0]=key;return this.toSegments.concat(remaining);};RefList.prototype.toSegmentsByItem=function(item){var key=this.idByItem(item);if(key===undefined)return;return this.toSegments.concat(key);};RefList.prototype.idByItem=function(item){if(item&&item.id)return item.id;var items=this.model._get(this.toSegments);for(var key in items){if(item===items[key])return key;}};RefList.prototype.indicesByItem=function(item){var id=this.idByItem(item);var ids=this.model._get(this.idsSegments);if(!ids)return;var indices;var index=-1;for(;;){index=ids.indexOf(id,index+1);if(index===-1)break;if(indices){indices.push(index);}else{indices=[index];}}return indices;};RefList.prototype.itemById=function(id){return this.model._get(this.toSegments.concat(id));};RefList.prototype.idByIndex=function(index){return this.model._get(this.idsSegments.concat(index));};RefList.prototype.onMutation=function(type,segments,eventArgs){if(util.mayImpact(this.toSegments,segments)){patchToEvent(type,segments,eventArgs,this);}else if(util.mayImpact(this.idsSegments,segments)){patchIdsEvent(type,segments,eventArgs,this);}else if(util.mayImpact(this.fromSegments,segments)){patchFromEvent(type,segments,eventArgs,this);}};function FromMap(){}function RefLists(){this.fromMap=new FromMap();}RefLists.prototype.add=function(refList){this.fromMap[refList.from]=refList;};RefLists.prototype.remove=function(from){var refList=this.fromMap[from];delete this.fromMap[from];return refList;};RefLists.prototype.toJSON=function(){var out=[];for(var from in this.fromMap){var refList=this.fromMap[from];out.push([refList.from,refList.to,refList.ids,refList.options]);}return out;};},{"../util":74,"./Model":55}],70:[function(require,module,exports){var util=require('../util');var Model=require('./Model');var arrayDiff=require('arraydiff');Model.prototype.setDiff=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._setDiff(segments,value,cb);};Model.prototype._setDiff=function(segments,value,cb){segments=this._dereference(segments);var model=this;function setDiff(doc,docSegments,fnCb){var previous=doc.get(docSegments);if(util.equal(previous,value)){fnCb();return previous;}doc.set(docSegments,value,fnCb);model.emit('change',segments,[value,previous,model._pass]);return previous;}return this._mutate(segments,setDiff,cb);};Model.prototype.setDiffDeep=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._setDiffDeep(segments,value,cb);};Model.prototype._setDiffDeep=function(segments,value,cb){var before=this._get(segments);cb=this.wrapCallback(cb);var group=util.asyncGroup(cb);var finished=group();diffDeep(this,segments,before,value,group);finished();};function diffDeep(model,segments,before,after,group){if(_typeof(before)!=='object'||!before||_typeof(after)!=='object'||!after){// Diff the entire value if not diffable objects
model._setDiff(segments,after,group());return;}if(Array.isArray(before)&&Array.isArray(after)){var diff=arrayDiff(before,after,util.deepEqual);if(!diff.length)return;// If the only change is a single item replacement, diff the item instead
if(diff.length===2&&diff[0].index===diff[1].index&&diff[0]instanceof arrayDiff.RemoveDiff&&diff[0].howMany===1&&diff[1]instanceof arrayDiff.InsertDiff&&diff[1].values.length===1){var index=diff[0].index;var itemSegments=segments.concat(index);diffDeep(model,itemSegments,before[index],after[index],group);return;}model._applyArrayDiff(segments,diff,group());return;}// Delete keys that were in before but not after
for(var key in before){if(key in after)continue;var itemSegments=segments.concat(key);model._del(itemSegments,group());}// Diff each property in after
for(var key in after){if(util.deepEqual(before[key],after[key]))continue;var itemSegments=segments.concat(key);diffDeep(model,itemSegments,before[key],after[key],group);}}Model.prototype.setArrayDiff=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._setArrayDiff(segments,value,cb);};Model.prototype.setArrayDiffDeep=function(){var subpath,value,cb;if(arguments.length===1){value=arguments[0];}else if(arguments.length===2){subpath=arguments[0];value=arguments[1];}else{subpath=arguments[0];value=arguments[1];cb=arguments[2];}var segments=this._splitPath(subpath);return this._setArrayDiffDeep(segments,value,cb);};Model.prototype._setArrayDiffDeep=function(segments,value,cb){return this._setArrayDiff(segments,value,cb,util.deepEqual);};Model.prototype._setArrayDiff=function(segments,value,cb,_equalFn){var before=this._get(segments);if(before===value)return this.wrapCallback(cb)();if(!Array.isArray(before)||!Array.isArray(value)){this._set(segments,value,cb);return;}var diff=arrayDiff(before,value,_equalFn);this._applyArrayDiff(segments,diff,cb);};Model.prototype._applyArrayDiff=function(segments,diff,cb){if(!diff.length)return this.wrapCallback(cb)();segments=this._dereference(segments);var model=this;function applyArrayDiff(doc,docSegments,fnCb){var group=util.asyncGroup(fnCb);for(var i=0,len=diff.length;i<len;i++){var item=diff[i];if(item instanceof arrayDiff.InsertDiff){// Insert
doc.insert(docSegments,item.index,item.values,group());model.emit('insert',segments,[item.index,item.values,model._pass]);}else if(item instanceof arrayDiff.RemoveDiff){// Remove
var removed=doc.remove(docSegments,item.index,item.howMany,group());model.emit('remove',segments,[item.index,removed,model._pass]);}else if(item instanceof arrayDiff.MoveDiff){// Move
var moved=doc.move(docSegments,item.from,item.to,item.howMany,group());model.emit('move',segments,[item.from,item.to,moved.length,model._pass]);}}}return this._mutate(segments,applyArrayDiff,cb);};},{"../util":74,"./Model":55,"arraydiff":2}],71:[function(require,module,exports){(function(process){var util=require('../util');var Model=require('./Model');var Query=require('./Query');var CollectionCounter=require('./CollectionCounter');Model.INITS.push(function(model,options){model.root.fetchOnly=options.fetchOnly;model.root.unloadDelay=options.unloadDelay||util.isServer?0:1000;// Track the total number of active fetches per doc
model.root._fetchedDocs=new CollectionCounter();// Track the total number of active susbscribes per doc
model.root._subscribedDocs=new CollectionCounter();});Model.prototype.fetch=function(){this._forSubscribable(arguments,'fetch');return this;};Model.prototype.unfetch=function(){this._forSubscribable(arguments,'unfetch');return this;};Model.prototype.subscribe=function(){this._forSubscribable(arguments,'subscribe');return this;};Model.prototype.unsubscribe=function(){this._forSubscribable(arguments,'unsubscribe');return this;};Model.prototype._forSubscribable=function(argumentsObject,method){var args,cb;if(!argumentsObject.length){// Use this model's scope if no arguments
args=[null];}else if(typeof argumentsObject[0]==='function'){// Use this model's scope if the first argument is a callback
args=[null];cb=argumentsObject[0];}else if(Array.isArray(argumentsObject[0])){// Items can be passed in as an array
args=argumentsObject[0];cb=argumentsObject[1];}else{// Or as multiple arguments
args=Array.prototype.slice.call(argumentsObject);var last=args[args.length-1];if(typeof last==='function')cb=args.pop();}var group=util.asyncGroup(this.wrapCallback(cb));var finished=group();var docMethod=method+'Doc';this.root.connection.startBulk();for(var i=0;i<args.length;i++){var item=args[i];if(item instanceof Query){item[method](group());}else{var segments=this._dereference(this._splitPath(item));if(segments.length===2){// Do the appropriate method for a single document.
this[docMethod](segments[0],segments[1],group());}else{var message='Cannot '+method+' to path: '+segments.join('.');group()(new Error(message));}}}this.root.connection.endBulk();process.nextTick(finished);};Model.prototype.fetchDoc=function(collectionName,id,cb){cb=this.wrapCallback(cb);// Maintain a count of fetches so that we can unload the document
// when there are no remaining fetches or subscribes for that document
this._context.fetchDoc(collectionName,id);this.root._fetchedDocs.increment(collectionName,id);// Fetch
var doc=this.getOrCreateDoc(collectionName,id);doc.shareDoc.fetch(cb);};Model.prototype.subscribeDoc=function(collectionName,id,cb){cb=this.wrapCallback(cb);// Maintain a count of subscribes so that we can unload the document
// when there are no remaining fetches or subscribes for that document
this._context.subscribeDoc(collectionName,id);this.root._subscribedDocs.increment(collectionName,id);var doc=this.getOrCreateDoc(collectionName,id);// Early return if we know we are already subscribed
if(doc.shareDoc.subscribed){return cb();}// Subscribe
if(this.root.fetchOnly){doc.shareDoc.fetch(cb);}else{doc.shareDoc.subscribe(cb);}};Model.prototype.unfetchDoc=function(collectionName,id,cb){cb=this.wrapCallback(cb);this._context.unfetchDoc(collectionName,id);// No effect if the document is not currently fetched
if(!this.root._fetchedDocs.get(collectionName,id))return cb();var model=this;if(this.root.unloadDelay){setTimeout(finishUnfetchDoc,this.root.unloadDelay);}else{finishUnfetchDoc();}function finishUnfetchDoc(){var count=model.root._fetchedDocs.decrement(collectionName,id);if(count)return cb(null,count);model._maybeUnloadDoc(collectionName,id);cb(null,0);}};Model.prototype.unsubscribeDoc=function(collectionName,id,cb){cb=this.wrapCallback(cb);this._context.unsubscribeDoc(collectionName,id);// No effect if the document is not currently subscribed
if(!this.root._subscribedDocs.get(collectionName,id))return cb();var model=this;if(this.root.unloadDelay){setTimeout(finishUnsubscribeDoc,this.root.unloadDelay);}else{finishUnsubscribeDoc();}function finishUnsubscribeDoc(){var count=model.root._subscribedDocs.decrement(collectionName,id);// If there are more remaining subscriptions, only decrement the count
// and callback with how many subscriptions are remaining
if(count)return cb(null,count);// If there is only one remaining subscription, actually unsubscribe
if(model.root.fetchOnly){unsubscribeDocCallback();}else{var doc=model.getDoc(collectionName,id);var shareDoc=doc&&doc.shareDoc;if(!shareDoc)return unsubscribeDocCallback();shareDoc.unsubscribe(unsubscribeDocCallback);}}function unsubscribeDocCallback(err){model._maybeUnloadDoc(collectionName,id);if(err)return cb(err);cb(null,0);}};// Removes the document from the local model if the model no longer has any
// remaining fetches or subscribes via a query or direct loading
Model.prototype._maybeUnloadDoc=function(collectionName,id){var doc=this.getDoc(collectionName,id);if(!doc)return;// If there is a query or direct fetch or subscribe that is holding reference
// to this doc, leave it loaded
if(this._hasDocReferences(collectionName,id))return;// Calling sharedDoc.destroy() will remove it from the connection only when
// there aren't any operations, fetches, or subscribes pending on the doc.
// Thus, if we remove the doc from Racer's model but don't remove it from
// ShareDB, we can end up with an inconsistent state, with the data existing
// in ShareDB not reflected in the racer model data
if(doc.shareDoc&&doc.shareDoc.hasPending())return;var previous=doc.get();// Remove doc from Racer
this.root.collections[collectionName].remove(id);// Remove doc from Share
if(doc.shareDoc)doc.shareDoc.destroy();this.emit('unload',[collectionName,id],[previous,this._pass]);};Model.prototype._hasDocReferences=function(collectionName,id){// Check if any fetched or subscribed queries currently have the
// id in their results
var queries=this.root._queries.collections[collectionName];if(queries){for(var hash in queries){var query=queries[hash];if(!query.subscribeCount&&!query.fetchCount)continue;if(query.idMap[id]>0)return true;}}// Check if document currently has direct fetch or subscribe
if(this.root._fetchedDocs.get(collectionName,id)||this.root._subscribedDocs.get(collectionName,id))return true;return false;};}).call(this,require('_process'));},{"../util":74,"./CollectionCounter":52,"./Model":55,"./Query":56,"_process":40}],72:[function(require,module,exports){var Model=require('./Model');Model.prototype.unbundle=function(data){if(this.connection)this.connection.startBulk();// Re-create and subscribe queries; re-create documents associated with queries
this._initQueries(data.queries);// Re-create other documents
for(var collectionName in data.collections){var collection=data.collections[collectionName];for(var id in collection){this.getOrCreateDoc(collectionName,id,collection[id]);}}for(var contextId in data.contexts){var contextData=data.contexts[contextId];var contextModel=this.context(contextId);// Re-init fetchedDocs counts
for(var collectionName in contextData.fetchedDocs){var collection=contextData.fetchedDocs[collectionName];for(var id in collection){var count=collection[id];while(count--){contextModel._context.fetchDoc(collectionName,id);this._fetchedDocs.increment(collectionName,id);}}}// Subscribe to document subscriptions
for(var collectionName in contextData.subscribedDocs){var collection=contextData.subscribedDocs[collectionName];for(var id in collection){var count=collection[id];while(count--){contextModel.subscribeDoc(collectionName,id);}}}// Re-init createdDocs counts
for(var collectionName in contextData.createdDocs){var collection=contextData.createdDocs[collectionName];for(var id in collection){// Count value doesn't matter for tracking creates
contextModel._context.createDoc(collectionName,id);}}}if(this.connection)this.connection.endBulk();// Re-create refs
for(var i=0;i<data.refs.length;i++){var item=data.refs[i];this.ref(item[0],item[1]);}// Re-create refLists
for(var i=0;i<data.refLists.length;i++){var item=data.refLists[i];this.refList(item[0],item[1],item[2],item[3]);}// Re-create fns
for(var i=0;i<data.fns.length;i++){var item=data.fns[i];this.start.apply(this,item);}// Re-create filters
for(var i=0;i<data.filters.length;i++){var item=data.filters[i];var filter=this._filters.add(item[1],item[2],item[3],item[4],item[5]);filter.ref(item[0]);}};},{"./Model":55}],73:[function(require,module,exports){var EventEmitter=require('events').EventEmitter;var Model=require('./Model');var util=require('./util');module.exports=Racer;function Racer(){EventEmitter.call(this);}util.mergeInto(Racer.prototype,EventEmitter.prototype);// Make classes accessible for use by plugins and tests
Racer.prototype.Model=Model;Racer.prototype.util=util;// Support plugins on racer instances
Racer.prototype.use=util.use;Racer.prototype.serverUse=util.serverUse;Racer.prototype.createModel=function(data){var model=new Model();if(data){model.createConnection(data);model.unbundle(data);}return model;};util.serverRequire(module,'./Racer.server');},{"./Model":65,"./util":74,"events":33}],74:[function(require,module,exports){(function(process){var deepEqual=require('fast-deep-equal');var isServer=process.title!=='browser';exports.isServer=isServer;exports.asyncGroup=asyncGroup;exports.castSegments=castSegments;exports.contains=contains;exports.copy=copy;exports.copyObject=copyObject;exports.deepCopy=deepCopy;exports.deepEqual=deepEqual;exports.equal=equal;exports.equalsNaN=equalsNaN;exports.isArrayIndex=isArrayIndex;exports.lookup=lookup;exports.mergeInto=mergeInto;exports.mayImpact=mayImpact;exports.mayImpactAny=mayImpactAny;exports.serverRequire=serverRequire;exports.serverUse=serverUse;exports.use=use;function asyncGroup(cb){var group=new AsyncGroup(cb);return function asyncGroupAdd(){return group.add();};}/**
 * @constructor
 * @param {Function} cb(err)
 */function AsyncGroup(cb){this.cb=cb;this.isDone=false;this.count=0;}AsyncGroup.prototype.add=function(){this.count++;var self=this;return function(err){self.count--;if(self.isDone)return;if(err){self.isDone=true;self.cb(err);return;}if(self.count>0)return;self.isDone=true;self.cb();};};/**
 * @param {Array<string | number>} segments
 * @return {Array<string | number>}
 */function castSegments(segments){// Cast number path segments from strings to numbers
for(var i=segments.length;i--;){var segment=segments[i];if(typeof segment==='string'&&isArrayIndex(segment)){segments[i]=+segment;}}return segments;}function contains(segments,testSegments){for(var i=0;i<segments.length;i++){if(segments[i]!==testSegments[i])return false;}return true;}function copy(value){if(value instanceof Date)return new Date(value);if(_typeof(value)==='object'){if(value===null)return null;if(Array.isArray(value))return value.slice();return copyObject(value);}return value;}function copyObject(object){var out=new object.constructor();for(var key in object){if(object.hasOwnProperty(key)){out[key]=object[key];}}return out;}function deepCopy(value){if(value instanceof Date)return new Date(value);if(_typeof(value)==='object'){if(value===null)return null;if(Array.isArray(value)){var array=[];for(var i=value.length;i--;){array[i]=deepCopy(value[i]);}return array;}var object=new value.constructor();for(var key in value){if(value.hasOwnProperty(key)){object[key]=deepCopy(value[key]);}}return object;}return value;}function equal(a,b){return a===b||equalsNaN(a)&&equalsNaN(b);}function equalsNaN(x){// eslint-disable-next-line no-self-compare
return x!==x;}function isArrayIndex(segment){return /^[0-9]+$/.test(segment);}function lookup(segments,value){if(!segments)return value;for(var i=0,len=segments.length;i<len;i++){if(value==null)return value;value=value[segments[i]];}return value;}function mayImpactAny(segmentsList,testSegments){for(var i=0,len=segmentsList.length;i<len;i++){if(mayImpact(segmentsList[i],testSegments))return true;}return false;}function mayImpact(segments,testSegments){var len=Math.min(segments.length,testSegments.length);for(var i=0;i<len;i++){if(segments[i]!==testSegments[i])return false;}return true;}function mergeInto(to,from){for(var key in from){to[key]=from[key];}return to;}function serverRequire(module,id){if(!isServer)return;return module.require(id);}function serverUse(module,id,options){if(!isServer)return this;var plugin=module.require(id);return this.use(plugin,options);}function use(plugin,options){// Don't include a plugin more than once
var plugins=this._plugins||(this._plugins=[]);if(plugins.indexOf(plugin)===-1){plugins.push(plugin);plugin(this,options);}return this;}}).call(this,require('_process'));},{"_process":40,"fast-deep-equal":34}],75:[function(require,module,exports){if(typeof require==='function'){var serializeObject=require('serialize-object');}// UPDATE_PROPERTIES map HTML attribute names to an Element DOM property that
// should be used for setting on bindings updates instead of setAttribute.
//
// https://github.com/jquery/jquery/blob/1.x-master/src/attributes/prop.js
// https://github.com/jquery/jquery/blob/master/src/attributes/prop.js
// http://webbugtrack.blogspot.com/2007/08/bug-242-setattribute-doesnt-always-work.html
var BOOLEAN_PROPERTIES={checked:'checked',disabled:'disabled',readonly:'readOnly',selected:'selected'};var INTEGER_PROPERTIES={colspan:'colSpan',maxlength:'maxLength',rowspan:'rowSpan',tabindex:'tabIndex'};var STRING_PROPERTIES={cellpadding:'cellPadding',cellspacing:'cellSpacing','class':'className',contenteditable:'contentEditable',enctype:'encoding','for':'htmlFor',frameborder:'frameBorder',id:'id',title:'title',type:'type',usemap:'useMap',value:'value'};var UPDATE_PROPERTIES={};mergeInto(BOOLEAN_PROPERTIES,UPDATE_PROPERTIES);mergeInto(INTEGER_PROPERTIES,UPDATE_PROPERTIES);mergeInto(STRING_PROPERTIES,UPDATE_PROPERTIES);// CREATE_PROPERTIES map HTML attribute names to an Element DOM property that
// should be used for setting on Element rendering instead of setAttribute.
// input.defaultChecked and input.defaultValue affect the attribute, so we want
// to use these for initial dynamic rendering. For binding updates,
// input.checked and input.value are modified.
var CREATE_PROPERTIES={};mergeInto(UPDATE_PROPERTIES,CREATE_PROPERTIES);CREATE_PROPERTIES.checked='defaultChecked';CREATE_PROPERTIES.value='defaultValue';// http://www.w3.org/html/wg/drafts/html/master/syntax.html#void-elements
var VOID_ELEMENTS={area:true,base:true,br:true,col:true,embed:true,hr:true,img:true,input:true,keygen:true,link:true,menuitem:true,meta:true,param:true,source:true,track:true,wbr:true};var NAMESPACE_URIS={svg:'http://www.w3.org/2000/svg',xlink:'http://www.w3.org/1999/xlink',xmlns:'http://www.w3.org/2000/xmlns/'};exports.CREATE_PROPERTIES=CREATE_PROPERTIES;exports.BOOLEAN_PROPERTIES=BOOLEAN_PROPERTIES;exports.INTEGER_PROPERTIES=INTEGER_PROPERTIES;exports.STRING_PROPERTIES=STRING_PROPERTIES;exports.UPDATE_PROPERTIES=UPDATE_PROPERTIES;exports.VOID_ELEMENTS=VOID_ELEMENTS;exports.NAMESPACE_URIS=NAMESPACE_URIS;// Template Classes
exports.Template=Template;exports.Doctype=Doctype;exports.Text=Text;exports.DynamicText=DynamicText;exports.Comment=Comment;exports.DynamicComment=DynamicComment;exports.Html=Html;exports.DynamicHtml=DynamicHtml;exports.Element=Element;exports.DynamicElement=DynamicElement;exports.Block=Block;exports.ConditionalBlock=ConditionalBlock;exports.EachBlock=EachBlock;exports.Attribute=Attribute;exports.DynamicAttribute=DynamicAttribute;// Binding Classes
exports.Binding=Binding;exports.NodeBinding=NodeBinding;exports.AttributeBinding=AttributeBinding;exports.RangeBinding=RangeBinding;function Template(content,source){this.content=content;this.source=source;}Template.prototype.toString=function(){return this.source;};Template.prototype.get=function(context,unescaped){return contentHtml(this.content,context,unescaped);};Template.prototype.getFragment=function(context,binding){var fragment=document.createDocumentFragment();this.appendTo(fragment,context,binding);return fragment;};Template.prototype.appendTo=function(parent,context){context.pause();appendContent(parent,this.content,context);context.unpause();};Template.prototype.attachTo=function(parent,node,context){context.pause();var node=attachContent(parent,node,this.content,context);context.unpause();return node;};Template.prototype.update=function(){};Template.prototype.stringify=function(value){return value==null?'':value+'';};Template.prototype.equals=function(other){return this===other;};Template.prototype.module='templates';Template.prototype.type='Template';Template.prototype.serialize=function(){return serializeObject.instance(this,this.content,this.source);};function Doctype(name,publicId,systemId){this.name=name;this.publicId=publicId;this.systemId=systemId;}Doctype.prototype=Object.create(Template.prototype);Doctype.prototype.constructor=Doctype;Doctype.prototype.get=function(){var publicText=this.publicId?' PUBLIC "'+this.publicId+'"':'';var systemText=this.systemId?this.publicId?' "'+this.systemId+'"':' SYSTEM "'+this.systemId+'"':'';return'<!DOCTYPE '+this.name+publicText+systemText+'>';};Doctype.prototype.appendTo=function(){// Doctype could be created via:
//   document.implementation.createDocumentType(this.name, this.publicId, this.systemId)
// However, it does not appear possible or useful to append it to the
// document fragment. Therefore, just don't render it in the browser
};Doctype.prototype.attachTo=function(parent,node){if(!node||node.nodeType!==10){throw attachError(parent,node);}return node.nextSibling;};Doctype.prototype.type='Doctype';Doctype.prototype.serialize=function(){return serializeObject.instance(this,this.name,this.publicId,this.systemId);};function Text(data){this.data=data;this.escaped=escapeHtml(data);}Text.prototype=Object.create(Template.prototype);Text.prototype.constructor=Text;Text.prototype.get=function(context,unescaped){return unescaped?this.data:this.escaped;};Text.prototype.appendTo=function(parent){var node=document.createTextNode(this.data);parent.appendChild(node);};Text.prototype.attachTo=function(parent,node){return attachText(parent,node,this.data,this);};Text.prototype.type='Text';Text.prototype.serialize=function(){return serializeObject.instance(this,this.data);};// DynamicText might be more accurately named DynamicContent. When its
// expression returns a template, it acts similar to a Block, and it renders
// the template surrounded by comment markers for range replacement. When its
// expression returns any other type, it renders a DOM Text node with no
// markers. Text nodes are bound by updating their data property dynamically.
// The update method must take care to switch between these types of bindings
// in case the expression return type changes dynamically.
function DynamicText(expression){this.expression=expression;this.unbound=false;}DynamicText.prototype=Object.create(Template.prototype);DynamicText.prototype.constructor=DynamicText;DynamicText.prototype.get=function(context,unescaped){var value=this.expression.get(context);if(value instanceof Template){do{value=value.get(context,unescaped);}while(value instanceof Template);return value;}var data=this.stringify(value);return unescaped?data:escapeHtml(data);};DynamicText.prototype.appendTo=function(parent,context,binding){var value=this.expression.get(context);if(value instanceof Template){var start=document.createComment(this.expression);var end=document.createComment('/'+this.expression);var condition=this.getCondition(context);parent.appendChild(start);value.appendTo(parent,context);parent.appendChild(end);updateRange(context,binding,this,start,end,null,condition);return;}var data=this.stringify(value);var node=document.createTextNode(data);parent.appendChild(node);addNodeBinding(this,context,node);};DynamicText.prototype.attachTo=function(parent,node,context){var value=this.expression.get(context);if(value instanceof Template){var start=document.createComment(this.expression);var end=document.createComment('/'+this.expression);var condition=this.getCondition(context);parent.insertBefore(start,node||null);node=value.attachTo(parent,node,context);parent.insertBefore(end,node||null);updateRange(context,null,this,start,end,null,condition);return node;}var data=this.stringify(value);return attachText(parent,node,data,this,context);};DynamicText.prototype.update=function(context,binding){if(binding instanceof RangeBinding){this._blockUpdate(context,binding);return;}var value=this.expression.get(context);if(value instanceof Template){var start=binding.node;if(!start.parentNode)return;var end=start;var fragment=this.getFragment(context);replaceRange(context,start,end,fragment,binding);return;}binding.node.data=this.stringify(value);};DynamicText.prototype.getCondition=function(context){return this.expression.get(context);};DynamicText.prototype.type='DynamicText';DynamicText.prototype.serialize=function(){return serializeObject.instance(this,this.expression);};function attachText(parent,node,data,template,context){if(!node){var newNode=document.createTextNode(data);parent.appendChild(newNode);addNodeBinding(template,context,newNode);return;}if(node.nodeType===3){// Proceed if nodes already match
if(node.data===data){addNodeBinding(template,context,node);return node.nextSibling;}data=normalizeLineBreaks(data);// Split adjacent text nodes that would have been merged together in HTML
var nextNode=splitData(node,data.length);if(node.data!==data){throw attachError(parent,node);}addNodeBinding(template,context,node);return nextNode;}// An empty text node might not be created at the end of some text
if(data===''){var newNode=document.createTextNode('');parent.insertBefore(newNode,node||null);addNodeBinding(template,context,newNode);return node;}throw attachError(parent,node);}function Comment(data,hooks){this.data=data;this.hooks=hooks;}Comment.prototype=Object.create(Template.prototype);Comment.prototype.constructor=Comment;Comment.prototype.get=function(){return'<!--'+this.data+'-->';};Comment.prototype.appendTo=function(parent,context){var node=document.createComment(this.data);parent.appendChild(node);emitHooks(this.hooks,context,node);};Comment.prototype.attachTo=function(parent,node,context){return attachComment(parent,node,this.data,this,context);};Comment.prototype.type='Comment';Comment.prototype.serialize=function(){return serializeObject.instance(this,this.data,this.hooks);};function DynamicComment(expression,hooks){this.expression=expression;this.hooks=hooks;}DynamicComment.prototype=Object.create(Template.prototype);DynamicComment.prototype.constructor=DynamicComment;DynamicComment.prototype.get=function(context){var value=getUnescapedValue(this.expression,context);var data=this.stringify(value);return'<!--'+data+'-->';};DynamicComment.prototype.appendTo=function(parent,context){var value=getUnescapedValue(this.expression,context);var data=this.stringify(value);var node=document.createComment(data);parent.appendChild(node);addNodeBinding(this,context,node);};DynamicComment.prototype.attachTo=function(parent,node,context){var value=getUnescapedValue(this.expression,context);var data=this.stringify(value);return attachComment(parent,node,data,this,context);};DynamicComment.prototype.update=function(context,binding){var value=getUnescapedValue(this.expression,context);binding.node.data=this.stringify(value);};DynamicComment.prototype.type='DynamicComment';DynamicComment.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.hooks);};function attachComment(parent,node,data,template,context){// Sometimes IE fails to create Comment nodes from HTML or innerHTML.
// This is an issue inside of <select> elements, for example.
if(!node||node.nodeType!==8){var newNode=document.createComment(data);parent.insertBefore(newNode,node||null);addNodeBinding(template,context,newNode);return node;}// Proceed if nodes already match
if(node.data===data){addNodeBinding(template,context,node);return node.nextSibling;}throw attachError(parent,node);}function addNodeBinding(template,context,node){if(template.expression&&!template.unbound){context.addBinding(new NodeBinding(template,context,node));}emitHooks(template.hooks,context,node);}function Html(data){this.data=data;}Html.prototype=Object.create(Template.prototype);Html.prototype.constructor=Html;Html.prototype.get=function(){return this.data;};Html.prototype.appendTo=function(parent){var fragment=createHtmlFragment(parent,this.data);parent.appendChild(fragment);};Html.prototype.attachTo=function(parent,node){return attachHtml(parent,node,this.data);};Html.prototype.type="Html";Html.prototype.serialize=function(){return serializeObject.instance(this,this.data);};function DynamicHtml(expression){this.expression=expression;this.ending='/'+expression;}DynamicHtml.prototype=Object.create(Template.prototype);DynamicHtml.prototype.constructor=DynamicHtml;DynamicHtml.prototype.get=function(context){var value=getUnescapedValue(this.expression,context);return this.stringify(value);};DynamicHtml.prototype.appendTo=function(parent,context,binding){var start=document.createComment(this.expression);var end=document.createComment(this.ending);var value=getUnescapedValue(this.expression,context);var html=this.stringify(value);var fragment=createHtmlFragment(parent,html);parent.appendChild(start);parent.appendChild(fragment);parent.appendChild(end);updateRange(context,binding,this,start,end);};DynamicHtml.prototype.attachTo=function(parent,node,context){var start=document.createComment(this.expression);var end=document.createComment(this.ending);var value=getUnescapedValue(this.expression,context);var html=this.stringify(value);parent.insertBefore(start,node||null);node=attachHtml(parent,node,html);parent.insertBefore(end,node||null);updateRange(context,null,this,start,end);return node;};DynamicHtml.prototype.update=function(context,binding){var parent=binding.start.parentNode;if(!parent)return;// Get start and end in advance, since binding is mutated in getFragment
var start=binding.start;var end=binding.end;var value=getUnescapedValue(this.expression,context);var html=this.stringify(value);var fragment=createHtmlFragment(parent,html);var innerOnly=true;replaceRange(context,start,end,fragment,binding,innerOnly);};DynamicHtml.prototype.type='DynamicHtml';DynamicHtml.prototype.serialize=function(){return serializeObject.instance(this,this.expression);};function createHtmlFragment(parent,html){if(parent&&parent.nodeType===1){var range=document.createRange();range.selectNodeContents(parent);return range.createContextualFragment(html);}var div=document.createElement('div');var range=document.createRange();div.innerHTML=html;range.selectNodeContents(div);return range.extractContents();}function attachHtml(parent,node,html){var fragment=createHtmlFragment(parent,html);for(var i=0,len=fragment.childNodes.length;i<len;i++){if(!node)throw attachError(parent,node);node=node.nextSibling;}return node;}function Attribute(data,ns){this.data=data;this.ns=ns;}Attribute.prototype=Object.create(Template.prototype);Attribute.prototype.constructor=Attribute;Attribute.prototype.get=Attribute.prototype.getBound=function(context){return this.data;};Attribute.prototype.type='Attribute';Attribute.prototype.serialize=function(){return serializeObject.instance(this,this.data,this.ns);};function DynamicAttribute(expression,ns){// In attributes, expression may be an instance of Template or Expression
this.expression=expression;this.ns=ns;this.elementNs=null;}DynamicAttribute.prototype=Object.create(Attribute.prototype);DynamicAttribute.prototype.constructor=DynamicAttribute;DynamicAttribute.prototype.get=function(context){return getUnescapedValue(this.expression,context);};DynamicAttribute.prototype.getBound=function(context,element,name,elementNs){this.elementNs=elementNs;context.addBinding(new AttributeBinding(this,context,element,name));return getUnescapedValue(this.expression,context);};DynamicAttribute.prototype.update=function(context,binding){var value=getUnescapedValue(this.expression,context);var element=binding.element;var propertyName=!this.elementNs&&UPDATE_PROPERTIES[binding.name];if(propertyName){var propertyValue=STRING_PROPERTIES[binding.name]?this.stringify(value):value;if(element[propertyName]===propertyValue)return;element[propertyName]=propertyValue;return;}if(value===false||value==null){if(this.ns){element.removeAttributeNS(this.ns,binding.name);}else{element.removeAttribute(binding.name);}return;}if(value===true)value=binding.name;if(this.ns){element.setAttributeNS(this.ns,binding.name,value);}else{element.setAttribute(binding.name,value);}};DynamicAttribute.prototype.type='DynamicAttribute';DynamicAttribute.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.ns);};function getUnescapedValue(expression,context){var unescaped=true;var value=expression.get(context,unescaped);while(value instanceof Template){value=value.get(context,unescaped);}return value;}function Element(tagName,attributes,content,hooks,selfClosing,notClosed,ns){this.tagName=tagName;this.attributes=attributes;this.content=content;this.hooks=hooks;this.selfClosing=selfClosing;this.notClosed=notClosed;this.ns=ns;this.endTag=getEndTag(tagName,selfClosing,notClosed);this.startClose=getStartClose(selfClosing);var lowerTagName=tagName&&tagName.toLowerCase();this.unescapedContent=lowerTagName==='script'||lowerTagName==='style';this.bindContentToValue=lowerTagName==='textarea';}Element.prototype=Object.create(Template.prototype);Element.prototype.constructor=Element;Element.prototype.getTagName=function(){return this.tagName;};Element.prototype.getEndTag=function(){return this.endTag;};Element.prototype.get=function(context){var tagName=this.getTagName(context);var endTag=this.getEndTag(tagName);var tagItems=[tagName];for(var key in this.attributes){var value=this.attributes[key].get(context);if(value===true){tagItems.push(key);}else if(value!==false&&value!=null){tagItems.push(key+'="'+escapeAttribute(value)+'"');}}var startTag='<'+tagItems.join(' ')+this.startClose;if(this.content){var inner=contentHtml(this.content,context,this.unescapedContent);return startTag+inner+endTag;}return startTag+endTag;};Element.prototype.appendTo=function(parent,context){var tagName=this.getTagName(context);var element=this.ns?document.createElementNS(this.ns,tagName):document.createElement(tagName);for(var key in this.attributes){var attribute=this.attributes[key];var value=attribute.getBound(context,element,key,this.ns);if(value===false||value==null)continue;var propertyName=!this.ns&&CREATE_PROPERTIES[key];if(propertyName){element[propertyName]=value;continue;}if(value===true)value=key;if(attribute.ns){element.setAttributeNS(attribute.ns,key,value);}else{element.setAttribute(key,value);}}if(this.content){this._bindContent(context,element);appendContent(element,this.content,context);}parent.appendChild(element);emitHooks(this.hooks,context,element);};Element.prototype.attachTo=function(parent,node,context){var tagName=this.getTagName(context);if(!node||node.nodeType!==1||node.tagName.toLowerCase()!==tagName.toLowerCase()){throw attachError(parent,node);}for(var key in this.attributes){// Get each attribute to create bindings
this.attributes[key].getBound(context,node,key,this.ns);// TODO: Ideally, this would also check that the node's current attributes
// are equivalent, but there are some tricky edge cases
}if(this.content){this._bindContent(context,node);attachContent(node,node.firstChild,this.content,context);}emitHooks(this.hooks,context,node);return node.nextSibling;};Element.prototype._bindContent=function(context,element){// For textareas with dynamic text content, bind to the value property
var child=this.bindContentToValue&&this.content.length===1&&this.content[0];if(child instanceof DynamicText){child.unbound=true;var template=new DynamicAttribute(child.expression);context.addBinding(new AttributeBinding(template,context,element,'value'));}};Element.prototype.type='Element';Element.prototype.serialize=function(){return serializeObject.instance(this,this.tagName,this.attributes,this.content,this.hooks,this.selfClosing,this.notClosed,this.ns);};function DynamicElement(tagName,attributes,content,hooks,selfClosing,notClosed,ns){this.tagName=tagName;this.attributes=attributes;this.content=content;this.hooks=hooks;this.selfClosing=selfClosing;this.notClosed=notClosed;this.ns=ns;this.startClose=getStartClose(selfClosing);this.unescapedContent=false;}DynamicElement.prototype=Object.create(Element.prototype);DynamicElement.prototype.constructor=DynamicElement;DynamicElement.prototype.getTagName=function(context){return getUnescapedValue(this.tagName,context);};DynamicElement.prototype.getEndTag=function(tagName){return getEndTag(tagName,this.selfClosing,this.notClosed);};DynamicElement.prototype.type='DynamicElement';function getStartClose(selfClosing){return selfClosing?' />':'>';}function getEndTag(tagName,selfClosing,notClosed){var lowerTagName=tagName&&tagName.toLowerCase();var isVoid=VOID_ELEMENTS[lowerTagName];return isVoid||selfClosing||notClosed?'':'</'+tagName+'>';}function getAttributeValue(element,name){var propertyName=UPDATE_PROPERTIES[name];return propertyName?element[propertyName]:element.getAttribute(name);}function emitHooks(hooks,context,value){if(!hooks)return;context.queue(function queuedHooks(){for(var i=0,len=hooks.length;i<len;i++){hooks[i].emit(context,value);}});}function Block(expression,content){this.expression=expression;this.ending='/'+expression;this.content=content;}Block.prototype=Object.create(Template.prototype);Block.prototype.constructor=Block;Block.prototype.get=function(context,unescaped){var blockContext=context.child(this.expression);return contentHtml(this.content,blockContext,unescaped);};Block.prototype.appendTo=function(parent,context,binding){var blockContext=context.child(this.expression);var start=document.createComment(this.expression);var end=document.createComment(this.ending);var condition=this.getCondition(context);parent.appendChild(start);appendContent(parent,this.content,blockContext);parent.appendChild(end);updateRange(context,binding,this,start,end,null,condition);};Block.prototype.attachTo=function(parent,node,context){var blockContext=context.child(this.expression);var start=document.createComment(this.expression);var end=document.createComment(this.ending);var condition=this.getCondition(context);parent.insertBefore(start,node||null);node=attachContent(parent,node,this.content,blockContext);parent.insertBefore(end,node||null);updateRange(context,null,this,start,end,null,condition);return node;};Block.prototype.type='Block';Block.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.content);};Block.prototype.update=function(context,binding){if(!binding.start.parentNode)return;var condition=this.getCondition(context);// Cancel update if prior condition is equivalent to current value
if(equalConditions(condition,binding.condition))return;binding.condition=condition;// Get start and end in advance, since binding is mutated in getFragment
var start=binding.start;var end=binding.end;var fragment=this.getFragment(context,binding);replaceRange(context,start,end,fragment,binding);};Block.prototype.getCondition=function(context){// We do an identity check to see if the value has changed before updating.
// With objects, the object would still be the same, so this identity check
// would fail to update enough. Thus, return NaN, which never equals anything
// including itself, so that we always update on objects.
//
// We could also JSON stringify or use some other hashing approach. However,
// that could be really expensive on gets of things that never change, and
// is probably not a good tradeoff. Perhaps there should be a separate block
// type that is only used in the case of dynamic updates
var value=this.expression.get(context);return _typeof(value)==='object'?NaN:value;};DynamicText.prototype._blockUpdate=Block.prototype.update;function ConditionalBlock(expressions,contents){this.expressions=expressions;this.beginning=expressions.join('; ');this.ending='/'+this.beginning;this.contents=contents;}ConditionalBlock.prototype=Object.create(Block.prototype);ConditionalBlock.prototype.constructor=ConditionalBlock;ConditionalBlock.prototype.get=function(context,unescaped){var condition=this.getCondition(context);if(condition==null)return'';var expression=this.expressions[condition];var blockContext=context.child(expression);return contentHtml(this.contents[condition],blockContext,unescaped);};ConditionalBlock.prototype.appendTo=function(parent,context,binding){var start=document.createComment(this.beginning);var end=document.createComment(this.ending);parent.appendChild(start);var condition=this.getCondition(context);if(condition!=null){var expression=this.expressions[condition];var blockContext=context.child(expression);appendContent(parent,this.contents[condition],blockContext);}parent.appendChild(end);updateRange(context,binding,this,start,end,null,condition);};ConditionalBlock.prototype.attachTo=function(parent,node,context){var start=document.createComment(this.beginning);var end=document.createComment(this.ending);parent.insertBefore(start,node||null);var condition=this.getCondition(context);if(condition!=null){var expression=this.expressions[condition];var blockContext=context.child(expression);node=attachContent(parent,node,this.contents[condition],blockContext);}parent.insertBefore(end,node||null);updateRange(context,null,this,start,end,null,condition);return node;};ConditionalBlock.prototype.type='ConditionalBlock';ConditionalBlock.prototype.serialize=function(){return serializeObject.instance(this,this.expressions,this.contents);};ConditionalBlock.prototype.update=function(context,binding){if(!binding.start.parentNode)return;var condition=this.getCondition(context);// Cancel update if prior condition is equivalent to current value
if(equalConditions(condition,binding.condition))return;binding.condition=condition;// Get start and end in advance, since binding is mutated in getFragment
var start=binding.start;var end=binding.end;var fragment=this.getFragment(context,binding);replaceRange(context,start,end,fragment,binding);};ConditionalBlock.prototype.getCondition=function(context){for(var i=0,len=this.expressions.length;i<len;i++){if(this.expressions[i].truthy(context)){return i;}}};function EachBlock(expression,content,elseContent){this.expression=expression;this.ending='/'+expression;this.content=content;this.elseContent=elseContent;}EachBlock.prototype=Object.create(Block.prototype);EachBlock.prototype.constructor=EachBlock;EachBlock.prototype.get=function(context,unescaped){var items=this.expression.get(context);if(items&&items.length){var html='';for(var i=0,len=items.length;i<len;i++){var itemContext=context.eachChild(this.expression,i);html+=contentHtml(this.content,itemContext,unescaped);}return html;}else if(this.elseContent){return contentHtml(this.elseContent,context,unescaped);}return'';};EachBlock.prototype.appendTo=function(parent,context,binding){var items=this.expression.get(context);var start=document.createComment(this.expression);var end=document.createComment(this.ending);parent.appendChild(start);if(items&&items.length){for(var i=0,len=items.length;i<len;i++){var itemContext=context.eachChild(this.expression,i);this.appendItemTo(parent,itemContext,start);}}else if(this.elseContent){appendContent(parent,this.elseContent,context);}parent.appendChild(end);updateRange(context,binding,this,start,end);};EachBlock.prototype.appendItemTo=function(parent,context,itemFor,binding){var before=parent.lastChild;var start,end;appendContent(parent,this.content,context);if(before===parent.lastChild){start=end=document.createComment('empty');parent.appendChild(start);}else{start=before&&before.nextSibling||parent.firstChild;end=parent.lastChild;}updateRange(context,binding,this,start,end,itemFor);};EachBlock.prototype.attachTo=function(parent,node,context){var items=this.expression.get(context);var start=document.createComment(this.expression);var end=document.createComment(this.ending);parent.insertBefore(start,node||null);if(items&&items.length){for(var i=0,len=items.length;i<len;i++){var itemContext=context.eachChild(this.expression,i);node=this.attachItemTo(parent,node,itemContext,start);}}else if(this.elseContent){node=attachContent(parent,node,this.elseContent,context);}parent.insertBefore(end,node||null);updateRange(context,null,this,start,end);return node;};EachBlock.prototype.attachItemTo=function(parent,node,context,itemFor){var start,end;var oldPrevious=node&&node.previousSibling;var nextNode=attachContent(parent,node,this.content,context);if(nextNode===node){start=end=document.createComment('empty');parent.insertBefore(start,node||null);}else{start=oldPrevious&&oldPrevious.nextSibling||parent.firstChild;end=nextNode&&nextNode.previousSibling||parent.lastChild;}updateRange(context,null,this,start,end,itemFor);return nextNode;};EachBlock.prototype.update=function(context,binding){if(!binding.start.parentNode)return;var start=binding.start;var end=binding.end;if(binding.itemFor){var fragment=document.createDocumentFragment();this.appendItemTo(fragment,context,binding.itemFor,binding);}else{var fragment=this.getFragment(context,binding);}replaceRange(context,start,end,fragment,binding);};EachBlock.prototype.insert=function(context,binding,index,howMany){var parent=binding.start.parentNode;if(!parent)return;// In case we are inserting all of the items, update instead. This is needed
// when we were previously rendering elseContent so that it is replaced
if(index===0&&this.expression.get(context).length===howMany){return this.update(context,binding);}var node=indexStartNode(binding,index);var fragment=document.createDocumentFragment();for(var i=index,len=index+howMany;i<len;i++){var itemContext=context.eachChild(this.expression,i);this.appendItemTo(fragment,itemContext,binding.start);}parent.insertBefore(fragment,node||null);};EachBlock.prototype.remove=function(context,binding,index,howMany){var parent=binding.start.parentNode;if(!parent)return;// In case we are removing all of the items, update instead. This is needed
// when elseContent should be rendered
if(index===0&&this.expression.get(context).length===0){return this.update(context,binding);}var node=indexStartNode(binding,index);var i=0;while(node){if(node===binding.end)return;if(node.$bindItemStart&&node.$bindItemStart.itemFor===binding.start){if(howMany===i++)return;}var nextNode=node.nextSibling;parent.removeChild(node);emitRemoved(context,node,binding);node=nextNode;}};EachBlock.prototype.move=function(context,binding,from,to,howMany){var parent=binding.start.parentNode;if(!parent)return;var node=indexStartNode(binding,from);var fragment=document.createDocumentFragment();var i=0;while(node){if(node===binding.end)break;if(node.$bindItemStart&&node.$bindItemStart.itemFor===binding.start){if(howMany===i++)break;}var nextNode=node.nextSibling;fragment.appendChild(node);node=nextNode;}node=indexStartNode(binding,to);parent.insertBefore(fragment,node||null);};EachBlock.prototype.type='EachBlock';EachBlock.prototype.serialize=function(){return serializeObject.instance(this,this.expression,this.content,this.elseContent);};function indexStartNode(binding,index){var node=binding.start;var i=0;while(node=node.nextSibling){if(node===binding.end)return node;if(node.$bindItemStart&&node.$bindItemStart.itemFor===binding.start){if(index===i)return node;i++;}}}function updateRange(context,binding,template,start,end,itemFor,condition){if(binding){binding.start=start;binding.end=end;binding.condition=condition;setNodeBounds(binding,start,itemFor);}else{context.addBinding(new RangeBinding(template,context,start,end,itemFor,condition));}}function setNodeBounds(binding,start,itemFor){if(itemFor){setNodeProperty(start,'$bindItemStart',binding);}else{setNodeProperty(start,'$bindStart',binding);}}function appendContent(parent,content,context){for(var i=0,len=content.length;i<len;i++){content[i].appendTo(parent,context);}}function attachContent(parent,node,content,context){for(var i=0,len=content.length;i<len;i++){while(node&&node.hasAttribute&&node.hasAttribute('data-no-attach')){node=node.nextSibling;}node=content[i].attachTo(parent,node,context);}return node;}function contentHtml(content,context,unescaped){var html='';for(var i=0,len=content.length;i<len;i++){html+=content[i].get(context,unescaped);}return html;}function replaceRange(context,start,end,fragment,binding,innerOnly){// Note: the calling function must make sure to check that there is a parent
var parent=start.parentNode;// Copy item binding from old start to fragment being inserted
if(start.$bindItemStart&&fragment.firstChild){setNodeProperty(fragment.firstChild,'$bindItemStart',start.$bindItemStart);start.$bindItemStart.start=fragment.firstChild;}// Fast path for single node replacements
if(start===end){parent.replaceChild(fragment,start);emitRemoved(context,start,binding);return;}// Remove all nodes from start to end
var node=innerOnly?start.nextSibling:start;var nextNode;while(node){nextNode=node.nextSibling;emitRemoved(context,node,binding);if(innerOnly&&node===end){nextNode=end;break;}parent.removeChild(node);if(node===end)break;node=nextNode;}// This also works if nextNode is null, by doing an append
parent.insertBefore(fragment,nextNode||null);}function emitRemoved(context,node,ignore){context.removeNode(node);emitRemovedBinding(context,ignore,node,'$bindNode');emitRemovedBinding(context,ignore,node,'$bindStart');emitRemovedBinding(context,ignore,node,'$bindItemStart');var attributes=node.$bindAttributes;if(attributes){node.$bindAttributes=null;for(var key in attributes){context.removeBinding(attributes[key]);}}for(node=node.firstChild;node;node=node.nextSibling){emitRemoved(context,node,ignore);}}function emitRemovedBinding(context,ignore,node,property){var binding=node[property];if(binding){node[property]=null;if(binding!==ignore){context.removeBinding(binding);}}}function attachError(parent,node){if(typeof console!=='undefined'){console.error('Attach failed for',node,'within',parent);}return new Error('Attaching bindings failed, because HTML structure '+'does not match client rendering.');}function Binding(){this.meta=null;}Binding.prototype.type='Binding';Binding.prototype.update=function(){this.context.pause();this.template.update(this.context,this);this.context.unpause();};Binding.prototype.insert=function(){this.update();};Binding.prototype.remove=function(){this.update();};Binding.prototype.move=function(){this.update();};function NodeBinding(template,context,node){this.template=template;this.context=context;this.node=node;this.meta=null;setNodeProperty(node,'$bindNode',this);}NodeBinding.prototype=Object.create(Binding.prototype);NodeBinding.prototype.constructor=NodeBinding;NodeBinding.prototype.type='NodeBinding';function AttributeBindingsMap(){}function AttributeBinding(template,context,element,name){this.template=template;this.context=context;this.element=element;this.name=name;this.meta=null;var map=element.$bindAttributes||(element.$bindAttributes=new AttributeBindingsMap());map[name]=this;}AttributeBinding.prototype=Object.create(Binding.prototype);AttributeBinding.prototype.constructor=AttributeBinding;AttributeBinding.prototype.type='AttributeBinding';function RangeBinding(template,context,start,end,itemFor,condition){this.template=template;this.context=context;this.start=start;this.end=end;this.itemFor=itemFor;this.condition=condition;this.meta=null;setNodeBounds(this,start,itemFor);}RangeBinding.prototype=Object.create(Binding.prototype);RangeBinding.prototype.constructor=RangeBinding;RangeBinding.prototype.type='RangeBinding';RangeBinding.prototype.insert=function(index,howMany){this.context.pause();if(this.template.insert){this.template.insert(this.context,this,index,howMany);}else{this.template.update(this.context,this);}this.context.unpause();};RangeBinding.prototype.remove=function(index,howMany){this.context.pause();if(this.template.remove){this.template.remove(this.context,this,index,howMany);}else{this.template.update(this.context,this);}this.context.unpause();};RangeBinding.prototype.move=function(from,to,howMany){this.context.pause();if(this.template.move){this.template.move(this.context,this,from,to,howMany);}else{this.template.update(this.context,this);}this.context.unpause();};//// Utility functions ////
function noop(){}function mergeInto(from,to){for(var key in from){to[key]=from[key];}}function escapeHtml(string){string=string+'';return string.replace(/[&<]/g,function(match){return match==='&'?'&amp;':'&lt;';});}function escapeAttribute(string){string=string+'';return string.replace(/[&"]/g,function(match){return match==='&'?'&amp;':'&quot;';});}function equalConditions(a,b){// First, test for strict equality
if(a===b)return true;// Failing that, allow for template objects used as a condition to define a
// custom `equals()` method to indicate equivalence
return a instanceof Template&&a.equals(b);}//// Shims & workarounds ////
// General notes:
//
// In all cases, Node.insertBefore should have `|| null` after its second
// argument. IE works correctly when the argument is ommitted or equal
// to null, but it throws and error if it is equal to undefined.
if(!Array.isArray){Array.isArray=function(value){return Object.prototype.toString.call(value)==='[object Array]';};}// Equivalent to textNode.splitText, which is buggy in IE <=9
function splitData(node,index){var newNode=node.cloneNode(false);newNode.deleteData(0,index);node.deleteData(index,node.length-index);node.parentNode.insertBefore(newNode,node.nextSibling||null);return newNode;}// Defined so that it can be overriden in IE <=8
function setNodeProperty(node,key,value){return node[key]=value;}function normalizeLineBreaks(string){return string;}(function(){// Don't try to shim in Node.js environment
if(typeof document==='undefined')return;var div=document.createElement('div');div.innerHTML='\r\n<br>\n';var windowsLength=div.firstChild.data.length;var unixLength=div.lastChild.data.length;if(windowsLength===1&&unixLength===1){normalizeLineBreaks=function normalizeLineBreaks(string){return string.replace(/\r\n/g,'\n');};}else if(windowsLength===2&&unixLength===2){normalizeLineBreaks=function normalizeLineBreaks(string){return string.replace(/(^|[^\r])(\n+)/g,function(match,value,newLines){for(var i=newLines.length;i--;){value+='\r\n';}return value;});};}// TODO: Shim createHtmlFragment for old IE
// TODO: Shim setAttribute('style'), which doesn't work in IE <=7
// http://webbugtrack.blogspot.com/2007/10/bug-245-setattribute-style-does-not.html
// TODO: Investigate whether input name attribute works in IE <=7. We could
// override Element::appendTo to use IE's alternative createElement syntax:
// document.createElement('<input name="xxx">')
// http://webbugtrack.blogspot.com/2007/10/bug-235-createelement-is-broken-in-ie.html
// In IE, input.defaultValue doesn't work correctly, so use input.value,
// which mistakenly but conveniently sets both the value property and attribute.
//
// Surprisingly, in IE <=7, input.defaultChecked must be used instead of
// input.checked before the input is in the document.
// http://webbugtrack.blogspot.com/2007/11/bug-299-setattribute-checked-does-not.html
var input=document.createElement('input');input.defaultValue='x';if(input.value!=='x'){CREATE_PROPERTIES.value='value';}try{// TextNodes are not expando in IE <=8
document.createTextNode('').$try=0;}catch(err){setNodeProperty=function setNodeProperty(node,key,value){// If trying to set a property on a TextNode, create a proxy CommentNode
// and set the property on that node instead. Put the proxy after the
// TextNode if marking the end of a range, and before otherwise.
if(node.nodeType===3){var proxyNode=node.previousSibling;if(!proxyNode||proxyNode.$bindProxy!==node){proxyNode=document.createComment('proxy');proxyNode.$bindProxy=node;node.parentNode.insertBefore(proxyNode,node||null);}return proxyNode[key]=value;}// Set the property directly on other node types
return node[key]=value;};}})();},{"serialize-object":76}],76:[function(require,module,exports){exports.instance=serializeInstance;exports.args=serializeArgs;exports.value=serializeValue;function serializeInstance(instance){var args=Array.prototype.slice.call(arguments,1);return'new '+instance.module+'.'+instance.type+'('+serializeArgs(args)+')';}function serializeArgs(args){// Map each argument into its string representation
var items=[];for(var i=args.length;i--;){var item=serializeValue(args[i]);items.unshift(item);}// Remove trailing null values, assuming they are optional
for(var i=items.length;i--;){var item=items[i];if(item!=='void 0'&&item!=='null')break;items.pop();}return items.join(', ');}function serializeValue(input){if(input&&input.serialize){return input.serialize();}else if(typeof input==='undefined'){return'void 0';}else if(input===null){return'null';}else if(typeof input==='string'){return formatString(input);}else if(typeof input==='number'||typeof input==='boolean'){return input+'';}else if(Array.isArray(input)){var items=[];for(var i=0;i<input.length;i++){var value=serializeValue(input[i]);items.push(value);}return'['+items.join(', ')+']';}else if(_typeof(input)==='object'){var items=[];for(var key in input){var value=serializeValue(input[key]);items.push(formatString(key)+': '+value);}return'{'+items.join(', ')+'}';}}function formatString(value){var escaped=value.replace(/['\r\n\\]/g,function(match){return match==='\''?'\\\'':match==='\r'?'\\r':match==='\n'?'\\n':match==='\\'?'\\\\':'';});return'\''+escaped+'\'';}},{}],77:[function(require,module,exports){(function(process){var Doc=require('./doc');var Query=require('./query');var SnapshotVersionRequest=require('./snapshot-request/snapshot-version-request');var SnapshotTimestampRequest=require('./snapshot-request/snapshot-timestamp-request');var emitter=require('../emitter');var ShareDBError=require('../error');var types=require('../types');var util=require('../util');var logger=require('../logger');var ERROR_CODE=ShareDBError.CODES;function connectionState(socket){if(socket.readyState===0||socket.readyState===1)return'connecting';return'disconnected';}/**
 * Handles communication with the sharejs server and provides queries and
 * documents.
 *
 * We create a connection with a socket object
 *   connection = new sharejs.Connection(sockset)
 * The socket may be any object handling the websocket protocol. See the
 * documentation of bindToSocket() for details. We then wait for the connection
 * to connect
 *   connection.on('connected', ...)
 * and are finally able to work with shared documents
 *   connection.get('food', 'steak') // Doc
 *
 * @param socket @see bindToSocket
 */module.exports=Connection;function Connection(socket){emitter.EventEmitter.call(this);// Map of collection -> id -> doc object for created documents.
// (created documents MUST BE UNIQUE)
this.collections={};// Each query and snapshot request is created with an id that the server uses when it sends us
// info about the request (updates, etc)
this.nextQueryId=1;this.nextSnapshotRequestId=1;// Map from query ID -> query object.
this.queries={};// Map from snapshot request ID -> snapshot request
this._snapshotRequests={};// A unique message number for the given id
this.seq=1;// Equals agent.clientId on the server
this.id=null;// This direct reference from connection to agent is not used internal to
// ShareDB, but it is handy for server-side only user code that may cache
// state on the agent and read it in middleware
this.agent=null;this.debug=false;this.state=connectionState(socket);this.bindToSocket(socket);}emitter.mixin(Connection);/**
 * Use socket to communicate with server
 *
 * Socket is an object that can handle the websocket protocol. This method
 * installs the onopen, onclose, onmessage and onerror handlers on the socket to
 * handle communication and sends messages by calling socket.send(message). The
 * sockets `readyState` property is used to determine the initaial state.
 *
 * @param socket Handles the websocket protocol
 * @param socket.readyState
 * @param socket.close
 * @param socket.send
 * @param socket.onopen
 * @param socket.onclose
 * @param socket.onmessage
 * @param socket.onerror
 */Connection.prototype.bindToSocket=function(socket){if(this.socket){this.socket.close();this.socket.onmessage=null;this.socket.onopen=null;this.socket.onerror=null;this.socket.onclose=null;}this.socket=socket;// State of the connection. The corresponding events are emitted when this changes
//
// - 'connecting'   The connection is still being established, or we are still
//                    waiting on the server to send us the initialization message
// - 'connected'    The connection is open and we have connected to a server
//                    and recieved the initialization message
// - 'disconnected' Connection is closed, but it will reconnect automatically
// - 'closed'       The connection was closed by the client, and will not reconnect
// - 'stopped'      The connection was closed by the server, and will not reconnect
var newState=connectionState(socket);this._setState(newState);// This is a helper variable the document uses to see whether we're
// currently in a 'live' state. It is true if and only if we're connected
this.canSend=false;var connection=this;socket.onmessage=function(event){try{var data=typeof event.data==='string'?JSON.parse(event.data):event.data;}catch(err){logger.warn('Failed to parse message',event);return;}if(connection.debug)logger.info('RECV',JSON.stringify(data));var request={data:data};connection.emit('receive',request);if(!request.data)return;try{connection.handleMessage(request.data);}catch(err){process.nextTick(function(){connection.emit('error',err);});}};socket.onopen=function(){connection._setState('connecting');};socket.onerror=function(err){// This isn't the same as a regular error, because it will happen normally
// from time to time. Your connection should probably automatically
// reconnect anyway, but that should be triggered off onclose not onerror.
// (onclose happens when onerror gets called anyway).
connection.emit('connection error',err);};socket.onclose=function(reason){// node-browserchannel reason values:
//   'Closed' - The socket was manually closed by calling socket.close()
//   'Stopped by server' - The server sent the stop message to tell the client not to try connecting
//   'Request failed' - Server didn't respond to request (temporary, usually offline)
//   'Unknown session ID' - Server session for client is missing (temporary, will immediately reestablish)
if(reason==='closed'||reason==='Closed'){connection._setState('closed',reason);}else if(reason==='stopped'||reason==='Stopped by server'){connection._setState('stopped',reason);}else{connection._setState('disconnected',reason);}};};/**
 * @param {object} message
 * @param {String} message.a action
 */Connection.prototype.handleMessage=function(message){var err=null;if(message.error){err=wrapErrorData(message.error,message);delete message.error;}// Switch on the message action. Most messages are for documents and are
// handled in the doc class.
switch(message.a){case'init':// Client initialization packet
if(message.protocol!==1){err=new ShareDBError(ERROR_CODE.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,'Unsupported protocol version: '+message.protocol);return this.emit('error',err);}if(types.map[message.type]!==types.defaultType){err=new ShareDBError(ERROR_CODE.ERR_DEFAULT_TYPE_MISMATCH,message.type+' does not match the server default type');return this.emit('error',err);}if(typeof message.id!=='string'){err=new ShareDBError(ERROR_CODE.ERR_CLIENT_ID_BADLY_FORMED,'Client id must be a string');return this.emit('error',err);}this.id=message.id;this._setState('connected');return;case'qf':var query=this.queries[message.id];if(query)query._handleFetch(err,message.data,message.extra);return;case'qs':var query=this.queries[message.id];if(query)query._handleSubscribe(err,message.data,message.extra);return;case'qu':// Queries are removed immediately on calls to destroy, so we ignore
// replies to query unsubscribes. Perhaps there should be a callback for
// destroy, but this is currently unimplemented
return;case'q':// Query message. Pass this to the appropriate query object.
var query=this.queries[message.id];if(!query)return;if(err)return query._handleError(err);if(message.diff)query._handleDiff(message.diff);if(message.hasOwnProperty('extra'))query._handleExtra(message.extra);return;case'bf':return this._handleBulkMessage(err,message,'_handleFetch');case'bs':return this._handleBulkMessage(err,message,'_handleSubscribe');case'bu':return this._handleBulkMessage(err,message,'_handleUnsubscribe');case'nf':case'nt':return this._handleSnapshotFetch(err,message);case'f':var doc=this.getExisting(message.c,message.d);if(doc)doc._handleFetch(err,message.data);return;case's':var doc=this.getExisting(message.c,message.d);if(doc)doc._handleSubscribe(err,message.data);return;case'u':var doc=this.getExisting(message.c,message.d);if(doc)doc._handleUnsubscribe(err);return;case'op':var doc=this.getExisting(message.c,message.d);if(doc)doc._handleOp(err,message);return;default:logger.warn('Ignoring unrecognized message',message);}};function wrapErrorData(errorData,fullMessage){// wrap in Error object so can be passed through event emitters
var err=new Error(errorData.message);err.code=errorData.code;if(fullMessage){// Add the message data to the error object for more context
err.data=fullMessage;}return err;}Connection.prototype._handleBulkMessage=function(err,message,method){if(message.data){for(var id in message.data){var dataForId=message.data[id];var doc=this.getExisting(message.c,id);if(doc){if(err){doc[method](err);}else if(dataForId.error){// Bulk reply snapshot-specific errorr - see agent.js getMapResult
doc[method](wrapErrorData(dataForId.error));}else{doc[method](null,dataForId);}}}}else if(Array.isArray(message.b)){for(var i=0;i<message.b.length;i++){var id=message.b[i];var doc=this.getExisting(message.c,id);if(doc)doc[method](err);}}else if(message.b){for(var id in message.b){var doc=this.getExisting(message.c,id);if(doc)doc[method](err);}}else{logger.error('Invalid bulk message',message);}};Connection.prototype._reset=function(){this.seq=1;this.id=null;this.agent=null;};// Set the connection's state. The connection is basically a state machine.
Connection.prototype._setState=function(newState,reason){if(this.state===newState)return;// I made a state diagram. The only invalid transitions are getting to
// 'connecting' from anywhere other than 'disconnected' and getting to
// 'connected' from anywhere other than 'connecting'.
if(newState==='connecting'&&this.state!=='disconnected'&&this.state!=='stopped'&&this.state!=='closed'||newState==='connected'&&this.state!=='connecting'){var err=new ShareDBError(ERROR_CODE.ERR_CONNECTION_STATE_TRANSITION_INVALID,'Cannot transition directly from '+this.state+' to '+newState);return this.emit('error',err);}this.state=newState;this.canSend=newState==='connected';if(newState==='disconnected'||newState==='stopped'||newState==='closed'){this._reset();}// Group subscribes together to help server make more efficient calls
this.startBulk();// Emit the event to all queries
for(var id in this.queries){var query=this.queries[id];query._onConnectionStateChanged();}// Emit the event to all documents
for(var collection in this.collections){var docs=this.collections[collection];for(var id in docs){docs[id]._onConnectionStateChanged();}}// Emit the event to all snapshots
for(var id in this._snapshotRequests){var snapshotRequest=this._snapshotRequests[id];snapshotRequest._onConnectionStateChanged();}this.endBulk();this.emit(newState,reason);this.emit('state',newState,reason);};Connection.prototype.startBulk=function(){if(!this.bulk)this.bulk={};};Connection.prototype.endBulk=function(){if(this.bulk){for(var collection in this.bulk){var actions=this.bulk[collection];this._sendBulk('f',collection,actions.f);this._sendBulk('s',collection,actions.s);this._sendBulk('u',collection,actions.u);}}this.bulk=null;};Connection.prototype._sendBulk=function(action,collection,values){if(!values)return;var ids=[];var versions={};var versionsCount=0;var versionId;for(var id in values){var value=values[id];if(value==null){ids.push(id);}else{versions[id]=value;versionId=id;versionsCount++;}}if(ids.length===1){var id=ids[0];this.send({a:action,c:collection,d:id});}else if(ids.length){this.send({a:'b'+action,c:collection,b:ids});}if(versionsCount===1){var version=versions[versionId];this.send({a:action,c:collection,d:versionId,v:version});}else if(versionsCount){this.send({a:'b'+action,c:collection,b:versions});}};Connection.prototype._sendAction=function(action,doc,version){// Ensure the doc is registered so that it receives the reply message
this._addDoc(doc);if(this.bulk){// Bulk subscribe
var actions=this.bulk[doc.collection]||(this.bulk[doc.collection]={});var versions=actions[action]||(actions[action]={});var isDuplicate=versions.hasOwnProperty(doc.id);versions[doc.id]=version;return isDuplicate;}else{// Send single doc subscribe message
var message={a:action,c:doc.collection,d:doc.id,v:version};this.send(message);}};Connection.prototype.sendFetch=function(doc){return this._sendAction('f',doc,doc.version);};Connection.prototype.sendSubscribe=function(doc){return this._sendAction('s',doc,doc.version);};Connection.prototype.sendUnsubscribe=function(doc){return this._sendAction('u',doc);};Connection.prototype.sendOp=function(doc,op){// Ensure the doc is registered so that it receives the reply message
this._addDoc(doc);var message={a:'op',c:doc.collection,d:doc.id,v:doc.version,src:op.src,seq:op.seq};if(op.op)message.op=op.op;if(op.create)message.create=op.create;if(op.del)message.del=op.del;this.send(message);};/**
 * Sends a message down the socket
 */Connection.prototype.send=function(message){if(this.debug)logger.info('SEND',JSON.stringify(message));this.emit('send',message);this.socket.send(JSON.stringify(message));};/**
 * Closes the socket and emits 'closed'
 */Connection.prototype.close=function(){this.socket.close();};Connection.prototype.getExisting=function(collection,id){if(this.collections[collection])return this.collections[collection][id];};/**
 * Get or create a document.
 *
 * @param collection
 * @param id
 * @return {Doc}
 */Connection.prototype.get=function(collection,id){var docs=this.collections[collection]||(this.collections[collection]={});var doc=docs[id];if(!doc){doc=docs[id]=new Doc(this,collection,id);this.emit('doc',doc);}return doc;};/**
 * Remove document from this.collections
 *
 * @private
 */Connection.prototype._destroyDoc=function(doc){var docs=this.collections[doc.collection];if(!docs)return;delete docs[doc.id];// Delete the collection container if its empty. This could be a source of
// memory leaks if you slowly make a billion collections, which you probably
// won't do anyway, but whatever.
if(!util.hasKeys(docs)){delete this.collections[doc.collection];}};Connection.prototype._addDoc=function(doc){var docs=this.collections[doc.collection];if(!docs){docs=this.collections[doc.collection]={};}if(docs[doc.id]!==doc){docs[doc.id]=doc;}};// Helper for createFetchQuery and createSubscribeQuery, below.
Connection.prototype._createQuery=function(action,collection,q,options,callback){var id=this.nextQueryId++;var query=new Query(action,this,id,collection,q,options,callback);this.queries[id]=query;query.send();return query;};// Internal function. Use query.destroy() to remove queries.
Connection.prototype._destroyQuery=function(query){delete this.queries[query.id];};// The query options object can contain the following fields:
//
// db: Name of the db for the query. You can attach extraDbs to ShareDB and
//   pick which one the query should hit using this parameter.
// Create a fetch query. Fetch queries are only issued once, returning the
// results directly into the callback.
//
// The callback should have the signature function(error, results, extra)
// where results is a list of Doc objects.
Connection.prototype.createFetchQuery=function(collection,q,options,callback){return this._createQuery('qf',collection,q,options,callback);};// Create a subscribe query. Subscribe queries return with the initial data
// through the callback, then update themselves whenever the query result set
// changes via their own event emitter.
//
// If present, the callback should have the signature function(error, results, extra)
// where results is a list of Doc objects.
Connection.prototype.createSubscribeQuery=function(collection,q,options,callback){return this._createQuery('qs',collection,q,options,callback);};Connection.prototype.hasPending=function(){return!!(this._firstDoc(hasPending)||this._firstQuery(hasPending)||this._firstSnapshotRequest());};function hasPending(object){return object.hasPending();}Connection.prototype.hasWritePending=function(){return!!this._firstDoc(hasWritePending);};function hasWritePending(object){return object.hasWritePending();}Connection.prototype.whenNothingPending=function(callback){var doc=this._firstDoc(hasPending);if(doc){// If a document is found with a pending operation, wait for it to emit
// that nothing is pending anymore, and then recheck all documents again.
// We have to recheck all documents, just in case another mutation has
// been made in the meantime as a result of an event callback
doc.once('nothing pending',this._nothingPendingRetry(callback));return;}var query=this._firstQuery(hasPending);if(query){query.once('ready',this._nothingPendingRetry(callback));return;}var snapshotRequest=this._firstSnapshotRequest();if(snapshotRequest){snapshotRequest.once('ready',this._nothingPendingRetry(callback));return;}// Call back when no pending operations
process.nextTick(callback);};Connection.prototype._nothingPendingRetry=function(callback){var connection=this;return function(){process.nextTick(function(){connection.whenNothingPending(callback);});};};Connection.prototype._firstDoc=function(fn){for(var collection in this.collections){var docs=this.collections[collection];for(var id in docs){var doc=docs[id];if(fn(doc)){return doc;}}}};Connection.prototype._firstQuery=function(fn){for(var id in this.queries){var query=this.queries[id];if(fn(query)){return query;}}};Connection.prototype._firstSnapshotRequest=function(){for(var id in this._snapshotRequests){return this._snapshotRequests[id];}};/**
 * Fetch a read-only snapshot at a given version
 *
 * @param collection - the collection name of the snapshot
 * @param id - the ID of the snapshot
 * @param version (optional) - the version number to fetch. If null, the latest version is fetched.
 * @param callback - (error, snapshot) => void, where snapshot takes the following schema:
 *
 * {
 *   id: string;         // ID of the snapshot
 *   v: number;          // version number of the snapshot
 *   type: string;       // the OT type of the snapshot, or null if it doesn't exist or is deleted
 *   data: any;          // the snapshot
 * }
 *
 */Connection.prototype.fetchSnapshot=function(collection,id,version,callback){if(typeof version==='function'){callback=version;version=null;}var requestId=this.nextSnapshotRequestId++;var snapshotRequest=new SnapshotVersionRequest(this,requestId,collection,id,version,callback);this._snapshotRequests[snapshotRequest.requestId]=snapshotRequest;snapshotRequest.send();};/**
 * Fetch a read-only snapshot at a given timestamp
 *
 * @param collection - the collection name of the snapshot
 * @param id - the ID of the snapshot
 * @param timestamp (optional) - the timestamp to fetch. If null, the latest version is fetched.
 * @param callback - (error, snapshot) => void, where snapshot takes the following schema:
 *
 * {
 *   id: string;         // ID of the snapshot
 *   v: number;          // version number of the snapshot
 *   type: string;       // the OT type of the snapshot, or null if it doesn't exist or is deleted
 *   data: any;          // the snapshot
 * }
 *
 */Connection.prototype.fetchSnapshotByTimestamp=function(collection,id,timestamp,callback){if(typeof timestamp==='function'){callback=timestamp;timestamp=null;}var requestId=this.nextSnapshotRequestId++;var snapshotRequest=new SnapshotTimestampRequest(this,requestId,collection,id,timestamp,callback);this._snapshotRequests[snapshotRequest.requestId]=snapshotRequest;snapshotRequest.send();};Connection.prototype._handleSnapshotFetch=function(error,message){var snapshotRequest=this._snapshotRequests[message.id];if(!snapshotRequest)return;delete this._snapshotRequests[message.id];snapshotRequest._handleResponse(error,message);};}).call(this,require('_process'));},{"../emitter":84,"../error":85,"../logger":86,"../types":89,"../util":90,"./doc":78,"./query":80,"./snapshot-request/snapshot-timestamp-request":82,"./snapshot-request/snapshot-version-request":83,"_process":40}],78:[function(require,module,exports){(function(process){var emitter=require('../emitter');var logger=require('../logger');var ShareDBError=require('../error');var types=require('../types');var ERROR_CODE=ShareDBError.CODES;/**
 * A Doc is a client's view on a sharejs document.
 *
 * It is is uniquely identified by its `id` and `collection`.  Documents
 * should not be created directly. Create them with connection.get()
 *
 *
 * Subscriptions
 * -------------
 *
 * We can subscribe a document to stay in sync with the server.
 *   doc.subscribe(function(error) {
 *     doc.subscribed // = true
 *   })
 * The server now sends us all changes concerning this document and these are
 * applied to our data. If the subscription was successful the initial
 * data and version sent by the server are loaded into the document.
 *
 * To stop listening to the changes we call `doc.unsubscribe()`.
 *
 * If we just want to load the data but not stay up-to-date, we call
 *   doc.fetch(function(error) {
 *     doc.data // sent by server
 *   })
 *
 *
 * Events
 * ------
 *
 * You can use doc.on(eventName, callback) to subscribe to the following events:
 * - `before op (op, source)` Fired before a partial operation is applied to the data.
 *   It may be used to read the old data just before applying an operation
 * - `op (op, source)` Fired after every partial operation with this operation as the
 *   first argument
 * - `create (source)` The document was created. That means its type was
 *   set and it has some initial data.
 * - `del (data, source)` Fired after the document is deleted, that is
 *   the data is null. It is passed the data before delteion as an
 *   arguments
 * - `load ()` Fired when a new snapshot is ingested from a fetch, subscribe, or query
 */module.exports=Doc;function Doc(connection,collection,id){emitter.EventEmitter.call(this);this.connection=connection;this.collection=collection;this.id=id;this.version=null;this.type=null;this.data=undefined;// Array of callbacks or nulls as placeholders
this.inflightFetch=[];this.inflightSubscribe=[];this.inflightUnsubscribe=[];this.pendingFetch=[];// Whether we think we are subscribed on the server. Synchronously set to
// false on calls to unsubscribe and disconnect. Should never be true when
// this.wantSubscribe is false
this.subscribed=false;// Whether to re-establish the subscription on reconnect
this.wantSubscribe=false;// The op that is currently roundtripping to the server, or null.
//
// When the connection reconnects, the inflight op is resubmitted.
//
// This has the same format as an entry in pendingOps
this.inflightOp=null;// All ops that are waiting for the server to acknowledge this.inflightOp
// This used to just be a single operation, but creates & deletes can't be
// composed with regular operations.
//
// This is a list of {[create:{...}], [del:true], [op:...], callbacks:[...]}
this.pendingOps=[];// The OT type of this document. An uncreated document has type `null`
this.type=null;// The applyStack enables us to track any ops submitted while we are
// applying an op incrementally. This value is an array when we are
// performing an incremental apply and null otherwise. When it is an array,
// all submitted ops should be pushed onto it. The `_otApply` method will
// reset it back to null when all incremental apply loops are complete.
this.applyStack=null;// Disable the default behavior of composing submitted ops. This is read at
// the time of op submit, so it may be toggled on before submitting a
// specifc op and toggled off afterward
this.preventCompose=false;}emitter.mixin(Doc);Doc.prototype.destroy=function(callback){var doc=this;doc.whenNothingPending(function(){if(doc.wantSubscribe){doc.unsubscribe(function(err){if(err){if(callback)return callback(err);return doc.emit('error',err);}doc.connection._destroyDoc(doc);if(callback)callback();});}else{doc.connection._destroyDoc(doc);if(callback)callback();}});};// ****** Manipulating the document data, version and type.
// Set the document's type, and associated properties. Most of the logic in
// this function exists to update the document based on any added & removed API
// methods.
//
// @param newType OT type provided by the ottypes library or its name or uri
Doc.prototype._setType=function(newType){if(typeof newType==='string'){newType=types.map[newType];}if(newType){this.type=newType;}else if(newType===null){this.type=newType;// If we removed the type from the object, also remove its data
this.data=undefined;}else{var err=new ShareDBError(ERROR_CODE.ERR_DOC_TYPE_NOT_RECOGNIZED,'Missing type '+newType);return this.emit('error',err);}};// Ingest snapshot data. This data must include a version, snapshot and type.
// This is used both to ingest data that was exported with a webpage and data
// that was received from the server during a fetch.
//
// @param snapshot.v    version
// @param snapshot.data
// @param snapshot.type
// @param callback
Doc.prototype.ingestSnapshot=function(snapshot,callback){if(!snapshot)return callback&&callback();if(typeof snapshot.v!=='number'){var err=new ShareDBError(ERROR_CODE.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,'Missing version in ingested snapshot. '+this.collection+'.'+this.id);if(callback)return callback(err);return this.emit('error',err);}// If the doc is already created or there are ops pending, we cannot use the
// ingested snapshot and need ops in order to update the document
if(this.type||this.hasWritePending()){// The version should only be null on a created document when it was
// created locally without fetching
if(this.version==null){if(this.hasWritePending()){// If we have pending ops and we get a snapshot for a locally created
// document, we have to wait for the pending ops to complete, because
// we don't know what version to fetch ops from. It is possible that
// the snapshot came from our local op, but it is also possible that
// the doc was created remotely (which would conflict and be an error)
return callback&&this.once('no write pending',callback);}// Otherwise, we've encounted an error state
var err=new ShareDBError(ERROR_CODE.ERR_DOC_MISSING_VERSION,'Cannot ingest snapshot in doc with null version. '+this.collection+'.'+this.id);if(callback)return callback(err);return this.emit('error',err);}// If we got a snapshot for a version further along than the document is
// currently, issue a fetch to get the latest ops and catch us up
if(snapshot.v>this.version)return this.fetch(callback);return callback&&callback();}// Ignore the snapshot if we are already at a newer version. Under no
// circumstance should we ever set the current version backward
if(this.version>snapshot.v)return callback&&callback();this.version=snapshot.v;var type=snapshot.type===undefined?types.defaultType:snapshot.type;this._setType(type);this.data=this.type&&this.type.deserialize?this.type.deserialize(snapshot.data):snapshot.data;this.emit('load');callback&&callback();};Doc.prototype.whenNothingPending=function(callback){var doc=this;process.nextTick(function(){if(doc.hasPending()){doc.once('nothing pending',callback);return;}callback();});};Doc.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe.length||this.inflightUnsubscribe.length||this.pendingFetch.length);};Doc.prototype.hasWritePending=function(){return!!(this.inflightOp||this.pendingOps.length);};Doc.prototype._emitNothingPending=function(){if(this.hasWritePending())return;this.emit('no write pending');if(this.hasPending())return;this.emit('nothing pending');};// **** Helpers for network messages
Doc.prototype._emitResponseError=function(err,callback){if(err&&err.code===ERROR_CODE.ERR_SNAPSHOT_READ_SILENT_REJECTION){this.wantSubscribe=false;if(callback){callback();}this._emitNothingPending();return;}if(callback){callback(err);this._emitNothingPending();return;}this._emitNothingPending();this.emit('error',err);};Doc.prototype._handleFetch=function(err,snapshot){var callback=this.inflightFetch.shift();if(err)return this._emitResponseError(err,callback);this.ingestSnapshot(snapshot,callback);this._emitNothingPending();};Doc.prototype._handleSubscribe=function(err,snapshot){var callback=this.inflightSubscribe.shift();if(err)return this._emitResponseError(err,callback);// Indicate we are subscribed only if the client still wants to be. In the
// time since calling subscribe and receiving a response from the server,
// unsubscribe could have been called and we might already be unsubscribed
// but not have received the response. Also, because requests from the
// client are not serialized and may take different async time to process,
// it is possible that we could hear responses back in a different order
// from the order originally sent
if(this.wantSubscribe)this.subscribed=true;this.ingestSnapshot(snapshot,callback);this._emitNothingPending();};Doc.prototype._handleUnsubscribe=function(err){var callback=this.inflightUnsubscribe.shift();if(err)return this._emitResponseError(err,callback);if(callback)callback();this._emitNothingPending();};Doc.prototype._handleOp=function(err,message){if(err){if(this.inflightOp){// The server has rejected submission of the current operation. If we get
// an "Op submit rejected" error, this was done intentionally
// and we should roll back but not return an error to the user.
if(err.code===ERROR_CODE.ERR_OP_SUBMIT_REJECTED)err=null;return this._rollback(err);}return this.emit('error',err);}if(this.inflightOp&&message.src===this.inflightOp.src&&message.seq===this.inflightOp.seq){// The op has already been applied locally. Just update the version
// and pending state appropriately
this._opAcknowledged(message);return;}if(this.version==null||message.v>this.version){// This will happen in normal operation if we become subscribed to a
// new document via a query. It can also happen if we get an op for
// a future version beyond the version we are expecting next. This
// could happen if the server doesn't publish an op for whatever reason
// or because of a race condition. In any case, we can send a fetch
// command to catch back up.
//
// Fetch only sends a new fetch command if no fetches are inflight, which
// will act as a natural debouncing so we don't send multiple fetch
// requests for many ops received at once.
this.fetch();return;}if(message.v<this.version){// We can safely ignore the old (duplicate) operation.
return;}if(this.inflightOp){var transformErr=transformX(this.inflightOp,message);if(transformErr)return this._hardRollback(transformErr);}for(var i=0;i<this.pendingOps.length;i++){var transformErr=transformX(this.pendingOps[i],message);if(transformErr)return this._hardRollback(transformErr);}this.version++;try{this._otApply(message,false);}catch(error){return this._hardRollback(error);}};// Called whenever (you guessed it!) the connection state changes. This will
// happen when we get disconnected & reconnect.
Doc.prototype._onConnectionStateChanged=function(){if(this.connection.canSend){this.flush();this._resubscribe();}else{if(this.inflightOp){this.pendingOps.unshift(this.inflightOp);this.inflightOp=null;}this.subscribed=false;if(this.inflightFetch.length||this.inflightSubscribe.length){this.pendingFetch=this.pendingFetch.concat(this.inflightFetch,this.inflightSubscribe);this.inflightFetch.length=0;this.inflightSubscribe.length=0;}if(this.inflightUnsubscribe.length){var callbacks=this.inflightUnsubscribe;this.inflightUnsubscribe=[];callEach(callbacks);}}};Doc.prototype._resubscribe=function(){var callbacks=this.pendingFetch;this.pendingFetch=[];if(this.wantSubscribe){if(callbacks.length){this.subscribe(function(err){callEach(callbacks,err);});return;}this.subscribe();return;}if(callbacks.length){this.fetch(function(err){callEach(callbacks,err);});}};// Request the current document snapshot or ops that bring us up to date
Doc.prototype.fetch=function(callback){if(this.connection.canSend){var isDuplicate=this.connection.sendFetch(this);pushActionCallback(this.inflightFetch,isDuplicate,callback);return;}this.pendingFetch.push(callback);};// Fetch the initial document and keep receiving updates
Doc.prototype.subscribe=function(callback){this.wantSubscribe=true;if(this.connection.canSend){var isDuplicate=this.connection.sendSubscribe(this);pushActionCallback(this.inflightSubscribe,isDuplicate,callback);return;}this.pendingFetch.push(callback);};// Unsubscribe. The data will stay around in local memory, but we'll stop
// receiving updates
Doc.prototype.unsubscribe=function(callback){this.wantSubscribe=false;// The subscribed state should be conservative in indicating when we are
// subscribed on the server. We'll actually be unsubscribed some time
// between sending the message and hearing back, but we cannot know exactly
// when. Thus, immediately mark us as not subscribed
this.subscribed=false;if(this.connection.canSend){var isDuplicate=this.connection.sendUnsubscribe(this);pushActionCallback(this.inflightUnsubscribe,isDuplicate,callback);return;}if(callback)process.nextTick(callback);};function pushActionCallback(inflight,isDuplicate,callback){if(isDuplicate){var lastCallback=inflight.pop();inflight.push(function(err){lastCallback&&lastCallback(err);callback&&callback(err);});}else{inflight.push(callback);}}// Operations //
// Send the next pending op to the server, if we can.
//
// Only one operation can be in-flight at a time. If an operation is already on
// its way, or we're not currently connected, this method does nothing.
Doc.prototype.flush=function(){// Ignore if we can't send or we are already sending an op
if(!this.connection.canSend||this.inflightOp)return;// Send first pending op unless paused
if(!this.paused&&this.pendingOps.length){this._sendOp();}};// Helper function to set op to contain a no-op.
function setNoOp(op){delete op.op;delete op.create;delete op.del;}// Transform server op data by a client op, and vice versa. Ops are edited in place.
function transformX(client,server){// Order of statements in this function matters. Be especially careful if
// refactoring this function
// A client delete op should dominate if both the server and the client
// delete the document. Thus, any ops following the client delete (such as a
// subsequent create) will be maintained, since the server op is transformed
// to a no-op
if(client.del)return setNoOp(server);if(server.del){return new ShareDBError(ERROR_CODE.ERR_DOC_WAS_DELETED,'Document was deleted');}if(server.create){return new ShareDBError(ERROR_CODE.ERR_DOC_ALREADY_CREATED,'Document already created');}// Ignore no-op coming from server
if(!server.op)return;// I believe that this should not occur, but check just in case
if(client.create){return new ShareDBError(ERROR_CODE.ERR_DOC_ALREADY_CREATED,'Document already created');}// They both edited the document. This is the normal case for this function -
// as in, most of the time we'll end up down here.
//
// You should be wondering why I'm using client.type instead of this.type.
// The reason is, if we get ops at an old version of the document, this.type
// might be undefined or a totally different type. By pinning the type to the
// op data, we make sure the right type has its transform function called.
if(client.type.transformX){var result=client.type.transformX(client.op,server.op);client.op=result[0];server.op=result[1];}else{var clientOp=client.type.transform(client.op,server.op,'left');var serverOp=client.type.transform(server.op,client.op,'right');client.op=clientOp;server.op=serverOp;}};/**
 * Applies the operation to the snapshot
 *
 * If the operation is create or delete it emits `create` or `del`. Then the
 * operation is applied to the snapshot and `op` and `after op` are emitted.
 * If the type supports incremental updates and `this.incremental` is true we
 * fire `op` after every small operation.
 *
 * This is the only function to fire the above mentioned events.
 *
 * @private
 */Doc.prototype._otApply=function(op,source){if(op.op){if(!this.type){// Throw here, because all usage of _otApply should be wrapped with a try/catch
throw new ShareDBError(ERROR_CODE.ERR_DOC_DOES_NOT_EXIST,'Cannot apply op to uncreated document. '+this.collection+'.'+this.id);}// Iteratively apply multi-component remote operations and rollback ops
// (source === false) for the default JSON0 OT type. It could use
// type.shatter(), but since this code is so specific to use cases for the
// JSON0 type and ShareDB explicitly bundles the default type, we might as
// well write it this way and save needing to iterate through the op
// components twice.
//
// Ideally, we would not need this extra complexity. However, it is
// helpful for implementing bindings that update DOM nodes and other
// stateful objects by translating op events directly into corresponding
// mutations. Such bindings are most easily written as responding to
// individual op components one at a time in order, and it is important
// that the snapshot only include updates from the particular op component
// at the time of emission. Eliminating this would require rethinking how
// such external bindings are implemented.
if(!source&&this.type===types.defaultType&&op.op.length>1){if(!this.applyStack)this.applyStack=[];var stackLength=this.applyStack.length;for(var i=0;i<op.op.length;i++){var component=op.op[i];var componentOp={op:[component]};// Transform componentOp against any ops that have been submitted
// sychronously inside of an op event handler since we began apply of
// our operation
for(var j=stackLength;j<this.applyStack.length;j++){var transformErr=transformX(this.applyStack[j],componentOp);if(transformErr)return this._hardRollback(transformErr);}// Apply the individual op component
this.emit('before op',componentOp.op,source);this.data=this.type.apply(this.data,componentOp.op);this.emit('op',componentOp.op,source);}// Pop whatever was submitted since we started applying this op
this._popApplyStack(stackLength);return;}// The 'before op' event enables clients to pull any necessary data out of
// the snapshot before it gets changed
this.emit('before op',op.op,source);// Apply the operation to the local data, mutating it in place
this.data=this.type.apply(this.data,op.op);// Emit an 'op' event once the local data includes the changes from the
// op. For locally submitted ops, this will be synchronously with
// submission and before the server or other clients have received the op.
// For ops from other clients, this will be after the op has been
// committed to the database and published
this.emit('op',op.op,source);return;}if(op.create){this._setType(op.create.type);this.data=this.type.deserialize?this.type.createDeserialized?this.type.createDeserialized(op.create.data):this.type.deserialize(this.type.create(op.create.data)):this.type.create(op.create.data);this.emit('create',source);return;}if(op.del){var oldData=this.data;this._setType(null);this.emit('del',oldData,source);return;}};// ***** Sending operations
// Actually send op to the server.
Doc.prototype._sendOp=function(){// Wait until we have a src id from the server
var src=this.connection.id;if(!src)return;// When there is no inflightOp, send the first item in pendingOps. If
// there is inflightOp, try sending it again
if(!this.inflightOp){// Send first pending op
this.inflightOp=this.pendingOps.shift();}var op=this.inflightOp;if(!op){var err=new ShareDBError(ERROR_CODE.ERR_INFLIGHT_OP_MISSING,'No op to send on call to _sendOp');return this.emit('error',err);}// Track data for retrying ops
op.sentAt=Date.now();op.retries=op.retries==null?0:op.retries+1;// The src + seq number is a unique ID representing this operation. This tuple
// is used on the server to detect when ops have been sent multiple times and
// on the client to match acknowledgement of an op back to the inflightOp.
// Note that the src could be different from this.connection.id after a
// reconnect, since an op may still be pending after the reconnection and
// this.connection.id will change. In case an op is sent multiple times, we
// also need to be careful not to override the original seq value.
if(op.seq==null)op.seq=this.connection.seq++;this.connection.sendOp(this,op);// src isn't needed on the first try, since the server session will have the
// same id, but it must be set on the inflightOp in case it is sent again
// after a reconnect and the connection's id has changed by then
if(op.src==null)op.src=src;};// Queues the operation for submission to the server and applies it locally.
//
// Internal method called to do the actual work for submit(), create() and del().
// @private
//
// @param op
// @param [op.op]
// @param [op.del]
// @param [op.create]
// @param [callback] called when operation is submitted
Doc.prototype._submit=function(op,source,callback){// Locally submitted ops must always have a truthy source
if(!source)source=true;// The op contains either op, create, delete, or none of the above (a no-op).
if(op.op){if(!this.type){var err=new ShareDBError(ERROR_CODE.ERR_DOC_DOES_NOT_EXIST,'Cannot submit op. Document has not been created. '+this.collection+'.'+this.id);if(callback)return callback(err);return this.emit('error',err);}// Try to normalize the op. This removes trailing skip:0's and things like that.
if(this.type.normalize)op.op=this.type.normalize(op.op);}try{this._pushOp(op,callback);this._otApply(op,source);}catch(error){return this._hardRollback(error);}// The call to flush is delayed so if submit() is called multiple times
// synchronously, all the ops are combined before being sent to the server.
var doc=this;process.nextTick(function(){doc.flush();});};Doc.prototype._pushOp=function(op,callback){if(this.applyStack){// If we are in the process of incrementally applying an operation, don't
// compose the op and push it onto the applyStack so it can be transformed
// against other components from the op or ops being applied
this.applyStack.push(op);}else{// If the type supports composes, try to compose the operation onto the
// end of the last pending operation.
var composed=this._tryCompose(op);if(composed){composed.callbacks.push(callback);return;}}// Push on to the pendingOps queue of ops to submit if we didn't compose
op.type=this.type;op.callbacks=[callback];this.pendingOps.push(op);};Doc.prototype._popApplyStack=function(to){if(to>0){this.applyStack.length=to;return;}// Once we have completed the outermost apply loop, reset to null and no
// longer add ops to the applyStack as they are submitted
var op=this.applyStack[0];this.applyStack=null;if(!op)return;// Compose the ops added since the beginning of the apply stack, since we
// had to skip compose when they were originally pushed
var i=this.pendingOps.indexOf(op);if(i===-1)return;var ops=this.pendingOps.splice(i);for(var i=0;i<ops.length;i++){var op=ops[i];var composed=this._tryCompose(op);if(composed){composed.callbacks=composed.callbacks.concat(op.callbacks);}else{this.pendingOps.push(op);}}};// Try to compose a submitted op into the last pending op. Returns the
// composed op if it succeeds, undefined otherwise
Doc.prototype._tryCompose=function(op){if(this.preventCompose)return;// We can only compose into the last pending op. Inflight ops have already
// been sent to the server, so we can't modify them
var last=this.pendingOps[this.pendingOps.length-1];if(!last||last.sentAt)return;// Compose an op into a create by applying it. This effectively makes the op
// invisible, as if the document were created including the op originally
if(last.create&&op.op){last.create.data=this.type.apply(last.create.data,op.op);return last;}// Compose two ops into a single op if supported by the type. Types that
// support compose must be able to compose any two ops together
if(last.op&&op.op&&this.type.compose){last.op=this.type.compose(last.op,op.op);return last;}};// *** Client OT entrypoints.
// Submit an operation to the document.
//
// @param operation handled by the OT type
// @param options  {source: ...}
// @param [callback] called after operation submitted
//
// @fires before op, op, after op
Doc.prototype.submitOp=function(component,options,callback){if(typeof options==='function'){callback=options;options=null;}var op={op:component};var source=options&&options.source;this._submit(op,source,callback);};// Create the document, which in ShareJS semantics means to set its type. Every
// object implicitly exists in the database but has no data and no type. Create
// sets the type of the object and can optionally set some initial data on the
// object, depending on the type.
//
// @param data  initial
// @param type  OT type
// @param options  {source: ...}
// @param callback  called when operation submitted
Doc.prototype.create=function(data,type,options,callback){if(typeof type==='function'){callback=type;options=null;type=null;}else if(typeof options==='function'){callback=options;options=null;}if(!type){type=types.defaultType.uri;}if(this.type){var err=new ShareDBError(ERROR_CODE.ERR_DOC_ALREADY_CREATED,'Document already exists');if(callback)return callback(err);return this.emit('error',err);}var op={create:{type:type,data:data}};var source=options&&options.source;this._submit(op,source,callback);};// Delete the document. This creates and submits a delete operation to the
// server. Deleting resets the object's type to null and deletes its data. The
// document still exists, and still has the version it used to have before you
// deleted it (well, old version +1).
//
// @param options  {source: ...}
// @param callback  called when operation submitted
Doc.prototype.del=function(options,callback){if(typeof options==='function'){callback=options;options=null;}if(!this.type){var err=new ShareDBError(ERROR_CODE.ERR_DOC_DOES_NOT_EXIST,'Document does not exist');if(callback)return callback(err);return this.emit('error',err);}var op={del:true};var source=options&&options.source;this._submit(op,source,callback);};// Stops the document from sending any operations to the server.
Doc.prototype.pause=function(){this.paused=true;};// Continue sending operations to the server
Doc.prototype.resume=function(){this.paused=false;this.flush();};// *** Receiving operations
// This is called when the server acknowledges an operation from the client.
Doc.prototype._opAcknowledged=function(message){if(this.inflightOp.create){this.version=message.v;}else if(message.v!==this.version){// We should already be at the same version, because the server should
// have sent all the ops that have happened before acknowledging our op
logger.warn('Invalid version from server. Expected: '+this.version+' Received: '+message.v,message);// Fetching should get us back to a working document state
return this.fetch();}// The op was committed successfully. Increment the version number
this.version++;this._clearInflightOp();};Doc.prototype._rollback=function(err){// The server has rejected submission of the current operation. Invert by
// just the inflight op if possible. If not possible to invert, cancel all
// pending ops and fetch the latest from the server to get us back into a
// working state, then call back
var op=this.inflightOp;if(op.op&&op.type.invert){op.op=op.type.invert(op.op);// Transform the undo operation by any pending ops.
for(var i=0;i<this.pendingOps.length;i++){var transformErr=transformX(this.pendingOps[i],op);if(transformErr)return this._hardRollback(transformErr);}// ... and apply it locally, reverting the changes.
//
// This operation is applied to look like it comes from a remote source.
// I'm still not 100% sure about this functionality, because its really a
// local op. Basically, the problem is that if the client's op is rejected
// by the server, the editor window should update to reflect the undo.
try{this._otApply(op,false);}catch(error){return this._hardRollback(error);}this._clearInflightOp(err);return;}this._hardRollback(err);};Doc.prototype._hardRollback=function(err){// Store pending ops so that we can notify their callbacks of the error.
// We combine the inflight op and the pending ops, because it's possible
// to hit a condition where we have no inflight op, but we do have pending
// ops. This can happen when an invalid op is submitted, which causes us
// to hard rollback before the pending op was flushed.
var pendingOps=[];if(this.inflightOp)pendingOps.push(this.inflightOp);pendingOps=pendingOps.concat(this.pendingOps);// Cancel all pending ops and reset if we can't invert
this._setType(null);this.version=null;this.inflightOp=null;this.pendingOps=[];// Fetch the latest version from the server to get us back into a working state
var doc=this;this.fetch(function(){// We want to check that no errors are swallowed, so we check that:
// - there are callbacks to call, and
// - that every single pending op called a callback
// If there are no ops queued, or one of them didn't handle the error,
// then we emit the error.
var allOpsHadCallbacks=!!pendingOps.length;for(var i=0;i<pendingOps.length;i++){allOpsHadCallbacks=callEach(pendingOps[i].callbacks,err)&&allOpsHadCallbacks;}if(err&&!allOpsHadCallbacks)return doc.emit('error',err);});};Doc.prototype._clearInflightOp=function(err){var inflightOp=this.inflightOp;this.inflightOp=null;var called=callEach(inflightOp.callbacks,err);this.flush();this._emitNothingPending();if(err&&!called)return this.emit('error',err);};function callEach(callbacks,err){var called=false;for(var i=0;i<callbacks.length;i++){var callback=callbacks[i];if(callback){callback(err);called=true;}}return called;}}).call(this,require('_process'));},{"../emitter":84,"../error":85,"../logger":86,"../types":89,"_process":40}],79:[function(require,module,exports){exports.Connection=require('./connection');exports.Doc=require('./doc');exports.Error=require('../error');exports.Query=require('./query');exports.types=require('../types');exports.logger=require('../logger');},{"../error":85,"../logger":86,"../types":89,"./connection":77,"./doc":78,"./query":80}],80:[function(require,module,exports){(function(process){var emitter=require('../emitter');// Queries are live requests to the database for particular sets of fields.
//
// The server actively tells the client when there's new data that matches
// a set of conditions.
module.exports=Query;function Query(action,connection,id,collection,query,options,callback){emitter.EventEmitter.call(this);// 'qf' or 'qs'
this.action=action;this.connection=connection;this.id=id;this.collection=collection;// The query itself. For mongo, this should look something like {"data.x":5}
this.query=query;// A list of resulting documents. These are actual documents, complete with
// data and all the rest. It is possible to pass in an initial results set,
// so that a query can be serialized and then re-established
this.results=null;if(options&&options.results){this.results=options.results;delete options.results;}this.extra=undefined;// Options to pass through with the query
this.options=options;this.callback=callback;this.ready=false;this.sent=false;}emitter.mixin(Query);Query.prototype.hasPending=function(){return!this.ready;};// Helper for subscribe & fetch, since they share the same message format.
//
// This function actually issues the query.
Query.prototype.send=function(){if(!this.connection.canSend)return;var message={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options){message.o=this.options;}if(this.results){// Collect the version of all the documents in the current result set so we
// don't need to be sent their snapshots again.
var results=[];for(var i=0;i<this.results.length;i++){var doc=this.results[i];results.push([doc.id,doc.version]);}message.r=results;}this.connection.send(message);this.sent=true;};// Destroy the query object. Any subsequent messages for the query will be
// ignored by the connection.
Query.prototype.destroy=function(callback){if(this.connection.canSend&&this.action==='qs'){this.connection.send({a:'qu',id:this.id});}this.connection._destroyQuery(this);// There is a callback for consistency, but we don't actually wait for the
// server's unsubscribe message currently
if(callback)process.nextTick(callback);};Query.prototype._onConnectionStateChanged=function(){if(this.connection.canSend&&!this.sent){this.send();}else{this.sent=false;}};Query.prototype._handleFetch=function(err,data,extra){// Once a fetch query gets its data, it is destroyed.
this.connection._destroyQuery(this);this._handleResponse(err,data,extra);};Query.prototype._handleSubscribe=function(err,data,extra){this._handleResponse(err,data,extra);};Query.prototype._handleResponse=function(err,data,extra){var callback=this.callback;this.callback=null;if(err)return this._finishResponse(err,callback);if(!data)return this._finishResponse(null,callback);var query=this;var wait=1;var finish=function finish(err){if(err)return query._finishResponse(err,callback);if(--wait)return;query._finishResponse(null,callback);};if(Array.isArray(data)){wait+=data.length;this.results=this._ingestSnapshots(data,finish);this.extra=extra;}else{for(var id in data){wait++;var snapshot=data[id];var doc=this.connection.get(snapshot.c||this.collection,id);doc.ingestSnapshot(snapshot,finish);}}finish();};Query.prototype._ingestSnapshots=function(snapshots,finish){var results=[];for(var i=0;i<snapshots.length;i++){var snapshot=snapshots[i];var doc=this.connection.get(snapshot.c||this.collection,snapshot.d);doc.ingestSnapshot(snapshot,finish);results.push(doc);}return results;};Query.prototype._finishResponse=function(err,callback){this.emit('ready');this.ready=true;if(err){this.connection._destroyQuery(this);if(callback)return callback(err);return this.emit('error',err);}if(callback)callback(null,this.results,this.extra);};Query.prototype._handleError=function(err){this.emit('error',err);};Query.prototype._handleDiff=function(diff){// We need to go through the list twice. First, we'll ingest all the new
// documents. After that we'll emit events and actually update our list.
// This avoids race conditions around setting documents to be subscribed &
// unsubscribing documents in event callbacks.
for(var i=0;i<diff.length;i++){var d=diff[i];if(d.type==='insert')d.values=this._ingestSnapshots(d.values);}for(var i=0;i<diff.length;i++){var d=diff[i];switch(d.type){case'insert':var newDocs=d.values;Array.prototype.splice.apply(this.results,[d.index,0].concat(newDocs));this.emit('insert',newDocs,d.index);break;case'remove':var howMany=d.howMany||1;var removed=this.results.splice(d.index,howMany);this.emit('remove',removed,d.index);break;case'move':var howMany=d.howMany||1;var docs=this.results.splice(d.from,howMany);Array.prototype.splice.apply(this.results,[d.to,0].concat(docs));this.emit('move',docs,d.from,d.to);break;}}this.emit('changed',this.results);};Query.prototype._handleExtra=function(extra){this.extra=extra;this.emit('extra',extra);};}).call(this,require('_process'));},{"../emitter":84,"_process":40}],81:[function(require,module,exports){var Snapshot=require('../../snapshot');var emitter=require('../../emitter');module.exports=SnapshotRequest;function SnapshotRequest(connection,requestId,collection,id,callback){emitter.EventEmitter.call(this);if(typeof callback!=='function'){throw new Error('Callback is required for SnapshotRequest');}this.requestId=requestId;this.connection=connection;this.id=id;this.collection=collection;this.callback=callback;this.sent=false;}emitter.mixin(SnapshotRequest);SnapshotRequest.prototype.send=function(){if(!this.connection.canSend){return;}this.connection.send(this._message());this.sent=true;};SnapshotRequest.prototype._onConnectionStateChanged=function(){if(this.connection.canSend){if(!this.sent)this.send();}else{// If the connection can't send, then we've had a disconnection, and even if we've already sent
// the request previously, we need to re-send it over this reconnected client, so reset the
// sent flag to false.
this.sent=false;}};SnapshotRequest.prototype._handleResponse=function(error,message){this.emit('ready');if(error){return this.callback(error);}var metadata=message.meta?message.meta:null;var snapshot=new Snapshot(this.id,message.v,message.type,message.data,metadata);this.callback(null,snapshot);};},{"../../emitter":84,"../../snapshot":88}],82:[function(require,module,exports){var SnapshotRequest=require('./snapshot-request');var util=require('../../util');module.exports=SnapshotTimestampRequest;function SnapshotTimestampRequest(connection,requestId,collection,id,timestamp,callback){SnapshotRequest.call(this,connection,requestId,collection,id,callback);if(!util.isValidTimestamp(timestamp)){throw new Error('Snapshot timestamp must be a positive integer or null');}this.timestamp=timestamp;}SnapshotTimestampRequest.prototype=Object.create(SnapshotRequest.prototype);SnapshotTimestampRequest.prototype._message=function(){return{a:'nt',id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp};};},{"../../util":90,"./snapshot-request":81}],83:[function(require,module,exports){var SnapshotRequest=require('./snapshot-request');var util=require('../../util');module.exports=SnapshotVersionRequest;function SnapshotVersionRequest(connection,requestId,collection,id,version,callback){SnapshotRequest.call(this,connection,requestId,collection,id,callback);if(!util.isValidVersion(version)){throw new Error('Snapshot version must be a positive integer or null');}this.version=version;}SnapshotVersionRequest.prototype=Object.create(SnapshotRequest.prototype);SnapshotVersionRequest.prototype._message=function(){return{a:'nf',id:this.requestId,c:this.collection,d:this.id,v:this.version};};},{"../../util":90,"./snapshot-request":81}],84:[function(require,module,exports){var EventEmitter=require('events').EventEmitter;exports.EventEmitter=EventEmitter;exports.mixin=mixin;function mixin(Constructor){for(var key in EventEmitter.prototype){Constructor.prototype[key]=EventEmitter.prototype[key];}}},{"events":33}],85:[function(require,module,exports){function ShareDBError(code,message){this.code=code;this.message=message||'';if(Error.captureStackTrace){Error.captureStackTrace(this,ShareDBError);}else{this.stack=new Error().stack;}}ShareDBError.prototype=Object.create(Error.prototype);ShareDBError.prototype.constructor=ShareDBError;ShareDBError.prototype.name='ShareDBError';ShareDBError.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:'ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT',ERR_APPLY_SNAPSHOT_NOT_PROVIDED:'ERR_APPLY_SNAPSHOT_NOT_PROVIDED',ERR_CLIENT_ID_BADLY_FORMED:'ERR_CLIENT_ID_BADLY_FORMED',ERR_CONNECTION_STATE_TRANSITION_INVALID:'ERR_CONNECTION_STATE_TRANSITION_INVALID',ERR_DATABASE_ADAPTER_NOT_FOUND:'ERR_DATABASE_ADAPTER_NOT_FOUND',ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:'ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE',ERR_DATABASE_METHOD_NOT_IMPLEMENTED:'ERR_DATABASE_METHOD_NOT_IMPLEMENTED',ERR_DEFAULT_TYPE_MISMATCH:'ERR_DEFAULT_TYPE_MISMATCH',ERR_DOC_MISSING_VERSION:'ERR_DOC_MISSING_VERSION',ERR_DOC_ALREADY_CREATED:'ERR_DOC_ALREADY_CREATED',ERR_DOC_DOES_NOT_EXIST:'ERR_DOC_DOES_NOT_EXIST',ERR_DOC_TYPE_NOT_RECOGNIZED:'ERR_DOC_TYPE_NOT_RECOGNIZED',ERR_DOC_WAS_DELETED:'ERR_DOC_WAS_DELETED',ERR_INFLIGHT_OP_MISSING:'ERR_INFLIGHT_OP_MISSING',ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:'ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION',ERR_MAX_SUBMIT_RETRIES_EXCEEDED:'ERR_MAX_SUBMIT_RETRIES_EXCEEDED',ERR_MESSAGE_BADLY_FORMED:'ERR_MESSAGE_BADLY_FORMED',ERR_MILESTONE_ARGUMENT_INVALID:'ERR_MILESTONE_ARGUMENT_INVALID',ERR_OP_ALREADY_SUBMITTED:'ERR_OP_ALREADY_SUBMITTED',ERR_OP_NOT_ALLOWED_IN_PROJECTION:'ERR_OP_NOT_ALLOWED_IN_PROJECTION',ERR_OP_SUBMIT_REJECTED:'ERR_OP_SUBMIT_REJECTED',ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:'ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM',ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:'ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM',ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:'ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT',ERR_OT_OP_BADLY_FORMED:'ERR_OT_OP_BADLY_FORMED',ERR_OT_OP_NOT_PROVIDED:'ERR_OT_OP_NOT_PROVIDED',ERR_PROTOCOL_VERSION_NOT_SUPPORTED:'ERR_PROTOCOL_VERSION_NOT_SUPPORTED',ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:'ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED',/**
   * A special error that a "readSnapshots" middleware implementation can use to indicate that it
   * wishes for the ShareDB client to treat it as a silent rejection, not passing the error back to
   * user code.
   *
   * For subscribes, the ShareDB client will still cancel the document subscription.
   */ERR_SNAPSHOT_READ_SILENT_REJECTION:'ERR_SNAPSHOT_READ_SILENT_REJECTION',/**
   * A "readSnapshots" middleware rejected the reads of specific snapshots.
   *
   * This error code is mostly for server use and generally will not be encountered on the client.
   * Instead, each specific doc that encountered an error will receive its specific error.
   *
   * The one exception is for queries, where a "readSnapshots" rejection of specific snapshots will
   * cause the client to receive this error for the whole query, since queries don't support
   * doc-specific errors.
   */ERR_SNAPSHOT_READS_REJECTED:'ERR_SNAPSHOT_READS_REJECTED',ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:'ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND',ERR_TYPE_CANNOT_BE_PROJECTED:'ERR_TYPE_CANNOT_BE_PROJECTED',ERR_UNKNOWN_ERROR:'ERR_UNKNOWN_ERROR'};module.exports=ShareDBError;},{}],86:[function(require,module,exports){var Logger=require('./logger');var logger=new Logger();module.exports=logger;},{"./logger":87}],87:[function(require,module,exports){var SUPPORTED_METHODS=['info','warn','error'];function Logger(){var defaultMethods={};SUPPORTED_METHODS.forEach(function(method){// Deal with Chrome issue: https://bugs.chromium.org/p/chromium/issues/detail?id=179628
defaultMethods[method]=console[method].bind(console);});this.setMethods(defaultMethods);}module.exports=Logger;Logger.prototype.setMethods=function(overrides){overrides=overrides||{};var logger=this;SUPPORTED_METHODS.forEach(function(method){if(typeof overrides[method]==='function'){logger[method]=overrides[method];}});};},{}],88:[function(require,module,exports){module.exports=Snapshot;function Snapshot(id,version,type,data,meta){this.id=id;this.v=version;this.type=type;this.data=data;this.m=meta;}},{}],89:[function(require,module,exports){exports.defaultType=require('ot-json0').type;exports.map={};exports.register=function(type){if(type.name)exports.map[type.name]=type;if(type.uri)exports.map[type.uri]=type;};exports.register(exports.defaultType);},{"ot-json0":36}],90:[function(require,module,exports){exports.doNothing=doNothing;function doNothing(){}exports.hasKeys=function(object){for(var key in object){return true;}return false;};// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/isInteger#Polyfill
exports.isInteger=Number.isInteger||function(value){return typeof value==='number'&&isFinite(value)&&Math.floor(value)===value;};exports.isValidVersion=function(version){if(version===null)return true;return exports.isInteger(version)&&version>=0;};exports.isValidTimestamp=function(timestamp){return exports.isValidVersion(timestamp);};},{}],91:[function(require,module,exports){var qs=require('qs');var parseUrl=require('url').parse;var resolveUrl=require('url').resolve;var router=require('./router');var currentPath=window.location.pathname+window.location.search;// Replace the initial state with the current URL immediately,
// so that it will be rendered if the state is later popped
if(window.history.replaceState){window.history.replaceState({$render:true,$method:'get'},null,window.location.href);}module.exports=History;function History(app,routes){this.app=app;this.routes=routes;if(window.history.pushState){addListeners(this);return;}this.push=function(url){window.location.assign(url);};this.replace=function(url){window.location.replace(url);};}History.prototype.push=function(url,render,state,e){this._update('pushState',url,render,state,e);};History.prototype.replace=function(url,render,state,e){this._update('replaceState',url,render,state,e);};// Rerender the current url locally
History.prototype.refresh=function(){var path=routePath(window.location.href);// Note that we don't pass previous to avoid triggering transitions
router.render(this,{url:path,method:'get'});};History.prototype.back=function(){window.history.back();};History.prototype.forward=function(){window.history.forward();};History.prototype.go=function(i){window.history.go(i);};History.prototype._update=function(historyMethod,relativeUrl,render,state,e){var url=resolveUrl(window.location.href,relativeUrl);var path=routePath(url);// TODO: history.push should set the window.location with external urls
if(!path)return;if(render==null)render=true;if(state==null)state={};// Update the URL
var options=renderOptions(e,path);state.$render=true;state.$method=options.method;window.history[historyMethod](state,null,options.url);currentPath=window.location.pathname+window.location.search;if(render)router.render(this,options,e);};History.prototype.page=function(){var page=this.app.createPage();var history=this;function redirect(url){if(url==='back')return history.back();// TODO: Add support for `basepath` option like Express
if(url==='home')url='\\';history.replace(url,true);}page.redirect=redirect;return page;};// Get the pathname if it is on the same protocol and domain
function routePath(url){var match=parseUrl(url);return match&&match.protocol===window.location.protocol&&match.host===window.location.host&&match.pathname+(match.search||'');}function renderOptions(e,path){// If this is a form submission, extract the form data and
// append it to the url for a get or params.body for a post
if(e&&e.type==='submit'){var form=e.target;var elements=form.elements;var query=[];for(var i=0,len=elements.length,el;i<len;i++){el=elements[i];var name=el.name;if(!name)continue;var value=el.value;query.push(encodeURIComponent(name)+'='+encodeURIComponent(value));if(name==='_method'){var override=value.toLowerCase();if(override==='delete')override='del';}}query=query.join('&');if(form.method.toLowerCase()==='post'){var method=override||'post';var body=qs.parse(query);}else{method='get';path+='?'+query;}}else{method='get';}return{method:method,url:path,previous:window.location.pathname+window.location.search,body:body,form:form,link:e&&e._tracksLink};}function addListeners(history){// Detect clicks on links
function onClick(e){var el=e.target;// Ignore command click, control click, and non-left click
if(e.metaKey||e.which!==1)return;// Ignore if already prevented
if(e.defaultPrevented)return;// Also look up for parent links (<a><img></a>)
while(el){var url=el.href;if(url){// Ignore if created by Tracks
if(el.hasAttribute&&el.hasAttribute('data-router-ignore'))return;// Ignore links meant to open in a different window or frame
if(el.target&&el.target!=='_self')return;// Ignore hash links to the same page
var hashIndex=url.indexOf('#');if(~hashIndex&&url.slice(0,hashIndex)===window.location.href.replace(/#.*/,'')){return;}e._tracksLink=el;history.push(url,true,null,e);return;}el=el.parentNode;}}function onSubmit(e){var target=e.target;// Ignore if already prevented
if(e.defaultPrevented)return;// Only handle if emitted on a form element that isn't multipart
if(target.tagName.toLowerCase()!=='form')return;if(target.enctype==='multipart/form-data')return;// Ignore if created by Tracks
if(target.hasAttribute&&target.hasAttribute('data-router-ignore'))return;// Use the url from the form action, defaulting to the current url
var url=target.action||window.location.href;history.push(url,true,null,e);}function onPopState(e){// HACK: Chrome sometimes does a pop state before the app is set up properly
if(!history.app.page)return;var previous=currentPath;var state=e.state;currentPath=window.location.pathname+window.location.search;var options={previous:previous,url:currentPath};if(state){if(!state.$render)return;options.method=state.$method;// Note that the post body is only sent on the initial reqest
// and it is empty if the state is later popped
return router.render(history,options);}// The state object will be null for states created by jump links.
// window.location.hash cannot be used, because it returns nothing
// if the url ends in just a hash character
var url=window.location.href,hashIndex=url.indexOf('#'),el,id;if(~hashIndex&&currentPath!==previous){options.method='get';router.render(history,options);id=url.slice(hashIndex+1);if(el=document.getElementById(id)||document.getElementsByName(id)[0]){el.scrollIntoView();}}}document.addEventListener('click',onClick,true);document.addEventListener('submit',onSubmit,false);window.addEventListener('popstate',onPopState,true);}},{"./router":93,"qs":43,"url":96}],92:[function(require,module,exports){var Route=require('../vendor/express/router/route');var History=require('./History');var router=module.exports=require('./router');router.setup=setup;function setup(app){var routes={queue:{},transitional:{},app:app};app.history=new History(app,routes);['get','post','put','del','enter','exit'].forEach(function(method){var queue=routes.queue[method]=[];var transitional=routes.transitional[method]=[];app[method]=function(pattern,callback){if(Array.isArray(pattern)){pattern.forEach(function(item){app[method](item,callback);});return app;}if(router.isTransitional(pattern)){var from=pattern.from;var to=pattern.to;var forward=pattern.forward||callback&&callback.forward||callback;var back=pattern.back||callback&&callback.back;var fromRoute=new Route(method,from,back);var toRoute=new Route(method,to,forward);fromRoute.isTransitional=true;toRoute.isTransitional=true;transitional.push({from:fromRoute,to:toRoute});if(back)transitional.push({from:toRoute,to:fromRoute});return app;}queue.push(new Route(method,pattern,callback));return app;};});}},{"../vendor/express/router/route":94,"./History":91,"./router":93}],93:[function(require,module,exports){var qs=require('qs');var nodeUrl=require('url');module.exports={render:render,isTransitional:isTransitional,mapRoute:mapRoute};function isTransitional(pattern){return pattern.hasOwnProperty('from')&&pattern.hasOwnProperty('to');}function mapRoute(from,params){var i=params.url.indexOf('?');var queryString=~i?params.url.slice(i):'';// If the route looks like /:a/:b?/:c/:d?
// and :b and :d are missing, return /a/c
// Thus, skip the / if the value is missing
var i=0;var path=from.replace(/\/(?:(?:\:([^?\/:*(]+)(?:\([^)]+\))?)|\*)(\?)?/g,onMatch);function onMatch(match,key,optional){var value=key?params[key]:params[i++];return optional&&value==null?'':'/'+encodeURIComponent(value);}return path+queryString;}function render(history,options,e){var req=new RenderReq(history.app.page,history.routes,options,e);req.routeTransitional(0,function(){req.page=history.page();req.routeQueue(0,function(){// Cancel rendering by this app if no routes match
req.cancel();});});}function RenderReq(page,routes,options,e){this.page=page;this.options=options;this.e=e;this.setUrl(options.url.replace(/#.*/,''));var queryString=nodeUrl.parse(this.url).query;this.query=queryString?qs.parse(queryString):{};this.method=options.method;this.body=options.body||{};this.setPrevious(options.previous);this.transitional=routes.transitional[this.method];this.queue=routes.queue[this.method];this.app=routes.app;}RenderReq.prototype.cancel=function(){var options=this.options;// Don't do anything if this is the result of an event, since the
// appropriate action will happen by default
if(this.e||options.noNavigate)return;// Otherwise, manually perform appropriate action
if(options.form){options.form.setAttribute('data-router-ignore','');options.form.submit();}else{window.location.assign(options.url);}};RenderReq.prototype.setUrl=function(url){this.url=url;this.path=url.replace(/\?.*/,'');};RenderReq.prototype.setPrevious=function(previous){this.previous=previous;this.previousPath=previous&&previous.replace(/\?.*/,'');};RenderReq.prototype.routeTransitional=function(i,next){i||(i=0);var item;while(item=this.transitional[i++]){// Even though we don't need to do anything after a done, pass a
// no op function, so that routes can expect it to be defined
var done=function done(){};if(!item.to.match(this.path)||!item.from.match(this.previousPath))continue;var req=this;var params=this.routeParams(item.to);this.onMatch(item.to,params,function(err){if(err)return req.cancel();req.routeTransitional(i,next);},done);return;}next();};RenderReq.prototype.routeQueue=function(i,next){i||(i=0);var route;while(route=this.queue[i++]){if(!route.match(this.path))continue;var req=this;var params=this.routeParams(route);this.onMatch(route,params,function(err){if(err)return req.cancel();req.routeQueue(i,next);});return;}next();};RenderReq.prototype.onMatch=function(route,params,next,done){if(!this.page)return next();// Stop the default browser action, such as clicking a link or submitting a form
if(this.e){this.e.preventDefault();this.e=null;}this.page.params=params;if(route.isTransitional){this.app.onRoute(route.callbacks,this.page,next,done);}else{this.app.onRoute(route.callbacks,this.page,next);}};RenderReq.prototype.routeParams=function(route){var routeParams=route.params;var params=routeParams.slice();for(var key in routeParams){params[key]=routeParams[key];}params.previous=this.previous;params.url=this.url;params.body=this.body;params.query=this.query;params.method=this.method;return params;};},{"qs":43,"url":96}],94:[function(require,module,exports){/**
 * Module dependencies.
 */var utils=require('../utils');/**
 * Expose `Route`.
 */module.exports=Route;/**
 * Initialize `Route` with the given HTTP `method`, `path`,
 * and an array of `callbacks` and `options`.
 *
 * Options:
 *
 *   - `sensitive`    enable case-sensitive routes
 *   - `strict`       enable strict matching for trailing slashes
 *
 * @param {String} method
 * @param {String} path
 * @param {Array} callbacks
 * @param {Object} options.
 * @api private
 */function Route(method,path,callbacks,options){options=options||{};this.path=path;this.method=method;this.callbacks=callbacks;this.regexp=utils.pathRegexp(path,this.keys=[],options.sensitive,options.strict);}/**
 * Check if this route matches `path`, if so
 * populate `.params`.
 *
 * @param {String} path
 * @return {Boolean}
 * @api private
 */Route.prototype.match=function(path){var keys=this.keys,params=this.params=[],m=this.regexp.exec(path);if(!m)return false;for(var i=1,len=m.length;i<len;++i){var key=keys[i-1];var val='string'==typeof m[i]?decodeURIComponent(m[i]):m[i];if(key){params[key.name]=val;}else{params.push(val);}}return true;};},{"../utils":95}],95:[function(require,module,exports){/**
 * Module dependencies.
 */ /**
 * toString ref.
 */var toString={}.toString;/**
 * Return ETag for `body`.
 *
 * @param {String|Buffer} body
 * @return {String}
 * @api private
 */exports.etag=function(body){return'"'+crc32.signed(body)+'"';};/**
 * Make `locals()` bound to the given `obj`.
 *
 * This is used for `app.locals` and `res.locals`.
 *
 * @param {Object} obj
 * @return {Function}
 * @api private
 */exports.locals=function(obj){function locals(obj){for(var key in obj){locals[key]=obj[key];}return obj;};return locals;};/**
 * Check if `path` looks absolute.
 *
 * @param {String} path
 * @return {Boolean}
 * @api private
 */exports.isAbsolute=function(path){if('/'==path[0])return true;if(':'==path[1]&&'\\'==path[2])return true;};/**
 * Flatten the given `arr`.
 *
 * @param {Array} arr
 * @return {Array}
 * @api private
 */exports.flatten=function(arr,ret){var ret=ret||[],len=arr.length;for(var i=0;i<len;++i){if(Array.isArray(arr[i])){exports.flatten(arr[i],ret);}else{ret.push(arr[i]);}}return ret;};/**
 * Normalize the given `type`, for example "html" becomes "text/html".
 *
 * @param {String} type
 * @return {Object}
 * @api private
 */exports.normalizeType=function(type){return~type.indexOf('/')?acceptParams(type):{value:mime.lookup(type),params:{}};};/**
 * Normalize `types`, for example "html" becomes "text/html".
 *
 * @param {Array} types
 * @return {Array}
 * @api private
 */exports.normalizeTypes=function(types){var ret=[];for(var i=0;i<types.length;++i){ret.push(exports.normalizeType(types[i]));}return ret;};/**
 * Return the acceptable type in `types`, if any.
 *
 * @param {Array} types
 * @param {String} str
 * @return {String}
 * @api private
 */exports.acceptsArray=function(types,str){// accept anything when Accept is not present
if(!str)return types[0];// parse
var accepted=exports.parseAccept(str),normalized=exports.normalizeTypes(types),len=accepted.length;for(var i=0;i<len;++i){for(var j=0,jlen=types.length;j<jlen;++j){if(exports.accept(normalized[j],accepted[i])){return types[j];}}}};/**
 * Check if `type(s)` are acceptable based on
 * the given `str`.
 *
 * @param {String|Array} type(s)
 * @param {String} str
 * @return {Boolean|String}
 * @api private
 */exports.accepts=function(type,str){if('string'==typeof type)type=type.split(/ *, */);return exports.acceptsArray(type,str);};/**
 * Check if `type` array is acceptable for `other`.
 *
 * @param {Object} type
 * @param {Object} other
 * @return {Boolean}
 * @api private
 */exports.accept=function(type,other){var t=type.value.split('/');return(t[0]==other.type||'*'==other.type)&&(t[1]==other.subtype||'*'==other.subtype)&&paramsEqual(type.params,other.params);};/**
 * Check if accept params are equal.
 *
 * @param {Object} a
 * @param {Object} b
 * @return {Boolean}
 * @api private
 */function paramsEqual(a,b){return!Object.keys(a).some(function(k){return a[k]!=b[k];});}/**
 * Parse accept `str`, returning
 * an array objects containing
 * `.type` and `.subtype` along
 * with the values provided by
 * `parseQuality()`.
 *
 * @param {Type} name
 * @return {Type}
 * @api private
 */exports.parseAccept=function(str){return exports.parseParams(str).map(function(obj){var parts=obj.value.split('/');obj.type=parts[0];obj.subtype=parts[1];return obj;});};/**
 * Parse quality `str`, returning an
 * array of objects with `.value`,
 * `.quality` and optional `.params`
 *
 * @param {String} str
 * @return {Array}
 * @api private
 */exports.parseParams=function(str){return str.split(/ *, */).map(acceptParams).filter(function(obj){return obj.quality;}).sort(function(a,b){if(a.quality===b.quality){return a.originalIndex-b.originalIndex;}else{return b.quality-a.quality;}});};/**
 * Parse accept params `str` returning an
 * object with `.value`, `.quality` and `.params`.
 * also includes `.originalIndex` for stable sorting
 *
 * @param {String} str
 * @return {Object}
 * @api private
 */function acceptParams(str,index){var parts=str.split(/ *; */);var ret={value:parts[0],quality:1,params:{},originalIndex:index};for(var i=1;i<parts.length;++i){var pms=parts[i].split(/ *= */);if('q'==pms[0]){ret.quality=parseFloat(pms[1]);}else{ret.params[pms[0]]=pms[1];}}return ret;}/**
 * Escape special characters in the given string of html.
 *
 * @param  {String} html
 * @return {String}
 * @api private
 */exports.escape=function(html){return String(html).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');};/**
 * Normalize the given path string,
 * returning a regular expression.
 *
 * An empty array should be passed,
 * which will contain the placeholder
 * key names. For example "/user/:id" will
 * then contain ["id"].
 *
 * @param  {String|RegExp|Array} path
 * @param  {Array} keys
 * @param  {Boolean} sensitive
 * @param  {Boolean} strict
 * @return {RegExp}
 * @api private
 */exports.pathRegexp=function(path,keys,sensitive,strict){if(toString.call(path)=='[object RegExp]')return path;if(Array.isArray(path))path='('+path.join('|')+')';path=path.concat(strict?'':'/?').replace(/\/\(/g,'(?:/').replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(_,slash,format,key,capture,optional,star){keys.push({name:key,optional:!!optional});slash=slash||'';return''+(optional?'':slash)+'(?:'+(optional?slash:'')+(format||'')+(capture||format&&'([^/.]+?)'||'([^/]+?)')+')'+(optional||'')+(star?'(/*)?':'');}).replace(/([\/.])/g,'\\$1').replace(/\*/g,'(.*)');return new RegExp('^'+path+'$',sensitive?'':'i');};},{}],96:[function(require,module,exports){// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.
'use strict';var punycode=require('punycode');var util=require('./util');exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null;}// Reference: RFC 3986, RFC 1808, RFC 2396
// define these here so at least they only have to be
// compiled once on the first module load.
var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,// Special case for a simple path URL
simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,// RFC 2396: characters reserved for delimiting URLs.
// We actually just auto-escape these.
delims=['<','>','"','`',' ','\r','\n','\t'],// RFC 2396: characters not allowed for various reasons.
unwise=['{','}','|','\\','^','`'].concat(delims),// Allowed by RFCs, but cause of XSS attacks.  Always escape these.
autoEscape=['\''].concat(unwise),// Characters that are never ever allowed in a hostname.
// Note that any invalid chars are also handled, but these
// are the ones that are *expected* to be seen, so we fast-path
// them.
nonHostChars=['%','/','?',';','#'].concat(autoEscape),hostEndingChars=['/','?','#'],hostnameMaxLen=255,hostnamePartPattern=/^[+a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,// protocols that can allow "unsafe" and "unwise" chars.
unsafeProtocol={'javascript':true,'javascript:':true},// protocols that never have a hostname.
hostlessProtocol={'javascript':true,'javascript:':true},// protocols that always contain a // bit.
slashedProtocol={'http':true,'https':true,'ftp':true,'gopher':true,'file':true,'http:':true,'https:':true,'ftp:':true,'gopher:':true,'file:':true},querystring=require('querystring');function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&util.isObject(url)&&url instanceof Url)return url;var u=new Url();u.parse(url,parseQueryString,slashesDenoteHost);return u;}Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!util.isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+_typeof(url));}// Copy chrome, IE, opera backslash-handling behavior.
// Back slashes before the query string get converted to forward slashes
// See: https://code.google.com/p/chromium/issues/detail?id=25916
var queryIndex=url.indexOf('?'),splitter=queryIndex!==-1&&queryIndex<url.indexOf('#')?'?':'#',uSplit=url.split(splitter),slashRegex=/\\/g;uSplit[0]=uSplit[0].replace(slashRegex,'/');url=uSplit.join(splitter);var rest=url;// trim before proceeding.
// This is to support parse stuff like "  http://foo.com  \n"
rest=rest.trim();if(!slashesDenoteHost&&url.split('#').length===1){// Try fast path regexp
var simplePath=simplePathPattern.exec(rest);if(simplePath){this.path=rest;this.href=rest;this.pathname=simplePath[1];if(simplePath[2]){this.search=simplePath[2];if(parseQueryString){this.query=querystring.parse(this.search.substr(1));}else{this.query=this.search.substr(1);}}else if(parseQueryString){this.search='';this.query={};}return this;}}var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length);}// figure out if it's got a host
// user@server is *always* interpreted as a hostname, and url
// resolution will treat //foo/bar as host=foo,path=bar because that's
// how the browser resolves relative URLs.
if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==='//';if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true;}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){// there's a hostname.
// the first instance of /, ?, ;, or # ends the host.
//
// If there is an @ in the hostname, then non-host chars *are* allowed
// to the left of the last @ sign, unless some host-ending character
// comes *before* the @-sign.
// URLs are obnoxious.
//
// ex:
// http://a@b@c/ => user:a@b host:c
// http://a@b?@c => user:a host:c path:/?@c
// v0.12 TODO(isaacs): This is not quite how Chrome does things.
// Review our test case against browsers more comprehensively.
// find the first instance of any hostEndingChars
var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec;}// at this point, either we have an explicit point where the
// auth portion cannot go past, or the last @ char is the decider.
var auth,atSign;if(hostEnd===-1){// atSign can be anywhere.
atSign=rest.lastIndexOf('@');}else{// atSign must be in auth portion.
// http://a@b/c@d => host:b auth:a path:/c@d
atSign=rest.lastIndexOf('@',hostEnd);}// Now we have a portion which is definitely the auth.
// Pull that off.
if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth);}// the host is the remaining to the left of the first non-host char
hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec;}// if we still have not hit it, then the entire thing is a host.
if(hostEnd===-1)hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);// pull out port.
this.parseHost();// we've indicated that there is a hostname,
// so even if it's empty, it has to be present.
this.hostname=this.hostname||'';// if hostname begins with [ and ends with ]
// assume that it's an IPv6 address.
var ipv6Hostname=this.hostname[0]==='['&&this.hostname[this.hostname.length-1]===']';// validate a little.
if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart='';for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){// we replace non-ASCII char with a temporary placeholder
// we need this to make sure size of hostname is not
// broken by replacing non-ASCII by nothing
newpart+='x';}else{newpart+=part[j];}}// we test again with ASCII char only
if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2]);}if(notHost.length){rest='/'+notHost.join('.')+rest;}this.hostname=validParts.join('.');break;}}}}if(this.hostname.length>hostnameMaxLen){this.hostname='';}else{// hostnames are always lower case.
this.hostname=this.hostname.toLowerCase();}if(!ipv6Hostname){// IDNA Support: Returns a punycoded representation of "domain".
// It only converts parts of the domain name that
// have non-ASCII characters, i.e. it doesn't matter if
// you call it with a domain that already is ASCII-only.
this.hostname=punycode.toASCII(this.hostname);}var p=this.port?':'+this.port:'';var h=this.hostname||'';this.host=h+p;this.href+=this.host;// strip [ and ] from the hostname
// the host field still retains them, though
if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=='/'){rest='/'+rest;}}}// now rest is set to the post-host stuff.
// chop off any delim chars.
if(!unsafeProtocol[lowerProto]){// First, make 100% sure that any "autoEscape" chars get
// escaped, even if encodeURIComponent doesn't think they
// need to be.
for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];if(rest.indexOf(ae)===-1)continue;var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae);}rest=rest.split(ae).join(esc);}}// chop off from the tail first.
var hash=rest.indexOf('#');if(hash!==-1){// got a fragment string.
this.hash=rest.substr(hash);rest=rest.slice(0,hash);}var qm=rest.indexOf('?');if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query);}rest=rest.slice(0,qm);}else if(parseQueryString){// no query string, but parseQueryString still requested
this.search='';this.query={};}if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname='/';}//to support http.request
if(this.pathname||this.search){var p=this.pathname||'';var s=this.search||'';this.path=p+s;}// finally, reconstruct the href based on what has been validated.
this.href=this.format();return this;};// format a parsed object into a url string
function urlFormat(obj){// ensure it's an object, and not a string url.
// If it's an obj, this is a no-op.
// this way, you can call url_format() on strings
// to clean up potentially wonky urls.
if(util.isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format();}Url.prototype.format=function(){var auth=this.auth||'';if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,':');auth+='@';}var protocol=this.protocol||'',pathname=this.pathname||'',hash=this.hash||'',host=false,query='';if(this.host){host=auth+this.host;}else if(this.hostname){host=auth+(this.hostname.indexOf(':')===-1?this.hostname:'['+this.hostname+']');if(this.port){host+=':'+this.port;}}if(this.query&&util.isObject(this.query)&&Object.keys(this.query).length){query=querystring.stringify(this.query);}var search=this.search||query&&'?'+query||'';if(protocol&&protocol.substr(-1)!==':')protocol+=':';// only the slashedProtocols get the //.  Not mailto:, xmpp:, etc.
// unless they had them to begin with.
if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host='//'+(host||'');if(pathname&&pathname.charAt(0)!=='/')pathname='/'+pathname;}else if(!host){host='';}if(hash&&hash.charAt(0)!=='#')hash='#'+hash;if(search&&search.charAt(0)!=='?')search='?'+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match);});search=search.replace('#','%23');return protocol+host+pathname+search+hash;};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative);}Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format();};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative);}Url.prototype.resolveObject=function(relative){if(util.isString(relative)){var rel=new Url();rel.parse(relative,false,true);relative=rel;}var result=new Url();var tkeys=Object.keys(this);for(var tk=0;tk<tkeys.length;tk++){var tkey=tkeys[tk];result[tkey]=this[tkey];}// hash is always overridden, no matter what.
// even href="" will remove it.
result.hash=relative.hash;// if the relative url is empty, then there's nothing left to do here.
if(relative.href===''){result.href=result.format();return result;}// hrefs like //foo/bar always cut to the protocol.
if(relative.slashes&&!relative.protocol){// take everything except the protocol from relative
var rkeys=Object.keys(relative);for(var rk=0;rk<rkeys.length;rk++){var rkey=rkeys[rk];if(rkey!=='protocol')result[rkey]=relative[rkey];}//urlParse appends trailing / to urls like http://www.example.com
if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname='/';}result.href=result.format();return result;}if(relative.protocol&&relative.protocol!==result.protocol){// if it's a known url protocol, then changing
// the protocol does weird things
// first, if it's not file:, then we MUST have a host,
// and if there was a path
// to begin with, then we MUST have a path.
// if it is file:, then the host is dropped,
// because that's known to be hostless.
// anything else is assumed to be absolute.
if(!slashedProtocol[relative.protocol]){var keys=Object.keys(relative);for(var v=0;v<keys.length;v++){var k=keys[v];result[k]=relative[k];}result.href=result.format();return result;}result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||'').split('/');while(relPath.length&&!(relative.host=relPath.shift())){;}if(!relative.host)relative.host='';if(!relative.hostname)relative.hostname='';if(relPath[0]!=='')relPath.unshift('');if(relPath.length<2)relPath.unshift('');result.pathname=relPath.join('/');}else{result.pathname=relative.pathname;}result.search=relative.search;result.query=relative.query;result.host=relative.host||'';result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;// to support http.request
if(result.pathname||result.search){var p=result.pathname||'';var s=result.search||'';result.path=p+s;}result.slashes=result.slashes||relative.slashes;result.href=result.format();return result;}var isSourceAbs=result.pathname&&result.pathname.charAt(0)==='/',isRelAbs=relative.host||relative.pathname&&relative.pathname.charAt(0)==='/',mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split('/')||[],relPath=relative.pathname&&relative.pathname.split('/')||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];// if the url is a non-slashed url, then relative
// links like ../.. should be able
// to crawl up to the hostname, as well.  This is strange.
// result.protocol has already been set by now.
// Later on, put the first path part into the host field.
if(psychotic){result.hostname='';result.port=null;if(result.host){if(srcPath[0]==='')srcPath[0]=result.host;else srcPath.unshift(result.host);}result.host='';if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==='')relPath[0]=relative.host;else relPath.unshift(relative.host);}relative.host=null;}mustEndAbs=mustEndAbs&&(relPath[0]===''||srcPath[0]==='');}if(isRelAbs){// it's absolute.
result.host=relative.host||relative.host===''?relative.host:result.host;result.hostname=relative.hostname||relative.hostname===''?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath;// fall through to the dot-handling below.
}else if(relPath.length){// it's relative
// throw away the existing file, and take the new path instead.
if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query;}else if(!util.isNullOrUndefined(relative.search)){// just pull out the search.
// like href='?foo'.
// Put this after the other two cases because it simplifies the booleans
if(psychotic){result.hostname=result.host=srcPath.shift();//occationaly the auth can get stuck only in host
//this especially happens in cases like
//url.resolveObject('mailto:local1@domain1', 'local2@domain2')
var authInHost=result.host&&result.host.indexOf('@')>0?result.host.split('@'):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift();}}result.search=relative.search;result.query=relative.query;//to support http.request
if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:'')+(result.search?result.search:'');}result.href=result.format();return result;}if(!srcPath.length){// no path at all.  easy.
// we've already handled the other stuff above.
result.pathname=null;//to support http.request
if(result.search){result.path='/'+result.search;}else{result.path=null;}result.href=result.format();return result;}// if a url ENDs in . or .., then it must get a trailing slash.
// however, if it ends in anything else non-slashy,
// then it must NOT get a trailing slash.
var last=srcPath.slice(-1)[0];var hasTrailingSlash=(result.host||relative.host||srcPath.length>1)&&(last==='.'||last==='..')||last==='';// strip single dots, resolve double dots to parent dir
// if the path tries to go above the root, `up` ends up > 0
var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last==='.'){srcPath.splice(i,1);}else if(last==='..'){srcPath.splice(i,1);up++;}else if(up){srcPath.splice(i,1);up--;}}// if the path is allowed to go above the root, restore leading ..s
if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift('..');}}if(mustEndAbs&&srcPath[0]!==''&&(!srcPath[0]||srcPath[0].charAt(0)!=='/')){srcPath.unshift('');}if(hasTrailingSlash&&srcPath.join('/').substr(-1)!=='/'){srcPath.push('');}var isAbsolute=srcPath[0]===''||srcPath[0]&&srcPath[0].charAt(0)==='/';// put the host back
if(psychotic){result.hostname=result.host=isAbsolute?'':srcPath.length?srcPath.shift():'';//occationaly the auth can get stuck only in host
//this especially happens in cases like
//url.resolveObject('mailto:local1@domain1', 'local2@domain2')
var authInHost=result.host&&result.host.indexOf('@')>0?result.host.split('@'):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift();}}mustEndAbs=mustEndAbs||result.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift('');}if(!srcPath.length){result.pathname=null;result.path=null;}else{result.pathname=srcPath.join('/');}//to support request.http
if(!util.isNull(result.pathname)||!util.isNull(result.search)){result.path=(result.pathname?result.pathname:'')+(result.search?result.search:'');}result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result;};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==':'){this.port=port.substr(1);}host=host.substr(0,host.length-port.length);}if(host)this.hostname=host;};},{"./util":97,"punycode":41,"querystring":49}],97:[function(require,module,exports){'use strict';module.exports={isString:function isString(arg){return typeof arg==='string';},isObject:function isObject(arg){return _typeof(arg)==='object'&&arg!==null;},isNull:function isNull(arg){return arg===null;},isNullOrUndefined:function isNullOrUndefined(arg){return arg==null;}};},{}],98:[function(require,module,exports){(function(global){var rng;var crypto=global.crypto||global.msCrypto;// for IE 11
if(crypto&&crypto.getRandomValues){// WHATWG crypto-based RNG - http://wiki.whatwg.org/wiki/Crypto
// Moderately fast, high quality
var _rnds8=new Uint8Array(16);rng=function whatwgRNG(){crypto.getRandomValues(_rnds8);return _rnds8;};}if(!rng){// Math.random()-based (RNG)
//
// If all else fails, use Math.random().  It's fast, but is of unspecified
// quality.
var _rnds=new Array(16);rng=function rng(){for(var i=0,r;i<16;i++){if((i&0x03)===0)r=Math.random()*0x100000000;_rnds[i]=r>>>((i&0x03)<<3)&0xff;}return _rnds;};}module.exports=rng;}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{});},{}],99:[function(require,module,exports){//     uuid.js
//
//     Copyright (c) 2010-2012 Robert Kieffer
//     MIT License - http://opensource.org/licenses/mit-license.php
// Unique ID creation requires a high quality random # generator.  We feature
// detect to determine the best RNG source, normalizing to a function that
// returns 128-bits of randomness, since that's what's usually required
var _rng=require('./rng');// Maps for number <-> hex string conversion
var _byteToHex=[];var _hexToByte={};for(var i=0;i<256;i++){_byteToHex[i]=(i+0x100).toString(16).substr(1);_hexToByte[_byteToHex[i]]=i;}// **`parse()` - Parse a UUID into it's component bytes**
function parse(s,buf,offset){var i=buf&&offset||0,ii=0;buf=buf||[];s.toLowerCase().replace(/[0-9a-f]{2}/g,function(oct){if(ii<16){// Don't overflow!
buf[i+ii++]=_hexToByte[oct];}});// Zero out remaining bytes if string was short
while(ii<16){buf[i+ii++]=0;}return buf;}// **`unparse()` - Convert UUID byte array (ala parse()) into a string**
function unparse(buf,offset){var i=offset||0,bth=_byteToHex;return bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+'-'+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]]+bth[buf[i++]];}// **`v1()` - Generate time-based UUID**
//
// Inspired by https://github.com/LiosK/UUID.js
// and http://docs.python.org/library/uuid.html
// random #'s we need to init node and clockseq
var _seedBytes=_rng();// Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1)
var _nodeId=[_seedBytes[0]|0x01,_seedBytes[1],_seedBytes[2],_seedBytes[3],_seedBytes[4],_seedBytes[5]];// Per 4.2.2, randomize (14 bit) clockseq
var _clockseq=(_seedBytes[6]<<8|_seedBytes[7])&0x3fff;// Previous uuid creation time
var _lastMSecs=0,_lastNSecs=0;// See https://github.com/broofa/node-uuid for API details
function v1(options,buf,offset){var i=buf&&offset||0;var b=buf||[];options=options||{};var clockseq=options.clockseq!==undefined?options.clockseq:_clockseq;// UUID timestamps are 100 nano-second units since the Gregorian epoch,
// (1582-10-15 00:00).  JSNumbers aren't precise enough for this, so
// time is handled internally as 'msecs' (integer milliseconds) and 'nsecs'
// (100-nanoseconds offset from msecs) since unix epoch, 1970-01-01 00:00.
var msecs=options.msecs!==undefined?options.msecs:new Date().getTime();// Per 4.2.1.2, use count of uuid's generated during the current clock
// cycle to simulate higher resolution clock
var nsecs=options.nsecs!==undefined?options.nsecs:_lastNSecs+1;// Time since last uuid creation (in msecs)
var dt=msecs-_lastMSecs+(nsecs-_lastNSecs)/10000;// Per 4.2.1.2, Bump clockseq on clock regression
if(dt<0&&options.clockseq===undefined){clockseq=clockseq+1&0x3fff;}// Reset nsecs if clock regresses (new clockseq) or we've moved onto a new
// time interval
if((dt<0||msecs>_lastMSecs)&&options.nsecs===undefined){nsecs=0;}// Per 4.2.1.2 Throw error if too many uuids are requested
if(nsecs>=10000){throw new Error('uuid.v1(): Can\'t create more than 10M uuids/sec');}_lastMSecs=msecs;_lastNSecs=nsecs;_clockseq=clockseq;// Per 4.1.4 - Convert from unix epoch to Gregorian epoch
msecs+=12219292800000;// `time_low`
var tl=((msecs&0xfffffff)*10000+nsecs)%0x100000000;b[i++]=tl>>>24&0xff;b[i++]=tl>>>16&0xff;b[i++]=tl>>>8&0xff;b[i++]=tl&0xff;// `time_mid`
var tmh=msecs/0x100000000*10000&0xfffffff;b[i++]=tmh>>>8&0xff;b[i++]=tmh&0xff;// `time_high_and_version`
b[i++]=tmh>>>24&0xf|0x10;// include version
b[i++]=tmh>>>16&0xff;// `clock_seq_hi_and_reserved` (Per 4.2.2 - include variant)
b[i++]=clockseq>>>8|0x80;// `clock_seq_low`
b[i++]=clockseq&0xff;// `node`
var node=options.node||_nodeId;for(var n=0;n<6;n++){b[i+n]=node[n];}return buf?buf:unparse(b);}// **`v4()` - Generate random UUID**
// See https://github.com/broofa/node-uuid for API details
function v4(options,buf,offset){// Deprecated - 'format' argument, as supported in v1.2
var i=buf&&offset||0;if(typeof options=='string'){buf=options=='binary'?new Array(16):null;options=null;}options=options||{};var rnds=options.random||(options.rng||_rng)();// Per 4.4, set bits for version and `clock_seq_hi_and_reserved`
rnds[6]=rnds[6]&0x0f|0x40;rnds[8]=rnds[8]&0x3f|0x80;// Copy bytes to buffer, if provided
if(buf){for(var ii=0;ii<16;ii++){buf[i+ii]=rnds[ii];}}return buf||unparse(rnds);}// Export public API
var uuid=v4;uuid.v1=v1;uuid.v4=v4;uuid.parse=parse;uuid.unparse=unparse;module.exports=uuid;},{"./rng":98}],"derby":[function(require,module,exports){var serverRequire=require('racer').util.serverRequire;var Derby=serverRequire(module,'./lib/DerbyForServer')||require('./lib/Derby');module.exports=new Derby();},{"./lib/Derby":25,"racer":"racer"}],"racer":[function(require,module,exports){var Racer=require('./Racer');module.exports=new Racer();},{"./Racer":73}]},{},[50,1]);