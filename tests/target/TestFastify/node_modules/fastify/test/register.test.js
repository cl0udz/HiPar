'use strict';
/* eslint no-prototype-builtins: 0 */

var t = require('tap');

var test = t.test;

var sget = require('simple-get').concat;

var Fastify = require('..');

test('register', function (t) {
  t.plan(17);
  var fastify = Fastify();
  fastify.register(function (instance, opts, done) {
    t.notEqual(instance, fastify);
    t.ok(fastify.isPrototypeOf(instance));
    t.is(typeof opts, 'object');
    t.is(typeof done, 'function');
    instance.get('/first', function (req, reply) {
      reply.send({
        hello: 'world'
      });
    });
    done();
  });
  fastify.register(function (instance, opts, done) {
    t.notEqual(instance, fastify);
    t.ok(fastify.isPrototypeOf(instance));
    t.is(typeof opts, 'object');
    t.is(typeof done, 'function');
    instance.get('/second', function (req, reply) {
      reply.send({
        hello: 'world'
      });
    });
    done();
  });
  fastify.listen(0, function (err) {
    t.error(err);
    fastify.server.unref();
    makeRequest('first');
    makeRequest('second');
  });

  function makeRequest(path) {
    sget({
      method: 'GET',
      url: 'http://localhost:' + fastify.server.address().port + '/' + path
    }, function (err, response, body) {
      t.error(err);
      t.strictEqual(response.statusCode, 200);
      t.strictEqual(response.headers['content-length'], '' + body.length);
      t.deepEqual(JSON.parse(body), {
        hello: 'world'
      });
    });
  }
});
test('internal route declaration should pass the error generated by the register to the next handler / 1', function (t) {
  t.plan(1);
  var fastify = Fastify();
  fastify.register(function (instance, opts, next) {
    next(new Error('kaboom'));
  });
  fastify.get('/', function (req, reply) {
    reply.send({
      hello: 'world'
    });
  });
  fastify.listen(0, function (err) {
    fastify.close();
    t.is(err.message, 'kaboom');
  });
});
test('internal route declaration should pass the error generated by the register to the next handler / 2', function (t) {
  t.plan(2);
  var fastify = Fastify();
  fastify.register(function (instance, opts, next) {
    next(new Error('kaboom'));
  });
  fastify.get('/', function (req, reply) {
    reply.send({
      hello: 'world'
    });
  });
  fastify.after(function (err) {
    t.is(err.message, 'kaboom');
  });
  fastify.listen(0, function (err) {
    fastify.close();
    t.error(err);
  });
});