'use strict';

var t = require('tap');

var test = t.test;

var Ajv = require('ajv');

var ajv = new Ajv({
  coerceTypes: true
});

var validation = require('../../lib/validation');

var _require = require('../../lib/schemas'),
    Schemas = _require.Schemas;

var symbols = require('../../lib/validation').symbols;

test('Symbols', function (t) {
  t.plan(5);
  t.is(typeof symbols.responseSchema, 'symbol');
  t.is(typeof symbols.bodySchema, 'symbol');
  t.is(typeof symbols.querystringSchema, 'symbol');
  t.is(typeof symbols.paramsSchema, 'symbol');
  t.is(typeof symbols.headersSchema, 'symbol');
});
test('build schema - missing schema', function (t) {
  t.plan(1);
  var opts = {};
  validation.build(opts);
  t.is(typeof opts[symbols.responseSchema], 'undefined');
});
test('build schema - missing output schema', function (t) {
  t.plan(1);
  var opts = {
    schema: {}
  };
  validation.build(opts, null, new Schemas());
  t.is(typeof opts[symbols.responseSchema], 'undefined');
});
test('build schema - output schema', function (t) {
  t.plan(2);
  var opts = {
    schema: {
      response: {
        '2xx': {
          type: 'object',
          properties: {
            hello: {
              type: 'string'
            }
          }
        },
        201: {
          type: 'object',
          properties: {
            hello: {
              type: 'number'
            }
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.is(typeof opts[symbols.responseSchema]['2xx'], 'function');
  t.is(typeof opts[symbols.responseSchema]['201'], 'function');
});
test('build schema - payload schema', function (t) {
  t.plan(1);
  var opts = {
    schema: {
      body: {
        type: 'object',
        properties: {
          hello: {
            type: 'string'
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.is(typeof opts[symbols.bodySchema], 'function');
});
test('build schema - query schema', function (t) {
  t.plan(2);
  var opts = {
    schema: {
      query: {
        type: 'object',
        properties: {
          hello: {
            type: 'string'
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.type(opts[symbols.querystringSchema].schema.type, 'string');
  t.is(typeof opts[symbols.querystringSchema], 'function');
});
test('build schema - query schema abbreviated', function (t) {
  t.plan(2);
  var opts = {
    schema: {
      query: {
        hello: {
          type: 'string'
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.type(opts[symbols.querystringSchema].schema.type, 'string');
  t.is(typeof opts[symbols.querystringSchema], 'function');
});
test('build schema - querystring schema', function (t) {
  t.plan(2);
  var opts = {
    schema: {
      querystring: {
        type: 'object',
        properties: {
          hello: {
            type: 'string'
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.type(opts[symbols.querystringSchema].schema.type, 'string');
  t.is(typeof opts[symbols.querystringSchema], 'function');
});
test('build schema - querystring schema abbreviated', function (t) {
  t.plan(2);
  var opts = {
    schema: {
      querystring: {
        hello: {
          type: 'string'
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.type(opts[symbols.querystringSchema].schema.type, 'string');
  t.is(typeof opts[symbols.querystringSchema], 'function');
});
test('build schema - must throw if querystring and query schema exist', function (t) {
  t.plan(2);

  try {
    var opts = {
      schema: {
        query: {
          type: 'object',
          properties: {
            hello: {
              type: 'string'
            }
          }
        },
        querystring: {
          type: 'object',
          properties: {
            hello: {
              type: 'string'
            }
          }
        }
      }
    };
    validation.build(opts, function (schema) {
      return ajv.compile(schema);
    }, new Schemas());
  } catch (err) {
    t.is(err.code, 'FST_ERR_SCH_DUPLICATE');
    t.is(err.message, 'FST_ERR_SCH_DUPLICATE: Schema with \'querystring\' already present!');
  }
});
test('build schema - params schema', function (t) {
  t.plan(1);
  var opts = {
    schema: {
      params: {
        type: 'object',
        properties: {
          hello: {
            type: 'string'
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.is(typeof opts[symbols.paramsSchema], 'function');
});
test('build schema - headers schema', function (t) {
  t.plan(1);
  var opts = {
    schema: {
      headers: {
        type: 'object',
        properties: {
          'content-type': {
            type: 'string'
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    return ajv.compile(schema);
  }, new Schemas());
  t.is(typeof opts[symbols.headersSchema], 'function');
});
test('build schema - headers are lowercase', function (t) {
  t.plan(1);
  var opts = {
    schema: {
      headers: {
        type: 'object',
        properties: {
          'Content-Type': {
            type: 'string'
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    t.ok(schema.properties['content-type'], 'lowercase content-type exists');
    return function () {};
  }, new Schemas());
});
test('build schema - headers are not lowercased in case of custom object', function (t) {
  t.plan(1);

  class Headers {}

  var opts = {
    schema: {
      headers: new Headers()
    }
  };
  validation.build(opts, function (schema) {
    t.type(schema, Headers);
    return function () {};
  }, new Schemas());
});
test('build schema - uppercased headers are not included', function (t) {
  t.plan(1);
  var opts = {
    schema: {
      headers: {
        type: 'object',
        properties: {
          'Content-Type': {
            type: 'string'
          }
        }
      }
    }
  };
  validation.build(opts, function (schema) {
    t.notOk('Content-Type' in schema.properties, 'uppercase does not exist');
    return function () {};
  }, new Schemas());
});