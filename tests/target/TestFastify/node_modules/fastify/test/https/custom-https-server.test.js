'use strict';

require("core-js/modules/es.array.concat");

require("core-js/modules/es.array.join");

require("core-js/modules/es.function.bind");

var t = require('tap');

var test = t.test;

var Fastify = require('../..');

var https = require('https');

var fs = require('fs');

var path = require('path');

var sget = require('simple-get').concat;

test('Should support a custom https server', function (t) {
  t.plan(6);

  var serverFactory = function serverFactory(handler, opts) {
    t.ok(opts.serverFactory);
    var options = {
      key: fs.readFileSync(path.join(__dirname, 'fastify.key')),
      cert: fs.readFileSync(path.join(__dirname, 'fastify.cert'))
    };
    var server = https.createServer(options, function (req, res) {
      req.custom = true;
      handler(req, res);
    });
    return server;
  };

  var fastify = Fastify({
    serverFactory: serverFactory
  });
  t.teardown(fastify.close.bind(fastify));
  fastify.get('/', function (req, reply) {
    t.ok(req.raw.custom);
    reply.send({
      hello: 'world'
    });
  });
  fastify.listen(0, function (err) {
    t.error(err);
    sget({
      method: 'GET',
      url: 'https://localhost:' + fastify.server.address().port,
      rejectUnauthorized: false
    }, function (err, response, body) {
      t.error(err);
      t.strictEqual(response.statusCode, 200);
      t.deepEqual(JSON.parse(body), {
        hello: 'world'
      });
    });
  });
});