'use strict';

var t = require('tap');

var test = t.test;

var sget = require('simple-get').concat;

var fs = require('fs');

var path = require('path');

var Fastify = require('../..');

try {
  var fastify = Fastify({
    https: {
      key: fs.readFileSync(path.join(__dirname, 'fastify.key')),
      cert: fs.readFileSync(path.join(__dirname, 'fastify.cert'))
    }
  });
  t.pass('Key/cert successfully loaded');
} catch (e) {
  t.fail('Key/cert loading failed', e);
}

test('https get', function (t) {
  t.plan(1);

  try {
    fastify.get('/', function (req, reply) {
      reply.code(200).send({
        hello: 'world'
      });
    });
    t.pass();
  } catch (e) {
    t.fail();
  }
});
fastify.listen(0, function (err) {
  t.error(err);
  fastify.server.unref();
  test('https get request', function (t) {
    t.plan(4);
    sget({
      method: 'GET',
      url: 'https://localhost:' + fastify.server.address().port,
      rejectUnauthorized: false
    }, function (err, response, body) {
      t.error(err);
      t.strictEqual(response.statusCode, 200);
      t.strictEqual(response.headers['content-length'], '' + body.length);
      t.deepEqual(JSON.parse(body), {
        hello: 'world'
      });
    });
  });
});