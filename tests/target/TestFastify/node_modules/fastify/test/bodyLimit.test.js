'use strict';

var Fastify = require('..');

var sget = require('simple-get').concat;

var t = require('tap');

var test = t.test;
test('bodyLimit', function (t) {
  t.plan(5);

  try {
    Fastify({
      bodyLimit: 1.3
    });
    t.fail('option must be an integer');
  } catch (err) {
    t.ok(err);
  }

  try {
    Fastify({
      bodyLimit: []
    });
    t.fail('option must be an integer');
  } catch (err) {
    t.ok(err);
  }

  var fastify = Fastify({
    bodyLimit: 1
  });
  fastify.post('/', function (request, reply) {
    reply.send({
      error: 'handler should not be called'
    });
  });
  fastify.listen(0, function (err) {
    t.error(err);
    fastify.server.unref();
    sget({
      method: 'POST',
      url: 'http://localhost:' + fastify.server.address().port,
      headers: {
        'Content-Type': 'application/json'
      },
      body: [],
      json: true
    }, function (err, response, body) {
      t.error(err);
      t.strictEqual(response.statusCode, 413);
    });
  });
});