'use strict';

require("core-js/modules/es.array.concat");

require("core-js/modules/es.array.join");

require("core-js/modules/es.object.to-string");

require("core-js/modules/es.promise");

require("regenerator-runtime/runtime");

var t = require('tap');

var test = t.test;

var fs = require('fs');

var path = require('path');

var Fastify = require('../..');

var h2url = require('h2url');

var msg = {
  hello: 'world'
};
var fastify;

try {
  fastify = Fastify({
    http2: true,
    https: {
      key: fs.readFileSync(path.join(__dirname, '..', 'https', 'fastify.key')),
      cert: fs.readFileSync(path.join(__dirname, '..', 'https', 'fastify.cert'))
    }
  });
  t.pass('Key/cert successfully loaded');
} catch (e) {
  t.fail('Key/cert loading failed', e);
}

fastify.get('/', function (req, reply) {
  reply.code(200).send(msg);
});
fastify.listen(0, function (err) {
  t.error(err);
  fastify.server.unref();
  test('https get request', function _callee(t) {
    var url, res;
    return regeneratorRuntime.async(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            t.plan(3);
            url = "https://localhost:".concat(fastify.server.address().port);
            _context.next = 4;
            return regeneratorRuntime.awrap(h2url.concat({
              url: url
            }));

          case 4:
            res = _context.sent;
            t.strictEqual(res.headers[':status'], 200);
            t.strictEqual(res.headers['content-length'], '' + JSON.stringify(msg).length);
            t.deepEqual(JSON.parse(res.body), msg);

          case 8:
          case "end":
            return _context.stop();
        }
      }
    });
  });
});