'use strict';

var t = require('tap');

var test = t.test;

var Fastify = require('../..');

var h2url = require('h2url');

var msg = {
  hello: 'world'
};
var fastify;

try {
  fastify = Fastify({
    http2: true
  });
  t.pass('http2 successfully loaded');
} catch (e) {
  t.fail('http2 loading failed', e);
}

fastify.get('/', function (req, reply) {
  reply.code(200).send(msg);
});
fastify.listen(0, function (err) {
  t.error(err);
  fastify.server.unref();
  test('http UNKNOWN_METHOD request', function _callee(t) {
    var url, res;
    return regeneratorRuntime.async(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            t.plan(2);
            url = `http://localhost:${fastify.server.address().port}`;
            _context.next = 4;
            return regeneratorRuntime.awrap(h2url.concat({
              url,
              method: 'UNKNOWN_METHOD'
            }));

          case 4:
            res = _context.sent;
            t.strictEqual(res.headers[':status'], 404);
            t.deepEqual(JSON.parse(res.body), {
              statusCode: 404,
              error: 'Not Found',
              message: 'Not Found'
            });

          case 7:
          case "end":
            return _context.stop();
        }
      }
    });
  });
});